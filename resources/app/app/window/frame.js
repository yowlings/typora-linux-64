define("app/window/frame",["../main","jquery/jquery","jquery-localize-master/dist/jquery.localize","bootstrape/js/bootstrap","../document/File","exoskeleton-master/exoskeleton","../editor/UndoManager","../document/StringUtils","../document/Node","../editor/polyfill","./FileHelper","../editor/EditHelper","../editor/KeyMaster","./MenuHelper","./FileInfoPanel","./steno2","../editor/Editor","../document/MarkParser","../editor/Inline","../editor/Emoji","../document/Node2Mark","../document/Node2HTML","../document/NodeOperation","../editor/Diagram","codemirror/lib/codemirror","rangy/rangy-core","../editor/Fences","autoComplete","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint","../editor/MathBlock","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","../editor/MathInline","rangy/rangy-classapplier","../editor/Brush","../editor/Stylize","../editor/Selection","../editor/TableEdit","../editor/ImageEdit","../editor/UserOp","../editor/ConvertUtils","../editor/DeleteOp","../editor/PairOp","../editor/IndentOp","../editor/ClipboardOp","../editor/DocMenu","../editor/SearchPanel","../editor/Word","../document/Export","../document/Node2Native","../editor/SourceView","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","../editor/QuickOpenPanel","./Library","../editor/FileTree","../editor/FileList","../window/FileInfoPanel","../window/FileHelper","../window/ClientCommand","./PDFBridge","./PandocBridge","../window/ContextMenu","../window/PandocBridge","../window/MegaMenu","list.js-master/dist/list","list.js-master/dist/list.fuzzysearch.min","./ClientCommand"],function(e,t,n){"use strict";function i(){function e(){var e=n.getBounds();C.app.setting.put("lastWidth",e.width,!0),C.app.setting.put("lastHeight",e.height,!0),C.app.setting.put("lastX",e.x+24>1e3?200:e.x+10,!0),C.app.setting.put("lastY",e.y+24>800?200:e.y+10,!0),C.app.setting.save()}function t(){a&&(clearTimeout(a),a=null),a=setTimeout(e,500)}var n=C.getCurrentWindow();C.app,document.querySelector("#w-traffic-lights");$("#w-min").on("click",function(){n.minimize()}),$("#w-close").on("click",function(){n.close()}),$("#w-restore").on("click",function(){n.unmaximize(),n.setFullScreen(!1)});var i=null;$("#w-max").on("mouseup",function(e){1===e.which&&($("#w-traffic-lights").addClass("on-win-fullsize"),i&&clearTimeout(i),$("#w-max-group").removeClass("w-show-more"),n.maximize())}).on("mousedown",function(){i=setTimeout(function(){$("#w-max-group").addClass("w-show-more")},300)}).on("mouseenter",function(){this.classList.add("hover")}).on("mouseleave",function(){this.classList.remove("hover")}),$("#w-full").on("mouseup",function(e){1===e.which&&($("#w-traffic-lights").addClass("on-win-fullsize"),this.classList.remove("mouse-hover"),i&&clearTimeout(i),$("#w-max-group").removeClass("w-show-more"),n.setFullScreen(!0))}).on("mouseenter",function(){this.classList.add("hover")}).on("mouseleave",function(){this.classList.remove("hover")}),$("#w-pin").on("mouseup",function(e){1===e.which&&y.pinWindow()}).on("mouseenter",function(){this.classList.add("hover")}).on("mouseleave",function(){this.classList.remove("hover")}),$("#w-unpin").on("click",function(){y.unpinWindow()}),$("#top-titlebar").on("mouseleave",function(){i&&clearTimeout(i),$("#w-max-group").removeClass("w-show-more")}),document.body.classList.contains("native-window")&&$("body").on("mousemove",function(e){e.pageY<11&&n.setMenuBarVisibility(!0)});var r=null,o=function(e,t){if(n.isFocused()){var i=n.getBounds(),r=C.screen.getDisplayMatching(i).scaleFactor,o={top:i.y*r,bottom:(i.y+i.height)*r,left:i.x*r,right:(i.x+i.width)*r};e>o.left&&e<o.right&&t>o.top&&t<o.bottom?document.body.classList.contains("mouse-entered")||document.body.classList.add("mouse-entered"):document.body.classList.contains("mouse-entered")&&document.body.classList.remove("mouse-entered")}else document.body.classList.contains("mouse-entered")&&document.body.classList.remove("mouse-entered")};window.mouseMonitor=function(e,t){r&&clearTimeout(r),r=setTimeout(function(){o(e,t)},100)},n.on("maximize",function(){$("#w-traffic-lights").addClass("on-win-fullsize"),document.body.classList.remove("mouse-entered")}),n.on("enter-full-screen",function(){$("#w-traffic-lights").addClass("on-win-fullsize"),document.body.classList.remove("mouse-entered"),document.body.classList.add("typora-fullscreen")}),n.on("unmaximize",function(){$("#w-traffic-lights").removeClass("on-win-fullsize"),document.body.classList.remove("mouse-entered"),t()}),n.on("leave-full-screen",function(){$("#w-traffic-lights").removeClass("on-win-fullsize"),document.body.classList.remove("mouse-entered"),document.body.classList.remove("typora-fullscreen"),t()}),e();var a;n.on("resize",function(){m.suppressResize||e()}),n.on("move",function(){e()}),window.onbeforeunload=function(e){function t(){if(m.backupDocumentSnap(),m.editor.library.end(),g.watchFileChange(null),w.slientQuit(),C.app.getDocumentController().removeWindow(n.id),"win32"==process.platform){var e=C.screen;e.removeListener("display-added",s),e.removeListener("display-removed",s),e.removeListener("display-metrics-changed",s)}var t=n.getBounds();C.app.setting.put("lastWidth",t.width,!0),C.app.setting.put("lastHeight",t.height,!0),C.app.setting.put("lastX",t.x,!0),C.app.setting.put("lastY",t.y,!0),C.app.setting.save()}return m.autoSaveWorker(!0),n.focus(),v.tryLeaveDocument(function(e){e||(t(),releasePrintWin_(),releaseCaptureWin_(),m.fileHasModified=!1,m.updateChangeCount(m.ChangeType.NSChangeAutosaved),n.destroy())}),!1};var l=reqnode("electron").ipcRenderer;window.onerror=function(e,t,n,i,r){l.send("errorInWindow",r?r.stack:t+":"+n+"\n"+e)}}function r(){function e(e){var t=C.getCurrentWindow(),n=C.app;e=reqnode("path").normalize(e),n.getDocumentController().getDocumentFromWindowId(t.id).rename(e),e?g.setFileTitle(e):(m.filePath=void 0,m.updateChangeCount(m.ChangeType.NSChangeReadOtherContents),g.watchFileChange(null)),m.resumeFileChangeTimestamp=new Date,m.editor.library.markCurrentFile()}function t(e){return m.filePath&&(m.filePath==e||0==m.filePath.indexOf(e+i))}var n=reqnode("electron").ipcRenderer;window.doApplyRename=e;var i=m.isWin?"\\":"/";n.on("willRename",function(e,n){t(n.oldPath)&&g.watchFileChange(null)}),n.on("didRename",function(n,i){t(i.oldPath)&&(e(i.newPath+m.filePath.substr(i.oldPath.length)),i.oldPath==m.getMountFolder()&&m.editor.library.onRootChanged(i.newPath))}),n.on("willSave",function(e,t){try{m.editor.library.pauseOnChange()}catch(e){}}),n.on("didSave",function(e,t){try{var n=t.path,i=m.editor.library.fileList.findElemFromPath(n);i.length&&m.editor.library.fileList.appendItemToView({path:n,folderPath:i.attr("data-parent-path"),folderName:i.children(".file-list-item-parent-loc").text(),lastModified:new Date,name:i.find(".file-list-item-file-name").text(),summary:t.summary,oldPath:n},!0)}catch(e){console.warn(e)}try{m.editor.library.pauseOnChange(!0)}catch(e){}}),n.on("saveFromUntitled",function(t,n){m.filePath!=n&&e()})}function o(){-1!=window.navigator.userAgent.indexOf("Windows NT")?(document.body.classList.add("os-windows"),-1!=window.navigator.userAgent.indexOf("Windows NT 6.1")?document.body.classList.add("os-windows-7"):-1!=window.navigator.userAgent.indexOf("Windows NT 6.2")?document.body.classList.add("os-windows-8"):-1!=window.navigator.userAgent.indexOf("Windows NT 6.3")?(document.body.classList.add("os-windows-8"),document.body.classList.add("os-windows-8.1")):-1!=window.navigator.userAgent.indexOf("Windows NT 10")&&document.body.classList.add("os-windows-10")):process&&"linux"==process.platform?document.body.classList.add("os-linux"):process&&"darwin"==process.platform&&document.body.classList.add("os-mac")}function a(){-1==window.navigator.userAgent.indexOf("Windows NT 6.2")&&-1==window.navigator.userAgent.indexOf("Windows NT 6.3")||document.body.classList.add("paint-border")}function s(){try{if("win32"!==process.platform)return;var e=C.app,t=C.getCurrentWindow(),n=reqnode("electron").webFrame,i=reqnode("wmi-client"),r=C.screen,o=new i({host:"localhost",namespace:"\\\\root\\WMI"}),a=r.getDisplayMatching(t.getBounds()),s=r.getAllDisplays().findIndex(function(e,t){return a.bounds.x==e.bounds.x&&a.bounds.y==e.bounds.y}),l=a.scaleFactor;if(-1==s&&(s=0),l>1)return n.setZoomFactor(1),void e.setting.put("zoomFactor",1);o.query("SELECT MaxHorizontalImageSize,MaxVerticalImageSize FROM WmiMonitorBasicDisplayParams",function(t,i){var r=1;r=Math.max(a.size.width,a.size.height)/Math.max(i[s].MaxHorizontalImageSize,i[s].MaxVerticalImageSize)/43.885714285714286,r=Math.round(100*r)/100,r=16==a.size.width&&9==a.size.height?1:r<1.0765?1:1.25,n.setZoomFactor(r),e.setting.put("zoomFactor",r)})}catch(e){console.error(e)}}function l(){document.body.classList.remove("native-window"),document.body.classList.add("show-footer")}function c(){var e=C.app;if(!0===e.setting.get("framelessWindow")?(document.body.classList.remove("native-window"),document.body.classList.add("unibody-window")):(document.body.classList.add("native-window"),document.body.classList.remove("unibody-window")),!1!==e.setting.get("showStatusBar")&&document.body.classList.add("show-footer"),o(),a(),!e.setting.get("customZoom")&&"win32"==process.platform){s();var t=C.screen;t.on("display-added",s),t.on("display-removed",s),t.on("display-metrics-changed",s)}}function d(){$("html, body, #top-titlebar").click(function(){$("#main-menu").removeClass("open")})}function u(){$("#outline-btn").click(function(){m.editor.library.toggleSidebar(),m.isNode&&y.refreshViewMenu()}),$("#toggle-sourceview-btn").click(function(){m.toggleSourceMode()}),$("#toggle-focus-mode-btn").click(function(){m.editor.toggleFocusMode()}),$("#toggle-typewriter-mode-btn").click(function(){m.editor.toggleTypeWriterMode()}),h()}function h(){$("#footer-word-count").on("click",function(){if(document.body.classList.contains("show-word-count"))document.body.classList.remove("show-word-count"),document.body.classList.remove("show-word-count-in-selection");else{document.body.classList.add("show-word-count"),m.sync(),m.editor.brush.updateWordCount();var e=m.editor.getMarkdown(),t=Math.round(($("#footer-word-count-td").text()-0)/270);$("#footer-read-time-count-td").text(t||"≤ 1"),$("#footer-line-count-td").text((e.match(/\n/g)||[]).length+1),$("#footer-char-count-td").text(e.length);var n=m.editor.selection.getTextInSelection();n.length?($("#footer-char-count-td-sel").text(n.length),$("#footer-word-count-td-sel").text(m.editor.selection.getWordCountInSelection(n)),document.body.classList.add("show-word-count-in-selection")):document.body.classList.remove("show-word-count-in-selection")}}),$("#footer-word-count-info-close").on("click",function(){$("#footer-word-count").trigger("click")}),$("#footer-word-count").on("before-show-ty-hint",function(e){document.body.classList.contains("show-word-count")&&(e.cancel=!0)})}function p(){if(m.isWin){var e=C.app,t=[{type:"recent"},{type:"tasks",items:[{type:"task",program:process.execPath,arguments:"",iconPath:process.execPath,iconIndex:0,title:"New Document",description:"Create a new window"}]}];e.setAppUserModelId("abnerworks.Typora");e.setJumpList(t)}}var f=e("../main"),m=(e("../editor/KeyMaster"),e("../document/File")),g=(e("../document/Node"),e("../window/FileInfoPanel")),v=(e("../editor/EditHelper"),e("../window/FileHelper")),y=e("../window/ClientCommand"),b=e("../window/ContextMenu"),w=e("../window/PandocBridge"),x=e("../window/MegaMenu"),C=window.reqnode?reqnode("electron").remote:null;m.resetZoom=function(){"win32"==process.platform?s():(reqnode("electron").webFrame.setZoomFactor(1),C.app.setting.put("zoomFactor",1),C.app.setting.put("zoomLevel",1))},$(document).ready(function(){reqnode?c():l(),f.init(),m.isNodeHtml&&(m.contextMenu=new b(m.editor.sessionStr),m.megaMenu=new x(m.editor.sessionStr)),reqnode&&(i(),p(),r()),d(),g.prepareInfoPanel(),u()})}),define("app/main",["jquery/jquery","jquery-localize-master/dist/jquery.localize","bootstrape/js/bootstrap","app/document/File","exoskeleton-master/exoskeleton","app/editor/UndoManager","app/document/StringUtils","app/document/Node","app/editor/polyfill","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/MenuHelper","app/window/FileInfoPanel","app/window/steno2","app/editor/Editor","app/document/MarkParser","app/editor/Inline","app/editor/Emoji","app/document/Node2Mark","app/document/Node2HTML","app/document/NodeOperation","app/editor/Diagram","codemirror/lib/codemirror","rangy/rangy-core","app/editor/Fences","autoComplete","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint","app/editor/MathBlock","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","app/editor/MathInline","rangy/rangy-classapplier","app/editor/Brush","app/editor/Stylize","app/editor/Selection","app/editor/TableEdit","app/editor/ImageEdit","app/editor/UserOp","app/editor/ConvertUtils","app/editor/DeleteOp","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp","app/editor/DocMenu","app/editor/SearchPanel","app/editor/Word","app/document/Export","app/document/Node2Native","app/editor/SourceView","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","app/editor/QuickOpenPanel","app/window/Library","app/editor/FileTree","app/editor/FileList"],function(e,t,n){function i(e){window.getMarkdown=function(){return e.getMarkdown()}}if(!window.jQuery){window.$=e("jquery/jquery"),window.jQuery=window.$,e("jquery-localize-master/dist/jquery.localize.js");var r="Base";window.require?r=reqnode("electron").remote.app.setting.getUserLocale():window.app&&(r=app.app.getLocale());var o={language:r,pathPrefix:"locales"};if($("[data-lg='Front'], [data-after-content], [ty-hint]").localize("Front",o),window.require&&reqnode("electron").remote.app.setting.get("sidebar_tab")&&window.innerWidth>540){var a=document.querySelector("#typora-sidebar");a.classList.add("open"),a.style.transition="0s",document.body.classList.add("pin-outline")}$.fn.textExcludeSVG=function(e){var t=this.clone().find("svg, .MathJax_Preview").remove().end();return e&&t.find(".md-inline-math script").html(function(){return this.innerHTML.replace(/\u200b/g,"")}).end().find(".md-emoji").html(function(){return(this.querySelector(".md-meta")||{}).textContent||""}),t.text()},$.fn.textWithoutNbps=function(){return this.text().replace(/\u00A0/g," ").replace()}}e("bootstrape/js/bootstrap.js");var s=e("app/document/File"),l=e("app/editor/Editor");window.File=s,s.language=r,t.init=function(){var e=new l("#write",s);i(e),window.editor=e,setTimeout(function(){document.querySelector("#typora-sidebar").style.transition="",$("[data-lg='Panel']").localize("Panel",o),s.isNode&&$("[data-lg='Menu']").localize("Menu",o)},20)}}),define("jquery/jquery",[],function(e,t,n){!function(e,t){"object"==typeof n&&"object"==typeof n.exports?n.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(e,t){function n(e){var t=e.length,n=X.type(e);return"function"!==n&&!X.isWindow(e)&&(!(1!==e.nodeType||!t)||("array"===n||0===t||"number"==typeof t&&t>0&&t-1 in e))}function i(e,t,n){if(X.isFunction(t))return X.grep(e,function(e,i){return!!t.call(e,i,e)!==n});if(t.nodeType)return X.grep(e,function(e){return e===t!==n});if("string"==typeof t){if(ae.test(t))return X.filter(t,e,n);t=X.filter(t,e)}return X.grep(e,function(e){return z.call(t,e)>=0!==n})}function r(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}function o(e){var t=he[e]={};return X.each(e.match(ue)||[],function(e,n){t[n]=!0}),t}function a(){G.removeEventListener("DOMContentLoaded",a,!1),e.removeEventListener("load",a,!1),X.ready()}function s(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=X.expando+Math.random()}function l(e,t,n){var i;if(void 0===n&&1===e.nodeType)if(i="data-"+t.replace(ye,"-$1").toLowerCase(),"string"==typeof(n=e.getAttribute(i))){try{n="true"===n||"false"!==n&&("null"===n?null:+n+""===n?+n:ve.test(n)?X.parseJSON(n):n)}catch(e){}ge.set(e,t,n)}else n=void 0;return n}function c(){return!0}function d(){return!1}function u(){try{return G.activeElement}catch(e){}}function h(e,t){return X.nodeName(e,"table")&&X.nodeName(11!==t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function p(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function f(e){var t=Ie.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function m(e,t){for(var n=0,i=e.length;i>n;n++)me.set(e[n],"globalEval",!t||me.get(t[n],"globalEval"))}function g(e,t){var n,i,r,o,a,s,l,c;if(1===t.nodeType){if(me.hasData(e)&&(o=me.access(e),a=me.set(t,o),c=o.events)){delete a.handle,a.events={};for(r in c)for(n=0,i=c[r].length;i>n;n++)X.event.add(t,r,c[r][n])}ge.hasData(e)&&(s=ge.access(e),l=X.extend({},s),ge.set(t,l))}}function v(e,t){var n=e.getElementsByTagName?e.getElementsByTagName(t||"*"):e.querySelectorAll?e.querySelectorAll(t||"*"):[];return void 0===t||t&&X.nodeName(e,t)?X.merge([e],n):n}function y(e,t){var n=t.nodeName.toLowerCase();"input"===n&&Ce.test(e.type)?t.checked=e.checked:("input"===n||"textarea"===n)&&(t.defaultValue=e.defaultValue)}function b(t,n){var i,r=X(n.createElement(t)).appendTo(n.body),o=e.getDefaultComputedStyle&&(i=e.getDefaultComputedStyle(r[0]))?i.display:X.css(r[0],"display");return r.detach(),o}function w(e){var t=G,n=Be[e];return n||("none"!==(n=b(e,t))&&n||(De=(De||X("<iframe frameborder='0' width='0' height='0'/>")).appendTo(t.documentElement),(t=De[0].contentDocument).write(),t.close(),n=b(e,t),De.detach()),Be[e]=n),n}function x(e,t,n){var i,r,o,a,s=e.style;return(n=n||$e(e))&&(a=n.getPropertyValue(t)||n[t]),n&&(""!==a||X.contains(e.ownerDocument,e)||(a=X.style(e,t)),He.test(a)&&je.test(t)&&(i=s.width,r=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=i,s.minWidth=r,s.maxWidth=o)),void 0!==a?a+"":a}function C(e,t){return{get:function(){return e()?void delete this.get:(this.get=t).apply(this,arguments)}}}function k(e,t){if(t in e)return t;for(var n=t[0].toUpperCase()+t.slice(1),i=t,r=Ke.length;r--;)if((t=Ke[r]+n)in e)return t;return i}function S(e,t,n){var i=qe.exec(t);return i?Math.max(0,i[1]-(n||0))+(i[2]||"px"):t}function T(e,t,n,i,r){for(var o=n===(i?"border":"content")?4:"width"===t?1:0,a=0;4>o;o+=2)"margin"===n&&(a+=X.css(e,n+we[o],!0,r)),i?("content"===n&&(a-=X.css(e,"padding"+we[o],!0,r)),"margin"!==n&&(a-=X.css(e,"border"+we[o]+"Width",!0,r))):(a+=X.css(e,"padding"+we[o],!0,r),"padding"!==n&&(a+=X.css(e,"border"+we[o]+"Width",!0,r)));return a}function E(e,t,n){var i=!0,r="width"===t?e.offsetWidth:e.offsetHeight,o=$e(e),a="border-box"===X.css(e,"boxSizing",!1,o);if(0>=r||null==r){if((0>(r=x(e,t,o))||null==r)&&(r=e.style[t]),He.test(r))return r;i=a&&(J.boxSizingReliable()||r===e.style[t]),r=parseFloat(r)||0}return r+T(e,t,n||(a?"border":"content"),i,o)+"px"}function F(e,t){for(var n,i,r,o=[],a=0,s=e.length;s>a;a++)(i=e[a]).style&&(o[a]=me.get(i,"olddisplay"),n=i.style.display,t?(o[a]||"none"!==n||(i.style.display=""),""===i.style.display&&xe(i)&&(o[a]=me.access(i,"olddisplay",w(i.nodeName)))):(r=xe(i),"none"===n&&r||me.set(i,"olddisplay",r?n:X.css(i,"display"))));for(a=0;s>a;a++)(i=e[a]).style&&(t&&"none"!==i.style.display&&""!==i.style.display||(i.style.display=t?o[a]||"":"none"));return e}function _(e,t,n,i,r){return new _.prototype.init(e,t,n,i,r)}function M(){return setTimeout(function(){Ye=void 0}),Ye=X.now()}function N(e,t){var n,i=0,r={height:e};for(t=t?1:0;4>i;i+=2-t)n=we[i],r["margin"+n]=r["padding"+n]=e;return t&&(r.opacity=r.width=e),r}function L(e,t,n){for(var i,r=(et[t]||[]).concat(et["*"]),o=0,a=r.length;a>o;o++)if(i=r[o].call(n,t,e))return i}function A(e,t){var n,i,r,o,a;for(n in e)if(i=X.camelCase(n),r=t[i],o=e[n],X.isArray(o)&&(r=o[1],o=e[n]=o[0]),n!==i&&(e[i]=o,delete e[n]),(a=X.cssHooks[i])&&"expand"in a){o=a.expand(o),delete e[i];for(n in o)n in e||(e[n]=o[n],t[n]=r)}else t[i]=r}function R(e,t,n){var i,r,o=0,a=Ze.length,s=X.Deferred().always(function(){delete l.elem}),l=function(){if(r)return!1;for(var t=Ye||M(),n=Math.max(0,c.startTime+c.duration-t),i=1-(n/c.duration||0),o=0,a=c.tweens.length;a>o;o++)c.tweens[o].run(i);return s.notifyWith(e,[c,i,n]),1>i&&a?n:(s.resolveWith(e,[c]),!1)},c=s.promise({elem:e,props:X.extend({},t),opts:X.extend(!0,{specialEasing:{}},n),originalProperties:t,originalOptions:n,startTime:Ye||M(),duration:n.duration,tweens:[],createTween:function(t,n){var i=X.Tween(e,c.opts,t,n,c.opts.specialEasing[t]||c.opts.easing);return c.tweens.push(i),i},stop:function(t){var n=0,i=t?c.tweens.length:0;if(r)return this;for(r=!0;i>n;n++)c.tweens[n].run(1);return t?s.resolveWith(e,[c,t]):s.rejectWith(e,[c,t]),this}}),d=c.props;for(A(d,c.opts.specialEasing);a>o;o++)if(i=Ze[o].call(c,e,d,c.opts))return i;return X.map(d,L,c),X.isFunction(c.opts.start)&&c.opts.start.call(e,c),X.fx.timer(X.extend(l,{elem:e,anim:c,queue:c.opts.queue})),c.progress(c.opts.progress).done(c.opts.done,c.opts.complete).fail(c.opts.fail).always(c.opts.always)}function I(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var i,r=0,o=t.toLowerCase().match(ue)||[];if(X.isFunction(n))for(;i=o[r++];)"+"===i[0]?(i=i.slice(1)||"*",(e[i]=e[i]||[]).unshift(n)):(e[i]=e[i]||[]).push(n)}}function P(e,t,n,i){function r(s){var l;return o[s]=!0,X.each(e[s]||[],function(e,s){var c=s(t,n,i);return"string"!=typeof c||a||o[c]?a?!(l=c):void 0:(t.dataTypes.unshift(c),r(c),!1)}),l}var o={},a=e===yt;return r(t.dataTypes[0])||!o["*"]&&r("*")}function O(e,t){var n,i,r=X.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((r[n]?e:i||(i={}))[n]=t[n]);return i&&X.extend(!0,e,i),e}function D(e,t,n){for(var i,r,o,a,s=e.contents,l=e.dataTypes;"*"===l[0];)l.shift(),void 0===i&&(i=e.mimeType||t.getResponseHeader("Content-Type"));if(i)for(r in s)if(s[r]&&s[r].test(i)){l.unshift(r);break}if(l[0]in n)o=l[0];else{for(r in n){if(!l[0]||e.converters[r+" "+l[0]]){o=r;break}a||(a=r)}o=o||a}return o?(o!==l[0]&&l.unshift(o),n[o]):void 0}function B(e,t,n,i){var r,o,a,s,l,c={},d=e.dataTypes.slice();if(d[1])for(a in e.converters)c[a.toLowerCase()]=e.converters[a];for(o=d.shift();o;)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!l&&i&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),l=o,o=d.shift())if("*"===o)o=l;else if("*"!==l&&l!==o){if(!(a=c[l+" "+o]||c["* "+o]))for(r in c)if((s=r.split(" "))[1]===o&&(a=c[l+" "+s[0]]||c["* "+s[0]])){!0===a?a=c[r]:!0!==c[r]&&(o=s[0],d.unshift(s[1]));break}if(!0!==a)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+l+" to "+o}}}return{state:"success",data:t}}function j(e,t,n,i){var r;if(X.isArray(t))X.each(t,function(t,r){n||xt.test(e)?i(e,r):j(e+"["+("object"==typeof r?t:"")+"]",r,n,i)});else if(n||"object"!==X.type(t))i(e,t);else for(r in t)j(e+"["+r+"]",t[r],n,i)}function H(e){return X.isWindow(e)?e:9===e.nodeType&&e.defaultView}var $=[],U=$.slice,q=$.concat,W=$.push,z=$.indexOf,V={},K=V.toString,Y=V.hasOwnProperty,J={},G=e.document,Q="2.1.1",X=function(e,t){return new X.fn.init(e,t)},Z=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,ee=/^-ms-/,te=/-([\da-z])/gi,ne=function(e,t){return t.toUpperCase()};X.fn=X.prototype={jquery:Q,constructor:X,selector:"",length:0,toArray:function(){return U.call(this)},get:function(e){return null!=e?0>e?this[e+this.length]:this[e]:U.call(this)},pushStack:function(e){var t=X.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return X.each(this,e,t)},map:function(e){return this.pushStack(X.map(this,function(t,n){return e.call(t,n,t)}))},slice:function(){return this.pushStack(U.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(0>e?t:0);return this.pushStack(n>=0&&t>n?[this[n]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:W,sort:$.sort,splice:$.splice},X.extend=X.fn.extend=function(){var e,t,n,i,r,o,a=arguments[0]||{},s=1,l=arguments.length,c=!1;for("boolean"==typeof a&&(c=a,a=arguments[s]||{},s++),"object"==typeof a||X.isFunction(a)||(a={}),s===l&&(a=this,s--);l>s;s++)if(null!=(e=arguments[s]))for(t in e)n=a[t],i=e[t],a!==i&&(c&&i&&(X.isPlainObject(i)||(r=X.isArray(i)))?(r?(r=!1,o=n&&X.isArray(n)?n:[]):o=n&&X.isPlainObject(n)?n:{},a[t]=X.extend(c,o,i)):void 0!==i&&(a[t]=i));return a},X.extend({expando:"jQuery"+(Q+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isFunction:function(e){return"function"===X.type(e)},isArray:Array.isArray,isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){return!X.isArray(e)&&e-parseFloat(e)>=0},isPlainObject:function(e){return"object"===X.type(e)&&!e.nodeType&&!X.isWindow(e)&&!(e.constructor&&!Y.call(e.constructor.prototype,"isPrototypeOf"))},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?V[K.call(e)]||"object":typeof e},globalEval:function(e){var t,n=eval;(e=X.trim(e))&&(1===e.indexOf("use strict")?(t=G.createElement("script"),t.text=e,G.head.appendChild(t).parentNode.removeChild(t)):n(e))},camelCase:function(e){return e.replace(ee,"ms-").replace(te,ne)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,i){var r=0,o=e.length,a=n(e);if(i){if(a)for(;o>r&&!1!==t.apply(e[r],i);r++);else for(r in e)if(!1===t.apply(e[r],i))break}else if(a)for(;o>r&&!1!==t.call(e[r],r,e[r]);r++);else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?"":(e+"").replace(Z,"")},makeArray:function(e,t){var i=t||[];return null!=e&&(n(Object(e))?X.merge(i,"string"==typeof e?[e]:e):W.call(i,e)),i},inArray:function(e,t,n){return null==t?-1:z.call(t,e,n)},merge:function(e,t){for(var n=+t.length,i=0,r=e.length;n>i;i++)e[r++]=t[i];return e.length=r,e},grep:function(e,t,n){for(var i=[],r=0,o=e.length,a=!n;o>r;r++)!t(e[r],r)!==a&&i.push(e[r]);return i},map:function(e,t,i){var r,o=0,a=e.length,s=[];if(n(e))for(;a>o;o++)null!=(r=t(e[o],o,i))&&s.push(r);else for(o in e)null!=(r=t(e[o],o,i))&&s.push(r);return q.apply([],s)},guid:1,proxy:function(e,t){var n,i,r;return"string"==typeof t&&(n=e[t],t=e,e=n),X.isFunction(e)?(i=U.call(arguments,2),r=function(){return e.apply(t||this,i.concat(U.call(arguments)))},r.guid=e.guid=e.guid||X.guid++,r):void 0},now:Date.now,support:J}),X.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){V["[object "+t+"]"]=t.toLowerCase()});var ie=function(e){function t(e,t,n,i){var r,o,a,s,c,u,h,p,f,m;if((t?t.ownerDocument||t:B)!==N&&M(t),t=t||N,n=n||[],!e||"string"!=typeof e)return n;if(1!==(s=t.nodeType)&&9!==s)return[];if(A&&!i){if(r=ge.exec(e))if(a=r[1]){if(9===s){if(!(o=t.getElementById(a))||!o.parentNode)return n;if(o.id===a)return n.push(o),n}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(a))&&O(t,o)&&o.id===a)return n.push(o),n}else{if(r[2])return Q.apply(n,t.getElementsByTagName(e)),n;if((a=r[3])&&b.getElementsByClassName&&t.getElementsByClassName)return Q.apply(n,t.getElementsByClassName(a)),n}if(b.qsa&&(!R||!R.test(e))){if(p=h=D,f=t,m=9===s&&e,1===s&&"object"!==t.nodeName.toLowerCase()){for(u=k(e),(h=t.getAttribute("id"))?p=h.replace(ye,"\\$&"):t.setAttribute("id",p),p="[id='"+p+"'] ",c=u.length;c--;)u[c]=p+d(u[c]);f=ve.test(e)&&l(t.parentNode)||t,m=u.join(",")}if(m)try{return Q.apply(n,f.querySelectorAll(m)),n}catch(e){}finally{h||t.removeAttribute("id")}}}return T(e.replace(ae,"$1"),t,n,i)}function n(){function e(n,i){return t.push(n+" ")>w.cacheLength&&delete e[t.shift()],e[n+" "]=i}var t=[];return e}function i(e){return e[D]=!0,e}function r(e){var t=N.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function o(e,t){for(var n=e.split("|"),i=e.length;i--;)w.attrHandle[n[i]]=t}function a(e,t){var n=t&&e,i=n&&1===e.nodeType&&1===t.nodeType&&(~t.sourceIndex||V)-(~e.sourceIndex||V);if(i)return i;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function s(e){return i(function(t){return t=+t,i(function(n,i){for(var r,o=e([],n.length,t),a=o.length;a--;)n[r=o[a]]&&(n[r]=!(i[r]=n[r]))})})}function l(e){return e&&typeof e.getElementsByTagName!==z&&e}function c(){}function d(e){for(var t=0,n=e.length,i="";n>t;t++)i+=e[t].value;return i}function u(e,t,n){var i=t.dir,r=n&&"parentNode"===i,o=H++;return t.first?function(t,n,o){for(;t=t[i];)if(1===t.nodeType||r)return e(t,n,o)}:function(t,n,a){var s,l,c=[j,o];if(a){for(;t=t[i];)if((1===t.nodeType||r)&&e(t,n,a))return!0}else for(;t=t[i];)if(1===t.nodeType||r){if(l=t[D]||(t[D]={}),(s=l[i])&&s[0]===j&&s[1]===o)return c[2]=s[2];if(l[i]=c,c[2]=e(t,n,a))return!0}}}function h(e){return e.length>1?function(t,n,i){for(var r=e.length;r--;)if(!e[r](t,n,i))return!1;return!0}:e[0]}function p(e,n,i){for(var r=0,o=n.length;o>r;r++)t(e,n[r],i);return i}function f(e,t,n,i,r){for(var o,a=[],s=0,l=e.length,c=null!=t;l>s;s++)(o=e[s])&&(!n||n(o,i,r))&&(a.push(o),c&&t.push(s));return a}function m(e,t,n,r,o,a){return r&&!r[D]&&(r=m(r)),o&&!o[D]&&(o=m(o,a)),i(function(i,a,s,l){var c,d,u,h=[],m=[],g=a.length,v=i||p(t||"*",s.nodeType?[s]:s,[]),y=!e||!i&&t?v:f(v,h,e,s,l),b=n?o||(i?e:g||r)?[]:a:y;if(n&&n(y,b,s,l),r)for(c=f(b,m),r(c,[],s,l),d=c.length;d--;)(u=c[d])&&(b[m[d]]=!(y[m[d]]=u));if(i){if(o||e){if(o){for(c=[],d=b.length;d--;)(u=b[d])&&c.push(y[d]=u);o(null,b=[],c,l)}for(d=b.length;d--;)(u=b[d])&&(c=o?Z.call(i,u):h[d])>-1&&(i[c]=!(a[c]=u))}}else b=f(b===a?b.splice(g,b.length):b),o?o(null,a,b,l):Q.apply(a,b)})}function g(e){for(var t,n,i,r=e.length,o=w.relative[e[0].type],a=o||w.relative[" "],s=o?1:0,l=u(function(e){return e===t},a,!0),c=u(function(e){return Z.call(t,e)>-1},a,!0),p=[function(e,n,i){return!o&&(i||n!==E)||((t=n).nodeType?l(e,n,i):c(e,n,i))}];r>s;s++)if(n=w.relative[e[s].type])p=[u(h(p),n)];else{if((n=w.filter[e[s].type].apply(null,e[s].matches))[D]){for(i=++s;r>i&&!w.relative[e[i].type];i++);return m(s>1&&h(p),s>1&&d(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(ae,"$1"),n,i>s&&g(e.slice(s,i)),r>i&&g(e=e.slice(i)),r>i&&d(e))}p.push(n)}return h(p)}function v(e,n){var r=n.length>0,o=e.length>0,a=function(i,a,s,l,c){var d,u,h,p=0,m="0",g=i&&[],v=[],y=E,b=i||o&&w.find.TAG("*",c),x=j+=null==y?1:Math.random()||.1,C=b.length;for(c&&(E=a!==N&&a);m!==C&&null!=(d=b[m]);m++){if(o&&d){for(u=0;h=e[u++];)if(h(d,a,s)){l.push(d);break}c&&(j=x)}r&&((d=!h&&d)&&p--,i&&g.push(d))}if(p+=m,r&&m!==p){for(u=0;h=n[u++];)h(g,v,a,s);if(i){if(p>0)for(;m--;)g[m]||v[m]||(v[m]=J.call(l));v=f(v)}Q.apply(l,v),c&&!i&&v.length>0&&p+n.length>1&&t.uniqueSort(l)}return c&&(j=x,E=y),g};return r?i(a):a}var y,b,w,x,C,k,S,T,E,F,_,M,N,L,A,R,I,P,O,D="sizzle"+-new Date,B=e.document,j=0,H=0,$=n(),U=n(),q=n(),W=function(e,t){return e===t&&(_=!0),0},z="undefined",V=1<<31,K={}.hasOwnProperty,Y=[],J=Y.pop,G=Y.push,Q=Y.push,X=Y.slice,Z=Y.indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(this[t]===e)return t;return-1},ee="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",te="[\\x20\\t\\r\\n\\f]",ne="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",ie=ne.replace("w","w#"),re="\\["+te+"*("+ne+")(?:"+te+"*([*^$|!~]?=)"+te+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+ie+"))|)"+te+"*\\]",oe=":("+ne+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+re+")*)|.*)\\)|)",ae=new RegExp("^"+te+"+|((?:^|[^\\\\])(?:\\\\.)*)"+te+"+$","g"),se=new RegExp("^"+te+"*,"+te+"*"),le=new RegExp("^"+te+"*([>+~]|"+te+")"+te+"*"),ce=new RegExp("="+te+"*([^\\]'\"]*?)"+te+"*\\]","g"),de=new RegExp(oe),ue=new RegExp("^"+ie+"$"),he={ID:new RegExp("^#("+ne+")"),CLASS:new RegExp("^\\.("+ne+")"),TAG:new RegExp("^("+ne.replace("w","w*")+")"),ATTR:new RegExp("^"+re),PSEUDO:new RegExp("^"+oe),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+te+"*(even|odd|(([+-]|)(\\d*)n|)"+te+"*(?:([+-]|)"+te+"*(\\d+)|))"+te+"*\\)|)","i"),bool:new RegExp("^(?:"+ee+")$","i"),needsContext:new RegExp("^"+te+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+te+"*((?:-\\d)?\\d*)"+te+"*\\)|)(?=[^-]|$)","i")},pe=/^(?:input|select|textarea|button)$/i,fe=/^h\d$/i,me=/^[^{]+\{\s*\[native \w/,ge=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ve=/[+~]/,ye=/'|\\/g,be=new RegExp("\\\\([\\da-f]{1,6}"+te+"?|("+te+")|.)","ig"),we=function(e,t,n){var i="0x"+t-65536;return i!==i||n?t:0>i?String.fromCharCode(i+65536):String.fromCharCode(i>>10|55296,1023&i|56320)};try{Q.apply(Y=X.call(B.childNodes),B.childNodes),Y[B.childNodes.length].nodeType}catch(e){Q={apply:Y.length?function(e,t){G.apply(e,X.call(t))}:function(e,t){for(var n=e.length,i=0;e[n++]=t[i++];);e.length=n-1}}}b=t.support={},C=t.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},M=t.setDocument=function(e){var t,n=e?e.ownerDocument||e:B,i=n.defaultView;return n!==N&&9===n.nodeType&&n.documentElement?(N=n,L=n.documentElement,A=!C(n),i&&i!==i.top&&(i.addEventListener?i.addEventListener("unload",function(){M()},!1):i.attachEvent&&i.attachEvent("onunload",function(){M()})),b.attributes=r(function(e){return e.className="i",!e.getAttribute("className")}),b.getElementsByTagName=r(function(e){return e.appendChild(n.createComment("")),!e.getElementsByTagName("*").length}),b.getElementsByClassName=me.test(n.getElementsByClassName)&&r(function(e){return e.innerHTML="<div class='a'></div><div class='a i'></div>",e.firstChild.className="i",2===e.getElementsByClassName("i").length}),b.getById=r(function(e){return L.appendChild(e).id=D,!n.getElementsByName||!n.getElementsByName(D).length}),b.getById?(w.find.ID=function(e,t){if(typeof t.getElementById!==z&&A){var n=t.getElementById(e);return n&&n.parentNode?[n]:[]}},w.filter.ID=function(e){var t=e.replace(be,we);return function(e){return e.getAttribute("id")===t}}):(delete w.find.ID,w.filter.ID=function(e){var t=e.replace(be,we);return function(e){var n=typeof e.getAttributeNode!==z&&e.getAttributeNode("id");return n&&n.value===t}}),w.find.TAG=b.getElementsByTagName?function(e,t){return typeof t.getElementsByTagName!==z?t.getElementsByTagName(e):void 0}:function(e,t){var n,i=[],r=0,o=t.getElementsByTagName(e);if("*"===e){for(;n=o[r++];)1===n.nodeType&&i.push(n);return i}return o},w.find.CLASS=b.getElementsByClassName&&function(e,t){return typeof t.getElementsByClassName!==z&&A?t.getElementsByClassName(e):void 0},I=[],R=[],(b.qsa=me.test(n.querySelectorAll))&&(r(function(e){e.innerHTML="<select msallowclip=''><option selected=''></option></select>",e.querySelectorAll("[msallowclip^='']").length&&R.push("[*^$]="+te+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||R.push("\\["+te+"*(?:value|"+ee+")"),e.querySelectorAll(":checked").length||R.push(":checked")}),r(function(e){var t=n.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&R.push("name"+te+"*[*^$|!~]?="),e.querySelectorAll(":enabled").length||R.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),R.push(",.*:")})),(b.matchesSelector=me.test(P=L.matches||L.webkitMatchesSelector||L.mozMatchesSelector||L.oMatchesSelector||L.msMatchesSelector))&&r(function(e){b.disconnectedMatch=P.call(e,"div"),P.call(e,"[s!='']:x"),I.push("!=",oe)}),R=R.length&&new RegExp(R.join("|")),I=I.length&&new RegExp(I.join("|")),t=me.test(L.compareDocumentPosition),O=t||me.test(L.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,i=t&&t.parentNode;return e===i||!(!i||1!==i.nodeType||!(n.contains?n.contains(i):e.compareDocumentPosition&&16&e.compareDocumentPosition(i)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},W=t?function(e,t){if(e===t)return _=!0,0;var i=!e.compareDocumentPosition-!t.compareDocumentPosition;return i||(1&(i=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!b.sortDetached&&t.compareDocumentPosition(e)===i?e===n||e.ownerDocument===B&&O(B,e)?-1:t===n||t.ownerDocument===B&&O(B,t)?1:F?Z.call(F,e)-Z.call(F,t):0:4&i?-1:1)}:function(e,t){if(e===t)return _=!0,0;var i,r=0,o=e.parentNode,s=t.parentNode,l=[e],c=[t];if(!o||!s)return e===n?-1:t===n?1:o?-1:s?1:F?Z.call(F,e)-Z.call(F,t):0;if(o===s)return a(e,t);for(i=e;i=i.parentNode;)l.unshift(i);for(i=t;i=i.parentNode;)c.unshift(i);for(;l[r]===c[r];)r++;return r?a(l[r],c[r]):l[r]===B?-1:c[r]===B?1:0},n):N},t.matches=function(e,n){return t(e,null,null,n)},t.matchesSelector=function(e,n){if((e.ownerDocument||e)!==N&&M(e),n=n.replace(ce,"='$1']"),!(!b.matchesSelector||!A||I&&I.test(n)||R&&R.test(n)))try{var i=P.call(e,n);if(i||b.disconnectedMatch||e.document&&11!==e.document.nodeType)return i}catch(e){}return t(n,N,null,[e]).length>0},t.contains=function(e,t){return(e.ownerDocument||e)!==N&&M(e),O(e,t)},t.attr=function(e,t){(e.ownerDocument||e)!==N&&M(e);var n=w.attrHandle[t.toLowerCase()],i=n&&K.call(w.attrHandle,t.toLowerCase())?n(e,t,!A):void 0;return void 0!==i?i:b.attributes||!A?e.getAttribute(t):(i=e.getAttributeNode(t))&&i.specified?i.value:null},t.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},t.uniqueSort=function(e){var t,n=[],i=0,r=0;if(_=!b.detectDuplicates,F=!b.sortStable&&e.slice(0),e.sort(W),_){for(;t=e[r++];)t===e[r]&&(i=n.push(r));for(;i--;)e.splice(n[i],1)}return F=null,e},x=t.getText=function(e){var t,n="",i=0,r=e.nodeType;if(r){if(1===r||9===r||11===r){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=x(e)}else if(3===r||4===r)return e.nodeValue}else for(;t=e[i++];)n+=x(t);return n},(w=t.selectors={cacheLength:50,createPseudo:i,match:he,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(be,we),e[3]=(e[3]||e[4]||e[5]||"").replace(be,we),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||t.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&t.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return he.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&de.test(n)&&(t=k(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(be,we).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=$[e+" "];return t||(t=new RegExp("(^|"+te+")"+e+"("+te+"|$)"))&&$(e,function(e){return t.test("string"==typeof e.className&&e.className||typeof e.getAttribute!==z&&e.getAttribute("class")||"")})},ATTR:function(e,n,i){return function(r){var o=t.attr(r,e);return null==o?"!="===n:!n||(o+="","="===n?o===i:"!="===n?o!==i:"^="===n?i&&0===o.indexOf(i):"*="===n?i&&o.indexOf(i)>-1:"$="===n?i&&o.slice(-i.length)===i:"~="===n?(" "+o+" ").indexOf(i)>-1:"|="===n&&(o===i||o.slice(0,i.length+1)===i+"-"))}},CHILD:function(e,t,n,i,r){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===i&&0===r?function(e){return!!e.parentNode}:function(t,n,l){var c,d,u,h,p,f,m=o!==a?"nextSibling":"previousSibling",g=t.parentNode,v=s&&t.nodeName.toLowerCase(),y=!l&&!s;if(g){if(o){for(;m;){for(u=t;u=u[m];)if(s?u.nodeName.toLowerCase()===v:1===u.nodeType)return!1;f=m="only"===e&&!f&&"nextSibling"}return!0}if(f=[a?g.firstChild:g.lastChild],a&&y){for(p=(c=(d=g[D]||(g[D]={}))[e]||[])[0]===j&&c[1],h=c[0]===j&&c[2],u=p&&g.childNodes[p];u=++p&&u&&u[m]||(h=p=0)||f.pop();)if(1===u.nodeType&&++h&&u===t){d[e]=[j,p,h];break}}else if(y&&(c=(t[D]||(t[D]={}))[e])&&c[0]===j)h=c[1];else for(;(u=++p&&u&&u[m]||(h=p=0)||f.pop())&&((s?u.nodeName.toLowerCase()!==v:1!==u.nodeType)||!++h||(y&&((u[D]||(u[D]={}))[e]=[j,h]),u!==t)););return(h-=r)===i||h%i==0&&h/i>=0}}},PSEUDO:function(e,n){var r,o=w.pseudos[e]||w.setFilters[e.toLowerCase()]||t.error("unsupported pseudo: "+e);return o[D]?o(n):o.length>1?(r=[e,e,"",n],w.setFilters.hasOwnProperty(e.toLowerCase())?i(function(e,t){for(var i,r=o(e,n),a=r.length;a--;)i=Z.call(e,r[a]),e[i]=!(t[i]=r[a])}):function(e){return o(e,0,r)}):o}},pseudos:{not:i(function(e){var t=[],n=[],r=S(e.replace(ae,"$1"));return r[D]?i(function(e,t,n,i){for(var o,a=r(e,null,i,[]),s=e.length;s--;)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,i,o){return t[0]=e,r(t,null,o,n),!n.pop()}}),has:i(function(e){return function(n){return t(e,n).length>0}}),contains:i(function(e){return function(t){return(t.textContent||t.innerText||x(t)).indexOf(e)>-1}}),lang:i(function(e){return ue.test(e||"")||t.error("unsupported lang: "+e),e=e.replace(be,we).toLowerCase(),function(t){var n;do{if(n=A?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return(n=n.toLowerCase())===e||0===n.indexOf(e+"-")}while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===L},focus:function(e){return e===N.activeElement&&(!N.hasFocus||N.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return!1===e.disabled},disabled:function(e){return!0===e.disabled},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!w.pseudos.empty(e)},header:function(e){return fe.test(e.nodeName)},input:function(e){return pe.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:s(function(){return[0]}),last:s(function(e,t){return[t-1]}),eq:s(function(e,t,n){return[0>n?n+t:n]}),even:s(function(e,t){for(var n=0;t>n;n+=2)e.push(n);return e}),odd:s(function(e,t){for(var n=1;t>n;n+=2)e.push(n);return e}),lt:s(function(e,t,n){for(var i=0>n?n+t:n;--i>=0;)e.push(i);return e}),gt:s(function(e,t,n){for(var i=0>n?n+t:n;++i<t;)e.push(i);return e})}}).pseudos.nth=w.pseudos.eq;for(y in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})w.pseudos[y]=function(e){return function(t){return"input"===t.nodeName.toLowerCase()&&t.type===e}}(y);for(y in{submit:!0,reset:!0})w.pseudos[y]=function(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}(y);return c.prototype=w.filters=w.pseudos,w.setFilters=new c,k=t.tokenize=function(e,n){var i,r,o,a,s,l,c,d=U[e+" "];if(d)return n?0:d.slice(0);for(s=e,l=[],c=w.preFilter;s;){(!i||(r=se.exec(s)))&&(r&&(s=s.slice(r[0].length)||s),l.push(o=[])),i=!1,(r=le.exec(s))&&(i=r.shift(),o.push({value:i,type:r[0].replace(ae," ")}),s=s.slice(i.length));for(a in w.filter)!(r=he[a].exec(s))||c[a]&&!(r=c[a](r))||(i=r.shift(),o.push({value:i,type:a,matches:r}),s=s.slice(i.length));if(!i)break}return n?s.length:s?t.error(e):U(e,l).slice(0)},S=t.compile=function(e,t){var n,i=[],r=[],o=q[e+" "];if(!o){for(t||(t=k(e)),n=t.length;n--;)(o=g(t[n]))[D]?i.push(o):r.push(o);(o=q(e,v(r,i))).selector=e}return o},T=t.select=function(e,t,n,i){var r,o,a,s,c,u="function"==typeof e&&e,h=!i&&k(e=u.selector||e);if(n=n||[],1===h.length){if((o=h[0]=h[0].slice(0)).length>2&&"ID"===(a=o[0]).type&&b.getById&&9===t.nodeType&&A&&w.relative[o[1].type]){if(!(t=(w.find.ID(a.matches[0].replace(be,we),t)||[])[0]))return n;u&&(t=t.parentNode),e=e.slice(o.shift().value.length)}for(r=he.needsContext.test(e)?0:o.length;r--&&(a=o[r],!w.relative[s=a.type]);)if((c=w.find[s])&&(i=c(a.matches[0].replace(be,we),ve.test(o[0].type)&&l(t.parentNode)||t))){if(o.splice(r,1),!(e=i.length&&d(o)))return Q.apply(n,i),n;break}}return(u||S(e,h))(i,t,!A,n,ve.test(e)&&l(t.parentNode)||t),n},b.sortStable=D.split("").sort(W).join("")===D,b.detectDuplicates=!!_,M(),b.sortDetached=r(function(e){return 1&e.compareDocumentPosition(N.createElement("div"))}),r(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||o("type|href|height|width",function(e,t,n){return n?void 0:e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),b.attributes&&r(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||o("value",function(e,t,n){return n||"input"!==e.nodeName.toLowerCase()?void 0:e.defaultValue}),r(function(e){return null==e.getAttribute("disabled")})||o(ee,function(e,t,n){var i;return n?void 0:!0===e[t]?t.toLowerCase():(i=e.getAttributeNode(t))&&i.specified?i.value:null}),t}(e);X.find=ie,X.expr=ie.selectors,X.expr[":"]=X.expr.pseudos,X.unique=ie.uniqueSort,X.text=ie.getText,X.isXMLDoc=ie.isXML,X.contains=ie.contains;var re=X.expr.match.needsContext,oe=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,ae=/^.[^:#\[\.,]*$/;X.filter=function(e,t,n){var i=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===i.nodeType?X.find.matchesSelector(i,e)?[i]:[]:X.find.matches(e,X.grep(t,function(e){return 1===e.nodeType}))},X.fn.extend({find:function(e){var t,n=this.length,i=[],r=this;if("string"!=typeof e)return this.pushStack(X(e).filter(function(){for(t=0;n>t;t++)if(X.contains(r[t],this))return!0}));for(t=0;n>t;t++)X.find(e,r[t],i);return i=this.pushStack(n>1?X.unique(i):i),i.selector=this.selector?this.selector+" "+e:e,i},filter:function(e){return this.pushStack(i(this,e||[],!1))},not:function(e){return this.pushStack(i(this,e||[],!0))},is:function(e){return!!i(this,"string"==typeof e&&re.test(e)?X(e):e||[],!1).length}});var se,le=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/;(X.fn.init=function(e,t){var n,i;if(!e)return this;if("string"==typeof e){if(!(n="<"===e[0]&&">"===e[e.length-1]&&e.length>=3?[null,e,null]:le.exec(e))||!n[1]&&t)return!t||t.jquery?(t||se).find(e):this.constructor(t).find(e);if(n[1]){if(t=t instanceof X?t[0]:t,X.merge(this,X.parseHTML(n[1],t&&t.nodeType?t.ownerDocument||t:G,!0)),oe.test(n[1])&&X.isPlainObject(t))for(n in t)X.isFunction(this[n])?this[n](t[n]):this.attr(n,t[n]);return this}return(i=G.getElementById(n[2]))&&i.parentNode&&(this.length=1,this[0]=i),this.context=G,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):X.isFunction(e)?void 0!==se.ready?se.ready(e):e(X):(void 0!==e.selector&&(this.selector=e.selector,this.context=e.context),X.makeArray(e,this))}).prototype=X.fn,se=X(G);var ce=/^(?:parents|prev(?:Until|All))/,de={children:!0,contents:!0,next:!0,prev:!0};X.extend({dir:function(e,t,n){for(var i=[],r=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(r&&X(e).is(n))break;i.push(e)}return i},sibling:function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n}}),X.fn.extend({has:function(e){var t=X(e,this),n=t.length;return this.filter(function(){for(var e=0;n>e;e++)if(X.contains(this,t[e]))return!0})},closest:function(e,t){for(var n,i=0,r=this.length,o=[],a=re.test(e)||"string"!=typeof e?X(e,t||this.context):0;r>i;i++)for(n=this[i];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?a.index(n)>-1:1===n.nodeType&&X.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(o.length>1?X.unique(o):o)},index:function(e){return e?"string"==typeof e?z.call(X(e),this[0]):z.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(X.unique(X.merge(this.get(),X(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),X.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return X.dir(e,"parentNode")},parentsUntil:function(e,t,n){return X.dir(e,"parentNode",n)},next:function(e){return r(e,"nextSibling")},prev:function(e){return r(e,"previousSibling")},nextAll:function(e){return X.dir(e,"nextSibling")},prevAll:function(e){return X.dir(e,"previousSibling")},nextUntil:function(e,t,n){return X.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return X.dir(e,"previousSibling",n)},siblings:function(e){return X.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return X.sibling(e.firstChild)},contents:function(e){return e.contentDocument||X.merge([],e.childNodes)}},function(e,t){X.fn[e]=function(n,i){var r=X.map(this,t,n);return"Until"!==e.slice(-5)&&(i=n),i&&"string"==typeof i&&(r=X.filter(i,r)),this.length>1&&(de[e]||X.unique(r),ce.test(e)&&r.reverse()),this.pushStack(r)}});var ue=/\S+/g,he={};X.Callbacks=function(e){var t,n,i,r,a,s,l=[],c=!(e="string"==typeof e?he[e]||o(e):X.extend({},e)).once&&[],d=function(o){for(t=e.memory&&o,n=!0,s=r||0,r=0,a=l.length,i=!0;l&&a>s;s++)if(!1===l[s].apply(o[0],o[1])&&e.stopOnFalse){t=!1;break}i=!1,l&&(c?c.length&&d(c.shift()):t?l=[]:u.disable())},u={add:function(){if(l){var n=l.length;!function t(n){X.each(n,function(n,i){var r=X.type(i);"function"===r?e.unique&&u.has(i)||l.push(i):i&&i.length&&"string"!==r&&t(i)})}(arguments),i?a=l.length:t&&(r=n,d(t))}return this},remove:function(){return l&&X.each(arguments,function(e,t){for(var n;(n=X.inArray(t,l,n))>-1;)l.splice(n,1),i&&(a>=n&&a--,s>=n&&s--)}),this},has:function(e){return e?X.inArray(e,l)>-1:!(!l||!l.length)},empty:function(){return l=[],a=0,this},disable:function(){return l=c=t=void 0,this},disabled:function(){return!l},lock:function(){return c=void 0,t||u.disable(),this},locked:function(){return!c},fireWith:function(e,t){return!l||n&&!c||(t=t||[],t=[e,t.slice?t.slice():t],i?c.push(t):d(t)),this},fire:function(){return u.fireWith(this,arguments),this},fired:function(){return!!n}};return u},X.extend({Deferred:function(e){var t=[["resolve","done",X.Callbacks("once memory"),"resolved"],["reject","fail",X.Callbacks("once memory"),"rejected"],["notify","progress",X.Callbacks("memory")]],n="pending",i={state:function(){return n},always:function(){return r.done(arguments).fail(arguments),this},then:function(){var e=arguments;return X.Deferred(function(n){X.each(t,function(t,o){var a=X.isFunction(e[t])&&e[t];r[o[1]](function(){var e=a&&a.apply(this,arguments);e&&X.isFunction(e.promise)?e.promise().done(n.resolve).fail(n.reject).progress(n.notify):n[o[0]+"With"](this===i?n.promise():this,a?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?X.extend(e,i):i}},r={};return i.pipe=i.then,X.each(t,function(e,o){var a=o[2],s=o[3];i[o[1]]=a.add,s&&a.add(function(){n=s},t[1^e][2].disable,t[2][2].lock),r[o[0]]=function(){return r[o[0]+"With"](this===r?i:this,arguments),this},r[o[0]+"With"]=a.fireWith}),i.promise(r),e&&e.call(r,r),r},when:function(e){var t,n,i,r=0,o=U.call(arguments),a=o.length,s=1!==a||e&&X.isFunction(e.promise)?a:0,l=1===s?e:X.Deferred(),c=function(e,n,i){return function(r){n[e]=this,i[e]=arguments.length>1?U.call(arguments):r,i===t?l.notifyWith(n,i):--s||l.resolveWith(n,i)}};if(a>1)for(t=new Array(a),n=new Array(a),i=new Array(a);a>r;r++)o[r]&&X.isFunction(o[r].promise)?o[r].promise().done(c(r,i,o)).fail(l.reject).progress(c(r,n,t)):--s;return s||l.resolveWith(i,o),l.promise()}});var pe;X.fn.ready=function(e){return X.ready.promise().done(e),this},X.extend({isReady:!1,readyWait:1,holdReady:function(e){e?X.readyWait++:X.ready(!0)},ready:function(e){(!0===e?--X.readyWait:X.isReady)||(X.isReady=!0,!0!==e&&--X.readyWait>0||(pe.resolveWith(G,[X]),X.fn.triggerHandler&&(X(G).triggerHandler("ready"),X(G).off("ready"))))}}),X.ready.promise=function(t){return pe||(pe=X.Deferred(),"complete"===G.readyState?setTimeout(X.ready):(G.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1))),pe.promise(t)},X.ready.promise();var fe=X.access=function(e,t,n,i,r,o,a){var s=0,l=e.length,c=null==n;if("object"===X.type(n)){r=!0;for(s in n)X.access(e,t,s,n[s],!0,o,a)}else if(void 0!==i&&(r=!0,X.isFunction(i)||(a=!0),c&&(a?(t.call(e,i),t=null):(c=t,t=function(e,t,n){return c.call(X(e),n)})),t))for(;l>s;s++)t(e[s],n,a?i:i.call(e[s],s,t(e[s],n)));return r?e:c?t.call(e):l?t(e[0],n):o};X.acceptData=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType},s.uid=1,s.accepts=X.acceptData,s.prototype={key:function(e){if(!s.accepts(e))return 0;var t={},n=e[this.expando];if(!n){n=s.uid++;try{t[this.expando]={value:n},Object.defineProperties(e,t)}catch(i){t[this.expando]=n,X.extend(e,t)}}return this.cache[n]||(this.cache[n]={}),n},set:function(e,t,n){var i,r=this.key(e),o=this.cache[r];if("string"==typeof t)o[t]=n;else if(X.isEmptyObject(o))X.extend(this.cache[r],t);else for(i in t)o[i]=t[i];return o},get:function(e,t){var n=this.cache[this.key(e)];return void 0===t?n:n[t]},access:function(e,t,n){var i;return void 0===t||t&&"string"==typeof t&&void 0===n?void 0!==(i=this.get(e,t))?i:this.get(e,X.camelCase(t)):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,i,r,o=this.key(e),a=this.cache[o];if(void 0===t)this.cache[o]={};else{X.isArray(t)?i=t.concat(t.map(X.camelCase)):(r=X.camelCase(t),t in a?i=[t,r]:(i=r,i=i in a?[i]:i.match(ue)||[])),n=i.length;for(;n--;)delete a[i[n]]}},hasData:function(e){return!X.isEmptyObject(this.cache[e[this.expando]]||{})},discard:function(e){e[this.expando]&&delete this.cache[e[this.expando]]}};var me=new s,ge=new s,ve=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,ye=/([A-Z])/g;X.extend({hasData:function(e){return ge.hasData(e)||me.hasData(e)},data:function(e,t,n){return ge.access(e,t,n)},removeData:function(e,t){ge.remove(e,t)},_data:function(e,t,n){return me.access(e,t,n)},_removeData:function(e,t){me.remove(e,t)}}),X.fn.extend({data:function(e,t){var n,i,r,o=this[0],a=o&&o.attributes;if(void 0===e){if(this.length&&(r=ge.get(o),1===o.nodeType&&!me.get(o,"hasDataAttrs"))){for(n=a.length;n--;)a[n]&&0===(i=a[n].name).indexOf("data-")&&(i=X.camelCase(i.slice(5)),l(o,i,r[i]));me.set(o,"hasDataAttrs",!0)}return r}return"object"==typeof e?this.each(function(){ge.set(this,e)}):fe(this,function(t){var n,i=X.camelCase(e);if(o&&void 0===t){if(void 0!==(n=ge.get(o,e)))return n;if(void 0!==(n=ge.get(o,i)))return n;if(void 0!==(n=l(o,i,void 0)))return n}else this.each(function(){var n=ge.get(this,i);ge.set(this,i,t),-1!==e.indexOf("-")&&void 0!==n&&ge.set(this,e,t)})},null,t,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){ge.remove(this,e)})}}),X.extend({queue:function(e,t,n){var i;return e?(t=(t||"fx")+"queue",i=me.get(e,t),n&&(!i||X.isArray(n)?i=me.access(e,t,X.makeArray(n)):i.push(n)),i||[]):void 0},dequeue:function(e,t){t=t||"fx";var n=X.queue(e,t),i=n.length,r=n.shift(),o=X._queueHooks(e,t);"inprogress"===r&&(r=n.shift(),i--),r&&("fx"===t&&n.unshift("inprogress"),delete o.stop,r.call(e,function(){X.dequeue(e,t)},o)),!i&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return me.get(e,n)||me.access(e,n,{empty:X.Callbacks("once memory").add(function(){me.remove(e,[t+"queue",n])})})}}),X.fn.extend({queue:function(e,t){var n=2;return"string"!=typeof e&&(t=e,e="fx",n--),arguments.length<n?X.queue(this[0],e):void 0===t?this:this.each(function(){var n=X.queue(this,e,t);X._queueHooks(this,e),"fx"===e&&"inprogress"!==n[0]&&X.dequeue(this,e)})},dequeue:function(e){return this.each(function(){X.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,i=1,r=X.Deferred(),o=this,a=this.length,s=function(){--i||r.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";a--;)(n=me.get(o[a],e+"queueHooks"))&&n.empty&&(i++,n.empty.add(s));return s(),r.promise(t)}});var be=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,we=["Top","Right","Bottom","Left"],xe=function(e,t){return e=t||e,"none"===X.css(e,"display")||!X.contains(e.ownerDocument,e)},Ce=/^(?:checkbox|radio)$/i;!function(){var e=G.createDocumentFragment().appendChild(G.createElement("div")),t=G.createElement("input");t.setAttribute("type","radio"),t.setAttribute("checked","checked"),t.setAttribute("name","t"),e.appendChild(t),J.checkClone=e.cloneNode(!0).cloneNode(!0).lastChild.checked,e.innerHTML="<textarea>x</textarea>",J.noCloneChecked=!!e.cloneNode(!0).lastChild.defaultValue}();var ke="undefined";J.focusinBubbles="onfocusin"in e;var Se=/^key/,Te=/^(?:mouse|pointer|contextmenu)|click/,Ee=/^(?:focusinfocus|focusoutblur)$/,Fe=/^([^.]*)(?:\.(.+)|)$/;X.event={global:{},add:function(e,t,n,i,r){var o,a,s,l,c,d,u,h,p,f,m,g=me.get(e);if(g)for(n.handler&&(o=n,n=o.handler,r=o.selector),n.guid||(n.guid=X.guid++),(l=g.events)||(l=g.events={}),(a=g.handle)||(a=g.handle=function(t){return typeof X!==ke&&X.event.triggered!==t.type?X.event.dispatch.apply(e,arguments):void 0}),c=(t=(t||"").match(ue)||[""]).length;c--;)s=Fe.exec(t[c])||[],p=m=s[1],f=(s[2]||"").split(".").sort(),p&&(u=X.event.special[p]||{},p=(r?u.delegateType:u.bindType)||p,u=X.event.special[p]||{},d=X.extend({type:p,origType:m,data:i,handler:n,guid:n.guid,selector:r,needsContext:r&&X.expr.match.needsContext.test(r),namespace:f.join(".")},o),(h=l[p])||(h=l[p]=[],h.delegateCount=0,u.setup&&!1!==u.setup.call(e,i,f,a)||e.addEventListener&&e.addEventListener(p,a,!1)),u.add&&(u.add.call(e,d),d.handler.guid||(d.handler.guid=n.guid)),r?h.splice(h.delegateCount++,0,d):h.push(d),X.event.global[p]=!0)},remove:function(e,t,n,i,r){var o,a,s,l,c,d,u,h,p,f,m,g=me.hasData(e)&&me.get(e);if(g&&(l=g.events)){for(c=(t=(t||"").match(ue)||[""]).length;c--;)if(s=Fe.exec(t[c])||[],p=m=s[1],f=(s[2]||"").split(".").sort(),p){for(u=X.event.special[p]||{},h=l[p=(i?u.delegateType:u.bindType)||p]||[],s=s[2]&&new RegExp("(^|\\.)"+f.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=h.length;o--;)d=h[o],!r&&m!==d.origType||n&&n.guid!==d.guid||s&&!s.test(d.namespace)||i&&i!==d.selector&&("**"!==i||!d.selector)||(h.splice(o,1),d.selector&&h.delegateCount--,u.remove&&u.remove.call(e,d));a&&!h.length&&(u.teardown&&!1!==u.teardown.call(e,f,g.handle)||X.removeEvent(e,p,g.handle),delete l[p])}else for(p in l)X.event.remove(e,p+t[c],n,i,!0);X.isEmptyObject(l)&&(delete g.handle,me.remove(e,"events"))}},trigger:function(t,n,i,r){var o,a,s,l,c,d,u,h=[i||G],p=Y.call(t,"type")?t.type:t,f=Y.call(t,"namespace")?t.namespace.split("."):[];if(a=s=i=i||G,3!==i.nodeType&&8!==i.nodeType&&!Ee.test(p+X.event.triggered)&&(p.indexOf(".")>=0&&(f=p.split("."),p=f.shift(),f.sort()),c=p.indexOf(":")<0&&"on"+p,t=t[X.expando]?t:new X.Event(p,"object"==typeof t&&t),t.isTrigger=r?2:3,t.namespace=f.join("."),t.namespace_re=t.namespace?new RegExp("(^|\\.)"+f.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=void 0,t.target||(t.target=i),n=null==n?[t]:X.makeArray(n,[t]),u=X.event.special[p]||{},r||!u.trigger||!1!==u.trigger.apply(i,n))){if(!r&&!u.noBubble&&!X.isWindow(i)){for(l=u.delegateType||p,Ee.test(l+p)||(a=a.parentNode);a;a=a.parentNode)h.push(a),s=a;s===(i.ownerDocument||G)&&h.push(s.defaultView||s.parentWindow||e)}for(o=0;(a=h[o++])&&!t.isPropagationStopped();)t.type=o>1?l:u.bindType||p,(d=(me.get(a,"events")||{})[t.type]&&me.get(a,"handle"))&&d.apply(a,n),(d=c&&a[c])&&d.apply&&X.acceptData(a)&&(t.result=d.apply(a,n),!1===t.result&&t.preventDefault());return t.type=p,r||t.isDefaultPrevented()||u._default&&!1!==u._default.apply(h.pop(),n)||!X.acceptData(i)||c&&X.isFunction(i[p])&&!X.isWindow(i)&&((s=i[c])&&(i[c]=null),X.event.triggered=p,i[p](),X.event.triggered=void 0,s&&(i[c]=s)),t.result}},dispatch:function(e){e=X.event.fix(e);var t,n,i,r,o,a=[],s=U.call(arguments),l=(me.get(this,"events")||{})[e.type]||[],c=X.event.special[e.type]||{};if(s[0]=e,e.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,e)){for(a=X.event.handlers.call(this,e,l),t=0;(r=a[t++])&&!e.isPropagationStopped();)for(e.currentTarget=r.elem,n=0;(o=r.handlers[n++])&&!e.isImmediatePropagationStopped();)(!e.namespace_re||e.namespace_re.test(o.namespace))&&(e.handleObj=o,e.data=o.data,void 0!==(i=((X.event.special[o.origType]||{}).handle||o.handler).apply(r.elem,s))&&!1===(e.result=i)&&(e.preventDefault(),e.stopPropagation()));return c.postDispatch&&c.postDispatch.call(this,e),e.result}},handlers:function(e,t){var n,i,r,o,a=[],s=t.delegateCount,l=e.target;if(s&&l.nodeType&&(!e.button||"click"!==e.type))for(;l!==this;l=l.parentNode||this)if(!0!==l.disabled||"click"!==e.type){for(i=[],n=0;s>n;n++)o=t[n],r=o.selector+" ",void 0===i[r]&&(i[r]=o.needsContext?X(r,this).index(l)>=0:X.find(r,this,null,[l]).length),i[r]&&i.push(o);i.length&&a.push({elem:l,handlers:i})}return s<t.length&&a.push({elem:this,handlers:t.slice(s)}),a},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,t){var n,i,r,o=t.button;return null==e.pageX&&null!=t.clientX&&(n=e.target.ownerDocument||G,i=n.documentElement,r=n.body,e.pageX=t.clientX+(i&&i.scrollLeft||r&&r.scrollLeft||0)-(i&&i.clientLeft||r&&r.clientLeft||0),e.pageY=t.clientY+(i&&i.scrollTop||r&&r.scrollTop||0)-(i&&i.clientTop||r&&r.clientTop||0)),e.which||void 0===o||(e.which=1&o?1:2&o?3:4&o?2:0),e}},fix:function(e){if(e[X.expando])return e;var t,n,i,r=e.type,o=e,a=this.fixHooks[r];for(a||(this.fixHooks[r]=a=Te.test(r)?this.mouseHooks:Se.test(r)?this.keyHooks:{}),i=a.props?this.props.concat(a.props):this.props,e=new X.Event(o),t=i.length;t--;)n=i[t],e[n]=o[n];return e.target||(e.target=G),3===e.target.nodeType&&(e.target=e.target.parentNode),a.filter?a.filter(e,o):e},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==u()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===u()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&X.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(e){return X.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,n,i){var r=X.extend(new X.Event,n,{type:e,isSimulated:!0,originalEvent:{}});i?X.event.trigger(r,null,t):X.event.dispatch.call(t,r),r.isDefaultPrevented()&&n.preventDefault()}},X.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)},X.Event=function(e,t){return this instanceof X.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?c:d):this.type=e,t&&X.extend(this,t),this.timeStamp=e&&e.timeStamp||X.now(),void(this[X.expando]=!0)):new X.Event(e,t)},X.Event.prototype={isDefaultPrevented:d,isPropagationStopped:d,isImmediatePropagationStopped:d,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=c,e&&e.preventDefault&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=c,e&&e.stopPropagation&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=c,e&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),this.stopPropagation()}},X.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,t){X.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,i=this,r=e.relatedTarget,o=e.handleObj;return(!r||r!==i&&!X.contains(i,r))&&(e.type=o.origType,n=o.handler.apply(this,arguments),e.type=t),n}}}),J.focusinBubbles||X.each({focus:"focusin",blur:"focusout"},function(e,t){var n=function(e){X.event.simulate(t,e.target,X.event.fix(e),!0)};X.event.special[t]={setup:function(){var i=this.ownerDocument||this,r=me.access(i,t);r||i.addEventListener(e,n,!0),me.access(i,t,(r||0)+1)},teardown:function(){var i=this.ownerDocument||this,r=me.access(i,t)-1;r?me.access(i,t,r):(i.removeEventListener(e,n,!0),me.remove(i,t))}}}),X.fn.extend({on:function(e,t,n,i,r){var o,a;if("object"==typeof e){"string"!=typeof t&&(n=n||t,t=void 0);for(a in e)this.on(a,t,n,e[a],r);return this}if(null==n&&null==i?(i=t,n=t=void 0):null==i&&("string"==typeof t?(i=n,n=void 0):(i=n,n=t,t=void 0)),!1===i)i=d;else if(!i)return this;return 1===r&&(o=i,i=function(e){return X().off(e),o.apply(this,arguments)},i.guid=o.guid||(o.guid=X.guid++)),this.each(function(){X.event.add(this,e,i,n,t)})},one:function(e,t,n,i){return this.on(e,t,n,i,1)},off:function(e,t,n){var i,r;if(e&&e.preventDefault&&e.handleObj)return i=e.handleObj,X(e.delegateTarget).off(i.namespace?i.origType+"."+i.namespace:i.origType,i.selector,i.handler),this;if("object"==typeof e){for(r in e)this.off(r,t,e[r]);return this}return(!1===t||"function"==typeof t)&&(n=t,t=void 0),!1===n&&(n=d),this.each(function(){X.event.remove(this,e,n,t)})},trigger:function(e,t){return this.each(function(){X.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];return n?X.event.trigger(e,t,n,!0):void 0}});var _e=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,Me=/<([\w:]+)/,Ne=/<|&#?\w+;/,Le=/<(?:script|style|link)/i,Ae=/checked\s*(?:[^=]|=\s*.checked.)/i,Re=/^$|\/(?:java|ecma)script/i,Ie=/^true\/(.*)/,Pe=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,Oe={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};Oe.optgroup=Oe.option,Oe.tbody=Oe.tfoot=Oe.colgroup=Oe.caption=Oe.thead,Oe.th=Oe.td,X.extend({clone:function(e,t,n){var i,r,o,a,s=e.cloneNode(!0),l=X.contains(e.ownerDocument,e);if(!(J.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||X.isXMLDoc(e)))for(a=v(s),o=v(e),i=0,r=o.length;r>i;i++)y(o[i],a[i]);if(t)if(n)for(o=o||v(e),a=a||v(s),i=0,r=o.length;r>i;i++)g(o[i],a[i]);else g(e,s);return(a=v(s,"script")).length>0&&m(a,!l&&v(e,"script")),s},buildFragment:function(e,t,n,i){for(var r,o,a,s,l,c,d=t.createDocumentFragment(),u=[],h=0,p=e.length;p>h;h++)if((r=e[h])||0===r)if("object"===X.type(r))X.merge(u,r.nodeType?[r]:r);else if(Ne.test(r)){for(o=o||d.appendChild(t.createElement("div")),a=(Me.exec(r)||["",""])[1].toLowerCase(),s=Oe[a]||Oe._default,o.innerHTML=s[1]+r.replace(_e,"<$1></$2>")+s[2],c=s[0];c--;)o=o.lastChild;X.merge(u,o.childNodes),(o=d.firstChild).textContent=""}else u.push(t.createTextNode(r));for(d.textContent="",h=0;r=u[h++];)if((!i||-1===X.inArray(r,i))&&(l=X.contains(r.ownerDocument,r),o=v(d.appendChild(r),"script"),l&&m(o),n))for(c=0;r=o[c++];)Re.test(r.type||"")&&n.push(r);return d},cleanData:function(e){for(var t,n,i,r,o=X.event.special,a=0;void 0!==(n=e[a]);a++){if(X.acceptData(n)&&(r=n[me.expando])&&(t=me.cache[r])){if(t.events)for(i in t.events)o[i]?X.event.remove(n,i):X.removeEvent(n,i,t.handle);me.cache[r]&&delete me.cache[r]}delete ge.cache[n[ge.expando]]}}}),X.fn.extend({text:function(e){return fe(this,function(e){return void 0===e?X.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=e)})},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||h(this,e).appendChild(e)})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=h(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){for(var n,i=e?X.filter(e,this):this,r=0;null!=(n=i[r]);r++)t||1!==n.nodeType||X.cleanData(v(n)),n.parentNode&&(t&&X.contains(n.ownerDocument,n)&&m(v(n,"script")),n.parentNode.removeChild(n));return this},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(X.cleanData(v(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return X.clone(this,e,t)})},html:function(e){return fe(this,function(e){var t=this[0]||{},n=0,i=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Le.test(e)&&!Oe[(Me.exec(e)||["",""])[1].toLowerCase()]){e=e.replace(_e,"<$1></$2>");try{for(;i>n;n++)1===(t=this[n]||{}).nodeType&&(X.cleanData(v(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=arguments[0];return this.domManip(arguments,function(t){e=this.parentNode,X.cleanData(v(this)),e&&e.replaceChild(t,this)}),e&&(e.length||e.nodeType)?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(e,t){e=q.apply([],e);var n,i,r,o,a,s,l=0,c=this.length,d=this,u=c-1,h=e[0],m=X.isFunction(h);if(m||c>1&&"string"==typeof h&&!J.checkClone&&Ae.test(h))return this.each(function(n){var i=d.eq(n);m&&(e[0]=h.call(this,n,i.html())),i.domManip(e,t)});if(c&&(n=X.buildFragment(e,this[0].ownerDocument,!1,this),i=n.firstChild,1===n.childNodes.length&&(n=i),i)){for(o=(r=X.map(v(n,"script"),p)).length;c>l;l++)a=n,l!==u&&(a=X.clone(a,!0,!0),o&&X.merge(r,v(a,"script"))),t.call(this[l],a,l);if(o)for(s=r[r.length-1].ownerDocument,X.map(r,f),l=0;o>l;l++)a=r[l],Re.test(a.type||"")&&!me.access(a,"globalEval")&&X.contains(s,a)&&(a.src?X._evalUrl&&X._evalUrl(a.src):X.globalEval(a.textContent.replace(Pe,"")))}return this}}),X.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){X.fn[e]=function(e){for(var n,i=[],r=X(e),o=r.length-1,a=0;o>=a;a++)n=a===o?this:this.clone(!0),X(r[a])[t](n),W.apply(i,n.get());return this.pushStack(i)}});var De,Be={},je=/^margin/,He=new RegExp("^("+be+")(?!px)[a-z%]+$","i"),$e=function(e){return e.ownerDocument.defaultView.getComputedStyle(e,null)};!function(){function t(){a.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",a.innerHTML="",r.appendChild(o);var t=e.getComputedStyle(a,null);n="1%"!==t.top,i="4px"===t.width,r.removeChild(o)}var n,i,r=G.documentElement,o=G.createElement("div"),a=G.createElement("div");a.style&&(a.style.backgroundClip="content-box",a.cloneNode(!0).style.backgroundClip="",J.clearCloneStyle="content-box"===a.style.backgroundClip,o.style.cssText="border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;position:absolute",o.appendChild(a),e.getComputedStyle&&X.extend(J,{pixelPosition:function(){return t(),n},boxSizingReliable:function(){return null==i&&t(),i},reliableMarginRight:function(){var t,n=a.appendChild(G.createElement("div"));return n.style.cssText=a.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",n.style.marginRight=n.style.width="0",a.style.width="1px",r.appendChild(o),t=!parseFloat(e.getComputedStyle(n,null).marginRight),r.removeChild(o),t}}))}(),X.swap=function(e,t,n,i){var r,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];r=n.apply(e,i||[]);for(o in t)e.style[o]=a[o];return r};var Ue=/^(none|table(?!-c[ea]).+)/,qe=new RegExp("^("+be+")(.*)$","i"),We=new RegExp("^([+-])=("+be+")","i"),ze={position:"absolute",visibility:"hidden",display:"block"},Ve={letterSpacing:"0",fontWeight:"400"},Ke=["Webkit","O","Moz","ms"];X.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=x(e,"opacity");return""===n?"1":n}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:"cssFloat"},style:function(e,t,n,i){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var r,o,a,s=X.camelCase(t),l=e.style;return t=X.cssProps[s]||(X.cssProps[s]=k(l,s)),a=X.cssHooks[t]||X.cssHooks[s],void 0===n?a&&"get"in a&&void 0!==(r=a.get(e,!1,i))?r:l[t]:("string"===(o=typeof n)&&(r=We.exec(n))&&(n=(r[1]+1)*r[2]+parseFloat(X.css(e,t)),o="number"),void(null!=n&&n===n&&("number"!==o||X.cssNumber[s]||(n+="px"),J.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,i))||(l[t]=n))))}},css:function(e,t,n,i){var r,o,a,s=X.camelCase(t);return t=X.cssProps[s]||(X.cssProps[s]=k(e.style,s)),(a=X.cssHooks[t]||X.cssHooks[s])&&"get"in a&&(r=a.get(e,!0,n)),void 0===r&&(r=x(e,t,i)),"normal"===r&&t in Ve&&(r=Ve[t]),""===n||n?(o=parseFloat(r),!0===n||X.isNumeric(o)?o||0:r):r}}),X.each(["height","width"],function(e,t){X.cssHooks[t]={get:function(e,n,i){return n?Ue.test(X.css(e,"display"))&&0===e.offsetWidth?X.swap(e,ze,function(){return E(e,t,i)}):E(e,t,i):void 0},set:function(e,n,i){var r=i&&$e(e);return S(0,n,i?T(e,t,i,"border-box"===X.css(e,"boxSizing",!1,r),r):0)}}}),X.cssHooks.marginRight=C(J.reliableMarginRight,function(e,t){return t?X.swap(e,{display:"inline-block"},x,[e,"marginRight"]):void 0}),X.each({margin:"",padding:"",border:"Width"},function(e,t){X.cssHooks[e+t]={expand:function(n){for(var i=0,r={},o="string"==typeof n?n.split(" "):[n];4>i;i++)r[e+we[i]+t]=o[i]||o[i-2]||o[0];return r}},je.test(e)||(X.cssHooks[e+t].set=S)}),X.fn.extend({css:function(e,t){return fe(this,function(e,t,n){var i,r,o={},a=0;if(X.isArray(t)){for(i=$e(e),r=t.length;r>a;a++)o[t[a]]=X.css(e,t[a],!1,i);return o}return void 0!==n?X.style(e,t,n):X.css(e,t)},e,t,arguments.length>1)},show:function(){return F(this,!0)},hide:function(){return F(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){xe(this)?X(this).show():X(this).hide()})}}),X.Tween=_,_.prototype={constructor:_,init:function(e,t,n,i,r,o){this.elem=e,this.prop=n,this.easing=r||"swing",this.options=t,this.start=this.now=this.cur(),this.end=i,this.unit=o||(X.cssNumber[n]?"":"px")},cur:function(){var e=_.propHooks[this.prop];return e&&e.get?e.get(this):_.propHooks._default.get(this)},run:function(e){var t,n=_.propHooks[this.prop];return this.pos=t=this.options.duration?X.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):_.propHooks._default.set(this),this}},_.prototype.init.prototype=_.prototype,_.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=X.css(e.elem,e.prop,""))&&"auto"!==t?t:0:e.elem[e.prop]},set:function(e){X.fx.step[e.prop]?X.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[X.cssProps[e.prop]]||X.cssHooks[e.prop])?X.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},_.propHooks.scrollTop=_.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},X.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},X.fx=_.prototype.init,X.fx.step={};var Ye,Je,Ge=/^(?:toggle|show|hide)$/,Qe=new RegExp("^(?:([+-])=|)("+be+")([a-z%]*)$","i"),Xe=/queueHooks$/,Ze=[function(e,t,n){var i,r,o,a,s,l,c,d=this,u={},h=e.style,p=e.nodeType&&xe(e),f=me.get(e,"fxshow");n.queue||(null==(s=X._queueHooks(e,"fx")).unqueued&&(s.unqueued=0,l=s.empty.fire,s.empty.fire=function(){s.unqueued||l()}),s.unqueued++,d.always(function(){d.always(function(){s.unqueued--,X.queue(e,"fx").length||s.empty.fire()})})),1===e.nodeType&&("height"in t||"width"in t)&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],"inline"===("none"===(c=X.css(e,"display"))?me.get(e,"olddisplay")||w(e.nodeName):c)&&"none"===X.css(e,"float")&&(h.display="inline-block")),n.overflow&&(h.overflow="hidden",d.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]}));for(i in t)if(r=t[i],Ge.exec(r)){if(delete t[i],o=o||"toggle"===r,r===(p?"hide":"show")){if("show"!==r||!f||void 0===f[i])continue;p=!0}u[i]=f&&f[i]||X.style(e,i)}else c=void 0;if(X.isEmptyObject(u))"inline"===("none"===c?w(e.nodeName):c)&&(h.display=c);else{f?"hidden"in f&&(p=f.hidden):f=me.access(e,"fxshow",{}),o&&(f.hidden=!p),p?X(e).show():d.done(function(){X(e).hide()}),d.done(function(){var t;me.remove(e,"fxshow");for(t in u)X.style(e,t,u[t])});for(i in u)a=L(p?f[i]:0,i,d),i in f||(f[i]=a.start,p&&(a.end=a.start,a.start="width"===i||"height"===i?1:0))}}],et={"*":[function(e,t){var n=this.createTween(e,t),i=n.cur(),r=Qe.exec(t),o=r&&r[3]||(X.cssNumber[e]?"":"px"),a=(X.cssNumber[e]||"px"!==o&&+i)&&Qe.exec(X.css(n.elem,e)),s=1,l=20;if(a&&a[3]!==o){o=o||a[3],r=r||[],a=+i||1;do{s=s||".5",a/=s,X.style(n.elem,e,a+o)}while(s!==(s=n.cur()/i)&&1!==s&&--l)}return r&&(a=n.start=+a||+i||0,n.unit=o,n.end=r[1]?a+(r[1]+1)*r[2]:+r[2]),n}]};X.Animation=X.extend(R,{tweener:function(e,t){X.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");for(var n,i=0,r=e.length;r>i;i++)n=e[i],et[n]=et[n]||[],et[n].unshift(t)},prefilter:function(e,t){t?Ze.unshift(e):Ze.push(e)}}),X.speed=function(e,t,n){var i=e&&"object"==typeof e?X.extend({},e):{complete:n||!n&&t||X.isFunction(e)&&e,duration:e,easing:n&&t||t&&!X.isFunction(t)&&t};return i.duration=X.fx.off?0:"number"==typeof i.duration?i.duration:i.duration in X.fx.speeds?X.fx.speeds[i.duration]:X.fx.speeds._default,(null==i.queue||!0===i.queue)&&(i.queue="fx"),i.old=i.complete,i.complete=function(){X.isFunction(i.old)&&i.old.call(this),i.queue&&X.dequeue(this,i.queue)},i},X.fn.extend({fadeTo:function(e,t,n,i){return this.filter(xe).css("opacity",0).show().end().animate({opacity:t},e,n,i)},animate:function(e,t,n,i){var r=X.isEmptyObject(e),o=X.speed(t,n,i),a=function(){var t=R(this,X.extend({},e),o);(r||me.get(this,"finish"))&&t.stop(!0)};return a.finish=a,r||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(e,t,n){var i=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=t,t=e,e=void 0),t&&!1!==e&&this.queue(e||"fx",[]),this.each(function(){var t=!0,r=null!=e&&e+"queueHooks",o=X.timers,a=me.get(this);if(r)a[r]&&a[r].stop&&i(a[r]);else for(r in a)a[r]&&a[r].stop&&Xe.test(r)&&i(a[r]);for(r=o.length;r--;)o[r].elem!==this||null!=e&&o[r].queue!==e||(o[r].anim.stop(n),t=!1,o.splice(r,1));(t||!n)&&X.dequeue(this,e)})},finish:function(e){return!1!==e&&(e=e||"fx"),this.each(function(){var t,n=me.get(this),i=n[e+"queue"],r=n[e+"queueHooks"],o=X.timers,a=i?i.length:0;for(n.finish=!0,X.queue(this,e,[]),r&&r.stop&&r.stop.call(this,!0),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;a>t;t++)i[t]&&i[t].finish&&i[t].finish.call(this);delete n.finish})}}),X.each(["toggle","show","hide"],function(e,t){var n=X.fn[t];X.fn[t]=function(e,i,r){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(N(t,!0),e,i,r)}}),X.each({slideDown:N("show"),slideUp:N("hide"),slideToggle:N("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){X.fn[e]=function(e,n,i){return this.animate(t,e,n,i)}}),X.timers=[],X.fx.tick=function(){var e,t=0,n=X.timers;for(Ye=X.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||X.fx.stop(),Ye=void 0},X.fx.timer=function(e){X.timers.push(e),e()?X.fx.start():X.timers.pop()},X.fx.interval=13,X.fx.start=function(){Je||(Je=setInterval(X.fx.tick,X.fx.interval))},X.fx.stop=function(){clearInterval(Je),Je=null},X.fx.speeds={slow:600,fast:200,_default:400},X.fn.delay=function(e,t){return e=X.fx?X.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,n){var i=setTimeout(t,e);n.stop=function(){clearTimeout(i)}})},function(){var e=G.createElement("input"),t=G.createElement("select"),n=t.appendChild(G.createElement("option"));e.type="checkbox",J.checkOn=""!==e.value,J.optSelected=n.selected,t.disabled=!0,J.optDisabled=!n.disabled,(e=G.createElement("input")).value="t",e.type="radio",J.radioValue="t"===e.value}();var tt,nt=X.expr.attrHandle;X.fn.extend({attr:function(e,t){return fe(this,X.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){X.removeAttr(this,e)})}}),X.extend({attr:function(e,t,n){var i,r,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o)return typeof e.getAttribute===ke?X.prop(e,t,n):(1===o&&X.isXMLDoc(e)||(t=t.toLowerCase(),i=X.attrHooks[t]||(X.expr.match.bool.test(t)?tt:void 0)),void 0===n?i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=X.find.attr(e,t))?void 0:r:null!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):void X.removeAttr(e,t))},removeAttr:function(e,t){var n,i,r=0,o=t&&t.match(ue);if(o&&1===e.nodeType)for(;n=o[r++];)i=X.propFix[n]||n,X.expr.match.bool.test(n)&&(e[i]=!1),e.removeAttribute(n)},attrHooks:{type:{set:function(e,t){if(!J.radioValue&&"radio"===t&&X.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}}}),tt={set:function(e,t,n){return!1===t?X.removeAttr(e,n):e.setAttribute(n,n),n}},X.each(X.expr.match.bool.source.match(/\w+/g),function(e,t){var n=nt[t]||X.find.attr;nt[t]=function(e,t,i){var r,o;return i||(o=nt[t],nt[t]=r,r=null!=n(e,t,i)?t.toLowerCase():null,nt[t]=o),r}});var it=/^(?:input|select|textarea|button)$/i;X.fn.extend({prop:function(e,t){return fe(this,X.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[X.propFix[e]||e]})}}),X.extend({propFix:{for:"htmlFor",class:"className"},prop:function(e,t,n){var i,r,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o)return(1!==o||!X.isXMLDoc(e))&&(t=X.propFix[t]||t,r=X.propHooks[t]),void 0!==n?r&&"set"in r&&void 0!==(i=r.set(e,n,t))?i:e[t]=n:r&&"get"in r&&null!==(i=r.get(e,t))?i:e[t]},propHooks:{tabIndex:{get:function(e){return e.hasAttribute("tabindex")||it.test(e.nodeName)||e.href?e.tabIndex:-1}}}}),J.optSelected||(X.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null}}),X.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){X.propFix[this.toLowerCase()]=this});var rt=/[\t\r\n\f]/g;X.fn.extend({addClass:function(e){var t,n,i,r,o,a,s="string"==typeof e&&e,l=0,c=this.length;if(X.isFunction(e))return this.each(function(t){X(this).addClass(e.call(this,t,this.className))});if(s)for(t=(e||"").match(ue)||[];c>l;l++)if(n=this[l],i=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(rt," "):" ")){for(o=0;r=t[o++];)i.indexOf(" "+r+" ")<0&&(i+=r+" ");a=X.trim(i),n.className!==a&&(n.className=a)}return this},removeClass:function(e){var t,n,i,r,o,a,s=0===arguments.length||"string"==typeof e&&e,l=0,c=this.length;if(X.isFunction(e))return this.each(function(t){X(this).removeClass(e.call(this,t,this.className))});if(s)for(t=(e||"").match(ue)||[];c>l;l++)if(n=this[l],i=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(rt," "):"")){for(o=0;r=t[o++];)for(;i.indexOf(" "+r+" ")>=0;)i=i.replace(" "+r+" "," ");a=e?X.trim(i):"",n.className!==a&&(n.className=a)}return this},toggleClass:function(e,t){var n=typeof e;return"boolean"==typeof t&&"string"===n?t?this.addClass(e):this.removeClass(e):this.each(X.isFunction(e)?function(n){X(this).toggleClass(e.call(this,n,this.className,t),t)}:function(){if("string"===n)for(var t,i=0,r=X(this),o=e.match(ue)||[];t=o[i++];)r.hasClass(t)?r.removeClass(t):r.addClass(t);else(n===ke||"boolean"===n)&&(this.className&&me.set(this,"__className__",this.className),this.className=this.className||!1===e?"":me.get(this,"__className__")||"")})},hasClass:function(e){for(var t=" "+e+" ",n=0,i=this.length;i>n;n++)if(1===this[n].nodeType&&(" "+this[n].className+" ").replace(rt," ").indexOf(t)>=0)return!0;return!1}});var ot=/\r/g;X.fn.extend({val:function(e){var t,n,i,r=this[0];return arguments.length?(i=X.isFunction(e),this.each(function(n){var r;1===this.nodeType&&(null==(r=i?e.call(this,n,X(this).val()):e)?r="":"number"==typeof r?r+="":X.isArray(r)&&(r=X.map(r,function(e){return null==e?"":e+""})),(t=X.valHooks[this.type]||X.valHooks[this.nodeName.toLowerCase()])&&"set"in t&&void 0!==t.set(this,r,"value")||(this.value=r))})):r?(t=X.valHooks[r.type]||X.valHooks[r.nodeName.toLowerCase()])&&"get"in t&&void 0!==(n=t.get(r,"value"))?n:"string"==typeof(n=r.value)?n.replace(ot,""):null==n?"":n:void 0}}),X.extend({valHooks:{option:{get:function(e){var t=X.find.attr(e,"value");return null!=t?t:X.trim(X.text(e))}},select:{get:function(e){for(var t,n,i=e.options,r=e.selectedIndex,o="select-one"===e.type||0>r,a=o?null:[],s=o?r+1:i.length,l=0>r?s:o?r:0;s>l;l++)if(!(!(n=i[l]).selected&&l!==r||(J.optDisabled?n.disabled:null!==n.getAttribute("disabled"))||n.parentNode.disabled&&X.nodeName(n.parentNode,"optgroup"))){if(t=X(n).val(),o)return t;a.push(t)}return a},set:function(e,t){for(var n,i,r=e.options,o=X.makeArray(t),a=r.length;a--;)i=r[a],(i.selected=X.inArray(i.value,o)>=0)&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),X.each(["radio","checkbox"],function(){X.valHooks[this]={set:function(e,t){return X.isArray(t)?e.checked=X.inArray(X(e).val(),t)>=0:void 0}},J.checkOn||(X.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),X.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){X.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),X.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,i){return this.on(t,e,n,i)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}});var at=X.now(),st=/\?/;X.parseJSON=function(e){return JSON.parse(e+"")},X.parseXML=function(e){var t,n;if(!e||"string"!=typeof e)return null;try{n=new DOMParser,t=n.parseFromString(e,"text/xml")}catch(e){t=void 0}return(!t||t.getElementsByTagName("parsererror").length)&&X.error("Invalid XML: "+e),t};var lt,ct,dt=/#.*$/,ut=/([?&])_=[^&]*/,ht=/^(.*?):[ \t]*([^\r\n]*)$/gm,pt=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,ft=/^(?:GET|HEAD)$/,mt=/^\/\//,gt=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,vt={},yt={},bt="*/".concat("*");try{ct=location.href}catch(e){(ct=G.createElement("a")).href="",ct=ct.href}lt=gt.exec(ct.toLowerCase())||[],X.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ct,type:"GET",isLocal:pt.test(lt[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":bt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":X.parseJSON,"text xml":X.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?O(O(e,X.ajaxSettings),t):O(X.ajaxSettings,e)},ajaxPrefilter:I(vt),ajaxTransport:I(yt),ajax:function(e,t){function n(e,t,n,a){var l,d,v,y,w,C=t;2!==b&&(b=2,s&&clearTimeout(s),i=void 0,o=a||"",x.readyState=e>0?4:0,l=e>=200&&300>e||304===e,n&&(y=D(u,x,n)),y=B(u,y,x,l),l?(u.ifModified&&((w=x.getResponseHeader("Last-Modified"))&&(X.lastModified[r]=w),(w=x.getResponseHeader("etag"))&&(X.etag[r]=w)),204===e||"HEAD"===u.type?C="nocontent":304===e?C="notmodified":(C=y.state,d=y.data,v=y.error,l=!v)):(v=C,(e||!C)&&(C="error",0>e&&(e=0))),x.status=e,x.statusText=(t||C)+"",l?f.resolveWith(h,[d,C,x]):f.rejectWith(h,[x,C,v]),x.statusCode(g),g=void 0,c&&p.trigger(l?"ajaxSuccess":"ajaxError",[x,u,l?d:v]),m.fireWith(h,[x,C]),c&&(p.trigger("ajaxComplete",[x,u]),--X.active||X.event.trigger("ajaxStop")))}"object"==typeof e&&(t=e,e=void 0),t=t||{};var i,r,o,a,s,l,c,d,u=X.ajaxSetup({},t),h=u.context||u,p=u.context&&(h.nodeType||h.jquery)?X(h):X.event,f=X.Deferred(),m=X.Callbacks("once memory"),g=u.statusCode||{},v={},y={},b=0,w="canceled",x={readyState:0,getResponseHeader:function(e){var t;if(2===b){if(!a)for(a={};t=ht.exec(o);)a[t[1].toLowerCase()]=t[2];t=a[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===b?o:null},setRequestHeader:function(e,t){var n=e.toLowerCase();return b||(e=y[n]=y[n]||e,v[e]=t),this},overrideMimeType:function(e){return b||(u.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>b)for(t in e)g[t]=[g[t],e[t]];else x.always(e[x.status]);return this},abort:function(e){var t=e||w;return i&&i.abort(t),n(0,t),this}};if(f.promise(x).complete=m.add,x.success=x.done,x.error=x.fail,u.url=((e||u.url||ct)+"").replace(dt,"").replace(mt,lt[1]+"//"),u.type=t.method||t.type||u.method||u.type,u.dataTypes=X.trim(u.dataType||"*").toLowerCase().match(ue)||[""],null==u.crossDomain&&(l=gt.exec(u.url.toLowerCase()),u.crossDomain=!(!l||l[1]===lt[1]&&l[2]===lt[2]&&(l[3]||("http:"===l[1]?"80":"443"))===(lt[3]||("http:"===lt[1]?"80":"443")))),u.data&&u.processData&&"string"!=typeof u.data&&(u.data=X.param(u.data,u.traditional)),P(vt,u,t,x),2===b)return x;(c=u.global)&&0==X.active++&&X.event.trigger("ajaxStart"),u.type=u.type.toUpperCase(),u.hasContent=!ft.test(u.type),r=u.url,u.hasContent||(u.data&&(r=u.url+=(st.test(r)?"&":"?")+u.data,delete u.data),!1===u.cache&&(u.url=ut.test(r)?r.replace(ut,"$1_="+at++):r+(st.test(r)?"&":"?")+"_="+at++)),u.ifModified&&(X.lastModified[r]&&x.setRequestHeader("If-Modified-Since",X.lastModified[r]),X.etag[r]&&x.setRequestHeader("If-None-Match",X.etag[r])),(u.data&&u.hasContent&&!1!==u.contentType||t.contentType)&&x.setRequestHeader("Content-Type",u.contentType),x.setRequestHeader("Accept",u.dataTypes[0]&&u.accepts[u.dataTypes[0]]?u.accepts[u.dataTypes[0]]+("*"!==u.dataTypes[0]?", "+bt+"; q=0.01":""):u.accepts["*"]);for(d in u.headers)x.setRequestHeader(d,u.headers[d]);if(u.beforeSend&&(!1===u.beforeSend.call(h,x,u)||2===b))return x.abort();w="abort";for(d in{success:1,error:1,complete:1})x[d](u[d]);if(i=P(yt,u,t,x)){x.readyState=1,c&&p.trigger("ajaxSend",[x,u]),u.async&&u.timeout>0&&(s=setTimeout(function(){x.abort("timeout")},u.timeout));try{b=1,i.send(v,n)}catch(e){if(!(2>b))throw e;n(-1,e)}}else n(-1,"No Transport");return x},getJSON:function(e,t,n){return X.get(e,t,n,"json")},getScript:function(e,t){return X.get(e,void 0,t,"script")}}),X.each(["get","post"],function(e,t){X[t]=function(e,n,i,r){return X.isFunction(n)&&(r=r||i,i=n,n=void 0),X.ajax({url:e,type:t,dataType:r,data:n,success:i})}}),X.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){X.fn[t]=function(e){return this.on(t,e)}}),X._evalUrl=function(e){return X.ajax({url:e,type:"GET",dataType:"script",async:!1,global:!1,throws:!0})},X.fn.extend({wrapAll:function(e){var t;return X.isFunction(e)?this.each(function(t){X(this).wrapAll(e.call(this,t))}):(this[0]&&(t=X(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this)},wrapInner:function(e){return this.each(X.isFunction(e)?function(t){X(this).wrapInner(e.call(this,t))}:function(){var t=X(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=X.isFunction(e);return this.each(function(n){X(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){X.nodeName(this,"body")||X(this).replaceWith(this.childNodes)}).end()}}),X.expr.filters.hidden=function(e){return e.offsetWidth<=0&&e.offsetHeight<=0},X.expr.filters.visible=function(e){return!X.expr.filters.hidden(e)};var wt=/%20/g,xt=/\[\]$/,Ct=/\r?\n/g,kt=/^(?:submit|button|image|reset|file)$/i,St=/^(?:input|select|textarea|keygen)/i;X.param=function(e,t){var n,i=[],r=function(e,t){t=X.isFunction(t)?t():null==t?"":t,i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(void 0===t&&(t=X.ajaxSettings&&X.ajaxSettings.traditional),X.isArray(e)||e.jquery&&!X.isPlainObject(e))X.each(e,function(){r(this.name,this.value)});else for(n in e)j(n,e[n],t,r);return i.join("&").replace(wt,"+")},X.fn.extend({serialize:function(){return X.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=X.prop(this,"elements");return e?X.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!X(this).is(":disabled")&&St.test(this.nodeName)&&!kt.test(e)&&(this.checked||!Ce.test(e))}).map(function(e,t){var n=X(this).val();return null==n?null:X.isArray(n)?X.map(n,function(e){return{name:t.name,value:e.replace(Ct,"\r\n")}}):{name:t.name,value:n.replace(Ct,"\r\n")}}).get()}}),X.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(e){}};var Tt=0,Et={},Ft={0:200,1223:204},_t=X.ajaxSettings.xhr();e.ActiveXObject&&X(e).on("unload",function(){for(var e in Et)Et[e]()}),J.cors=!!_t&&"withCredentials"in _t,J.ajax=_t=!!_t,X.ajaxTransport(function(e){var t;return J.cors||_t&&!e.crossDomain?{send:function(n,i){var r,o=e.xhr(),a=++Tt;if(o.open(e.type,e.url,e.async,e.username,e.password),e.xhrFields)for(r in e.xhrFields)o[r]=e.xhrFields[r];e.mimeType&&o.overrideMimeType&&o.overrideMimeType(e.mimeType),e.crossDomain||n["X-Requested-With"]||(n["X-Requested-With"]="XMLHttpRequest");for(r in n)o.setRequestHeader(r,n[r]);t=function(e){return function(){t&&(delete Et[a],t=o.onload=o.onerror=null,"abort"===e?o.abort():"error"===e?i(o.status,o.statusText):i(Ft[o.status]||o.status,o.statusText,"string"==typeof o.responseText?{text:o.responseText}:void 0,o.getAllResponseHeaders()))}},o.onload=t(),o.onerror=t("error"),t=Et[a]=t("abort");try{o.send(e.hasContent&&e.data||null)}catch(e){if(t)throw e}},abort:function(){t&&t()}}:void 0}),X.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return X.globalEval(e),e}}}),X.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),X.ajaxTransport("script",function(e){if(e.crossDomain){var t,n;return{send:function(i,r){t=X("<script>").prop({async:!0,charset:e.scriptCharset,src:e.url}).on("load error",n=function(e){t.remove(),n=null,e&&r("error"===e.type?404:200,e.type)}),G.head.appendChild(t[0])},abort:function(){n&&n()}}}});var Mt=[],Nt=/(=)\?(?=&|$)|\?\?/;X.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Mt.pop()||X.expando+"_"+at++;return this[e]=!0,e}}),X.ajaxPrefilter("json jsonp",function(t,n,i){var r,o,a,s=!1!==t.jsonp&&(Nt.test(t.url)?"url":"string"==typeof t.data&&!(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&Nt.test(t.data)&&"data");return s||"jsonp"===t.dataTypes[0]?(r=t.jsonpCallback=X.isFunction(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,s?t[s]=t[s].replace(Nt,"$1"+r):!1!==t.jsonp&&(t.url+=(st.test(t.url)?"&":"?")+t.jsonp+"="+r),t.converters["script json"]=function(){return a||X.error(r+" was not called"),a[0]},t.dataTypes[0]="json",o=e[r],e[r]=function(){a=arguments},i.always(function(){e[r]=o,t[r]&&(t.jsonpCallback=n.jsonpCallback,Mt.push(r)),a&&X.isFunction(o)&&o(a[0]),a=o=void 0}),"script"):void 0}),X.parseHTML=function(e,t,n){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(n=t,t=!1),t=t||G;var i=oe.exec(e),r=!n&&[];return i?[t.createElement(i[1])]:(i=X.buildFragment([e],t,r),r&&r.length&&X(r).remove(),X.merge([],i.childNodes))};var Lt=X.fn.load;X.fn.load=function(e,t,n){if("string"!=typeof e&&Lt)return Lt.apply(this,arguments);var i,r,o,a=this,s=e.indexOf(" ");return s>=0&&(i=X.trim(e.slice(s)),e=e.slice(0,s)),X.isFunction(t)?(n=t,t=void 0):t&&"object"==typeof t&&(r="POST"),a.length>0&&X.ajax({url:e,type:r,dataType:"html",data:t}).done(function(e){o=arguments,a.html(i?X("<div>").append(X.parseHTML(e)).find(i):e)}).complete(n&&function(e,t){a.each(n,o||[e.responseText,t,e])}),this},X.expr.filters.animated=function(e){return X.grep(X.timers,function(t){return e===t.elem}).length};var At=e.document.documentElement;X.offset={setOffset:function(e,t,n){var i,r,o,a,s,l,c=X.css(e,"position"),d=X(e),u={};"static"===c&&(e.style.position="relative"),s=d.offset(),o=X.css(e,"top"),l=X.css(e,"left"),("absolute"===c||"fixed"===c)&&(o+l).indexOf("auto")>-1?(i=d.position(),a=i.top,r=i.left):(a=parseFloat(o)||0,r=parseFloat(l)||0),X.isFunction(t)&&(t=t.call(e,n,s)),null!=t.top&&(u.top=t.top-s.top+a),null!=t.left&&(u.left=t.left-s.left+r),"using"in t?t.using.call(e,u):d.css(u)}},X.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each(function(t){X.offset.setOffset(this,e,t)});var t,n,i=this[0],r={top:0,left:0},o=i&&i.ownerDocument;return o?(t=o.documentElement,X.contains(t,i)?(typeof i.getBoundingClientRect!==ke&&(r=i.getBoundingClientRect()),n=H(o),{top:r.top+n.pageYOffset-t.clientTop,left:r.left+n.pageXOffset-t.clientLeft}):r):void 0},position:function(){if(this[0]){var e,t,n=this[0],i={top:0,left:0};return"fixed"===X.css(n,"position")?t=n.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),X.nodeName(e[0],"html")||(i=e.offset()),i.top+=X.css(e[0],"borderTopWidth",!0),i.left+=X.css(e[0],"borderLeftWidth",!0)),{top:t.top-i.top-X.css(n,"marginTop",!0),left:t.left-i.left-X.css(n,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent||At;e&&!X.nodeName(e,"html")&&"static"===X.css(e,"position");)e=e.offsetParent;return e||At})}}),X.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,n){var i="pageYOffset"===n;X.fn[t]=function(r){return fe(this,function(t,r,o){var a=H(t);return void 0===o?a?a[n]:t[r]:void(a?a.scrollTo(i?e.pageXOffset:o,i?o:e.pageYOffset):t[r]=o)},t,r,arguments.length,null)}}),X.each(["top","left"],function(e,t){X.cssHooks[t]=C(J.pixelPosition,function(e,n){return n?(n=x(e,t),He.test(n)?X(e).position()[t]+"px":n):void 0})}),X.each({Height:"height",Width:"width"},function(e,t){X.each({padding:"inner"+e,content:t,"":"outer"+e},function(n,i){X.fn[i]=function(i,r){var o=arguments.length&&(n||"boolean"!=typeof i),a=n||(!0===i||!0===r?"margin":"border");return fe(this,function(t,n,i){var r;return X.isWindow(t)?t.document.documentElement["client"+e]:9===t.nodeType?(r=t.documentElement,Math.max(t.body["scroll"+e],r["scroll"+e],t.body["offset"+e],r["offset"+e],r["client"+e])):void 0===i?X.css(t,n,a):X.style(t,n,i,a)},t,o?i:void 0,o,null)}})}),X.fn.size=function(){return this.length},X.fn.andSelf=X.fn.addBack,"function"==typeof define&&define.amd&&define("jquery/jquery",[],function(){return X});var Rt=e.jQuery,It=e.$;return X.noConflict=function(t){return e.$===X&&(e.$=It),t&&e.jQuery===X&&(e.jQuery=Rt),X},typeof t===ke&&(e.jQuery=e.$=X),X})}),define("jquery-localize-master/dist/jquery.localize.js",[],function(e,t,n){!function(e){var t;t=function(e){return e},e.defaultLanguage=t(navigator.languages&&navigator.languages.length>0?navigator.languages[0]:navigator.language||navigator.userLanguage),e.localize=function(n,i){var r,o,a,s,l,c,d,u,h,p,f,m,g,v,y,b,w,x;return null==i&&(i={}),x=this,s={},a=i.fileExtension||"json",o=e.Deferred(),d=function(e,t,n){var i;switch(null==n&&(n=1),n){case 1:return s={},i=t+".lproj/"+e+"."+a,l(i,e,t,n);default:return o.resolve()}},l=function(t,n,r,o){var a,l,c;return null!=i.pathPrefix&&(t=i.pathPrefix+"/"+t),c=function(t){return e.extend(s,t),g(s),d(n,r,o+1)},l=function(){return 2===o&&r.indexOf("-")>-1?d(n,r,o+1):i.fallback&&i.fallback!==r?d(n,i.fallback):void 0},e.localize.data[n]?c(e.localize.data[n]):(a={url:t,dataType:"json",async:!0,timeout:null!=i.timeout?i.timeout:500,success:c,error:l},"file:"===window.location.protocol&&(a.error=function(t){return c(t.responseText?e.parseJSON(t.responseText):{})}),e.ajax(a))},g=function(e){return null!=i.callback?i.callback(e,r):r(e)},r=function(t){return e.localize.data[n]=t,x.each(function(){var n,i,r;if(n=e(this),i=(n.data("localize")||n.data("afterContent")||n.attr("ty-hint")||"").replace(/\\n/g,"\n"),r=w(i,t))return u(n,i,r)})},u=function(t,n,i){if(t.is("input"))f(t,n,i);else if(t.is("textarea"))f(t,n,i);else if(t.is("img"))p(t,n,i);else if(t.is("optgroup"))m(t,n,i);else if(t[0].hasAttribute("data-after-content"))t.attr("data-after-content",i);else if(t[0].hasAttribute("ty-hint"))t.attr("ty-hint",i);else if(t[0].hasAttribute("data-lt"))t.html(i);else{if(e.isPlainObject(i))return h(t,i);t.text(i)}},f=function(t,n,i){var r;if(r=e.isPlainObject(i)?i.value:i,t.is("[placeholder]"))return t.attr("placeholder",r)},h=function(e,t){return y(e,"title",t),b(e,"text",t)},m=function(e,t,n){return e.attr("label",n)},p=function(e,t,n){return y(e,"alt",n),y(e,"src",n)},w=function(e,t){return t[e]||e},y=function(e,t,n){if(null!=(n=w(t,n)))return e.attr(t,n)},b=function(e,t,n){if(null!=(n=w(t,n)))return e.text(n)},v=function(e){var t;return"string"==typeof e?"^"+e+"$":null!=e.length?function(){var n,i,r;for(r=[],n=0,i=e.length;n<i;n++)t=e[n],r.push(v(t));return r}().join("|"):e},c=t(i.language?i.language:e.defaultLanguage),i.skipLanguage&&c.match(v(i.skipLanguage))?o.resolve():d(n,c,1),x.localizePromise=o,x},e.fn.localize=e.localize,e.localize.getString=function(t,n){return(e.localize.data[n||"Front"]||{})[t]||t},e.localize.data={}}(e("jquery/jquery"))}),define("bootstrape/js/bootstrap",[],function(e,t,n){"use strict";if(window.jQuery||(window.$=e("$"),window.jQuery=window.$),"undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");+function(e){var t='[data-dismiss="alert"]',n=function(n){e(n).on("click",t,this.close)};n.VERSION="3.2.0",n.prototype.close=function(t){function n(){o.detach().trigger("closed.bs.alert").remove()}var i=e(this),r=i.attr("data-target");r||(r=(r=i.attr("href"))&&r.replace(/.*(?=#[^\s]*$)/,""));var o=e(r);t&&t.preventDefault(),o.length||(o=i.hasClass("alert")?i:i.parent()),o.trigger(t=e.Event("close.bs.alert")),t.isDefaultPrevented()||(o.removeClass("in"),e.support.transition&&o.hasClass("fade")?o.one("bsTransitionEnd",n).emulateTransitionEnd(150):n())};var i=e.fn.alert;e.fn.alert=function(t){return this.each(function(){var i=e(this),r=i.data("bs.alert");r||i.data("bs.alert",r=new n(this)),"string"==typeof t&&r[t].call(i)})},e.fn.alert.Constructor=n,e.fn.alert.noConflict=function(){return e.fn.alert=i,this},e(document).on("click.bs.alert.data-api",t,n.prototype.close)}(jQuery),function(e){function t(t){return this.each(function(){var i=e(this),r=i.data("bs.button"),o="object"==typeof t&&t;r||i.data("bs.button",r=new n(this,o)),"toggle"==t?r.toggle():t&&r.setState(t)})}var n=function(t,i){this.$element=e(t),this.options=e.extend({},n.DEFAULTS,i),this.isLoading=!1};n.VERSION="3.2.0",n.DEFAULTS={loadingText:"loading..."},n.prototype.setState=function(t){var n="disabled",i=this.$element,r=i.is("input")?"val":"html",o=i.data();t+="Text",null==o.resetText&&i.data("resetText",i[r]()),i[r](null==o[t]?this.options[t]:o[t]),setTimeout(e.proxy(function(){"loadingText"==t?(this.isLoading=!0,i.addClass(n).attr(n,n)):this.isLoading&&(this.isLoading=!1,i.removeClass(n).removeAttr(n))},this),0)},n.prototype.toggle=function(){var e=!0,t=this.$element.closest('[data-toggle="buttons"]');if(t.length){var n=this.$element.find("input");"radio"==n.prop("type")&&(n.prop("checked")&&this.$element.hasClass("active")?e=!1:t.find(".active").removeClass("active")),e&&n.prop("checked",!this.$element.hasClass("active")).trigger("change")}e&&this.$element.toggleClass("active")};var i=e.fn.button;e.fn.button=t,e.fn.button.Constructor=n,e.fn.button.noConflict=function(){return e.fn.button=i,this},e(document).on("click.bs.button.data-api",'[data-toggle^="button"]',function(n){var i=e(n.target);i.hasClass("btn")||(i=i.closest(".btn")),t.call(i,"toggle"),n.preventDefault()})}(jQuery),function(e){function t(t){return this.each(function(){var i=e(this),r=i.data("bs.carousel"),o=e.extend({},n.DEFAULTS,i.data(),"object"==typeof t&&t),a="string"==typeof t?t:o.slide;r||i.data("bs.carousel",r=new n(this,o)),"number"==typeof t?r.to(t):a?r[a]():o.interval&&r.pause().cycle()})}var n=function(t,n){this.$element=e(t).on("keydown.bs.carousel",e.proxy(this.keydown,this)),this.$indicators=this.$element.find(".carousel-indicators"),this.options=n,this.paused=this.sliding=this.interval=this.$active=this.$items=null,"hover"==this.options.pause&&this.$element.on("mouseenter.bs.carousel",e.proxy(this.pause,this)).on("mouseleave.bs.carousel",e.proxy(this.cycle,this))};n.VERSION="3.2.0",n.DEFAULTS={interval:5e3,pause:"hover",wrap:!0},n.prototype.keydown=function(e){switch(e.which){case 37:this.prev();break;case 39:this.next();break;default:return}e.preventDefault()},n.prototype.cycle=function(t){return t||(this.paused=!1),this.interval&&clearInterval(this.interval),this.options.interval&&!this.paused&&(this.interval=setInterval(e.proxy(this.next,this),this.options.interval)),this},n.prototype.getItemIndex=function(e){return this.$items=e.parent().children(".item"),this.$items.index(e||this.$active)},n.prototype.to=function(t){var n=this,i=this.getItemIndex(this.$active=this.$element.find(".item.active"));if(!(t>this.$items.length-1||t<0))return this.sliding?this.$element.one("slid.bs.carousel",function(){n.to(t)}):i==t?this.pause().cycle():this.slide(t>i?"next":"prev",e(this.$items[t]))},n.prototype.pause=function(t){return t||(this.paused=!0),this.$element.find(".next, .prev").length&&e.support.transition&&(this.$element.trigger(e.support.transition.end),this.cycle(!0)),this.interval=clearInterval(this.interval),this},n.prototype.next=function(){if(!this.sliding)return this.slide("next")},n.prototype.prev=function(){if(!this.sliding)return this.slide("prev")},n.prototype.slide=function(t,n){var i=this.$element.find(".item.active"),r=n||i[t](),o=this.interval,a="next"==t?"left":"right",s="next"==t?"first":"last",l=this;if(!r.length){if(!this.options.wrap)return;r=this.$element.find(".item")[s]()}if(r.hasClass("active"))return this.sliding=!1;var c=r[0],d=e.Event("slide.bs.carousel",{relatedTarget:c,direction:a});if(this.$element.trigger(d),!d.isDefaultPrevented()){if(this.sliding=!0,o&&this.pause(),this.$indicators.length){this.$indicators.find(".active").removeClass("active");var u=e(this.$indicators.children()[this.getItemIndex(r)]);u&&u.addClass("active")}var h=e.Event("slid.bs.carousel",{relatedTarget:c,direction:a});return e.support.transition&&this.$element.hasClass("slide")?(r.addClass(t),r[0].offsetWidth,i.addClass(a),r.addClass(a),i.one("bsTransitionEnd",function(){r.removeClass([t,a].join(" ")).addClass("active"),i.removeClass(["active",a].join(" ")),l.sliding=!1,setTimeout(function(){l.$element.trigger(h)},0)}).emulateTransitionEnd(1e3*i.css("transition-duration").slice(0,-1))):(i.removeClass("active"),r.addClass("active"),this.sliding=!1,this.$element.trigger(h)),o&&this.cycle(),this}};var i=e.fn.carousel;e.fn.carousel=t,e.fn.carousel.Constructor=n,e.fn.carousel.noConflict=function(){return e.fn.carousel=i,this},e(document).on("click.bs.carousel.data-api","[data-slide], [data-slide-to]",function(n){var i,r=e(this),o=e(r.attr("data-target")||(i=r.attr("href"))&&i.replace(/.*(?=#[^\s]+$)/,""));if(o.hasClass("carousel")){var a=e.extend({},o.data(),r.data()),s=r.attr("data-slide-to");s&&(a.interval=!1),t.call(o,a),s&&o.data("bs.carousel").to(s),n.preventDefault()}}),e(window).on("load",function(){e('[data-ride="carousel"]').each(function(){var n=e(this);t.call(n,n.data())})})}(jQuery),function(e){function t(t){t&&3===t.which||(e(i).remove(),e(r).each(function(){var i=n(e(this)),r={relatedTarget:this};i.hasClass("open")&&(i.trigger(t=e.Event("hide.bs.dropdown",r)),t.isDefaultPrevented()||i.removeClass("open").trigger("hidden.bs.dropdown",r))}))}function n(t){var n=t.attr("data-target");n||(n=(n=t.attr("href"))&&/#[A-Za-z]/.test(n)&&n.replace(/.*(?=#[^\s]*$)/,""));var i=n&&e(n);return i&&i.length?i:t.parent()}var i=".dropdown-backdrop",r='[data-toggle="dropdown"]',o=function(t){e(t).on("click.bs.dropdown",this.toggle)};o.VERSION="3.2.0",o.prototype.toggle=function(i){var r=e(this);if(!r.is(".disabled, :disabled")){var o=n(r),a=o.hasClass("open");if(t(),!a){"ontouchstart"in document.documentElement&&!o.closest(".navbar-nav").length&&e('<div class="dropdown-backdrop"/>').insertAfter(e(this)).on("click",t);var s={relatedTarget:this};if(o.trigger(i=e.Event("show.bs.dropdown",s)),i.isDefaultPrevented())return;r.trigger("focus"),o.toggleClass("open").trigger("shown.bs.dropdown",s)}return!1}},o.prototype.keydown=function(t){if(/(38|40|27)/.test(t.keyCode)){var i=e(this);if(t.preventDefault(),t.stopPropagation(),!i.is(".disabled, :disabled")){var o=n(i),a=o.hasClass("open");if(!a||a&&27==t.keyCode)return 27==t.which&&o.find(r).trigger("focus"),i.trigger("click");var s=" li:not(.divider):visible a",l=o.find('[role="menu"]'+s+', [role="listbox"]'+s);if(l.length){var c=l.index(l.filter(":focus"));38==t.keyCode&&c>0&&c--,40==t.keyCode&&c<l.length-1&&c++,~c||(c=0),l.eq(c).trigger("focus")}}}};var a=e.fn.dropdown;e.fn.dropdown=function(t){return this.each(function(){var n=e(this),i=n.data("bs.dropdown");i||n.data("bs.dropdown",i=new o(this)),"string"==typeof t&&i[t].call(n)})},e.fn.dropdown.Constructor=o,e.fn.dropdown.noConflict=function(){return e.fn.dropdown=a,this},e(document).on("click.bs.dropdown.data-api",t).on("click.bs.dropdown.data-api",".dropdown form",function(e){e.stopPropagation()}).on("click.bs.dropdown.data-api",r,o.prototype.toggle).on("keydown.bs.dropdown.data-api",r+', [role="menu"], [role="listbox"]',o.prototype.keydown)}(jQuery),function(e){function t(t,i){return this.each(function(){var r=e(this),o=r.data("bs.modal"),a=e.extend({},n.DEFAULTS,r.data(),"object"==typeof t&&t);o||r.data("bs.modal",o=new n(this,a)),"string"==typeof t?o[t](i):a.show&&o.show(i)})}var n=function(t,n){this.options=n,this.$body=e(document.body),this.$element=e(t),this.$backdrop=this.isShown=null,this.scrollbarWidth=0,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,e.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};n.VERSION="3.2.0",n.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},n.prototype.toggle=function(e){return this.isShown?this.hide():this.show(e)},n.prototype.show=function(t){var n=this,i=e.Event("show.bs.modal",{relatedTarget:t});this.$element.trigger(i),this.isShown||i.isDefaultPrevented()||(this.isShown=!0,this.checkScrollbar(),this.$body.addClass("modal-open"),this.setScrollbar(),this.escape(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',e.proxy(this.hide,this)),this.backdrop(function(){var i=e.support.transition&&n.$element.hasClass("fade");n.$element.parent().length||n.$element.appendTo(n.$body),n.$element.show().scrollTop(0),i&&n.$element[0].offsetWidth,n.$element.addClass("in").attr("aria-hidden",!1),n.enforceFocus();var r=e.Event("shown.bs.modal",{relatedTarget:t});i?n.$element.find(".modal-dialog").one("bsTransitionEnd",function(){n.$element.trigger("focus").trigger(r)}).emulateTransitionEnd(300):n.$element.trigger("focus").trigger(r)}))},n.prototype.hide=function(t){t&&t.preventDefault(),t=e.Event("hide.bs.modal"),this.$element.trigger(t),this.isShown&&!t.isDefaultPrevented()&&(this.isShown=!1,this.resetScrollbar(),this.escape(),e(document).off("focusin.bs.modal"),this.$element.removeClass("in").attr("aria-hidden",!0).off("click.dismiss.bs.modal"),e.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",e.proxy(this.hideModal,this)).emulateTransitionEnd(300):this.hideModal())},n.prototype.enforceFocus=function(){e(document).off("focusin.bs.modal").on("focusin.bs.modal",e.proxy(function(e){this.$element[0]===e.target||this.$element.has(e.target).length||this.$element.trigger("focus")},this))},n.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.bs.modal",e.proxy(function(e){27==e.which&&this.hide()},this)):this.isShown||this.$element.off("keyup.dismiss.bs.modal")},n.prototype.hideModal=function(){var t=this;this.$element.hide(),this.backdrop(function(){t.$element.trigger("hidden.bs.modal"),e("body").removeClass("modal-open")})},n.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},n.prototype.backdrop=function(t){var n=this,i=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var r=e.support.transition&&i;if(this.$backdrop=e('<div class="modal-backdrop '+i+'" />').appendTo(this.$body),this.$element.on("click.dismiss.bs.modal",e.proxy(function(e){e.target===e.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus.call(this.$element[0]):this.hide.call(this))},this)),r&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!t)return;r?this.$backdrop.one("bsTransitionEnd",t).emulateTransitionEnd(150):t()}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var o=function(){n.removeBackdrop(),t&&t()};e.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",o).emulateTransitionEnd(150):o()}else t&&t()},n.prototype.checkScrollbar=function(){document.body.clientWidth>=window.innerWidth||(this.scrollbarWidth=this.scrollbarWidth||this.measureScrollbar())},n.prototype.setScrollbar=function(){var e=parseInt(this.$body.css("padding-right")||0,10);this.scrollbarWidth&&this.$body.css("padding-right",e+this.scrollbarWidth)},n.prototype.resetScrollbar=function(){this.$body.css("padding-right","")},n.prototype.measureScrollbar=function(){var e=document.createElement("div");e.className="modal-scrollbar-measure",this.$body.append(e);var t=e.offsetWidth-e.clientWidth;return this.$body[0].removeChild(e),t};var i=e.fn.modal;e.fn.modal=t,e.fn.modal.Constructor=n,e.fn.modal.noConflict=function(){return e.fn.modal=i,this},e(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(n){var i=e(this),r=i.attr("href"),o=e(i.attr("data-target")||r&&r.replace(/.*(?=#[^\s]+$)/,"")),a=o.data("bs.modal")?"toggle":e.extend({remote:!/#/.test(r)&&r},o.data(),i.data());i.is("a")&&n.preventDefault(),o.one("show.bs.modal",function(e){e.isDefaultPrevented()||o.one("hidden.bs.modal",function(){i.is(":visible")&&i.trigger("focus")})}),t.call(o,a,this)})}(jQuery),function(e){var t=function(e,t){this.type=this.options=this.enabled=this.timeout=this.hoverState=this.$element=null,this.init("tooltip",e,t)};t.VERSION="3.2.0",t.DEFAULTS={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1,viewport:{selector:"body",padding:0}},t.prototype.init=function(t,n,i){this.enabled=!0,this.type=t,this.$element=e(n),this.options=this.getOptions(i),this.$viewport=this.options.viewport&&e(this.options.viewport.selector||this.options.viewport);for(var r=this.options.trigger.split(" "),o=r.length;o--;){var a=r[o];if("click"==a)this.$element.on("click."+this.type,this.options.selector,e.proxy(this.toggle,this));else if("manual"!=a){var s="hover"==a?"mouseenter":"focusin",l="hover"==a?"mouseleave":"focusout";this.$element.on(s+"."+this.type,this.options.selector,e.proxy(this.enter,this)),this.$element.on(l+"."+this.type,this.options.selector,e.proxy(this.leave,this))}}this.options.selector?this._options=e.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},t.prototype.getDefaults=function(){return t.DEFAULTS},t.prototype.getOptions=function(t){return(t=e.extend({},this.getDefaults(),this.$element.data(),t)).delay&&"number"==typeof t.delay&&(t.delay={show:t.delay,hide:t.delay}),t},t.prototype.getDelegateOptions=function(){var t={},n=this.getDefaults();return this._options&&e.each(this._options,function(e,i){n[e]!=i&&(t[e]=i)}),t},t.prototype.enter=function(t){var n=t instanceof this.constructor?t:e(t.currentTarget).data("bs."+this.type);if(n||(n=new this.constructor(t.currentTarget,this.getDelegateOptions()),e(t.currentTarget).data("bs."+this.type,n)),clearTimeout(n.timeout),n.hoverState="in",!n.options.delay||!n.options.delay.show)return n.show();n.timeout=setTimeout(function(){"in"==n.hoverState&&n.show()},n.options.delay.show)},t.prototype.leave=function(t){var n=t instanceof this.constructor?t:e(t.currentTarget).data("bs."+this.type);if(n||(n=new this.constructor(t.currentTarget,this.getDelegateOptions()),e(t.currentTarget).data("bs."+this.type,n)),clearTimeout(n.timeout),n.hoverState="out",!n.options.delay||!n.options.delay.hide)return n.hide();n.timeout=setTimeout(function(){"out"==n.hoverState&&n.hide()},n.options.delay.hide)},t.prototype.show=function(){var t=e.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){this.$element.trigger(t);var n=e.contains(document.documentElement,this.$element[0]);if(t.isDefaultPrevented()||!n)return;var i=this,r=this.tip(),o=this.getUID(this.type);this.setContent(),r.attr("id",o),this.$element.attr("aria-describedby",o),this.options.animation&&r.addClass("fade");var a="function"==typeof this.options.placement?this.options.placement.call(this,r[0],this.$element[0]):this.options.placement,s=/\s?auto?\s?/i,l=s.test(a);l&&(a=a.replace(s,"")||"top"),r.detach().css({top:0,left:0,display:"block"}).addClass(a).data("bs."+this.type,this),this.options.container?r.appendTo(this.options.container):r.insertAfter(this.$element);var c=this.getPosition(),d=r[0].offsetWidth,u=r[0].offsetHeight;if(l){var h=a,p=this.$element.parent(),f=this.getPosition(p);a="bottom"==a&&c.top+c.height+u-f.scroll>f.height?"top":"top"==a&&c.top-f.scroll-u<0?"bottom":"right"==a&&c.right+d>f.width?"left":"left"==a&&c.left-d<f.left?"right":a,r.removeClass(h).addClass(a)}var m=this.getCalculatedOffset(a,c,d,u);this.applyPlacement(m,a);var g=function(){i.$element.trigger("shown.bs."+i.type),i.hoverState=null};e.support.transition&&this.$tip.hasClass("fade")?r.one("bsTransitionEnd",g).emulateTransitionEnd(150):g()}},t.prototype.applyPlacement=function(t,n){var i=this.tip(),r=i[0].offsetWidth,o=i[0].offsetHeight,a=parseInt(i.css("margin-top"),10),s=parseInt(i.css("margin-left"),10);isNaN(a)&&(a=0),isNaN(s)&&(s=0),t.top=t.top+a,t.left=t.left+s,e.offset.setOffset(i[0],e.extend({using:function(e){i.css({top:Math.round(e.top),left:Math.round(e.left)})}},t),0),i.addClass("in");var l=i[0].offsetWidth,c=i[0].offsetHeight;"top"==n&&c!=o&&(t.top=t.top+o-c);var d=this.getViewportAdjustedDelta(n,t,l,c);d.left?t.left+=d.left:t.top+=d.top;var u=d.left?2*d.left-r+l:2*d.top-o+c,h=d.left?"left":"top",p=d.left?"offsetWidth":"offsetHeight";i.offset(t),this.replaceArrow(u,i[0][p],h)},t.prototype.replaceArrow=function(e,t,n){this.arrow().css(n,e?50*(1-e/t)+"%":"")},t.prototype.setContent=function(){var e=this.tip(),t=this.getTitle();e.find(".tooltip-inner")[this.options.html?"html":"text"](t),e.removeClass("fade in top bottom left right")},t.prototype.hide=function(){function t(){"in"!=n.hoverState&&i.detach(),n.$element.trigger("hidden.bs."+n.type)}var n=this,i=this.tip(),r=e.Event("hide.bs."+this.type);if(this.$element.removeAttr("aria-describedby"),this.$element.trigger(r),!r.isDefaultPrevented())return i.removeClass("in"),e.support.transition&&this.$tip.hasClass("fade")?i.one("bsTransitionEnd",t).emulateTransitionEnd(150):t(),this.hoverState=null,this},t.prototype.fixTitle=function(){var e=this.$element;(e.attr("title")||"string"!=typeof e.attr("data-original-title"))&&e.attr("data-original-title",e.attr("title")||"").attr("title","")},t.prototype.hasContent=function(){return this.getTitle()},t.prototype.getPosition=function(t){var n=(t=t||this.$element)[0],i="BODY"==n.tagName;return e.extend({},"function"==typeof n.getBoundingClientRect?n.getBoundingClientRect():null,{scroll:i?document.documentElement.scrollTop||document.body.scrollTop:t.scrollTop(),width:i?e(window).width():t.outerWidth(),height:i?e(window).height():t.outerHeight()},i?{top:0,left:0}:t.offset())},t.prototype.getCalculatedOffset=function(e,t,n,i){return"bottom"==e?{top:t.top+t.height,left:t.left+t.width/2-n/2}:"top"==e?{top:t.top-i,left:t.left+t.width/2-n/2}:"left"==e?{top:t.top+t.height/2-i/2,left:t.left-n}:{top:t.top+t.height/2-i/2,left:t.left+t.width}},t.prototype.getViewportAdjustedDelta=function(e,t,n,i){var r={top:0,left:0};if(!this.$viewport)return r;var o=this.options.viewport&&this.options.viewport.padding||0,a=this.getPosition(this.$viewport);if(/right|left/.test(e)){var s=t.top-o-a.scroll,l=t.top+o-a.scroll+i;s<a.top?r.top=a.top-s:l>a.top+a.height&&(r.top=a.top+a.height-l)}else{var c=t.left-o,d=t.left+o+n;c<a.left?r.left=a.left-c:d>a.width&&(r.left=a.left+a.width-d)}return r},t.prototype.getTitle=function(){var e=this.$element,t=this.options;return e.attr("data-original-title")||("function"==typeof t.title?t.title.call(e[0]):t.title)},t.prototype.getUID=function(e){do{e+=~~(1e6*Math.random())}while(document.getElementById(e));return e},t.prototype.tip=function(){return this.$tip=this.$tip||e(this.options.template)},t.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},t.prototype.validate=function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},t.prototype.enable=function(){this.enabled=!0},t.prototype.disable=function(){this.enabled=!1},t.prototype.toggleEnabled=function(){this.enabled=!this.enabled},t.prototype.toggle=function(t){var n=this;t&&((n=e(t.currentTarget).data("bs."+this.type))||(n=new this.constructor(t.currentTarget,this.getDelegateOptions()),e(t.currentTarget).data("bs."+this.type,n))),n.tip().hasClass("in")?n.leave(n):n.enter(n)},t.prototype.destroy=function(){clearTimeout(this.timeout),this.hide().$element.off("."+this.type).removeData("bs."+this.type)};var n=e.fn.tooltip;e.fn.tooltip=function(n){return this.each(function(){var i=e(this),r=i.data("bs.tooltip"),o="object"==typeof n&&n;(r||"destroy"!=n)&&(r||i.data("bs.tooltip",r=new t(this,o)),"string"==typeof n&&r[n]())})},e.fn.tooltip.Constructor=t,e.fn.tooltip.noConflict=function(){return e.fn.tooltip=n,this}}(jQuery),function(e){var t=function(e,t){this.init("popover",e,t)};if(!e.fn.tooltip)throw new Error("Popover requires tooltip.js");t.VERSION="3.2.0",t.DEFAULTS=e.extend({},e.fn.tooltip.Constructor.DEFAULTS,{placement:"right",trigger:"click",content:"",template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}),t.prototype=e.extend({},e.fn.tooltip.Constructor.prototype),t.prototype.constructor=t,t.prototype.getDefaults=function(){return t.DEFAULTS},t.prototype.setContent=function(){var e=this.tip(),t=this.getTitle(),n=this.getContent();e.find(".popover-title")[this.options.html?"html":"text"](t),e.find(".popover-content").empty()[this.options.html?"string"==typeof n?"html":"append":"text"](n),e.removeClass("fade top bottom left right in"),e.find(".popover-title").html()||e.find(".popover-title").hide()},t.prototype.hasContent=function(){return this.getTitle()||this.getContent()},t.prototype.getContent=function(){var e=this.$element,t=this.options;return e.attr("data-content")||("function"==typeof t.content?t.content.call(e[0]):t.content)},t.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".arrow")},t.prototype.tip=function(){return this.$tip||(this.$tip=e(this.options.template)),this.$tip};var n=e.fn.popover;e.fn.popover=function(n){return this.each(function(){var i=e(this),r=i.data("bs.popover"),o="object"==typeof n&&n;(r||"destroy"!=n)&&(r||i.data("bs.popover",r=new t(this,o)),"string"==typeof n&&r[n]())})},e.fn.popover.Constructor=t,e.fn.popover.noConflict=function(){return e.fn.popover=n,this}}(jQuery),function(e){function t(t){return this.each(function(){var i=e(this),r=i.data("bs.tab");r||i.data("bs.tab",r=new n(this)),"string"==typeof t&&r[t]()})}var n=function(t){this.element=e(t)};n.VERSION="3.2.0",n.prototype.show=function(){var t=this.element,n=t.closest("ul:not(.dropdown-menu)"),i=t.data("target");if(i||(i=(i=t.attr("href"))&&i.replace(/.*(?=#[^\s]*$)/,"")),!t.parent("li").hasClass("active")){var r=n.find(".active:last a")[0],o=e.Event("show.bs.tab",{relatedTarget:r});if(t.trigger(o),!o.isDefaultPrevented()){var a=e(i);this.activate(t.closest("li"),n),this.activate(a,a.parent(),function(){t.trigger({type:"shown.bs.tab",relatedTarget:r})})}}},n.prototype.activate=function(t,n,i){function r(){o.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),t.addClass("active"),a?(t[0].offsetWidth,t.addClass("in")):t.removeClass("fade"),t.parent(".dropdown-menu")&&t.closest("li.dropdown").addClass("active"),i&&i()}var o=n.find("> .active"),a=i&&e.support.transition&&o.hasClass("fade");a?o.one("bsTransitionEnd",r).emulateTransitionEnd(150):r(),o.removeClass("in")};var i=e.fn.tab;e.fn.tab=t,e.fn.tab.Constructor=n,e.fn.tab.noConflict=function(){return e.fn.tab=i,this},e(document).on("click.bs.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(n){n.preventDefault(),t.call(e(this),"show")})}(jQuery),function(e){function t(t){return this.each(function(){var i=e(this),r=i.data("bs.affix"),o="object"==typeof t&&t;r||i.data("bs.affix",r=new n(this,o)),"string"==typeof t&&r[t]()})}var n=function(t,i){this.options=e.extend({},n.DEFAULTS,i),this.$target=e(this.options.target).on("scroll.bs.affix.data-api",e.proxy(this.checkPosition,this)).on("click.bs.affix.data-api",e.proxy(this.checkPositionWithEventLoop,this)),this.$element=e(t),this.affixed=this.unpin=this.pinnedOffset=null,this.checkPosition()};n.VERSION="3.2.0",n.RESET="affix affix-top affix-bottom",n.DEFAULTS={offset:0,target:window},n.prototype.getPinnedOffset=function(){if(this.pinnedOffset)return this.pinnedOffset;this.$element.removeClass(n.RESET).addClass("affix");var e=this.$target.scrollTop(),t=this.$element.offset();return this.pinnedOffset=t.top-e},n.prototype.checkPositionWithEventLoop=function(){setTimeout(e.proxy(this.checkPosition,this),1)},n.prototype.checkPosition=function(){if(this.$element.is(":visible")){var t=e(document).height(),i=this.$target.scrollTop(),r=this.$element.offset(),o=this.options.offset,a=o.top,s=o.bottom;"object"!=typeof o&&(s=a=o),"function"==typeof a&&(a=o.top(this.$element)),"function"==typeof s&&(s=o.bottom(this.$element));var l=!(null!=this.unpin&&i+this.unpin<=r.top)&&(null!=s&&r.top+this.$element.height()>=t-s?"bottom":null!=a&&i<=a&&"top");if(this.affixed!==l){null!=this.unpin&&this.$element.css("top","");var c="affix"+(l?"-"+l:""),d=e.Event(c+".bs.affix");this.$element.trigger(d),d.isDefaultPrevented()||(this.affixed=l,this.unpin="bottom"==l?this.getPinnedOffset():null,this.$element.removeClass(n.RESET).addClass(c).trigger(e.Event(c.replace("affix","affixed"))),"bottom"==l&&this.$element.offset({top:t-this.$element.height()-s}))}}};var i=e.fn.affix;e.fn.affix=t,e.fn.affix.Constructor=n,e.fn.affix.noConflict=function(){return e.fn.affix=i,this},e(window).on("load",function(){e('[data-spy="affix"]').each(function(){var n=e(this),i=n.data();i.offset=i.offset||{},i.offsetBottom&&(i.offset.bottom=i.offsetBottom),i.offsetTop&&(i.offset.top=i.offsetTop),t.call(n,i)})})}(jQuery),function(e){function t(t){return this.each(function(){var i=e(this),r=i.data("bs.collapse"),o=e.extend({},n.DEFAULTS,i.data(),"object"==typeof t&&t);!r&&o.toggle&&"show"==t&&(t=!t),r||i.data("bs.collapse",r=new n(this,o)),"string"==typeof t&&r[t]()})}var n=function(t,i){this.$element=e(t),this.options=e.extend({},n.DEFAULTS,i),this.transitioning=null,this.options.parent&&(this.$parent=e(this.options.parent)),this.options.toggle&&this.toggle()};n.VERSION="3.2.0",n.DEFAULTS={toggle:!0},n.prototype.dimension=function(){return this.$element.hasClass("width")?"width":"height"},n.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var n=e.Event("show.bs.collapse");if(this.$element.trigger(n),!n.isDefaultPrevented()){var i=this.$parent&&this.$parent.find("> .panel > .in");if(i&&i.length){var r=i.data("bs.collapse");if(r&&r.transitioning)return;t.call(i,"hide"),r||i.data("bs.collapse",null)}var o=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[o](0),this.transitioning=1;var a=function(){this.$element.removeClass("collapsing").addClass("collapse in")[o](""),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!e.support.transition)return a.call(this);var s=e.camelCase(["scroll",o].join("-"));this.$element.one("bsTransitionEnd",e.proxy(a,this)).emulateTransitionEnd(350)[o](this.$element[0][s])}}},n.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var t=e.Event("hide.bs.collapse");if(this.$element.trigger(t),!t.isDefaultPrevented()){var n=this.dimension();this.$element[n](this.$element[n]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse").removeClass("in"),this.transitioning=1;var i=function(){this.transitioning=0,this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")};if(!e.support.transition)return i.call(this);this.$element[n](0).one("bsTransitionEnd",e.proxy(i,this)).emulateTransitionEnd(350)}}},n.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()};var i=e.fn.collapse;e.fn.collapse=t,e.fn.collapse.Constructor=n,e.fn.collapse.noConflict=function(){return e.fn.collapse=i,this},e(document).on("click.bs.collapse.data-api",'[data-toggle="collapse"]',function(n){var i,r=e(this),o=r.attr("data-target")||n.preventDefault()||(i=r.attr("href"))&&i.replace(/.*(?=#[^\s]+$)/,""),a=e(o),s=a.data("bs.collapse"),l=s?"toggle":r.data(),c=r.attr("data-parent"),d=c&&e(c);s&&s.transitioning||(d&&d.find('[data-toggle="collapse"][data-parent="'+c+'"]').not(r).addClass("collapsed"),r[a.hasClass("in")?"addClass":"removeClass"]("collapsed")),t.call(a,l)})}(jQuery),function(e){function t(n,i){var r=e.proxy(this.process,this);this.$body=e("body"),this.$scrollElement=e(e(n).is("body")?window:n),this.options=e.extend({},t.DEFAULTS,i),this.selector=(this.options.target||"")+" .nav li > a",this.offsets=[],this.targets=[],this.activeTarget=null,this.scrollHeight=0,this.$scrollElement.on("scroll.bs.scrollspy",r),this.refresh(),this.process()}function n(n){return this.each(function(){var i=e(this),r=i.data("bs.scrollspy"),o="object"==typeof n&&n;r||i.data("bs.scrollspy",r=new t(this,o)),"string"==typeof n&&r[n]()})}t.VERSION="3.2.0",t.DEFAULTS={offset:10},t.prototype.getScrollHeight=function(){return this.$scrollElement[0].scrollHeight||Math.max(this.$body[0].scrollHeight,document.documentElement.scrollHeight)},t.prototype.refresh=function(){var t="offset",n=0;e.isWindow(this.$scrollElement[0])||(t="position",n=this.$scrollElement.scrollTop()),this.offsets=[],this.targets=[],this.scrollHeight=this.getScrollHeight();var i=this;this.$body.find(this.selector).map(function(){var i=e(this),r=i.data("target")||i.attr("href"),o=/^#./.test(r)&&e(r);return o&&o.length&&o.is(":visible")&&[[o[t]().top+n,r]]||null}).sort(function(e,t){return e[0]-t[0]}).each(function(){i.offsets.push(this[0]),i.targets.push(this[1])})},t.prototype.process=function(){var e,t=this.$scrollElement.scrollTop()+this.options.offset,n=this.getScrollHeight(),i=this.options.offset+n-this.$scrollElement.height(),r=this.offsets,o=this.targets,a=this.activeTarget;if(this.scrollHeight!=n&&this.refresh(),t>=i)return a!=(e=o[o.length-1])&&this.activate(e);if(a&&t<=r[0])return a!=(e=o[0])&&this.activate(e);for(e=r.length;e--;)a!=o[e]&&t>=r[e]&&(!r[e+1]||t<=r[e+1])&&this.activate(o[e])},t.prototype.activate=function(t){this.activeTarget=t,e(this.selector).parentsUntil(this.options.target,".active").removeClass("active");var n=this.selector+'[data-target="'+t+'"],'+this.selector+'[href="'+t+'"]',i=e(n).parents("li").addClass("active");i.parent(".dropdown-menu").length&&(i=i.closest("li.dropdown").addClass("active")),i.trigger("activate.bs.scrollspy")};var i=e.fn.scrollspy;e.fn.scrollspy=n,e.fn.scrollspy.Constructor=t,e.fn.scrollspy.noConflict=function(){return e.fn.scrollspy=i,this},e(window).on("load.bs.scrollspy.data-api",function(){e('[data-spy="scroll"]').each(function(){var t=e(this);n.call(t,t.data())})})}(jQuery),function(e){function t(){var e=document.createElement("bootstrap"),t={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var n in t)if(void 0!==e.style[n])return{end:t[n]};return!1}e.fn.emulateTransitionEnd=function(t){var n=!1,i=this;e(this).one("bsTransitionEnd",function(){n=!0});return setTimeout(function(){n||e(i).trigger(e.support.transition.end)},t),this},e(function(){e.support.transition=t(),e.support.transition&&(e.event.special.bsTransitionEnd={bindType:e.support.transition.end,delegateType:e.support.transition.end,handle:function(t){if(e(t.target).is(this))return t.handleObj.handler.apply(this,arguments)}})})}($)}),define("app/document/File",["exoskeleton-master/exoskeleton","jquery/jquery","app/editor/UndoManager","app/document/StringUtils","app/document/Node","app/document/Node","app/editor/polyfill","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/MenuHelper","app/window/FileInfoPanel","app/window/steno2"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var i=e("jquery/jquery"),r=e("app/editor/UndoManager"),o=e("app/document/Node"),a=o.Node,s=o.TYPE,l=(e("app/editor/polyfill"),e("app/window/FileHelper")),c=e("app/window/MenuHelper"),d=e("app/window/FileInfoPanel"),u=l.ChangeCounter,h=(l.ChangeType,e("app/window/steno2")),p=window.reqnode?reqnode("electron").remote:null,f=p?p.app:window.app,m={option:{indentSize:2,autoToggleEmojiAutoComplete:!0,enableInlineMath:!1,autoNumberingForMath:!1,enableHighlight:!1,enableSubscript:!1,enableSuperscript:!1,enableDiagram:!1,copyMarkdownByDefault:!1,showLineNumbersForFence:!1,useRelativePathForImg:!1,noSpellCheck:!1,autoCorrectMisspell:!1,noPairingMatch:!1,autoPairExtendSymbol:!1,noPreWrap:!1,autoSave:!1,scrollWithCursor:!1,expandSimpleBlock:!1,printPDFByPhantom:!1,allowImageMove:!0,allowImageUpload:!0,headingStyle:0,ulStyle:0,strictMarkdown:!1,preferCRLF:!1,showFileTree:!0,sortType:0,sidebarTab:""},readOption:function(){function e(e){return m.isMac?f.setting.getBool(e):m.isNode?f.setting.get(e):void 0}function t(e){return m.isMac?f.setting.getInteger(e):m.isNode?f.setting.get(e):void 0}function n(e,t){return void 0===e?t:e}m.isMac||m.isNode?(m.option.autoToggleEmojiAutoComplete=n(e("trigger_emoji_autocomplete"),!0),m.option.enableInlineMath=n(e("enable_inline_math"),!0),m.option.enableHighlight=e("enable_highlight")||!1,m.option.enableSubscript=e("enable_subscript")||!1,m.option.enableSuperscript=e("enable_superscript")||!1,m.option.enableDiagram=n(e("enable_diagram"),!0),m.option.copyMarkdownByDefault=e("copy_markdown_by_default")||!1,m.option.showLineNumbersForFence=e("show_line_numbers_for_fence")||!1,m.option.noPairingMatch=e("no_pairing_match")||!1,m.option.autoPairExtendSymbol=e("match_pari_markdown")||!1,m.option.expandSimpleBlock=e("auto_expand_block")||!1,m.option.headingStyle=t("heading_style")||0,m.option.ulStyle=t("ul_style")||0,m.option.scrollWithCursor=!e("no_mid_caret"),m.option.autoNumberingForMath=e("auto_numbering_for_math"),m.option.useRelativePathForImg=e("use_relative_path_for_img")||!1,m.option.allowImageUpload=e("allow_image_upload")||!1,m.option.allowImageMove=e("allow_image_move")||!1,m.option.preferCRLF=e("line_ending_crlf")||!1,m.option.sidebarTab=f.setting.get("sidebar_tab")||"",m.option.sortType=t("file_sort_type")||0,m.option.strictMarkdown=e("strict_mode")||!1,m.isMac?m.option.indentSize=f.setting.getInteger("indentSize")||2:m.isNode&&(f.setting.get("useCustomFontSize")&&(document.body.parentElement.style.fontSize=f.setting.get("customFontSize")+"px"),m.option.indentSize=f.setting.get("indentSize")||2,m.option.enableAutoSave=f.setting.get("enableAutoSave")||!1,m.option.saveFileOnSwitch=f.setting.get("save_file_on_switch")||!1,m.option.noSpellCheck=f.setting.get("no_spell_check")||!1,m.option.autoCorrectMisspell=f.setting.get("auto_correct_misspell")||!1),m.option.showLineNumbersForFence&&i("#write").addClass("show-fences-line-number"),window.innerWidth<540&&(m.option.sidebarTab=null),m.setCanCollapsePinnedOutline(e("can_collapse_outline_panel")),m.option.passiveEvents=m.isNodeHtml):window._options&&(m.option=i.extend(m.option,window._options))},setEditor:function(e){m.isLocked=m.isMac&&f.document.isLocked(),m.editor=e,m.isMac||(m.changeCounter=new u)},getFilePathUseNode:function(){if(m.isNode){var e=p.getCurrentWindow(),t=p.app.getDocumentController().getDocumentFromWindowId(e.id).path;m.mountFolder_||(m.mountFolder_=e.initMountFolder,e.initMountFolder=void 0)}return t},setLineEnding:function(e,t){if(e!=m.useCRLF){m.useCRLF=e;var n;if(m.isMac)n=f.menu.getItem("Edit").submenu().getItem("Line Endings").submenu();else{if(!m.isNode)return;n=p.Menu.getApplicationMenu().getItem("Edit").submenu.getItem("Line Endings").submenu}if(n.getItem("Windows Line Endings (CRLF)").setState(m.useCRLF),n.getItem("Unix Line Endings (LF)").setState(!m.useCRLF),t){m.sync();var i=m.editor.getMarkdown();i=(i.split(/\r?\n/g)||[i]).join(m.useCRLF?"\r\n":"\n"),m.reloadContent(i),m.isMac&&m.setLineEnding(e)}}},getContent:function(e,t){m.setLineEnding(m.option.preferCRLF);var n;if(m.isMac)return n=f.document.content||"",m.setLineEnding(n.indexOf("\r\n")>-1&&!/[^\r]\n/.exec("a"+n)),n;if(m.isNode){var r=e;try{if(r=e||m.getFilePathUseNode()){var o=m.fs.readFileSync(r),a=t||l.detectEncodeByNode(o);return n=l.getContentFromBuffer(o,a),m.setLineEnding(n.indexOf("\r\n")>-1||!(n.indexOf("\n")>-1)&&m.option.preferCRLF),d.setFileTitle(r,a),n}d.setFileTitle()}catch(e){var s=e.message||"";return debugMode||(s=s.splits&&s.splits(/\n/)[0]||s),p.dialog.showErrorBox(i.localize.getString("Failed to load file"),s),d.setFileTitle(""),r&&f.getDocumentController().getDocument(r).switchToUntitled(),""}}return""},setContent:function(e,t){m.isMac?f.document.content=e:t&&m.isNode&&m.getCurrentDocByNode().setContent(e)},getMountFolder:function(){return m.isMac?f.controller.cachedMountFolder():m.mountFolder_},setMountFolder:function(e){m.mountFolder_=e},sync:function(e,t){if(m.isActiveWindow())if(m.editor.sourceView.inSourceMode){var n=m.editor.sourceView.cm.getValue(m.useCRLF?"\r\n":"\n");m.setContent(n,t),m.isMac&&e&&f.document.isDocumentEdited()&&m.editor.sourceView.onSave()}else{m.editor.undo.completeSnap(!0),m.editor.store(null,!0);try{i(".md-focus").closest(".unholdable").length||m.editor.autoRemoveUnholdable()}catch(e){console.error(e.stack)}m.setContent(m.editor.getMarkdown(),t)}},isActiveWindow:function(){if(m.isMac)return f.controller.isActiveWindow();if(!m.isNode)return!0;var e=p.getCurrentWindow();if(e.id===(m.getCurrentDocByNode().activeWindow||{}).id)return!0;e.isFocused()&&(console.warn("error found on windows focus management"),window.onWindowFocus())},shouldTriggerSyncChange:function(){if(m.isMac)return f.controller.shouldTriggerSyncChange();if(m.isNode){var e=m.getCurrentDocByNode();return m.isActiveWindow()&&e.windows.size>1}},getCurrentDocByNode:function(){return f.getDocumentController().getDocumentFromWindowId(p.getCurrentWindow().id)},saveUseNode:function(e,t){function n(e){console.log("swith to utf8 encode"),o=Buffer.from(c),m.fileEncode="utf8"}function r(){console.error("fs write failed"),m.inSavingProcess=!1,m.updateChangeCount(m.ChangeType.NSChangeReadOtherContents)}if(m.isActiveWindow()){m.sync();var o,a=m.getFilePathUseNode(),s=m.fileEncode||"utf8",c=m.editor.getMarkdown();if(m.isNode){var d=reqnode("iconv-lite");try{o=d.encode(c,s)}catch(e){n()}0==o.length&&""!=c&&n(),a&&!t?(m.inSavingProcess=m.inSavingProcess||!t,f.sendEvent("willSave",a),h.writeFile(a,o,function(t){if(t)return alert(i.localize.getString("Save File Failed")+"\n"+t.stack),console.error(t.stack),void r();try{if(o.length&&0==m.fs.statSync(a).size)return void r()}catch(e){return void r()}m.resumeFileChangeTimestamp=new Date,m.lastSaved=m.resumeFileChangeTimestamp,m.getCurrentDocByNode().setLastSync(m.resumeFileChangeTimestamp-0),m.inSavingProcess=!1,e&&e(t),f.sendEvent("didSave",{path:a,summary:c.substr(0,200)})}),m.updateChangeCount(m.ChangeType.NSChangeAutosaved)):l.showSaveDialog(e||void 0)}}},updateChangeCount:function(e){if(m.editor.sourceView&&m.editor.sourceView.inSourceMode)m.isMac?e==m.ChangeType.NSChangeAutosaved?(m.editor.sourceView.cm.save(),f.document.updateChangeCount(e)):e==m.ChangeType.NSChangeCleared?f.document.updateChangeCount(e):f.document.isDocumentEdited()||f.document.updateChangeCount(m.ChangeType.NSChangeDone):(m.changeCounter.updateChangeCount(e),e===m.ChangeType.NSChangeAutosaved&&d.setLastModified(new Date));else if(m.needsUpdateSnap(),m.isMac){f.document.updateChangeCount(e);var t=f.menu.getItem("Edit");t&&(t.submenu().getItem("Undo").setEnabled(m.editor.undo.hasUndo()),t.submenu().getItem("Redo").setEnabled(m.editor.undo.hasRedo()))}else if(m.changeCounter.updateChangeCount(e),e===m.ChangeType.NSChangeAutosaved?(v=!1,d.setLastModified(new Date)):v=!0,m.isNode){var n=p.Menu.getApplicationMenu().getItem("Edit").submenu;n.getItem("Undo").setEnabled(m.editor.undo.hasUndo()),n.getItem("Redo").setEnabled(m.editor.undo.hasRedo()),releasePrintWin_(),releaseCaptureWin_()}},onSwitchDocumentTarget:function(e,t){m.editor.brush.clearAndPause(),m.fileHasModified=!1,m.editor.focusCid=null;var n=m.editor.sourceView.inSourceMode;e&&e.nodeMap&&e.undoRedo?m.restoreEditStateFromData(e):(m.changeCounter&&m.changeCounter.reset(),m.editor.undo.reset(),m.editor.nodeMap.reset(!1,!0),m.editor.reset(n?"":m.getContent(t))),n&&m.editor.sourceView.setValue(m.getContent(t),!0);var r=null,o=0;if(!(e&&e.nodeMap)&&m.editor.undo.reset(),window.getSelection().removeAllRanges(),m.editor.brush.restart(),m.isMac){m.editor.library.markCurrentFile();var a=f.window.getLastCursor()||[];r=JSON.parse(a[1]||"null"),o=a[2]||0}r&&setTimeout(function(){m.editor.undo.exeCommand(r)},500),i("content").scrollTop(o),m.freshMenu(),m.editor.brush.updateWordCount(),m.editor.refresh(),m.getMountFolder()||m.editor.library.onRootChanged()},getDocumentSnap:function(){if(!m.option.showFileTree)return null;if(m.isMac)return f.document.snap;if(m.isNode){var e=m.getCurrentDocByNode();if(e)return e.snap}},restoreEditStateFromData:function(e,t,n){if(!e||!e.undoRedo||!e.nodeMap)return!0;if(e.timeStamp==(m.isMac?f.controller.contentSnapRestoredTime:m.contentSnapRestoredTime))return!0;var r=null,a=m.editor,s=a.sourceView&&a.sourceView.inSourceMode,l=!1;if(m.editor.focusCid=null,m.editor.lastCursor=null,a.nodeMap.restoreFromJson(JSON.parse(e.nodeMap)),a.undo.restoreFromJson(JSON.parse(e.undoRedo)),m.setLineEnding(e.useCRLF),m.isNode&&(l=!m.getCurrentDocByNode().isSnapValid(),e.content=e.srcContent=m.getCurrentDocByNode().content),s)t&&(r=a.sourceView.cm.getScrollInfo().top),m.reloadContent(e.srcContent,!0,!1,!1,!0),e.srcHist&&(a.sourceView.cm.doc.clearHistory(),a.sourceView.cm.doc.setHistory(JSON.parse(e.srcHist))),e.fromSourceMode||m.reloadContent(e.content,!1,!1,!1,n||!f.document.isDocumentEdited()),t&&a.sourceView.cm.scrollTo(0,r);else if(t&&(r=i("content").scrollTop()),e.fromSourceMode?m.reloadContent(e.srcContent,!1,!1,!1,!0,n):l||(i(a.sessionStr).html(o.NodeCollectionUtils.toHTML(a.nodeMap.blocks)),n||(a.focusCid=void 0,a.refresh())),t){if("object"==typeof t)try{a.undo.exeCommand(t)}catch(e){}i("content").scrollTop(r)}if(m.isMac&&(f.controller.contentSnapRestoredTime=e.timeStamp),m.isNode){if(m._needsUpdateSnap=!1,m.contentSnapRestoredTime=e.timeStamp,m.changeCounter.reset(e.changeCounter),l)return m.reloadContent(m.getContent(),!1,!1,!0,!1,n),m.updateChangeCount(m.ChangeType.NSChangeAutosaved),void(m.fileHasModified=!1);d.setFileTitle(m.filePath,e.fileEncode)}n||(m.freshMenu(),m.editor.brush.updateWordCount(),m.editor.refresh(!1,!0))},needsUpdateSnap:function(){m.isMac?f.document.needsUpdateSnap():m._needsUpdateSnap=!0},backupDocumentSnap:function(){m.isMac&&f.document.backupDocumentSnap(),m.isNode&&m.buildDocumentSnap()},backupLastCursor:function(){if(m.isMac){var e=m.editor.sourceView.inSourceMode;f.window.setLastCursor(JSON.stringify(m.editor.selection.buildUndo()||null),e?0:i("content").scrollTop())}},buildDocumentSnap:function(){function e(){var e=m.editor.sourceView.inSourceMode,t={nodeMap:JSON.stringify(m.editor.nodeMap.storeToJson()),undoRedo:JSON.stringify(m.editor.undo.storeToJson()),timeStamp:new Date-0,cursorPos:JSON.stringify(m.editor.selection.buildUndo()),scrollOffset:e?0:i("content").scrollTop(),useCRLF:m.useCRLF};return e&&(t.fromSourceMode=!0,t.srcHist=JSON.stringify(m.editor.sourceView.cm.doc.getHistory())),m.isNode&&(t.fileEncode=m.fileEncode,t.changeCounter=m.changeCounter.clone(),m.contentSnapRestoredTime=t.timeStamp),m.isMac&&(f.controller.contentSnapRestoredTime=t.timeStamp),t}if(m.option.showFileTree&&(m.sync(!1,!0),m.isMac&&f.document.buildDocumentSnap(e()),m.isNode)){var t;if(!m._needsUpdateSnap)return;m._needsUpdateSnap=!1,(t=m.getCurrentDocByNode())&&t.shouldSaveSnap()&&t.addSnap(e())}},presentedItemChanged:function(){if(m.isActiveWindow())if(console.log("presentedItemChanged"),m.isNode){if(m.filePath){if(m.inSavingProcess)return}else m.filePath=m.getFilePathUseNode(),m.fileName=l.getFileNameFromPath(path);var e=new Date,t=e-m.resumeFileChangeTimestamp>1e3;if(m.isMacNode&&e-m.lastSaved<2e3&&(t=!1),m.filePath&&t){var n=m.changeCounter.isDocumentEdited();!function(e){var t,n=i("content").scrollTop();e?(m.isMac?t=f.document.getDataFromFile(!0):m.isNode&&(t=m.getContent(m.filePath,m.fileEncode)),m.reloadContent(t,!1,!1,!0),m.updateChangeCount(m.ChangeType.NSChangeAutosaved),m.editor.sourceView.inSourceMode&&m.editor.sourceView.setValue(t),setTimeout(function(){m.setContent(t),i("content").scrollTop(n)},0)):m.updateChangeCount(m.ChangeType.NSChangeReadOtherContents)}(!n||confirm(i.localize.getString("File content is changed by external applications. Reload content from disk ?"))),n&&p.getCurrentWindow().focus()}m.resumeFileChangeTimestamp=new Date}else m.isMac&&(f.document.isDocumentEdited()&&!confirm(i.localize.getString("File content is changed by external applications. Reload content from disk ?"))||f.document.refreshContentFromDisk())},reloadWithEncoding:function(e){if(m.isNode&&m.filePath){var t=m.getContent(m.filePath,e);m.reloadContent(t),m.updateChangeCount(m.ChangeType.NSChangeCleared)}},reloadContent:function(e,t,n,a,s,l){var c,d,u=r.makeEmptyCommand(),h=m.editor.sourceView&&m.editor.sourceView.inSourceMode;if(m.isMac&&m.setLineEnding(m.useCRLF),h||l||(m.editor.store(),m.editor.undo.completeSnap(!0),u.undo.push(m.editor.selection.buildUndo())),m.editor.focusCid=null,m.editor.lastCursor=null,u.undo.push(r.buildAllDoc(m.editor.nodeMap,a)),h&&(d=m.editor.sourceView.cm.getCursor(),m.editor.sourceView.setValue(e,!0,a||s?"fromDisk":"begin")),h&&a||(m.editor.nodeMap.reset(),(c=o.Node.parseFrom(e,m.editor.nodeMap,{skips:{old_code:!1}}))[1].map(function(e){e.set("attachTo",m.editor.nodeMap)}),u.redo.push(r.buildAllDoc(m.editor.nodeMap,a)),h?(m.editor.sourceView.renderedHTML=c[0],m.editor.undo.register(u,s)):i(m.editor.sessionStr).html(c[0])),h){var p=m.editor.sourceView.cm.getInputField();return p.setSelectionRange&&p.setSelectionRange(0,0),void m.editor.sourceView.cm.setCursor(d)}if(a){var f=m.editor.undo.lastRegisteredOperationCommand(),g=f&&f.undo.last();g&&"reload"==g.type&&g.reloadFromDisk&&(u.undo=[g],m.editor.undo.removeLastRegisteredOperationCommand())}m.editor.undo.register(u,s),l||(t?(m.editor.undo.reset(),m.updateChangeCount(m.ChangeType.NSChangeAutosaved)):window.getSelection().removeAllRanges(),setTimeout(function(){m.editor.refresh(),m.editor.selection.scrollAdjust()},n?500:0))},copy:function(){m.editor.UserOp.copyHandler(m.editor)},delete:function(){"TEXTAREA"!=document.activeElement.tagName&&"INPUT"!=document.activeElement.tagName&&m.editor.UserOp.backspaceHandler(m.editor,null,"Backspace")},deleteActive:function(){var e=m.editor.getMarkElem(),t=m.editor.findNodeByElem(e),n=m.editor.UserOp.backToParagraph(editor,t,!0);m.editor.undo.register(n)},cut:function(){if(m.isLocked)return!1;m.editor.refocus(void 0,!0),m.editor.snapSelection=editor.selection.buildUndo(),m.editor.UserOp.copyHandler(editor,null),m.editor.UserOp.backspaceHandler(editor,null,"delSelection")},pasteAsPlainText:function(){i(m.editor.sessionStr).trigger("pasteAsPlainText")},lock:function(){m.isLocked=!0,m.freshLock()},unlock:function(){m.isLocked=!1,m.freshLock()},toggleSourceMode:function(){m.editor.sourceView.inSourceMode?(m.editor.sourceView.hide(),m.editor.library.recoverSidebar()):(m.editor.library.tmpHideSidebar(),m.editor.sourceView.show()),m.freshMenu()},isFocusedOnWriteDiv:function(){return i(document.activeElement).closest("#write").length>0},getExtraContext:function(e){if(!e)return"default";if(document.querySelector("#write").contains(e))return function(){try{if(a.isType(document.activeElement.tagName,"INPUT","TEXTAREA"))return"";var e=editor.selection.getRangy(),t=editor.getMarkElem(),n=i(".md-expand"),r=t.attr("mdtype"),o=/^file:\/\//;if(/^table/g.exec(r)&&!m.isLocked)return"table|seperator|insertParagraphBefore|insertParagraphAfter";if(a.isType(r,s.math_block))return"copyMathBlock|delete|seperator|insertParagraphBefore|insertParagraphAfter";if(a.isType(r,s.fences))return"delete-fences|insertParagraphBefore|insertParagraphAfter";if(t.attr("tabindex"))return"copy|delete|seperator|insertParagraphBefore|insertParagraphAfter";if(e&&i(e.commonAncestorContainer).closest(".md-inline-math").length)return"copyMathInline";if(a.isType(n.hasClass("md-img-loaded")&&n.attr("md-inline"),s.image)&&o.exec(n.find("img").attr("src")))return"revealInFinder";if(a.isType(n.hasClass("md-img-loaded")&&n.attr("md-inline"),s.refimg)&&o.exec(n.find("img").attr("src")))return"revealInFinder"}catch(e){}return""}();if(m.editor.sourceView.inSourceMode&&document.querySelector("#typora-source").contains(e))return"sourceMode";if(m.getMountFolder()){var t=m.editor.getJQueryElem(e).closest(".file-library-node");return m.editor.library.useTreeStyle?t.attr("data-path")==m.getMountFolder()?"folder-root":t.length?"true"==t.attr("data-is-directory")?"folder":"file":"default":t.length?"file-list":"default"}return""},getCurBlockType:function(){try{if(document.activeElement.hasAttribute&&document.activeElement.hasAttribute("tabindex"))return i(document.activeElement).closest("[mdtype]").attr("mdtype")||"";if(rangy.getSelection().rangeCount){var e=m.editor.selection.getRangy();return i(e.commonAncestorContainer).closest("[mdtype]").attr("mdtype")||""}}catch(e){}return""},freshLock:function(e){void 0!==e&&(m.isLocked=e),i("input, selector").prop("readOnly",m.isLocked||!1),i(".CodeMirror").each(function(){this.CodeMirror&&(this.CodeMirror.options.readOnly=m.isLocked||!1)}),m.isLocked?(m.editor.tableEdit.unfocusAll(),i("[contenteditable=true]").attr("locked","true").attr("contenteditable","false"),i(m.editor.sessionStr).blur(),i(".md-expand").removeClass("md-expand")):i("[locked='true']").attr("locked","false").attr("contenteditable","true"),i("#md-searchpanel input").prop("readOnly",!1),m.freshMenu(),m.editor.sourceView.inSourceMode&&m.editor.sourceView.cm.focus(),setTimeout(function(){m.isMac&&f.touchBar&&f.touchBar.freshLock()},100)},setTheme:function(e){function t(){function e(e){var t=Number(e).toString(16).toUpperCase();return 1==t.length?"0"+t:t}var t=window.getComputedStyle(document.body).backgroundColor.match(/\d+/gi);t.length&&(m.isMac?f.window.setBackgroundColor(t[0],t[1],t[2],t[3]||256):f.setting.put("backgroundColor",function(t,n,i){return"#"+e(t)+e(n)+e(i)}(t[0],t[1],t[2])),m.colorBrightness=(299*t[0]+587*t[1]+114*t[2])/256e3),m.isMac&&("true"!=(window.getComputedStyle(document.body).getPropertyValue("--typora-center-window-title")||"").trim()&&document.body.classList.contains("pin-outline")?f.window.setTitlebarTextMarginLeft(document.querySelector("#typora-sidebar").getBoundingClientRect().width):f.window.setTitlebarTextMarginLeft(void 0))}m.colorBrightness=1;var n=function(){setTimeout(t,100),m.editor.refresh(!0),m.isFocusMode&&m.editor.updateFocusMode(!1),m.isTypeWriterMode&&m.editor.setTypeWriterMode(!0,!0)};if(m.isMac){var r=document.getElementById("theme_css"),o=r.getAttribute("href"),a=f.setting.get("currentThemeFolder")||r.href.replace(/\/([a-z-]+)\.css$/i,"");if(e=e||f.setting.get("theme")||"github",e=e.replace(/\s*([A-Z])/g,"-$1").replace(/^-/,"").toLowerCase(),f.setting.getBool("allow_custom_fontsize")){var s=(f.setting.getDouble("custom_fontsize")||16)+"";document.body.parentElement.style.fontSize=s+"px"}o!=e&&i.get(a+"/"+e+".css",function(){r.setAttribute("href",a+"/"+e+".css")}).then(function(){setTimeout(n,20)}),document.querySelector("#base_user_css").setAttribute("href",a+"/base.user.css"),document.querySelector("#theme_user_css").setAttribute("href",a+"/"+e+".user.css")}else if(m.isNode){var l=f.setting.getCurrentTheme(),c=f.getPath("userData"),d=m.isWin?"\\":"/";i("#theme_css").attr("href",[c,"themes",l].join(d)),setTimeout(n,20),document.querySelector("#base_user_css").setAttribute("href",[c,"themes","base.user.css"].join(d)),document.querySelector("#theme_user_css").setAttribute("href",[c,"themes",l.replace(/\.css$/,".user.css")].join(d)),m.isMacNode&&f.setting.refreshThemeMenu()}},getFileName:function(e){if(m.isMac){var t=f.document.currentFilePath(),n=f.document.currentFolderPath(),i=void 0;return t&&n&&(i=t.replace(n,"").replace(/^\//g,"")),i||(e?m.getSuggestedFileName():void 0)}return m.fileName||(e?m.getSuggestedFileName():void 0)},getSuggestedFileName:function(e){if(m.fileName)return m.fileName.replace(/\.[^.]+$/,"");if(e){var t=m.getFileName();if(t)return t.replace(/\.[^.]+$/,"")}m.editor.nodeMap.blocks;var n,r,o="",a="";try{(r=m.editor.docMenu.getMetaNode())&&(a=m.editor.docMenu.getValueInMeta("date",r)||"",a=(/\d+-\d+-\d+/g.exec(a)||/\d+\/\d+\/\d+/g.exec(a)||[""])[0],o=(o=m.editor.docMenu.getValueInMeta("title",r)||"").replace(/(^\s*("|'))|(("|')\s*)/gi,"").replace(/\s+(.)/gi,"-$1").toLocaleString(),o=a&&o?[a,o].join("-"):o),0!=o.trim().length&&"-"!=o||(n=i(i("#write h1, #write h2, #write h3")[0]),m.editor.sourceView.inSourceMode?(o=(o=m.editor.getMarkdown()).substr(0,o.indexOf("\n"))||o).length>60&&(o=o.substr(0,o.indexOf("."))||o):n.length?o=m.editor.UserOp.getDisplayText(n).replace(/\r?\n/gi,""):(o=(o=(n=i(i("[cid]:not(.md-meta-block)")[0])).length?m.editor.UserOp.getDisplayText(n):"").substr(0,o.indexOf("\n"))||o).length>60&&(o=o.substr(0,o.indexOf("."))||o),o.replace(/\u00A0|\n/g," ")),o.length>120&&(o=o.substr(0,120))}catch(e){}return 0==o.trim().length&&(o=i.localize.getString("Untitled","Front")),o},setCanCollapsePinnedOutline:function(e){e?document.body.classList.remove("no-collapse-outline"):document.body.classList.add("no-collapse-outline")},refreshImageCopyStatus:function(e,t){e?(g&&clearTimeout(g),g=setTimeout(function(){c.doRefreshImageCopyStatus(t)},500)):c.doRefreshImageCopyStatus(t)}},g=null,v=!1,y=function(e){m.editor.brush.timerID&&m.isActiveWindow()&&(v&&(v=!1,d.saveToRecover(m.editor.getMarkdown())),!0!==e&&m.option.enableAutoSave&&m.fileHasModified&&m.changeCounter.isDocumentEdited()&&m.filePath&&m.saveUseNode())};if(m.ChangeType=l.ChangeType,m.isMac=void 0!==window.app,m.isNode=void 0!==window.reqnode,m.isMacNode=m.isNode&&"darwin"==process.platform,m.isMacOrMacNode=m.isMac||m.isMacNode,m.isNodeHtml=window.isOnWindowHtml,m.isWin=m.isNode&&"win32"==process.platform,m.isLinux=m.isNode&&"linux"==process.platform,m.isUnixNode=m.isLinux||m.isMacNode,m.FileInfoPanel=d,m.autoSaveWorker=y,m.freshMenu=c.freshMenu,m.bindMenu=c.bindMenu,m.isNode){m.fs=reqnode("fs");var b=f.setting.config||{},w=Number.parseFloat(b.autoSaveTimer||5);w&&!Number.isNaN(w)||(w=5),setInterval(y,60*w*1e3)}n.exports=m}),define("exoskeleton-master/exoskeleton",["jquery/jquery"],function(e,t){"use strict";var n,i=window,r=e("jquery/jquery"),o=i.Backbone,a=i.Exoskeleton,s=t.utils=n=n||{};t.$=r;var l=[],c=l.slice,d={}.toString;t.noConflict=function(){return i.Backbone=o,i.Exoskeleton=a,this},t.extend=function(e,t){var i,r=this;i=e&&n.has(e,"constructor")?e.constructor:function(){return r.apply(this,arguments)},n.extend(i,r,t);var o=function(){this.constructor=i};return o.prototype=r.prototype,i.prototype=new o,e&&n.extend(i.prototype,e),i.__super__=r.prototype,i};var u=function(){throw new Error('A "url" property or function must be specified')},h=function(e,t){var n=t.error;t.error=function(i){n&&n(e,i,t),e.trigger("error",e,i,t)}},p=function(e){return"function"==typeof n[e]};s.result=function(e,t){var n=e?e[t]:void 0;return"function"==typeof n?e[t]():n},s.defaults=function(e){return c.call(arguments,1).forEach(function(t){for(var n in t)void 0===e[n]&&(e[n]=t[n])}),e},s.extend=function(e){return c.call(arguments,1).forEach(function(t){for(var n in t)e[n]=t[n]}),e},s.clone=function(e){return!e instanceof Object?e:Array.isArray(e)?e.slice():s.extend({},e)};var f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};s.escape=function(e){return null==e?"":String(e).replace(/[&<>"']/g,function(e){return f[e]})},s.sortBy=function(e,t,n){var i="function"==typeof t?t:function(e){return e[t]};return e.map(function(e,t,r){return{value:e,index:t,criteria:i.call(n,e,t,r)}}).sort(function(e,t){var n=e.criteria,i=t.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(n<i||void 0===i)return-1}return e.index-t.index}).map(function(e){return e.value})};var m=0;s.uniqueId=function(e){var t=++m+"";return e?e+t:t},s.has=function(e,t){return Object.hasOwnProperty.call(e,t)};var g=function(e,t,i,r){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;var o=d.call(e);if(o!=d.call(t))return!1;switch(o){case"[object String]":return e==String(t);case"[object Number]":return e!==+e?t!==+t:0===e?1/e==1/t:e===+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var a=i.length;a--;)if(i[a]==e)return r[a]==t;var s=e.constructor,l=t.constructor;if(s!==l&&!("function"==typeof s&&s instanceof s&&"function"==typeof l&&l instanceof l))return!1;i.push(e),r.push(t);var c=0,u=!0;if("[object Array]"===o){if(c=e.length,u=c===t.length)for(;c--&&(u=g(e[c],t[c],i,r)););}else{for(var h in e)if(n.has(e,h)&&(c++,!(u=n.has(t,h)&&g(e[h],t[h],i,r))))break;if(u){for(h in t)if(n.has(t,h)&&!c--)break;u=!c}}return i.pop(),r.pop(),u};s.isEqual=function(e,t){return g(e,t,[],[])};var v=t.Events={on:function(e,t,n){return b(this,"on",e,[t,n])&&t?(this._events||(this._events={}),(this._events[e]||(this._events[e]=[])).push({callback:t,context:n,ctx:n||this}),this):this},once:function(e,t,n){if(!b(this,"once",e,[t,n])||!t)return this;var i,r=this,o=function(){i||(i=!0,r.off(e,o),t.apply(this,arguments))};return o._callback=t,this.on(e,o,n)},off:function(e,t,n){var i,r,o,a,s,l,c,d;if(!this._events||!b(this,"off",e,[t,n]))return this;if(!e&&!t&&!n)return this._events=void 0,this;for(s=0,l=(a=e?[e]:Object.keys(this._events)).length;s<l;s++)if(e=a[s],o=this._events[e]){if(this._events[e]=i=[],t||n)for(c=0,d=o.length;c<d;c++)r=o[c],(t&&t!==r.callback&&t!==r.callback._callback||n&&n!==r.context)&&i.push(r);i.length||delete this._events[e]}return this},trigger:function(e){if(!this._events)return this;var t=c.call(arguments,1);if(!b(this,"trigger",e,t))return this;var n=this._events[e],i=this._events.all;return n&&w(n,t),i&&w(i,arguments),this},stopListening:function(e,t,n){var i=this._listeningTo;if(!i)return this;var r=!t&&!n;n||"object"!=typeof t||(n=this),e&&((i={})[e._listenId]=e);for(var o in i)(e=i[o]).off(t,n,this),!r&&Object.keys(e._events).length||delete this._listeningTo[o];return this}},y=/\s+/,b=function(e,t,n,i){if(!n)return!0;if("object"==typeof n){for(var r in n)e[t].apply(e,[r,n[r]].concat(i));return!1}if(y.test(n)){for(var o=n.split(y),a=0,s=o.length;a<s;a++)e[t].apply(e,[o[a]].concat(i));return!1}return!0},w=function(e,t){var n,i=-1,r=e.length,o=t[0],a=t[1],s=t[2];switch(t.length){case 0:for(;++i<r;)(n=e[i]).callback.call(n.ctx);return;case 1:for(;++i<r;)(n=e[i]).callback.call(n.ctx,o);return;case 2:for(;++i<r;)(n=e[i]).callback.call(n.ctx,o,a);return;case 3:for(;++i<r;)(n=e[i]).callback.call(n.ctx,o,a,s);return;default:for(;++i<r;)(n=e[i]).callback.apply(n.ctx,t);return}},x={listenTo:"on",listenToOnce:"once"};Object.keys(x).forEach(function(e){var t=x[e];v[e]=function(e,i,r){return(this._listeningTo||(this._listeningTo={}))[e._listenId||(e._listenId=n.uniqueId("l"))]=e,r||"object"!=typeof i||(r=this),e[t](i,r,this),this}}),v.bind=v.on,v.unbind=v.off,n.extend(t,v);var C=t.Model=function(e,t){var i=e||{};t||(t={}),this.cid=n.uniqueId("c"),this.attributes=Object.create(null),t.collection&&(this.collection=t.collection),t.parse&&(i=this.parse(i,t)||{}),i=n.defaults({},i,n.result(this,"defaults")),this.set(i,t),this.changed=Object.create(null),this.initialize.apply(this,arguments)};n.extend(C.prototype,v,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return n.extend({},this.attributes)},sync:function(){return t.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return n.escape(this.get(e))},has:function(e){return null!=this.get(e)},set:function(e,t,i){var r,o,a,s,l,c,d,u;if(null==e)return this;if("object"==typeof e?(o=e,i=t):(o={})[e]=t,i||(i={}),!this._validate(o,i))return!1;a=i.unset,l=i.broadcast,s=[],c=this._changing,this._changing=!0,c||(this._previousAttributes=n.extend(Object.create(null),this.attributes),this.changed={}),u=this.attributes,d=this._previousAttributes,this.idAttribute in o&&(this.id=o[this.idAttribute]);for(r in o)t=o[r],n.isEqual(u[r],t)||s.push(r),n.isEqual(d[r],t)?delete this.changed[r]:this.changed[r]=t,a?delete u[r]:u[r]=t;if(l){s.length&&(this._pending=i);for(var h=0,p=s.length;h<p;h++)this.trigger("change:"+s[h],this,u[s[h]],i)}if(c)return this;if(l)for(;this._pending;)i=this._pending,this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,n.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var i in this.attributes)t[i]=void 0;return this.set(t,n.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!!Object.keys(this.changed).length:n.has(this.changed,e)},changedAttributes:function(e){if(!e)return!!this.hasChanged()&&n.extend(Object.create(null),this.changed);var t,i=!1,r=this._changing?this._previousAttributes:this.attributes;for(var o in e)n.isEqual(r[o],t=e[o])||((i||(i={}))[o]=t);return i},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return n.extend(Object.create(null),this._previousAttributes)},fetch:function(e){void 0===(e=e?n.extend({},e):{}).parse&&(e.parse=!0);var t=this,i=e.success;return e.success=function(n){if(!t.set(t.parse(n,e),e))return!1;i&&i(t,n,e),t.trigger("sync",t,n,e)},h(this,e),this.sync("read",this,e)},save:function(e,t,i){var r,o,a,s=this.attributes;if(null==e||"object"==typeof e?(r=e,i=t):(r={})[e]=t,i=n.extend({validate:!0},i),r&&!i.wait){if(!this.set(r,i))return!1}else if(!this._validate(r,i))return!1;r&&i.wait&&(this.attributes=n.extend(Object.create(null),s,r)),void 0===i.parse&&(i.parse=!0);var l=this,c=i.success;return i.success=function(e){l.attributes=s;var t=l.parse(e,i);if(i.wait&&(t=n.extend(r||{},t)),t&&"object"==typeof t&&!l.set(t,i))return!1;c&&c(l,e,i),l.trigger("sync",l,e,i)},h(this,i),"patch"===(o=this.isNew()?"create":i.patch?"patch":"update")&&(i.attrs=r),a=this.sync(o,this,i),r&&i.wait&&(this.attributes=s),a},destroy:function(e){var t=this,i=(e=e?n.extend({},e):{}).success,r=function(){t.trigger("destroy",t,t.collection,e)};if(e.success=function(n){(e.wait||t.isNew())&&r(),i&&i(t,n,e),t.isNew()||t.trigger("sync",t,n,e)},this.isNew())return e.success(),!1;h(this,e);var o=this.sync("delete",this,e);return e.wait||r(),o},url:function(){var e=n.result(this,"urlRoot")||n.result(this.collection,"url")||u();return this.isNew()?e:e.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(e){return this._validate({},n.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=n.extend(Object.create(null),this.attributes,e);var i=this.validationError=this.validate(e,t)||null;return!i||(this.trigger("invalid",this,i,n.extend(t,{validationError:i})),!1)}}),n.keys&&["keys","values","pairs","invert","pick","omit"].filter(p).forEach(function(e){C.prototype[e]=function(){var t=c.call(arguments);return t.unshift(this.attributes),n[e].apply(n,t)}});var k=t.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,n.extend({broadcast:!0},t))},S={add:!0,remove:!0,merge:!0},T={add:!0,remove:!1};return n.extend(k.prototype,v,{model:void 0===C?null:C,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return t.sync.apply(this,arguments)},add:function(e,t){return this.set(e,n.extend({merge:!1},t,T))},remove:function(e,t){var n=!Array.isArray(e);e=n?[e]:e.slice(),t||(t={});var i,r,o,a;for(i=0,r=e.length;i<r;i++)(a=e[i]=this.get(e[i]))&&(delete this._byId[a.id],delete this._byId[a.cid],o=this.indexOf(a),this.models.splice(o,1),this.length--,t.broadcast&&(t.index=o,a.trigger("remove",a,this,t)),this._removeReference(a,t));return n?e[0]:e},set:function(e,t){(t=n.defaults({},t,S)).parse&&(e=this.parse(e,t));var i=!Array.isArray(e);e=i?e?[e]:[]:e.slice();var r,o,a,s,l,c,d,u=t.at,h=this.model,p=this.comparator&&null==u&&!1!==t.sort,f="string"==typeof this.comparator?this.comparator:null,m=[],g=[],v={},y=t.add,b=t.merge,w=t.remove,x=!(p||!y||!w)&&[];for(r=0,o=e.length;r<o;r++){if(l=e[r]||{},a=l instanceof C?s=l:l[h.prototype.idAttribute||"id"],c=this.get(a))w&&(v[c.cid]=!0),b&&(l=l===s?s.attributes:l,t.parse&&(l=c.parse(l,t)),c.set(l,t),p&&!d&&c.hasChanged(f)&&(d=!0)),e[r]=c;else if(y){if(!(s=e[r]=this._prepareModel(l,t)))continue;m.push(s),this._addReference(s,t)}s=c||s,!x||!s.isNew()&&v[s.id]||x.push(s),v[s.id]=!0}if(w){for(r=0,o=this.length;r<o;++r)v[(s=this.models[r]).cid]||g.push(s);g.length&&this.remove(g,t)}if(m.length||x&&x.length)if(p&&(d=!0),this.length+=m.length,null!=u)for(r=0,o=m.length;r<o;r++)this.models.splice(u+r,0,m[r]);else{x&&(this.models.length=0);var k=x||m;for(r=0,o=k.length;r<o;r++)this.models.push(k[r])}if(d&&this.sort({broadcast:!1}),t.broadcast){for(r=0,o=m.length;r<o;r++)(s=m[r]).trigger("add",s,this,t);(d||x&&x.length)&&this.trigger("sort",this,t)}return i?e[0]:e},reset:function(e,t){t||(t={});for(var i=0,r=this.models.length;i<r;i++)this._removeReference(this.models[i],t);return t.previousModels=this.models,this._reset(),e=this.add(e,n.extend({broadcast:!1},t)),t.broadcast&&this.trigger("reset",this,t),e},push:function(e,t){return this.add(e,n.extend({at:this.length},t))},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return this.add(e,n.extend({at:0},t))},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(){return c.apply(this.models,arguments)},get:function(e){if(null!=e)return this._byId[e]||this._byId[e.id]||this._byId[e.cid]},at:function(e){return this.models[e]},where:function(e,t){return e&&Object.keys(e).length?this[t?"find":"filter"](function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0}):t?void 0:[]},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),"string"==typeof this.comparator||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(this.comparator.bind(this)),e.broadcast&&this.trigger("sort",this,e),this},pluck:function(e){return this.models.map(function(t){return t.get(e)})},fetch:function(e){void 0===(e=e?n.extend({},e):{}).parse&&(e.parse=!0);var t=e.success,i=this;return e.success=function(n){var r=e.reset?"reset":"set";i[r](n,e),t&&t(i,n,e),i.trigger("sync",i,n,e)},h(this,e),this.sync("read",this,e)},create:function(e,t){if(t=t?n.extend({},t):{},!(e=this._prepareModel(e,t)))return!1;t.wait||this.add(e,t);var i=this,r=t.success;return t.success=function(e,n){t.wait&&i.add(e,t),r&&r(e,n,t)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId=Object.create(null)},_prepareModel:function(e,t){if(e instanceof C)return e;(t=n.extend({},t)).collection=this;var i=new this.model(e,t);return i.validationError?(this.trigger("invalid",this,i.validationError,t),!1):i},_addReference:function(e,t){this._byId[e.cid]=e,null!=e.id&&(this._byId[e.id]=e),e.collection||(e.collection=this),e.on("all",this._onModelEvent,this)},_removeReference:function(e,t){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,i){("add"!==e&&"remove"!==e||n===this)&&("destroy"===e&&this.remove(t,i),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],null!=t.id&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments))},toArray:function(){return this.models||[]}}),p("each")?(["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain"].filter(p).forEach(function(e){k.prototype[e]=function(){var t=c.call(arguments);return t.unshift(this.models),n[e].apply(n,t)}}),["groupBy","countBy","sortBy"].filter(p).forEach(function(e){k.prototype[e]=function(t,i){var r="function"==typeof t?t:function(e){return e.get(t)};return n[e](this.models,r,i)}})):(["forEach","map","filter","some","every","reduce","reduceRight","indexOf","lastIndexOf"].forEach(function(e){k.prototype[e]=function(t,n){return this.models[e](t,n)}}),k.prototype.find=function(e,t){var n;return this.some(function(i,r,o){if(e.call(t,i,r,o))return n=i,!0}),n},["sortBy"].forEach(function(e){k.prototype[e]=function(t,i){var r="function"==typeof t?t:function(e){return e.get(t)};return n[e](this.models,r,i)}})),["Model","Collection","Router","View","History"].forEach(function(e){var n=t[e];n&&(n.extend=t.extend)}),n.extend(t,v),t}),define("app/editor/UndoManager",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node"],function(e,t,n){"use strict";var i=e("exoskeleton-master/exoskeleton"),r=(e("app/document/StringUtils"),e("app/document/Node")),o=r.Node,a=r.TYPE,s={ADD:1,REPLACE:2,DELETE:-1,DELETE_ACCROSS_BLOCK:-2,HAS_UNDO_TO_PREPEND:-9},l=i.Model.extend({commandStack:void 0,index:void 0,undoManagerContext:!1,stackSize:void 0,UndoManager:l,initialize:function(e){this.commandStack=[],this.set({index:-1,stackSize:100}),this.editor=e,this.UndoManager=l,this.clearSnap()},reset:function(){this.commandStack=[],this.set({index:-1,stackSize:200}),this.clearSnap()},restoreFromJson:function(e){this.set("index",e.index),this.commandStack=JSON.parse(e.commandStackJson)},storeToJson:function(){return{index:this.get("index"),commandStackJson:JSON.stringify(this.commandStack)}},callCommand:function(e,t){var n,i;try{if(t)for(r=e.undo.length-1;r>-1;r--)i=this.exeCommand(e.undo[r],e.redo),n||(n=void 0===n?i:!!i);else for(var r=0;r<e.redo.length;r++)i=this.exeCommand(e.redo[r],e.undo),n||(n=void 0===n?i:!!i)}catch(e){console.error(e.stack)}return n}});l.prototype.register=function(e,t,n){!this.undoManagerContext&&e&&("sync"!==n&&(this.commandStack.splice(this.get("index")+1,this.commandStack.length-this.get("index")),this.commandStack.length>this.get("stackSize")&&this.commandStack.splice(0,this.commandStack.length-this.get("stackSize")),this.commandStack.push(e),this.set({index:this.commandStack.length-1})),t||"sync"!==n&&"restore"!==n&&File.updateChangeCount(File.ChangeType.NSChangeDone),"undo"!==n&&"input"!==n&&this.editor.syncChange(e.redo))},l.prototype.lastRegisteredOperationCommand=function(){return this.commandStack.length==this.get("index")+1?this.commandStack[this.get("index")]:null},l.prototype.removeLastRegisteredOperationCommand=function(){this.commandStack.length==this.get("index")+1&&(this.commandStack.pop(),this.set({index:this.get("index")-1}))},l.prototype.undoLastDiscardable=function(){if(!this.editor.sourceView.inSourceMode&&!File.isLocked){if(this.completeSnap(!0),"INPUT"==document.activeElement.tagName&&"checkbox"!=document.activeElement.getAttribute("type"))return!0;var e=this.commandStack[this.get("index")];e&&e.discardable&&this.undo()}},l.prototype.undo=function(e){if(this.editor.sourceView.inSourceMode)return this.editor.sourceView.cm.undo(),e&&e.preventDefault();if(this.completeSnap(!0),"INPUT"==document.activeElement.tagName&&e&&"checkbox"!=document.activeElement.getAttribute("type")){var t=document.activeElement,n=t.value,i=this;return setTimeout(function(){n==t.value&&i.undo()},50),!0}e&&e.preventDefault();var r=this.commandStack[this.get("index")];if(r){this.editor.brush.pause();var o=this.callCommand(r,!0);this.set({index:this.get("index")-1}),File.updateChangeCount(File.ChangeType.NSChangeUndone),o&&(this.editor.quickRefresh(),this.editor.selection.scrollAdjust()),this.editor.brush.resume(!0),void 0===o?this.undo():(this.editor.refocus(void 0,null,null,!0),this.editor.syncChange(r.undo.clone().reverse()))}},l.prototype.redo=function(e){if(this.editor.sourceView.inSourceMode)return this.editor.sourceView.cm.redo(),e&&e.preventDefault();if("INPUT"==document.activeElement.tagName&&e&&"checkbox"!=document.activeElement.getAttribute("type")){var t=document.activeElement,n=t.value,i=this;return setTimeout(function(){n==t.value&&i.redo()},50),!0}if(e&&e.preventDefault(),!this.snapFlag){var r=this.commandStack[this.get("index")+1];if(r){this.editor.brush.pause();var o=this.callCommand(r,!1);this.set({index:this.get("index")+1}),File.updateChangeCount(File.ChangeType.NSChangeRedone),o&&(this.editor.quickRefresh(),this.editor.selection.scrollAdjust()),this.editor.brush.resume(!0),void 0===o?this.redo():(this.editor.refocus(void 0,null,null,!0),this.editor.syncChange(r.redo))}}},l.prototype.hasUndo=function(){return!(!this.snapFlag&&-1===this.get("index"))},l.prototype.hasRedo=function(){return!(this.snapFlag||!(this.get("index")<this.commandStack.length-1))},l.prototype.exeCommand=function(e,t,n){function i(t,n){n=n||[],t=t||d.nodeMap,e.json.map(function(e){n.push(o.readFromJson(e,t,!0))}),e.json.map(function(e){var t=d.getNode(e.id);t.set("before",d.getNode(e.relation.before_id)),t.set("after",d.getNode(e.relation.after_id)),t.set("parent",d.getNode(e.relation.parent_id))})}var s,l,c,d=this.editor,u=!1,h=d.sourceView.inSourceMode;if(e){switch(e.type){case"reload":if(h)return;d.nodeMap.reset(d),i(),d.brush.queue=[],u=!0,$(d.sessionStr).html(r.NodeCollectionUtils.toHTML(d.nodeMap.blocks)),d.focusCid=null,d.lastCursor=null,window.getSelection().removeAllRanges(),File.fileEncode=e.encode;break;case"replace":if(h)return;if(!(c=d.getNode(e.id)))return console.error(e.id+" not found in  replace");c.get("type")==c.TYPE.fences&&d.fences.beforeDeleteFences(c,t),c.get("type")==c.TYPE.math_block&&d.mathBlock.beforeDeleteFences(c,t),e.id!=e.json.id?(d.getNode(e.id).remove(),c=o.readFromJson(e.json,d.nodeMap)):c.readFromJson(e.json,d.nodeMap),d.findElemById(e.id).replaceWith(d.MarkParser.renderHtmlWithBlockMeta(c,d.brush)),$(d.sessionStr).attr("contenteditable",!0),u=!0,d.brush.restart(),!n&&d.brush.addToQueue(c.id,!0);break;case"insert":if(h)return;var p=d.nodeMap,f=new Array,m=[];if(i(p,f),e.after&&(m=d.findElemById(e.after)).before(r.NodeCollectionUtils.toHTML(f)),!m.length&&e.before&&(m=d.findElemById(e.before)).after(r.NodeCollectionUtils.toHTML(f)),!m.length){var g=f[0].get("parent");g?d.findElemById(g.id).replaceWith(g.toHTML()):0===$(d.sessionStr).children().length&&($(d.sessionStr).html(r.NodeCollectionUtils.toHTML(f)),d.focusCid=null,d.lastCursor=null)}u=!0;break;case"remove":if(h)return;e.idArray.map(function(e){var n=d.getNode(e);o.isType(n,a.fences)&&d.fences.beforeDeleteFences(n,t),o.isType(n,a.math_block)&&d.mathBlock.beforeDeleteFences(n,t);var i=(s=d.findElemById(e)).parent("li");i.length&&i.css("margin","0.1px"),s.remove(),i.length&&i.css("margin",""),n&&n.remove()}),u=!0;break;case"text":if(h)return;s=d.findElemById(e.id),d.getNode(e.id).set("text",e.text),e.html&&s.html(e.html),u=!1,"def-footnote"!=s.attr("mdtype")&&"def-link"!=s.attr("mdtype")||(u=!0),!n&&d.brush.addToQueue(e.id,!0);break;case"cursor":if(n)return;if(h)return void(e.inSourceMode&&d.sourceView.cm.setCursor(e.pos));if(e.inSourceMode)return;try{if(void 0==e.end&&(e.end=e.start),void 0==e.startId&&void 0==e.id&&(e.id=e.cid),e.focus)return setTimeout(function(){d.findElemById(e.id).children("[tabindex]").andSelf("[tabindex]").focus()},100),d.findElemById(e.id).children("[tabindex]").andSelf("[tabindex]").focus(),!1;if(e.id||e.startId==e.endId){if(e.id=e.id||e.startId,(s=d.findElemById(e.id)).attr("mdtype")==a.fences||s.attr("mdtype")==a.math_block){var v;s.attr("mdtype")==a.fences?(d.fences.refreshEditor(),(v=d.fences.getCm(e.id)).focus()):v=d.mathBlock.startEditing(s,!0),e.selections&&e.selections.length?v.setSelection(e.selections[0].head,e.selections[0].anchor):e.pos?(v.setCursor(e.pos),e.selections&&v.setSelections(e.selections)):e.start>-1?(v.setCursor(v.posFromIndex(e.start)),e.end>-1&&v.setSelection(v.posFromIndex(e.start),v.posFromIndex(e.end))):d.selection.jumpIntoElemEnd(s)}else if(s.length&&void 0!==e.end){var y=s.text().length;e.start>y&&(e.start=y),e.end>y&&(e.end=y),d.selection.restoreSelection(s[0],{start:e.start,end:e.end})}else window.getSelection().removeAllRanges();t||d.refocus(e.id)}else if(e.startId)try{var b=d.selection.restoreEdge(d.findElemById(e.startId),e.start);b=d.selection.restoreEdge(d.findElemById(e.endId),e.end,!0,b),d.selection.setRange(b),d.refocus()}catch(e){console.log(e.stack)}File.isTypeWriterMode&&d.selection.scrollAdjust(),u=!1}catch(e){console.error(e.stack)}break;case"fences":if(h)return;c=d.getNode(e.id),o.isType(c,c.TYPE.math_block)?(d.mathBlock.startEditing(e.id),l=d.mathBlock.currentCm):l=d.fences.getCm(e.id),l.focus(),"undo"==e.cmd&&l.undo(),"redo"==e.cmd&&l.redo(),u=!1;break;case"fences-pos":if(h||n)return;c=d.getNode(e.id),o.isType(c,c.TYPE.math_block)?(d.mathBlock.startEditing(e.id),l=d.mathBlock.currentCm):(d.fences.refreshEditor(),l=d.fences.getCm(e.id)),l.focus(),l.setCursor(e.pos),u=!1;break;case"attr":if(h)return;e.value=e.value||!1,(c=this.editor.getNode(e.id)).attr(e.key,e.value,this.editor,!0),!n&&d.brush.addToQueue(e.id,!0);break;case"wrap":if(h)return;var w={};w.type="insert",w.json=[e.json],e.json.children.map(function(n,i){var r=d.getNode(n.id);0===i?w.before=r.get("before")?r.get("before").id:null:i===e.json.children.length-1&&(w.after=r.get("after")?r.get("after").id:null),r&&(r.get("type")==r.TYPE.fences&&(u=!0,d.fences.beforeDeleteFences(r,t)),r.get("type")==r.TYPE.math_block&&(u=!0,d.mathBlock.beforeDeleteFences(r,t)),r.remove(),d.findElemById(n.id).remove())}),this.exeCommand(w,t);break;case"unwrap":if(h)return;var x=(c=d.getNode(e.id)).unwrap();!e.skipHTML&&d.findElemById(e.id).replaceWith(r.NodeCollectionUtils.toHTML(x)),u=!0;break;case"scroll":if(h||n)return;d.selection.scrollAdjust(e.id?d.findElemById(e.id):void 0,e.marginTop);break;case"sync":if(!n)return;if(void 0!==e.html)d.findElemById(e.id).html(e.html).find(".md-expand, .md-focus").removeClass("md-expand md-focus");else if(void 0!==e.allHtml)d.nodeMap.reset(),i(),$("#write").html(e.allHtml);else if(void 0!==e.cmChanges)l=d.fences.getCm(e.id),e.cmChanges.forEach(function(e){l.replaceRange(e.text,e.from,e.to)});else{if(void 0!==e.tex)return(c=d.getNode(e.id)).set("text",e.tex),d.findElemById(e.id).replaceWith(c.toHTML()),!0;if(void 0!==e.srcChanges)h&&e.srcChanges.forEach(function(e){d.sourceView.cm.replaceRange(e.text,e.from,e.to)});else if(void 0!==e.content){if(h&&!e.fromSourceMode){var C=d.sourceView.cm.getScrollInfo().top;d.sourceView.cm.setValue(e.content,"sync"),d.sourceView.cm.scrollTo(0,C)}!h&&e.fromSourceMode&&(d.nodeMap.reset(),d.reset(e.content))}}default:return}return u}},l.prototype.clearSnap=function(){this.snapNode={},this.snapFlag=0,this.snapDate=0,this.snapSelection=null},l.prototype.completeSnap=function(e,t){if(e&&!this.snapFlag||!this.snapNode||!this.snapNode.id)return this.snapFlag=0;var n=null;return this.snapFlag==s.HAS_UNDO_TO_PREPEND?(n=c,t||this.register(n,!1),c=null,this.clearSnap(),n):(n=l.makeEmptyCommand(),o.isType(this.snapNode.content.type,a.fences,a.math_block)?void 0:(this.snapSelection&&n.undo.push(this.snapSelection),n.undo.push({type:"replace",id:this.snapNode.id,json:this.snapNode}),this.buildSnap(this.snapNode.id,0),n.redo.push({type:"replace",id:this.snapNode.id,json:this.snapNode}),this.snapSelection&&n.redo.push(this.snapSelection),t||this.register(n,!0,"input"),n))},l.prototype.buildSnap=function(e,t,n){this.snapSelection=this.editor.selection.buildUndo();var i=this.editor.getNode(e);if(!i)return this.clearSnap();void 0!==n&&null!==n?i.set("text",n):this.editor.store(e,!0),this.snapNode=i.storeToJson(),this.snapFlag=t||0,this.snapDate=(new Date).getTime()};var c,d=null;l.prototype.noStashedUndo=function(){return this.snapFlag!==s.HAS_UNDO_TO_PREPEND},l.prototype.stashUndo=function(e){c?l.append(c,e):c=e,this.snapFlag=s.HAS_UNDO_TO_PREPEND},l.prototype.clearEventTimer=function(){d&&clearTimeout(d),d=null},l.prototype.snap=function(e,t,n,i){var r=this;this.snapFlag==s.HAS_UNDO_TO_PREPEND&&(this.completeSnap(),File.updateChangeCount(File.ChangeType.NSChangeDone)),!e&&this.snapNode&&(e=this.snapNode.id),e||this.clearSnap(),this.snapFlag?(this.snapNode.id!=e?(this.completeSnap(),this.buildSnap(e,t,n),File.updateChangeCount(File.ChangeType.NSChangeDone)):t!=this.snapFlag||this.snapFlag==s.REPLACE?(this.completeSnap(),File.updateChangeCount(File.ChangeType.NSChangeDone)):t&&this.snapDate&&(new Date).getTime()-this.snapDate>1e3&&(this.completeSnap(),File.updateChangeCount(File.ChangeType.NSChangeDone)),this.snapFlag=t):t&&(this.buildSnap(e,t,n),File.updateChangeCount(File.ChangeType.NSChangeDone)),t&&!i&&(this.clearEventTimer(),t==s.DELETE_ACCROSS_BLOCK?(this.editor.selection.scrollAdjust(),d=null):d=setTimeout(function(){r.editor.findElemById(e).trigger("inline-input"),d=null},50))},l.prototype.buildReplaceUndo=function(e){return l.buildReplaceUndo(e)},l.buildReplaceUndo=function(e,t){if(!e)throw new Error("empty node");return{type:"replace",id:t||e.id,json:e.storeToJson()}},l.addUndoForInsert=function(e,t,n,i){t&&(e.redo.push({type:"insert",after:i?i.id:t.get("after")?t.get("after").id:null,before:n?n.id:t.get("before")?t.get("before").id:null,json:[t.storeToJson()]}),e.undo.push({type:"remove",idArray:[t.id]}))},l.addUndoForWrap=function(e,t,n){t&&(e.redo.push({type:"wrap",json:t.storeToJson(),skipHTML:n}),e.undo.push({type:"unwrap",id:t.id,skipHTML:n}))},l.addUndoForUnwrap=function(e,t){t&&(e.undo.push({type:"wrap",json:t.storeToJson()}),e.redo.push({type:"unwrap",id:t.id}))},l.buildAllDoc=function(e,t){var n=e.blocks.at(0),i=[];for(n=n.getLastBrother(!0);n;)i.push(n.storeToJson()),n=n.get("after");return{type:"reload",json:i,reloadFromDisk:t,encode:File.fileEncode}},l.addUndoForInsertArray=function(e,t,n,i){t&&0!=t.length&&(e.redo.push({type:"insert",after:i?i.id:t[t.length-1].get("after")?t[t.length-1].get("after").id:null,before:n?n.id:t[0].get("before")?t[0].get("before").id:null,json:t.reduce(function(e,t){return e.push(t.storeToJson()),e},[])}),e.undo.push({type:"remove",idArray:t.reduce(function(e,t){return e.push(t.id),e},[])}))},l.addUndoForRemoveArray=function(e,t,n,i){t&&0!=t.length&&(e.undo.push({type:"insert",after:i?i.id:t[t.length-1].get("after")?t[t.length-1].get("after").id:null,before:n?n.id:t[0].get("before")?t[0].get("before").id:null,json:t.reduce(function(e,t){return e.push(t.storeToJson()),e},[])}),e.redo.push({type:"remove",idArray:t.reduce(function(e,t){return e.push(t.id),e},[])}))},l.addUndoForRemove=function(e,t,n,i){e.undo.push({type:"insert",after:i?i.id:t.get("after")?t.get("after").id:null,before:n?n.id:t.get("before")?t.get("before").id:null,json:[t.storeToJson()]}),e.redo.push({type:"remove",idArray:[t.id]})},l.makeEmptyCommand=function(e){var t={undo:[],redo:[]};return e&&t.undo.push(e),t},l.isEmptyCommand=function(e){return!(e&&e.undo&&e.redo&&(e.undo.length||e.redo.length))},l.append=function(e,t){return t&&(e.undo=e.undo.concat(t.undo),e.redo=e.redo.concat(t.redo)),e},o.storeToJson=function(e){var t={};return t.content={},t.relation={},t.children=new Array,o.property.map(function(n){var i=e.get(n);void 0!==i&&null!==i&&(i instanceof Array?t.content[n]=$.merge([],i):typeof i==Object?t.content[n]=$.extend({},i):t.content[n]=i)}),t.relation.before_id=e.get("before")?e.get("before").id:null,t.relation.after_id=e.get("after")?e.get("after").id:null,t.relation.parent_id=e.get("parent")?e.get("parent").id:null,t.is_top=!!e.get("attachTo"),e.get("children").toArray().map(function(e){var n=o.storeToJson(e);t.children.push(n)}),t.id=e.id,t},o.readFromJson=function(e,t,n){var i=function(e){var n=t.allNodes.get(e);return n&&!n.attributes&&(console.assert(null,"node deleted"),n.attributes={}),n}(e.id)||new o({id:e.id});return i.set("in",t),e.is_top&&i.set("attachTo",t),o.property.map(function(e){i.attributes[e]=void 0}),i.set(e.content),i.clearChildren(!0),e.relation.parent_id||i.set("attachTo",t),e.children.map(function(e){o.readFromJson(e,t,!0)}),e.children.map(function(e){var n=t.allNodes.get(e.id);n.set("before",t.allNodes.get(e.relation.before_id)),n.set("after",t.allNodes.get(e.relation.after_id)),n.set("parent",i)}),n||(i.set("before",t.allNodes.get(e.relation.before_id)),i.set("after",t.allNodes.get(e.relation.after_id)),i.set("parent",t.allNodes.get(e.relation.parent_id))),i},o.prototype.storeToJson=function(){return o.storeToJson(this)},o.prototype.readFromJson=function(e,t){this.clearChildren();var n=o.readFromJson(e,t||this.get("in"));this.replaceWith(n)},l.SnapFlag=s,n.exports=l}),define("app/document/StringUtils",[],function(e,t,n){"use strict";function i(e,t){function n(e){for(var t,n,i=new Array,r=0,o=-1,a=0;t=(n=e.charAt(r++)).charCodeAt(0);){var s=46==t||t>=48&&t<=57;s!==a&&(i[++o]="",a=s),i[o]+=n}return i}var i=/\.[^.\\\/]+$/,r=(i.exec(e)||[""])[0],o=(i.exec(e)||[""])[0];r.length&&r==o&&(e=e.replace(i,""),t=t.replace(i,""));for(var a=n(e),s=n(t),l=0;a[l]&&s[l];l++)if(a[l]!==s[l]){var c=Number(a[l]),d=Number(s[l]);return c==a[l]&&d==s[l]?c-d:a[l].localeCompare(s[l])}return a.length-s.length}var r=/^[\s\u200b]+$/,o=function(e){return null==e||void 0==e||""===e||"​"===e},a=function(e,t,n){return null==e||void 0==e||""==e?"":"string"!=typeof e&&"number"!=typeof e?e:(e=(e+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),t&&(e=s(e)),e)},s=function(e){return e.replace(/[[\]~`*\\$<]/g,"\\$&").replace(/(\b_)|(_(?=\s))/g,"\\$&")},l=/^\s*(([\w-_]+:\/\/)|(www\.)|\w*\/)[\w-.\/?%&=:@]*/i,c=/^\s*(([\w-_]+:\/\/)|(www\.)|\w*\/)?[\w-.\/?%&=:@]+(\.jpe?g|png|gif|webm|svg)/i,d=function(e,t,n){return e.replace(new RegExp("\\b"+t+"\\b","gi"),n)},u=function(e,t){var n=e.getHours()+"",i=e.getMinutes()+"",r=e.getSeconds()+"";return(n.length<2?"0":"")+n+":"+(i.length<2?"0":"")+i+(t?(r.length<2?"0":"")+r:"")},h=function(e,t){if(!e)return t;t=t||"";var n=e.split("/"),i=t.split("/");n.pop();for(var r=0;r<i.length;r++)"."!=i[r]&&(".."==i[r]?n.pop():n.push(i[r]));return n.join("/")};String.prototype.replaceExact=function(e,t){return d(this,e,t)},String.prototype.repeat=function(e){return(!$.isNumeric(e)||e<0)&&(console.error("String.prototype.repeat only accepts non-nagitive number"),e=0),new Array(e-0+1).join(this)},String.prototype.startsWith=String.prototype.startsWith||function(e){return this.match("^"+e)===e},String.prototype.endsWith=String.prototype.endsWith||function(e){return this.match(e+"$")===e},String.prototype.format=function(){var e=/\{\d+\}/g,t=arguments;return this.replace(e,function(e){return t[e.match(/\d+/)]})},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};for(var p=[{base:"A",letters:"AⒶＡÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄȺⱯ"},{base:"AA",letters:"Ꜳ"},{base:"AE",letters:"ÆǼǢ"},{base:"AO",letters:"Ꜵ"},{base:"AU",letters:"Ꜷ"},{base:"AV",letters:"ꜸꜺ"},{base:"AY",letters:"Ꜽ"},{base:"B",letters:"BⒷＢḂḄḆɃƂƁ"},{base:"C",letters:"CⒸＣĆĈĊČÇḈƇȻꜾ"},{base:"D",letters:"DⒹＤḊĎḌḐḒḎĐƋƊƉꝹ"},{base:"DZ",letters:"ǱǄ"},{base:"Dz",letters:"ǲǅ"},{base:"E",letters:"EⒺＥÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚƐƎ"},{base:"F",letters:"FⒻＦḞƑꝻ"},{base:"G",letters:"GⒼＧǴĜḠĞĠǦĢǤƓꞠꝽꝾ"},{base:"H",letters:"HⒽＨĤḢḦȞḤḨḪĦⱧⱵꞍ"},{base:"I",letters:"IⒾＩÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬƗ"},{base:"J",letters:"JⒿＪĴɈ"},{base:"K",letters:"KⓀＫḰǨḲĶḴƘⱩꝀꝂꝄꞢ"},{base:"L",letters:"LⓁＬĿĹĽḶḸĻḼḺŁȽⱢⱠꝈꝆꞀ"},{base:"LJ",letters:"Ǉ"},{base:"Lj",letters:"ǈ"},{base:"M",letters:"MⓂＭḾṀṂⱮƜ"},{base:"N",letters:"NⓃＮǸŃÑṄŇṆŅṊṈȠƝꞐꞤ"},{base:"NJ",letters:"Ǌ"},{base:"Nj",letters:"ǋ"},{base:"O",letters:"OⓄＯÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘǪǬØǾƆƟꝊꝌ"},{base:"OI",letters:"Ƣ"},{base:"OO",letters:"Ꝏ"},{base:"OU",letters:"Ȣ"},{base:"OE",letters:"Œ"},{base:"oe",letters:"œ"},{base:"P",letters:"PⓅＰṔṖƤⱣꝐꝒꝔ"},{base:"Q",letters:"QⓆＱꝖꝘɊ"},{base:"R",letters:"RⓇＲŔṘŘȐȒṚṜŖṞɌⱤꝚꞦꞂ"},{base:"S",letters:"SⓈＳẞŚṤŜṠŠṦṢṨȘŞⱾꞨꞄ"},{base:"T",letters:"TⓉＴṪŤṬȚŢṰṮŦƬƮȾꞆ"},{base:"TZ",letters:"Ꜩ"},{base:"U",letters:"UⓊＵÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴɄ"},{base:"V",letters:"VⓋＶṼṾƲꝞɅ"},{base:"VY",letters:"Ꝡ"},{base:"W",letters:"WⓌＷẀẂŴẆẄẈⱲ"},{base:"X",letters:"XⓍＸẊẌ"},{base:"Y",letters:"YⓎＹỲÝŶỸȲẎŸỶỴƳɎỾ"},{base:"Z",letters:"ZⓏＺŹẐŻŽẒẔƵȤⱿⱫꝢ"},{base:"a",letters:"aⓐａẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁąⱥɐ"},{base:"aa",letters:"ꜳ"},{base:"ae",letters:"æǽǣ"},{base:"ao",letters:"ꜵ"},{base:"au",letters:"ꜷ"},{base:"av",letters:"ꜹꜻ"},{base:"ay",letters:"ꜽ"},{base:"b",letters:"bⓑｂḃḅḇƀƃɓ"},{base:"c",letters:"cⓒｃćĉċčçḉƈȼꜿↄ"},{base:"d",letters:"dⓓｄḋďḍḑḓḏđƌɖɗꝺ"},{base:"dz",letters:"ǳǆ"},{base:"e",letters:"eⓔｅèéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛɇɛǝ"},{base:"f",letters:"fⓕｆḟƒꝼ"},{base:"g",letters:"gⓖｇǵĝḡğġǧģǥɠꞡᵹꝿ"},{base:"h",letters:"hⓗｈĥḣḧȟḥḩḫẖħⱨⱶɥ"},{base:"hv",letters:"ƕ"},{base:"i",letters:"iⓘｉìíîĩīĭïḯỉǐȉȋịįḭɨı"},{base:"j",letters:"jⓙｊĵǰɉ"},{base:"k",letters:"kⓚｋḱǩḳķḵƙⱪꝁꝃꝅꞣ"},{base:"l",letters:"lⓛｌŀĺľḷḹļḽḻſłƚɫⱡꝉꞁꝇ"},{base:"lj",letters:"ǉ"},{base:"m",letters:"mⓜｍḿṁṃɱɯ"},{base:"n",letters:"nⓝｎǹńñṅňṇņṋṉƞɲŉꞑꞥ"},{base:"nj",letters:"ǌ"},{base:"o",letters:"oⓞｏòóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộǫǭøǿɔꝋꝍɵ"},{base:"oi",letters:"ƣ"},{base:"ou",letters:"ȣ"},{base:"oo",letters:"ꝏ"},{base:"p",letters:"pⓟｐṕṗƥᵽꝑꝓꝕ"},{base:"q",letters:"qⓠｑɋꝗꝙ"},{base:"r",letters:"rⓡｒŕṙřȑȓṛṝŗṟɍɽꝛꞧꞃ"},{base:"s",letters:"sⓢｓßśṥŝṡšṧṣṩșşȿꞩꞅẛ"},{base:"t",letters:"tⓣｔṫẗťṭțţṱṯŧƭʈⱦꞇ"},{base:"tz",letters:"ꜩ"},{base:"u",letters:"uⓤｕùúûũṹūṻŭüǜǘǖǚủůűǔȕȗưừứữửựụṳųṷṵʉ"},{base:"v",letters:"vⓥｖṽṿʋꝟʌ"},{base:"vy",letters:"ꝡ"},{base:"w",letters:"wⓦｗẁẃŵẇẅẘẉⱳ"},{base:"x",letters:"xⓧｘẋẍ"},{base:"y",letters:"yⓨｙỳýŷỹȳẏÿỷẙỵƴɏỿ"},{base:"z",letters:"zⓩｚźẑżžẓẕƶȥɀⱬꝣ"}],f={},m=0;m<p.length;m++)for(var g=p[m].letters,v=0;v<g.length;v++)f[g[v]]=p[m].base;var y={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"'":"\\'","\\":"\\\\"},b={"&newline;":null,"&tab;":"\t","&copy;":"©","&amp;":"&","&gt":">","&lt":"<","&num;":"#"},w=document.createElement("textarea");i.insensitive=!0,t.decodeHtmlEntity=function(e){e=e.toLowerCase();var t=b[e];return t||(w.innerHTML=e,(t=w.value)!=e?b[e]=t:t=null),t},t.formateDateTime=function(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()+"  "+u(e)},t.formateTimeOnly=u,t.formateDateOnly=function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},t.insert=function(e,t,n){return e=e||"",t<e.length?e.substring(0,t)+n+e.substring(t):e+n},t.escape=function(e,t,n){var e=a(e,t);return File.option.noPreWrap&&(e=e.replace(/(^ )|( $)/g," ").replace(/  /g,"  ")),e},t.escapeForPreWrap=a,t.unescape=function(e){return null==e||void 0==e||""==e?"":(e+"").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'")},t.escapeHead=function(e){return e.replace(/(^ *)((#+)|(\+ +)|(\- +)|(\* +)|(\d+\. +)|(```|~~~)|(>)|(-+\s*$))/,"$1\\$2")},t.escapeMark=s,t.escapeSelector=function(e){if(window.CSS&&CSS.escape)return CSS.escape(e);for(var t,n=e,i=String(n),r=i.length,o=-1,a="",s=i.charCodeAt(0);++o<r;)0!=(t=i.charCodeAt(o))?a+=t>=1&&t<=31||127==t||0==o&&t>=48&&t<=57||1==o&&t>=48&&t<=57&&45==s?"\\"+t.toString(16)+" ":0==o&&1==r&&45==t||!(t>=128||45==t||95==t||t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122)?"\\"+i.charAt(o):i.charAt(o):a+="�";return a},t.escapeRegExp=function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},t.isNullOrEmpty=o,t.isNotNullOrEmpty=function(e){return!o(e)},t.isNullOrBlank=function(e){return null==e||void 0==e||""===e||r.exec(e)},t.replaceExact=d,t.splitExact=function(e,t){return e.split(new RegExp("\\b"+t+"\\b","gi"))},t.trimArr=function(e){if(e&&e.length){for(var t=0,n=e.length-1;0===e[t].trim().length&&t<n;)t++;for(;n>t&&0===e[n].trim().length;)n--;return e.slice(t,n+1)}return e},t.isURL=function(e){return!!l.exec(e)},t.isImg=function(e){return!!c.exec(e)},t.camelize=function(e){return e.replace(/(?:^|_|-)(\w)/g,function(e,t,n){return 0==n?t.toLowerCase():t.toUpperCase()})},t.getRelativePath=function(e,t,n){if(!e)return t;var i;if(File.isNode)return""==(i=reqnode("path").relative(e,t))&&(i="./"),i;e=e.replace(/\\\\/g,"/").replace(/^\.\//,"");var r,o=(t=t.replace(/\\\\/g,"/")).split(/\//g),a=e.split(/\//g),s=o.pop(),l="";for(""==a.last()&&a.pop(),""==a[0]&&a.shift(),""==o[0]&&o.shift(),r=o.join("/");0!==r.indexOf(a.join("/"));)a.pop(),l+="../";var c=o.slice(a.length);return c.length&&(l+=c.join("/")+"/"),i=l+s,n&&!i.match(/^\.\.\//)&&(i="./"+i),i},t.getAbsolutePath=h,t.getAbsoluteURL=function(e,t){if(!t)return"";var n=t.replace(/^[\\\/]{2}/,"http://");return e=e||"",n.match(/^[^:]+:\/\//)?n:n.match(/^[\\\/]/)?e.replace(/(^[^:]+:\/\/[^\/]+)\/.*/,"$1"+t):h(e,n)},t.useOrDefault=function(e,t){return e.trim().length?e:t},t.removeDiacritics=function(e){return(e||"").replace(/[^\u0000-\u007E]/g,function(e){return f[e]||e})},t.escapeInQuote=function(e){return e.replace(/["'\\\b\t\n\f\r]/g,function(e){return y[e]}).replace(/\u200b/g,"")},t.pathByDeleteLastComponent=function(e){return File.isMac?e.split("/").slice(0,-1).join("/"):reqnode("path").join(e,"..")},t.date2NatrualLang=function(e,t){var n,i,r,o,a,s=new Date,l=(s-e)/1e3,c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return l<30?n="just now":l<60?n="1 minutes ago":l<3600?n=Math.floor((l+30)/60).toString()+" minutes ago":l<18e3&&s.getDay()==e.getDay()?(i=e.getHours(),r=e.getMinutes(),n=[(i>9?"":"0")+i,(r>9?"":"0")+r].join(":")):l<172800&&s.getDay()==(e.getDay()+1)%7?n=t?"Yesterday":"yesterday":l<518400?n=Math.floor(l/86400)+" days ago":s.getYear()==e.getYear()?(a=e.getDate(),n=c[e.getMonth()]+" "+(a>9?"":"0")+a):(o=e.getMonth()+1,a=e.getDate(),n=[e.getFullYear(),(o>9?"":"0")+o,(a>9?"":"0")+a].join("-")),n},t.abbreviatingWithTilde=function(e){return File.isMac?app.path.abbreviatingWithTilde(e):File.isUnixNode?reqnode("fs-plus").tildify(e):e},t.naturalSort=i}),define("app/document/Node",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils"],function(e,t,n){"use strict";var i=e("exoskeleton-master/exoskeleton"),r=e("app/document/StringUtils"),o={paragraph:"paragraph",heading:"heading",blockquote:"blockquote",fences:"fences",hr:"hr",def_link:"def_link",def_footnote:"def_footnote",table:"table",raw_edit:"raw_edit",meta_block:"meta_block",math_block:"math_block",list:"list",toc:"toc",iframe:"iframe"},a={list_item:"list_item",table_row:"table_row",table_cell:"table_cell",line:"line"},s={plain:"plain",strong:"strong",em:"em",code:"code",underline:"underline",escape:"escape",autolink:"autolink",reflink:"reflink",refimg:"refimg",link:"link",url:"url",br:"br",tag:"tag",comment:"comment",atag:"atag",imgtag:"imgtag",del:"del",todo:"todo",image:"image",footnote:"footnote",attr:"attr",emoji:"emoji",inline_math:"inline_math",subscript:"subscript",superscript:"superscript",linebreak:"linebreak",highlight:"highlight",html_entity:"html_entity"},l={};i.utils.extend(l,o,a,s);var c=0,d=function(){return"n"+c++},u=i.Model.extend({initialize:function(){var e=this.get("id")||d();this.get("id")||this.set("id",e),u.pool[e]&&console.warn("Duplicate Model"),u.pool[e]=this,this.TYPE=l,this.set("text",this.get("text")||""),this.set("broadcast",!1),this.set("children",new p)},isBlock:function(e){return u.isBlock(this.get("type"),e)},isTopBlock:function(){return this.get("attachTo")&&!this.get("parent")},isVirtualBlock:function(){return u.isVirtualBlock(this.get("type"))},getClosetBlock:function(e){return this.isBlock(e)?this:this.get("parent").getClosetBlock(e)},getTopBlock:function(){return this.isTopBlock()?this:this.get("parent").getTopBlock()},isInline:function(){return!this.isBlock(!0)},getLastChild:function(){try{return this.get("children").at(this.get("children").length-1).getLastBrother(!1)}catch(e){return null}},getFirstChild:function(){try{return this.get("children").at(0).getLastBrother(!0)}catch(e){return null}},escapedMark:function(e){return e.replace(/\*/g,"*").replace(/_/g,"_").replace(/`/g,"`")},isLoose:function(e){for(var t=this.getFirstChild(),n=t,i=!1;n;){if(function(e){for(var t=e.getFirstChild(),n=0,i=0;t;){if(u.isType(t,l.paragraph))n++;else{if(!u.isType(t,l.list))return!0;if(u.isType(t.get("after"),l.paragraph)||t.isLoose())return!0;i++}t=t.get("after")}return!(n<=1&&i<=1)}(n)){i=!0;break}n=n.get("after")}if(e)for(n=t;n;)n.set("tight",!i),n=n.get("after");return i},safeGetStrAttr:function(e,t){if("href-title"==e)return this.safeGetStrAttr("href")+" "+this.safeGetStrAttr("title");var n=this.get(e)?this.get(e):"";return t?r.escape(n):n},replaceWith:function(e){e.id!=this.id&&(e.get("after")&&e.get("after").set("before",e.get("before")),e.get("before")&&e.get("before").set("after",e.get("after")),e.set("parent",this.get("parent")),e.set("before",this.get("before")),e.set("after",this.get("after")),this.remove())},giveChildrenTo:function(e,t,n,i){if(0!=this.get("children").length){var r=t||this.getFirstChild();for(i&&(t=t||r,n=n||this.getLastChild(),t.get("before")&&t.get("before").set("after",n.get("after")),t.set("before",null),t.set("in",this.get("in")),n.set("after",null),n.set("in",this.get("in")));r;)r.set("parent",e),r=r.get("after")}},append:function(e,t){if(e)return e.detach(),this.get("children").length?t?this.getFirstChild().insert(e,!0):this.getLastChild().insert(e):(e.set("in",this.get("in")),e.set("parent",this)),e},appendTillEnd:function(e){if(e){var t=null,n=this.getLastChild();do{t=e.get("after"),e.detach(),n?n.insert(e):(e.set("parent",this),e.set("in",this.get("in"))),n=e,e=t}while(t)}},insertTillEnd:function(e){if(e){var t=null,n=this;do{t=e.get("after"),e.detach(),n.insert(e),n=e,e=t}while(t)}},insert:function(e,t){if(e){if(e instanceof Array)return console.warning("deprecate, use insertArray"),this.insertArray(e,t);var n=t?"before":"after";return this.get(n)!==e&&(e.detach(),e.set(n,this.get(n)),this.set(n,e)),e.set("in",this.get("in")),e.set("parent",this.get("parent")),e.set("attachTo",this.get("attachTo")),e}},insertArray:function(e,t,n){if(e&&e.length){var i=t?"before":"after",r=n?e[0]:e[0].getLastBrother(!0),o=n?e.last():e.last().getLastBrother(!1);"before"===i?(r.set("before",this.get("before")),o.set("after",this)):(o.set("after",this.get("after")),r.set("before",this));for(var a=0;a<e.length;a++)e[a].set("in",this.get("in")),e[a].set("parent",this.get("parent")),e[a].set("attachTo",this.get("attachTo")),n&&a>0&&e[a].set("before",e[a-1]);return r}},clearChildren:function(){this.get("in");this.get("children").forEach(function(e){e.delete()})},canContainBlock:function(e){return u.canContainBlock(this.get("type"),e)},canNotDirectEdit:function(){return u.isType(this,l.hr,l.math_block,l.list,l.list_item,l.toc)},getText:function(e,t){var n=[],i=this.get("children");return t=t||"",this.canContainBlock(!0)||i&&i.length>0?(i.forEach(function(t){n.push(t.getText(e))}),n=n.join(t),this.unset("text")):(n=this.get("text")||"",e&&u.isType(this,l.heading,l.paragraph,l.line)&&(n=r.escapeHead(n))),n},getNthChild:function(e){try{for(var t=this.get("children").at(0).getLastBrother(!0),n=0;t&&n<e;)n++,t=t.get("after");return t}catch(e){}return null},getChildIndex:function(){for(var e=this.get("before"),t=0;e;)e=e.get("before"),t++;return t},getVeryFirst:function(e,t){return 0==this.get("children").length||t&&u.isType(this,l.paragraph)?this:(e?this.getLastChild():this.getFirstChild()).getVeryFirst(e,t)},getLastBrother:function(e,t,n){var i=e?"before":"after",r=this.get("in").blocks;if(this.isTopBlock()){if(t)return null;if(!n&&r.length)return r.at(e?0:r.length-1).getLastBrother(e,!1,!0)}return this.get(i)?this.attributes[i].getLastBrother(e,t,!0):this},getVeryFirstBrotherIncludeTopBlock:function(e){return this.getVeryFirstBrother(e,!0)},getVeryFirstBrother:function(e,t){var n=e?"before":"after";return!t&&this.isTopBlock()?null:!this.get(n)&&this.get("parent")?this.get("parent").getVeryFirstBrother(e,t):this.get(n)?this.get(n).getVeryFirst(e):null},getClosetParagraphLevel:function(){return u.isType(this.get("parent"),l.paragraph)?this.get("parent"):this},contains:function(e){return!!e&&(this.id==e.id||this.contains(e.get("parent")))},closest:function(){for(var e=this.get("type"),t=0;t<arguments.length;t++)if(e==arguments[t])return this;var n=this.get("parent");return n?u.prototype.closest.apply(n,arguments):null},isStyled:function(){var e=this.get("type");return e==l.strong||e==l.em||e==l.code},isSeperated:function(){var e=this.get("type");return this.canNotDirectEdit()||e==l.code||e==l.escape},isDeleted:function(){return void 0==this.attributes},delete:function(e){this.attributes&&(this.set("parent",null),this.set("after",null),this.set("before",null),this.set("in",null),e?this.get("children").toArray().map(function(e){e.attributes.parent=null}):this.clearChildren()),u.pool[this.cid]=void 0,this.attributes=void 0},remove:function(e){var t=this.get("before"),n=this.get("after");this.delete(e),t&&t.set("after",n),n&&n.set("before",t)},detach:function(){var e=this.get("before"),t=this.get("after");e&&e.set("after",t),t&&t.set("before",e),this.set("parent",null),this.set("attachTo",null)},clearEmptyChar:function(){var e=this.attributes.text;e&&(e=e.replace(/\u200B/g,""),this.get("type")==l.line&&/\u200b +/.exec(this.attributes.text)&&(e="​"+e),this.attributes.text=e)},get:function(e){if(!this.attributes)return console.error("attributes for node has been deleted"),null;var t=this.attributes[e];switch(e){case"text":return t=t||"",u.isType(this,l.math_block)&&(t=t.replace(/^(\w*)\$\$(\w*)$/m,"$1\\$$$$$2")),t;default:return t}},set:function(e,t){var n,i,r=this.get("in");if("string"==typeof e){switch(i=this.get(e),e){case"parent":i&&i.attributes&&i.get("children").remove(this),t&&t.get("children").add(this);break;case"before":i&&i.attributes&&(i.attributes.after=null),t&&(t&&t.attributes.after&&t.attributes.after.attributes&&(t.attributes.after.attributes.before=null),t.attributes.after=this);break;case"after":i&&i.attributes&&(i.attributes.before=null),t&&(t&&t.attributes.before&&t.attributes.before.attributes&&(t.attributes.before.attributes.after=null),t.attributes.before=this);break;case"attachTo":i&&i.blocks.remove(this),t&&t.blocks.add(this);break;case"in":var o=this.get("attachTo");i&&(i.foot_list.remove(this),i.link_list.remove(this),i.blocks.remove(this),i.allNodes.remove(this)),t&&(this.get("type")!=l.def_footnote||t.foot_list.get(this.id)?this.get("type")!=l.def_link||t.link_list.get(this.id)||t.link_list.push(this):t.foot_list.push(this),t.allNodes.add(this),o&&this.set("attachTo",o));break;case"id":t&&(this.id=t,this.cid=t);break;case"ref":t=t?t.replace(/\u200b/gi,"").replace(/\\?\]/gi,"\\]"):t;break;case"href":t=t&&this.get("type")===l.def_link?t.replace(/\[|\]|"]/gi,""):t;break;case"title":break;case"type":t!=i&&(h.forEach(function(e){this.attributes[e]=void 0},this),this.attributes.ahead=void 0,this.attributes.tail=void 0,this.attributes.mathLabel=void 0,this.attributes.mathEqLabel=void 0)}this.attributes[e]=t,function(){var n=this.get("in")||r,o="type"===e&&i===l.heading||this.get("type")==l.heading&&u.isType(e,"depth","text","parent","before","after");n&&i!=t&&o&&n.toc&&n.toc.refresh(),this.get("type")===l.def_link&&i!=t&&("ref"===e?(File.editor.imgEdit.willUpdateImgRef(i),File.editor.imgEdit.willUpdateImgRef(t)):"text"===e&&File.editor.imgEdit.willUpdateImgRef(this.get("ref"))),n&&n.toc&&"type"==e&&t==l.toc&&setTimeout(function(){n.toc.refresh()},20)}.call(this),function(){var n=this.get("in")||r;"type"===e&&n&&(i===l.def_footnote&&n.foot_list.remove(this),i===l.def_link&&n.link_list.remove(this),t===l.def_footnote&&n.foot_list.push(this),t===l.def_link&&n.link_list.push(this)),u.isType(this.get("type"),l.def_link,l.def_link)&&File.editor.docMenu.resizeFooter()}.call(this),function(){this.get("in");(this.get("type")==l.meta_block&&"text"==e||"type"==e&&(i==l.meta_block||t==l.meta_block))&&File.isNode&&File.refreshImageCopyStatus(!0)}.call(this)}else{this.id||e.id||(e.id=d()),e.id&&this.set("id",e.id),e.in&&this.set("in",e.in),e.attachTo&&this.set("attachTo",e.attachTo),e.type&&this.set("type",e.type);for(n in e)-1==["id","in","attachTo","type"].indexOf(n)&&u.prototype.set.call(this,n,e[n])}return this}}),h=["depth","lang","pattern","align","style","checked","history","alt","attr","prespace","subindent","markindent"];u.property=["text","type","ahead","tail","header","href","title","ref","start","width","height"].concat(h),u.isBlock=function(e,t){return o[e]||t&&a[e]},u.isVirtualBlock=function(e){return a[e]},u.canContainBlock=function(e,t){return e==l.blockquote||e==l.list||e==l.list_item||t&&(e==l.table_row||e==l.table)},u.noChangeLine=function(e){for(var t=e;t;){if(u.isType(e,l.table_cell,l.def_footnote,l.def_link))return!0;t=t.get("parent")}return!1},u.isType=function(e){if(null!==e&&void 0!==e&&!1!==e){var t="object"==typeof e&&e.attributes?e.attributes.type:e;if(arguments[1]instanceof Array)return u.isType.apply(null,[t].concat(arguments[1]));for(var n=1;n<arguments.length;n++)if(t==arguments[n])return!0;return!(arguments.length>1)&&void 0}};var p=function(){this.reset(),Object.defineProperty(this,"length",{get:function(){return this._set.length}})};p.prototype.get=function(e){return this._map.get(e)},p.prototype.add=function(e){e.cid&&this._map.set(e.cid,e),this._set.push(e)},p.prototype.remove=function(e){this._set.remove(e),e.cid&&this._map.delete(e.cid)},p.prototype.at=function(e){return this._set[e]},p.prototype.first=function(){return this._set[0]},p.prototype.sortedFirst=function(){for(var e=this.first();e&&e.get("before");)e=e.get("before");return e},p.prototype.toArray=function(){return this._set.clone()},p.prototype.reset=function(){this._set=[],this._map=new Map},p.prototype.forEach=function(e,t){this._set.clone().forEach(e,t)},p.prototype.map=function(e,t){return this._set.clone().map(e,t)},p.prototype.sortedForEach=function(e,t){for(var n=this.sortedFirst();n;)e.call(t,n),n=n.get("after")},p.prototype.update=function(e){e.cid&&this._map.set(e.cid,e)},u.pool={};var f={toHTML:function(e){var t=[];if(e.length){var n=e instanceof Array,i=n?e[0]:e.at(0);if(!n)for(;i.get("before");)i=i.get("before");do{t.push(i.toHTML()),i=i.get("after")}while(i&&(!n||e.indexOf(i)>-1))}return t.join("")}},m=function(){this.blocks=new p,this.allNodes=new p,this.foot_list=[],this.link_list=[]};m.prototype.storeToJson=function(){return{blocks:this.blocks.map(function(e){return e.storeToJson()}),nid:c}},m.prototype.restoreFromJson=function(e){this.reset(),e.blocks.map(function(e){return u.readFromJson(e,this,!0)},this).map(function(t,n){t.set("before",this.allNodes.get(e.blocks[n].relation.before_id)),t.set("after",this.allNodes.get(e.blocks[n].relation.after_id))},this),c=e.nid-0,this.toc&&this.toc.refresh(!0,!0)},m.prototype.get=function(e){switch(e){case"allNodes":return this.allNodes;case"blocks":return this.blocks}},m.prototype.reset=function(e,t){this.blocks.forEach(function(e){e.delete()}),this.blocks.reset(),!e&&this.allNodes.length&&console.warn("nodeMap not clean"),this.allNodes.reset(),this.foot_list instanceof Array?(this.foot_list=[],this.link_list=[]):(this.foot_list.reset(),this.link_list.reset()),u.pool={},t&&(c=0)},m.prototype.getFirst=function(){return this.blocks.sortedFirst()},m.prototype.getLast=function(){if(this.blocks.length>0){var e=this.blocks.at(this.blocks.length-1);return e=e.getLastBrother(!1)}return null},u.backToParagraphBeforeDelete=[l.heading,l.def_footnote,l.def_link,l.meta_block,l.fences],u.ListType={ol:"ol",ul:"ul",task:"tasklist"},t.Node=u,t.NodeMap=m,t.NodeCollection=p,t.NodeCollectionUtils=f,t.TYPE=l,u.TYPE=l}),define("app/editor/polyfill",["jquery/jquery"],function(e,t,n){"use strict";var i=e("jquery/jquery");if(window.app&&(window.open=function(e,t){app.window.openLink(e)}),"performance"in window==0&&(window.performance=window.performance||{offset:Date.now(),now:function(){return Date.now()-this.offset}}),Element.prototype.insertChildAtIndex=function(e,t){t||(t=0),t>=this.children.length?this.appendChild(e):this.insertBefore(e,this.children[t])},DocumentFragment.prototype.insertChildAtIndex=function(e,t){t||(t=0),t>=this.children.length?this.appendChild(e):this.insertBefore(e,this.children[t])},Number.isNaN||(Number.isNaN=window.isNaN),Number.parseInt||(Number.parseInt=window.parseInt),!window.Set){var r=function(){this.set=[]};r.prototype.add=function(e){-1==!this.has(e)&&this.set.push(e)},r.prototype.delete=function(e){this.has(e)&&this.set.splice(this.set.indexOf(e))},r.prototype.has=function(e){return this.set.indexOf(e)>-1},window.Set=r}if(!window.Map){var o=function(){this.map={}};o.prototype.get=function(e){return this.map[e]},o.prototype.delete=function(e){delete this.map[e]},o.prototype.set=function(e,t){this.map[e]=t},window.Map=o}[].fill||Object.defineProperty(Array.prototype,"fill",{value:function(e){for(var t=Object(this),n=parseInt(t.length),i=arguments[1],r=parseInt(i)||0,o=r<0?Math.max(n+r,0):Math.min(r,n),a=arguments[2],s=void 0===a?n:parseInt(a)||0,l=s<0?Math.max(n+s,0):Math.min(s,n);o<l;o++)t[o]=e;return t}}),[].find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var i=arguments[1],r=0;r<n;){var o=t[r];if(e.call(i,o,r,t))return o;r++}}}),Object.defineProperty(Array.prototype,"remove",{value:function(e){var t=this.indexOf(e);if(~t)return this.splice(t,1)}}),Object.defineProperty(Array.prototype,"removeFirstIf",{value:function(e){for(var t=this.length;t--;)if(e(this[t],t))return void this.splice(t,1)}}),Object.defineProperty(Array.prototype,"removeIf",{value:function(e){for(var t=this.length;t--;)e(this[t],t)&&this.splice(t,1)}}),Object.defineProperty(Array.prototype,"repeat",{value:function(e,t){for(;t;)this[--t]=e;return this}}),Object.defineProperty(Array.prototype,"last",{value:function(){return this.length?this[this.length-1]:void 0}}),Object.defineProperty(Array.prototype,"lastDef",{value:function(){for(var e=this.length-1;e>=0;e--)if(void 0!=this[e])return this[e]}}),Object.defineProperty(Array.prototype,"clone",{value:function(){return this.slice(0)}}),window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(e,t){t=t||window;for(var n=0;n<this.length;n++)e.call(t,this[n],n,this)}),i.fn.visibleText=function(){if(0===this.length)return"";if(1===this.length&&(3===this[0].nodeType||0===this[0].childElementCount))return this.text();var e="";return i.each(this.contents(),function(t,n){3===n.nodeType?e+=n.textContent:1===n.nodeType&&(n.offsetHeight||n.offsetWidth)&&(e+=i(n).visibleText())}),e},window.console&&function(){if(console.stack=function(e){(new Error).stack},File.isMac||File.isNode){var e;File.isNode&&(e=reqnode("electron").ipcRenderer);var t=console.error;console.error=function(n){t(n),File.isMac?app.window.log("[Error] "+n):File.isNode&&(e||(e=reqnode("electron").ipcRenderer),e&&e.send("sendError",n))};var n=console.log;if(console.log=function(t){n(t),File.isMac?app.window.log("[Log] "+t):File.isNode&&(e||(e=reqnode("electron").ipcRenderer),e&&e.send("sendLog",t))},window.debugMode&&File.isMac){var i=console.debug;console.debug=function(e){i(e),File.isMac&&app.window.log("[Debug] "+e)}}}}(),void 0===NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),void 0===HTMLCollection.prototype.forEach&&(HTMLCollection.prototype.forEach=Array.prototype.forEach),window.Promise||function(e){function t(){}function n(e,t){return function(){e.apply(t,arguments)}}function i(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],c(e,this)}function r(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,i._immediateFn(function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null!==n){var i;try{i=n(e._value)}catch(e){return void a(t.promise,e)}o(t.promise,i)}else(1===e._state?o:a)(t.promise,e._value)})):e._deferreds.push(t)}function o(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if(t instanceof i)return e._state=3,e._value=t,void s(e);if("function"==typeof r)return void c(n(r,t),e)}e._state=1,e._value=t,s(e)}catch(t){a(e,t)}}function a(e,t){e._state=2,e._value=t,s(e)}function s(e){2===e._state&&0===e._deferreds.length&&i._immediateFn(function(){e._handled||i._unhandledRejectionFn(e._value)});for(var t=0,n=e._deferreds.length;t<n;t++)r(e,e._deferreds[t]);e._deferreds=null}function l(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function c(e,t){var n=!1;try{e(function(e){n||(n=!0,o(t,e))},function(e){n||(n=!0,a(t,e))})}catch(e){if(n)return;n=!0,a(t,e)}}var d=setTimeout;i.prototype.catch=function(e){return this.then(null,e)},i.prototype.then=function(e,n){var i=new this.constructor(t);return r(this,new l(e,n,i)),i},i.all=function(e){var t=Array.prototype.slice.call(e);return new i(function(e,n){function i(o,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(e){i(o,e)},n)}t[o]=a,0==--r&&e(t)}catch(e){n(e)}}if(0===t.length)return e([]);for(var r=t.length,o=0;o<t.length;o++)i(o,t[o])})},i.resolve=function(e){return e&&"object"==typeof e&&e.constructor===i?e:new i(function(t){t(e)})},i.reject=function(e){return new i(function(t,n){n(e)})},i.race=function(e){return new i(function(t,n){for(var i=0,r=e.length;i<r;i++)e[i].then(t,n)})},i._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){d(e,0)},i._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)},i._setImmediateFn=function(e){i._immediateFn=e},i._setUnhandledRejectionFn=function(e){i._unhandledRejectionFn=e},window.Promise=i}(window)}),define("app/window/FileHelper",["app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster"],function(e,t,n){"use strict";var i=e("app/document/StringUtils"),r=e("app/editor/EditHelper"),o=window.reqnode?reqnode("electron").remote:null,a={NSChangeDone:0,NSChangeUndone:1,NSChangeCleared:2,NSChangeReadOtherContents:3,NSChangeAutosaved:4,NSChangeRedone:5},s=function(){this.doneStack=[],this.undoneStack=[],this.curState=[a.NSChangeAutosaved,new Date-0],this.lastSaved=this.curState[1]};s.prototype.isDocumentEdited=function(){return!this.curState},s.prototype.clone=function(){return{doneStack:this.doneStack.clone(),undoneStack:this.undoneStack.clone(),curState:this.curState,lastSaved:this.lastSaved}},s.prototype.reset=function(e){this.doneStack=e?e.doneStack:[],this.undoneStack=e?e.undoneStack:[],this.curState=e?e.curState:[a.NSChangeAutosaved,new Date-0],this.lastSaved=e?e.lastSaved:this.curState[1]},s.prototype.isDiscardableUntitled=function(){return!(File.fileHasModified||File.changeCounter.isDocumentEdited()||File.filePath)},s.prototype.updateChangeCount=function(e){var t,n=this.curState;switch(File.fileHasModified=File.filePath||!0,e){case a.NSChangeDone:this.curState&&this.curState[0]===a.NSChangeAutosaved&&(this.doneStack.push(this.curState),this.curState=null),this.doneStack.push([e]),this.doneStack.length>200&&this.doneStack.splice(0,this.doneStack.length-200),this.undoneStack=[];break;case a.NSChangeUndone:for(this.curState&&this.curState[0]===a.NSChangeAutosaved&&(this.undoneStack.push(this.curState),this.curState=null),this.doneStack.pop(),this.undoneStack.push([e]);(t=this.doneStack.last())&&t&&t[0]===a.NSChangeAutosaved;)this.doneStack.pop(),this.lastSaved===t[1]&&(this.curState=t);break;case a.NSChangeRedone:for(this.curState&&this.curState[0]===a.NSChangeAutosaved&&(this.doneStack.push(this.curState),this.curState=null),this.undoneStack.pop(),this.doneStack.push([e]);(t=this.undoneStack.last())&&t&&t[0]===a.NSChangeAutosaved;)this.undoneStack.pop(),this.lastSaved===t[1]&&(this.curState=t);break;case a.NSChangeCleared:File.resumeFileChangeTimestamp=new Date,this.doneStack=[],this.undoneStack=[],this.curState=[a.NSChangeAutosaved,new Date-0],this.lastSaved=this.curState[1];break;case a.NSChangeAutosaved:if(File.resumeFileChangeTimestamp=new Date,this.curState)return;this.curState=[a.NSChangeAutosaved,new Date-0],this.lastSaved=this.curState[1];break;case a.NSChangeReadOtherContents:File.resumeFileChangeTimestamp=new Date;for(var i=[],r=[],o=0;o<this.doneStack.length;o++)this.doneStack[o][0]!==a.NSChangeAutosaved&&i.push(this.doneStack[o]);for(o=0;o<this.undoneStack.length;o++)this.undoneStack[o][0]!==a.NSChangeAutosaved&&r.push(this.undoneStack[o]);this.doneStack=i,this.undoneStack=r,this.curState=null}n!==this.curState&&File.isNodeHtml&&l()};var l=function(){if(File.changeCounter)if(File.changeCounter.curState)(File.filePath||File.fileName)&&File.isNode&&(e=o.getCurrentWindow()).setTitle(e.getTitle().replace(/•? - Typora$/," - Typora")),document.querySelector("#title-text").classList.remove("title-modified"),document.querySelector("#m-saved").parentElement.classList.add("saved");else{if(document.querySelector("#title-text").classList.add("title-modified"),File.isNode){var e=o.getCurrentWindow();e.setTitle(e.getTitle().replace(/•? - Typora$/,"• - Typora"))}document.querySelector("#m-saved").parentElement.classList.remove("saved")}};t.showExportDialog=function(e,t,n,a,s){var l=o.getCurrentWindow(),c=o.app,d=File.getFilePathUseNode(),u=o.dialog;d?(e=e||"md",d=d.replace(/\.[^\/\\.]+$/,"")+"."+e):d=c.getPath("userDesktop")+"/"+File.getSuggestedFileName(!0)+"."+e;var h=$.isFunction(t)?t:function(e){var o=a||function(t){t&&(r.getDialog("Error",$.localize.getString("Failed to export file to <em>{0}</em>","Panel").format(i.escape(e)),!0,"error-dialog").modal({backdrop:"static"}),console.error(t))},s=t;e&&File.fs.writeFile(e,s,n,o)};u.showSaveDialog(l,{properties:["saveFile"],title:$.localize.getString("Save","Menu"),defaultPath:d,filters:s?[{name:e.toUpperCase(),extensions:[e]},{name:$.localize.getString("All Files","Panel"),extensions:[]}]:[]},h)},t.showSaveDialog=function(e,t){var n=o.getCurrentWindow(),i=o.app,r=File.getFilePathUseNode(),a=o.dialog;r||(r=i.getPath("documents")+"/"+(c(r)||File.getSuggestedFileName())+".md"),a.showSaveDialog(n,{properties:["saveFile"],title:c(r)||File.getSuggestedFileName(),defaultPath:r,filters:[{name:$.localize.getString("Markdown File","Panel"),extensions:["md","markdown","mmd","mdown"]},{name:$.localize.getString("Plain Text File","Panel"),extensions:["txt","text",""]},{name:$.localize.getString("All Files","Panel"),extensions:[]}]},function(r){r?(i.setPath("documents",reqnode("path").dirname(r)),File.fs.writeFileSync(r,File.editor.getMarkdown(),"utf8"),File.resumeFileChangeTimestamp=new Date,i.getDocumentController().getDocument(r)||(i.getDocumentController().getDocumentFromWindowId(n.id).rename(r),File.FileInfoPanel.setFileTitle(r),File.updateChangeCount(File.ChangeType.NSChangeAutosaved)),e&&e()):t&&t()})};var c=function(e){return(e=e&&e.replace(/\\/g,"/").replace(/\/$/,""))&&e.substring(e.lastIndexOf("/")+1)},d=null,u=function(e,t){File.inSavingProcess&&setTimeout(function(){u(e)},500);var n=File.getCurrentDocByNode();if(File.fileHasModified&&File.changeCounter.isDocumentEdited()&&n.windows.size<=1){if(t&&(File.option.enableAutoSave||File.option.saveFileOnSwitch)&&File.filePath)return File.buildDocumentSnap(),void File.saveUseNode(e);var i=r.getDialog($.localize.getString("Save","Menu"),$.localize.getString("Do you want to save the changes made to this document ?<br> Your changes will be lost if you don't save them.","Panel"),!0,"three-way-dialog",$.localize.getString("Save","Menu"),$.localize.getString(File.path?"Discard Changes":"Discard","Panel"));i.modal({backdrop:!1,keyboard:!1}),i.off("click","#three-way-dialog-yes-btn").off("click","#three-way-dialog-yes-btn").on("click","#three-way-dialog-yes-btn",function(){i.modal("hide"),File.buildDocumentSnap(),File.saveUseNode(e)}).on("click","#three-way-dialog-no-btn",function(){i.modal("hide"),File.buildDocumentSnap(),n.setLastSync(-1),e()})}else e()},h=["","md","markdown","mmd","text","txt","mdown"],p=function(e){return!(!e||"."==e[0])&&~h.indexOf(f(e).toLowerCase())},f=function(e){return(e.split(/[\/\\]/).last().match(/\.([^.]+)$/)||[])[1]||""};!function(){function e(){File.option.copyMarkdownByDefault=!0,window.ClientCommand.selectAll(),setTimeout(function(){window.ClientCommand.copy(),setTimeout(function(){File.editor.EditHelper.showNotification("Context copied to clipboard.")},500)},500)}$("#save-error-banner").on("click",".btn",e).on("click","#trigger-save-error-dialog",function(){$("#save-error-dialog").modal("show"),$("#save-error-banner").hide()}),$("#save-error-dialog").on("click",".btn-primary",e).on("hidden.bs.modal",function(){$("#save-error-banner").show()})}();t.getFileNameFromPath=c,t.normalizePath=function(e){return File.isNode?reqnode("path").normalize(e):app.path.normalize(e)},t.getFileFolderPath=function(e){return File.isNode?reqnode("path").dirname(e):(e=(e||"").replace(/\\/g,"/"),e=e&&e.substring(0,e.lastIndexOf("/")+1),File.isNode&&"win32"==process.platform?e.replace(/\//g,"\\"):e)},t.getCurrentFilePath=function(){return File.isMac?app.document.currentFilePath():File.isNode?File.filePath||"":""},t.getCurrentFileFolderPath=function(){return File.isMac?app.document.currentFolderPath():File.isNode&&File.filePath?reqnode("path").dirname(File.filePath):""},t.getUnsavedDraftsPath=function(){return d||(d=reqnode("path").resolve(o.app.getPath("userData"),"draftsRecover"),reqnode("fs-extra").ensureDirSync(d)),d},t.ChangeType=a,t.ChangeCounter=s,t.tryLeaveDocument=u,t.refreshTitlebarText=l,t.allowedExtensions=h,t.isSupportedFile=p,t.detectEncodeByNode=function(e){var t=reqnode("jschardet"),n=reqnode("iconv-lite"),i=(reqnode("is-utf8")(e)?"utf8":t.detect(e).encoding)||"utf8";return"ascii"==i.toLowerCase()&&(i="utf8"),n.encodingExists(i)||(i=i.replace(/-/g,"_")),i=n.encodingExists(i)?i:"utf8"},t.getContentFromBuffer=function(e,t){var n=reqnode("iconv-lite");return"utf8"==t||"uft16le"==t?e.toString(t):n.decode(e,t)},t.statWrapper=function(e,t){var n={},i=reqnode("path").basename(e),r=e===File.getMountFolder();if(!r&&i&&"."==i[0])return n.shouldIgnore=!r,t(n);if(File.isWin)reqnode("fswin-aio").getAttributes(e,function(e){if(!e)return t(null);n.shouldIgnore=e.IS_HIDDEN||e.IS_SYSTEM||e.IS_TEMPORARY,n.isDir=e.IS_DIRECTORY,n.isFile=!n.isDir,n.mtime=e.LAST_WRITE_TIME,n.size=0,n.shouldIgnore||(n.isDir?n.shouldIgnore="node_modules"==i:n.isFile&&!n.shouldIgnore&&(n.shouldIgnore=!p(i))),r&&(n.shouldIgnore=!1),t(n)});else{var o=reqnode("util");reqnode("fs").stat(e,function(e,a){if(e||!a)return t(null);n.isDir=a.isDirectory(),n.isFile=a.isFile(),n.mtime=new Date(o.inspect(a.mtime)),n.size=a.size/1e3,/\.asar[\/\\]*$/.exec(i)&&(n.isFile=!0,n.isDir=!1,n.shouldIgnore=!0),n.isDir?n.shouldIgnore="node_modules"==i:n.isFile&&(n.shouldIgnore=n.shouldIgnore||!p(i)||n.size>5e3),r&&(n.shouldIgnore=!1),t(n)})}},t.saveFileFailedOnNode=function(){$("#save-error-dialog").modal("show"),File.editor.library.hideSidebar(!0),File.lock(),File.isBroken=!0}}),define("app/editor/EditHelper",["jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/document/StringUtils","app/editor/KeyMaster"],function(e,t,n){"use strict";function i(e,t){var n,o=e.getAttribute("width")||"",a=e.getAttribute("height")||"",s=r(t.children||[]),l=/^[\d.]+$/;n=window.getComputedStyle(e).cssText.replace(/;\s*-webkit-[^;]+;/g,""),l.test(o)&&(n=n.replace("; width: auto;","; width: "+o+"px;")),l.test(a)&&(n=n.replace("; height: auto;","; height: "+a+"px;")),t.style.cssText=n,s.length&&r(e.children||[]).forEach(function(e,t){i(e,s[t])})}function r(e){for(var t=[],n=e.length,i=0;i<n;i++)t.push(e[i]);return t}function o(e,t,n){var r=e.cloneNode(!0),o=e.getBoundingClientRect();t&&i(e,r),r.setAttribute("height",o.bottom-o.top);var s=a(r.outerHTML);return n?s:"data:image/svg+xml;charset=utf-8,"+s}function a(e){return e.replace(/xmlns:NS\d+/gi,"xmlns:xlink").replace(/NS\d+:href/gi,"xlink:href").replace(/NS\d+:space/gi,"xml:space").replace(/NS\d+:/gi,"")}var s,l=e("jquery/jquery"),c=(e("app/document/Node").Node,e("app/document/StringUtils"),e("app/editor/KeyMaster").map,e("exoskeleton-master/exoskeleton"),!1),d=l("#ty-tooltip");l("body").on("mouseenter","[ty-hint]",function(){var e=l(this),t=l.Event("before-show-ty-hint",{cancel:!1});if(e.trigger(t),!t.cancel){d.text(this.getAttribute("ty-hint")).addClass("shown").attr("style","");var n=e.offset(),i=d[0].clientWidth,r=n.left+this.clientWidth/2;"right"==e.attr("ty-hint-pos")?n.left+=this.clientWidth+4:(n.top>window.innerHeight/2?n.top=n.top-d[0].clientHeight-6:n.top+=this.clientHeight,i/2+r>window.innerWidth?n.left=window.innerWidth-i-4:(n.left=r-i/2,n.left=Math.max(2,n.left))),d.offset(n),new Date-s<2e3?d.addClass("instant"):d.removeClass("instant")}}).on("mouseleave click","[ty-hint]",function(){s=new Date,d.removeClass("shown")}),function(){var e=document.querySelector("#write");l(document.body).on("keydown","input",function(t){if(!e.contains(this)){var n=event.keyCode||event.which;if(File.isNode){if("Z"==String.fromCharCode(n)&&(File.isMacOrMacNode?t.metaKey:t.ctrlKey))return reqnode("electron").remote.getCurrentWindow().webContents.undo(),!1;if("Y"==String.fromCharCode(n)&&(File.isMacOrMacNode?t.metaKey:t.ctrlKey))return reqnode("electron").remote.getCurrentWindow().webContents.redo(),!1}if(File.isMac){if("Z"==String.fromCharCode(n)&&t.metaKey)return t.shiftKey?app.window.redo():app.window.undo(),!1;if("Y"==String.fromCharCode(n)&&t.metaKey&&!t.shiftKey)return app.window.redo(),!1}}})}(),t.getDialog=function(e,t,n,i,r,o){var a=l("#"+(i=i||"quick-dialog"));return a.find("#"+i+"-title").text(e),n?a.find("#"+i+"-message").html(t):a.find("#"+i+"-message").text(t),a.find(".btn-primary").text(r||"OK").off("click"),a.find("#three-way-dialog-no-btn").text(o||"No").off("click"),a},t.replaceTag=function(e,t){var n=e[0].outerHTML,i=new RegExp("<"+e[0].tagName,"i"),r=n.replace(i,"<"+t);i=new RegExp("</"+e[0].tagName+">$","i"),r=r.replace(i,"</"+t+">");var o=l(r);return e.replaceWith(o),o},t.getEditParent=function(e,t){return t.getClosetBlock(!0)},t.fixPopoverPosition=function(e,t,n){var i,r=e.offset(),o=l(editor.sessionStr).offset().left+10,a=l(editor.sessionStr).width(),s=e.find(".md-arrow");return(t=t||".code-tooltip.md-hover-tip").jquery?s=(i=t).find(".md-arrow"):i=e.find(t),e.length?(i.css("max-width",a-60),r.top+=e.height()*(n?1:1.5)+(n?0:4),r.left+=(e.width()-i.width())/2,r.left+i.width()>window.innerWidth-10?r.left=window.innerWidth-10-i.width():r.left<o&&(r.left=o),i.css("position","absolute").offset(r),!n&&s.offset(function(t,n){var i={};return i.left=e.offset().left+e.width()/2,i.top=n.top,i}),i):(console.error("cannot fixPopoverPosition on empty $parent"),i.hide())},t.showNotification=function(e,t){var n="<p>"+e+"<span class='btn close-btn btn-xs' aria-label='"+l.localize.getString("Close")+"'><span class='glyphicon glyphicon-remove'></span></span></p>";l("#md-notification").html(n).show().delay(5e3).fadeOut()},t.resetClick=function(e){var t=File.editor;if(c)return!(c=!1);if(e.target&&("CONTENT"==e.target.tagName||"HTML"==e.target.tagName)){var n=e.clientX,i=e.clientY,r=document.querySelector(t.sessionStr),o=l(r).offset(),a=document.createEvent("MouseEvents"),s=o.left,d=o.left+r.clientWidth,u=o.top,h=o.top+r.clientHeight;if(n>=s&&n<=d||i>=u&&i<=h)return;if(c=!0,n=n<o.left?o.left+1:o.left+r.clientWidth-1,i=i<o.top?o.top+1:o.top+r.clientHeight-1,e.stopPropagation(),a=document.createEvent("MouseEvents"),!(r=document.elementFromPoint(n,i)))return;a.initMouseEvent("click",!0,!0,r.ownerDocument.defaultView,1,e.screenX+(n-e.clientX),e.screenY+(i-e.clientY),n,i,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button),r.dispatchEvent(a)}},t.getWordCount=function(e){if(0===e.trim().length)return 0;var t=0,n=["d",e.replace(/[\u303F-\uFAFF]/gi,function(e){return t++," "}).replace(/(^|\s+)[!-\/:-@\[-`{-~]+(\s+|$)/gm," "),"d"].join(" ").split(/[\s!-,\.\\:-@\[-`{-~]+/g).length;return t+n-2},t.SVG2HtmlImg=function(e){if(!e)return"";var t=o(e,!0),n=document.createElement("img"),i=e.getBoundingClientRect();return n.width=i.width,n.height=i.height,n.setAttribute("src","data:image/svg+xml;base64,"+btoa(t)),n.outerHTML},t.svg2DataURL=o,t.processExportedSVG=a,t.findAnchorElem=function(e){if(e.match(/^#/)){var t=(e.substr(1)||"").toLowerCase().trim().replace(/-/g," ");return l("#write").find("h1, h2, h3, h4, h5, h6").filter(function(){var e=l(this).text().toLowerCase().trim().replace(/-/g," ");return e==t||e==decodeURI(t)})}}}),define("app/editor/KeyMaster",[],function(e,t,n){"use strict";function i(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1}function r(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function o(e){for(h in f)f[h]=e[w[h]]}function a(e){var t,n,r,a,c,d;if(t=e.keyCode,-1==i(b,t)&&b.push(t),93!=t&&224!=t||(t=91),t in f){f[t]=!0;for(r in g)g[r]==t&&(s[r]=!0)}else if(o(e),s.filter.call(this,e)&&t in p)for(d=l(),a=0;a<p[t].length;a++)if((n=p[t][a]).scope==d||"all"==n.scope){c=n.mods.length>0;for(r in f)(!f[r]&&i(n.mods,+r)>-1||f[r]&&-1==i(n.mods,+r))&&(c=!1);(0!=n.mods.length||f[16]||f[18]||f[17]||f[91])&&!c||!1===n.method(e,n)&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}function s(e,t,n){var i,r;i=c(e),void 0===n&&(n=t,t="all");for(var o=0;o<i.length;o++)r=[],(e=i[o].split("+")).length>1&&(r=d(e),e=[e[e.length-1]]),e=e[0],(e=y(e))in p||(p[e]=[]),p[e].push({shortcut:i[o],scope:t,method:n,key:i[o],mods:r})}function l(){return m||"all"}function c(e){var t;return e=e.replace(/\s/g,""),""==(t=e.split(","))[t.length-1]&&(t[t.length-2]+=","),t}function d(e){for(var t=e.slice(0,e.length-1),n=0;n<t.length;n++)t[n]=g[t[n]];return t}function u(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,function(){n(window.event)})}var h,p={},f={16:!1,18:!1,17:!1,91:!1},m="all",g={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,command:91},v={backspace:8,tab:9,clear:12,enter:13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},y=function(e){return v[e]||e.toUpperCase().charCodeAt(0)},b=[];for(h=1;h<20;h++)v["f"+h]=111+h;var w={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey"};for(h in g)s[h]=!1;u(document,"keydown",function(e){a(e)}),u(document,"keyup",function(e){var t,n=e.keyCode,r=i(b,n);if(r>=0&&b.splice(r,1),93!=n&&224!=n||(n=91),n in f){f[n]=!1;for(t in g)g[t]==n&&(s[t]=!1)}}),u(window,"focus",function(){for(h in f)f[h]=!1;for(h in g)s[h]=!1});var x=s;n.exports=x,x.setScope=function(e){m=e||"all"},x.getScope=l,x.deleteScope=function(e){var t,n,i;for(t in p)for(n=p[t],i=0;i<n.length;)n[i].scope===e?n.splice(i,1):i++},x.filter=function(e){return!("SELECT"==(e.target||e.srcElement).tagName)},x.isPressed=function(e){return"string"==typeof e&&(e=y(e)),-1!=i(b,e)},x.getPressedKeyCodes=function(){return b.slice(0)},x.unbind=function(e,t){var n,i,o,a,s,u=[];for(n=c(e),a=0;a<n.length;a++){if((i=n[a].split("+")).length>1&&(u=d(i),e=i[i.length-1]),e=y(e),void 0===t&&(t=l()),!p[e])return;for(o in p[e])(s=p[e][o]).scope===t&&r(s.mods,u)&&(p[e][o]={})}},void 0!==n&&(n.exports=x);var C={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",91:"Command",107:"=",109:"-",127:"Delete",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"};x.map=C,x.functionKey=["Command","Ctrl","Shift","Alt","Home","End","PageUp","PageDown","CapsLock","Esc","PrintScrn","Insert","Pause"],x.handleCtrlDown=function(e){$(e.sessionStr+" a").attr("contenteditable",!0)},x.isCommand=function(e){return String.fromCharCode(e.which).length>0&&(e.ctrlKey||e.metaKey)},x.handleCtrlUp=function(e){$(e.sessionStr+" a").attr("contenteditable",!1)}}),define("app/window/MenuHelper",["exoskeleton-master/exoskeleton","jquery/jquery","app/editor/UndoManager","app/document/StringUtils","app/document/Node","app/editor/polyfill"],function(e,t,n){"use strict";function i(e,t){e=e||(File.isNode?c.Menu.getApplicationMenu().getItem("Format").submenu:d.menu.getItem("Format").submenu()),!t&&File.editor.stylize.putBookmark(null,File.editor.stylize.buildBookmark());var n=File.editor.styleBookmark.style,i=(File.editor.stylize.CONST.NormalBlockMap[n.block[0]],File.editor.stylize.CONST.NoInline.indexOf(n.block[0])>-1);n.block[0]==l.def_footnote&&(i=i||File.editor.stylize.isAtFootnoteDefSpan()),i=i||!n.inline.indexOf(l.inline_math),["Strong","Emphasis","Underline","Code","Strike","Hyperlink","Image","Clear Format","Inline Math","Highlight","Subscript","Superscript","Comment"].map(function(t){var n=e.getItem(t);n&&(n.setEnabled(!File.isLocked&&!i),n.setState(!1))});var r;(r=e.getItem("Inline Math"))&&r.setHidden(!File.option.enableInlineMath),(r=e.getItem("Highlight"))&&r.setHidden(!File.option.enableHighlight),(r=e.getItem("Subscript"))&&r.setHidden(!File.option.enableSubscript),(r=e.getItem("Superscript"))&&r.setHidden(!File.option.enableSuperscript);var o=["image","strong","em","link"];(File.editor.styleBookmark.style.inline||[]).map(function(t){var n=e.getItem(File.editor.stylize.CONST.StyleToNameMap[t]);n&&n.setState(!0),File.isMac&&d.touchBar&&(o.remove(t),d.touchBar.setStateForInline(!0,File.editor.stylize.CONST.StyleToNameMap[t]))}),File.isMac&&d.touchBar&&(d.touchBar.setInlineEnabled(!i),i||o.map(function(e){d.touchBar.setStateForInline(!1,File.editor.stylize.CONST.StyleToNameMap[e])}))}function r(e,t){e=e||(File.isMac?d.menu.getItem("Paragraph").submenu():c.Menu.getApplicationMenu().getItem("Paragraph").submenu),!t&&File.editor.stylize.putBookmark(null,File.editor.stylize.buildBookmark());var n=File.editor.styleBookmark.style,i=File.editor.stylize.CONST.NormalBlockMap[n.block[0]];["Heading 1","Heading 2","Heading 3","Heading 4","Heading 5","Heading 6","Paragraph","Decrease Heading Level","Increase Heading Level","Link Reference","Footnotes","YAML Front Matter","Table","Horizontal Line","Code Fences","Math Block","Quote","Ordered List","Unordered List","Task List","Table of Contents"].map(function(t){var r=e.getItem(t);try{r&&(r.setEnabled(!File.isLocked&&n.block.length>0&&void 0!=i),r.setState(!1))}catch(e){console.error(e),console.error(t)}}),!function(){try{return File.editor.getMarkElem(window.getSelection().getRangeAt(0).startContainer).attr("mdtype")==a.TYPE.meta_block}catch(e){}return!1}()?["Paragraph","Quote","Ordered List","Unordered List","Task List","Code Fences","Math Block"].map(function(t){e.getItem(t).setEnabled(!0)}):e.getItem("Paragraph").setEnabled(!0);var r=null,o=!1;(File.editor.styleBookmark.style.block||[]).map(function(t){var n=e.getItem(File.editor.stylize.CONST.StyleToNameMap[t]);n&&n.setState(!0),!r&&s.isType(t,"ol","ul","tasklist")&&(r=t),t==l.blockquote&&(o=!0);var i=e.getItem("Task Status");if("tasklist"==t){i.setEnabled(!0);var a=File.isNode?i.submenu:i.submenu();"checked"==File.editor.styleBookmark.style.state?(a.getItem("Mark as Complete").setState(!0),a.getItem("Mark as Incomplete").setState(!1)):(a.getItem("Mark as Complete").setState(!1),a.getItem("Mark as Incomplete").setState(!0))}else i.setEnabled(!1)}),File.isMac&&d.touchBar&&($("#md-searchpanel").is(":visible")?d.touchBar.showFindReplaceTouchBar():document.body.classList.contains("modal-open")?$("#table-insert-dialog:visible").length?d.touchBar.showInsertTableTouchBar():d.touchBar.showDialogTouchBar():d.touchBar.setBlockStyle({blockStyle:File.editor.stylize.CONST.StyleToNameMap[function(e){return e[0]==l.line?l.paragraph:e[0]==l.table_cell?l.table:e[0]}(n.block)]||"",listType:r,underQuote:o,fallbackOnly:!i}))}function o(e){if(e){var t=File.editor.sourceView&&File.editor.sourceView.inSourceMode;if(e.getItem("Source Code Mode").setState(t),e.getItem("Source Code Mode").setEnabled(!File.isLocked),e.getItem("Always on Top").setState(File.isMac?d.window.isAlwaysOnTop():c.getCurrentWindow().isAlwaysOnTop()),e.getItem("Focus Mode").setState(File.isFocusMode),e.getItem("Focus Mode").setEnabled(!0),e.getItem("Typewriter Mode").setState(File.isTypeWriterMode),e.getItem("Typewriter Mode").setEnabled(!0),File.editor.library){var n=File.editor.library.isSidebarShown(),i=File.editor.library.getActiveTab();e.getItem("Outline").setState(n&&"outline"==i),e.getItem("Outline").setEnabled(!t),e.getItem("Articles").setState(n&&"file-list"==i),e.getItem("Articles").setEnabled(!t),e.getItem("File Tree").setState(n&&"file-tree"==i),e.getItem("File Tree").setEnabled(!t)}}}e("exoskeleton-master/exoskeleton"),e("app/editor/UndoManager");var a=e("app/document/Node"),s=a.Node,l=a.TYPE,c=(e("app/editor/polyfill"),window.reqnode?reqnode("electron").remote:null),d=c?c.app:window.app,u=null,h=function(){u&&clearTimeout(u),u=setTimeout(function(){r(),i(void 0,!0)},400)},p={doRefreshImageCopyStatus:function(e){var t,n,i,r,o=File.editor,a=o.imgEdit&&o.imgEdit.getTagetImageStorageFolder();if(File.isNode)n=(t=c.Menu.getApplicationMenu().getItem("Edit").submenu.getItem("Image Tools")).submenu.getItem("Use Image Root Path"),(r=t.submenu.getItem("When Insert Local Image").submenu.getItem("Copy Image File to Folder…")).setState(!!a);else if(File.isMac){var s=(t=d.menu.getItem("Edit").submenu().getItem("Image Tools")).submenu().getItem("When Insert Local Image").submenu();n=t.submenu().getItem("Use Image Root Path"),i=s.getItem("Upload Image via iPic"),(r=s.getItem("Copy Image File to Folder…")).setState(!!a&&"ipic"!==a.toLowerCase()),i.setState(a&&"ipic"==a.toLowerCase())}n.setState(!!File.editor.docMenu.getLocalRootUrl()),void 0!==e&&(r.setEnabled(!e),n.setEnabled(!e),i&&i.setEnabled(!e))},refreshViewMenu:o,refreshBlockMenu:r,bindMenu:function(){if(File.isMac){var e=File.editor.sourceView.inSourceMode,t=d.menu.getItem("Edit").submenu();t.setMenuWillOpen(function(){t.getItem("Delete").setEnabled(!File.isLocked&&!e),t.getItem("Delete").setEnabled(!File.isLocked&&!e)}),t.getItem("Image Tools").submenu().setMenuWillOpen(function(){File.refreshImageCopyStatus(!1)});l=d.menu.getItem("Paragraph").submenu();(a=(u=d.menu.getItem("Format").submenu()).getItem("Inline Math"))&&a.setHidden(!File.option.enableInlineMath),(a=u.getItem("Highlight"))&&a.setHidden(!File.option.enableHighlight),(a=u.getItem("Subscript"))&&a.setHidden(!File.option.enableSubscript),(a=u.getItem("Superscript"))&&a.setHidden(!File.option.enableSuperscript),l.setMenuWillOpen(function(){r(l);var e=l.getItem("Heading 6");e.setHidden(!e.getState())}),l.setMenuDidClose(function(){l.getItem("Heading 6").setHidden(!1)}),u.setMenuWillOpen(function(){i(u)}),r(l),i(u,!0),File.freshMenu(),$(File.editor.sessionStr).on("cursorChange",function(){h()});var n=d.menu.getItem("View").submenu();n.setMenuWillOpen(function(){o(n),d.controller.adjustTabMenuItem()})}else if(File.isNode){var a,s=c.Menu.getApplicationMenu(),l=s.getItem("Paragraph").submenu,u=s.getItem("Format").submenu;(a=u.getItem("Inline Math"))&&a.setHidden(!File.option.enableInlineMath),(a=u.getItem("Highlight"))&&a.setHidden(!File.option.enableHighlight),(a=u.getItem("Subscript"))&&a.setHidden(!File.option.enableSubscript),(a=u.getItem("Superscript"))&&a.setHidden(!File.option.enableSuperscript),$(File.editor.sessionStr).on("cursorChange",function(){h()})}},freshMenu:function(e){function t(){function t(e,t){n.getItem(e).setEnabled(t),File.isNode&&n.getItem(e).submenu.items.forEach(function(e){e.setEnabled(t)})}if(o(r),i&&(i.getItem("Copy as HTML Code").setEnabled(!a),File.isMac?(i.getItem("Image Tools").submenu().getItem("Insert Local Images…").setEnabled(!File.isLocked),i.getItem("Image Tools").submenu().getItem("Upload Local Images via iPic").setEnabled(!File.isLocked&&!a)):i.getItem("Image Tools").submenu.getItem("Insert Local Images…").setEnabled(!File.isLocked),i.getItem("Delete Range").setEnabled(!File.isLocked),i.getItem("Cut").setEnabled(!File.isLocked),File.refreshImageCopyStatus(!1,File.isLocked||a)),t("Paragraph",!File.isLocked&&!a),t("Format",!File.isLocked&&!a),a){var s=File.editor.sourceView.cm.doc.historySize();i.getItem("Undo").setEnabled(!File.isLocked&&s.undo>0),i.getItem("Redo").setEnabled(!File.isLocked&&s.redo>0),File.isNode&&window.ClientCommand.refreshViewMenu()}else i.getItem("Undo").setEnabled(!File.isLocked&&File.editor.undo.hasUndo()),i.getItem("Redo").setEnabled(!File.isLocked&&File.editor.undo.hasRedo()),File.isNode?window.ClientCommand.refreshViewMenu():r.getItem("Always on Top").setEnabled(!0),!File.isLocked&&$(File.editor.sessionStr).trigger("cursorChange");if(e&&File.isNode){var l=c.Menu.getApplicationMenu().getItem("File").submenu,d=l.getItem("Open File Location"),u=l.getItem("Reopen with Encoding");d.visible=!!File.filePath,u.visible=!!File.filePath}}var n,i=null,r=null,a=File.editor.sourceView&&File.editor.sourceView.inSourceMode;if(File.isMac)n=d.menu,i=n.getItem("Edit").submenu(),r=n.getItem("View").submenu();else{if(!File.isNode)return;n=c.Menu.getApplicationMenu(),i=n.getItem("Edit").submenu,r=n.getItem("View").submenu}if(File.isNode)try{t()}catch(e){reqnode("electron").ipcRenderer.send("errorInWindow"," (caught) "+(e?e.stack:e.message))}else t()}};n.exports=p}),define("app/window/FileInfoPanel",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/window/FileHelper","app/editor/EditHelper","app/document/Node","app/editor/KeyMaster"],function(e,t,n){"use strict";function i(e){if(reqnode){var t=reqnode("fs");reqnode("path"),m.getCurrentWindow();if(v&&(v.close(),v.removeAllListeners()),e){File.resumeFileChangeTimestamp=new Date;try{(v=t.watch(e,{persistent:!1})).on("change",function(n,r){File.inSavingProcess&&"rename"==n?i(e):"change"==n||t.existsSync(e)?(File.presentedItemChanged(),"rename"==n&&i(e)):b()})}catch(e){console.log(e)}}}}function r(){$("#file-info-filename-input-area").hide(),$("#file-info-filename").show()}function o(e){var t=m.getCurrentWindow();m.app.getDocumentController().getDocumentFromWindowId(t.id).rename(e),e&&C(e),File.resumeFileChangeTimestamp=new Date}function a(e){var t,n=d.getFileFolderPath(File.filePath)+e;File.fs.existsSync(n)?(t=u.getDialog($.localize.getString("Rename Failed"),$.localize.getString("File or directory with name <i>{0}</i> already exist, please choose another file name","Panel").format(c.escape(e)),!0).modal({backdrop:!1,keyboard:!1})).find(".btn-primary").one("click",function(){$("#quick-dialog").hide()}):((t=u.getDialog($.localize.getString("Confirm"),"Rename file from <i>"+c.escape(File.fileName)+"</i> to <i>"+c.escape(e)+"</i> ?",!0)).modal({backdrop:!1,keyboard:!1}),t.find(".btn-primary").one("click",function(){t.modal("hide"),File.fs.existsSync(n)?m.dialog.showErrorBox("File Exists","File or directory with the given name already exists, please give a different name"):File.fs.rename(File.filePath,n,function(e){e?($("#quick-dialog").hide(),console.log("renamed failed: "+e.message),m.dialog.showErrorBox("Rename Filed","Renaming operation failed due to "+e.message)):(u.showNotification("<i class='fa fa-check'></i> Rename Success ","success"),o(n))})}))}function s(){var e=$("#file-info-filename").hide(),t=$("#file-info-filename-input-area").show(),n=t.children("input"),i=t.children("#file-info-filename-input-ext"),r=e.text(),o=r.substring(0,r.lastIndexOf(".")),a=r.substring(r.lastIndexOf("."));n.val(o).focus(),i.text(a)}var l,c=e("app/document/StringUtils"),d=(e("exoskeleton-master/exoskeleton"),e("app/window/FileHelper")),u=e("app/editor/EditHelper"),h=e("app/editor/KeyMaster").map,p=null,f=null,m=window.reqnode?reqnode("electron").remote:null,g=c.date2NatrualLang,v=null,y=function(e){var t=new Date;return l=c.formateDateOnly(new Date)+" "+(e||"untitled").replace(/\.[^.]*$/,"")+" "+c.formateTimeOnly(t,!0).replace(/:/g,"")+".md"},b=function(){File.getCurrentDocByNode().switchToUntitled()};window.clientHanlderOnPresentationMoved=function(){File.resumeFileChangeTimestamp=new Date,File.filePath=void 0,File.updateChangeCount(File.ChangeType.NSChangeReadOtherContents),i(null)};var w=function(e){window.debugMode&&console.warn(e)},x=function(e){if(l&&e){var t=reqnode("fs"),n=reqnode("path"),i=d.getUnsavedDraftsPath(),r=n.resolve(i,l);t.stat(r,function(o,a){!o&&t.rename(r,n.resolve(i,y(e)),w)})}},C=function(e,t,n){var r=$("#title-text"),o=m.app,a=m.getCurrentWindow(),s=(reqnode("path"),m.Menu.getApplicationMenu().getItem("File").submenu),c=s.getItem("Open File Location"),u=s.getItem("Reopen with Encoding");if(File.fileEncode=void 0,e){c.visible=!0,u.visible=!0,$("#file-info-content").removeClass("file-info-untitled");var n=d.getFileNameFromPath(e);File.filePath=e,File.fileName=n,File.fileEncode=t,o.getDocumentController().hasDuplicateName(n)?(r.text(e),a.setTitle(e+" - Typora")):(r.text(n),a.setTitle(n+" - Typora")),$("#file-info-filename").show().text(n).attr("data-disabled","false"),$("#file-info-file-path").show().find(".file-info-field-value").text(e.substring(0,e.length-n.length)),k(e),i(e),x(n),File.editor.library&&File.editor.library.markCurrentFile()}else $("#file-info-content").addClass("file-info-untitled"),(n=n||File.fileName)?(File.fileName=n,r.text(n),a.setTitle(n+"• - Typora")):(r.text($.localize.getString("Untitled")),a.setTitle($.localize.getString("Untitled")+" - Typora")),File.filePath=void 0,l||y(),c.visible=!1,u.visible=!1;d.refreshTitlebarText()},k=function(e){e=e||File.filePath,File.fs&&e&&File.fs.stat(File.filePath,function(e,t){t&&S(t.mtime)})},S=function(e){if(e=e||p){p=e;var t=c.formateDateTime(e);$("#file-info-last-modified .file-info-field-value").text(t),$("#file-info-last-saved-sub").text("Saved "+g(e))}},T=function(e){var t=File.editor.writingArea.innerText;void 0===e&&(e=u.getWordCount(t)),$("#file-info-field-read-value-word").text(e),$("#file-info-field-read-value-ch").text(t.length),$("#file-info-field-read-value-minutes").text(Math.floor(e/250)+1)};t.watchFileChange=i,t.onPresentationMoved=b,t.setFileTitle=C,t.saveToRecover=function(e){e.trim().length&&-1==(File.filePath||"").indexOf(d.getUnsavedDraftsPath())&&reqnode("fs").writeFile(d.getUnsavedDraftsPath()+"/"+(l||y()),e,"utf8",function(e){e?w(e):x(File.fileName||File.getSuggestedFileName())})},t.prepareInfoPanel=function(){function e(e){$(".info-panel-tab.active").removeClass("active"),"file"==e?(File.editor.library.switch("files",!0),File.option.showFileTree||T()):File.editor.library.switch("outline"),File.isNode&&ClientCommand.refreshViewMenu()}File.option.showFileTree?(document.querySelector("#file-library").style.display="",document.querySelector("#file-info-content").style.display="none"):(document.querySelector("#file-library").style.display="none",document.querySelector("#file-info-content").style.display=""),f||(f=setInterval(function(){S()},3e4)),$("#file-info-save-btn").click(function(){File.saveUseNode()}),$("#info-panel-tab-file").click(function(){e("file")}),$("#info-panel-tab-outline").click(function(){e("outline")}),File.option.showFileTree||$("#info-panel-tab-outline").trigger("click"),$("#file-info-filename").click(function(){"false"==this.getAttribute("data-disabled")&&s()}),$("#file-info-file-path .file-info-field-value").click(function(){$("#typora-sidebar").removeClass("open"),m.shell.showItemInFolder(File.filePath)});var t=$("#file-info-filename-input"),n=$("#file-info-filename-input-ext");t.blur(function(){setTimeout(function(){if($("#file-info-filename-input:visible").length)r();else{var e=(t.val()+n.text()).trim();r(),e!=File.fileName&&a(e)}},50)}).keydown(function(e){var t=h[e.which||e.keyCode];"Esc"==t?r():"Enter"==t&&(r(),$("#file-info-filename-input").trigger("blur"))}).keypress(function(e){var t=String.fromCharCode(e.keyCode);if('\\/:*?"<>|'.indexOf(t)>-1)return!1}),n.click(function(){t.val(t.val()+n.text()).focus(),n.text("")})},t.setLastModified=S,t.updateContentAnalyze=T}),define("app/window/steno2",[],function(e,t,n){"use strict";function i(e){return a.join(a.dirname(e),".~"+a.basename(e))}function r(e){this.file=e,this.callbacks=[],this.nextData=null,this.nextCallbacks=[]}if(window.reqnode){var o=reqnode("fs"),a=reqnode("path"),s={};r.prototype.write=function(e,t){function n(e){for(;this.callbacks.length;)this.callbacks.shift()(e);t(e)}function r(e){for(;this.callbacks.length;)this.callbacks.shift()(e);if(t(),this.lock=!1,this.nextData){var n=this.nextData;this.callbacks=this.nextCallbacks,this.nextData=null,this.nextCallbacks=[],this.write(n,this.callbacks.pop())}}this.lock?(t&&this.nextCallbacks.push(t),this.nextData=e):(this.lock=!0,o.open(this.file,o.constants.O_RDWR,function(t,a){t?n.call(this,t):o.stat(this.file,function(t,s){if(s.size<=e.length)o.write(a,e,r.bind(this));else{o.closeSync(a);var l=i(this.file);o.writeFile(l,e,function(t){o.writeFile(this.file,e,function(e){e?n.call(this,e):o.unlink(l,r.bind(this))}.bind(this))}.bind(this))}}.bind(this))}.bind(this)))},t.writeFile=function(e,t,n){e=a.resolve(e),s[e]=s[e]||new r(e),s[e].write(t,n)},t.writeFileSync=function(e,t){o.writeFileSync(i(e),t),o.renameSync(i(e),e)}}}),define("app/editor/Editor",["app/editor/polyfill","jquery/jquery","app/document/StringUtils","exoskeleton-master/exoskeleton","app/document/Node","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji","app/document/Node2Mark","app/document/Node2HTML","app/document/NodeOperation","app/editor/Diagram","codemirror/lib/codemirror","rangy/rangy-core","app/editor/Fences","autoComplete","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint","app/editor/MathBlock","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","app/editor/MathInline","rangy/rangy-classapplier","app/editor/Brush","app/editor/Stylize","app/window/MenuHelper","app/editor/polyfill","app/editor/Selection","app/editor/EditHelper","app/editor/TableEdit","app/editor/ImageEdit","app/editor/UserOp","app/editor/TableEdit","app/editor/ConvertUtils","app/editor/DeleteOp","app/window/FileHelper","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp","app/editor/Selection","app/editor/UndoManager","app/editor/KeyMaster","app/editor/UserOp","app/window/FileInfoPanel","app/document/File","app/window/steno2","app/editor/DocMenu","app/editor/Stylize","app/editor/SearchPanel","app/editor/Emoji","app/editor/Word","app/document/Export","app/document/Node2Native","app/editor/SourceView","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","app/editor/QuickOpenPanel","app/window/Library","app/editor/FileTree","app/editor/FileList"],function(e,t,n){"use strict";e("app/editor/polyfill");var i=e("jquery/jquery"),r=e("app/document/StringUtils"),o=e("exoskeleton-master/exoskeleton"),a=e("app/document/Node"),s=a.Node,l=a.TYPE,c=e("app/document/MarkParser"),d=(e("app/document/Node2Mark"),e("app/document/Node2HTML"),e("app/document/NodeOperation"),e("app/editor/Fences")),u=e("app/editor/MathBlock"),h=e("app/editor/MathInline"),p=e("app/editor/Brush"),f=e("app/editor/Selection"),m=f.rangy,g=e("app/editor/EditHelper"),v=e("app/editor/TableEdit"),y=e("app/editor/ImageEdit"),b=e("app/editor/UndoManager"),w=b.SnapFlag,x=e("app/editor/KeyMaster"),C=x.map,k=e("app/editor/UserOp"),S=e("app/window/FileInfoPanel"),T=e("app/document/File"),E=e("app/editor/DocMenu"),F=e("app/editor/Stylize"),_=e("app/editor/SearchPanel"),M=e("app/editor/Emoji"),N=e("app/editor/Word"),L=e("app/document/Export"),A=e("app/editor/SourceView"),R=e("app/window/FileHelper"),I=e("app/editor/QuickOpenPanel"),P=e("app/window/Library"),O=window.reqnode?reqnode("electron").remote:null;!function(){var e=i.fn.replaceWith;i.fn.oldReplaceWith=e,i.fn.replaceWith=function(t){var n=this.parent().closest("li");e.apply(this,arguments),n.length&&(n.css("margin","0.1px"),n.css("margin",""))}}();var D,B,j=180,H=0,$=null,U=o.Model.extend({constructor:function(e,t){this.sessionStr=e,this.EditHelper=g,this.MarkParser=c,t.setTheme(),t.setEditor(this),this.nodeMap=new a.NodeMap,this.writingArea=document.querySelector(this.sessionStr),t.readOption();var n=void 0,r=t.getDocumentSnap();this.imgEdit=new y(this),this.docMenu=new E(this),this.undo=new b(this),t.option.showFileTree&&(r||{}).nodeMap?(t.isNode&&S.setFileTitle(t.getFilePathUseNode(),r.fileEncode),t.restoreEditStateFromData(r,!1,!0)):(n=t.getContent(),this.reset(n)),this.library=new P(this),this.library.init(),this._bindGlobal(),this._bindKeyEvents(),this._bindMouseEvents(),this.focusCid=null,this.selection=new f(this),this.keypressMsg="",this.mathInline=new h(this),this.brush=new p(this),this.tableEdit=new v(this),this.fences=new d(this),this.mathBlock=new u(this),this.stylize=new F(this);var o=this;setTimeout(function(){o.refresh(),o.selection.unlockScroll()},500),this.brush.run(),this.UserOp=k,this.searchPanel=new _(this),this.writingArea.setAttribute("contenteditable","true"),this.writingArea.focus(),this.sourceView=new A(this),void 0!=n&&n.trim().length?(this.selection.lockScroll(),this.selection.jumpIntoElemEnd(i("[cid]").last())):(document.querySelector(this.sessionStr+">*:first-child").classList.add("md-focus"),this.selection.jumpTop()),this.emoji=new M(this),this.word=new N(this),this.export=new L(this),(t.isMac||t.isNode)&&setTimeout(t.bindMenu,200),t.freshLock(),this.quickOpenPanel=new I(this),this.quickOpenPanel.init(),this.dropTargetDom=null,this.strollingBySelect=!1},reset:function(e){var t=new a.Node({type:a.TYPE.raw_edit,in:this.nodeMap,attachTo:this.nodeMap,text:e});this.writingArea.innerHTML=t.parseFrom({skips:{old_code:!1}})[0],this.lastCursor=null,T._needsUpdateSnap=!0},quickRefresh:function(){this.refresh(!1,!0)},refresh:function(e,t){var n=T.isActiveWindow();this.sourceView&&this.sourceView.inSourceMode?e&&this.sourceView.cm.refresh():this.brush&&(i(this.writingArea).find(".md-mathjax-panel").length||(this.mathBlock.currentCm=void 0),t||(this.nodeMap.toc.refresh(!0),this.docMenu.resizeFooter()),this.fences.modeLoaded&&this.fences.refreshEditor(void 0,e),this.diagrams.modeLoaded&&this.diagrams.refreshDiagram(e),this.mathBlock.renderAll(),this.mathInline.renderAll(),n&&(this.brush&&this.stylize&&(this.brush.expand(),this.brush.updateWordCount(),T.isNode&&T.refreshImageCopyStatus(!0)),i("#typora-table-row-tracker, #typora-table-col-tracker").hide()))},getJQueryElem:function(e){return e?i(e.nodeType==e.ELEMENT_NODE?e:e.parentNode):i()},getMarkElem:function(e){if(!e&&document.activeElement.nodeType==window.Node.ELEMENT_NODE&&(document.activeElement.hasAttribute("tabindex")||s.isType(document.activeElement.tagName,"TEXTAREA","INPUT")))return i(document.activeElement).closest("[cid]");if(!(e=e||window.getSelection().anchorNode||document.activeElement))return[];var t=i(e.nodeType==e.ELEMENT_NODE?e:e.parentNode);return!t.length||"TH"!==t[0].tagName&&"TD"!==t[0].tagName||(t=t.children(".td-span")),r.isNullOrEmpty(t.attr("cid"))&&(t=t.closest("[cid]")),t},autoRemoveUnholdable:function(e){var t=this.focusCid&&this.findElemById(this.focusCid).closest(".unholdable");if(t&&t.length)try{var n=this.findNodeByElem(t).getClosetParagraphLevel(),e=e||b.makeEmptyCommand(this.selection.buildUndo());t.text().length||t.children(".md-line").length>1?t.removeClass("unholdable"):(this.undo.UndoManager.addUndoForRemove(e,n),e.redo.push(this.selection.buildUndo()),n.remove(),t.remove(),this.undo.register(e),this.focusCid=null)}catch(e){console.warn(e.stack)}},store:function(e,t){if((!this.sourceView||!this.sourceView.inSourceMode)&&(e=e||this.focusCid)){var n=e.id?e:this.nodeMap.get("allNodes").get(e);if(n){var i=this.findElemById(n.id);if(i.length>0){var r=i.textExcludeSVG(!0);return s.isType(n,n.TYPE.meta_block)?(r=r.replace(/\n$/,""),n.set("text",r)):s.isType(n,n.TYPE.math_block)?this.mathBlock.syncToNode(n):s.isType(n,n.TYPE.def_footnote,n.TYPE.def_link)?(s.reverseAttrFromElem(n,i),!t&&this.docMenu.resizeFooter()):n&&!i[0].querySelector("[cid]")?n.get("type")==n.TYPE.fences&&i.find(".CodeMirror-code").length?this.fences.syncToNode(n):(n.set("text",r),n.clearChildren()):t&&n.get("children").map(function(e){i[0].querySelector("[cid='"+e.cid+"']")?this.store(e):e.remove()},this),s.isType(n,n.TYPE.meta_block)&&!t&&this.imgEdit.updateLocalRootUrl(),n}this.focusCid=null}}},cleanTooltip:function(){i(this.sessionStr).find(".md-tooltip-hide").hide(),K(),this.mathBlock.stopEditing()},refocus:function(e,t,n,r){if(!this.sourceView||!this.sourceView.inSourceMode){var o,a,l=e?this.findElemById(e):this.getMarkElem(),c=this,d=this.nodeMap.allNodes.get(this.focusCid),u=c.findElemById(this.focusCid);if(c.docMenu.autoHideOutline(),e=void 0===e?l.attr("cid"):e,t&&e&&c.store(e),this.focusCid!=e||!l.hasClass("md-focus")){if(this.focusCid!=e&&(c.findElemById(c.focusCid).trigger("blur").trigger("losefocus").find(".md-tooltip-hide").hide(),K(),s.isType(d,s.TYPE.paragraph)&&d.unset("depth")),i(document.activeElement).trigger("focus"),l.addClass("md-focus").trigger("refocus"),this.focusCid==e)return;if(this.undo.noStashedUndo()&&(a=this.undo.completeSnap(!0,!0),this.store(this.focusCid),this.lastCursor&&this.lastCursor.startId==this.lastCursor.endId&&(this.lastCursor.id=this.lastCursor.startId),a&&this.lastCursor&&this.focusCid==this.lastCursor.id&&(a.redo.push(this.lastCursor),c.undo.register(a,!0),a=null)),T.option.expandSimpleBlock&&(this.focusCid=k.simpleExpand(this,e))?("block"==document.querySelector("#md-searchpanel").style.display&&this.searchPanel.closePanel(),e=this.focusCid):this.focusCid=e,T.isLocked)return;this.focusCid&&d&&!(i.contains(u,l)||i.contains(l,u)||l.length&&l.is(u))&&(d.clearEmptyChar(),(o=this.simpleParse(d,r))&&(o[0].undo[0]=c.lastCursor,setTimeout(function(){o[0].redo.push(c.selection.buildUndo()),c.findElemById(o[2]).replaceWith(o[1]),a&&(b.append(a,o[0]),o[0]=a),c.undo.noStashedUndo()?c.undo.register(o[0],!0):c.undo.stashUndo(o[0]),c.quickRefresh(),c.selection.scrollAdjust(),c.undo.exeCommand(o[0].redo.last())},50))),!o&&a&&this.undo.register(a,!0),this.docMenu.highlightVisibleHeader(),this.focusCid&&this.brush.focusContainer(l)}return c.isIME=0,n||this.brush.expandOnDelay(),e}},_bindGlobal:function(){function e(){T.isNodeHtml||(x("command+z, ctrl+z",function(e){if(T.isLocked)return!1;d.writingArea.contains(e.target)&&d.undo.undo(e)}),x("command+y, ctrl+y",function(e){if(T.isLocked)return!1;d.writingArea.contains(e.target)&&d.undo.redo(e)})),x("command+l, ctrl+l",function(e){e.preventDefault(),d.selection.selectLine()}),x("command+d, ctrl+d",function(e){e.preventDefault(),d.selection.selectWord()}),x("command+e, ctrl+e",function(e){e.preventDefault(),d.selection.selectPhrase()}),x("command+b, ctrl+b",function(e){if(T.isLocked)return!1;e.preventDefault(),d.stylize.toggleStyle(a.TYPE.strong)}),x("command+i, ctrl+i",function(e){if(T.isLocked)return!1;e.preventDefault(),d.stylize.toggleStyle(a.TYPE.em)}),x("command+u, ctrl+u",function(e){if(T.isLocked)return!1;e.preventDefault(),d.stylize.toggleStyle(a.TYPE.underline)}),x("command+a, ctrl+a",function(e){T.editor.sourceView.inSourceMode||!i(document.activeElement).closest("#write").length||(e.preventDefault(),T.editor.selection.selectAll(),T.editor.brush.expand())}),x("shift+command+d, shift+ctrl+d",function(e){if(T.isLocked)return!1;e.preventDefault(),d.selection.selectWord(),k.backspaceHandler(d,null,"delSelection")})}function t(){x("ctrl+b",function(e){if(T.isLocked)return!1;e.preventDefault(),d.stylize.toggleStyle(a.TYPE.strong)}),x("ctrl+i",function(e){if(T.isLocked)return!1;e.preventDefault(),d.stylize.toggleStyle(a.TYPE.em)}),x("ctrl+u",function(e){if(T.isLocked)return!1;e.preventDefault(),d.stylize.toggleStyle(a.TYPE.underline)}),x("ctrl+a",function(e){e.preventDefault(),T.isNode&&ClientCommand.selectAll()})}function n(e){if(window.app){if(app.document.isLocked())return}else if(T.isLocked)return!1;d.sourceView.inSourceMode||d.imgEdit.doInsertFromURL(e)}function o(){i(".md-table-edit").length&&d.tableEdit.resizeTableEdit(i(".md-table-edit")),i(".typora-table-tracker").hide(),d.setTypeWriterMode(T.isTypeWriterMode,!0),c=null}var c,d=this;x("command+=",function(e){var t=d.getMarkElem(),n=t.attr("mdtype");s.isType(n,l.heading,l.line)&&d.stylize.changeHeadingLevel(d.findNodeByElem(t),!0),e.preventDefault(),e.stopPropagation()}),x("command+-",function(e){var t=d.getMarkElem(),n=t.attr("mdtype");s.isType(n,l.heading,l.line)&&d.stylize.changeHeadingLevel(d.findNodeByElem(t),!1),e.preventDefault(),e.stopPropagation()}),T.isNodeHtml?(x("ctrl+home",function(e){T.editor.selection.jumpTop()}),x("ctrl+end",function(e){T.editor.selection.jumpBottom()}),x("ctrl+z, command+z",function(e){if(d.writingArea.contains(e.target))return ClientCommand.undo(),!1}),x("ctrl+y, command+y, command+shift+z, ctrl+shift+z",function(e){if(d.writingArea.contains(e.target))return ClientCommand.redo(),!1}),t()):(x("ctrl+k",function(e){var t=d.selection.getRangy();if(t&&!s.isType(document.activeElement.tagName,"INPUT","TEXTAREA")){if(t.collapsed){var n=d.getMarkElem();t.setEnd(n[0],n[0].childNodes.length),d.selection.setRange(t)}t.toString().length?k.backspaceHandler(d,e,"delSelection"):k.backspaceHandler(d,e,!0),e.preventDefault(),e.stopPropagation()}}),x("command+left, command+right, shift+command+left, shift+command+right",function(e){d.brush.expandOnDelay(!0)}),x("command+up, command+down",function(e){d.refocus()}),x("ctrl+h",function(e){d.selection.getRangy()&&!s.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&k.backspaceHandler(d,e,"Backspace")}),x("ctrl+d",function(e){d.selection.getRangy()&&!s.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&k.backspaceHandler(d,e,"Delete")}),x("ctrl+tab",function(e){T.isMac&&app.window.selectNextTab()}),x("ctrl+shift+tab",function(e){T.isMac&&app.window.selectPreviousTab()}),x("command+y",function(e){if(T.isLocked)return!1;d.undo.completeSnap(!0),T.editor.undo.redo(e),T.freshMenu()})),T.isMac||T.isNode||e(),i(document).on("dragover",function(e){e.originalEvent.dataTransfer.dropEffect="none"}).on("drop",function(e){if(T.isMac)return!1;var t,i=e.originalEvent.dataTransfer.getData("text/html"),o=e.originalEvent.dataTransfer.files,a=e.originalEvent.dataTransfer.items;if(i){if(T.isLocked)return!1;k.pasteHandler(d,i)}else if(o&&o.length&&T.isNodeHtml)for(var s=0;s<a.length;s++){var l,c=a[s].webkitGetAsEntry(),u=o[s],h=O.getCurrentWindow();if(c.isFile){if(l=u.path.match(/(?:^|\.)([^.]+)$/)){if(l=(l[1]||"").toLowerCase(),~["latex","ltx","tex","wiki","dokuwiki","docx","rst","rest","org","textile","opml"].indexOf(l)){!function(e){if(ClientCommand.validatePandocInstall())if(!t&&T.changeCounter.isDiscardableUntitled())t=!0,window.getSelection().removeAllRanges(),ClientCommand.doImport(e);else{var n=O.app.openFile();n.webContents.once("did-finish-load",function(){n.webContents.executeJavaScript('setTimeout(function(){window.getSelection().removeAllRanges();ClientCommand.doImport("'+r.escapeInQuote(e)+'")}, 200)')})}}(u.path);continue}if(~R.allowedExtensions.indexOf(l)){O.app.openFile(u.path,{curWindow:h});continue}}}else c.isDirectory&&(T.filePath||T.getMountFolder()?O.app.openFolder(u.path):O.app.switchFolder(u.path,h));if(T.isLocked)return!1;s>0&&d.UserOp.insertParagraph(!1,d),n(u.path)}e.stopPropagation(),e.preventDefault()}).on("dragfile",function(e){try{if(window.app&&app.document.isLocked())return!1;if(T.isLocked&&!T.isMac)return!1;var t,i=e.originalEvent.data.urls,r=e.originalEvent.data.folders;r.length?(r.map(function(e){app.controller.openFolder(e)}),T.getMountFolder()&&T.editor.library.showSidebar("files")):i.map(function(e,i){if((t=e.match(/(?:^|\.)([^.]+)$/))&&(t=t[1],~["txt","text","latex","ltx","tex","wiki","dokuwiki","docx","rst","rest","org","textile","opml","md","mmd","markdown","mdown","multimarkdown",""].indexOf(t)))return app.app.openInTypora(e),!1;i>0&&d.UserOp.insertParagraph(!1,d),n(e)})}catch(e){}}).on("paste",this.sessionStr,function(e){if(T.isLocked)return!1;if(!d.sourceView.inSourceMode)return k.pasteHandler(d,e.originalEvent,T._PasteContentFlag)}).on("pasteAsPlainText",this.sessionStr,function(e){if(T.isLocked)return!1;{if(!d.sourceView.inSourceMode)return k.pasteHandler(d,e.originalEvent,!0);T.isMac&&app.window.pasteAsPlainText()}}).on("copy",this.sessionStr,function(e){s.isType(document.activeElement.tagName,"INPUT","TEXTAREA")||(d.refocus(void 0,!0),k.copyHandler(d,e.originalEvent))}).on("cut",this.sessionStr,function(e){return!T.isLocked&&(!!s.isType(document.activeElement.tagName,"INPUT","TEXTAREA")||(T.isNode?(T._CopyContentFlag="cut_before",O.getCurrentWindow().webContents.copy(),!1):(d.refocus(void 0,!0),d.snapSelection=d.selection.buildUndo(),k.copyHandler(d,e.originalEvent),void k.backspaceHandler(d,e,"delSelection"))))}).on("contextmenu",this.sessionStr,function(e){var t,n=i(e.target);if(!n.closest(".CodeMirror")[0]){if(s.isType(d.getMarkElem(e.target).attr("mdtype"),F.CONST.Selectable)||(t=d.selection.getRangy())&&""==t.toString()&&(t.collapse(!0),t.select(t.isBackward)),"IMG"===e.target.tagName&&0==n.closest(".md-image.md-expand").length){var r=n.closest(".md-image").addClass("md-expand"),o=r.children(".md-meta")[0].length;(t=m.createRange()).moveToBookmark({containerNode:r.children(".md-meta")[0],start:o-1,end:o-1}),d.selection.setRange(t)}T.isNodeHtml&&T.contextMenu.show(e)}}).on("inline-input",function(e){d.selection.scrollAdjust(),d.tableEdit.unfocusAll(!0)}).on("click","#md-notification .undo-btn",function(){d.undo.undo(),i("#md-notification").fadeOut()}).on("click","#md-notification .ok-btn",function(){i("#md-notification").fadeOut()}).on("focus","body",function(){return!1}).on("click",g.resetClick),i(window).on("resize",function(){T.suppressResize||(c&&clearTimeout(c),c=setTimeout(o,300))}).on("mouseup",function(){d.stopScrolling(),d.brush.updateWordCountInSelection()}),T.isMac&&(i("#top-hotpot").on("mouseenter",function(e){1==e.which&&d.startScrolling(!0)}),i("#bottom-hotpot").on("mouseenter",function(e){1==e.which&&d.startScrolling(!1)}),i("#top-hotpot").on("mouseleave",function(e){d.stopScrolling()}),i("#bottom-hotpot").on("mouseleave",function(e){e.screenY+4>window.innerHeight||d.stopScrolling()}),app.window.isFullScreen()&&i("#top-hotpot, #bottom-hotpot").show()),i(d.sessionStr).on("change","[type='checkbox']",function(){var e=this.parentElement.getAttribute("cid"),t=this.checked;t?this.setAttribute("checked","checked"):this.removeAttribute("checked"),d.getNode(e).attr("checked",t,d,!1)}),document.addEventListener("selectionchange",function(e){var t;T.isNodeHtml&&(t=d.selection.getRangy(),i("svg.in-text-selection").attr("class",""),t&&t.getNodes([1],function(e){"svg"===e.tagName&&e.classList.add("in-text-selection")})),T.isFocusMode&&J.call(d)},!1)},_bindKeyEvents:function(){function e(e){e?i("a, .md-def-url, .md-url").css("cursor","pointer"):i("a, .md-def-url, .md-url").css("cursor","")}var t,n,r=this,o=!1,a=!1,l=!1;r.isIME=0;var c;i(document.body).on("keydown",function(e){if(r.docMenu.autoHideOutline(),document.body.classList.remove("show-word-count"),document.activeElement==document.body){var t=e.keyCode||e.which;i(r.sessionStr).focus(),"Delete"!=C[t]&&"Backspace"!=C[t]&&"Enter"!=C[t]||(e.originalEvent!=c&&(e.target=r.writingArea,c=e.originalEvent,i(r.sessionStr).trigger(e)),e.preventDefault())}if(T.isNodeHtml&&T.contextMenu.handleKeyEvent(e))return!1}),i(r.sessionStr).on("keydown",function(t){c=t.originalEvent,r.keypressMsg=null;var n=t.keyCode||t.which,a="TEXTAREA"==t.target.tagName||"INPUT"==t.target.tagName;if(229!=n){if(T.isNodeHtml&&T.contextMenu.handleKeyEvent(t))return!1;if(document.body.classList.contains("megamenu-opened"))"Esc"===C[n]&&T.megaMenu.hide();else{if(i(".dropdown-menu.open:not(#typora-sidebar), .dropdown-menu.show").removeClass("open").removeClass("show"),"Ctrl"!=C[n]&&"Command"!=C[n]||e(!0),s.isType(C[n],"Right","Left","Up","Down")){if(i(".context-menu:visible").length&&r.contextmenu.handleArrowKey(C[n]),"INPUT"==t.target.tagName&&t.target.classList.contains("mode")&&!t.ctrlKey&&!t.metaKey){if("Left"==C[n]&&0==t.target.selectionStart&&0==t.target.selectionEnd)return r.selection.moveUpOrDown(!0,t,!0),!1;if("Right"==C[n]&&t.target.selectionStart==t.target.selectionEnd&&t.target.selectionEnd==t.target.value.length)return r.selection.moveUpOrDown(!1,t,!0),!1}if(a&&s.isType(C[n],"Right","Left"))return;if(T.isLocked)return!0;if(t.ctrlKey||t.metaKey){if(T.isMac&&t.metaKey&&("Up"==C[n]||"Down"==C[n]))return"Up"==C[n]?r.selection.jumpTop(t.shiftKey):r.selection.jumpBottom(t.shiftKey),!1;if(t.target.classList&&t.target.classList.contains("md-def-name")&&"Right"===C[n])return r.selection.jumpIntoElemEnd(i(t.target).closest("[mdtype]")),!1}if(T.isMac&&t.metaKey){var d={};i.extend(d,t),d.type="keyup",setTimeout(function(){i(t.target).trigger(d)},10)}t.shiftKey&&i(".md-focus .md-math-after-sym").text("​"),"Right"==C[n]||"Left"==C[n]?(r.lastCursor=r.selection.buildUndo(),r.brush.isAutoCompleteShown()&&r.brush.triggerAutoComplete(),!t.shiftKey&&r.selection.moveLeftOrRight("Left"==C[n],t)):"Up"!=C[n]&&"Down"!=C[n]||(r.lastCursor=r.selection.buildUndo(),r.brush.isAutoCompleteShown()?t.shiftKey?r.brush.hideAutoComplete():r.brush.changeAutoCompleteSelection("Up"==C[n],t):!t.shiftKey&&r.selection.moveUpOrDown("Up"==C[n],t))}if(!a){if("Esc"==C[n]){if(i("#table-insert-dialog:visible").modal("hide").length)return void i(T.editor.sessionStr).trigger("cursorChange");r.brush.triggerAutoComplete(!0),t.preventDefault()}else if("Tab"==C[n]){if(t.metaKey||t.ctrlKey||t.altKey)return;if(t.preventDefault(),!(t.shiftKey?k.lessIndent(r):k.moreIndent(r))){(p=r.getMarkElem()).hasClass("md-def-link");if(p.closest(".md-table").length)r.tableEdit.moveToNextCell(!0,t.shiftKey);else if(p.hasClass("md-def-link")||p.hasClass("md-def-footnote")){var u=r.getJQueryElem(window.getSelection().anchorNode).closest("span[contenteditable]");t.shiftKey?r.selection.selectAllElem(i(u.prevAll("span[contenteditable='true']")[0])):r.selection.selectAllElem(i(u.nextAll("span[contenteditable='true']")[0]))}else t.shiftKey||(r.selection.prepNode("\t",t),k.insertInlineText(r,null,"\t",r.selection.getOffset(p),null,!0),r.refocus(),r.brush.addToQueue(r.focusCid))}}else if("Backspace"==C[n]||"Delete"==C[n]){if(T.isNodeHtml){var h=!0;l?t.preventDefault():(l=!0,t.ctrlKey&&(r.selection.getRangy()||{}).collapsed?k.backspaceHandler(r,t,C[n]):h=k.backspaceHandler(r,t,C[n],!1,!0),null===h?(l=!1,r.undo.snap(r.focusCid||r.getMarkElem().attr("cid"),w.DELETE),r.brush.addToQueue(r.focusCid)):(t.preventDefault(),setTimeout(function(){l=!1},20)))}else{if(t.metaKey){var p=r.getMarkElem(window.getSelection().commonAncestorContainer);p.hasClass("md-expand");p.addClass("md-expand"),window.getSelection().modify("extend","backward","lineboundary")}k.backspaceHandler(r,t,C[n])}t.stopPropagation()}else if("Enter"==C[n]){if(i(".auto-suggest-container:visible .active").length)return r.brush.applyAutocompleteByKey(),void t.preventDefault();z.call(r,t.metaKey||t.ctrlKey,t.shiftKey),t.preventDefault(),t.stopPropagation()}o&&n==this.lastKey&&[224,17,91,93].indexOf(n)>-1&&this.lastKeyTime&&performance.now()-this.lastKeyTime<300?(t.preventDefault(),r.refocus(void 0,!0),this.lastKey=0):(this.lastKey=t.keyCode,this.lastKeyTime=performance.now()),o=!1}}}}).on("keypress",function(e){var t=e.keyCode||e.which;if(T.isLocked&&e.charCode>0)return e.ctrlKey||e.metaKey;var n=r.findNodeByElem(r.getMarkElem());if("TEXTAREA"!=e.target.tagName&&"INPUT"!=e.target.tagName&&!x.isCommand(e)){if(!n||n.canNotDirectEdit())return e.preventDefault();if("Enter"==C[t])e.preventDefault();else if(e.charCode>0&&window.getSelection().rangeCount){r.lastKeyPressOn=new Date,r.selection.prepNode(String.fromCharCode(e.charCode),e);var i=r.getMarkElem().attr("cid");i!=r.focusCid&&r.refocus(i),r.brush.addToQueue(r.focusCid)}}}).on("keyup",function(t){o=!0;var n=t.keyCode||t.which;"CTRL"!=C[n]&&"Command"!=C[n]||e(!1),"TEXTAREA"!=t.target.tagName&&"INPUT"!=t.target.tagName&&("Right"==C[n]||"Left"==C[n]||"Up"==C[n]||"Down"==C[n]?!(a=t.shiftKey)&&!r.isIME&&!t.metaKey&&r.refocus():a&&"Shift"==C[n]?(a=!1,!r.isIME&&!t.metaKey&&r.refocus()):"Enter"==C[n]&&function(){var e=i("#write .md-focus");2==e.length&&e.get(0).getAttribute("cid")===e.get(1).getAttribute("cid")?(i(e.get(1)).remove(),r.selection.jumpIntoElemEnd(i(e.get(0))),z.call(r,T.isMacOrMacNode?t.metaKey:t.ctrlKey,t.shiftKey)):e.next("div:not('[mdtype]')").remove().length&&z.call(r,T.isMacOrMacNode?t.metaKey:t.ctrlKey,t.shiftKey)}())}).on("compositionend",function(e){if("TEXTAREA"!=event.target.tagName&&"INPUT"!=event.target.tagName){var t=r.getMarkElem();r.focusCid=r.getMarkElem().attr("cid"),r.brush.addToQueue(r.focusCid),r.isIME=0,setTimeout(function(){t.trigger("inline-input"),r.writingArea.setAttribute("contenteditable","true"),r.brush.brushQueue()},0)}}).on("compositionstart",function(e){if("TEXTAREA"!=event.target.tagName&&"INPUT"!=event.target.tagName&&(r.isIME=1,r.selection.prepNode("",e,void 0,!0),T.isMac)){r.writingArea.setAttribute("contenteditable","false");var t=i(".md-focus");if(t.find("[cid]").length){var n=r.selection.getRangy();i(n.startContainer).closest("[cid]").attr("contenteditable","true")}else t.attr("contenteditable","true")}}).on("input",function(e){function i(e){r.syncChange([{type:"sync",id:e,html:r.findElemById(e).html()}])}s.isType(e.target.tagName,"INPUT","TEXTAREA")||r.focusCid&&(t&&(clearTimeout(t),t=null),n&&r.focusCid!=n&&i(n),n=r.focusCid,t=setTimeout(function(){i(n),n=null,t=null},200))})},tryOpenLink:function(e,t){if(t&&(e=D),e.length){var n=e.attr("href"),r=i.localize.getString("Need to define the reference link <b>[{0}]</b> with syntax <b>[{1}]: www.example.com</b>");if(this.undo.completeSnap(!0),e[0].hasAttribute("data-ref")){var o=e.data("ref");if(void 0===(n=this.nodeMap.link_list.getHrefByRef(o,!0)))return g.showNotification(r.format(o,o),"warning"),!T.isLocked&&this.docMenu.addEmptyDef(o,a.TYPE.def_link),!1;if(""===n)return g.showNotification(r.format(o,o),"warning"),!1}n&&this.tryOpenUrl_(n)}},tryOpenUrl_:function(e){var t=e;if(e.match(/^#/)){var n=g.findAnchorElem(e);this.selection.jumpIntoElemBegin(n),this.selection.scrollAdjust(n,10)}else{if(!e.match(/:\/\//)){if(e=e.replace(/([#?][^.]+)$/,""),T.isMac&&window.app.path.openURL(decodeURI(e),(R.getCurrentFileFolderPath()||"")+"/"))return;if(T.isNode){var i=reqnode("fs-plus"),r=reqnode("path").resolve(R.getCurrentFileFolderPath()+"/",decodeURI(e));if(i.isFileSync(r))return void O.shell.openItem(r);if(i.isFileSync(r+".md"))return void O.shell.openItem(r+".md");if(i.isFileSync(r+".markdown"))return void O.shell.openItem(r+".markdown")}e=/^[A-Za-z.+-]+:/.exec(t)?t:"http://"+t}T.isNode?reqnode("electron").shell.openExternal(e):window.open(e)}},_bindMouseEvents:function(){function e(e){var n=i(e.target).closest("[md-inline='image'],[md-inline='imgtag']");if(n.length){if("image"==n.attr("md-inline")){var r=i(e.target).closest(".md-content");if(r.length){var o=t.selection.getRangy(),a=r.text(),s=a.indexOf("]")+2;if(o.startOffset>s)return o.setStart(r[0].childNodes[0],s),o.setEnd(r[0].childNodes[0],a.length-1),o.select(o.isBackward),!0;if(o.startOffset>=2&&o.endOffset>o.startOffset&&o.endOffset<s-1)return o.setStart(r[0].childNodes[0],2),o.setEnd(r[0].childNodes[0],s-2),o.select(o.isBackward),!0}return t.selection.selectAllElem(n),!0}if("IMG"==e.target.tagName)return t.selection.selectAllElem(n),!0}}var t=this,n=!1;i(this.sessionStr).on("mouseover",'.footnotes, [mdtype="table"], .task-list-item, .md-inline-math',function(e){1==e.which&&i(this).attr("contenteditable",!0).find(".md-math-after-sym").text("​")}).on("mouseenter",'[mdtype="heading"], [mdtype="paragraph"]',function(e){1==e.which&&i(this).find(".md-math-after-sym").text("​")}).on("mousedown",function(e){n=!1;var r=document.body.classList;r.remove("show-word-count"),T.isNode&&r.contains("typora-fullscreen")&&r.contains("native-window")&&O.getCurrentWindow().setMenuBarVisibility(!1);var o=i(e.target);if(i(".dropdown-menu.open:not(#typora-sidebar), .dropdown-menu.show").removeClass("open").removeClass("show"),o.closest("a").length&&!o.closest("img").length&&(T.isMacOrMacNode?e.metaKey:e.ctrlKey))return e.stopPropagation(),e.preventDefault(),!1;o.closest(".md-fences:not(.CodeMirror)").length||T.isMac||3!==e.which||i(e.target).closest("[md-inline]").addClass("md-expand"),t.lastCursor=t.selection.buildUndo(),t.isMousePressed=1===e.which}).on("click","[md-inline='link']>.md-content, .md-def-url",function(e){if(e.ctrlKey||e.metaKey)return t.tryOpenUrl_(i(this).text()),!1}).on("contextmenu",function(e){document.activeElement.hasAttribute&&document.activeElement.hasAttribute("tabindex")&&document.activeElement.hasAttribute("mdtype")&&window.getSelection().removeAllRanges(),D=i(e.target).closest("a")}).on("mousemove",function(e){n=!0}).on("click",function(e){if(3==(e.originalEvent||e).detail)return t.selection.selectLine(),!1;var n=t.getMarkElem(e.target);if(t.docMenu.autoHideOutline(),t.brush.isAutoCompleteShown()&&t.brush.triggerAutoComplete(),t.searchPanel.isOpen()&&t.searchPanel.closePanel(!0),"INPUT"!==e.target.tagName||"checkbox"!==e.target.getAttribute("type")){if("TEXTAREA"===e.target.tagName||"INPUT"===e.target.tagName||e.target.classList&&e.target.classList.contains("code-tooltip"))return e.preventDefault(),void i(e.target).trigger("focus");if(n.hasClass("md-fences")&&t.fences.clickEventHandled.call(t.fences,e,n.attr("cid")))return!1;if(i(e.target).closest("a").length){if(e.stopPropagation(),e.preventDefault(),(T.isMacOrMacNode?e.metaKey:e.ctrlKey)||T.isLocked)return t.tryOpenLink(i(e.target).closest("a")),!1;var r=i(e.target).closest(".md-image"),o=r.closest('[md-inline="link"]');(o.length?o:r).addClass("md-expand")}var l=t.findNodeByElem(n);s.isType(l,a.TYPE.paragraph,a.TYPE.heading)&&i(".md-tooltip-remove").remove();var c=t.selection.getRangy();return c&&c.commonAncestorContainer==t.writingArea&&!c.collapsed?(e.stopPropagation(),!1):void 0}}).on("dblclick",function(n){if(e(n),T.isMac&&!/\S\s+\S/.exec(window.getSelection().toString()))return t.selection.selectWord(!1,!0),!1}).on("mouseup",function(e){function r(){T.isTypeWriterMode&&T.option.scrollWithCursor?t.selection.typeWriterScroll(null,null,function(){t.refocus(u)}):t.refocus(u)}function o(){t.isMousePressed?$=setTimeout(o,j):(H=0,r())}if(t.isMousePressed=!1,!s.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&!T.isLocked){i('.footnotes, [mdtype="table"], .task-list-item').attr("contenteditable",!1);var a=t.selection.getRangy();a&&!a.collapsed&&s.isType(a.commonAncestorContainer.tagName,"LI","UL","QUOTEBLOCK","ARTICLE")&&t.refocus(null);var c=a?a.commonAncestorContainer:e.target;if(c==t.writingArea||t.writingArea.contains(c)){var d=t.getMarkElem(e.target),u=d.length&&!d.find("[cid]").length?d.attr("cid"):void 0;if(d.closest(".md-fences:not(.CodeMirror)").length&&t.fences.focus(d.attr("cid")),!d.length&&e.target==document.querySelector(t.sessionStr)&&(!n||!a||a.collapsed))try{var h=t.nodeMap.getLast(),p=t.findElemById(h.cid);if(e.pageY-p.offset().top-p.height()>0){if(s.isType(h,l.paragraph,l.heading))t.selection.jumpIntoElemEnd(t.findElemById(h.getVeryFirst(!0).cid)),d=p;else{var f=b.makeEmptyCommand(t.selection.buildUndo()),m=t.selection.addUnholdable(h,f),g=t.findElemById(m.cid);t.undo.register(f),t.selection.jumpIntoElemBegin(g),d=g}t.refocus(),e.stopPropagation()}}catch(e){}try{clearTimeout($),"BODY"==document.activeElement.tagName?H=0:window.getSelection().toString().length?(H=0,r()):1===H?(H=0,r()):0===H&&($=setTimeout(o,j),H++),function(){if(!(d=i(t.writingArea).find(".unholdable")).length||d.find("[cid='"+t.focusCid+"']").andSelf("[cid='"+t.focusCid+"']").length);else if(d.text().length||d.children(".md-line").length>1)d.removeClass("unholdable");else{var e=b.makeEmptyCommand(t.selection.buildUndo()),n=t.findNodeByElem(d).getClosetParagraphLevel();t.undo.UndoManager.addUndoForRemove(e,n),e.redo.push(t.selection.buildUndo()),n.remove(),d.remove(),t.undo.register(e)}}()}catch(e){console.warn(e.stack)}T.isLocked||t.writingArea.setAttribute("contenteditable","true")}}});document.querySelector("content").addEventListener("wheel",function(e){Math.abs(e.deltaY)<4||T.isFocusMode&&T.isTypeWriterMode&&setTimeout(G.bind(t),100)},!!T.option.passiveEvents&&{passive:!0}),i("content").on("scroll",function(e){if(T.preventScroll)return!1;1==e.buttons&&T.isFocusMode&&T.isTypeWriterMode&&setTimeout(G.bind(t),100),i(".auto-suggest-container, .autoComplt-list").hide()}).on("click",function(e){function n(t,n){var i=document.createEvent("MouseEvents");i.initMouseEvent("mousedown",!0,!0,t.ownerDocument.defaultView,1,e.screenX,e.screenY+n,e.clientX,e.clientY+n,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button),t.dispatchEvent(i)}function r(n,i){i?t.selection.jumpIntoElemEnd(n):t.selection.jumpIntoElemBegin(n),e.preventDefault(),e.stopPropagation()}if(e.target==this||e.target==t.writingArea){if(t.selection.getRangy())return;for(var o,a=window.innerHeight,s=document.querySelector("#write > *").getBoundingClientRect(),l=e.pageX>s.right-2,c=e.pageX<s.left+2,d=Math.min(s.right-2,Math.max(e.pageX,s.left+2)),u=e.pageY;u<a;u+=20)if(!(o=i(document.elementFromPoint(d,u))).find("[mdtype]").length&&o.closest("[mdtype]").andSelf("[mdtype]").length)return T.isNodeHtml?r(o,l):n(o[0],u-e.pageY),void t.refocus(o.attr("cid"));for(u=e.pageY;u>0;u-=20)if(!(o=i(document.elementFromPoint(d,u))).find("[mdtype]").length&&o.closest("[mdtype]").andSelf("[mdtype]").length)return T.isNodeHtml?r(o,!c):n(o[0],u-e.pageY),void t.refocus(o.attr("cid"))}})},simpleParse:function(e,t){var n=e.get("type")==l.line;if(e.get("type")==l.raw_edit||n&&/(^[`~>#|\-+*1-9=\[])|\n\s*\S/g.test(e.safeGetStrAttr("text"))){this.brush.pause();var i,r,o=this.undo.UndoManager.makeEmptyCommand(),a=e.getClosetParagraphLevel();return o.undo.push(this.selection.buildUndo()),o.undo.push(b.buildReplaceUndo(a)),i=e.parseFrom(t?{skips:{enableStartMatch:!0}}:void 0),(n=n&&1===i[1].length)&&s.isType(e,l.line)?(this.brush.restart(),null):(n?(i=e.separateBlockFromLine(),r="",o.redo.push(b.buildReplaceUndo(i[1])),i[0]&&(r+=i[0].toHTML(),b.addUndoForInsert(o,i[0])),r+=i[1].toHTML(),i[2]&&(r+=i[2].toHTML(),b.addUndoForInsert(o,i[2]))):(o.redo.push(this.undo.buildReplaceUndo(i[1][0])),b.addUndoForInsertArray(o,i[1].slice(1)),r=i[0]),this.brush.restart(),[o,r,a.cid])}},findElemById:function(e){return e?i("[cid='"+e+"']"):i()},findNodeByElem:function(e){return e.length?this.nodeMap.get("allNodes").get(e.attr("cid")):null},beforeInsertTextFromCandidate:function(e){var t=!1,n={preventDefault:function(){t=!0}};return this.selection.prepNode(e,n),!t},replaceText:function(e,t,n,r,o){function a(){this.undo.snap(p,w.REPLACE,void 0,!0),m=e.length-g.toString().length,g.deleteContents(),g.insertNode(document.createTextNode(e)),f.start+=m,f.end+=m,v.moveToBookmark(f),this.selection.setRange(v),this.brush.addToQueue(p)}function l(e){this.selection.deRange(e);var t=i(e.startContainer).closest(".md-meta"),n=i(e.endContainer).closest(".md-meta");e.collapsed||!t.length&&!n.length||y>3||t[0]!=n[0]&&(t.length&&e.setStartAfter(t[0]),n.length&&e.setEndBefore(n[0]),y++,l.call(this,e))}if(this.sourceView.inSourceMode||this.isIME||!this.writingArea.contains(document.activeElement)||s.isType(document.activeElement.tagName,"INPUT","TEXTAREA"))return!0;var c,d,u,h,p,f,m,g=this.selection.rangy.createRange(),v=this.selection.getRangy(),y=0;if(g.setStart(t,n),g.setEnd(r,o),e.match(/\n/))return k.pasteHandler(this,e,!0),!1;if(!v.collapsed)return!0;if(u=this.getJQueryElem(g.commonAncestorContainer),h=u.closest("[cid]"),!(p=h.attr("cid")))return!1;if(f=v.getBookmark(h[0]),g.collapsed){var b;return 1!=e.length||!(b=this.UserOp.hanldePair(this,e,this.getNode(p),f,void 0,g))||(this.undo.register(b),!1)}return!u.closest("code, script").length&&(g.commonAncestorContainer==v.commonAncestorContainer&&v.startOffset-g.endOffset>=0&&v.startOffset-g.endOffset<=2||v.equals(g)?(a.call(this),!1):((d=this.selection.rangy.createRange()).setEnd(v.startContainer,v.startOffset),d.setStart(g.endContainer,g.endOffset),(c=d.toString()).length&&c.replace(/[*_\s\]]/g,"").length<2&&(l.call(this,g),a.call(this)),!1))},getMarkdown:function(e){if(this.sourceView.inSourceMode)return this.sourceView.cm.getValue();var t=this.nodeMap.toMark();return e?t.replace(/\n+$/,""):t},getNode:function(e,t){return t&&!(e=e||this.focusCid)&&(e=this.refocus()),this.nodeMap.get("allNodes").get(e)},restoreLastCursor:function(e,t){if(e&&e.preventDefault(),this.lastCursor){if(document.activeElement!=this.writingArea){var n=i("content").scrollTop();this.writingArea.focus(),i("content").scrollTop(n)}this.undo.exeCommand(this.lastCursor,t?[]:void 0)}},toggleFocusMode:function(){T.isFocusMode?(T.isFocusMode=!1,G.call(this)):(T.isFocusMode=!0,J.call(this)),T.isNode?window.ClientCommand.refreshViewMenu():T.isMac&&app.menu.getItem("View").submenu().getItem("Focus Mode").setState(T.isFocusMode)},updateFocusMode:function(e){e?J.call(this):G.call(this)},setTypeWriterMode:function(e,t){if(T.isTypeWriterMode!=e||t){T.isTypeWriterMode=e;var n=this;if(e){document.body.classList.add("on-typewriter-mode");var r=document.querySelector("content").clientHeight,o=(i("content"),(r-n.defaultTextHeight)/2);document.querySelector("#write-style").innerHTML="#write { \npadding-top: $1px;\npadding-bottom: 0;\n}\n#write:after {\nheight: $2px;\n}".replace(/\$1/g,o-n.defaultTextHeight).replace(/\$2/g,o+n.defaultTextHeight),T.editor.sourceView&&T.editor.sourceView.inSourceMode||n.selection.typeWriterScroll(null,null)}else t||(document.querySelector("#write-style").innerHTML=0,document.body.classList.remove("on-typewriter-mode"),n.selection.scrollAdjust());T.editor.sourceView.enableTypeWriterMode(e),t||(T.isNode?window.ClientCommand.refreshViewMenu():T.isMac&&app.menu.getItem("View").submenu().getItem("Typewriter Mode").setState(T.isTypeWriterMode))}},toggleTypeWriterMode:function(e){void 0===e&&(e=!T.isTypeWriterMode),this.setTypeWriterMode(e)},syncFullContent:function(){var e=T.editor.sourceView.inSourceMode;T.isMac?app.controller.syncFullContent(e):T.isNode&&T.isActiveWindow()&&T.getCurrentDocByNode().syncFullContent(e)},applyFullContent:function(e){if(!T.isActiveWindow()){var t=T.isMac?app.document.content:T.getCurrentDocByNode().content;if(void 0===t)return;this.undo.exeCommand({type:"sync",content:t,fromSourceMode:e},void 0,!0),this.refresh()}},syncChange:function(e){function t(e,t){return e.map(function(e){return e?"fences"==e.type?null:e:null},t)}if(T.isMac)app.controller.shouldTriggerSyncChange()&&(W(),app.document.syncChange(JSON.stringify(t(e,this))));else if(T.isNode){var n=T.getCurrentDocByNode();T.shouldTriggerSyncChange()&&(W(),n.syncChange(JSON.stringify(t(e,this))))}},applyChange:function(e){if(e&&!T.isActiveWindow()){var t=JSON.parse(e),n=!1;window.debugMode&&function(e){e&&("sync"!=e.type?e.type:void 0!==e.html||(void 0!==e.allHtml||(void 0!==e.cmChanges||(void 0!==e.tex||(void 0!==e.srcChanges||e.content)))))}(t[0]),t.forEach(function(e){n=this.undo.exeCommand(e,void 0,!0)||n},this),n&&this.refresh()}},startScrolling:function(e){this.strollingBySelect=!0;var t=i("content"),n=t[0].scrollHeight-window.innerHeight,r=e?0:n;t.stop(!0).animate({scrollTop:r},Math.abs(r-t.scrollTop())/256*1e3,"linear")},stopScrolling:function(){this.strollingBySelect&&(i("content").stop(!0),this.strollingBySelect=!1)}}),q=function(){editor.syncFullContent(),B=null},W=function(){B&&clearTimeout(B),B=setTimeout(q,500)};U.prototype.scheduleFullContentSync=W;var z=function(e,t){this.brush.pause(),this.brush.hideAutoComplete(),this.undo.completeSnap(!0);var n=this.getMarkElem();if(this.brush.brushNode(n.attr("cid")),n=this.getMarkElem(),s.isType(n.attr("mdtype"),a.TYPE.fences,a.TYPE.footnote))return!0;r=o=k.backspaceHandler(this,null,"delSelection",!0,!1);var i,r,o,c=(n=this.getMarkElem()).closest(".md-table").length,d=c,u=this,h=n.attr("cid"),p=this.store(h);if(T.isTypeWriterMode&&this.selection.lockScroll(),function(i){if(n.attr("mdtype")==a.TYPE.meta_block)try{var r=i.selection.getRangy();return!(!e&&!t&&r.collapsed&&r.endContainer.textContent.replace(/\n$/,"").length<=r.endOffset&&r.endContainer.textContent.match(/\n{2,}$/g))}catch(e){return!0}return!1}(this))(r=r||b.makeEmptyCommand()).undo.push(this.selection.buildUndo()),k.insertInlineText(this,null,"\n",this.selection.getOffset(n),r,!0),this.undo.register(r),this.brush.addToQueue(h);else if(function(e){var t=e.getNode(h);if(s.isType(t,l.def_link,l.def_footnote)&&s.isEmptyBlock(t))return!0}(this))r=this.UserOp.backToParagraph(u,this.getNode(h),!0,!1),o&&(r=b.append(o,r)),this.undo.register(r);else if(c)this.tableEdit.moveToNextCell(!0);else if(!d)if(r=this.selection.prepNode("​",null,!0))o&&(r=b.append(o,r)),this.undo.register(r);else if(p&&(i=p.breakOn(e,this,t))){var f=this.findElemById(i.oldCid),m=f.parent("ol");u.findNodeByElem(m);f.replaceWith(i.newHtml),s.isType(this.getNode(i.nextFocus),a.TYPE.math_block)?(i.command.redo.push({type:"fences-pos",id:i.nextFocus,pos:{line:0,ch:0}}),setTimeout(function(){u.mathBlock.startEditing(i.nextFocus)},0)):(this.selection.jumpIntoElemBegin(this.findElemById(i.nextFocus)),i.command.redo.push(this.selection.buildUndo())),this.focusCid=this.refocus(i.nextFocus,void 0,void 0,!0),this.findElemById(i.nextFocus).addClass("md-focus"),o&&(i.command=b.append(o,i.command)),this.undo.register(i.command),this.quickRefresh()}return!(i&&i.nextFocus)&&this.refocus(),this.brush.resume(),this.selection.scrollAdjust(),!0};U.prototype.pressReturn=z;var V,K=function(){i(".md-tooltip-remove").remove(),i(".md-focus").removeClass("md-focus"),i(".md-focus-container").removeClass("md-focus-container"),document.body.classList.remove("show-word-count")},Y=!1,J=function(){V&&(clearTimeout(V),V=null),Y||(Y=!0,document.body.classList.add("on-focus-mode"))},G=function(){Y&&(Y=!1,document.body.classList.remove("on-focus-mode"))};n.exports=U}),define("app/document/MarkParser",["app/document/StringUtils","app/document/Node","exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/editor/Inline","app/document/Node","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji"],function(e,t,n){"use strict";function i(e,t,n){var i,o,a=[],s=0;if(!t){if(!(o=K.exec(e)))return null;e=o[1]}if(e=e.replace(/(^|[^\\])((`+)([\s\S]*?[^`])\3(?!`))/g,function(e,t,n){return a.push(n),s++,[t,"",s-1,""].join("")}),File.option.enableInlineMath&&(e=e.replace(/(^|[^\\])((\$+)([\s\S]*?[^$])\3(?!\$))/g,function(e,t,n){return a.push(n),s++,[t,"",s-1,""].join("")})),e=e.replace(/\\\\/g,oe.ESCAPE_ESCAPE).replace(/\\\|/g,oe.ESCAPE_VLINE).replace(/\\\ /g,oe.ESCAPE_SPACE),i=e.split(G),t&&i.length<=1)return null;if(i.length<n&&File.option.enableInlineMath){var l=(e=e.replace(/\uE07A(\d+)\uE07B/g,function(e,t){return a[t-0]})).split(G);l.length==n&&(i=l)}return i.map(function(e){return r(e.replace(/\uE022/g,"\\ ").replace(/\uE07A(\d+)\uE07B/g,function(e,t){return a[t-0]}))})}function r(e){return e?e.replace(new RegExp(oe.ESCAPE_ESCAPE,"g"),"\\\\").replace(new RegExp(oe.ESCAPE_VLINE,"g"),"\\|"):e}function o(e,t){function n(e){if(v.isType(this.cur,y.paragraph)&&1==this.cur._lines.length&&this.cur._lines[0].match(_))return o.call(this,this.cur),this.cur=null,e.set("ahead",1),!0}function r(e){var t=this.lines[this.ln+1];if(void 0!==t&&t.match(_))return this.ln++,e.set("tail",1),!0;void 0!==t&&e.set("tail",0)}function o(e){this.blocks.remove(e),e.remove()}function a(e,t){var n=e=e||this.cur;this.oldNode&&!this.blocks.length?(v.isType(e,y.paragraph)&&v.isType(this.oldNode,y.line)?(e.set("type",y.line),e.set("text",e.getText())):e.giveChildrenTo(this.oldNode),this.oldNode.copyContentFrom(e),e._lines&&(this.oldNode._lines=e._lines),e.remove(),this.blocks.push(v.isType(this.oldNode,y.line)?this.oldNode.get("parent"):this.oldNode),n=this.oldNode):(this.parent?this.parent.append(e):this.blocks.length?this.blocks.last().insert(e):(console.error("parse error"),e.set("parent",this.parent),e.set("in",this.nodeMap),e.set("attachTo",this.nodeMap)),this.blocks.push(e)),this.cur=t?n:null}function s(e,t){this.cur&&(!v.isType(this.cur,y.paragraph)||this.cur._lines.length?(f.onClose&&f.onClose.call(this,t),t||void 0!=this.cur.get("tail")||this.cur.set("tail",0),a.call(this,this.cur,e)):this.cur=null)}function l(e,t,i){var r=new v({type:y.list,style:e,in:this.nodeMap,pattern:t});e==v.ListType.ol?r.set("start",i):r._mark=i,n.call(this,r),s.call(this),this.cur=r}function c(t){var n=t?J:Y;if(r=i(e,t)){var r,o,a,s=this.ln+1,l=this.lines.length,c=this.lines[s],d=[];if(s<l&&this.lines[s].match(n))for(s++;s<l&&(a=this.lines[s],o=null,o=i(a,t,r.length));s++)d.push(o);if(d.length)return c=t?c.split(G):c.replace(/^ *\||\| *$/g,"").split(G),u.call(this,r,c,d,s-1),!0}return!1}function d(e){p=new v({type:y.toc,in:this.nodeMap,pattern:e}),n.call(this,p),r.call(this,p),s.call(this,!0),a.call(this,p)}function u(e,t,i,o){function l(e,t){var n,i=new v({type:y.table_row,parent:e,in:e.get("in"),header:!c,before:c});for(h=0;h<u;h++)n=new v({type:y.table_cell,parent:i,in:i.get("in"),before:n,text:(t[h]||"").trim()});return i}var c,d=new v({type:y.table,in:this.nodeMap}),u=e.length;t=t||new Array(e.length),i=i||[[]];for(var h=0;h<u;h++)t[h]=t[h]||"",t[h].match(/^ *-+: *$/)?t[h]="right":t[h].match(/^ *:-+: *$/)?t[h]="center":t[h].match(/^ *:-+ *$/)?t[h]="left":t[h]=null;d.set("align",t),c=l.call(this,d,e),i.forEach(function(e){c=l.call(this,d,e)},this),n.call(this,d),s.call(this),o&&(this.ln=o),r.call(this,d),a.call(this,d),this.cur=null}var h,p,f;if(this.cur){f=te[this.cur.get("type")];var g=!t&&f.shouldClose.call(this,e);if(g>0||t){if(s.call(this,!1,t),2==g)return}else if(!g)return void(f.onContinue&&f.onContinue.call(this,e))}if(!t)if(this.skips.old_code||!(h=D.exec(e))){if((h=A.exec(e))&&v.isType(this.cur,y.paragraph)&&!m.isNullOrBlank(this.cur._lines.last()))return p=new v({type:y.heading,depth:"="==h[1]?1:2,text:this.cur._lines.pop(),pattern:"{0}\n"+e,in:this.nodeMap}),n.call(this,p),s.call(this),r.call(this,p),void a.call(this,p);if(e.match(R)){if(h=M.exec(e))return p=new v({type:y.blockquote,in:this.nodeMap,pattern:h[1]}),n.call(this,p),p._lines=[h[2]],p._indent=h[1].replace(/[ \u00A0]*>/,"").length,s.call(this),void(this.cur=p);if(h=(File.option.strictMarkdown?L:N).exec(e))return p=new v({type:y.heading,depth:h[2].length,text:h[3],pattern:(this.skips.enableStartMatch?h[1].replace(/#$/,"# "):h[1])+"{0}"+h[4],in:this.nodeMap}),n.call(this,p),r.call(this,p),s.call(this),void a.call(this,p);if(this.skips.enableMetaBlock&&0==this.ln&&e.match(z)){var b=this.ln+1,w=this.lines.length;if(!(x=this.skips.enableStartMatch||!1))for(;b<w;b++)if(this.lines[b].match(z)){x=b>this.ln+1;break}if(x)return p=new v({type:y.meta_block,in:this.nodeMap,text:this.lines.slice(this.ln+1,b).join("\n")}),n.call(this,p),this.ln=b,r.call(this,p),s.call(this,!0),void a.call(this,p)}if(h=j.exec(e))return p=new v({type:y.hr,pattern:e.trim(),in:this.nodeMap}),n.call(this,p),r.call(this,p),s.call(this,!0),void a.call(this,p);if(h=C.tasklist.exec(e))return l.call(this,v.ListType.task,h[2],h[3]),void(f=te[y.list]).onContinue.call(this,e,h[0].replace(/\t/,"  ").replace(/^\s+$/,"").length,h[1].length);if(h=C.ul.exec(e))return U.exec(this.lines[this.ln+1]||"")?(d.call(this,e+"\n"+this.lines[this.ln+1]),void this.ln++):(l.call(this,v.ListType.ul,h[2],h[3]),void(f=te[y.list]).onContinue.call(this,e,h[0].replace(/\t/,"  ").replace(/^\s+$/,"").length,h[1].length));if(h=C.ol.exec(e))return l.call(this,v.ListType.ol,h[0].replace(/\d+/,"{0}"),h[0].match(/\d+/)[0].replace(/^1$/,"")),void(f=te[y.list]).onContinue.call(this,e,h[0].replace(/\t/,"  ").replace(/^\s+$/,"").length,h[1].length);if((h=e.match(O))&&!this.skips.math_block){var b=this.ln+1,w=this.lines.length,x=this.skips.enableStartMatch||!1;if(!x)for(;b<w;b++)if(this.lines[b].match(O)){x=!0;break}if(x)return p=new v({type:y.math_block,in:this.nodeMap,text:this.lines.slice(this.ln+1,b).join("\n")}),n.call(this,p),this.ln=b,r.call(this,p),s.call(this,!0),void a.call(this,p)}if(h=I.exec(e))return p=new v({type:y.fences,lang:h[3],pattern:h[1]+"{0}",in:this.nodeMap}),p._mark=h[2],p._lines=[],n.call(this,p),s.call(this),void(this.cur=p);if(e.match(H))return void d.call(this);if(e.match($))return void d.call(this,e);if(c.call(this,!1))return;if(this.skips.enableStartMatch&&(h=V.exec(e))){var k=i(e,!1);if(k&&k.length>1)return void u.call(this,k)}if(h=W.exec(e))return p=new v({type:y.def_footnote,ref:h[1],text:h[2],in:this.nodeMap}),n.call(this,p),r.call(this,p),s.call(this,!0),void a.call(this,p);if(h=q.exec(e))return p=new v({type:y.def_link,ref:h[1],href:h[3],title:h[7],in:this.nodeMap,pattern:"[;]:"+h[2]+";"+h[4]+(h[5]?";"+h[6]:"")}),n.call(this,p),r.call(this,p),s.call(this,!0),void a.call(this,p)}else if(c.call(this,!0))return;this.cur||(this.cur=new v({type:y.paragraph,in:this.nodeMap}),this.cur._lines=[]),v.isType(this.cur,y.paragraph)?this.cur._lines.push(e):f&&f.onContinue&&f.onContinue.call(this,e)}else v.isType(this.cur,y.code)&&f?f.onContinue&&f.onContinue.call(this,e):(p=new v({type:y.code,pattern:h[1],in:this.nodeMap}),n.call(this,p),p._lines=[h[2]],s.call(this),this.cur=p)}function a(e,t,n){this.options=e||u({},he.defaults),this.options.decorate=t||b.decorate,this.options.context=n||this,this.rules=re.normal,this.options.gfm?this.options.breaks?this.rules=re.breaks:this.rules=re.gfm:this.options.pedantic&&(this.rules=re.pedantic),File.option.enableHighlight&&(this.rules.escape2=/^[\uE013\uE014\uE015\uE018\uE020]/)}function s(e,t){for(var n,i=/([a-z0-9])_([a-z0-9])/gi;n=i.exec(e);)e=e.substring(0,n.index+1)+oe.UNDER_CHAR+e.substring(n.index+2),i.lastIndex&&i.lastIndex--;return e=e.replace(/\\[\*_=\]\\]/gi,function(e){return le[e]||e}),t&&e.length<2e4&&(e=e.replace(/((?:(https?:\/\/[\w-+.\/~?%&=:#\uE006]+)|((mailto:\/{0,2})?[a-z0-9][a-z0-9\-_+\.\uE006]*(@)[a-z0-9][a-z0-9\-_\uE006]*\.(com|co|net|org|edu|io|tv|fm|me|info|cc|ca|de|cn|ru)(\.[a-z0-9][a-z0-9\-_\uE006]+)?)|(www\.[a-z0-9][a-z0-9\-_\uE006]*(\.[a-z0-9\-_\uE006]+)+(\/[\w-.\/~?%&=:#\uE006]*)?)))/gi,oe.URL_START+"$1"+oe.URL_END)),e}function l(e){return e.replace(/[\uE006-\uE020]/g,function(e){return ae[e]?"\\"+ae[e]:se[e]||""})}function c(e,t){return e=e.source,t=t||"",function n(i,r){return i?(r=r.source||r,r=r.replace(/(^|[^\[])\^/g,"$1"),e=e.replace(i,r),n):new RegExp(e,t)}}function d(){}function u(e){for(var t,n,i=1;i<arguments.length;i++){t=arguments[i];for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}function h(e,t,n,i,r){function o(e,t,n){return new v({type:n||y.paragraph,text:e,parent:t,in:t.get("in")})}function a(n,i,r){d+=n.length,e=e.substring(d),r.cid==t.editor.focusCid&&t.editor.store(),t.editor.undo.completeSnap(!0),i.undo.push(w.buildReplaceUndo(r.getClosetParagraphLevel()))}function s(n,i,r,o){var a,s="";return o=o||h(e,t,n,!1,i),v.isType(r,y.list,y.blockquote)&&v.isType(r.get("parent"),y.paragraph)?(r=(a=r.separateBlockFromLine())[1],i.redo.push(w.buildReplaceUndo(r)),a[0]&&w.addUndoForInsert(i,a[0]),a[2]&&w.addUndoForInsert(i,a[2]),s=(a[0]&&a[0].toHTML()||"")+r.toHTML(o.html)+(a[2]&&a[2].toHTML()||"")):(i.redo.push(w.buildReplaceUndo(r)),s=r.toHTML(o.html)),{html:s,offset:d+o.offset,focus:o.focus,blockChanged:!0,command:i,splits:a}}function l(i,r,l){var c,d,p,f=File.option.indentSize;if(a(i,r,n),n.set("type",y.list),n.set("text",""),n.set("style",l),(d=o("",n,y.list_item)).set("checked",null!=/x|X/g.exec(i)),u=o(e,d,y.paragraph),l==v.ListType.ul&&n.set("pattern",i.trim()+" ".repeat(f-1)),l==v.ListType.ol){var m=i.match(/\d+/)[0].replace(/^1$/,"");""!=m?n.set("start",m):n.unset("start")}(p=h(e,t,u,!1)).html=d.toHTML(p.html),c=s(null,r,n,p);var g=(n=c.splits&&c.splits[1]||n).get("before"),b=n.get("after");return c.splits&&!c.splits[0]&&v.isType(g,y.list)&&g.get("style")==n.get("style")&&(c.replaceCid=g.cid,c.toRemove=[n.cid],r.undo.push(w.buildReplaceUndo(g)),w.addUndoForRemove(r,n),g.appendTillEnd(n.getFirstChild()),g.getFirstChild().unset("tail"),g.getFirstChild().getLastChild().unset("tail"),n.remove(),v.isType(b,y.list)&&b.get("style")==b.get("style")&&(c.toRemove.push(b.cid),w.addUndoForRemove(r,b),g.appendTillEnd(b.getFirstChild()),g.getFirstChild().unset("tail"),g.getFirstChild().getLastChild().unset("tail"),b.remove()),r.redo.push(w.buildReplaceUndo(g)),c.html=g.toHTML(),c.splits[2]&&(c.html+=c.splits[2].toHTML())),c}var c,d=0,u=n,p=[];if(r=r||!i&&w.makeEmptyCommand(),!i){if(/^ *>[^\n]+/.exec(e))return function(t){return a(e.match(/^ *>[ \u00A0]?/)[0],t,n),n.set("type",y.blockquote),n.set("text",""),u=o(e,n),t.redo.push(w.buildReplaceUndo(n)),s(u,t,n)}(r);if(c=/^( *)[*+-][ \t\u00A0]+(\[(x|X)\]|\[ \]) +/.exec(e))return l(c[0],r,v.ListType.task);if(c=/^( *)[*+-][ \t\u00A0]+/.exec(e))return l(c[0],r,v.ListType.ul);if(c=/^( *)\d+\.[ \t\u00A0]+/.exec(e))return l(c[0],r,v.ListType.ol);if(c=function(e,t){var n=e.get("parent"),i=n&&n.get("parent");return v.isType(e,y.line)&&!e.get("before")&&n&&v.isType(n,y.paragraph)&&!n.get("before")&&i&&v.isType(i,y.list_item)&&!i.get("before")&&!i.get("after")&&i.get("parent").get("style")==v.ListType.ul&&/(^ *\[(x|X)\]( |\t)+)|((^ *\[ \]) +)/g.exec(t)}(n,e))return function(i,r){var o,l,c=n.get("parent").get("parent"),d=c.get("parent");return a(i,r,d),d.set("style",v.ListType.task),c.set("checked",null!=/x|X/g.exec(i)),n.set("text",e),u=n,l=h(e,t,u,!0,r),l.html=c.toHTML(),o=s(null,r,d,l),o.replaceCid=d.cid,o}(c[0],r);if(v.isType(n,y.paragraph))return function(t){return u=o(e,n,y.line),s(u,t,n)}(r)}var m=[],g={innerHtml:f(e,t.inline,v.isType(n,y.heading),n,p,m),offset:0,focus:n.cid,blockChanged:!1,command:r,cursorDiff:p,mdlike:m[0]};return g.html=n&&n.toHTML(g.innerHtml,m[0]),g}function p(e,t){if(v.isType(e,y.line)){var n=[],i=f(e.safeGetStrAttr("text"),t.inline,!1,e,[],n);return e.toHTML(i,n[0])}if(e.get("children").length){for(var r=e.getFirstChild(),o=[];r;)o.push(p(r,t)),r=r.get("after");return e.toHTML(o.join(""))}return e.toHTML()}function f(e,t,n,i,r,o){for(var a=[],s="";e;){if(!n){if(a=/^ *>[^\n]+/.exec(e)){e=e.substring(a[0].length),s+=t.options.decorate({type:y.blockquote,pattern:a[0].match(/^( *> ?)+/gm)[0],inner:f(a[0].replace(/^( *> ?)+/gm,""),t,!0,null,r)});continue}if(a=(File.option.strictMarkdown?ue:de).exec(e)){e=e.substring(a[0].length);var l=a[1].length;s+=t.options.decorate({type:y.heading,meta_before:a[0].substring(0,l),meta_after:a[3],inner:t.output(a[2],null,null,null,{attr:!1},r)}),o&&o.push("h"+a[0].match(/#/g).length);continue}if(a=I.exec(e)){e=e.substring(a[0].length),s+=t.options.decorate({type:y.fences,lang:a[3],pattern:a[1]});continue}if(a=W.exec(e)){e=e.substring(a[0].length),s+=t.options.decorate({type:y.def_footnote,ref:a[1],inner:t.output(a[2]||"",null,null,null,null,r)});continue}if(a=/^\s*\[([^\]]+)\]:\s+([^\n]*)/.exec(e)){e=e.substring(a[0].length),s+=t.options.decorate({type:y.def_link,ref:a[1],inner:t.output(a[2]||"",null,null,null,null,r)});continue}}if(a=/(^[^\n]+(\n){0,1})/g.exec(e))e=e.substring(a[0].length),s+=t.options.decorate({type:y.paragraph,inner:t.output(a[0],null,null,null,{attr:!v.isType(i,y.heading)},r)});else if(a=/^\s*\n\s*/.exec(e))e=e.substring(a[0].length),s+=a[0];else if(e.length)break}return s}var m=e("app/document/StringUtils"),g=e("app/document/Node"),v=g.Node,y=g.TYPE,b=e("app/editor/Inline"),w=e("app/editor/UndoManager"),x=e("app/editor/Emoji"),C={ul:/^(\s*)(([-+*])\s+)/,ol:/^(\s*)\d+\.\s+/,tasklist:/^(\s*)(([-+*])\s*)\[((x|X)| )\]\s+/},k=/^(\s*)([-+*>\[]|\d+\.)\s+/,S=/^(\s*)[^\s]/,T={ul:/^(\s*)([-+*])\s+/,ol:/^(\s*)(\d+\.)\s+/,tasklist:/^(\s*)([-+*]\s*\[((x|X)| )\])\s+/},E=/\r\n|\r|\n|\u2424/,F=/^[ \u00A0]{0,3}$/,_=/^[\s\u00A0]*$/,M=/(^\s{0,3}> *)(.*)$/,N=/(^\s*(#{1,6})\s*)([^\n]+?)(\s*#*\s*)$/,L=/(^\s*(#{1,6})\s+)([^\n]+?)(\s*#*\s*)$/,A=/^ *(=|-){2,}[\s\u00A0]*$/,R=/^\s*[-+*_<\[\{|#0-9`~=>$]/,I=/^( *(`{3,}|~{3,})[ \t\u00A0]*)([^\n`]+)? *$/,P=/^\s*(`{3,}|~{3,})\s*$/,O=/^\s*\${2}\s*$/,D=/^( {4}|\t)(\s*\S.*)$/,B=/^( {4}|\t)/,j=/^\s*([-+_*])\s*\1\s*\1(\s|\1)*$/,H=/^\s*\[toc\]\s*$/i,$=/^\s*\{:toc\}\s*$/i,U=/^\s?\{:\s*toc(\s*|(\s+.*))\}/,q=/^\s*\[([^\]]+)\]:(\s*<?)([^\s>]+)(>?)((\s+)["'(]([^\n]*)["')])?\s*$/,W=/^\s*\[\^([^\]]+)\]:\s*([^\n]*)$/,z=/^-{3}$/,V=/^ *\|([^\|]+\|.+)\|\s*$/,K=/^\s*\|(.+)\|\s*$/,Y=/^ *\|(\s*[-:]+\s*\|[-| :]*)$/,J=/^ *([-:]+\s*\|[-| :]*)$/,G=/ *\| */,Q={},X={},Z={},ee="  ",te={paragraph:{shouldClose:function(e){return e.match(F)?(this.cur.set("tail",1),2):-1},onClose:function(e){this.cur._lines.length>1&&this.cur._lines[0].match(_)&&(this.cur.set("ahead",1),this.cur._lines.shift()),!this.cur._lines.length&&this.cur._lines.push(""),this.cur._lines.forEach(function(e){this.cur.append(new v({type:y.line,text:e}))},this),this.cur._lines=void 0,this.cur.set("text","")},onContinue:function(e){this.cur._lines.push(e)}},blockquote:{shouldClose:function(e){return e.trim().length?e.match(M)?0:-1:(this.cur.set("tail",1),2)},onClose:function(e){new ie(this.cur._lines,this.cur,null,null,this.skips),this.cur._lines=void 0,this.cur.unset("text")},onContinue:function(e){Q[this.cur._indent]||(Q[this.cur._indent]=new RegExp("^[  ]{0,3}> {0,"+(this.cur._indent||0)+"}")),this.cur._lines.push(e.replace(Q[this.cur._indent],""))}},list:{shouldClose:function(e){var t,n=this.cur.getLastChild();return X[n._indent]||(X[n._indent]=new RegExp("^ {"+n._indent+",}|\\t")),e.match(X[n._indent])?0:e.match(_)?(this.cur.set("tail",(this.cur.get("tail")||0)+1),this.cur.get("tail")>1?2:0):(t=C[this.cur.get("style")].exec(e))?this.cur.get("style")!=v.ListType.ol?t[3]==this.cur._mark?0:1:0:this.lines[this.ln-1].match(_)?1:-1},onClose:function(){for(var e=this.cur.getLastChild(),t=this.cur.get("tail")||0;t>0;)!e._lines.last().trim().length&&e._lines.pop(),t--;new ie(e._lines,e,null,null,this.skips),e._lines=void 0,e._indent=void 0,e._indentDecided=void 0,e.unset("text"),this.cur._mark=void 0,this.cur.unset("text")},onContinue:function(e,t,n){var i,r=this.cur.getLastChild(),o=t,t=File.option.strictMarkdown?t-n:2,a=this.cur.get("style"),s=0;if(n=n||(r?r.get("prespace"):0)||0,e.match(_)||this.cur.unset("tail"),!r)return a==v.ListType.ol&&(s=/^\s*(\d+)\.\s+/.exec(e)[1].length-1),r=new v({type:y.list_item,prespace:n,markindent:o-s-n}),this.cur.append(r),r._indent=t+n,r._numLength=s,r._lines=[e.replace(C[a],"")],void(a==v.ListType.task&&r.set("checked",!!C.tasklist.exec(e)[5]));r._numLength=r._numLength||0,X[r._indent]||(X[r._indent]=new RegExp("^ {"+r._indent+",}|\\t"));var l=e.match(X[r._indent]),c=0;if(Z[r._indent]||(Z[r._indent]=new RegExp("^ {2,"+r._indent+"}|\\t")),c=(e.match(Z[r._indent])||[""])[0].length,e=l?e.replace(Z[r._indent],""):e,!l&&(i=T[a].exec(e)))return n=i[1].length,t=i[0].replace(/\t/g,ee).length,o=t,t=File.option.strictMarkdown?t-n:2,r._lines.length>1&&r._lines.last().match(_)?(r._lines.pop(),r.set("tail",1)):r.set("tail",0),this.cur.unset("tail"),new ie(r._lines,r,null,null,this.skips),r._lines=void 0,r._indent=void 0,r.unset("text"),a==v.ListType.ol&&(s=/^\s*(\d+)\.\s+/.exec(e)[1].length-1),r=new v({type:y.list_item,prespace:n,markindent:o-s-n}),r._numLength=s,a==v.ListType.task&&r.set("checked",!!i[3].trim().length),this.cur.append(r),r._indent=t+n,void(r._lines=[e.substring(i[0].length)]);if(!r._indentDecided){if((i=S.exec(e))&&r._indent&&r._indent-n<4)if(i[1].length){var d=i[1].length,u=d+r._indent;u>n+r.get("markindent")&&function(e){return!!k.exec(function(e){if(!e||0==e.length)return"";for(var t=e.length-1;t>=0;t--)if(e[t].trim().length>0)return e[t];return""}(e))}(r._lines)?d=r.get("markindent")-r._indent:u>=n+r.get("markindent")+4&&(d=d+r._indent-4-r.get("markindent")),r._indent+=d,this.cur.set("subindent",r._indent-r._numLength),r.set("subindent",r._indent-r._numLength),e=e.substring(d)}else r.set("subindent",Math.max(2,c-r._numLength));r._indentDecided=!!i}return void r._lines.push(e)}},fences:{shouldClose:function(e){var t;return(t=P.exec(e))&&this.cur._mark==t[1]?2:0},onContinue:function(e){this.cur._lines.push(e)},onClose:function(){this.cur.set("text",this.cur._lines.join("\n")),this.cur._mark=void 0,this.cur._lines=void 0;var e=this.lines[this.ln+1];void 0!==e&&e.match(_)&&(this.cur.set("tail",1),this.ln++)}},code:{shouldClose:function(e){return e.match(D)?0:this.cur._lines.length>1&&!this.cur._lines.last().match(_)&&e.match(_)?0:1},onClose:function(){this.cur._lines.length>1&&(this.cur._lines.last().match(_)?(this.cur.set("tail",1),this.cur._lines.pop(),this.cur._lines.length>1&&this.cur._lines.last().match(_)&&(this.cur._lines.pop(),this.ln--)):this.cur.set("tail",0)),this.cur.set("text",this.cur._lines.join("\n")),this.cur.attributes.type=y.fences,this.cur._lines=void 0},onContinue:function(e){this.cur._lines.push(e.replace(B,""))}}},ne=function(e,t,n,i,r){e.parent=t,e.cur=null,e.skips=r,e.ln=0,e.blocks=[],e.oldNode=i,e.nodeMap=t||i,e.nodeMap=e.nodeMap?e.nodeMap.get("in"):n,ee=" ".repeat(File.option.indentSize)},ie=function(e,t,n,i,r){var a=e;"string"==typeof e&&(a=e.split(E),"\n"===e.charCodeAt(e.length-1)&&(s-=1));var s=a.length;for(this.lines=a,ne(this,t,n,i,r),this.skips.enableMetaBlock=this.skips.enableMetaBlock&&!t;this.ln<=s;this.ln++)o.call(this,a[this.ln],this.ln==s);return this};v.parseFrom=function(e,t,n,i){return n=n||{},new v({type:y.raw_edit,in:t,attachTo:n.noTop?null:t,text:e}).parseFrom(n,void 0,i)},v.prototype.parseFrom=function(e,t,n){if(e=e||{},v.isType(this.get("parent"),y.table_row))return this.set("type",y.table_cell),this.set("text",this.safeGetStrAttr("text").replace(/\n|\r/gi,"").replace(/([^\\])\|/gi,"$1|")),!n&&this.toHTML();if(!v.isType(this,y.line,y.raw_edit,y.list_item))return[!n&&this.toHTML(),[this]];var i=function(e){if(v.isType(e,y.list_item)&&!e.get("children").length){var t=new v({type:y.paragraph,text:e.get("text"),parent:e,in:e.get("in")});return e.set("text",""),t}return null}(this)||this,r=e.skips||{};if(t=t||i.get("text"),this.get("type")===y.line&&(t=t.replace(/\r?\n/,"")),r.enableMetaBlock=this.get("attachTo")&&!this.get("before"),r.old_code=!1!==r.old_code,this.isBlock(!0)){var o=this.get("before"),a=this.get("after"),s=new ie(t,null,i.get("in"),i,r).blocks;return s.length<=1?[!n&&this.toHTML(),[this]]:(s[0].set("before",o),s.last().set("after",a),[!n&&g.NodeCollectionUtils.toHTML(s),s])}};var re={escape:/^\\([\\`*{}\[\]()#+\-.!_>$|<~])/,escape2:/^[\uE013\uE014\uE018\uE020]/,autolink:/^<((([^ >]+(@|:)[^ >]+))|(\s*www\.[^ >]+))>/,url:/^\uE016([^\uE017]+)\uE017/i,comment:/^<!--[\s\S]*?-->/,br:/^<br[\s\/]*>(\s*<\/br>)*/,tag:/^<\/?\w+(?:"[^"]*"|'[^']*'|[^'">])*?>/,underline:/^<u>([^\r]*?\S)<\/u>/,atag:/^(<a\s.+?>)(.*?)(<\/\s*a>)/,imgtag:/^<img(\s+.+)*?\s+src=("([^"]+)"|'([^']+)').*?(\/?\s*>.*?(<\/img>)?)/,link:/^\[((?:\[[^\]]*\]|[^\[\]])*)\]\(<?((?:\([^)]*\)|[^()])*?)>?[ \t]*((['"])(.*?)\4[ \t]*)?\)/,image:/^\!\[((?:\[[^\]]*\]|[^\[\]])*)\]\(<?((?:\([^)]*\)|[^()])*?)>?[ \t]*((['"])(.*?)\4[ \t]*)?\)({([^{}\(\)]*)})?/,reflink:/^(!?)\[(inside)\]\s*\[([^\]]*)\]/,strong:/^(\*\*|__)(?=\S)([^\r]*?\S?[*_]?)\1/,em1:/^(\_)(?=\S)([^\r]*?[^\s_])\1(?!\1)/,em2:/^(\*)(?=\S)([^\r]*?[^\s*])\1(?!\1)/,highlight:/^(\=\=)(?=\S)([^\r]*?\S)\1/,code:/^(`+)([\s\S]*?[^`])\1(?!`)/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:/(\s|\S)+?[^\u200B\uE010-\uE020\uE006\\<!\[_*`&{\$\:~\^\=]*/,footnote:/^\[\^([^\]]+)\]/,attr:/^{( *([#.][-\w_\uE006]+ *|[-\w_\uE006]+=[-\w_"'\uE006]+ *)+)}/,html:/(comment|closed|closing)/,entity:/^&[a-z]+;/i,emoji:/^(\u200B*):([+\-\w\uE006]+):(\u200B*)/,inline_math:/^\$.*(?:[^\\])\$/,subscript:/^~(([^\s]|(\\\s))+?)~/,superscript:/^\^(([^\s]|(\\\s))+?)\^/,linebreak:/  $/};re._inside=/(?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*/,re._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/,re._tag="(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:/|@)\\b",re.html=c(re.html)("comment",/<!--[\s\S]*?-->/)("closed",/<(tag)[\s\S]+?<\/\1>/)("closing",/<tag(?:"[^"]*"|'[^']*'|[^'">])*?>/)(/tag/g,re._tag)(),re.link=c(re.link)("inside",re._inside)("href",re._href)(),re.reflink=c(re.reflink)("inside",re._inside)(),re.normal=u({},re),re.pedantic=u({},re.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/}),re.gfm=re.normal,re.breaks=u({},re.gfm,{text:c(re.gfm.text)("{2,}","*")()}),a.rules=re;var oe={UNDER_CHAR:"",MATH_CHAR:"",DEF_FOOT_PERFIX_CHAR:"",ESCAPE_SATR:"",ESCAPE_UNDERLINE:"",ESCAPE_EQUAL:"",URL_START:"",URL_END:"",ESCAPE_END_SQUARE_BRACKET:"",NOT_USED:"",ESCAPE_ESCAPE:"",ESCAPE_VLINE:"",ESCAPE_SPACE:""},ae={"":"[^","":"*","":"_","":"=","":"]","":"\\"},se={"":"_","":"","":""},le={"\\\\":oe.ESCAPE_ESCAPE,"\\*":oe.ESCAPE_SATR,"\\=":oe.ESCAPE_EQUAL,"\\_":oe.ESCAPE_UNDERLINE,"\\]":oe.ESCAPE_END_SQUARE_BRACKET};a.skipLink={autolink:1,url:1,link:1,reflink:1},a.prototype.output=function(e,t,n,i,r,o){function c(e,t){var n=e.last();n&&n.type===y.plain?n.text+=t:e.push({type:y.plain,text:t})}function d(e){return P="",e.map(function(e){P+=t(e,b)}),P}t=t||this.options.decorate,(r=u(r||{},this.options.skipOp)).attr=!1!==r.attr,File.option.enableInlineMath||(r.inline_math=!0),File.option.enableSubscript||(r.subscript=!0),File.option.enableSuperscript||(r.superscript=!0),File.option.enableHighlight||(r.highlight=!0),o=o||[];var h,p,f,g=0,v=[],b=this.options;for(i||(e=s(e,!r.url));e;)if(f=this.rules.escape2.exec(e))g+=f[0].length,e=e.substring(f[0].length),v.push({type:y.escape,text:ae[f[0]]});else if(f=this.rules.escape.exec(e))g+=f[0].length,e=e.substring(f[0].length),v.push({type:y.escape,text:f[1]});else if(r.autolink||!(f=this.rules.autolink.exec(e)))if(r.url||!(f=this.rules.url.exec(e)))if(f=this.rules.comment.exec(e))g+=f[0].length,e=e.substring(f[0].length),h=f[0],v.push({type:r.comment?y.tag:y.comment,text:h});else if(f=this.rules.br.exec(e))g+=f[0].length,e=e.substring(f[0].length),v.push({type:"br",text:f[0]});else if(f=this.rules.tag.exec(e)){var w;if(!r.underline&&(w=this.rules.underline.exec(e))){g+=w[0].length,e=e.substring(w[0].length),v.push({type:y.underline,inner:this.output(w[1],t,null,!0),text:w[1]});continue}if(!r.atag&&(w=this.rules.atag.exec(e))&&w[2].trim().length){g+=w[0].length,e=e.substring(w[0].length),v.push({type:y.atag,inner:this.output(w[2],t,null,!0),left:w[1],right:w[3],href:l((w[1].match(/\s+href=['"]([^'"]+)/)||[])[1]||"")});continue}if(!r.imgtag&&(w=this.rules.imgtag.exec(e))&&(w[3]||w[4]).trim().length){g+=w[0].length,e=e.substring(w[0].length);var C=(/\sstyle=(['"])(.+?)\1/.exec(w[0])||[])[2]||"",k=(/(^|[^\w-])width\s*:\s*(.+?)(\s*;|$)/.exec(C)||[])[2],S=(/(^|[^\w-])height*:\s*(.+?)(\s*;|$)/.exec(C)||[])[2],T=(/(^|[^\w-])zoom*:\s*(.+?)(\s*;|$)/.exec(C)||[])[2];k||(k=(/\swidth=(['"])(.+?)\1/.exec(w[0])||[])[2],/\d\s*$/.exec(k||"")&&(k+="px;")),S||(S=(/\sheight=(['"])(.+?)\1/.exec(w[0])||[])[2],/\d\s*$/.exec(S||"")&&(k+="px;")),v.push({type:y.imgtag,text:w[0],href:l(w[3]||w[4]),width:k,height:S,zoom:T});continue}g+=f[0].length,e=e.substring(f[0].length),h=f[0],v.push({type:y.tag,text:l(h)})}else if(!(f=this.rules.link.exec(e))||r.link)if(!(f=this.rules.image.exec(e))||r.image)if(!r.footnote&&g&&(f=this.rules.footnote.exec(e))){g+=f[0].length,e=e.substring(f[0].length);I=(f[2]||f[1]).replace(/\s+/g," ");v.push({type:y.footnote,inner:this.output(f[1],t,null,!0,a.skipLink),text:l(f[1])})}else if(!(f=this.rules.reflink.exec(e))||r.reflink&&!f[1])if(r.attr||!(f=this.rules.attr.exec(e)))if(f=this.rules.strong.exec(e))g+=f[0].length,e=e.substring(f[0].length),v.push({type:y.strong,pattern:f[1],inner:this.output(f[2],t,null,!0)});else if((f=this.rules.em1.exec(e))||(f=this.rules.em2.exec(e)))g+=f[0].length,e=e.substring(f[0].length),v.push({type:y.em,pattern:f[1],inner:this.output(f[2],t,null,!0)});else if(f=this.rules.code.exec(e))g+=f[0].length,e=e.substring(f[0].length),v.push({type:y.code,pattern:f[1],text:f[2]});else if(f=this.rules.del.exec(e))g+=f[0].length,e=e.substring(f[0].length),v.push({type:y.del,pattern:"~~",inner:this.output(f[1],t,null,!0)});else if((f=this.rules.emoji.exec(e))&&x.data[f[2]=f[2].replace(/\uE006/g,"_")])e=e.substring(f[0].length),v.push({type:y.emoji,text:f[2],inner:x.data[f[2]]}),!f[1].length&&(o[g]=1),g+=f[0].length,!f[3].length&&(o[g]=1);else{if(!r.subscript&&(f=this.rules.subscript.exec(e))){e=e.substring(f[0].length);E=[];(f=f[1].split(/\\\s/g))[0]&&E.push({type:y.plain,text:f[0]});for(F=1;F<f.length;F++)E.push({type:y.escape,text:" "}),f[F]&&E.push({type:y.plain,text:f[F]});v.push({type:y.subscript,inner:d(E)})}if(!r.superscript&&(f=this.rules.superscript.exec(e))){e=e.substring(f[0].length);var E=[];(f=f[1].split(/\\\s/g))[0]&&E.push({type:y.plain,text:f[0]});for(var F=1;F<f.length;F++)E.push({type:y.escape,text:" "}),f[F]&&E.push({type:y.plain,text:f[F]});v.push({type:y.superscript,inner:d(E)})}if(r.inline_math||!(f=this.rules.inline_math.exec(e)))if(r.highlight||!(f=this.rules.highlight.exec(e))){if(f=this.rules.entity.exec(e))g+=f[0].length,e=e.substring(f[0].length),m.decodeHtmlEntity(f[0])?v.push({type:y.html_entity,inner:f[0],text:f[0]}):c(v,f[0]||"");else if(f=this.rules.text.exec(e))g+=f[0].length,!(e=e.substring(f[0].length))&&this.rules.linebreak.exec(f[0]||"")?(c(v,f[0].replace(this.rules.linebreak,"")),v.push({type:y.linebreak,text:"  "})):c(v,f[0]||"");else if(e)throw new Error("Infinite loop on byte: "+e.charCodeAt(0))}else g+=f[0].length,e=e.substring(f[0].length),v.push({type:y.highlight,inner:this.output(f[2],t,null,!0),text:f[2]});else{var _=null,M=0,N="",L=null,A=/\$/,R="$";for(/^\$\$/.exec(f[0])?(_=/{|}|\$\$/g,R="$$"):(_=/{|}|\$/g,R="$"),_.exec(f[0]);L=_.exec(f[0]);){if(A.exec(L[0])&&M<=0&&"\\"!=f[0].substring(L.index-1,L.index)){N=f[0].substring(0,L.index+L[0].length);break}"{"===L[0]?"\\"===L.input[L.index-1]&&"\\"!==!L.input[L.index-2]||M++:"}"===L[0]&&("\\"===L.input[L.index-1]&&"\\"!==!L.input[L.index-2]||M--)}if(N.length-2*R.length>0&&/[^\s$]/.exec(N)){g+=N.length,e=e.substring(N.length),v.push({type:"inline_math",text:l(N),pattern:R});continue}g+=f[0].length,e=e.substring(f[0].length),c(v,f[0]||"")}}else g+=f[0].length,e=e.substring(f[0].length),v.push({type:y.attr,text:f[0]});else{g+=f[0].length,e=e.substring(f[0].length);var I=(f[3]||"").replace(/\s+/g," ");v.push({type:f[1]?"refimg":"reflink",ref:l(I),inner:this.output(f[2],t,null,!0,a.skipLink),text:l(f[2]),markdown:f[0],onlychild:!e&&!v.length})}else g+=f[0].length,e=e.substring(f[0].length),v.push({type:"image",href:l(f[2]),title:f[5],markdown:f[0],alt:f[1],onlychild:!e&&!v.length});else g+=f[0].length,e=e.substring(f[0].length),v.push({type:"link",href:l(f[2]),title:f[5],markdown:f[0],inner:f[1]?this.output(f[1],t,null,!0,a.skipLink):"",meta:l(f[0].substring(f[1].length+2))});else e=e.substring(f[0].length),g+=f[1].length,p=h=f[1],null===/^\w+:\/\//.exec(h)&&/@/.exec(h)&&(p="mailto:"+p),v.push({type:y.url,href:l(p),text:h});else g+=f[0].length,e=e.substring(f[0].length),"",h=f[1],p="@"===f[4]?":"===f[1].charAt(6)?h:"mailto:"+f[1]:h,v.push({type:y.autolink,href:l(p),text:h});var P=d(v);return i||(P=l(P)),P},a.prototype.mangle=function(e){for(var t,n="",i=e.length,r=0;r<i;r++)t=e.charCodeAt(r),Math.random()>.5&&(t="x"+t.toString(16)),n+="&#"+t+";";return n},d.exec=d;var ce,de=/^(\s*#{1,6}\s*)([^\n]+?\s*)(#*\s*)(\n{1,2}|$)/,ue=/^(\s*#{1,6}\s+)([^\n]+?\s*)(#*\s*)(\n{1,2}|$)/,he={};he.options=he.setOptions=function(e){return u(he.defaults,e),he},he.defaults={gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,smartLists:!1,silent:!1,highlight:null,langPrefix:"lang-",smartypants:!1,headerPrefix:""},he.parseInline=function(e,t,n){return ce||(ce=new a),ce.output(e,null,null,null,t,n)},he.InlineLexer=a,he.quickParse=h,he.reDefLink=q,he.reDefFootnote=W,he.renderHtmlWithBlockMeta=p,he.splitTableCell=i,he.recoverEscape=l,n.exports=he}),define("app/editor/Inline",["app/document/StringUtils","app/document/Node","exoskeleton-master/exoskeleton","jquery/jquery","app/editor/EditHelper","app/editor/KeyMaster"],function(e,t,n){"use strict";function i(e,t,n,i,a,s){var h,p,f,m,g=File.editor,t=o.escape(t),v="",y="";if(e==l.refimg){if(p=n,h=g.nodeMap.link_list.getHrefByRef(p)||"",v=" data-ref='"+c(p)+"' ",!h)return"<span md-inline='refimg' class='md-image md-no-ref' "+v+"><span class='md-meta md-before md-content' contenteditable='true' data-hint='"+$.localize.getString("Please define image reference by \n[{0}]: http://example.png").format(c(p))+"' >"+t+"</span></span>"}else h=n;i&&(y+="width:"+i.replace(/['";\\]/g,"")+";"),a&&(y+="height:"+a.replace(/['";\\]/g,"")+";"),s&&(y+="zoom:"+s.replace(/['";\\]/g,"")+";"),y&&(y=" style =' "+y+"' ");var b=" data-src='"+d(h)+"' ",w=g.imgEdit.getRealSrc(h),x=/^data:/.exec(w),C=w;return/^file:\/\//i.exec(w||"")&&(w+="?lastModify="+imgLastModified),x&&(b=" "),w=d(w),f=x||loadedImgCache.indexOf(C)>-1?"<span md-inline='"+e+"'"+b+" contenteditable='false' class='md-image md-img-loaded' "+v+"><span class='md-meta md-before md-content' contenteditable='true'>"+t+"</span><img src='"+w+"' "+y+"></span>":failImgCache.indexOf(C)>-1?"<span md-inline='"+e+"'"+b+" contenteditable='false' class='md-image md-img-error' "+v+"><span class='md-meta md-content md-before' contenteditable='true'>"+t+"</span><img src='' "+y+"></span>":"<span md-inline='"+e+"'"+b+" contenteditable='false' class='md-image' data-src='"+w+"' "+v+"><span class='md-meta md-before md-content' contenteditable='true'>"+t+"</span><img src='"+w+"' "+u+" "+y+" /></span>",e==l.image&&-1==failImgCache.indexOf(w)&&(window.uploadImageQueue.has(h)?(r(m=$(f),h,!1),f=m[0].outerHTML):window.moveImageQueue.has(h)&&(r(m=$(f),h,!0),f=m[0].outerHTML)),f}function r(e,t,n){var i=n?"md-on-moving":"md-on-uploading";e.addClass(i),e.append($("#typora-uploading-image-templ").html().replace(/\s*\n\s*/g,"")),e.attr("data-origin-path",t)}var o=e("app/document/StringUtils"),a=e("app/document/Node"),s=e("app/editor/EditHelper"),l=(a.Node,a.TYPE);window.failImgCache=[],window.loadedImgCache=[],window.removeLastModifyQuery=function(e){return(e||"").replace(/\?lastModify=(.+)$/,"")};var c=function(e){return o.escapeForPreWrap(e)},d=function(e){if(/%[0-9a-f]{2}/i.exec(e))return e.replace(/'/,"%27").replace('"',"%22");var t;try{t=decodeURI(e)}catch(n){t=e}return encodeURI(t.replace(/\\/g,"/")).replace(/'/,"%27").replace('"',"%22")};t.onErrorEvaluate="var src = window.removeLastModifyQuery(this.getAttribute('src'));if(!src.trim()) return;if (failImgCache.length > 5000) {failImgCache = [];}if(failImgCache.indexOf(src) == -1 && src.trim().length){failImgCache.push(src);}$(this).closest('.md-image').addClass('md-img-error').removeClass('md-img-loaded');",t.onLoadEvaluate="var src = window.removeLastModifyQuery(this.getAttribute('src'));if(!src.trim()) return;if(loadedImgCache.indexOf(src) == -1 && src.trim().length){loadedImgCache.push(src);}$(this).closest('.md-image').addClass('md-img-loaded').removeClass('md-img-error');";var u='onerror=" '+t.onErrorEvaluate+' " onload ="'+t.onLoadEvaluate+'"';t.applyUploadingStyle=r,t.decorateAsExport=function(e,t){var n,i,r,a,u,h;switch(e.type){case l.strong:return"<strong>"+e.inner+"</strong>";case l.em:return"<em>"+e.inner+"</em>";case l.plain:return o.escape(e.text);case l.code:return t.forPrint&&File.isNode?(t.defaultFont||(t.defaultFont=window.getComputedStyle(File.editor.writingArea).fontFamily||"initial"),n="<code>"+e.text.trim().split(/([\-;]+)/).map(function(e){return e?/\-|;/.exec(e)?"<span style='font-family:"+t.defaultFont.replace(/'/g,"\\'")+"'>"+e+"</span>":o.escape(e,!1,!0):""}).join("")+"</code>"):n="<code>"+o.escape(e.text.trim(),!1,!0)+"</code>",n;case l.del:return"<del>"+e.inner+"</del>";case l.autolink:case l.url:return"<a href='"+d(e.href)+"' target='_blank' >"+e.text+"</a>";case l.br:return e.text;case l.tag:return/^<img/.test(e.text)&&t.forPrint&&(i=/(\ssrc=)(['"])([^"']*)(\2)/.exec(e.text))?(i=File.editor.imgEdit.getRealSrc(i[3]).replace(/^file:\/\/\/?/i,"file:///").replace(/\\/g,"/"),e.text.replace(/(\ssrc=)(['"])([^"']*)(\2)/,"$1$2"+i+"$4")):e.text;case l.link:return"#"==(e.href||"").trim()[0]&&(h=s.findAnchorElem(e.href)).length&&(e.href="#header-"+h.attr("cid")),"<a href='"+d(e.href)+"'"+(e.title?" title='"+c(e.title)+"'":"")+">"+e.inner+"</a>";case l.image:return i=t.forPrint?File.editor.imgEdit.getRealSrc(e.href):e.href,t.forPrint&&File.isNode&&File.option.printPDFByPhantom&&(i=i.replace(/^file:\/\/\/?/i,"file:///").replace(/\\/g,"/")),n="<img src='"+d(i)+"' alt='"+c(e.alt)+"' />",!t.noStyle&&e.onlyChild&&(n="<span class='md-image'>"+n+"</span>"),n;case l.footnote:if(u=t.nodeMap.foot_list.getNodeByRef(e.text)){var p=t.footnoteList.indexOf(e.text)+1;0==p&&(t.footnoteList.push(e.text),p=t.footnoteList.length);var f=t.appendFootnote(u,p);return n="<sup><a href='#dfref-footnote-"+f+"' name='ref-footnote-"+f+"'>"+p+"</a></sup>"}return"[^"+o.escape(e.text)+"]";case l.escape:return o.escape(e.text);case l.refimg:return r=t.nodeMap.link_list.getNodeByRef(e.ref||e.text),a=r?c(r.get("title")):void 0,void 0!==(i=r?d(r.get("href")):void 0)?(t.forPrint&&File.isNode&&File.option.printPDFByPhantom&&(i=i.replace(/^file:\/\/\/?/i,"file:///").replace(/\\/g,"/")),n="<img alt='"+e.text+"' src='"+i+"'"+(a?" title='"+a+"'":"")+"></img>",t.noStyle||(n="<span class='md-image'>"+n+"</span>"),n):"!["+e.inner+"]["+o.escape(e.ref)+"]";case l.reflink:return r=t.nodeMap.link_list.getNodeByRef(e.ref||e.text),i=r?c(r.get("href")):void 0,a=r?c(r.get("title")):void 0,void 0!==i?"<a href='"+i+"' target='_blank'"+(a?" title='"+a+"'":"")+">"+e.inner+"</a>":"["+e.inner+"]["+o.escape(e.ref)+"]";case l.attr:return"";case l.emoji:return e.inner;case l.inline_math:return t.noStyle?e.text:s.processExportedSVG(svgCache[e.text.replace(/\u200B/g,"")]||o.escapeForPreWrap(e.text));case l.subscript:return"<sub>"+e.inner+"</sub>";case l.superscript:return"<sup>"+e.inner+"</sup>";case l.underline:return"<u>"+e.inner+"</u>";case l.linebreak:return"<br/>";case l.highlight:return"<mark>"+e.inner+"</mark>";default:return e.inner||""}},t.decorate=function(e,t){switch(e.type){case l.heading:return"<span class='md-blockmeta'>"+e.meta_before+"</span><span class='md-header-span'>"+e.inner+"</span><span class='md-blockmeta'>"+e.meta_after+"</span>";case l.paragraph:return e.inner;case l.blockquote:return"<span class='md-blockmeta'>"+e.pattern+"</span>"+e.inner;case l.fences:return"<span class='md-blockmeta'>"+e.pattern+"</span><span class='md-lang'>"+o.escape(e.lang)+"</span>";case l.def_footnote:return"<span class='md-blockmeta'>[^</span>"+e.ref+"<span class='md-blockmeta'>]: </span><span class='md-def-content'>"+e.inner+"</span>";case l.def_link:return"<span class='md-blockmeta'>[</span>"+e.ref+"<span class='md-blockmeta'>]: </span><span class='md-def-content'>"+e.inner+"</span>";case l.strong:return"<span md-inline='strong' class='"+(e.inner?"":"md-empty")+"'><span class='md-meta md-before'>"+e.pattern+"</span><strong>"+e.inner+"</strong><span class='md-meta md-after'>"+e.pattern+"</span></span>";case l.em:return"<span md-inline='em' class='"+(e.inner?"":"md-empty")+"'><span class='md-meta md-before'>"+e.pattern+"</span><em>"+e.inner+"</em><span class='md-meta md-after'>"+e.pattern+"</span></span>";case l.highlight:return"<span md-inline='highlight'><span class='md-meta md-before'>==</span><mark>"+e.inner+"</mark><span class='md-meta md-after'>==</span></span>";case l.plain:return"<span md-inline='plain'>"+o.escape(e.text.replace(/\r?\n/gi,""))+"</span>";case l.code:var n=e.text.match(/^\s+/)||"";e.text=e.text.replace(/^\s+/,"");var r=e.text.match(/\s+$/)||"";return"<span md-inline='code' spellcheck='false'><span class='md-meta md-before'>"+e.pattern+n+"</span><code>"+o.escapeForPreWrap(e.text.trim(),!1,!0)+"</code><span class='md-meta md-after'>"+r+e.pattern+"</span></span>";case l.del:return"<span md-inline='del'><span class='md-meta md-before'>"+e.pattern+"</span><del>"+e.inner+"</del><span class='md-meta md-after'>"+e.pattern+"</span></span>";case l.autolink:return"<span md-inline='autolink'><span class='md-meta md-before'>&lt;</span><a href='"+d(e.href)+"'>"+o.escape(e.text)+"</a><span class='md-meta md-after'>&gt;</span></span>";case l.url:return"<span md-inline='url' spellcheck='false'><a href='"+d(e.href)+"'>"+o.escape(e.text)+"</a></span>";case l.br:return"<span md-inline='br' class='md-br md-tag' spellcheck='false'><span class='md-br-content'>"+o.escapeForPreWrap(e.text,!1,!0)+"</span></span>";case l.comment:return"<span md-inline='comment' class='md-comment' spellcheck='false'>"+o.escapeForPreWrap(e.text,!1,!0)+"</span>";case l.tag:return"<span md-inline='tag' class='md-tag' spellcheck='false'>"+o.escapeForPreWrap(e.text,!1,!0)+"</span>";case l.atag:return"<span md-inline='atag' class='md-atag'><span class='md-meta md-before'>"+o.escapeForPreWrap(e.left,!1,!0)+"</span><a href='"+d(e.href)+"'>"+e.inner+"</a><span class='md-meta md-after'>"+o.escapeForPreWrap(e.right,!1,!0)+"</span></span>";case l.link:var a=e.meta.replace(/^\((<?(?:\([^)]*\)|[^()])*?>?)([ \t]*)((['"])(.*?)\4)?([ \t]*)\)/,function(t,n,i,r,a,s,l){return"(</span><span class='md-content md-url'>"+o.escape(e.href)+"</span><span class='md-meta'>"+o.escape(i)+"</span><span class='md-content md-link-title'>"+o.escape(r)+"</span><span class='md-meta md-after'>"+o.escape(l)+")</span>"});return"<span md-inline='link' class='"+(e.inner?"":"md-empty-link")+"'><span class='md-meta md-before'>[</span><a spellcheck='false' href='"+d(e.href)+"' >"+e.inner+"</a><span class='md-meta md-before'>]"+a+"</span>";case l.imgtag:return i(e.type,e.text,e.href,e.width,e.height,e.zoom);case l.refimg:return i(e.type,e.markdown,e.ref||e.text);case l.image:return i(e.type,e.markdown,e.href);case l.footnote:return"<sup md-inline='footnote' class='md-footnote'><span class='md-meta md-before'>[^</span><span class='md-text'>"+e.inner+"</span><span class='md-meta md-after'>]</span></sup>";case l.escape:return"<span md-inline='escape'><span class='md-meta md-before'>\\</span>"+o.escape(e.text)+"</span>";case l.reflink:return"<span md-inline='reflink'><span class='md-meta md-before'>[</span><a data-ref='"+o.escapeForPreWrap(e.ref||e.text)+"' >"+e.inner+"</a><span class='md-meta md-after'>]</span><span class='md-meta md-before'>[</span><span class='md-content'>"+e.ref+"</span><span class='md-meta md-after'>]</span></span>";case l.attr:return"<span md-inline='attr' class='md-attr'>"+o.escape(e.text)+"</span>";case l.emoji:return"<span md-inline='emoji' data-content='"+e.text+"' class='md-emoji' >​<span data-emoji='"+e.inner+"' class='md-emoji-span'></span><span class='md-meta'>:"+e.text+":</span>​</span>";case l.inline_math:return e.text=e.text.replace(/\u200B*/g,""),!/^\$+$/.exec(e.text)&&svgCache[e.text]?"<span class='md-inline-math' md-inline='inline_math' pattern='"+e.pattern+"'><span class='md-before md-meta'>"+e.pattern+"</span><span class='inline-math-svg math-jax-postprocess'>"+svgCache[e.text]+"</span><span class='md-math-after-sym'></span><span class='md-after md-meta'>"+e.pattern+"</span></span>":"<span class='md-inline-math' md-inline='inline_math' pattern='"+e.pattern+"'><span class='inline-math-svg math-jax-preprocess'>"+o.escape(e.text)+"</span></span>";case l.subscript:return"<sub md-inline='subscript'><span class='md-meta md-before'>~</span>"+e.inner+"<span class='md-meta md-after'>~</span></sub>";case l.superscript:return"<sup md-inline='superscript'><span class='md-meta md-before'>^</span>"+e.inner+"<span class='md-meta md-after'>^</span></sup>";case l.underline:return"<span md-inline='underline'><span class='md-meta md-before'>&lt;u&gt;</span><u>"+e.inner+"</u><span class='md-meta md-after'>&lt;/u&gt;</span></span>";case l.linebreak:return"<span md-inline='linebreak'>  </span>";case l.html_entity:return"<span md-inline='html_entity' data-content='"+e.text+"' class='md-entity'><span class='md-meta'>"+o.escape(e.text)+"</span></span>";default:return console.error("unknow type "+e.type),e.text}}}),define("app/editor/Emoji",["jquery/jquery","exoskeleton-master/exoskeleton"],function(e,t,n){"use strict";var i=e("jquery/jquery"),r=e("exoskeleton-master/exoskeleton").Model.extend({initialize:function(e){this.editor=e,this.$container=i("#emoji-auto-suggest"),setTimeout(function(){i.getScript("./app/editor/EmojiSearchMap.js",function(){var e=window.EmojiSearchMap;for(var t in r.data)e[t]||(e[t]=[t])})},1e3)},search:function(e,t){if(!e)return[];var n,i=new RegExp("(^"+e+")|(_"+e+")|(-"+e+")","i"),o=Object.keys(r.data).filter(function(t){return i.exec(t)&&t!==e});if(o.sort(),r.data[e]&&o.unshift(e),n=(window.EmojiSearchMap||{})[e])for(var a=0;a<n.length;a++)-1==o.indexOf(n[a])&&o.push(n[a]);return t.type="emoji",t.token=e,t.match=o,t.found=o.length,t.pageNo=0,t.pageCnt=Math.floor((o.length-1)/5+1),o},showAutoSuggest:function(e,t){if(t.token===e)return!1;var n=this.search(e,t),i="";if(!t.found)return this.$container.hide(),!1;for(var o=0;o<n.length&&o<40;o++)o%5==0&&(i+=(o>0?"</ul>":"")+"<ul data-page='"+o/5+"' style='display:none'>"),i+="<li data-content=':"+n[o]+":' ><span>"+r.data[n[o]]+"</span> <span class='emoji-meta'>:"+n[o]+":</span></li>";return i+="</ul>",this.$container.html(i),this.$container}});r.data={100:"💯",1234:"🔢",grinning:"😀",smiley:"😃",smile:"😄",grin:"😁",laughing:"😆",satisfied:"😆",sweat_smile:"😅",joy:"😂",rofl:"🤣",relaxed:"☺️",blush:"😊",innocent:"😇",slightly_smiling_face:"🙂",upside_down_face:"🙃",wink:"😉",relieved:"😌",heart_eyes:"😍",kissing_heart:"😘",kissing:"😗",kissing_smiling_eyes:"😙",kissing_closed_eyes:"😚",yum:"😋",stuck_out_tongue_winking_eye:"😜",stuck_out_tongue_closed_eyes:"😝",stuck_out_tongue:"😛",money_mouth_face:"🤑",hugs:"🤗",nerd_face:"🤓",sunglasses:"😎",clown_face:"🤡",cowboy_hat_face:"🤠",smirk:"😏",unamused:"😒",disappointed:"😞",pensive:"😔",worried:"😟",confused:"😕",slightly_frowning_face:"🙁",frowning_face:"☹️",persevere:"😣",confounded:"😖",tired_face:"😫",weary:"😩",triumph:"😤",angry:"😠",rage:"😡",pout:"😡",no_mouth:"😶",neutral_face:"😐",expressionless:"😑",hushed:"😯",frowning:"😦",anguished:"😧",open_mouth:"😮",astonished:"😲",dizzy_face:"😵",flushed:"😳",scream:"😱",fearful:"😨",cold_sweat:"😰",cry:"😢",disappointed_relieved:"😥",drooling_face:"🤤",sob:"😭",sweat:"😓",sleepy:"😪",sleeping:"😴",roll_eyes:"🙄",thinking:"🤔",lying_face:"🤥",grimacing:"😬",zipper_mouth_face:"🤐",nauseated_face:"🤢",sneezing_face:"🤧",mask:"😷",face_with_thermometer:"🤒",face_with_head_bandage:"🤕",smiling_imp:"😈",imp:"👿",japanese_ogre:"👹",japanese_goblin:"👺",hankey:"💩",poop:"💩",shit:"💩",ghost:"👻",skull:"💀",skull_and_crossbones:"☠️",alien:"👽",space_invader:"👾",robot:"🤖",jack_o_lantern:"🎃",smiley_cat:"😺",smile_cat:"😸",joy_cat:"😹",heart_eyes_cat:"😻",smirk_cat:"😼",kissing_cat:"😽",scream_cat:"🙀",crying_cat_face:"😿",pouting_cat:"😾",open_hands:"👐",raised_hands:"🙌",clap:"👏",pray:"🙏",handshake:"🤝","+1":"👍",thumbsup:"👍","-1":"👎",thumbsdown:"👎",fist_oncoming:"👊",facepunch:"👊",punch:"👊",fist_raised:"✊",fist:"✊",fist_left:"🤛",fist_right:"🤜",crossed_fingers:"🤞",v:"✌️",metal:"🤘",ok_hand:"👌",point_left:"👈",point_right:"👉",point_up_2:"👆",point_down:"👇",point_up:"☝️",hand:"✋",raised_hand:"✋",raised_back_of_hand:"🤚",raised_hand_with_fingers_splayed:"🖐",vulcan_salute:"🖖",wave:"👋",call_me_hand:"🤙",muscle:"💪",middle_finger:"🖕",fu:"🖕",writing_hand:"✍️",selfie:"🤳",nail_care:"💅",ring:"💍",lipstick:"💄",kiss:"💋",lips:"👄",tongue:"👅",ear:"👂",nose:"👃",footprints:"👣",eye:"👁",eyes:"👀",speaking_head:"🗣",bust_in_silhouette:"👤",busts_in_silhouette:"👥",baby:"👶",boy:"👦",girl:"👧",man:"👨",woman:"👩",blonde_woman:"👱‍♀",blonde_man:"👱",person_with_blond_hair:"👱",older_man:"👴",older_woman:"👵",man_with_gua_pi_mao:"👲",woman_with_turban:"👳‍♀",man_with_turban:"👳",policewoman:"👮‍♀",policeman:"👮",cop:"👮",construction_worker_woman:"👷‍♀",construction_worker_man:"👷",construction_worker:"👷",guardswoman:"💂‍♀",guardsman:"💂",female_detective:"🕵️‍♀️",male_detective:"🕵",detective:"🕵",woman_health_worker:"👩‍⚕",man_health_worker:"👨‍⚕",woman_farmer:"👩‍🌾",man_farmer:"👨‍🌾",woman_cook:"👩‍🍳",man_cook:"👨‍🍳",woman_student:"👩‍🎓",man_student:"👨‍🎓",woman_singer:"👩‍🎤",man_singer:"👨‍🎤",woman_teacher:"👩‍🏫",man_teacher:"👨‍🏫",woman_factory_worker:"👩‍🏭",man_factory_worker:"👨‍🏭",woman_technologist:"👩‍💻",man_technologist:"👨‍💻",woman_office_worker:"👩‍💼",man_office_worker:"👨‍💼",woman_mechanic:"👩‍🔧",man_mechanic:"👨‍🔧",woman_scientist:"👩‍🔬",man_scientist:"👨‍🔬",woman_artist:"👩‍🎨",man_artist:"👨‍🎨",woman_firefighter:"👩‍🚒",man_firefighter:"👨‍🚒",woman_pilot:"👩‍✈",man_pilot:"👨‍✈",woman_astronaut:"👩‍🚀",man_astronaut:"👨‍🚀",woman_judge:"👩‍⚖",man_judge:"👨‍⚖",mrs_claus:"🤶",santa:"🎅",princess:"👸",prince:"🤴",bride_with_veil:"👰",man_in_tuxedo:"🤵",angel:"👼",pregnant_woman:"🤰",bowing_woman:"🙇‍♀",bowing_man:"🙇",bow:"🙇",tipping_hand_woman:"💁",information_desk_person:"💁",sassy_woman:"💁",tipping_hand_man:"💁‍♂",sassy_man:"💁‍♂",no_good_woman:"🙅",no_good:"🙅",ng_woman:"🙅",no_good_man:"🙅‍♂",ng_man:"🙅‍♂",ok_woman:"🙆",ok_man:"🙆‍♂",raising_hand_woman:"🙋",raising_hand:"🙋",raising_hand_man:"🙋‍♂",woman_facepalming:"🤦‍♀",man_facepalming:"🤦‍♂",woman_shrugging:"🤷‍♀",man_shrugging:"🤷‍♂",pouting_woman:"🙎",person_with_pouting_face:"🙎",pouting_man:"🙎‍♂",frowning_woman:"🙍",person_frowning:"🙍",frowning_man:"🙍‍♂",haircut_woman:"💇",haircut:"💇",haircut_man:"💇‍♂",massage_woman:"💆",massage:"💆",massage_man:"💆‍♂",business_suit_levitating:"🕴",dancer:"💃",man_dancing:"🕺",dancing_women:"👯",dancers:"👯",dancing_men:"👯‍♂",walking_woman:"🚶‍♀",walking_man:"🚶",walking:"🚶",running_woman:"🏃‍♀",running_man:"🏃",runner:"🏃",running:"🏃",couple:"👫",two_women_holding_hands:"👭",two_men_holding_hands:"👬",couple_with_heart_woman_man:"💑",couple_with_heart:"💑",couple_with_heart_woman_woman:"👩‍❤️‍👩",couple_with_heart_man_man:"👨‍❤️‍👨",couplekiss_man_woman:"💏",couplekiss_woman_woman:"👩‍❤️‍💋‍👩",couplekiss_man_man:"👨‍❤️‍💋‍👨",family_man_woman_boy:"👪",family:"👪",family_man_woman_girl:"👨‍👩‍👧",family_man_woman_girl_boy:"👨‍👩‍👧‍👦",family_man_woman_boy_boy:"👨‍👩‍👦‍👦",family_man_woman_girl_girl:"👨‍👩‍👧‍👧",family_woman_woman_boy:"👩‍👩‍👦",family_woman_woman_girl:"👩‍👩‍👧",family_woman_woman_girl_boy:"👩‍👩‍👧‍👦",family_woman_woman_boy_boy:"👩‍👩‍👦‍👦",family_woman_woman_girl_girl:"👩‍👩‍👧‍👧",family_man_man_boy:"👨‍👨‍👦",family_man_man_girl:"👨‍👨‍👧",family_man_man_girl_boy:"👨‍👨‍👧‍👦",family_man_man_boy_boy:"👨‍👨‍👦‍👦",family_man_man_girl_girl:"👨‍👨‍👧‍👧",family_woman_boy:"👩‍👦",family_woman_girl:"👩‍👧",family_woman_girl_boy:"👩‍👧‍👦",family_woman_boy_boy:"👩‍👦‍👦",family_woman_girl_girl:"👩‍👧‍👧",family_man_boy:"👨‍👦",family_man_girl:"👨‍👧",family_man_girl_boy:"👨‍👧‍👦",family_man_boy_boy:"👨‍👦‍👦",family_man_girl_girl:"👨‍👧‍👧",womans_clothes:"👚",shirt:"👕",tshirt:"👕",jeans:"👖",necktie:"👔",dress:"👗",bikini:"👙",kimono:"👘",high_heel:"👠",sandal:"👡",boot:"👢",mans_shoe:"👞",shoe:"👞",athletic_shoe:"👟",womans_hat:"👒",tophat:"🎩",mortar_board:"🎓",crown:"👑",rescue_worker_helmet:"⛑",school_satchel:"🎒",pouch:"👝",purse:"👛",handbag:"👜",briefcase:"💼",eyeglasses:"👓",dark_sunglasses:"🕶",closed_umbrella:"🌂",open_umbrella:"☂️",dog:"🐶",cat:"🐱",mouse:"🐭",hamster:"🐹",rabbit:"🐰",fox_face:"🦊",bear:"🐻",panda_face:"🐼",koala:"🐨",tiger:"🐯",lion:"🦁",cow:"🐮",pig:"🐷",pig_nose:"🐽",frog:"🐸",monkey_face:"🐵",see_no_evil:"🙈",hear_no_evil:"🙉",speak_no_evil:"🙊",monkey:"🐒",chicken:"🐔",penguin:"🐧",bird:"🐦",baby_chick:"🐤",hatching_chick:"🐣",hatched_chick:"🐥",duck:"🦆",eagle:"🦅",owl:"🦉",bat:"🦇",wolf:"🐺",boar:"🐗",horse:"🐴",unicorn:"🦄",bee:"🐝",honeybee:"🐝",bug:"🐛",butterfly:"🦋",snail:"🐌",shell:"🐚",beetle:"🐞",ant:"🐜",spider:"🕷",spider_web:"🕸",turtle:"🐢",snake:"🐍",lizard:"🦎",scorpion:"🦂",crab:"🦀",squid:"🦑",octopus:"🐙",shrimp:"🦐",tropical_fish:"🐠",fish:"🐟",blowfish:"🐡",dolphin:"🐬",flipper:"🐬",shark:"🦈",whale:"🐳",whale2:"🐋",crocodile:"🐊",leopard:"🐆",tiger2:"🐅",water_buffalo:"🐃",ox:"🐂",cow2:"🐄",deer:"🦌",dromedary_camel:"🐪",camel:"🐫",elephant:"🐘",rhinoceros:"🦏",gorilla:"🦍",racehorse:"🐎",pig2:"🐖",goat:"🐐",ram:"🐏",sheep:"🐑",dog2:"🐕",poodle:"🐩",cat2:"🐈",rooster:"🐓",turkey:"🦃",dove:"🕊",rabbit2:"🐇",mouse2:"🐁",rat:"🐀",chipmunk:"🐿",feet:"🐾",paw_prints:"🐾",dragon:"🐉",dragon_face:"🐲",cactus:"🌵",christmas_tree:"🎄",evergreen_tree:"🌲",deciduous_tree:"🌳",palm_tree:"🌴",seedling:"🌱",herb:"🌿",shamrock:"☘️",four_leaf_clover:"🍀",bamboo:"🎍",tanabata_tree:"🎋",leaves:"🍃",fallen_leaf:"🍂",maple_leaf:"🍁",mushroom:"🍄",ear_of_rice:"🌾",bouquet:"💐",tulip:"🌷",rose:"🌹",wilted_flower:"🥀",sunflower:"🌻",blossom:"🌼",cherry_blossom:"🌸",hibiscus:"🌺",earth_americas:"🌎",earth_africa:"🌍",earth_asia:"🌏",full_moon:"🌕",waning_gibbous_moon:"🌖",last_quarter_moon:"🌗",waning_crescent_moon:"🌘",new_moon:"🌑",waxing_crescent_moon:"🌒",first_quarter_moon:"🌓",moon:"🌔",waxing_gibbous_moon:"🌔",new_moon_with_face:"🌚",full_moon_with_face:"🌝",sun_with_face:"🌞",first_quarter_moon_with_face:"🌛",last_quarter_moon_with_face:"🌜",crescent_moon:"🌙",dizzy:"💫",star:"⭐️",star2:"🌟",sparkles:"✨",zap:"⚡️",fire:"🔥",boom:"💥",collision:"💥",comet:"☄",sunny:"☀️",sun_behind_small_cloud:"🌤",partly_sunny:"⛅️",sun_behind_large_cloud:"🌥",sun_behind_rain_cloud:"🌦",rainbow:"🌈",cloud:"☁️",cloud_with_rain:"🌧",cloud_with_lightning_and_rain:"⛈",cloud_with_lightning:"🌩",cloud_with_snow:"🌨",snowman_with_snow:"☃️",snowman:"⛄️",snowflake:"❄️",wind_face:"🌬",dash:"💨",tornado:"🌪",fog:"🌫",ocean:"🌊",droplet:"💧",sweat_drops:"💦",umbrella:"☔️",green_apple:"🍏",apple:"🍎",pear:"🍐",tangerine:"🍊",orange:"🍊",mandarin:"🍊",lemon:"🍋",banana:"🍌",watermelon:"🍉",grapes:"🍇",strawberry:"🍓",melon:"🍈",cherries:"🍒",peach:"🍑",pineapple:"🍍",kiwi_fruit:"🥝",avocado:"🥑",tomato:"🍅",eggplant:"🍆",cucumber:"🥒",carrot:"🥕",corn:"🌽",hot_pepper:"🌶",potato:"🥔",sweet_potato:"🍠",chestnut:"🌰",peanuts:"🥜",honey_pot:"🍯",croissant:"🥐",bread:"🍞",baguette_bread:"🥖",cheese:"🧀",egg:"🥚",fried_egg:"🍳",bacon:"🥓",pancakes:"🥞",fried_shrimp:"🍤",poultry_leg:"🍗",meat_on_bone:"🍖",pizza:"🍕",hotdog:"🌭",hamburger:"🍔",fries:"🍟",stuffed_flatbread:"🥙",taco:"🌮",burrito:"🌯",green_salad:"🥗",shallow_pan_of_food:"🥘",spaghetti:"🍝",ramen:"🍜",stew:"🍲",fish_cake:"🍥",sushi:"🍣",bento:"🍱",curry:"🍛",rice:"🍚",rice_ball:"🍙",rice_cracker:"🍘",oden:"🍢",dango:"🍡",shaved_ice:"🍧",ice_cream:"🍨",icecream:"🍦",cake:"🍰",birthday:"🎂",custard:"🍮",lollipop:"🍭",candy:"🍬",chocolate_bar:"🍫",popcorn:"🍿",doughnut:"🍩",cookie:"🍪",milk_glass:"🥛",baby_bottle:"🍼",coffee:"☕️",tea:"🍵",sake:"🍶",beer:"🍺",beers:"🍻",clinking_glasses:"🥂",wine_glass:"🍷",tumbler_glass:"🥃",cocktail:"🍸",tropical_drink:"🍹",champagne:"🍾",spoon:"🥄",fork_and_knife:"🍴",plate_with_cutlery:"🍽",soccer:"⚽️",basketball:"🏀",football:"🏈",baseball:"⚾️",tennis:"🎾",volleyball:"🏐",rugby_football:"🏉","8ball":"🎱",ping_pong:"🏓",badminton:"🏸",goal_net:"🥅",ice_hockey:"🏒",field_hockey:"🏑",cricket:"🏏",golf:"⛳️",bow_and_arrow:"🏹",fishing_pole_and_fish:"🎣",boxing_glove:"🥊",martial_arts_uniform:"🥋",ice_skate:"⛸",ski:"🎿",skier:"⛷",snowboarder:"🏂",weight_lifting_woman:"🏋️‍♀️",weight_lifting_man:"🏋",person_fencing:"🤺",women_wrestling:"🤼‍♀",men_wrestling:"🤼‍♂",woman_cartwheeling:"🤸‍♀",man_cartwheeling:"🤸‍♂",basketball_woman:"⛹️‍♀️",basketball_man:"⛹",woman_playing_handball:"🤾‍♀",man_playing_handball:"🤾‍♂",golfing_woman:"🏌️‍♀️",golfing_man:"🏌",surfing_woman:"🏄‍♀",surfing_man:"🏄",surfer:"🏄",swimming_woman:"🏊‍♀",swimming_man:"🏊",swimmer:"🏊",woman_playing_water_polo:"🤽‍♀",man_playing_water_polo:"🤽‍♂",rowing_woman:"🚣‍♀",rowing_man:"🚣",rowboat:"🚣",horse_racing:"🏇",biking_woman:"🚴‍♀",biking_man:"🚴",bicyclist:"🚴",mountain_biking_woman:"🚵‍♀",mountain_biking_man:"🚵",mountain_bicyclist:"🚵",running_shirt_with_sash:"🎽",medal_sports:"🏅",medal_military:"🎖","1st_place_medal":"🥇","2nd_place_medal":"🥈","3rd_place_medal":"🥉",trophy:"🏆",rosette:"🏵",reminder_ribbon:"🎗",ticket:"🎫",tickets:"🎟",circus_tent:"🎪",woman_juggling:"🤹‍♀",man_juggling:"🤹‍♂",performing_arts:"🎭",art:"🎨",clapper:"🎬",microphone:"🎤",headphones:"🎧",musical_score:"🎼",musical_keyboard:"🎹",drum:"🥁",saxophone:"🎷",trumpet:"🎺",guitar:"🎸",violin:"🎻",game_die:"🎲",dart:"🎯",bowling:"🎳",video_game:"🎮",slot_machine:"🎰",car:"🚗",red_car:"🚗",taxi:"🚕",blue_car:"🚙",bus:"🚌",trolleybus:"🚎",racing_car:"🏎",police_car:"🚓",ambulance:"🚑",fire_engine:"🚒",minibus:"🚐",truck:"🚚",articulated_lorry:"🚛",tractor:"🚜",kick_scooter:"🛴",bike:"🚲",motor_scooter:"🛵",motorcycle:"🏍",rotating_light:"🚨",oncoming_police_car:"🚔",oncoming_bus:"🚍",oncoming_automobile:"🚘",oncoming_taxi:"🚖",aerial_tramway:"🚡",mountain_cableway:"🚠",suspension_railway:"🚟",railway_car:"🚃",train:"🚋",mountain_railway:"🚞",monorail:"🚝",bullettrain_side:"🚄",bullettrain_front:"🚅",light_rail:"🚈",steam_locomotive:"🚂",train2:"🚆",metro:"🚇",tram:"🚊",station:"🚉",helicopter:"🚁",small_airplane:"🛩",airplane:"✈️",flight_departure:"🛫",flight_arrival:"🛬",rocket:"🚀",artificial_satellite:"🛰",seat:"💺",canoe:"🛶",boat:"⛵️",sailboat:"⛵️",motor_boat:"🛥",speedboat:"🚤",passenger_ship:"🛳",ferry:"⛴",ship:"🚢",anchor:"⚓️",construction:"🚧",fuelpump:"⛽️",busstop:"🚏",vertical_traffic_light:"🚦",traffic_light:"🚥",world_map:"🗺",moyai:"🗿",statue_of_liberty:"🗽",fountain:"⛲️",tokyo_tower:"🗼",european_castle:"🏰",japanese_castle:"🏯",stadium:"🏟",ferris_wheel:"🎡",roller_coaster:"🎢",carousel_horse:"🎠",parasol_on_ground:"⛱",beach_umbrella:"🏖",desert_island:"🏝",mountain:"⛰",mountain_snow:"🏔",mount_fuji:"🗻",volcano:"🌋",desert:"🏜",camping:"🏕",tent:"⛺️",railway_track:"🛤",motorway:"🛣",building_construction:"🏗",factory:"🏭",house:"🏠",house_with_garden:"🏡",houses:"🏘",derelict_house:"🏚",office:"🏢",department_store:"🏬",post_office:"🏣",european_post_office:"🏤",hospital:"🏥",bank:"🏦",hotel:"🏨",convenience_store:"🏪",school:"🏫",love_hotel:"🏩",wedding:"💒",classical_building:"🏛",church:"⛪️",mosque:"🕌",synagogue:"🕍",kaaba:"🕋",shinto_shrine:"⛩",japan:"🗾",rice_scene:"🎑",national_park:"🏞",sunrise:"🌅",sunrise_over_mountains:"🌄",stars:"🌠",sparkler:"🎇",fireworks:"🎆",city_sunrise:"🌇",city_sunset:"🌆",cityscape:"🏙",night_with_stars:"🌃",milky_way:"🌌",bridge_at_night:"🌉",foggy:"🌁",watch:"⌚️",iphone:"📱",calling:"📲",computer:"💻",keyboard:"⌨️",desktop_computer:"🖥",printer:"🖨",computer_mouse:"🖱",trackball:"🖲",joystick:"🕹",clamp:"🗜",minidisc:"💽",floppy_disk:"💾",cd:"💿",dvd:"📀",vhs:"📼",camera:"📷",camera_flash:"📸",video_camera:"📹",movie_camera:"🎥",film_projector:"📽",film_strip:"🎞",telephone_receiver:"📞",phone:"☎️",telephone:"☎️",pager:"📟",fax:"📠",tv:"📺",radio:"📻",studio_microphone:"🎙",level_slider:"🎚",control_knobs:"🎛",stopwatch:"⏱",timer_clock:"⏲",alarm_clock:"⏰",mantelpiece_clock:"🕰",hourglass:"⌛️",hourglass_flowing_sand:"⏳",satellite:"📡",battery:"🔋",electric_plug:"🔌",bulb:"💡",flashlight:"🔦",candle:"🕯",wastebasket:"🗑",oil_drum:"🛢",money_with_wings:"💸",dollar:"💵",yen:"💴",euro:"💶",pound:"💷",moneybag:"💰",credit_card:"💳",gem:"💎",balance_scale:"⚖️",wrench:"🔧",hammer:"🔨",hammer_and_pick:"⚒",hammer_and_wrench:"🛠",pick:"⛏",nut_and_bolt:"🔩",gear:"⚙️",chains:"⛓",gun:"🔫",bomb:"💣",hocho:"🔪",knife:"🔪",dagger:"🗡",crossed_swords:"⚔️",shield:"🛡",smoking:"🚬",coffin:"⚰️",funeral_urn:"⚱️",amphora:"🏺",crystal_ball:"🔮",prayer_beads:"📿",barber:"💈",alembic:"⚗️",telescope:"🔭",microscope:"🔬",hole:"🕳",pill:"💊",syringe:"💉",thermometer:"🌡",toilet:"🚽",potable_water:"🚰",shower:"🚿",bathtub:"🛁",bath:"🛀",bellhop_bell:"🛎",key:"🔑",old_key:"🗝",door:"🚪",couch_and_lamp:"🛋",bed:"🛏",sleeping_bed:"🛌",framed_picture:"🖼",shopping:"🛍",shopping_cart:"🛒",gift:"🎁",balloon:"🎈",flags:"🎏",ribbon:"🎀",confetti_ball:"🎊",tada:"🎉",dolls:"🎎",izakaya_lantern:"🏮",lantern:"🏮",wind_chime:"🎐",email:"✉️",envelope:"✉️",envelope_with_arrow:"📩",incoming_envelope:"📨","e-mail":"📧",love_letter:"💌",inbox_tray:"📥",outbox_tray:"📤",package:"📦",label:"🏷",mailbox_closed:"📪",mailbox:"📫",mailbox_with_mail:"📬",mailbox_with_no_mail:"📭",postbox:"📮",postal_horn:"📯",scroll:"📜",page_with_curl:"📃",page_facing_up:"📄",bookmark_tabs:"📑",bar_chart:"📊",chart_with_upwards_trend:"📈",chart_with_downwards_trend:"📉",spiral_notepad:"🗒",spiral_calendar:"🗓",calendar:"📆",date:"📅",card_index:"📇",card_file_box:"🗃",ballot_box:"🗳",file_cabinet:"🗄",clipboard:"📋",file_folder:"📁",open_file_folder:"📂",card_index_dividers:"🗂",newspaper_roll:"🗞",newspaper:"📰",notebook:"📓",notebook_with_decorative_cover:"📔",ledger:"📒",closed_book:"📕",green_book:"📗",blue_book:"📘",orange_book:"📙",books:"📚",book:"📖",open_book:"📖",bookmark:"🔖",link:"🔗",paperclip:"📎",paperclips:"🖇",triangular_ruler:"📐",straight_ruler:"📏",pushpin:"📌",round_pushpin:"📍",scissors:"✂️",pen:"🖊",fountain_pen:"🖋",black_nib:"✒️",paintbrush:"🖌",crayon:"🖍",memo:"📝",pencil:"📝",pencil2:"✏️",mag:"🔍",mag_right:"🔎",lock_with_ink_pen:"🔏",closed_lock_with_key:"🔐",lock:"🔒",unlock:"🔓",heart:"❤️",yellow_heart:"💛",green_heart:"💚",blue_heart:"💙",purple_heart:"💜",black_heart:"🖤",broken_heart:"💔",heavy_heart_exclamation:"❣️",two_hearts:"💕",revolving_hearts:"💞",heartbeat:"💓",heartpulse:"💗",sparkling_heart:"💖",cupid:"💘",gift_heart:"💝",heart_decoration:"💟",peace_symbol:"☮️",latin_cross:"✝️",star_and_crescent:"☪️",om:"🕉",wheel_of_dharma:"☸️",star_of_david:"✡️",six_pointed_star:"🔯",menorah:"🕎",yin_yang:"☯️",orthodox_cross:"☦️",place_of_worship:"🛐",ophiuchus:"⛎",aries:"♈️",taurus:"♉️",gemini:"♊️",cancer:"♋️",leo:"♌️",virgo:"♍️",libra:"♎️",scorpius:"♏️",sagittarius:"♐️",capricorn:"♑️",aquarius:"♒️",pisces:"♓️",id:"🆔",atom_symbol:"⚛️",accept:"🉑",radioactive:"☢️",biohazard:"☣️",mobile_phone_off:"📴",vibration_mode:"📳",eight_pointed_black_star:"✴️",vs:"🆚",white_flower:"💮",ideograph_advantage:"🉐",secret:"㊙️",congratulations:"㊗️",u6e80:"🈵",a:"🅰️",b:"🅱️",ab:"🆎",cl:"🆑",o2:"🅾️",sos:"🆘",x:"❌",o:"⭕️",stop_sign:"🛑",no_entry:"⛔️",name_badge:"📛",no_entry_sign:"🚫",anger:"💢",hotsprings:"♨️",no_pedestrians:"🚷",do_not_litter:"🚯",no_bicycles:"🚳","non-potable_water":"🚱",underage:"🔞",no_mobile_phones:"📵",no_smoking:"🚭",exclamation:"❗️",heavy_exclamation_mark:"❗️",grey_exclamation:"❕",question:"❓",grey_question:"❔",bangbang:"‼️",interrobang:"⁉️",low_brightness:"🔅",high_brightness:"🔆",part_alternation_mark:"〽️",warning:"⚠️",children_crossing:"🚸",trident:"🔱",fleur_de_lis:"⚜️",beginner:"🔰",recycle:"♻️",white_check_mark:"✅",chart:"💹",sparkle:"❇️",eight_spoked_asterisk:"✳️",negative_squared_cross_mark:"❎",globe_with_meridians:"🌐",diamond_shape_with_a_dot_inside:"💠",m:"Ⓜ️",cyclone:"🌀",zzz:"💤",atm:"🏧",wc:"🚾",wheelchair:"♿️",parking:"🅿️",sa:"🈂️",passport_control:"🛂",customs:"🛃",baggage_claim:"🛄",left_luggage:"🛅",mens:"🚹",womens:"🚺",baby_symbol:"🚼",restroom:"🚻",put_litter_in_its_place:"🚮",cinema:"🎦",signal_strength:"📶",koko:"🈁",symbols:"🔣",information_source:"ℹ️",abc:"🔤",abcd:"🔡",capital_abcd:"🔠",ng:"🆖",ok:"🆗",up:"🆙",cool:"🆒",new:"🆕",free:"🆓",zero:"0️⃣",one:"1️⃣",two:"2️⃣",three:"3️⃣",four:"4️⃣",five:"5️⃣",six:"6️⃣",seven:"7️⃣",eight:"8️⃣",nine:"9️⃣",keycap_ten:"🔟",hash:"#️⃣",asterisk:"*️⃣",arrow_forward:"▶️",pause_button:"⏸",play_or_pause_button:"⏯",stop_button:"⏹",record_button:"⏺",next_track_button:"⏭",previous_track_button:"⏮",fast_forward:"⏩",rewind:"⏪",arrow_double_up:"⏫",arrow_double_down:"⏬",arrow_backward:"◀️",arrow_up_small:"🔼",arrow_down_small:"🔽",arrow_right:"➡️",arrow_left:"⬅️",arrow_up:"⬆️",arrow_down:"⬇️",arrow_upper_right:"↗️",arrow_lower_right:"↘️",arrow_lower_left:"↙️",arrow_upper_left:"↖️",arrow_up_down:"↕️",left_right_arrow:"↔️",arrow_right_hook:"↪️",leftwards_arrow_with_hook:"↩️",arrow_heading_up:"⤴️",arrow_heading_down:"⤵️",twisted_rightwards_arrows:"🔀",repeat:"🔁",repeat_one:"🔂",arrows_counterclockwise:"🔄",arrows_clockwise:"🔃",musical_note:"🎵",notes:"🎶",heavy_plus_sign:"➕",heavy_minus_sign:"➖",heavy_division_sign:"➗",heavy_multiplication_x:"✖️",heavy_dollar_sign:"💲",currency_exchange:"💱",tm:"™️",copyright:"©️",registered:"®️",wavy_dash:"〰️",curly_loop:"➰",loop:"➿",end:"🔚",back:"🔙",on:"🔛",top:"🔝",soon:"🔜",heavy_check_mark:"✔️",ballot_box_with_check:"☑️",radio_button:"🔘",white_circle:"⚪️",black_circle:"⚫️",red_circle:"🔴",large_blue_circle:"🔵",small_red_triangle:"🔺",small_red_triangle_down:"🔻",small_orange_diamond:"🔸",small_blue_diamond:"🔹",large_orange_diamond:"🔶",large_blue_diamond:"🔷",white_square_button:"🔳",black_square_button:"🔲",black_small_square:"▪️",white_small_square:"▫️",black_medium_small_square:"◾️",white_medium_small_square:"◽️",black_medium_square:"◼️",white_medium_square:"◻️",black_large_square:"⬛️",white_large_square:"⬜️",speaker:"🔈",mute:"🔇",sound:"🔉",loud_sound:"🔊",bell:"🔔",no_bell:"🔕",mega:"📣",loudspeaker:"📢",eye_speech_bubble:"👁‍🗨",speech_balloon:"💬",thought_balloon:"💭",right_anger_bubble:"🗯",spades:"♠️",clubs:"♣️",hearts:"♥️",diamonds:"♦️",black_joker:"🃏",flower_playing_cards:"🎴",mahjong:"🀄️",clock1:"🕐",clock2:"🕑",clock3:"🕒",clock4:"🕓",clock5:"🕔",clock6:"🕕",clock7:"🕖",clock8:"🕗",clock9:"🕘",clock10:"🕙",clock11:"🕚",clock12:"🕛",clock130:"🕜",clock230:"🕝",clock330:"🕞",clock430:"🕟",clock530:"🕠",clock630:"🕡",clock730:"🕢",clock830:"🕣",clock930:"🕤",clock1030:"🕥",clock1130:"🕦",clock1230:"🕧",white_flag:"🏳️",black_flag:"🏴",checkered_flag:"🏁",triangular_flag_on_post:"🚩",rainbow_flag:"🏳️‍🌈",afghanistan:"🇦🇫",aland_islands:"🇦🇽",albania:"🇦🇱",algeria:"🇩🇿",american_samoa:"🇦🇸",andorra:"🇦🇩",angola:"🇦🇴",anguilla:"🇦🇮",antarctica:"🇦🇶",antigua_barbuda:"🇦🇬",argentina:"🇦🇷",armenia:"🇦🇲",aruba:"🇦🇼",australia:"🇦🇺",austria:"🇦🇹",azerbaijan:"🇦🇿",bahamas:"🇧🇸",bahrain:"🇧🇭",bangladesh:"🇧🇩",barbados:"🇧🇧",belarus:"🇧🇾",belgium:"🇧🇪",belize:"🇧🇿",benin:"🇧🇯",bermuda:"🇧🇲",bhutan:"🇧🇹",bolivia:"🇧🇴",caribbean_netherlands:"🇧🇶",bosnia_herzegovina:"🇧🇦",botswana:"🇧🇼",brazil:"🇧🇷",british_indian_ocean_territory:"🇮🇴",british_virgin_islands:"🇻🇬",brunei:"🇧🇳",bulgaria:"🇧🇬",burkina_faso:"🇧🇫",burundi:"🇧🇮",cape_verde:"🇨🇻",cambodia:"🇰🇭",cameroon:"🇨🇲",canada:"🇨🇦",canary_islands:"🇮🇨",cayman_islands:"🇰🇾",central_african_republic:"🇨🇫",chad:"🇹🇩",chile:"🇨🇱",cn:"🇨🇳",christmas_island:"🇨🇽",cocos_islands:"🇨🇨",colombia:"🇨🇴",comoros:"🇰🇲",congo_brazzaville:"🇨🇬",congo_kinshasa:"🇨🇩",cook_islands:"🇨🇰",costa_rica:"🇨🇷",cote_divoire:"🇨🇮",croatia:"🇭🇷",cuba:"🇨🇺",curacao:"🇨🇼",cyprus:"🇨🇾",czech_republic:"🇨🇿",denmark:"🇩🇰",djibouti:"🇩🇯",dominica:"🇩🇲",dominican_republic:"🇩🇴",ecuador:"🇪🇨",egypt:"🇪🇬",el_salvador:"🇸🇻",equatorial_guinea:"🇬🇶",eritrea:"🇪🇷",estonia:"🇪🇪",ethiopia:"🇪🇹",eu:"🇪🇺",european_union:"🇪🇺",falkland_islands:"🇫🇰",faroe_islands:"🇫🇴",fiji:"🇫🇯",finland:"🇫🇮",fr:"🇫🇷",french_guiana:"🇬🇫",french_polynesia:"🇵🇫",french_southern_territories:"🇹🇫",gabon:"🇬🇦",gambia:"🇬🇲",georgia:"🇬🇪",de:"🇩🇪",ghana:"🇬🇭",gibraltar:"🇬🇮",greece:"🇬🇷",greenland:"🇬🇱",grenada:"🇬🇩",guadeloupe:"🇬🇵",guam:"🇬🇺",guatemala:"🇬🇹",guernsey:"🇬🇬",guinea:"🇬🇳",guinea_bissau:"🇬🇼",guyana:"🇬🇾",haiti:"🇭🇹",honduras:"🇭🇳",hong_kong:"🇭🇰",hungary:"🇭🇺",iceland:"🇮🇸",india:"🇮🇳",indonesia:"🇮🇩",iran:"🇮🇷",iraq:"🇮🇶",ireland:"🇮🇪",isle_of_man:"🇮🇲",israel:"🇮🇱",it:"🇮🇹",jamaica:"🇯🇲",jp:"🇯🇵",crossed_flags:"🎌",jersey:"🇯🇪",jordan:"🇯🇴",kazakhstan:"🇰🇿",kenya:"🇰🇪",kiribati:"🇰🇮",kosovo:"🇽🇰",kuwait:"🇰🇼",kyrgyzstan:"🇰🇬",laos:"🇱🇦",latvia:"🇱🇻",lebanon:"🇱🇧",lesotho:"🇱🇸",liberia:"🇱🇷",libya:"🇱🇾",liechtenstein:"🇱🇮",lithuania:"🇱🇹",luxembourg:"🇱🇺",macau:"🇲🇴",macedonia:"🇲🇰",madagascar:"🇲🇬",malawi:"🇲🇼",malaysia:"🇲🇾",maldives:"🇲🇻",mali:"🇲🇱",malta:"🇲🇹",marshall_islands:"🇲🇭",martinique:"🇲🇶",mauritania:"🇲🇷",mauritius:"🇲🇺",mayotte:"🇾🇹",mexico:"🇲🇽",micronesia:"🇫🇲",moldova:"🇲🇩",monaco:"🇲🇨",mongolia:"🇲🇳",montenegro:"🇲🇪",montserrat:"🇲🇸",morocco:"🇲🇦",mozambique:"🇲🇿",myanmar:"🇲🇲",namibia:"🇳🇦",nauru:"🇳🇷",nepal:"🇳🇵",netherlands:"🇳🇱",new_caledonia:"🇳🇨",new_zealand:"🇳🇿",nicaragua:"🇳🇮",niger:"🇳🇪",nigeria:"🇳🇬",niue:"🇳🇺",norfolk_island:"🇳🇫",northern_mariana_islands:"🇲🇵",north_korea:"🇰🇵",norway:"🇳🇴",oman:"🇴🇲",pakistan:"🇵🇰",palau:"🇵🇼",palestinian_territories:"🇵🇸",panama:"🇵🇦",papua_new_guinea:"🇵🇬",paraguay:"🇵🇾",peru:"🇵🇪",philippines:"🇵🇭",pitcairn_islands:"🇵🇳",poland:"🇵🇱",portugal:"🇵🇹",puerto_rico:"🇵🇷",qatar:"🇶🇦",reunion:"🇷🇪",romania:"🇷🇴",ru:"🇷🇺",rwanda:"🇷🇼",st_barthelemy:"🇧🇱",st_helena:"🇸🇭",st_kitts_nevis:"🇰🇳",st_lucia:"🇱🇨",st_pierre_miquelon:"🇵🇲",st_vincent_grenadines:"🇻🇨",samoa:"🇼🇸",san_marino:"🇸🇲",sao_tome_principe:"🇸🇹",saudi_arabia:"🇸🇦",senegal:"🇸🇳",serbia:"🇷🇸",seychelles:"🇸🇨",sierra_leone:"🇸🇱",singapore:"🇸🇬",sint_maarten:"🇸🇽",slovakia:"🇸🇰",slovenia:"🇸🇮",solomon_islands:"🇸🇧",somalia:"🇸🇴",south_africa:"🇿🇦",south_georgia_south_sandwich_islands:"🇬🇸",kr:"🇰🇷",south_sudan:"🇸🇸",es:"🇪🇸",sri_lanka:"🇱🇰",sudan:"🇸🇩",suriname:"🇸🇷",swaziland:"🇸🇿",sweden:"🇸🇪",switzerland:"🇨🇭",syria:"🇸🇾",taiwan:"🇹🇼",tajikistan:"🇹🇯",tanzania:"🇹🇿",thailand:"🇹🇭",timor_leste:"🇹🇱",togo:"🇹🇬",tokelau:"🇹🇰",tonga:"🇹🇴",trinidad_tobago:"🇹🇹",tunisia:"🇹🇳",tr:"🇹🇷",turkmenistan:"🇹🇲",turks_caicos_islands:"🇹🇨",tuvalu:"🇹🇻",uganda:"🇺🇬",ukraine:"🇺🇦",united_arab_emirates:"🇦🇪",gb:"🇬🇧",uk:"🇬🇧",us:"🇺🇸",us_virgin_islands:"🇻🇮",uruguay:"🇺🇾",uzbekistan:"🇺🇿",vanuatu:"🇻🇺",vatican_city:"🇻🇦",venezuela:"🇻🇪",vietnam:"🇻🇳",wallis_futuna:"🇼🇫",western_sahara:"🇪🇭",yemen:"🇾🇪",zambia:"🇿🇲",zimbabwe:"🇿🇼"},n.exports=r}),define("app/document/Node2Mark",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var i=e("app/document/Node"),r=i.Node,o=i.NodeMap,a=i.TYPE,s=(e("app/document/StringUtils"),/\uE027/gi),l=["-","+","*"];r.UL_DEFAULT_START=l,r.prototype.toMark=function(){var e=c.call(this);return e instanceof Array?e.join(File.useCRLF?"\r\n":"\n").replace(s,""):e};var c=function(){function e(e){if(e.get("children").length)return p(e.get("children"));var t=e.get("text")?e.get("text"):"";return t=t.replace(/(\u200B*):(\u200B*)/g,":").replace(/\u200B\$/,"$")}function t(e,t){i(e,t.get("ahead")||0)}function n(e,t,n){void 0===n&&(n=t.get("after")?1:0),i(e,void 0==t.get("tail")?n:t.get("tail"))}function i(e,t){for(var n=0;n<t;n++)e.push("")}function o(e){return r.isType(e.get("parent"),a.list_item)&&!1!==e.get("parent").get("tight")}var l,f,m,g=[];try{switch(this.get("type")){case a.meta_block:return g.push("---"),(g=g.concat((this.get("text")||"").replace(/^---/gm,"​---").split(/\r*\n/))).push("---"),n(g,this),g;case a.heading:return t(g,this),this.get("pattern")?g=g.concat(this.get("pattern").replace("{0}",e(this)).split(/\r*\n/)):!r.isType(this.get("parent"),a.list_item)&&File.option.headingStyle&&this.get("depth")<=2?(g.push(e(this)),g.push(1==this.get("depth")?"===":"---")):g.push("#".repeat(this.get("depth"))+" "+e(this)),n(g,this),g;case a.paragraph:return t(g,this),f=e(this),g=g.concat(f),void 0===(E=this.get("tail"))&&this.get("after")&&r.isType(this.get("parent"),a.list_item)&&(E=o(this)?0:void 0),r.isType(this.get("after"),a.paragraph)&&E<1&&this.unset("tail"),r.isType(this.get("after"),a.math_block)&&!this.get("tail")&&(E=0),void 0===E?n(g,this,E):i(g,E),g;case a.line:return f=(this.get("text")||"").replace(/\r*\n+/g,""),f=f.replace(/^( {4}|\t)/gm,"​$1"),g.push(f),g;case a.blockquote:return t(g,this),f=e(this),m=h(a.blockquote,0,this,this.get("pattern")),f.map(function(e,t){f[t]=e?m+e:m.replace(/\s+$/,"")}),g=g.concat(f),n(g,this),""!==g.last()&&r.isType(this.get("after"),a.blockquote)&&g.push(""),g;case a.list:t(g,this);var v=this.get("style"),y=this.isLoose(),b=this.get("children").length,w=this;if(b)for(var x=this.getFirstChild(),C=Number.isNaN(Number.parseInt(this.get("start")))?0:Number.parseInt(this.get("start"))-1,k=0;x;){x.set("tight",!y),f=c.call(x),l=this.get("pattern"),y&&l&&x.get("markindent")&&(l=u(v,l.trim(),x.get("markindent"))),x.get("prespace")&&(l=" ".repeat(x.get("prespace"))+l);var S=(m=h(v,k+C,x,l,(b+"").length)).length,T=v==r.ListType.ol?(k+C+"").length-1:0;x.get("subindent")?S=Math.min(m.replace(/\s+$/,"").length+4,x.get("subindent")+T):w.get("subindent")&&(S=Math.min(m.replace(/\s+$/,"").length+4,w.get("subindent")+T)),f.map(function(e,t){f[t]=(t?e?" ".repeat(S):"":m)+f[t],g.push(f[t].replace(s,"​"))}),k++,x=x.get("after")}return r.isType(this.get("after"),a.list)&&(!this.get("tail")||this.get("tail"))<2&&this.get("pattern")==this.get("after").get("pattern")&&this.get("style")==this.get("after").get("style")&&(this.unset("tail"),g.push(""),o(this)&&g.push("")),n(g,this,o(this)?0:void 0),g;case a.list_item:(f=e(this))instanceof Array?g=g.concat(f):g.push(f);var E=this.get("tail");for(void 0==E&&!this.get("tight")&&this.get("after")&&(E=1),E>0&&g.push("");g.length>2&&""===g.last()&&""===g[g.length-2];)g.pop();return g;case a.fences:t(g,this);var F=this.getText();f=F.split(/\r*\n/),this.get("lang")?(this.get("pattern")||"").trim()?l=this.get("pattern"):(this.unset("pattern"),l="```{0}"):l=this.get("pattern")||"```{0}";for(var _=l.match(/^\s+$/),k=0;k<f.length;k++)f[k]=(_?l:"")+f[k].replace(/^(`{3}|~{3})/gi,"​$1");return!_&&g.push(l.replace(/\{0\}/,this.get("lang")||"")),g=g.concat(f),!_&&g.push(l.replace(/\s*\{0\}/,"")),n(g,this),g;case a.math_block:return t(g,this),g.push("$$"),(g=g.concat(this.get("text").replace(/(^\n)|(\n$)/g,"").split(/\r?\n/))).push("$$"),n(g,this,r.isType(this.get("after"),a.paragraph)&&r.isType(this.get("before"),a.paragraph)?0:1),g;case a.hr:return g.push(this.get("pattern")||"------"),n(g,this),g;case a.def_footnote:return t(g,this),g.push("[^"+this.get("ref")+"]: "+e(this)),n(g,this,!this.get("after")||r.isType(this.get("after"),r.TYPE.def_footnote)?0:1),g;case a.def_link:t(g,this);var M,N=this.safeGetStrAttr("title",!0).length;if(this.get("pattern")){var L=this.get("pattern").split(";");M=L[0]+this.get("ref")+L[1]+this.safeGetStrAttr("href",!0)+L[2],N&&(M+=(L[3]||"\t")+'"'+this.get("title")+'"')}else M="["+this.get("ref")+"]: "+this.safeGetStrAttr("href",!0)+(N?'\t"'+this.get("title")+'"':"");return g.push(M),n(g,this,!this.get("after")||r.isType(this.get("after"),r.TYPE.def_link)?0:1),g;case a.table:t(g,this);for(var A,R,I,P,O,D=[],B=[],j=0,H=this.getFirstChild();H;){for(A=H.getFirstChild(),B[j]=[],R=0;A;)B[j][R]=A.toMark().trim(),A=A.get("after"),0===j&&(D[R]=4),D[R]=Math.max(B[j][R].length,D[R]),D[R]=Math.min(D[R],40),R++;H=H.get("after"),j++}for(j=0;j<B.length;j++){for($="| ",R=0;R<D.length;R++)I=Math.max(D[R]-B[j][R].length,0),"right"==(P=this.get("align")[R])?$+=" ".repeat(I)+B[j][R]:"center"==P?(O=~~(I/2),$+=" ".repeat(O)+B[j][R]+" ".repeat(I-O)):$+=B[j][R]+" ".repeat(I),$+=" | ";if(g.push($.replace(/\s$/,"")),0===j){for($="| ",R=0;R<D.length;R++)$+="right"==(P=this.get("align")[R])?"-".repeat(D[R]-1)+":":"center"==P?":"+"-".repeat(D[R]-2)+":":"left"==P?":"+"-".repeat(D[R]-1):"-".repeat(D[R]),$+=" | ";g.push($.replace(/\s$/,""))}}return n(g,this),g;case a.table_row:for(var x=this.getFirstChild(),$="| ";x;)$+=x.toMark()+" | ";return $.replace(/\s$/,"");case a.table_cell:return d(e(this));case a.toc:return t(g,this),g.push(this.get("pattern")||"[TOC]"),~(this.get("pattern")||"").indexOf("\n")&&this.get("after")?n(g,this,2):n(g,this),g;default:return e(this)}}catch(e){return console.error(e.stack),g}},d=function(e){var t=[],n=0,i=0;return e=e.replace(/(^|[^\\])`[^`]*\|[^`]*`/g,function(e){return t.push(e),n++,["",n-1,""].join("")}),File.option.enableInlineMath&&(e=e.replace(/(^|[^\\])\$[^$]*\|[^$]*\$/g,function(e){return t.push(e),n++,["",n-1,""].join("")})),e.replace(/\|/g,"\\|").replace(/\\\\\|/g,"\\|").replace(/\uE07A[^\uE07B]+\uE07B/g,function(){return i++,t[i-1]})},u=function(e,t,n){return n=n||File.option.indentSize,e==a.blockquote?">"+" ".repeat(Math.min(n-1,4)):e===r.ListType.ol?"{0}."+" ".repeat(Math.min(n-2,4)||1):e===r.ListType.ul?(t||l[File.option.ulStyle])+" ".repeat(Math.min(n-1,4)):l[File.option.ulStyle]+" "},h=function(e,t,n,i){var o=File.option.indentSize;return t++,i=i||u(e),(!$.isNumeric(o)||o<2)&&(o=2),e==a.blockquote?i:e===r.ListType.ol?i.replace("{0}",t):e===r.ListType.ul?i:i+(n.get("checked")?"[x] ":"[ ] ")};r.getIndentPrefix=h,r.markFromArr=function(e){var t=p(e);return t instanceof Array?t.join(File.useCRLF?"\r\n":"\n").replace(s,""):t};var p=function(e){function t(e){var t=c.call(e);t instanceof Array?n=n.concat(t):i+=t}var n=[],i="";if(e.length)if(e instanceof Array)e.map(function(e){t(e)});else{var r=e.sortedFirst();do{t(r),r=r.get("after")}while(r)}return n.length?n:i};o.prototype.toMark=function(){if(this.blocks.length>0){var e=this.blocks.sortedFirst();e=e.getLastBrother(!0);var t=[],n="";do{var i=c.call(e);i instanceof Array?t=t.concat(i):n+=i,e=e.get("after")}while(e);return t.length?t.join(File.useCRLF?"\r\n":"\n").replace(s,""):n}return""},r.getIndentPrefix=h}),define("app/document/Node2HTML",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var i=e("app/document/Node"),r=i.Node,o=(i.NodeMap,i.TYPE),a=(i.NodeCollectionUtils,e("app/document/StringUtils")),s=e("app/document/MarkParser");window.resizeOnIframeLoad=function(e){e.width=Math.min(e.parentElement.offsetWidth,e.contentWindow.document.body.scrollWidth),e.height=e.contentWindow.document.body.scrollHeight},r.prototype.toHTML=function(e,t){function n(e){try{return!r.isType(e,o.fences,o.hr,o.def_link,o.def_footnote,o.table)&&((!r.isType(e,o.list)||e.get("style")!==r.ListType.task)&&(r.isType(e.get("parent"),o.list_item)&&e.get("parent").get("parent").get("style")===r.ListType.task))}catch(e){}return!1}function l(t){var a,l=t.get("children");if(e){if(n(u)){for(var c=[],d=$.parseHTML(e),h=0;h<d.length;h++)c.push($(d[h]).attr("contenteditable","true")[0].outerHTML);e=c.join("")}return e}return l&&l.length>0?i.NodeCollectionUtils.toHTML(l):(a=t.safeGetStrAttr("text"),r.isType(t,o.paragraph)&&/^\u200b( {4}|\t)/g.exec(a)&&(a=a.replace(/^\u200b( {4}|\t)/g,"$1"),t.set("text",a)),t.cursorDiff=[],s.parseInline(t.safeGetStrAttr("text"),{attr:!r.isType(t,o.heading)},t.cursorDiff))}function c(e){var i=n(e)?"contenteditable='true'":"",r=t?"mdlike='"+t+"' ":" ";return" cid = '"+e.id+"' mdtype = '"+e.get("type")+"' "+i+r}var d,u=this,h=["h1","h2","h3","h4","h5","h6"];switch(File.option.expandSimpleBlock&&r.isType(this,o.line)&&(h.indexOf(t)>-1?this.get("parent").set("depth",h.indexOf(t)+1):this.get("parent").unset("depth")),this.get("type")){case o.meta_block:var p=this.get("text")||"";return p.match(/^\n$/g)&&(p=p.replace(/^\n$/g,"\n\n")),"<pre "+c(this)+" class='md-meta-block md-end-block' >"+a.escape(p,!1,!0)+"\n</pre>";case o.paragraph:return"<p "+c(this)+">"+l(this)+"</p>";case o.line:return"<span class='md-line md-end-block' "+c(this)+">"+l(this)+"</span>";case o.raw_edit:return"<p class='rawedit' contenteditable ='true' "+c(this)+">"+this.safeGetStrAttr("text",!0)+"</p>";case o.heading:return"<h"+this.get("depth")+c(this)+"class='md-end-block md-heading' >"+l(this)+"</h"+this.get("depth")+">";case o.blockquote:return"<blockquote "+c(this)+" >"+l(this)+"</blockquote>";case o.list:var f=this.get("style"),m=((this.get("pattern")||r.UL_DEFAULT_START[File.option.ulStyle]||"-").match(/[*+-]/)||[])[0];if(m=" data-mark='"+m+"' ",f==r.ListType.task)return"<ul class='task-list' style='position:relative;'"+c(this)+m+">"+l(this)+"</ul>";if(f==r.ListType.ol){var g=""===this.get("start")?void 0:this.get("start")-0;return"<ol class='ol-list' "+(g=Number.isNaN(g)||1==g?"":"start='"+this.get("start")+"' ")+c(this)+" >"+l(this)+"</ol>"}return"<ul class='ul-list' "+c(this)+m+" >"+l(this)+"</ul>";case o.list_item:return this.get("parent")&&this.get("parent").get("style")===r.ListType.task?"<li class='task-list-item task-list-"+(this.get("checked")?"done":"not-done")+" ' "+c(this)+"><input type='checkbox' "+(this.get("checked")?"checked":"")+"></input>"+l(this)+"</li>":"<li "+c(this)+" >"+l(this)+"</li>";case o.fences:return"<pre class='md-fences mock-cm md-end-block"+(File.option.showLineNumbersForFence?" md-fences-with-lineno":"")+"' lang='"+(this.get("lang")||"").replace(/'/g,"&#39;").toLowerCase()+"' contenteditable='false'"+c(this)+">"+(this.get("text")&&this.get("text").trim().length?a.escape(this.get("text"))+"\n":"<br/>")+"</pre>";case o.hr:return"<div tabindex='-1' contenteditable='false' "+c(this)+" class='md-hr md-end-block' ><hr /></div>";case o.def_footnote:return"<div class='footnotes md-def-footnote md-end-block' contenteditable='false'"+c(this)+"><span class='md-def-name' contenteditable='true'>"+a.escape(this.get("ref")?this.get("ref"):"​")+"</span><span class='md-def-split md-def-f' contenteditable='false' ></span><span class='md-def-content' contenteditable='true'>"+l(this)+"</span></div>";case o.def_link:return"<div class='footnotes md-def-link md-end-block' contenteditable='false'"+c(this)+"><span class='md-def-name' contenteditable='true'>"+a.escape(this.get("ref")?this.get("ref"):"​")+"</span><span class='md-def-split md-def-f' contenteditable='false' ></span><span class='md-def-content md-def-url md-auto-disp' href='link' contenteditable='true'>"+a.escape(this.get("href"))+"</span><span class='md-def-split md-auto-hide' ></span><span class='md-def-title md-auto-disp md-auto-hide' contenteditable='true'>"+a.escape(this.get("title"))+"</span></div>";case o.table:this.get("align").length;for(var v="<figure class='md-table-fig' contenteditable='false' "+c(this)+"><table class='md-table'>",y=this.getFirstChild();y;)y.get("before")?v+=y.toHTML():v+="<thead>"+y.toHTML()+"</thead><tbody>",(y=y.get("after"))||(v+="</tbody>");return v+="</table></figure>";case o.table_row:for(var b,v="<tr class='md-end-block' "+c(this)+">",y=this.getFirstChild(),w=this.get("parent").get("align"),x=0,C=this.get("before")?"td":"th";y;)v+="<"+C+(b=(b=w[x])?" style='text-align:"+b+";' ":"")+">"+y.toHTML()+"</"+C+">",y=y.get("after"),x++;return v+="</tr>";case o.table_cell:return"<span contenteditable='true' class='td-span' "+c(this)+">"+l(this)+"</span>";case o.math_block:return"<div contenteditable='false' class='mathjax-block md-end-block' id='mathjax-"+this.cid+"' "+c(this)+">$$\n"+a.escape(a.useOrDefault(this.get("text"),"<Empty \\space Math \\space Block>"))+"\n$$</div>";case o.toc:return d=this.get("in"),"<div contenteditable='false' tabindex='-1' class='md-toc md-end-block' "+c(this)+"><div class='md-tooltip-hide md-toc-tooltip'> "+$.localize.getString("Table of Contents")+" <button type='button' class='btn md-delete-toc'><span class='glyphicon glyphicon-trash'></span></button></div><p class='md-toc-content'>"+(d.toc?d.toc.getTocInnerHTML():"")+"</p></div>";case o.iframe:return"<div contenteditable='false' tabindex='-1' class='md-iframe md-end-block' "+c(this)+"><div class='md-meta'>"+a.escape(this.get("text"))+"</div><iframe src='"+a.escape(this.get("href"))+"' width='"+a.escape(this.get("width")||"100%")+"' height='"+a.escape(this.get("height")||"")+"' allowfullscreen frameborder='0'></iframe></div>";default:return"<p "+c(this)+">unknow type: "+this.get("type")+"</p>"}}}),define("app/document/NodeOperation",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/editor/UndoManager","app/editor/Diagram","codemirror/lib/codemirror","app/editor/KeyMaster","rangy/rangy-core"],function(e,t,n){"use strict";function i(e){var t=e.get("parent"),n=t.clone(),i=e.get("after");for(i.set("before",null);i;)i.set("parent",n),i=i.get("after");return t.insert(n),{prev:t,next:n,oldCid:t.cid}}e("exoskeleton-master/exoskeleton");var r=e("app/document/Node"),o=r.Node,a=r.TYPE,s=(r.NodeCollectionUtils,e("app/document/StringUtils")),l=e("app/editor/UndoManager"),c=e("app/editor/Diagram"),d=e("rangy/rangy-core.js");o.normalizeNode=function(e){if(0==e.get("children").length){if(o.isType(e,a.paragraph)){var t=new o({type:a.line,text:e.get("text"),parent:e,in:e.get("in")});return e.unset("text"),t}if(o.isType(e,a.blockquote)){var n=new o({type:a.paragraph,parent:e,in:e.get("in")});return o.normalizeNode(n)}}};var u=function(e,t){try{var n,i,r=!t.isDeleted()&&t.getClosetParagraphLevel().get("parent");if(r=o.isType(r,a.list_item)&&r.get("parent"),!(n=o.isType(r,a.list)&&r.get("style")))return;if((i=e.get("text")).match(/^(\s{2, }|\t)/))return;n==o.ListType.ol?i=i.replace(/^\s*\d+\.\s+/,""):n==o.ListType.task?i=i.replace(/^\s*[*+-]?[ \t\u00A0]+(\[(x|X)\]|\[ \]\s+)/,""):n==o.ListType.ul&&(i=i.replace(/^\s*[+*-]\s+/,"")),e.set("text",i)}catch(e){}},h=function(e,t,n){return function(i,r){var s,l=!1,c={prev:i,next:r};return i.get("type")==a.line&&(!n&&i.parseFrom({skips:{enableStartMatch:!0}}),o.isType(i,a.line)||(l=!0,c.oldCid=i.get("parent").cid,s=i.separateBlockFromLine(),c.prev=s[1],c.opt_prev=s[0])),r.get("type")==a.line&&(!e&&!t&&u(r,i),!n&&r.parseFrom(),o.isType(r,a.line)?e&&o.isType(c.prev,a.math_block,a.fences,a.meta_block)&&(c.prev.set("text",r.get("text")||""),l=!1,r.remove(),c.next=null):(l=!l,s=r.separateBlockFromLine(!0),c.next=s[1],c.opt_next=s[2],o.isType(c.opt_next,a.paragraph)&&o.isType(i,a.line)&&i.get("after")&&i.get("parent").giveChildrenTo(c.opt_next,i.get("after"),null,!0))),l&&(c.prev=o.isType(c.prev,a.line)?c.prev.get("parent"):c.prev,c.next=o.isType(c.next,a.line)?c.next.get("parent"):c.next),!(!e&&o.isType(c.prev,a.line))&&(!c.prev.canContainBlock(!0)&&o.isType(c.prev.get("parent"),a.list_item)&&((t=t||c.prev.get("before"))||(c.noExit=!0),c.prev.get("parent").get("parent").get("children").toArray().forEach(function(e){e.unset("tail")})),c)}};o.genNormalSplitExitFunc=h,o.prototype.breakOn=function(e,t,n){function i(e){var t=e.get("parent");return o.isType(t,a.list_item)&&!e.get("before")&&!e.get("after")&&!t.get("before")&&!t.get("after")&&t.get("parent").get("attachTo")}function r(i,r){var s=l.makeEmptyCommand(),d={},u=r==c&&r>0,p=i.getClosetBlock();return s.undo.push(t.selection.buildUndo()),o.isType(p.get("parent"),a.list_item)&&!e?s.undo.push(t.undo.buildReplaceUndo(p.get("parent"))):s.undo.push(t.undo.buildReplaceUndo(p)),p.unset("ahead"),p.unset("tail"),o.isType(i,a.line)&&o.isEmptyBlock(i,null,!0)&&(n=!1),d=o.splitAt(i,r,t,h(n,e),!n&&!e),s.redo.push(t.undo.buildReplaceUndo(d.prev)),d.oldCid=d.oldCid||d.prev.cid,d.next&&l.addUndoForInsert(s,d.next),d.opt_prev&&l.addUndoForInsert(s,d.opt_prev),d.opt_next&&l.addUndoForInsert(s,d.opt_next),d.newHtml="",d.newHtml||[d.opt_prev,d.prev,d.next,d.opt_next].map(function(e){e&&(d.newHtml+=e.toHTML())}),o.isType(d.prev,a.meta_block)&&u&&d.prev.get("text").match(/\n$/)?d.nextFocus=d.next.getVeryFirst().id:u&&o.isType(d.prev&&d.prev.getLastChild()||d.prev,a.math_block,a.fences,a.meta_block)?d.nextFocus=d.prev.getVeryFirst(!0).id:u&&o.isType(d.prev,a.table)?d.nextFocus=d.prev.getLastChild().getVeryFirst().cid:d.nextFocus=d.next.getVeryFirst().cid,s.redo.push({type:"cursor",id:d.nextFocus,start:0}),d.command=s,d}var s,c;if(o.isType(this,a.def_footnote)){var d=t.getJQueryElem(window.getSelection().baseNode);s=d.closest(".md-def-name").length?t.selection.getOffset(d.closest(".md-def-name")):this.get("ref").length+t.selection.getOffset(d.closest(".md-def-content"))}else if(o.isType(this,a.meta_block))s=this.getText(!1).length;else{var u=t.findElemById(this.id);u.find(".md-emoji").each(function(){var e=[];this.childNodes.forEach(function(t){3==t.nodeType&&e.push(t)});for(var t=0;t<e.length;t++)this.removeChild(e[t])}),s=t.selection.getOffset(u)}if(this.get("children").length)return this.get("children").toArray().map(function(e){t.findElemById(e.id).replaceWith(e.toMark())}),this.clearChildren(),this.set("text",t.findElemById(this.id).text()),r(this,this.get("text").length);if(c=this.getText(!1).length,o.isType(this,a.def_link,a.def_footnote)&&(c+=this.get("ref").length),!this.get("children").length){var p;if(p=function(r){if(r=r.getClosetBlock(),c<=1&&o.isType(r,a.def_footnote,a.def_footnote)&&!e&&!n&&o.isEmptyBlock(r,null,!0))return(d=l.makeEmptyCommand(t.selection.buildUndo())).undo.push(l.buildReplaceUndo(r)),r.unset("ahead"),r.unset("tail"),r.set("type",a.paragraph),o.normalizeNode(r),d.redo.push(l.buildReplaceUndo(r)),d.redo.push({type:"cursor",id:r.getLastChild().cid,start:0}),{command:d,nextFocus:r.getLastChild().cid,oldCid:r.cid,newHtml:r.toHTML()};if(0==s&&0==c&&!e&&!n&&r.closest(a.blockquote,a.list)&&r.get("parent")&&r.get("parent").canContainBlock(!0)&&!i(r)){var d=l.makeEmptyCommand();d.undo.push(t.selection.buildUndo());var u={},h=r.get("before")&&o.isEmptyBlock(r.get("before"));return u=r.upStream(h),d.undo=d.undo.concat(u.command.undo),d.redo=d.redo.concat(u.command.redo),u.nextFocus=u.nextFocus||r.id,d.redo.push({type:"cursor",id:u.nextFocus,start:0}),u.command=d,u}}(this.getClosetBlock()))return p;if(p=function(e){var n=e.get("parent");if(s==c&&n&&n==t.nodeMap.getFirst()&&o.isType(n,a.paragraph)&&!e.get("before")&&!e.get("after")&&"---"===e.get("text")){var i=t.stylize.insertMetaBlock(!0);return i.command.undo.push(l.buildReplaceUndo(n)),e.set("text",""),i.command.redo.push(l.buildReplaceUndo(n)),i.newHtml=i.node.toHTML()+n.toHTML(),i.nextFocus=i.node.id,i.oldCid=n.id,i}}(this))return p;if(s<=c)return r(this,s)}},o.isEmptyBlock=function(e,t,n){var i=n?s.isNullOrBlank:s.isNullOrEmpty;if(o.isType(e,t||[]))return!1;if(e.get("children").length){if(o.isType(e,a.paragraph))return 1==e.get("children").length&&i(e.get("children").at(0).get("text"))}else{if(o.isType(e,a.def_link))return i(e.get("ref"))&&i(e.get("href"))&&i(e.get("title"));if(o.isType(e,a.def_footnote))return i(e.get("ref"))&&i(e.get("text"));if(!o.isType(e,a.table_cell,a.table_row,a.hr))return i(e.get("text"))}return!1};var p=function(e,t){if(t&&o.isType(e,a.def_link,a.def_footnote)&&o.isEmptyBlock(e)||!t&&o.isType(e,a.meta_block)||o.isType(e,a.heading)&&o.isEmptyBlock(e))return e.set("type",a.paragraph),e.set("text",""),e.clearChildren(),o.normalizeNode(e),e.id};o.smartSplit=function(e,t,n){var i,r,o,a=d.createRange();n?(o=$.parseHTML("<span />")[0],e[0].appendChild(o),e.prepend("<span />"),a.moveToBookmark({containerNode:e[0],start:t,end:t}),a.setEndAfter(o),r=(o=a.extractContents()).querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']"),i=e[0].querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']")):(e[0].childElementCount<3&&(o=$.parseHTML("<span />")[0],e[0].insertBefore(o,e[0].firstChild),e.append("<span />")),a.moveToBookmark({containerNode:e[0],start:0,end:t}),o&&a.setStart(o,0),i=(o=a.extractContents()).querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']"),r=e[0].querySelectorAll("[md-inline='strong'], [md-inline='em'], [md-inline='del'], [md-inline='code']"));for(c=0;c<i.length;c++)(s=$(i[c])).find(":not(.md-meta)").text().length?s.children(".md-after").length||s.append(s.children(".md-before").clone().removeClass("md-before").addClass("md-after")):s.html("");for(c=0;c<r.length;c++){var s=$(r[c]);s.find(":not(.md-meta)").text().length?s.children(".md-before").length||s.prepend(s.children(".md-after").clone().removeClass("md-after").addClass("md-before")):s.html("")}for(var l=o.querySelectorAll("svg"),c=0;c<l.length;c++)l[c].parentElement.removeChild(l[c]);return[$(o).text(),e.textExcludeSVG()]},o.splitAt=function(e,t,n,r,s){var l,c,d,u=e.clone();if(r=r||h(!1,!0),s&&o.isType(e,a.line)&&o.isType(e.get("after"),a.line)&&t>=e.get("text").length)return u.remove(),i(e);if(o.isType(e,a.line)&&o.isType(e.get("before"),a.line)&&0==t)return u.remove(),i(e.get("before"));if(o.isType(e,a.paragraph,a.line,a.heading,a.list_item))l=(d=o.smartSplit(n.findElemById(e.id),t))[0],c=d[1],o.isType(e.get("parent"),a.list_item)&&e.get("parent").get("parent").get("children").toArray().forEach(function(e){e.unset("tail")});else if(o.isType(e,a.def_link,a.def_footnote)){var p=e.get("ref");if(t<=p.length)e.set("ref",p.substring(0,t)),u.set("ref",p.substring(t)),u.set("href",e.get("href")),u.set("title",e.get("title")),e.set("href",""),e.set("title",""),l="",c=e.get("text");else if(o.isType(e,a.def_link)){var m=e.get("href")||"",g=e.get("title")||"";t<=p.length+m.length?(e.set("title",""),u.set("ref",""),e.set("href",m.substring(0,t-p.length)),u.set("href",m.substring(t-p.length))):(u.set("ref",""),u.set("href",""),e.set("title",g.substring(0,t-p.length-m.length)),u.set("title",g.substring(t-p.length-m.length)))}else{var v=e.get("text")||"";u.set("ref",""),l=v.substring(0,t-p.length),c=v.substring(t-p.length)}}else l=e.getText().substring(0,t),c=e.getText().substring(t);return e.set("text",l),!o.isType(u,a.paragraph,a.def_link)&&u.set("text",c),f(e,u,void 0,r)},o.prototype.separateBlockFromLine=function(e){var t,n,i=this.get("before"),r=this.get("after"),s=this.get("parent"),l=s;return this.detach(),i&&(e?(l=new o({type:a.paragraph,trim:s.get("trim")}),(t=s).insert(l,!1)):(t=new o({type:a.paragraph,trim:s.get("trim")}),l.insert(t,!0)),l.giveChildrenTo(t,null,i,!0)),r&&(n=new o({type:a.paragraph,trim:s.get("trim")}),l.giveChildrenTo(n,r,null,!0),l.insert(n,!1)),l.copyContentFrom(this),this.giveChildrenTo(l),this.remove(),t&&t.unset("tail"),l&&l.unset("ahead"),l&&l.unset("tail"),n&&n.unset("ahead"),[t,l,n]};var f=function(e,t,n,i){var r,o=e.isBlock(!0);if(n=n||e.get("parent"),e.set("parent",n),e.insert(t),e.unset("tail"),t.unset("ahead"),i&&o&&"object"==typeof(o=i(e,t))&&(r=o,e=o.prev,t=o.next,o.noExit&&(o=!1)),o)return p(e,!0),t&&(p(t,!1),e.insert(t)),r=r||{prev:e,next:t,oldCid:e.cid};var a=e.get("parent").clone();return a.set("text",""),e.get("parent").giveChildrenTo(a,t,null,!0),f(e.get("parent"),a,void 0,i)};o.getTreePosition=function(e,t){function n(e){return e.get("parent")?1+n(e.get("parent")):0}function i(e,t){return e==t?[e,e,t]:e.get("parent")==t.get("parent")||!e.get("parent")&&!e.get("parent")?[e.get("parent"),e,t]:i(e.get("parent"),t.get("parent"))}if(e==t)return[e,e,t];var r=n(e)-n(t);if(r>0)for(;r>0;)e=e.get("parent"),r--;else if(r<0)for(;r<0;)t=t.get("parent"),r++;return i(e,t)},o.prototype.copyContentFrom=function(e){var t=this;o.property.map(function(n){t.set(n,e.get(n))})},o.prototype.clone=function(){var e=new o;return e.copyContentFrom(this),e.set("in",this.get("in")),e},o.reverseAttrFromElem=function(e,t,n){var i,r=t.attr("mdtype");switch(e.set("type",r),n&&(t.find("[data-emoji]").text(function(){return this.getAttribute("data-emoji")}),t.find(".md-meta, .md-content").remove()),e.set("text",t.text()),r){case e.TYPE.heading:e.set("depth",t[0].tagName.replace(/H/gi,""));break;case e.TYPE.list:e.set("style",t[0].tagName.toLowerCase()),t.hasClass("task-list")&&e.set("style",o.ListType.task);break;case e.TYPE.math_block:break;case e.TYPE.fences:e.set("lang",t.attr("lang")||t.find("input.mode").val()),e.set("text",t.find("textarea[id]").val()||t.text());break;case e.TYPE.list_item:e.set("checked","checked"==t.children("input").attr("checked"));break;case e.TYPE.def_link:e.set("ref",t.find(".md-def-name").text()),e.set("title",t.find(".md-def-title").text()),e.set("href",t.find(".md-def-content").text());break;case e.TYPE.def_footnote:e.set("text",t.find(".md-def-content").text()),e.set("ref",t.find(".md-def-name").text());break;case e.TYPE.table:i=[],t.find("tbody>tr:first").children().toArray().map(function(e){i[e.cellIndex]=e.style.textAlign,""==e.style.textAlign&&(i[e.cellIndex]=null)}),i.length||t.find("thead>tr:first").children().toArray().map(function(e){i[e.cellIndex]=e.style.textAlign,""==e.style.textAlign&&(i[e.cellIndex]=null)}),e.set("align",i);break;case e.TYPE.table_row:e.set("header",t.closest("thead").length>0)}},o.reverse=function(e,t,n){if(e.length&&e[0].hasAttribute("mdtype")){var i,r,a=new o({in:t});return o.reverseAttrFromElem(a,e,n),a.get("type")==a.TYPE.table?(e.find("table tr[mdtype]").toArray().map(function(e){(r=o.reverse($(e),t,n)).set("parent",a),r.set("before",i),i=r}),o.TableEdit.valify(a)):a.get("type")==a.TYPE.table_row?e.children().children("span[mdtype]").toArray().map(function(e){(r=o.reverse($(e),t,n)).set("parent",a),r.set("before",i),i=r}):e.children("[mdtype]").toArray().map(function(e){(r=o.reverse($(e),t,n)).set("parent",a),r.set("before",i),i=r}),a}},o.prototype.downStream=function(e){var t=new o({type:e,parent:this.get("parent"),before:this.get("before"),after:this.get("after"),in:this.get("in"),attachTo:this.get("attachTo")});this.set("parent",t)},o.prototype.upStream=function(e,t){var n,i=this.get("parent"),r={};if(r.command=t||l.makeEmptyCommand(),i)if(!o.isType(i,a.list_item)||this.get("before")||this.get("after")){r.command.undo.push(l.buildReplaceUndo(i)),r.oldCid=i.id;var s=this.get("after"),c=this.get("before"),d=i.get("type")==a.list_item;if(this.set("parent",i.get("parent")),this.get("type")!==a.table&&(this.get("type")==a.list_item&&(this.set("type",a.paragraph),o.normalizeNode(this),r.nextFocus=this.getFirstChild().cid),i.get("type")==a.list_item)){this.set("type",i.get("type"));var u=new o({type:a.paragraph,in:this.get("in")});this.giveChildrenTo(u),u.set("parent",this),o.normalizeNode(u)}if(r.newHtml=this.toHTML(),s)if(s.set("before",this.canContainBlock(!1)?this.getFirstChild():null),d){do{s.set("parent",this),s=s.get("after")}while(s);r.newHtml=this.toHTML()}else{n=i.clone();do{s.set("parent",n),s=s.get("after")}while(s);r.newHtml+=n.toHTML()}c?(r.command.redo.push(l.buildReplaceUndo(i)),l.addUndoForRemove(r.command,this),i.insert(this),l.addUndoForInsert(r.command,this),r.newHtml=i.toHTML()+r.newHtml):(l.addUndoForRemove(r.command,this),i.insert(this,!0),l.addUndoForInsert(r.command,this),l.addUndoForRemove(r.command,i),i.remove()),n&&(this.insert(n),l.addUndoForInsert(r.command,n))}else{var h=l.buildReplaceUndo(i);this.giveChildrenTo(i),this.remove(),(r=i.upStream()).command.undo.unshift(h),r.nextFocus=r.nextFocus||i.id}return r},o.prototype.attr=function(e,t,n,i){function r(i,r){var o=n.undo.UndoManager.makeEmptyCommand();return o.undo.push({type:"attr",id:i.id,key:e,value:r||i.safeGetStrAttr(e)}),o.redo.push({type:"attr",key:e,id:i.id,value:t}),o}if(this.get(e)!=t){i||(n.store(),n.undo.completeSnap(!0));var o=r(this);switch(i||"align_idx"==e||n.undo.register(o),t="string"==typeof t?s.escape(t):t,e){case"lang":var l=n.fences.getCm(this.id);if(l.options.mode==t)break;c.isDiagramType(l.options.mode)&&n.diagrams.cancelDiagram(this.id),l.setOption("mode",getCodeMirrorMode(t)),l.refresh(),this.set("lang",t),$("[cid='"+this.id+"']").attr("lang",t).find(".CodeMirror").attr("lang",(t||"").toLowerCase()),i&&$("[cid='"+this.id+"'] input.mode").val(t||"").focus(),c.isDiagramType(t)&&n.diagrams.updateDiagram(this.id);break;case"checked":var d=document.querySelector("[cid='"+this.id+"']>input");t?(d.setAttribute("checked","checked"),d.parentElement.classList.remove("task-list-not-done"),d.parentElement.classList.add("task-list-done")):(d.removeAttribute("checked"),d.parentElement.classList.remove("task-list-done"),d.parentElement.classList.add("task-list-not-done")),d.checked=t||!1,this.set("checked",t||!1);break;case"href-title":if(this.get("type")==a.image){var u=t.split(/\s/);n.findElemById(this.id).find("img").attr("src",u[0]),this.set("href",u[0]),this.set("title",u[1]),i&&((f=$("[cid='"+this.id+"']")).hasClass("onfocus")||(f.addClass("onfocus").focus(),n.EditHelper.showTooltipForImage(n,f),$("[cid='"+this.id+"'] input.t-bracket-input").val(t||"").focus()))}break;case"alt":this.get("type")==a.image&&(n.findElemById(this.id).find("img").attr("alt",t),this.set("alt",t),i&&((f=$("[cid='"+this.id+"']")).hasClass("onfocus")||(f.addClass("onfocus").focus(),n.EditHelper.showTooltipForImage(n,f),$("[cid='"+this.id+"'] input.t-alt-input").val(t||"").focus())));break;case"align_idx":if(this.get("type")==a.table){var h=t[0],p=t[1],f=n.findElemById(this.id);!i&&n.undo.register(r(this,[h,this.get("align")[h]])),this.get("align")[h]=p,p=p||"",f.find(".md-table-edit>tr>th:nth-child("+(h+2)+") .btn").removeClass("active").blur(),f.find(".md-table-edit>tr>th:nth-child("+(h+2)+") .md-align-"+p).addClass("active").focus(),f.find("thead:not(.md-table-edit)>tr>th:nth-child("+(h+1)+")").css("text-align",p),f.find("tbody>tr>td:nth-child("+(h+1)+")").css("text-align",p),i&&n.tableEdit.showTableEdit(f)}}return o}},o.prototype.unwrap=function(e){var t=[],n=this,i=this.getFirstChild();do{var o=i.get("after");i.set("parent",n.get("parent")),i.set("attachTo",n.get("attachTo")),i.get("before")||i.set("before",n.get("before")),i.get("after")||i.set("after",n.get("after")),t.push(i),i.get("pattern")&&i.set("pattern",i.get("pattern").replace(/^\s+/,"")),i=o}while(i);return this.remove(!0),e&&e.findElemById(this.cid).replaceWith(r.NodeCollectionUtils.toHTML(t)),t},o.prototype.wrap=function(e,t,n,i){for(var r,o=e,a=[],s={parent:e.get("parent"),before:e.get("before"),after:t?t.get("after"):e.get("after")};o&&o!=s.after;)n&&n.findElemById(o.id).remove(),r=o,o=o.get("after"),this.append(r);s.after&&(s.after.insert(this,!0),i||(a=n.findElemById(s.after.id)).before(this.toHTML())),!a.length&&s.before&&(s.before.insert(this,!1),i||(a=n.findElemById(s.before.id)).after(this.toHTML())),a.length||(s.parent?(this.set("parent",s.parent),!i&&n&&n.findElemById(s.parent.id).html(this.toHTML())):i||0!==$(n.sessionStr).children().length||(this.set("attachTo",this.get("in")),n&&($(n.sessionStr).html(this.toHTML()),n.focusCid=null)))}}),define("app/editor/Diagram",["codemirror/lib/codemirror","app/document/StringUtils","jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/editor/KeyMaster"],function(e,t,n){"use strict";var i,r=e("codemirror/lib/codemirror"),o=(e("app/document/StringUtils"),e("jquery/jquery")),a=e("exoskeleton-master/exoskeleton"),s=e("app/document/Node"),l=(e("app/editor/KeyMaster").map,s.TYPE),c=s.Node,d={},u={},h=0,p=a.Model.extend({initialize:function(e){this.editor=e},cancelDiagram:function(e){var t=this.editor.fences.getCm(e);this.editor.findElemById(e).find(".md-diagram-panel").remove().end()[0].style.marginBottom="",d[e]&&clearTimeout(d[e]),d[e]=void 0,u[e]=void 0,r.clearMarks(t),t.getWrapperElement().offsetHeight||t.refresh()},refreshDiagram:function(e){var t=this;o(".md-fences").each(function(){(e||p.isDiagramType(this.getAttribute("lang"))&&!this.querySelector("svg"))&&(t.editor.fences.getCm(this.getAttribute("cid")),t.updateDiagram(this.getAttribute("cid"),!0))})},lazyload:function(){function t(){n.modeLoaded=!0,mermaidAPI.initialize({cloneCssStyles:!1,startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!1},sequenceDiagram:{useMaxWidth:!1,diagramMarginX:10,diagramMarginY:8,boxMargin:20},gantt:{leftPadding:0,rightPadding:0}}),mermaidAPI.parseError=function(e,t){throw t.message=e,i=t,new Error(t.message)},o(r.sessionStr).on("click",".md-diagram-panel",function(e){this.previousSibling.classList.contains("CodeMirror-focused")||this.previousSibling.CodeMirror.focus()}).addClass("enable-diagrams"),n.refreshDiagram()}if(File.option.enableDiagram){var n=this,r=this.editor;window.debugMode?e.async(["diagram/mermaidAPI.js","diagram/raphael.js"],function(){e.async(["diagram/sequence-diagram.js","diagram/flowchart.js"],function(){t()})}):e.async(File.isMac||window.debugMode?"lib/diagram/diagram.min.js":"lib.asar/diagram/diagram.min.js",t)}},startPreview:function(e){var t=this.editor.getNode(e).get("lang"),n=this.editor.fences.getCm(e);if(p.isDiagramType(t)){var i=this.editor.findElemById(e),r=i.find(".md-diagram-panel");r.length||(r=o("#componenet .md-diagram-panel").clone().attr("mdtype",l.math_block),i.append(r),this.updateDiagram(e),n.setOption("lint",{getAnnotations:function(){return[]},lintOnChange:!1})),i[0].style.marginBottom=i[0].classList.contains("md-focus")?r.height()+50+"px":""}},updateDiagram:function(e,t,n){function a(e){w.find(".md-diagram-panel-error")[0].innerHTML="",r.clearMarks(b),e&&(u[b.cid]=null)}function s(n,i){n.loc&&(u[e]=n,n.message="["+i+"]"+n.message,t?document.querySelector("[cid='"+e+"'] .md-diagram-panel-error").textContent=n.message:n.loc.first_line-1==(b.getCursor()||{}).line&&b.doc.lineCount()>1?a():v.diagrams.attachError(b,n))}function l(){try{g=Diagram.parse(b.getValue()||"title: Empty Diagram"),u[e]=null}catch(e){return void s(e,"Sequence")}a(!0),w.find(".md-diagram-panel-preview")[0].innerHTML="",g.drawSVG(w.find(".md-diagram-panel-preview")[0],{theme:"simple"});var t=w.find("svg")[0],n=w.width()/(t.getAttribute("width").replace("px","")-0);n<1&&(t.style.zoom=n)}function p(){try{a(!0),g=flowchart.parse(b.getValue()),w.find(".md-diagram-panel-preview")[0].innerHTML="",g.drawSVG(w.find(".md-diagram-panel-preview")[0],{y:0,"font-color":"currentColor","line-color":"currentColor","element-color":"currentColor",fill:"transparent"})}catch(e){return}}function f(){a(!0);var e=0,t=w.find(".md-diagram-panel-preview")[0],n=b.getValue().replace(/^(\s*(%%.*)*\n)+/,function(t){return e+=t.match(/\n/g).length,""}).replace(/\t/g,"    "),r=(n.match(/\s*([^\s]+)/)||["",""])[1];y[0].setAttribute("mermaid-type",r);var l=function(e){if(t.innerHTML=e,e){var n=t.children[0];n.getAttribute("height")&&"100%"!=n.getAttribute("height")&&(n.style.height=n.getAttribute("viewBox").split(/\s/)[3]-0+40+"px")}};try{if(i=null,l(""),0==n.trim().length?l("<text>"+o.localize.getString("Empty Diagram")+"</text>"):mermaidAPI.render("mermaidChart"+h++,n,l,t),i)throw i}catch(t){return t.loc?(t.loc.first_line+=e,t.loc.last_line+=e,t.message=t.message.replace(/^[^\n]*(\d)/,function(t,n){return"Parse error on line "+(n-0+e)})):t.loc={first_line:t.line+1,last_line:t.line+1},void s(t,"Mermaid")}a(!0)}function m(){if(c.isType(b.options.mode,"sequence"))l();else if(c.isType(b.options.mode,"flow"))p();else{if(!c.isType(b.options.mode,"mermaid"))return;f()}var t=w.closest("[cid]")[0];t.style.marginBottom=t.classList.contains("md-focus")?w.height()+40+"px":"",d[e]=null}var g,v=this.editor,y=this.editor.findElemById(e),b=this.editor.fences.getCm(e),w=y.find(".md-diagram-panel");if(y[0].removeAttribute("mermaid-type"),!w.length)return v.diagrams.startPreview(e);d[e]&&clearTimeout(d[e]),n?m():d[e]=setTimeout(m,200)},attachError:function(e,t){if(t=t||u[e.cid],e.state.lint&&r.clearMarks(e),t){var n={from:r.Pos(t.loc.first_line-1,t.loc.first_column),to:r.Pos(t.loc.last_line-1,t.loc.last_column||e.doc.getLine(t.loc.last_line-1).length),message:t.message};document.querySelector("[cid='"+e.cid+"'] .md-diagram-panel-error").textContent=t.message,r.updateLinting(e,[n])}}});p.isDiagramType=function(e){return File.option.enableDiagram&&c.isType(e,"sequence","flow","mermaid")},p.MODES=["sequence","flow","mermaid"],n.exports=p}),define("codemirror/lib/codemirror",[],function(e,t,n){n.exports=function(){"use strict";function e(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}function t(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function n(e,n){return t(e).appendChild(n)}function i(e,t,n,i){var r=document.createElement(e);if(n&&(r.className=n),i&&(r.style.cssText=i),"string"==typeof t)r.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)r.appendChild(t[o]);return r}function r(e,t,n,r){var o=i(e,t,n,r);return o.setAttribute("role","presentation"),o}function o(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function a(){var e;try{e=document.activeElement}catch(t){e=document.body||null}for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e}function s(t,n){var i=t.className;e(n).test(i)||(t.className+=(i?" ":"")+n)}function l(t,n){for(var i=t.split(" "),r=0;r<i.length;r++)i[r]&&!e(i[r]).test(n)&&(n+=" "+i[r]);return n}function c(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function d(e,t,n){t||(t={});for(var i in e)!e.hasOwnProperty(i)||!1===n&&t.hasOwnProperty(i)||(t[i]=e[i]);return t}function u(e,t,n,i,r){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=i||0,a=r||0;;){var s=e.indexOf("\t",o);if(s<0||s>=t)return a+(t-o);a+=s-o,a+=n-a%n,o=s+1}}function h(e,t){for(var n=0;n<e.length;++n)if(e[n]==t)return n;return-1}function p(e,t,n){for(var i=0,r=0;;){var o=e.indexOf("\t",i);-1==o&&(o=e.length);var a=o-i;if(o==e.length||r+a>=t)return i+Math.min(a,t-r);if(r+=o-i,r+=n-r%n,i=o+1,r>=t)return i}}function f(e){for(;Na.length<=e;)Na.push(m(Na)+" ");return Na[e]}function m(e){return e[e.length-1]}function g(e,t){for(var n=[],i=0;i<e.length;i++)n[i]=t(e[i],i);return n}function v(e,t,n){for(var i=0,r=n(t);i<e.length&&n(e[i])<=r;)i++;e.splice(i,0,t)}function y(){}function b(e,t){var n;return Object.create?n=Object.create(e):(y.prototype=e,n=new y),t&&d(t,n),n}function w(e){return/\w/.test(e)||e>""&&(e.toUpperCase()!=e.toLowerCase()||La.test(e))}function x(e,t){return t?!!(t.source.indexOf("\\w")>-1&&w(e))||t.test(e):w(e)}function C(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}function k(e){return e.charCodeAt(0)>=768&&Aa.test(e)}function S(e,t,n){for(;(n<0?t>0:t<e.length)&&k(e.charAt(t));)t+=n;return t}function T(e,t,n){for(;;){if(Math.abs(t-n)<=1)return e(t)?t:n;var i=Math.floor((t+n)/2);e(i)?n=i:t=i}}function E(e,t,n){var o=this;this.input=n,o.scrollbarFiller=i("div",null,"CodeMirror-scrollbar-filler"),o.scrollbarFiller.setAttribute("cm-not-content","true"),o.gutterFiller=i("div",null,"CodeMirror-gutter-filler"),o.gutterFiller.setAttribute("cm-not-content","true"),o.lineDiv=r("div",null,"CodeMirror-code"),o.selectionDiv=i("div",null,null,"position: relative; z-index: 1"),o.cursorDiv=i("div",null,"CodeMirror-cursors"),o.measure=i("div",null,"CodeMirror-measure"),o.lineMeasure=i("div",null,"CodeMirror-measure"),o.lineSpace=r("div",[o.measure,o.lineMeasure,o.selectionDiv,o.cursorDiv,o.lineDiv],null,"position: relative; outline: none");var a=r("div",[o.lineSpace],"CodeMirror-lines");o.mover=i("div",[a],null,"position: relative"),o.sizer=i("div",[o.mover],"CodeMirror-sizer"),o.sizerWidth=null,o.heightForcer=i("div",null,null,"position: absolute; height: "+Ta+"px; width: 1px;"),o.gutters=i("div",null,"CodeMirror-gutters"),o.lineGutter=null,o.scroller=i("div",[o.sizer,o.heightForcer,o.gutters],"CodeMirror-scroll"),o.scroller.setAttribute("tabIndex","-1"),o.wrapper=i("div",[o.scrollbarFiller,o.gutterFiller,o.scroller],"CodeMirror"),ta&&na<8&&(o.gutters.style.zIndex=-1,o.scroller.style.paddingRight=0),ia||Qo&&ha||(o.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(o.wrapper):e(o.wrapper)),o.viewFrom=o.viewTo=t.first,o.reportedViewFrom=o.reportedViewTo=t.first,o.view=[],o.renderedView=null,o.externalMeasured=null,o.viewOffset=0,o.lastWrapHeight=o.lastWrapWidth=0,o.updateLineNumbers=null,o.nativeBarWidth=o.barHeight=o.barWidth=0,o.scrollbarsClipped=!1,o.lineNumWidth=o.lineNumInnerWidth=o.lineNumChars=null,o.alignWidgets=!1,o.cachedCharWidth=o.cachedTextHeight=o.cachedPaddingH=null,o.maxLine=null,o.maxLineLength=0,o.maxLineChanged=!1,o.wheelDX=o.wheelDY=o.wheelStartX=o.wheelStartY=null,o.shift=!1,o.selForContextMenu=null,o.activeTouch=null,n.init(o)}function F(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var n=e;!n.lines;)for(var i=0;;++i){var r=n.children[i],o=r.chunkSize();if(t<o){n=r;break}t-=o}return n.lines[t]}function _(e,t,n){var i=[],r=t.line;return e.iter(t.line,n.line+1,function(e){var o=e.text;r==n.line&&(o=o.slice(0,n.ch)),r==t.line&&(o=o.slice(t.ch)),i.push(o),++r}),i}function M(e,t,n){var i=[];return e.iter(t,n,function(e){i.push(e.text)}),i}function N(e,t){var n=t-e.height;if(n)for(var i=e;i;i=i.parent)i.height+=n}function L(e){if(null==e.parent)return null;for(var t=e.parent,n=h(t.lines,e),i=t.parent;i;t=i,i=i.parent)for(var r=0;i.children[r]!=t;++r)n+=i.children[r].chunkSize();return n+t.first}function A(e,t){var n=e.first;e:do{for(var i=0;i<e.children.length;++i){var r=e.children[i],o=r.height;if(t<o){e=r;continue e}t-=o,n+=r.chunkSize()}return n}while(!e.lines);for(var a=0;a<e.lines.length;++a){var s=e.lines[a].height;if(t<s)break;t-=s}return n+a}function R(e,t){return t>=e.first&&t<e.first+e.size}function I(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function P(e,t,n){if(void 0===n&&(n=null),!(this instanceof P))return new P(e,t,n);this.line=e,this.ch=t,this.sticky=n}function O(e,t){return e.line-t.line||e.ch-t.ch}function D(e,t){return e.sticky==t.sticky&&0==O(e,t)}function B(e){return P(e.line,e.ch)}function j(e,t){return O(e,t)<0?t:e}function H(e,t){return O(e,t)<0?e:t}function $(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function U(e,t){if(t.line<e.first)return P(e.first,0);var n=e.first+e.size-1;return t.line>n?P(n,F(e,n).text.length):q(t,F(e,t.line).text.length)}function q(e,t){var n=e.ch;return null==n||n>t?P(e.line,t):n<0?P(e.line,0):e}function W(e,t){for(var n=[],i=0;i<t.length;i++)n[i]=U(e,t[i]);return n}function z(){Ra=!0}function V(){Ia=!0}function K(e,t,n){this.marker=e,this.from=t,this.to=n}function Y(e,t){if(e)for(var n=0;n<e.length;++n){var i=e[n];if(i.marker==t)return i}}function J(e,t){for(var n,i=0;i<e.length;++i)e[i]!=t&&(n||(n=[])).push(e[i]);return n}function G(e,t){e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],t.marker.attachLine(e)}function Q(e,t,n){var i;if(e)for(var r=0;r<e.length;++r){var o=e[r],a=o.marker;if(null==o.from||(a.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==a.type&&(!n||!o.marker.insertLeft)){var s=null==o.to||(a.inclusiveRight?o.to>=t:o.to>t);(i||(i=[])).push(new K(a,o.from,s?null:o.to))}}return i}function X(e,t,n){var i;if(e)for(var r=0;r<e.length;++r){var o=e[r],a=o.marker;if(null==o.to||(a.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==a.type&&(!n||o.marker.insertLeft)){var s=null==o.from||(a.inclusiveLeft?o.from<=t:o.from<t);(i||(i=[])).push(new K(a,s?null:o.from-t,null==o.to?null:o.to-t))}}return i}function Z(e,t){if(t.full)return null;var n=R(e,t.from.line)&&F(e,t.from.line).markedSpans,i=R(e,t.to.line)&&F(e,t.to.line).markedSpans;if(!n&&!i)return null;var r=t.from.ch,o=t.to.ch,a=0==O(t.from,t.to),s=Q(n,r,a),l=X(i,o,a),c=1==t.text.length,d=m(t.text).length+(c?r:0);if(s)for(var u=0;u<s.length;++u){var h=s[u];if(null==h.to){var p=Y(l,h.marker);p?c&&(h.to=null==p.to?null:p.to+d):h.to=r}}if(l)for(var f=0;f<l.length;++f){var g=l[f];null!=g.to&&(g.to+=d),null==g.from?Y(s,g.marker)||(g.from=d,c&&(s||(s=[])).push(g)):(g.from+=d,c&&(s||(s=[])).push(g))}s&&(s=ee(s)),l&&l!=s&&(l=ee(l));var v=[s];if(!c){var y,b=t.text.length-2;if(b>0&&s)for(var w=0;w<s.length;++w)null==s[w].to&&(y||(y=[])).push(new K(s[w].marker,null,null));for(var x=0;x<b;++x)v.push(y);v.push(l)}return v}function ee(e){for(var t=0;t<e.length;++t){var n=e[t];null!=n.from&&n.from==n.to&&!1!==n.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function te(e,t,n){var i=null;if(e.iter(t.line,n.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var n=e.markedSpans[t].marker;!n.readOnly||i&&-1!=h(i,n)||(i||(i=[])).push(n)}}),!i)return null;for(var r=[{from:t,to:n}],o=0;o<i.length;++o)for(var a=i[o],s=a.find(0),l=0;l<r.length;++l){var c=r[l];if(!(O(c.to,s.from)<0||O(c.from,s.to)>0)){var d=[l,1],u=O(c.from,s.from),p=O(c.to,s.to);(u<0||!a.inclusiveLeft&&!u)&&d.push({from:c.from,to:s.from}),(p>0||!a.inclusiveRight&&!p)&&d.push({from:s.to,to:c.to}),r.splice.apply(r,d),l+=d.length-3}}return r}function ne(e){var t=e.markedSpans;if(t){for(var n=0;n<t.length;++n)t[n].marker.detachLine(e);e.markedSpans=null}}function ie(e,t){if(t){for(var n=0;n<t.length;++n)t[n].marker.attachLine(e);e.markedSpans=t}}function re(e){return e.inclusiveLeft?-1:0}function oe(e){return e.inclusiveRight?1:0}function ae(e,t){var n=e.lines.length-t.lines.length;if(0!=n)return n;var i=e.find(),r=t.find(),o=O(i.from,r.from)||re(e)-re(t);if(o)return-o;var a=O(i.to,r.to)||oe(e)-oe(t);return a||t.id-e.id}function se(e,t){var n,i=Ia&&e.markedSpans;if(i)for(var r=void 0,o=0;o<i.length;++o)(r=i[o]).marker.collapsed&&null==(t?r.from:r.to)&&(!n||ae(n,r.marker)<0)&&(n=r.marker);return n}function le(e){return se(e,!0)}function ce(e){return se(e,!1)}function de(e,t,n,i,r){var o=F(e,t),a=Ia&&o.markedSpans;if(a)for(var s=0;s<a.length;++s){var l=a[s];if(l.marker.collapsed){var c=l.marker.find(0),d=O(c.from,n)||re(l.marker)-re(r),u=O(c.to,i)||oe(l.marker)-oe(r);if(!(d>=0&&u<=0||d<=0&&u>=0)&&(d<=0&&(l.marker.inclusiveRight&&r.inclusiveLeft?O(c.to,n)>=0:O(c.to,n)>0)||d>=0&&(l.marker.inclusiveRight&&r.inclusiveLeft?O(c.from,i)<=0:O(c.from,i)<0)))return!0}}}function ue(e){for(var t;t=le(e);)e=t.find(-1,!0).line;return e}function he(e){for(var t;t=ce(e);)e=t.find(1,!0).line;return e}function pe(e){for(var t,n;t=ce(e);)e=t.find(1,!0).line,(n||(n=[])).push(e);return n}function fe(e,t){var n=F(e,t),i=ue(n);return n==i?t:L(i)}function me(e,t){if(t>e.lastLine())return t;var n,i=F(e,t);if(!ge(e,i))return t;for(;n=ce(i);)i=n.find(1,!0).line;return L(i)+1}function ge(e,t){var n=Ia&&t.markedSpans;if(n)for(var i=void 0,r=0;r<n.length;++r)if((i=n[r]).marker.collapsed){if(null==i.from)return!0;if(!i.marker.widgetNode&&0==i.from&&i.marker.inclusiveLeft&&ve(e,t,i))return!0}}function ve(e,t,n){if(null==n.to){var i=n.marker.find(1,!0);return ve(e,i.line,Y(i.line.markedSpans,n.marker))}if(n.marker.inclusiveRight&&n.to==t.text.length)return!0;for(var r=void 0,o=0;o<t.markedSpans.length;++o)if((r=t.markedSpans[o]).marker.collapsed&&!r.marker.widgetNode&&r.from==n.to&&(null==r.to||r.to!=n.from)&&(r.marker.inclusiveLeft||n.marker.inclusiveRight)&&ve(e,t,r))return!0}function ye(e){for(var t=0,n=(e=ue(e)).parent,i=0;i<n.lines.length;++i){var r=n.lines[i];if(r==e)break;t+=r.height}for(var o=n.parent;o;n=o,o=n.parent)for(var a=0;a<o.children.length;++a){var s=o.children[a];if(s==n)break;t+=s.height}return t}function be(e){if(0==e.height)return 0;for(var t,n=e.text.length,i=e;t=le(i);){var r=t.find(0,!0);i=r.from.line,n+=r.from.ch-r.to.ch}for(i=e;t=ce(i);){var o=t.find(0,!0);n-=i.text.length-o.from.ch,n+=(i=o.to.line).text.length-o.to.ch}return n}function we(e){var t=e.display,n=e.doc;t.maxLine=F(n,n.first),t.maxLineLength=be(t.maxLine),t.maxLineChanged=!0,n.iter(function(e){var n=be(e);n>t.maxLineLength&&(t.maxLineLength=n,t.maxLine=e)})}function xe(e,t,n,i){if(!e)return i(t,n,"ltr");for(var r=!1,o=0;o<e.length;++o){var a=e[o];(a.from<n&&a.to>t||t==n&&a.to==t)&&(i(Math.max(a.from,t),Math.min(a.to,n),1==a.level?"rtl":"ltr"),r=!0)}r||i(t,n,"ltr")}function Ce(e,t,n){var i;Pa=null;for(var r=0;r<e.length;++r){var o=e[r];if(o.from<t&&o.to>t)return r;o.to==t&&(o.from!=o.to&&"before"==n?i=r:Pa=r),o.from==t&&(o.from!=o.to&&"before"!=n?i=r:Pa=r)}return null!=i?i:Pa}function ke(e,t){var n=e.order;return null==n&&(n=e.order=Oa(e.text,t)),n}function Se(e,t,n){var i=S(e.text,t+n,n);return i<0||i>e.text.length?null:i}function Te(e,t,n){var i=Se(e,t.ch,n);return null==i?null:new P(t.line,i,n<0?"after":"before")}function Ee(e,t,n,i,r){if(e){var o=ke(n,t.doc.direction);if(o){var a,s=r<0?m(o):o[0],l=r<0==(1==s.level)?"after":"before";if(s.level>0){var c=Jt(t,n);a=r<0?n.text.length-1:0;var d=Gt(t,c,a).top;a=T(function(e){return Gt(t,c,e).top==d},r<0==(1==s.level)?s.from:s.to-1,a),"before"==l&&(a=Se(n,a,1))}else a=r<0?s.to:s.from;return new P(i,a,l)}}return new P(i,r<0?n.text.length:0,r<0?"before":"after")}function Fe(e,t,n,i){var r=ke(t,e.doc.direction);if(!r)return Te(t,n,i);n.ch>=t.text.length?(n.ch=t.text.length,n.sticky="before"):n.ch<=0&&(n.ch=0,n.sticky="after");var o=Ce(r,n.ch,n.sticky),a=r[o];if("ltr"==e.doc.direction&&a.level%2==0&&(i>0?a.to>n.ch:a.from<n.ch))return Te(t,n,i);var s,l=function(e,n){return Se(t,e instanceof P?e.ch:e,n)},c=function(n){return e.options.lineWrapping?(s=s||Jt(e,t),mn(e,t,s,n)):{begin:0,end:t.text.length}},d=c("before"==n.sticky?l(n,-1):n.ch);if("rtl"==e.doc.direction||1==a.level){var u=1==a.level==i<0,h=l(n,u?1:-1);if(null!=h&&(u?h<=a.to&&h<=d.end:h>=a.from&&h>=d.begin)){var p=u?"before":"after";return new P(n.line,h,p)}}var f=function(e,t,i){for(var o=function(e,t){return t?new P(n.line,l(e,1),"before"):new P(n.line,e,"after")};e>=0&&e<r.length;e+=t){var a=r[e],s=t>0==(1!=a.level),c=s?i.begin:l(i.end,-1);if(a.from<=c&&c<a.to)return o(c,s);if(c=s?a.from:l(a.to,-1),i.begin<=c&&c<i.end)return o(c,s)}},m=f(o+i,i,d);if(m)return m;var g=i>0?d.end:l(d.begin,-1);return null==g||i>0&&g==t.text.length||!(m=f(i>0?0:r.length-1,i,c(g)))?null:m}function _e(e,t){return e._handlers&&e._handlers[t]||Da}function Me(e,t,n){if(e.removeEventListener)e.removeEventListener(t,n,!1);else if(e.detachEvent)e.detachEvent("on"+t,n);else{var i=e._handlers,r=i&&i[t];if(r){var o=h(r,n);o>-1&&(i[t]=r.slice(0,o).concat(r.slice(o+1)))}}}function Ne(e,t){var n=_e(e,t);if(n.length)for(var i=Array.prototype.slice.call(arguments,2),r=0;r<n.length;++r)n[r].apply(null,i)}function Le(e,t,n){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),Ne(e,n||t.type,e,t),De(t)||t.codemirrorIgnore}function Ae(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var n=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),i=0;i<t.length;++i)-1==h(n,t[i])&&n.push(t[i])}function Re(e,t){return _e(e,t).length>0}function Ie(e){e.prototype.on=function(e,t){Ba(this,e,t)},e.prototype.off=function(e,t){Me(this,e,t)}}function Pe(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function Oe(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function De(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Be(e){Pe(e),Oe(e)}function je(e){return e.target||e.srcElement}function He(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),pa&&e.ctrlKey&&1==t&&(t=3),t}function $e(e){if(null==ka){var t=i("span","​");n(e,i("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(ka=t.offsetWidth<=1&&t.offsetHeight>2&&!(ta&&na<8))}var r=ka?i("span","​"):i("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return r.setAttribute("cm-text",""),r}function Ue(e){if(null!=Sa)return Sa;var i=n(e,document.createTextNode("AخA")),r=va(i,0,1).getBoundingClientRect(),o=va(i,1,2).getBoundingClientRect();return t(e),!(!r||r.left==r.right)&&(Sa=o.right-r.right<3)}function qe(e){if(null!=qa)return qa;var t=n(e,i("span","x")),r=t.getBoundingClientRect(),o=va(t,0,1).getBoundingClientRect();return qa=Math.abs(r.left-o.left)>1}function We(e,t){arguments.length>2&&(t.dependencies=Array.prototype.slice.call(arguments,2)),Wa[e]=t}function ze(e){if("string"==typeof e&&za.hasOwnProperty(e))e=za[e];else if(e&&"string"==typeof e.name&&za.hasOwnProperty(e.name)){var t=za[e.name];"string"==typeof t&&(t={name:t}),(e=b(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return ze("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return ze("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function Ve(e,t){t=ze(t);var n=Wa[t.name];if(!n)return Ve(e,"text/plain");var i=n(e,t);if(Va.hasOwnProperty(t.name)){var r=Va[t.name];for(var o in r)r.hasOwnProperty(o)&&(i.hasOwnProperty(o)&&(i["_"+o]=i[o]),i[o]=r[o])}if(i.name=t.name,t.helperType&&(i.helperType=t.helperType),t.modeProps)for(var a in t.modeProps)i[a]=t.modeProps[a];return i}function Ke(e,t){d(t,Va.hasOwnProperty(e)?Va[e]:Va[e]={})}function Ye(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var n={};for(var i in t){var r=t[i];r instanceof Array&&(r=r.concat([])),n[i]=r}return n}function Je(e,t){for(var n;e.innerMode&&(n=e.innerMode(t))&&n.mode&&n.mode!=e;)t=n.state,e=n.mode;return n&&!n.mode&&(n=void 0),n||{mode:e,state:t}}function Ge(e,t,n){return!e.startState||e.startState(t,n)}function Qe(e,t,n,i){var r=[e.state.modeGen],o={},a=L(t);"object"==typeof n&&(n.lineBefore=e.getLine(a-1),n.lineAfter=e.getLine(a+1)),ot(e,t.text,e.doc.mode,n,function(e,t){return r.push(e,t)},o,i);for(var s=0;s<e.state.overlays.length;++s)!function(i){var a=e.state.overlays[i],s=1,l=0;ot(e,t.text,a.mode,"visiblespace"!==a.mode.name||n.base,function(e,t){for(var n=s;l<e;){var i=r[s];i>e&&r.splice(s,1,e,r[s+1],i),s+=2,l=Math.min(e,i)}if(t)if(a.opaque)r.splice(n,s-n,e,"overlay "+t),s=n+2;else for(;n<s;n+=2){var o=r[n+1];r[n+1]=(o?o+" ":"")+"overlay "+t}},o)}(s);return{styles:r,classes:o.bgClass||o.textClass?o:null}}function Xe(e,t,n){if(!t.styles||t.styles[0]!=e.state.modeGen){var i=Ze(e,L(t)),r=Qe(e,t,t.text.length>e.options.maxHighlightLength?Ye(e.doc.mode,i):i);t.stateAfter=i,t.styles=r.styles,r.classes?t.styleClasses=r.classes:t.styleClasses&&(t.styleClasses=null),n===e.doc.frontier&&e.doc.frontier++}return t.styles}function Ze(e,t,n){var i=e.doc,r=e.display;if(!i.mode.startState)return!0;var o=at(e,t,n),a=o>i.first&&F(i,o-1).stateAfter;return a=a?Ye(i.mode,a):Ge(i.mode),i.iter(o,t,function(n){"object"==typeof a&&(a.lineBefore=e.getLine(t-1),a.lineAfter=e.getLine(t+1)),et(e,n.text,a);var s=o==t-1||o%5==0||o>=r.viewFrom&&o<r.viewTo;n.stateAfter=s?Ye(i.mode,a):null,++o}),n&&(i.frontier=o),a}function et(e,t,n,i){var r=e.doc.mode,o=new Ka(t,e.options.tabSize);for(o.start=o.pos=i||0,n.lineBefore=n.lineBefore||"",n.lineAfter=n.lineAfter||"",""==t&&tt(r,n);!o.eol();)nt(r,o,n),o.start=o.pos}function tt(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var n=Je(e,t);return n.mode.blankLine?n.mode.blankLine(n.state):void 0}}function nt(e,t,n,i){for(var r=0;r<10;r++){i&&(i[0]=Je(e,n).mode);var o=e.token(t,n);if(t.pos>t.start)return o}if("gfm"==e.name)return t.pos=t.start+1,null;throw new Error("Mode "+e.name+" failed to advance stream.")}function it(e,t,n,i){var r,o=function(e){return{start:u.start,end:u.pos,string:u.current(),type:r||null,state:e?Ye(a.mode,d):d}},a=e.doc,s=a.mode;t=U(a,t);var l,c=F(a,t.line),d=Ze(e,t.line,n),u=new Ka(c.text,e.options.tabSize);for(i&&(l=[]);(i||u.pos<t.ch)&&!u.eol();)u.start=u.pos,r=nt(s,u,d),i&&l.push(o(!0));return i?l:o()}function rt(e,t){if(e)for(;;){var n=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!n)break;e=e.slice(0,n.index)+e.slice(n.index+n[0].length);var i=n[1]?"bgClass":"textClass";null==t[i]?t[i]=n[2]:new RegExp("(?:^|s)"+n[2]+"(?:$|s)").test(t[i])||(t[i]+=" "+n[2])}return e}function ot(e,t,n,i,r,o,a){var s=n.flattenSpans;null==s&&(s=e.options.flattenSpans);var l,c=0,d=null,u=new Ka(t,e.options.tabSize),h=e.options.addModeClass&&[null];for(""==t&&rt(tt(n,i),o);!u.eol();){if(u.pos>e.options.maxHighlightLength?(s=!1,a&&et(e,t,i,u.pos),u.pos=t.length,l=null):l=rt(nt(n,u,i,h),o),h){var p=h[0].name;p&&(l="m-"+(l?p+" "+l:p))}if(!s||d!=l){for(;c<u.start;)r(c=Math.min(u.start,c+5e3),d);d=l}u.start=u.pos}for(;c<u.pos;){var f=Math.min(u.pos,c+5e3);r(f,d),c=f}}function at(e,t,n){for(var i,r,o=e.doc,a=n?-1:t-(e.doc.mode.innerMode?1e3:100),s=t;s>a;--s){if(s<=o.first)return o.first;var l=F(o,s-1);if(l.stateAfter&&(!n||s<=o.frontier))return s;var c=u(l.text,null,e.options.tabSize);(null==r||i>c)&&(r=s-1,i=c)}return r}function st(e,t,n,i){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),ne(e),ie(e,n);var r=i?i(e):1;r!=e.height&&N(e,r)}function lt(e){e.parent=null,ne(e)}function ct(e,t){if(!e||/^\s*$/.test(e))return null;var n=t.addModeClass?Qa:Ga;return n[e]||(n[e]=e.replace(/\S+/g,"cm-$&"))}function dt(e,t){var n=r("span",null,null,ia?"padding-right: .1px":null),i={pre:r("pre",[n],"CodeMirror-line"),content:n,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:(ta||ia)&&e.getOption("lineWrapping")};t.measure={};for(var o=0;o<=(t.rest?t.rest.length:0);o++){var a=o?t.rest[o-1]:t.line,s=void 0;i.pos=0,i.addToken=ht,Ue(e.display.measure)&&(s=ke(a,e.doc.direction))&&(i.addToken=ft(i.addToken,s)),i.map=[],gt(a,i,Xe(e,a,t!=e.display.externalMeasured&&L(a))),a.styleClasses&&(a.styleClasses.bgClass&&(i.bgClass=l(a.styleClasses.bgClass,i.bgClass||"")),a.styleClasses.textClass&&(i.textClass=l(a.styleClasses.textClass,i.textClass||""))),0==i.map.length&&i.map.push(0,0,i.content.appendChild($e(e.display.measure))),0==o?(t.measure.map=i.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(i.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(ia){var c=i.content.lastChild;(/\bcm-tab\b/.test(c.className)||c.querySelector&&c.querySelector(".cm-tab"))&&(i.content.className="cm-tab-wrap-hack")}return Ne(e,"renderLine",e,t.line,i.pre),i.pre.className&&(i.textClass=l(i.pre.className,i.textClass||"")),i}function ut(e){var t=i("span","•","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function ht(e,t,n,r,o,a,s){if(t){var l,c=e.splitSpaces?pt(t,e.trailingSpace):t,d=e.cm.state.specialChars,u=!1;if(d.test(t)){l=document.createDocumentFragment();for(var h=0;;){d.lastIndex=h;var p=d.exec(t),m=p?p.index-h:t.length-h;if(m){var g=document.createTextNode(c.slice(h,h+m));ta&&na<9?l.appendChild(i("span",[g])):l.appendChild(g),e.map.push(e.pos,e.pos+m,g),e.col+=m,e.pos+=m}if(!p)break;h+=m+1;var v=void 0;if("\t"==p[0]){var y=e.cm.options.tabSize,b=y-e.col%y;(v=l.appendChild(i("span",f(b),"cm-tab"))).setAttribute("role","presentation"),v.setAttribute("cm-text","\t"),e.col+=b}else"\r"==p[0]||"\n"==p[0]?((v=l.appendChild(i("span","\r"==p[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",p[0]),e.col+=1):((v=e.cm.options.specialCharPlaceholder(p[0])).setAttribute("cm-text",p[0]),ta&&na<9?l.appendChild(i("span",[v])):l.appendChild(v),e.col+=1);e.map.push(e.pos,e.pos+1,v),e.pos++}}else e.col+=t.length,l=document.createTextNode(c),e.map.push(e.pos,e.pos+t.length,l),ta&&na<9&&(u=!0),e.pos+=t.length;if(e.trailingSpace=32==c.charCodeAt(t.length-1),n||r||o||u||s){var w=n||"";r&&(w+=r),o&&(w+=o);var x=i("span",[l],w,s);return a&&(x.title=a),e.content.appendChild(x)}e.content.appendChild(l)}}function pt(e,t){if(e.length>1&&!/  /.test(e))return e;for(var n=t,i="",r=0;r<e.length;r++){var o=e.charAt(r);" "!=o||!n||r!=e.length-1&&32!=e.charCodeAt(r+1)||(o=" "),i+=o,n=" "==o}return i}function ft(e,t){return function(n,i,r,o,a,s,l){r=r?r+" cm-force-border":"cm-force-border";for(var c=n.pos,d=c+i.length;;){for(var u=void 0,h=0;h<t.length&&!((u=t[h]).to>c&&u.from<=c);h++);if(u.to>=d)return e(n,i,r,o,a,s,l);e(n,i.slice(0,u.to-c),r,o,null,s,l),o=null,i=i.slice(u.to-c),c=u.to}}}function mt(e,t,n,i){var r=!i&&n.widgetNode;r&&e.map.push(e.pos,e.pos+t,r),!i&&e.cm.display.input.needsContentAttribute&&(r||(r=e.content.appendChild(document.createElement("span"))),r.setAttribute("cm-marker",n.id)),r&&(e.cm.display.input.setUneditable(r),e.content.appendChild(r)),e.pos+=t,e.trailingSpace=!1}function gt(e,t,n){var i=e.markedSpans,r=e.text,o=0;if(i)for(var a,s,l,c,d,u,h,p=r.length,f=0,m=1,g="",v=0;;){if(v==f){l=c=d=u=s="",h=null,v=1/0;for(var y=[],b=void 0,w=0;w<i.length;++w){var x=i[w],C=x.marker;"bookmark"==C.type&&x.from==f&&C.widgetNode?y.push(C):x.from<=f&&(null==x.to||x.to>f||C.collapsed&&x.to==f&&x.from==f)?(null!=x.to&&x.to!=f&&v>x.to&&(v=x.to,c=""),C.className&&(l+=" "+C.className),C.css&&(s=(s?s+";":"")+C.css),C.startStyle&&x.from==f&&(d+=" "+C.startStyle),C.endStyle&&x.to==v&&(b||(b=[])).push(C.endStyle,x.to),C.title&&!u&&(u=C.title),C.collapsed&&(!h||ae(h.marker,C)<0)&&(h=x)):x.from>f&&v>x.from&&(v=x.from)}if(b)for(var k=0;k<b.length;k+=2)b[k+1]==v&&(c+=" "+b[k]);if(!h||h.from==f)for(var S=0;S<y.length;++S)mt(t,0,y[S]);if(h&&(h.from||0)==f){if(mt(t,(null==h.to?p+1:h.to)-f,h.marker,null==h.from),null==h.to)return;h.to==f&&(h=!1)}}if(f>=p)break;for(var T=Math.min(p,v);;){if(g){var E=f+g.length;if(!h){var F=E>T?g.slice(0,T-f):g;t.addToken(t,F,a?a+l:l,d,f+F.length==v?c:"",u,s)}if(E>=T){g=g.slice(T-f),f=T;break}f=E,d=""}g=r.slice(o,o=n[m++]),a=ct(n[m++],t.cm.options)}}else for(var _=1;_<n.length;_+=2)t.addToken(t,r.slice(o,o=n[_]),ct(n[_+1],t.cm.options))}function vt(e,t,n){this.line=t,this.rest=pe(t),this.size=this.rest?L(m(this.rest))-n+1:1,this.node=this.text=null,this.hidden=ge(e,t)}function yt(e,t,n){for(var i,r=[],o=t;o<n;o=i){var a=new vt(e.doc,F(e.doc,o),o);i=o+a.size,r.push(a)}return r}function bt(e){Xa?Xa.ops.push(e):e.ownsGroup=Xa={ops:[e],delayedCallbacks:[]}}function wt(e){var t=e.delayedCallbacks,n=0;do{for(;n<t.length;n++)t[n].call(null);for(var i=0;i<e.ops.length;i++){var r=e.ops[i];if(r.cursorActivityHandlers)for(;r.cursorActivityCalled<r.cursorActivityHandlers.length;)r.cursorActivityHandlers[r.cursorActivityCalled++].call(null,r.cm)}}while(n<t.length)}function xt(e,t){var n=e.ownsGroup;if(n)try{wt(n)}finally{Xa=null,t(n)}}function Ct(e,t){var n=_e(e,t);if(n.length){var i,r=Array.prototype.slice.call(arguments,2);Xa?i=Xa.delayedCallbacks:Za?i=Za:(i=Za=[],setTimeout(kt,0));for(var o=0;o<n.length;++o)!function(e){i.push(function(){return n[e].apply(null,r)})}(o)}}function kt(){var e=Za;Za=null;for(var t=0;t<e.length;++t)e[t]()}function St(e,t,n,i){for(var r=0;r<t.changes.length;r++){var o=t.changes[r];"text"==o?_t(e,t):"gutter"==o?Nt(e,t,n,i):"class"==o?Mt(e,t):"widget"==o&&Lt(e,t,i)}t.changes=null}function Tt(e){return e.node==e.text&&(e.node=i("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),ta&&na<8&&(e.node.style.zIndex=2)),e.node}function Et(e,t){var n=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(n&&(n+=" CodeMirror-linebackground"),t.background)n?t.background.className=n:(t.background.parentNode.removeChild(t.background),t.background=null);else if(n){var r=Tt(t);t.background=r.insertBefore(i("div",null,n),r.firstChild),e.display.input.setUneditable(t.background)}}function Ft(e,t){var n=e.display.externalMeasured;return n&&n.line==t.line?(e.display.externalMeasured=null,t.measure=n.measure,n.built):dt(e,t)}function _t(e,t){var n=t.text.className,i=Ft(e,t);t.text==t.node&&(t.node=i.pre),t.text.parentNode.replaceChild(i.pre,t.text),t.text=i.pre,i.bgClass!=t.bgClass||i.textClass!=t.textClass?(t.bgClass=i.bgClass,t.textClass=i.textClass,Mt(e,t)):n&&(t.text.className=n)}function Mt(e,t){Et(e,t),t.line.wrapClass?Tt(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var n=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=n||""}function Nt(e,t,n,r){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var o=Tt(t);t.gutterBackground=i("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?r.fixedPos:-r.gutterTotalWidth)+"px; width: "+r.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),o.insertBefore(t.gutterBackground,t.text)}var a=t.line.gutterMarkers;if(e.options.lineNumbers||a){var s=0===n||n===e.lineCount()-1||(n+1)%10==0?" CodeMirror-linenumber-show":"",l=Tt(t),c=t.gutter=i("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?r.fixedPos:-r.gutterTotalWidth)+"px");if(e.display.input.setUneditable(c),l.insertBefore(c,t.text),t.line.gutterClass&&(c.className+=" "+t.line.gutterClass),!e.options.lineNumbers||a&&a["CodeMirror-linenumbers"]||(t.lineNumber=c.appendChild(i("div",I(e.options,n),"CodeMirror-linenumber CodeMirror-gutter-elt"+s,"left: "+r.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),a)for(var d=0;d<e.options.gutters.length;++d){var u=e.options.gutters[d],h=a.hasOwnProperty(u)&&a[u];h&&c.appendChild(i("div",[h],"CodeMirror-gutter-elt","left: "+r.gutterLeft[u]+"px; width: "+r.gutterWidth[u]+"px"))}}}function Lt(e,t,n){t.alignable&&(t.alignable=null);for(var i=t.node.firstChild,r=void 0;i;i=r)r=i.nextSibling,"CodeMirror-linewidget"==i.className&&t.node.removeChild(i);Rt(e,t,n)}function At(e,t,n,i){var r=Ft(e,t);return t.text=t.node=r.pre,r.bgClass&&(t.bgClass=r.bgClass),r.textClass&&(t.textClass=r.textClass),Mt(e,t),Nt(e,t,n,i),Rt(e,t,i),t.node}function Rt(e,t,n){if(It(e,t.line,t,n,!0),t.rest)for(var i=0;i<t.rest.length;i++)It(e,t.rest[i],t,n,!1)}function It(e,t,n,r,o){if(t.widgets)for(var a=Tt(n),s=0,l=t.widgets;s<l.length;++s){var c=l[s],d=i("div",[c.node],"CodeMirror-linewidget");c.handleMouseEvents||d.setAttribute("cm-ignore-events","true"),Pt(c,d,n,r),e.display.input.setUneditable(d),o&&c.above?a.insertBefore(d,n.gutter||n.text):a.appendChild(d),Ct(c,"redraw")}}function Pt(e,t,n,i){if(e.noHScroll){(n.alignable||(n.alignable=[])).push(t);var r=i.wrapperWidth;t.style.left=i.fixedPos+"px",e.coverGutter||(r-=i.gutterTotalWidth,t.style.paddingLeft=i.gutterTotalWidth+"px"),t.style.width=r+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-i.gutterTotalWidth+"px"))}function Ot(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!o(document.body,e.node)){var r="position: relative;";e.coverGutter&&(r+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(r+="width: "+t.display.wrapper.clientWidth+"px;"),n(t.display.measure,i("div",[e.node],null,r))}return e.height=e.node.parentNode.offsetHeight}function Dt(e,t){for(var n=je(t);n!=e.wrapper;n=n.parentNode)if(!n||1==n.nodeType&&"true"==n.getAttribute("cm-ignore-events")||n.parentNode==e.sizer&&n!=e.mover)return!0}function Bt(e){return e.lineSpace.offsetTop}function jt(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function Ht(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=n(e.measure,i("pre","x")),r=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,o={left:parseInt(r.paddingLeft),right:parseInt(r.paddingRight)};return isNaN(o.left)||isNaN(o.right)||(e.cachedPaddingH=o),o}function $t(e){return Ta-e.display.nativeBarWidth}function Ut(e){return e.display.scroller.clientWidth-$t(e)-e.display.barWidth}function qt(e){return e.display.scroller.clientHeight-$t(e)-e.display.barHeight}function Wt(e,t,n){var i=e.options.lineWrapping,r=i&&Ut(e);if(!t.measure.heights||i&&t.measure.width!=r){var o=t.measure.heights=[];if(i){t.measure.width=r;for(var a=t.text.firstChild.getClientRects(),s=0;s<a.length-1;s++){var l=a[s],c=a[s+1];Math.abs(l.bottom-c.bottom)>2&&o.push((l.bottom+c.top)/2-n.top)}}o.push(n.bottom-n.top)}}function zt(e,t,n){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var i=0;i<e.rest.length;i++)if(e.rest[i]==t)return{map:e.measure.maps[i],cache:e.measure.caches[i]};for(var r=0;r<e.rest.length;r++)if(L(e.rest[r])>n)return{map:e.measure.maps[r],cache:e.measure.caches[r],before:!0}}function Vt(e,t){var i=L(t=ue(t)),r=e.display.externalMeasured=new vt(e.doc,t,i);r.lineN=i;var o=r.built=dt(e,r);return r.text=o.pre,n(e.display.lineMeasure,o.pre),r}function Kt(e,t,n,i){return Gt(e,Jt(e,t),n,i)}function Yt(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[Sn(e,t)];var n=e.display.externalMeasured;return n&&t>=n.lineN&&t<n.lineN+n.size?n:void 0}function Jt(e,t){var n=L(t),i=Yt(e,n);i&&!i.text?i=null:i&&i.changes&&(St(e,i,n,bn(e)),e.curOp.forceUpdate=!0),i||(i=Vt(e,t));var r=zt(i,t,n);return{line:t,view:i,rect:null,map:r.map,cache:r.cache,before:r.before,hasHeights:!1}}function Gt(e,t,n,i,r){t.before&&(n=-1);var o,a=n+(i||"");return t.cache.hasOwnProperty(a)?o=t.cache[a]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(Wt(e,t.view,t.rect),t.hasHeights=!0),(o=Zt(e,t,n,i)).bogus||(t.cache[a]=o)),{left:o.left,right:o.right,top:r?o.rtop:o.top,bottom:r?o.rbottom:o.bottom}}function Qt(e,t,n){for(var i,r,o,a,s,l,c=0;c<e.length;c+=3)if(s=e[c],l=e[c+1],t<s?(r=0,o=1,a="left"):t<l?o=(r=t-s)+1:(c==e.length-3||t==l&&e[c+3]>t)&&(r=(o=l-s)-1,t>=l&&(a="right")),null!=r){if(i=e[c+2],s==l&&n==(i.insertLeft?"left":"right")&&(a=n),"left"==n&&0==r)for(;c&&e[c-2]==e[c-3]&&e[c-1].insertLeft;)i=e[2+(c-=3)],a="left";if("right"==n&&r==l-s)for(;c<e.length-3&&e[c+3]==e[c+4]&&!e[c+5].insertLeft;)i=e[(c+=3)+2],a="right";break}return{node:i,start:r,end:o,collapse:a,coverStart:s,coverEnd:l}}function Xt(e,t){var n=es;if("left"==t)for(var i=0;i<e.length&&(n=e[i]).left==n.right;i++);else for(var r=e.length-1;r>=0&&(n=e[r]).left==n.right;r--);return n}function Zt(e,t,n,i){var r,o=Qt(t.map,n,i),a=o.node,s=o.start,l=o.end,c=o.collapse;if(3==a.nodeType){for(var d=0;d<4;d++){for(;s&&k(t.line.text.charAt(o.coverStart+s));)--s;for(;o.coverStart+l<o.coverEnd&&k(t.line.text.charAt(o.coverStart+l));)++l;if((r=ta&&na<9&&0==s&&l==o.coverEnd-o.coverStart?a.parentNode.getBoundingClientRect():Xt(va(a,s,l).getClientRects(),i)).left||r.right||0==s)break;l=s,s-=1,c="right"}ta&&na<11&&(r=en(e.display.measure,r))}else{s>0&&(c=i="right");var u;r=e.options.lineWrapping&&(u=a.getClientRects()).length>1?u["right"==i?u.length-1:0]:a.getBoundingClientRect()}if(ta&&na<9&&!s&&(!r||!r.left&&!r.right)){var h=a.parentNode.getClientRects()[0];r=h?{left:h.left,right:h.left+yn(e.display),top:h.top,bottom:h.bottom}:es}for(var p=r.top-t.rect.top,f=r.bottom-t.rect.top,m=(p+f)/2,g=t.view.measure.heights,v=0;v<g.length-1&&!(m<g[v]);v++);var y=v?g[v-1]:0,b=g[v],w={left:("right"==c?r.right:r.left)-t.rect.left,right:("left"==c?r.left:r.right)-t.rect.left,top:y,bottom:b};return r.left||r.right||(w.bogus=!0),e.options.singleCursorHeightPerLine||(w.rtop=p,w.rbottom=f),w}function en(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!qe(e))return t;var n=screen.logicalXDPI/screen.deviceXDPI,i=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*n,right:t.right*n,top:t.top*i,bottom:t.bottom*i}}function tn(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function nn(e){e.display.externalMeasure=null,t(e.display.lineMeasure);for(var n=0;n<e.display.view.length;n++)tn(e.display.view[n])}function rn(e){nn(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function on(){return oa&&ua?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function an(){return oa&&ua?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function sn(e,t,n,i,r){if(!r&&t.widgets)for(var o=0;o<t.widgets.length;++o)if(t.widgets[o].above){var a=Ot(t.widgets[o]);n.top+=a,n.bottom+=a}if("line"==i)return n;i||(i="local");var s=ye(t);if("local"==i?s+=Bt(e.display):s-=e.display.viewOffset,"page"==i||"window"==i){var l=e.display.lineSpace.getBoundingClientRect();s+=l.top+("window"==i?0:an());var c=l.left+("window"==i?0:on());n.left+=c,n.right+=c}return n.top+=s,n.bottom+=s,n}function ln(e,t,n){if("div"==n)return t;var i=t.left,r=t.top;if("page"==n)i-=on(),r-=an();else if("local"==n||!n){var o=e.display.sizer.getBoundingClientRect();i+=o.left,r+=o.top}var a=e.display.lineSpace.getBoundingClientRect();return{left:i-a.left,top:r-a.top}}function cn(e,t,n,i,r){return i||(i=F(e.doc,t.line)),sn(e,i,Kt(e,i,t.ch,r),n)}function dn(e,t,n,i,r,o){function a(t,a){var s=Gt(e,r,t,a?"right":"left",o);return a?s.left=s.right:s.right=s.left,sn(e,i,s,n)}function s(e,t,n){var i=l[t].level%2!=0;return a(n?e-1:e,i!=n)}i=i||F(e.doc,t.line),r||(r=Jt(e,i));var l=ke(i,e.doc.direction),c=t.ch,d=t.sticky;if(c>=i.text.length?(c=i.text.length,d="before"):c<=0&&(c=0,d="after"),!l)return a("before"==d?c-1:c,"before"==d);var u=Ce(l,c,d),h=Pa,p=s(c,u,"before"==d);return null!=h&&(p.other=s(c,h,"before"!=d)),p}function un(e,t){var n=0;t=U(e.doc,t),e.options.lineWrapping||(n=yn(e.display)*t.ch);var i=F(e.doc,t.line),r=ye(i)+Bt(e.display);return{left:n,right:n,top:r,bottom:r+i.height}}function hn(e,t,n,i,r){var o=P(e,t,n);return o.xRel=r,i&&(o.outside=!0),o}function pn(e,t,n){var i=e.doc;if((n+=e.display.viewOffset)<0)return hn(i.first,0,null,!0,-1);var r=A(i,n),o=i.first+i.size-1;if(r>o)return hn(i.first+i.size-1,F(i,o).text.length,null,!0,1);t<0&&(t=0);for(var a=F(i,r);;){var s=gn(e,a,r,t,n),l=ce(a),c=l&&l.find(0,!0);if(!l||!(s.ch>c.from.ch||s.ch==c.from.ch&&s.xRel>0))return s;r=L(a=c.to.line)}}function fn(e,t,n,i){var r=function(i){return sn(e,t,Gt(e,n,i),"line")},o=t.text.length,a=T(function(e){return r(e-1).bottom<=i},o,0);return o=T(function(e){return r(e).top>i},a,o),{begin:a,end:o}}function mn(e,t,n,i){return fn(e,t,n,sn(e,t,Gt(e,n,i),"line").top)}function gn(e,t,n,i,r){r-=ye(t);var o,a=0,s=t.text.length,l=Jt(e,t);if(ke(t,e.doc.direction)){if(e.options.lineWrapping){var c;a=(c=fn(e,t,l,r)).begin,s=c.end}o=new P(n,a);var d,u,h=dn(e,o,"line",t,l).left,p=h<i?1:-1,f=h-i;do{if(d=f,u=o,null==(o=Fe(e,t,o,p))||o.ch<a||s<=("before"==o.sticky?o.ch-1:o.ch)){o=u;break}f=dn(e,o,"line",t,l).left-i}while(p<0!=f<0&&Math.abs(f)<=Math.abs(d));if(Math.abs(f)>Math.abs(d)){if(f<0==d<0)throw new Error("Broke out of infinite loop in coordsCharInner");o=u}}else{var m=T(function(n){var o=sn(e,t,Gt(e,l,n),"line");return o.top>r?(s=Math.min(n,s),!0):!(o.bottom<=r)&&(o.left>i||!(o.right<i)&&i-o.left<o.right-i)},a,s);o=new P(n,m=S(t.text,m,1),m==s?"before":"after")}var g=dn(e,o,"line",t,l);return(r<g.top||g.bottom<r)&&(o.outside=!0),o.xRel=i<g.left?-1:i>g.right?1:0,o}function vn(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==Ja){Ja=i("pre");for(var r=0;r<49;++r)Ja.appendChild(document.createTextNode("x")),Ja.appendChild(i("br"));Ja.appendChild(document.createTextNode("x"))}n(e.measure,Ja);var o=Ja.offsetHeight/50;return o>3&&(e.cachedTextHeight=o),t(e.measure),o||1}function yn(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=i("span","xxxxxxxxxx"),r=i("pre",[t]);n(e.measure,r);var o=t.getBoundingClientRect(),a=(o.right-o.left)/10;return a>2&&(e.cachedCharWidth=a),a||10}function bn(e){for(var t=e.display,n={},i={},r=t.gutters.clientLeft,o=t.gutters.firstChild,a=0;o;o=o.nextSibling,++a)n[e.options.gutters[a]]=o.offsetLeft+o.clientLeft+r,i[e.options.gutters[a]]=o.clientWidth;return{fixedPos:wn(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:n,gutterWidth:i,wrapperWidth:t.wrapper.clientWidth}}function wn(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function xn(e){var t=vn(e.display),n=e.options.lineWrapping,i=n&&Math.max(5,e.display.scroller.clientWidth/yn(e.display)-3);return function(r){if(ge(e.doc,r))return 0;var o=0;if(r.widgets)for(var a=0;a<r.widgets.length;a++)r.widgets[a].height&&(o+=r.widgets[a].height);return n?o+(Math.ceil(r.text.length/i)||1)*t:o+t}}function Cn(e){var t=e.doc,n=xn(e);t.iter(function(e){var t=n(e);t!=e.height&&N(e,t)})}function kn(e,t,n,i){var r=e.display;if(!n&&"true"==je(t).getAttribute("cm-not-content"))return null;var o,a,s=r.lineSpace.getBoundingClientRect();try{o=t.clientX-s.left,a=t.clientY-s.top}catch(t){return null}var l,c=pn(e,o,a);if(i&&1==c.xRel&&(l=F(e.doc,c.line).text).length==c.ch){var d=u(l,l.length,e.options.tabSize)-l.length;c=P(c.line,Math.max(0,Math.round((o-Ht(e.display).left)/yn(e.display))-d))}return c}function Sn(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var n=e.display.view,i=0;i<n.length;i++)if((t-=n[i].size)<0)return i}function Tn(e){e.display.input.showSelection(e.display.input.prepareSelection())}function En(e,t){for(var n=e.doc,i={},r=i.cursors=document.createDocumentFragment(),o=i.selection=document.createDocumentFragment(),a=0;a<n.sel.ranges.length;a++)if(!1!==t||a!=n.sel.primIndex){var s=n.sel.ranges[a];if(!(s.from().line>=e.display.viewTo||s.to().line<e.display.viewFrom)){var l=s.empty();(l||e.options.showCursorWhenSelecting)&&Fn(e,s.head,r),l||_n(e,s,o)}}return i}function Fn(e,t,n){var r=dn(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),o=n.appendChild(i("div"," ","CodeMirror-cursor"));if(o.style.left=r.left+"px",o.style.top=r.top+"px",o.style.height=Math.max(0,r.bottom-r.top)*e.options.cursorHeight+"px",r.other){var a=n.appendChild(i("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));a.style.display="",a.style.left=r.other.left+"px",a.style.top=r.other.top+"px",a.style.height=.85*(r.other.bottom-r.other.top)+"px"}}function _n(e,t,n){function r(e,t,n,r){t<0&&(t=0),t=Math.round(t),r=Math.round(r),l.appendChild(i("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(null==n?u-e:n)+"px;\n                             height: "+(r-t)+"px"))}function o(t,n,i){function o(n,i){return cn(e,P(t,n),"div",c,i)}var a,l,c=F(s,t),h=c.text.length;return xe(ke(c,s.direction),n||0,null==i?h:i,function(e,t,s){var c,p,f,m=o(e,"left");if(e==t)c=m,p=f=m.left;else{if(c=o(t-1,"right"),"rtl"==s){var g=m;m=c,c=g}p=m.left,f=c.right}null==n&&0==e&&(p=d),c.top-m.top>3&&(r(p,m.top,null,m.bottom),p=d,m.bottom<c.top&&r(p,m.bottom,null,c.top)),null==i&&t==h&&(f=u),(!a||m.top<a.top||m.top==a.top&&m.left<a.left)&&(a=m),(!l||c.bottom>l.bottom||c.bottom==l.bottom&&c.right>l.right)&&(l=c),p<d+1&&(p=d),r(p,c.top,f-p,c.bottom)}),{start:a,end:l}}var a=e.display,s=e.doc,l=document.createDocumentFragment(),c=Ht(e.display),d=c.left,u=Math.max(a.sizerWidth,Ut(e)-a.sizer.offsetLeft)-c.right,h=t.from(),p=t.to();if(h.line==p.line)o(h.line,h.ch,p.ch);else{var f=F(s,h.line),m=F(s,p.line),g=ue(f)==ue(m),v=o(h.line,h.ch,g?f.text.length+1:null).end,y=o(p.line,g?0:null,p.ch).start;g&&(v.top<y.top-2?(r(v.right,v.top,null,v.bottom),r(d,y.top,y.left,y.bottom)):r(v.right,v.top,y.left-v.right,v.bottom)),v.bottom<y.top&&r(d,v.bottom,null,y.top)}n.appendChild(l)}function Mn(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var n=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0?t.blinker=setInterval(function(){return t.cursorDiv.style.visibility=(n=!n)?"":"hidden"},e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function Nn(e){e.state.focused||(e.display.input.focus(),An(e))}function Ln(e){e.state.delayingBlurEvent=!0,setTimeout(function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,Rn(e))},100)}function An(e,t){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(Ne(e,"focus",e,t),e.state.focused=!0,s(e.display.wrapper,"CodeMirror-focused"),e.curOp||e.display.selForContextMenu==e.doc.sel||(e.display.input.reset(),ia&&setTimeout(function(){return e.display.input.reset(!0)},20)),e.display.input.receivedFocus()),Mn(e))}function Rn(e,t){e.state.delayingBlurEvent||(e.state.focused&&(Ne(e,"blur",e,t),e.state.focused=!1,wa(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150))}function In(e){for(var t=e.display,n=t.lineDiv.offsetTop,i=0;i<t.view.length;i++){var r=t.view[i],o=void 0;if(!r.hidden){if(ta&&na<8){var a=r.node.offsetTop+r.node.offsetHeight;o=a-n,n=a}else{var s=r.node.getBoundingClientRect();o=s.bottom-s.top}var l=r.line.height-o;if(o<2&&(o=vn(t)),(l>.001||l<-.001)&&(N(r.line,o),Pn(r.line),r.rest))for(var c=0;c<r.rest.length;c++)Pn(r.rest[c])}}}function Pn(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.parentNode.offsetHeight}function On(e,t,n){var i=n&&null!=n.top?Math.max(0,n.top):e.scroller.scrollTop;i=Math.floor(i-Bt(e));var r=n&&null!=n.bottom?n.bottom:i+e.wrapper.clientHeight,o=A(t,i),a=A(t,r);if(n&&n.ensure){var s=n.ensure.from.line,l=n.ensure.to.line;s<o?(o=s,a=A(t,ye(F(t,s))+e.wrapper.clientHeight)):Math.min(l,t.lastLine())>=a&&(o=A(t,ye(F(t,l))-e.wrapper.clientHeight),a=l)}return{from:o,to:Math.max(a,o+1)}}function Dn(e){var t=e.display,n=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var i=wn(t)-t.scroller.scrollLeft+e.doc.scrollLeft,r=t.gutters.offsetWidth,o=i+"px",a=0;a<n.length;a++)if(!n[a].hidden){e.options.fixedGutter&&(n[a].gutter&&(n[a].gutter.style.left=o),n[a].gutterBackground&&(n[a].gutterBackground.style.left=o));var s=n[a].alignable;if(s)for(var l=0;l<s.length;l++)s[l].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=i+r+"px")}}function Bn(e){if(!e.options.lineNumbers)return!1;var t=e.doc,n=I(e.options,t.first+t.size-1),r=e.display;if(n.length!=r.lineNumChars){var o=r.measure.appendChild(i("div",[i("div",n)],"CodeMirror-linenumber CodeMirror-gutter-elt")),a=o.firstChild.offsetWidth,s=o.offsetWidth-a;return r.lineGutter.style.width="",r.lineNumInnerWidth=Math.max(a,r.lineGutter.offsetWidth-s)+s+2,r.lineNumWidth=r.lineNumInnerWidth+s,r.lineNumChars=r.lineNumInnerWidth?n.length:-1,r.lineGutter.style.width=r.lineNumWidth+"px",Mi(e),!0}return!1}function jn(e,t){if(!Le(e,"scrollCursorIntoView")){var n=e.display,r=n.sizer.getBoundingClientRect(),o=null;if(t.top+r.top<0?o=!0:t.bottom+r.top>(window.innerHeight||document.documentElement.clientHeight)&&(o=!1),null!=o&&!ca){var a=i("div","​",null,"position: absolute;\n                         top: "+(t.top-n.viewOffset-Bt(e.display))+"px;\n                         height: "+(t.bottom-t.top+$t(e)+n.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(a),a.scrollIntoView(o),e.display.lineSpace.removeChild(a)}}}function Hn(e,t,n,i){null==i&&(i=0);for(var r,o=0;o<5;o++){var a=!1,s=dn(e,t),l=n&&n!=t?dn(e,n):s,c=Un(e,r={left:Math.min(s.left,l.left),top:Math.min(s.top,l.top)-i,right:Math.max(s.left,l.left),bottom:Math.max(s.bottom,l.bottom)+i}),d=e.doc.scrollTop,u=e.doc.scrollLeft;if(null!=c.scrollTop&&(Jn(e,c.scrollTop),Math.abs(e.doc.scrollTop-d)>1&&(a=!0)),null!=c.scrollLeft&&(Qn(e,c.scrollLeft),Math.abs(e.doc.scrollLeft-u)>1&&(a=!0)),!a)break}return r}function $n(e,t){var n=Un(e,t);null!=n.scrollTop&&Jn(e,n.scrollTop),null!=n.scrollLeft&&Qn(e,n.scrollLeft)}function Un(e,t){var n=e.display,i=vn(e.display);t.top<0&&(t.top=0);var r=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:n.scroller.scrollTop,o=qt(e),a={};t.bottom-t.top>o&&(t.bottom=t.top+o);var s=e.doc.height+jt(n),l=t.top<i,c=t.bottom>s-i;if(t.top<r)a.scrollTop=l?0:t.top;else if(t.bottom>r+o){var d=Math.min(t.top,(c?s:t.bottom)-o);d!=r&&(a.scrollTop=d)}var u=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:n.scroller.scrollLeft,h=Ut(e)-(e.options.fixedGutter?n.gutters.offsetWidth:0),p=t.right-t.left>h;return p&&(t.right=t.left+h),t.left<10?a.scrollLeft=0:t.left<u?a.scrollLeft=Math.max(0,t.left-(p?0:10)):t.right>h+u-3&&(a.scrollLeft=t.right+(p?0:10)-h),a}function qn(e,t){null!=t&&(Kn(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function Wn(e){Kn(e);var t=e.getCursor(),n=t,i=t;e.options.lineWrapping||(n=t.ch?P(t.line,t.ch-1):t,i=P(t.line,t.ch+1)),e.curOp.scrollToPos={from:n,to:i,margin:e.options.cursorScrollMargin}}function zn(e,t,n){null==t&&null==n||Kn(e),null!=t&&(e.curOp.scrollLeft=t),null!=n&&(e.curOp.scrollTop=n)}function Vn(e,t){Kn(e),e.curOp.scrollToPos=t}function Kn(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,Yn(e,un(e,t.from),un(e,t.to),t.margin))}function Yn(e,t,n,i){var r=Un(e,{left:Math.min(t.left,n.left),top:Math.min(t.top,n.top)-i,right:Math.max(t.right,n.right),bottom:Math.max(t.bottom,n.bottom)+i});zn(e,r.scrollLeft,r.scrollTop)}function Jn(e,t){Math.abs(e.doc.scrollTop-t)<2||(Qo||Fi(e,{top:t}),Gn(e,t,!0),Qo&&Fi(e),wi(e,100))}function Gn(e,t,n){t=Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t),(e.display.scroller.scrollTop!=t||n)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function Qn(e,t,n,i){t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),(n?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)&&!i||(e.doc.scrollLeft=t,Dn(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function Xn(e){var t=e.display,n=t.gutters.offsetWidth,i=Math.round(e.doc.height+jt(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?n:0,docHeight:i,scrollHeight:i+$t(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:n}}function Zn(e,t){t||(t=Xn(e));var n=e.display.barWidth,i=e.display.barHeight;ei(e,t);for(var r=0;r<4&&n!=e.display.barWidth||i!=e.display.barHeight;r++)n!=e.display.barWidth&&e.options.lineWrapping&&In(e),ei(e,Xn(e)),n=e.display.barWidth,i=e.display.barHeight}function ei(e,t){var n=e.display,i=n.scrollbars.update(t);n.sizer.style.paddingRight=(n.barWidth=i.right)+"px",n.sizer.style.paddingBottom=(n.barHeight=i.bottom)+"px",n.heightForcer.style.borderBottom=i.bottom+"px solid transparent",i.right&&i.bottom?(n.scrollbarFiller.style.display="block",n.scrollbarFiller.style.height=i.bottom+"px",n.scrollbarFiller.style.width=i.right+"px"):n.scrollbarFiller.style.display="",i.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(n.gutterFiller.style.display="block",n.gutterFiller.style.height=i.bottom+"px",n.gutterFiller.style.width=t.gutterWidth+"px"):n.gutterFiller.style.display=""}function ti(e){e.display.scrollbars&&(e.display.scrollbars.clear(),e.display.scrollbars.addClass&&wa(e.display.wrapper,e.display.scrollbars.addClass)),e.display.scrollbars=new is[e.options.scrollbarStyle](function(t){e.display.wrapper.insertBefore(t,e.display.scrollbarFiller),Ba(t,"mousedown",function(){e.state.focused&&setTimeout(function(){return e.display.input.focus()},0)}),t.setAttribute("cm-not-content","true")},function(t,n){"horizontal"==n?Qn(e,t):Jn(e,t)},e),e.display.scrollbars.addClass&&s(e.display.wrapper,e.display.scrollbars.addClass)}function ni(e){e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++rs},bt(e.curOp)}function ii(e){xt(e.curOp,function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;ri(e)})}function ri(e){for(var t=e.ops,n=0;n<t.length;n++)oi(t[n]);for(var i=0;i<t.length;i++)ai(t[i]);for(var r=0;r<t.length;r++)si(t[r]);for(var o=0;o<t.length;o++)li(t[o]);for(var a=0;a<t.length;a++)ci(t[a])}function oi(e){var t=e.cm,n=t.display;Ci(t),e.updateMaxLine&&we(t),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<n.viewFrom||e.scrollToPos.to.line>=n.viewTo)||n.maxLineChanged&&t.options.lineWrapping,e.update=e.mustUpdate&&new os(t,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function ai(e){e.updatedDisplay=e.mustUpdate&&Ti(e.cm,e.update)}function si(e){var t=e.cm,n=t.display;e.updatedDisplay&&In(t),e.barMeasure=Xn(t),n.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=Kt(t,n.maxLine,n.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(n.scroller.clientWidth,n.sizer.offsetLeft+e.adjustWidthTo+$t(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,n.sizer.offsetLeft+e.adjustWidthTo-Ut(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=n.input.prepareSelection(e.focus))}function li(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&Qn(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var n=e.focus&&e.focus==a()&&(!document.hasFocus||document.hasFocus());e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,n),(e.updatedDisplay||e.startHeight!=t.doc.height)&&Zn(t,e.barMeasure),e.updatedDisplay&&Ni(t,e.barMeasure),e.selectionChanged&&Mn(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),n&&Nn(e.cm)}function ci(e){var t=e.cm,n=t.display,i=t.doc;e.updatedDisplay&&Ei(t,e.update),null==n.wheelStartX||null==e.scrollTop&&null==e.scrollLeft&&!e.scrollToPos||(n.wheelStartX=n.wheelStartY=null),null!=e.scrollTop&&Gn(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&Qn(t,e.scrollLeft,!0,!0),e.scrollToPos&&jn(t,Hn(t,U(i,e.scrollToPos.from),U(i,e.scrollToPos.to),e.scrollToPos.margin));var r=e.maybeHiddenMarkers,o=e.maybeUnhiddenMarkers;if(r)for(var a=0;a<r.length;++a)r[a].lines.length||Ne(r[a],"hide");if(o)for(var s=0;s<o.length;++s)o[s].lines.length&&Ne(o[s],"unhide");n.wrapper.offsetHeight&&(i.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&Ne(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function di(e,t){if(e.curOp)return t();ni(e);try{return t()}finally{ii(e)}}function ui(e,t){return function(){if(e.curOp)return t.apply(e,arguments);ni(e);try{return t.apply(e,arguments)}finally{ii(e)}}}function hi(e){return function(){if(this.curOp)return e.apply(this,arguments);ni(this);try{return e.apply(this,arguments)}finally{ii(this)}}}function pi(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);ni(t);try{return e.apply(this,arguments)}finally{ii(t)}}}function fi(e,t,n,i){null==t&&(t=e.doc.first),null==n&&(n=e.doc.first+e.doc.size),i||(i=0);var r=e.display;if(i&&n<r.viewTo&&(null==r.updateLineNumbers||r.updateLineNumbers>t)&&(r.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=r.viewTo)Ia&&fe(e.doc,t)<r.viewTo&&gi(e);else if(n<=r.viewFrom)Ia&&me(e.doc,n+i)>r.viewFrom?gi(e):(r.viewFrom+=i,r.viewTo+=i);else if(t<=r.viewFrom&&n>=r.viewTo)gi(e);else if(t<=r.viewFrom){var o=vi(e,n,n+i,1);o?(r.view=r.view.slice(o.index),r.viewFrom=o.lineN,r.viewTo+=i):gi(e)}else if(n>=r.viewTo){var a=vi(e,t,t,-1);a?(r.view=r.view.slice(0,a.index),r.viewTo=a.lineN):gi(e)}else{var s=vi(e,t,t,-1),l=vi(e,n,n+i,1);s&&l?(r.view=r.view.slice(0,s.index).concat(yt(e,s.lineN,l.lineN)).concat(r.view.slice(l.index)),r.viewTo+=i):gi(e)}var c=r.externalMeasured;c&&(n<c.lineN?c.lineN+=i:t<c.lineN+c.size&&(r.externalMeasured=null))}function mi(e,t,n){e.curOp.viewChanged=!0;var i=e.display,r=e.display.externalMeasured;if(r&&t>=r.lineN&&t<r.lineN+r.size&&(i.externalMeasured=null),!(t<i.viewFrom||t>=i.viewTo)){var o=i.view[Sn(e,t)];if(null!=o.node){var a=o.changes||(o.changes=[]);-1==h(a,n)&&a.push(n)}}}function gi(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function vi(e,t,n,i){var r,o=Sn(e,t),a=e.display.view;if(!Ia||n==e.doc.first+e.doc.size)return{index:o,lineN:n};for(var s=e.display.viewFrom,l=0;l<o;l++)s+=a[l].size;if(s!=t){if(i>0){if(o==a.length-1)return null;r=s+a[o].size-t,o++}else r=s-t;t+=r,n+=r}for(;fe(e.doc,n)!=n;){if(o==(i<0?0:a.length-1))return null;n+=i*a[o-(i<0?1:0)].size,o+=i}return{index:o,lineN:n}}function yi(e,t,n){var i=e.display;0==i.view.length||t>=i.viewTo||n<=i.viewFrom?(i.view=yt(e,t,n),i.viewFrom=t):(i.viewFrom>t?i.view=yt(e,t,i.viewFrom).concat(i.view):i.viewFrom<t&&(i.view=i.view.slice(Sn(e,t))),i.viewFrom=t,i.viewTo<n?i.view=i.view.concat(yt(e,i.viewTo,n)):i.viewTo>n&&(i.view=i.view.slice(0,Sn(e,n)))),i.viewTo=n}function bi(e){for(var t=e.display.view,n=0,i=0;i<t.length;i++){var r=t[i];r.hidden||r.node&&!r.changes||++n}return n}function wi(e,t){e.doc.mode.startState&&e.doc.frontier<e.display.viewTo&&e.state.highlight.set(t,c(xi,e))}function xi(e){var t=e.doc;if(t.frontier<t.first&&(t.frontier=t.first),!(t.frontier>=e.display.viewTo)){var n=+new Date+e.options.workTime,i=Ye(t.mode,Ze(e,t.frontier)),r=[];t.iter(t.frontier,Math.min(t.first+t.size,e.display.viewTo+500),function(o){if(t.frontier>=e.display.viewFrom){var a=o.styles,s=o.text.length>e.options.maxHighlightLength,l=Qe(e,o,s?Ye(t.mode,i):i,!0);o.styles=l.styles;var c=o.styleClasses,d=l.classes;d?o.styleClasses=d:c&&(o.styleClasses=null);for(var u=!a||a.length!=o.styles.length||c!=d&&(!c||!d||c.bgClass!=d.bgClass||c.textClass!=d.textClass),h=0;!u&&h<a.length;++h)u=a[h]!=o.styles[h];u&&r.push(t.frontier),o.stateAfter=s?i:Ye(t.mode,i)}else o.text.length<=e.options.maxHighlightLength&&et(e,o.text,i),o.stateAfter=t.frontier%5==0?Ye(t.mode,i):null;if(++t.frontier,+new Date>n)return wi(e,e.options.workDelay),!0}),r.length&&di(e,function(){for(var t=0;t<r.length;t++)mi(e,r[t],"text")})}}function Ci(e){var t=e.display;!t.scrollbarsClipped&&t.scroller.offsetWidth&&(t.nativeBarWidth=t.scroller.offsetWidth-t.scroller.clientWidth,t.heightForcer.style.height=$t(e)+"px",t.sizer.style.marginBottom=-t.nativeBarWidth+"px",t.sizer.style.borderRightWidth=$t(e)+"px",t.scrollbarsClipped=!0)}function ki(e){if(e.hasFocus())return null;var t=a();if(!t||!o(e.display.lineDiv,t))return null;var n={activeElt:t};if(window.getSelection){var i=window.getSelection();i.anchorNode&&i.extend&&o(e.display.lineDiv,i.anchorNode)&&(n.anchorNode=i.anchorNode,n.anchorOffset=i.anchorOffset,n.focusNode=i.focusNode,n.focusOffset=i.focusOffset)}return n}function Si(e){if(e&&e.activeElt&&e.activeElt!=a()&&(e.activeElt.focus(),e.anchorNode&&o(document.body,e.anchorNode)&&o(document.body,e.focusNode))){var t=window.getSelection(),n=document.createRange();n.setEnd(e.anchorNode,e.anchorOffset),n.collapse(!1),t.removeAllRanges(),t.addRange(n),t.extend(e.focusNode,e.focusOffset)}}function Ti(e,n){var i=e.display,r=e.doc;if(n.editorIsHidden)return gi(e),!1;if(!n.force&&n.visible.from>=i.viewFrom&&n.visible.to<=i.viewTo&&(null==i.updateLineNumbers||i.updateLineNumbers>=i.viewTo)&&i.renderedView==i.view&&0==bi(e))return!1;Bn(e)&&(gi(e),n.dims=bn(e));var o=r.first+r.size,a=Math.max(n.visible.from-e.options.viewportMargin,r.first),s=Math.min(o,n.visible.to+e.options.viewportMargin);i.viewFrom<a&&a-i.viewFrom<20&&(a=Math.max(r.first,i.viewFrom)),i.viewTo>s&&i.viewTo-s<20&&(s=Math.min(o,i.viewTo)),Ia&&(a=fe(e.doc,a),s=me(e.doc,s));var l=a!=i.viewFrom||s!=i.viewTo||i.lastWrapHeight!=n.wrapperHeight||i.lastWrapWidth!=n.wrapperWidth;yi(e,a,s),i.viewOffset=ye(F(e.doc,i.viewFrom)),e.display.mover.style.top=i.viewOffset+"px";var c=bi(e);if(!l&&0==c&&!n.force&&i.renderedView==i.view&&(null==i.updateLineNumbers||i.updateLineNumbers>=i.viewTo))return!1;var d=ki(e);return c>4&&(i.lineDiv.style.display="none"),_i(e,i.updateLineNumbers,n.dims),c>4&&(i.lineDiv.style.display=""),i.renderedView=i.view,Si(d),t(i.cursorDiv),t(i.selectionDiv),i.gutters.style.height=i.sizer.style.minHeight=0,l&&(i.lastWrapHeight=n.wrapperHeight,i.lastWrapWidth=n.wrapperWidth,wi(e,400)),i.updateLineNumbers=null,!0}function Ei(e,t){for(var n=t.viewport,i=!0;(i&&e.options.lineWrapping&&t.oldDisplayWidth!=Ut(e)||(n&&null!=n.top&&(n={top:Math.min(e.doc.height+jt(e.display)-qt(e),n.top)}),t.visible=On(e.display,e.doc,n),!(t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)))&&Ti(e,t);i=!1){In(e);var r=Xn(e);Tn(e),Zn(e,r),Ni(e,r)}t.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function Fi(e,t){var n=new os(e,t);if(Ti(e,n)){In(e),Ei(e,n);var i=Xn(e);Tn(e),Zn(e,i),Ni(e,i),n.finish()}}function _i(e,n,i){function r(t){var n=t.nextSibling;return ia&&pa&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),n}for(var o=e.display,a=e.options.lineNumbers,s=o.lineDiv,l=s.firstChild,c=o.view,d=o.viewFrom,u=0;u<c.length;u++){var p=c[u];if(p.hidden);else if(p.node&&p.node.parentNode==s){for(;l!=p.node;)l=r(l);var f=a&&null!=n&&n<=d&&p.lineNumber;p.changes&&(h(p.changes,"gutter")>-1&&(f=!1),St(e,p,d,i)),f&&(t(p.lineNumber),p.lineNumber.appendChild(document.createTextNode(I(e.options,d)))),l=p.node.nextSibling}else{var m=At(e,p,d,i);s.insertBefore(m,l)}d+=p.size}for(;l;)l=r(l)}function Mi(e){var t=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=t+"px"}function Ni(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+$t(e)+"px"}function Li(e){var n=e.display.gutters,r=e.options.gutters;t(n);for(var o=0;o<r.length;++o){var a=r[o],s=n.appendChild(i("div",null,"CodeMirror-gutter "+a));"CodeMirror-linenumbers"==a&&(e.display.lineGutter=s,s.style.width=(e.display.lineNumWidth||1)+"px")}n.style.display=o?"":"none",Mi(e)}function Ai(e){var t=h(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):t>-1&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}function Ri(e){var t=e.wheelDeltaX,n=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==n&&e.detail&&e.axis==e.VERTICAL_AXIS?n=e.detail:null==n&&(n=e.wheelDelta),{x:t,y:n}}function Ii(e){var t=Ri(e);return t.x*=ss,t.y*=ss,t}function Pi(e,t){var n=Ri(t),i=n.x,r=n.y,o=e.display,a=o.scroller,s=a.scrollWidth>a.clientWidth,l=a.scrollHeight>a.clientHeight;if(i&&s||r&&l){if(r&&pa&&ia)e:for(var c=t.target,d=o.view;c!=a;c=c.parentNode)for(var u=0;u<d.length;u++)if(d[u].node==c){e.display.currentWheelTarget=c;break e}if(i&&!Qo&&!aa&&null!=ss)return r&&l&&Jn(e,Math.max(0,a.scrollTop+r*ss)),Qn(e,Math.max(0,a.scrollLeft+i*ss)),(!r||r&&l)&&Pe(t),void(o.wheelStartX=null);if(r&&null!=ss){var h=r*ss,p=e.doc.scrollTop,f=p+o.wrapper.clientHeight;h<0?p=Math.max(0,p+h-50):f=Math.min(e.doc.height,f+h+50),Fi(e,{top:p,bottom:f})}as<20&&(null==o.wheelStartX?(o.wheelStartX=a.scrollLeft,o.wheelStartY=a.scrollTop,o.wheelDX=i,o.wheelDY=r,setTimeout(function(){if(null!=o.wheelStartX){var e=a.scrollLeft-o.wheelStartX,t=a.scrollTop-o.wheelStartY,n=t&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,n&&(ss=(ss*as+n)/(as+1),++as)}},200)):(o.wheelDX+=i,o.wheelDY+=r))}}function Oi(e,t){var n=e[t];e.sort(function(e,t){return O(e.from(),t.from())}),t=h(e,n);for(var i=1;i<e.length;i++){var r=e[i],o=e[i-1];if(O(o.to(),r.from())>=0){var a=H(o.from(),r.from()),s=j(o.to(),r.to()),l=o.empty()?r.from()==r.head:o.from()==o.head;i<=t&&--t,e.splice(--i,2,new cs(l?s:a,l?a:s))}}return new ls(e,t)}function Di(e,t){return new ls([new cs(e,t||e)],0)}function Bi(e){return e.text?P(e.from.line+e.text.length-1,m(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function ji(e,t){if(O(e,t.from)<0)return e;if(O(e,t.to)<=0)return Bi(t);var n=e.line+t.text.length-(t.to.line-t.from.line)-1,i=e.ch;return e.line==t.to.line&&(i+=Bi(t).ch-t.to.ch),P(n,i)}function Hi(e,t){for(var n=[],i=0;i<e.sel.ranges.length;i++){var r=e.sel.ranges[i];n.push(new cs(ji(r.anchor,t),ji(r.head,t)))}return Oi(n,e.sel.primIndex)}function $i(e,t,n){return e.line==t.line?P(n.line,e.ch-t.ch+n.ch):P(n.line+(e.line-t.line),e.ch)}function Ui(e,t,n){for(var i=[],r=P(e.first,0),o=r,a=0;a<t.length;a++){var s=t[a],l=$i(s.from,r,o),c=$i(Bi(s),r,o);if(r=s.to,o=c,"around"==n){var d=e.sel.ranges[a],u=O(d.head,d.anchor)<0;i[a]=new cs(u?c:l,u?l:c)}else i[a]=new cs(l,l)}return new ls(i,e.sel.primIndex)}function qi(e){e.doc.mode=Ve(e.options,e.doc.modeOption),Wi(e)}function Wi(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.frontier=e.doc.first,wi(e,100),e.state.modeGen++,e.curOp&&fi(e)}function zi(e,t){return 0==t.from.ch&&0==t.to.ch&&""==m(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function Vi(e,t,n,i){function r(e){return n?n[e]:null}function o(e,n,r){st(e,n,r,i),Ct(e,"change",e,t)}function a(e,t){for(var n=[],o=e;o<t;++o)n.push(new Ya(c[o],r(o),i));return n}var s=t.from,l=t.to,c=t.text,d=F(e,s.line),u=F(e,l.line),h=m(c),p=r(c.length-1),f=l.line-s.line;if(t.full)e.insert(0,a(0,c.length)),e.remove(c.length,e.size-c.length);else if(zi(e,t)){var g=a(0,c.length-1);o(u,u.text,p),f&&e.remove(s.line,f),g.length&&e.insert(s.line,g)}else if(d==u)if(1==c.length)o(d,d.text.slice(0,s.ch)+h+d.text.slice(l.ch),p);else{var v=a(1,c.length-1);v.push(new Ya(h+d.text.slice(l.ch),p,i)),o(d,d.text.slice(0,s.ch)+c[0],r(0)),e.insert(s.line+1,v)}else if(1==c.length)o(d,d.text.slice(0,s.ch)+c[0]+u.text.slice(l.ch),r(0)),e.remove(s.line+1,f);else{o(d,d.text.slice(0,s.ch)+c[0],r(0)),o(u,h+u.text.slice(l.ch),p);var y=a(1,c.length-1);f>1&&e.remove(s.line+1,f-1),e.insert(s.line+1,y)}Ct(e,"change",e,t)}function Ki(e,t,n){function i(e,r,o){if(e.linked)for(var a=0;a<e.linked.length;++a){var s=e.linked[a];if(s.doc!=r){var l=o&&s.sharedHist;n&&!l||(t(s.doc,l),i(s.doc,e,l))}}}i(e,null,!0)}function Yi(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,Cn(e),qi(e),Ji(e),e.options.lineWrapping||we(e),e.options.mode=t.modeOption,fi(e)}function Ji(e){("rtl"==e.doc.direction?s:wa)(e.display.lineDiv,"CodeMirror-rtl")}function Gi(e){di(e,function(){Ji(e),fi(e)})}function Qi(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function Xi(e,t){var n={from:B(t.from),to:Bi(t),text:_(e,t.from,t.to)};return or(e,n,t.from.line,t.to.line+1),Ki(e,function(e){return or(e,n,t.from.line,t.to.line+1)},!0),n}function Zi(e){for(;e.length&&m(e).ranges;)e.pop()}function er(e,t){return t?(Zi(e.done),m(e.done)):e.done.length&&!m(e.done).ranges?m(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),m(e.done)):void 0}function tr(e,t,n,i){var r=e.history;r.undone.length=0;var o,a,s=+new Date;if(!((t.text||[]).length>1)&&(r.lastOp==i||r.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&r.lastModTime>s-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=er(r,r.lastOp==i)))a=m(o.changes),0==O(t.from,t.to)&&0==O(t.from,a.to)?a.to=Bi(t):o.changes.push(Xi(e,t));else{"setValue"!=t.origin&&e.cm.cid&&e.cm.editor.fences.addToUndoManager(e.cm,!1,"undo");var l=m(r.done);for(l&&l.ranges||rr(e.sel,r.done),o={changes:[Xi(e,t)],generation:r.generation},r.done.push(o);r.done.length>r.undoDepth;)r.done.shift(),r.done[0].ranges||r.done.shift()}r.done.push(n),r.generation=++r.maxGeneration,r.lastModTime=r.lastSelTime=s,r.lastOp=r.lastSelOp=i,r.lastOrigin=r.lastSelOrigin=t.origin,a||Ne(e,"historyAdded")}function nr(e,t,n,i){var r=t.charAt(0);return"*"==r||"+"==r&&n.ranges.length==i.ranges.length&&n.somethingSelected()==i.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}function ir(e,t,n,i){var r=e.history,o=i&&i.origin;n==r.lastSelOp||o&&r.lastSelOrigin==o&&(r.lastModTime==r.lastSelTime&&r.lastOrigin==o||nr(e,o,m(r.done),t))?r.done[r.done.length-1]=t:rr(t,r.done),r.lastSelTime=+new Date,r.lastSelOrigin=o,r.lastSelOp=n,i&&!1!==i.clearRedo&&Zi(r.undone)}function rr(e,t){var n=m(t);n&&n.ranges&&n.equals(e)||t.push(e)}function or(e,t,n,i){var r=t["spans_"+e.id],o=0;e.iter(Math.max(e.first,n),Math.min(e.first+e.size,i),function(n){n.markedSpans&&((r||(r=t["spans_"+e.id]={}))[o]=n.markedSpans),++o})}function ar(e){if(!e)return null;for(var t,n=0;n<e.length;++n)e[n].marker.explicitlyCleared?t||(t=e.slice(0,n)):t&&t.push(e[n]);return t?t.length?t:null:e}function sr(e,t){var n=t["spans_"+e.id];if(!n)return null;for(var i=[],r=0;r<t.text.length;++r)i.push(ar(n[r]));return i}function lr(e,t){var n=sr(e,t),i=Z(e,t);if(!n)return i;if(!i)return n;for(var r=0;r<n.length;++r){var o=n[r],a=i[r];if(o&&a)e:for(var s=0;s<a.length;++s){for(var l=a[s],c=0;c<o.length;++c)if(o[c].marker==l.marker)continue e;o.push(l)}else a&&(n[r]=a)}return n}function cr(e,t,n){for(var i=[],r=0;r<e.length;++r){var o=e[r];if(o.ranges)i.push(n?ls.prototype.deepCopy.call(o):o);else{var a=o.changes,s=[];i.push({changes:s});for(var l=0;l<a.length;++l){var c=a[l],d=void 0;if(s.push({from:c.from,to:c.to,text:c.text}),t)for(var u in c)(d=u.match(/^spans_(\d+)$/))&&h(t,Number(d[1]))>-1&&(m(s)[u]=c[u],delete c[u])}}}return i}function dr(e,t,n,i){if(e.cm&&e.cm.display.shift||e.extend){var r=t.anchor;if(i){var o=O(n,r)<0;o!=O(i,r)<0?(r=n,n=i):o!=O(n,i)<0&&(n=i)}return new cs(r,n)}return new cs(i||n,n)}function ur(e,t,n,i){vr(e,new ls([dr(e,e.sel.primary(),t,n)],0),i)}function hr(e,t,n){for(var i=[],r=0;r<e.sel.ranges.length;r++)i[r]=dr(e,e.sel.ranges[r],t[r],null);vr(e,Oi(i,e.sel.primIndex),n)}function pr(e,t,n,i){var r=e.sel.ranges.slice(0);r[t]=n,vr(e,Oi(r,e.sel.primIndex),i)}function fr(e,t,n,i){vr(e,Di(t,n),i)}function mr(e,t,n){var i={ranges:t.ranges,update:function(t){var n=this;this.ranges=[];for(var i=0;i<t.length;i++)n.ranges[i]=new cs(U(e,t[i].anchor),U(e,t[i].head))},origin:n&&n.origin};return Ne(e,"beforeSelectionChange",e,i),e.cm&&Ne(e.cm,"beforeSelectionChange",e.cm,i),i.ranges!=t.ranges?Oi(i.ranges,i.ranges.length-1):t}function gr(e,t,n){var i=e.history.done,r=m(i);r&&r.ranges?(i[i.length-1]=t,yr(e,t,n)):vr(e,t,n)}function vr(e,t,n){yr(e,t,n),ir(e,e.sel,e.cm?e.cm.curOp.id:NaN,n)}function yr(e,t,n){(Re(e,"beforeSelectionChange")||e.cm&&Re(e.cm,"beforeSelectionChange"))&&(t=mr(e,t,n)),br(e,xr(e,t,n&&n.bias||(O(t.primary().head,e.sel.primary().head)<0?-1:1),!0)),n&&!1===n.scroll||!e.cm||Wn(e.cm)}function br(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=!0,Ae(e.cm)),Ct(e,"cursorActivity",e))}function wr(e){br(e,xr(e,e.sel,null,!1))}function xr(e,t,n,i){for(var r,o=0;o<t.ranges.length;o++){var a=t.ranges[o],s=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[o],l=kr(e,a.anchor,s&&s.anchor,n,i),c=kr(e,a.head,s&&s.head,n,i);(r||l!=a.anchor||c!=a.head)&&(r||(r=t.ranges.slice(0,o)),r[o]=new cs(l,c))}return r?Oi(r,t.primIndex):t}function Cr(e,t,n,i,r){var o=F(e,t.line);if(o.markedSpans)for(var a=0;a<o.markedSpans.length;++a){var s=o.markedSpans[a],l=s.marker;if((null==s.from||(l.inclusiveLeft?s.from<=t.ch:s.from<t.ch))&&(null==s.to||(l.inclusiveRight?s.to>=t.ch:s.to>t.ch))){if(r&&(Ne(l,"beforeCursorEnter"),l.explicitlyCleared)){if(o.markedSpans){--a;continue}break}if(!l.atomic)continue;if(n){var c=l.find(i<0?1:-1),d=void 0;if((i<0?l.inclusiveRight:l.inclusiveLeft)&&(c=Sr(e,c,-i,c&&c.line==t.line?o:null)),c&&c.line==t.line&&(d=O(c,n))&&(i<0?d<0:d>0))return Cr(e,c,t,i,r)}var u=l.find(i<0?-1:1);return(i<0?l.inclusiveLeft:l.inclusiveRight)&&(u=Sr(e,u,i,u.line==t.line?o:null)),u?Cr(e,u,t,i,r):null}}return t}function kr(e,t,n,i,r){var o=i||1,a=Cr(e,t,n,o,r)||!r&&Cr(e,t,n,o,!0)||Cr(e,t,n,-o,r)||!r&&Cr(e,t,n,-o,!0);return a||(e.cantEdit=!0,P(e.first,0))}function Sr(e,t,n,i){return n<0&&0==t.ch?t.line>e.first?U(e,P(t.line-1)):null:n>0&&t.ch==(i||F(e,t.line)).text.length?t.line<e.first+e.size-1?P(t.line+1,0):null:new P(t.line,t.ch+n)}function Tr(e){e.setSelection(P(e.firstLine(),0),P(e.lastLine()),Fa)}function Er(e,t,n){var i={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return i.canceled=!0}};return n&&(i.update=function(t,n,r,o){t&&(i.from=U(e,t)),n&&(i.to=U(e,n)),r&&(i.text=r),void 0!==o&&(i.origin=o)}),Ne(e,"beforeChange",e,i),e.cm&&Ne(e.cm,"beforeChange",e.cm,i),i.canceled?null:{from:i.from,to:i.to,text:i.text,origin:i.origin}}function Fr(e,t,n){if(e.cm){if(!e.cm.curOp)return ui(e.cm,Fr)(e,t,n);if(e.cm.state.suppressEdits)return}if(!(Re(e,"beforeChange")||e.cm&&Re(e.cm,"beforeChange"))||(t=Er(e,t,!0))){var i=Ra&&!n&&te(e,t.from,t.to);if(i)for(var r=i.length-1;r>=0;--r)_r(e,{from:i[r].from,to:i[r].to,text:r?[""]:t.text});else _r(e,t)}}function _r(e,t){if(1!=t.text.length||""!=t.text[0]||0!=O(t.from,t.to)){var n=Hi(e,t);tr(e,t,n,e.cm?e.cm.curOp.id:NaN),Lr(e,t,n,Z(e,t));var i=[];Ki(e,function(e,n){n||-1!=h(i,e.history)||(Or(e.history,t),i.push(e.history)),Lr(e,t,null,Z(e,t))})}}function Mr(e,t,n){if(!e.cm||!e.cm.state.suppressEdits||n){for(var i,r=e.history,o=e.sel,a="undo"==t?r.done:r.undone,s="undo"==t?r.undone:r.done,l=0;l<a.length&&(i=a[l],n?!i.ranges||i.equals(e.sel):i.ranges);l++);if(l!=a.length){for(r.lastOrigin=r.lastSelOrigin=null;(i=a.pop()).ranges;){if(rr(i,s),n&&!i.equals(e.sel))return void vr(e,i,{clearRedo:!1});o=i}var c=[];rr(o,s),s.push({changes:c,generation:r.generation}),r.generation=i.generation||++r.maxGeneration;for(var d=Re(e,"beforeChange")||e.cm&&Re(e.cm,"beforeChange"),u=i.changes.length-1;u>=0;--u){var p=function(n){var r=i.changes[n];if(r.origin=t,d&&!Er(e,r,!1))return a.length=0,{};c.push(Xi(e,r));var o=n?Hi(e,r):m(a);Lr(e,r,o,lr(e,r)),!n&&e.cm&&e.cm.scrollIntoView({from:r.from,to:Bi(r)});var s=[];Ki(e,function(e,t){t||-1!=h(s,e.history)||(Or(e.history,r),s.push(e.history)),Lr(e,r,null,lr(e,r))})}(u);if(p)return p.v}}}}function Nr(e,t){if(0!=t&&(e.first+=t,e.sel=new ls(g(e.sel.ranges,function(e){return new cs(P(e.anchor.line+t,e.anchor.ch),P(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm)){fi(e.cm,e.first,e.first-t,t);for(var n=e.cm.display,i=n.viewFrom;i<n.viewTo;i++)mi(e.cm,i,"gutter")}}function Lr(e,t,n,i){if(e.cm&&!e.cm.curOp)return ui(e.cm,Lr)(e,t,n,i);if(t.to.line<e.first)Nr(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var r=t.text.length-1-(e.first-t.from.line);Nr(e,r),t={from:P(e.first,0),to:P(t.to.line+r,t.to.ch),text:[m(t.text)],origin:t.origin}}var o=e.lastLine();t.to.line>o&&(t={from:t.from,to:P(o,F(e,o).text.length),text:[t.text[0]],origin:t.origin}),t.removed=_(e,t.from,t.to),n||(n=Hi(e,t)),e.cm?Ar(e.cm,t,i):Vi(e,t,i),yr(e,n,Fa)}}function Ar(e,t,n){var i=e.doc,r=e.display,o=t.from,a=t.to,s=!1,l=o.line;e.options.lineWrapping||(l=L(ue(F(i,o.line))),i.iter(l,a.line+1,function(e){if(e==r.maxLine)return s=!0,!0})),i.sel.contains(t.from,t.to)>-1&&Ae(e),Vi(i,t,n,xn(e)),e.options.lineWrapping||(i.iter(l,o.line+t.text.length,function(e){var t=be(e);t>r.maxLineLength&&(r.maxLine=e,r.maxLineLength=t,r.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0)),i.frontier=Math.min(i.frontier,o.line-1),wi(e,400);var c=t.text.length-(a.line-o.line)-1;t.full?fi(e):o.line!=a.line||1!=t.text.length||zi(e.doc,t)?fi(e,o.line,a.line+1,c):mi(e,o.line,"text");var d=Re(e,"changes"),u=Re(e,"change");if(u||d){var h={from:o,to:a,text:t.text,removed:t.removed,origin:t.origin};u&&Ct(e,"change",e,h),d&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(h)}e.display.selForContextMenu=null}function Rr(e,t,n,i,r){if(i||(i=n),O(i,n)<0){var o=i;i=n,n=o}"string"==typeof t&&(t=e.splitLines(t)),Fr(e,{from:n,to:i,text:t,origin:r})}function Ir(e,t,n,i){n<e.line?e.line+=i:t<e.line&&(e.line=t,e.ch=0)}function Pr(e,t,n,i){for(var r=0;r<e.length;++r){var o=e[r],a=!0;if(o.ranges){o.copied||((o=e[r]=o.deepCopy()).copied=!0);for(var s=0;s<o.ranges.length;s++)Ir(o.ranges[s].anchor,t,n,i),Ir(o.ranges[s].head,t,n,i)}else{for(var l=0;l<o.changes.length;++l){var c=o.changes[l];if(n<c.from.line)c.from=P(c.from.line+i,c.from.ch),c.to=P(c.to.line+i,c.to.ch);else if(t<=c.to.line){a=!1;break}}a||(e.splice(0,r+1),r=0)}}}function Or(e,t){var n=t.from.line,i=t.to.line,r=t.text.length-(i-n)-1;Pr(e.done,n,i,r),Pr(e.undone,n,i,r)}function Dr(e,t,n,i){var r=t,o=t;return"number"==typeof t?o=F(e,$(e,t)):r=L(t),null==r?null:(i(o,r)&&e.cm&&mi(e.cm,r,n),o)}function Br(e,t,n){ye(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&qn(e,n)}function jr(e,t,n,i){var r=new hs(e,n,i),o=e.cm;return o&&r.noHScroll&&(o.display.alignWidgets=!0),Dr(e,t,"widget",function(t){var n=t.widgets||(t.widgets=[]);if(null==r.insertAt?n.push(r):n.splice(Math.min(n.length-1,Math.max(0,r.insertAt)),0,r),r.line=t,o&&!ge(e,t)){var i=ye(t)<e.scrollTop;N(t,t.height+Ot(r)),i&&qn(o,r.height),o.curOp.forceUpdate=!0}return!0}),Ct(o,"lineWidgetAdded",o,r,"number"==typeof t?t:L(t)),r}function Hr(e,t,n,i,o){if(i&&i.shared)return $r(e,t,n,i,o);if(e.cm&&!e.cm.curOp)return ui(e.cm,Hr)(e,t,n,i,o);var a=new fs(e,o),s=O(t,n);if(i&&d(i,a,!1),s>0||0==s&&!1!==a.clearWhenEmpty)return a;if(a.replacedWith&&(a.collapsed=!0,a.widgetNode=r("span",[a.replacedWith],"CodeMirror-widget"),i.handleMouseEvents||a.widgetNode.setAttribute("cm-ignore-events","true"),i.insertLeft&&(a.widgetNode.insertLeft=!0)),a.collapsed){if(de(e,t.line,t,n,a)||t.line!=n.line&&de(e,n.line,t,n,a))throw new Error("Inserting collapsed marker partially overlapping an existing one");V()}a.addToHistory&&tr(e,{from:t,to:n,origin:"markText"},e.sel,NaN);var l,c=t.line,u=e.cm;if(e.iter(c,n.line+1,function(e){u&&a.collapsed&&!u.options.lineWrapping&&ue(e)==u.display.maxLine&&(l=!0),a.collapsed&&c!=t.line&&N(e,0),G(e,new K(a,c==t.line?t.ch:null,c==n.line?n.ch:null)),++c}),a.collapsed&&e.iter(t.line,n.line+1,function(t){ge(e,t)&&N(t,0)}),a.clearOnEnter&&Ba(a,"beforeCursorEnter",function(){return a.clear()}),a.readOnly&&(z(),(e.history.done.length||e.history.undone.length)&&e.clearHistory()),a.collapsed&&(a.id=++ps,a.atomic=!0),u){if(l&&(u.curOp.updateMaxLine=!0),a.collapsed)fi(u,t.line,n.line+1);else if(a.className||a.title||a.startStyle||a.endStyle||a.css)for(var h=t.line;h<=n.line;h++)mi(u,h,"text");a.atomic&&wr(u.doc),Ct(u,"markerAdded",u,a)}return a}function $r(e,t,n,i,r){(i=d(i)).shared=!1;var o=[Hr(e,t,n,i,r)],a=o[0],s=i.widgetNode;return Ki(e,function(e){s&&(i.widgetNode=s.cloneNode(!0)),o.push(Hr(e,U(e,t),U(e,n),i,r));for(var l=0;l<e.linked.length;++l)if(e.linked[l].isParent)return;a=m(o)}),new ms(o,a)}function Ur(e){return e.findMarks(P(e.first,0),e.clipPos(P(e.lastLine())),function(e){return e.parent})}function qr(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=i.find(),o=e.clipPos(r.from),a=e.clipPos(r.to);if(O(o,a)){var s=Hr(e,o,a,i.primary,i.primary.type);i.markers.push(s),s.parent=i}}}function Wr(e){for(var t=0;t<e.length;t++)!function(t){var n=e[t],i=[n.primary.doc];Ki(n.primary.doc,function(e){return i.push(e)});for(var r=0;r<n.markers.length;r++){var o=n.markers[r];-1==h(i,o.doc)&&(o.parent=null,n.markers.splice(r--,1))}}(t)}function zr(e){var t=this;if(Yr(t),!Le(t,e)&&!Dt(t.display,e)){Pe(e),ta&&(ys=+new Date);var n=kn(t,e,!0),i=e.dataTransfer.files;if(n&&!t.isReadOnly())if(i&&i.length&&window.FileReader&&window.File)for(var r=i.length,o=Array(r),a=0,s=0;s<r;++s)!function(e,i){if(!t.options.allowDropFileTypes||-1!=h(t.options.allowDropFileTypes,e.type)){var s=new FileReader;s.onload=ui(t,function(){var e=s.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(e)&&(e=""),o[i]=e,++a==r){var l={from:n=U(t.doc,n),to:n,text:t.doc.splitLines(o.join(t.doc.lineSeparator())),origin:"paste"};Fr(t.doc,l),gr(t.doc,Di(n,Bi(l)))}}),s.readAsText(e)}}(i[s],s);else{if(t.state.draggingText&&t.doc.sel.contains(n)>-1)return t.state.draggingText(e),void setTimeout(function(){return t.display.input.focus()},20);try{var l=e.dataTransfer.getData("Text");if(l){var c;if(t.state.draggingText&&!t.state.draggingText.copy&&(c=t.listSelections()),yr(t.doc,Di(n,n)),c)for(var d=0;d<c.length;++d)Rr(t.doc,"",c[d].anchor,c[d].head,"drag");t.replaceSelection(l,"around","paste"),t.display.input.focus()}}catch(e){}}}}function Vr(e,t){if(ta&&(!e.state.draggingText||+new Date-ys<100))Be(t);else if(!Le(e,t)&&!Dt(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!sa)){var n=i("img",null,null,"position: fixed; left: 0; top: 0;");n.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",aa&&(n.width=n.height=1,e.display.wrapper.appendChild(n),n._top=n.offsetTop),t.dataTransfer.setDragImage(n,0,0),aa&&n.parentNode.removeChild(n)}}function Kr(e,t){var r=kn(e,t);if(r){var o=document.createDocumentFragment();Fn(e,r,o),e.display.dragCursor||(e.display.dragCursor=i("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),n(e.display.dragCursor,o)}}function Yr(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function Jr(e){if(document.body.getElementsByClassName)for(var t=document.body.getElementsByClassName("CodeMirror"),n=0;n<t.length;n++){var i=t[n].CodeMirror;i&&e(i)}}function Gr(){bs||(Qr(),bs=!0)}function Qr(){var e;Ba(window,"resize",function(){null==e&&(e=setTimeout(function(){e=null,Jr(Xr)},100))}),Ba(window,"blur",function(){return Jr(Rn)})}function Xr(e){var t=e.display;t.lastWrapHeight==t.wrapper.clientHeight&&t.lastWrapWidth==t.wrapper.clientWidth||(t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize())}function Zr(e){var t=e.split(/-(?!$)/);e=t[t.length-1];for(var n,i,r,o,a=0;a<t.length-1;a++){var s=t[a];if(/^(cmd|meta|m)$/i.test(s))o=!0;else if(/^a(lt)?$/i.test(s))n=!0;else if(/^(c|ctrl|control)$/i.test(s))i=!0;else{if(!/^s(hift)?$/i.test(s))throw new Error("Unrecognized modifier name: "+s);r=!0}}return n&&(e="Alt-"+e),i&&(e="Ctrl-"+e),o&&(e="Cmd-"+e),r&&(e="Shift-"+e),e}function eo(e){var t={};for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];if(/^(name|fallthrough|(de|at)tach)$/.test(n))continue;if("..."==i){delete e[n];continue}for(var r=g(n.split(" "),Zr),o=0;o<r.length;o++){var a=void 0,s=void 0;o==r.length-1?(s=r.join(" "),a=i):(s=r.slice(0,o+1).join(" "),a="...");var l=t[s];if(l){if(l!=a)throw new Error("Inconsistent bindings for "+s)}else t[s]=a}delete e[n]}for(var c in t)e[c]=t[c];return e}function to(e,t,n,i){var r=(t=ro(t)).call?t.call(e,i):t[e];if(!1===r)return"nothing";if("..."===r)return"multi";if(null!=r&&n(r))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return to(e,t.fallthrough,n,i);for(var o=0;o<t.fallthrough.length;o++){var a=to(e,t.fallthrough[o],n,i);if(a)return a}}}function no(e){var t="string"==typeof e?e:ws[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function io(e,t){if(aa&&34==e.keyCode&&e.char)return!1;var n=ws[e.keyCode],i=n;return null!=i&&!e.altGraphKey&&(e.altKey&&"Alt"!=n&&(i="Alt-"+i),(ya?e.metaKey:e.ctrlKey)&&"Ctrl"!=n&&(i="Ctrl-"+i),(ya?e.ctrlKey:e.metaKey)&&"Cmd"!=n&&(i="Cmd-"+i),!t&&e.shiftKey&&"Shift"!=n&&(i="Shift-"+i),i)}function ro(e){return"string"==typeof e?Ss[e]:e}function oo(e,t){for(var n=e.doc.sel.ranges,i=[],r=0;r<n.length;r++){for(var o=t(n[r]);i.length&&O(o.from,m(i).to)<=0;){var a=i.pop();if(O(a.from,o.from)<0){o.from=a.from;break}}i.push(o)}di(e,function(){for(var t=i.length-1;t>=0;t--)Rr(e.doc,"",i[t].from,i[t].to,"+delete");Wn(e)})}function ao(e,t){var n=F(e.doc,t),i=ue(n);return i!=n&&(t=L(i)),Ee(!0,e,i,t,1)}function so(e,t){var n=F(e.doc,t),i=he(n);return i!=n&&(t=L(i)),Ee(!0,e,n,t,-1)}function lo(e,t){var n=ao(e,t.line),i=F(e.doc,n.line),r=ke(i,e.doc.direction);if(!r||0==r[0].level){var o=Math.max(0,i.text.search(/\S/)),a=t.line==n.line&&t.ch<=o&&t.ch;return P(n.line,a?0:o,n.sticky)}return n}function co(e,t,n){if("string"==typeof t&&!(t=Fs[t]))return!1;e.display.input.ensurePolled();var i=e.display.shift,r=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n&&(e.display.shift=!1),r=t(e)!=Ea}finally{e.display.shift=i,e.state.suppressEdits=!1}return r}function uo(e,t,n){for(var i=0;i<e.state.keyMaps.length;i++){var r=to(t,e.state.keyMaps[i],n,e);if(r)return r}return e.options.extraKeys&&to(t,e.options.extraKeys,n,e)||to(t,e.options.keyMap,n,e)}function ho(e,t,n,i){var r=e.state.keySeq;if(r){if(no(t))return"handled";_s.set(50,function(){e.state.keySeq==r&&(e.state.keySeq=null,e.display.input.reset())}),t=r+" "+t}var o=uo(e,t,i);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&Ct(e,"keyHandled",e,t,n),"handled"!=o&&"multi"!=o||(Pe(n),Mn(e)),r&&!o&&/\'$/.test(t)?(Pe(n),!0):!!o}function po(e,t){var n=io(t,!0);return!!n&&(t.shiftKey&&!e.state.keySeq?ho(e,"Shift-"+n,t,function(t){return co(e,t,!0)})||ho(e,n,t,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return co(e,t)}):ho(e,n,t,function(t){return co(e,t)}))}function fo(e,t,n){return ho(e,"'"+n+"'",t,function(t){return co(e,t,!0)})}function mo(e){var t=this;if(t.curOp.focus=a(),37==e.keyCode&&e.shiftKey,!Le(t,e)){ta&&na<11&&27==e.keyCode&&(e.returnValue=!1);var n=e.keyCode;t.display.shift=16==n||e.shiftKey;var i=po(t,e);aa&&(Ms=i?n:null,!i&&88==n&&!Ua&&(pa?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut")),18!=n||/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)||go(t)}}function go(e){function t(e){18!=e.keyCode&&e.altKey||(wa(n,"CodeMirror-crosshair"),Me(document,"keyup",t),Me(document,"mouseover",t))}var n=e.display.lineDiv;s(n,"CodeMirror-crosshair"),Ba(document,"keyup",t),Ba(document,"mouseover",t)}function vo(e){16==e.keyCode&&(this.doc.sel.shift=!1),Le(this,e)}function yo(e){var t=this;if(!(Dt(t.display,e)||Le(t,e)||e.ctrlKey&&!e.altKey||pa&&e.metaKey)){var n=e.keyCode,i=e.charCode;if(aa&&n==Ms)return Ms=null,void Pe(e);if(!aa||e.which&&!(e.which<10)||!po(t,e)){var r=String.fromCharCode(null==i?n:i);"\b"!=r&&(fo(t,e,r)||t.display.input.onKeyPress(e))}}}function bo(e){var t=this,n=t.display;if(!(Le(t,e)||n.activeTouch&&n.input.supportsTouch()))if(n.input.ensurePolled(),n.shift=e.shiftKey,Dt(n,e))ia||(n.scroller.draggable=!1,setTimeout(function(){return n.scroller.draggable=!0},100));else if(!So(t,e)){var i=kn(t,e);switch(window.focus(),He(e)){case 1:t.state.selectingText?t.state.selectingText(e):i?wo(t,e,i):je(e)==n.scroller&&Pe(e);break;case 2:ia&&(t.state.lastMiddleDown=+new Date),i&&ur(t.doc,i),setTimeout(function(){return n.input.focus()},20),Pe(e);break;case 3:ba?To(t,e):Ln(t)}}}function wo(e,t,n){ta?setTimeout(c(Nn,e),0):e.curOp.focus=a();var i,r=+new Date;Es&&Es.time>r-400&&0==O(Es.pos,n)?i="triple":Ts&&Ts.time>r-400&&0==O(Ts.pos,n)?(i="double",Es={time:r,pos:n}):(i="single",Ts={time:r,pos:n});var o,s=e.doc.sel,l=pa?t.metaKey:t.ctrlKey;e.options.dragDrop&&ja&&!e.isReadOnly()&&"single"==i&&(o=s.contains(n))>-1&&(O((o=s.ranges[o]).from(),n)<0||n.xRel>0)&&(O(o.to(),n)>0||n.xRel<0)?xo(e,t,n,l):Co(e,t,n,i,l)}function xo(e,t,n,i){var r=e.display,o=!1,a=ui(e,function(t){ia&&(r.scroller.draggable=!1),e.state.draggingText=!1,Me(document,"mouseup",a),Me(document,"mousemove",s),Me(r.scroller,"dragstart",l),Me(r.scroller,"drop",a),o||(Pe(t),i||ur(e.doc,n),ia||ta&&9==na?setTimeout(function(){document.body.focus(),r.input.focus()},20):r.input.focus())}),s=function(e){o=o||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},l=function(){return o=!0};ia&&(r.scroller.draggable=!0),e.state.draggingText=a,a.copy=pa?t.altKey:t.ctrlKey,r.scroller.dragDrop&&r.scroller.dragDrop(),Ba(document,"mouseup",a),Ba(document,"mousemove",s),Ba(r.scroller,"dragstart",l),Ba(r.scroller,"drop",a),Ln(e),setTimeout(function(){return r.input.focus()},20)}function Co(e,t,n,i,r){function o(t){if(0!=O(b,t))if(b=t,"rect"==i){for(var r=[],o=e.options.tabSize,a=u(F(d,n.line).text,n.ch,o),s=u(F(d,t.line).text,t.ch,o),l=Math.min(a,s),c=Math.max(a,s),g=Math.min(n.line,t.line),v=Math.min(e.lastLine(),Math.max(n.line,t.line));g<=v;g++){var y=F(d,g).text,w=p(y,l,o);l==c?r.push(new cs(P(g,w),P(g,w))):y.length>w&&r.push(new cs(P(g,w),P(g,p(y,c,o))))}r.length||r.push(new cs(n,n)),vr(d,Oi(m.ranges.slice(0,f).concat(r),f),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{var x=h,C=x.anchor,k=t;if("single"!=i){var S;O((S="double"==i?e.findWordAt(t):new cs(P(t.line,0),U(d,P(t.line+1,0)))).anchor,C)>0?(k=S.head,C=H(x.from(),S.anchor)):(k=S.anchor,C=j(x.to(),S.head))}var T=m.ranges.slice(0);T[f]=new cs(U(d,C),k),vr(d,Oi(T,f),_a)}}function s(t){var n=++x,r=kn(e,t,!0,"rect"==i);if(r)if(0!=O(r,b)){e.curOp.focus=a(),o(r);var l=On(c,d);(r.line>=l.to||r.line<l.from)&&setTimeout(ui(e,function(){x==n&&s(t)}),150)}else{var u=t.clientY<w.top?-20:t.clientY>w.bottom?20:0;u&&setTimeout(ui(e,function(){x==n&&(c.scroller.scrollTop+=u,s(t))}),50)}}function l(t){e.state.selectingText=!1,x=1/0,Pe(t),c.input.focus(),Me(document,"mousemove",C),Me(document,"mouseup",k),d.history.lastSelOrigin=null}var c=e.display,d=e.doc;Pe(t);var h,f,m=d.sel,g=m.ranges;if(r&&!t.shiftKey?(f=d.sel.contains(n),h=f>-1?g[f]:new cs(n,n)):(h=d.sel.primary(),f=d.sel.primIndex),fa?t.shiftKey&&t.metaKey:t.altKey)i="rect",r||(h=new cs(n,n)),n=kn(e,t,!0,!0),f=-1;else if("double"==i){var v=e.findWordAt(n);h=e.display.shift||d.extend?dr(d,h,v.anchor,v.head):v}else if("triple"==i){var y=new cs(P(n.line,0),U(d,P(n.line+1,0)));h=e.display.shift||d.extend?dr(d,h,y.anchor,y.head):y}else h=dr(d,h,n);r?-1==f?(f=g.length,vr(d,Oi(g.concat([h]),f),{scroll:!1,origin:"*mouse"})):g.length>1&&g[f].empty()&&"single"==i&&!t.shiftKey?(vr(d,Oi(g.slice(0,f).concat(g.slice(f+1)),0),{scroll:!1,origin:"*mouse"}),m=d.sel):pr(d,f,h,_a):(f=0,vr(d,new ls([h],0),_a),m=d.sel);var b=n,w=c.wrapper.getBoundingClientRect(),x=0,C=ui(e,function(e){He(e)?s(e):l(e)}),k=ui(e,l);e.state.selectingText=k,Ba(document,"mousemove",C),Ba(document,"mouseup",k)}function ko(e,t,n,i){var r,o;try{r=t.clientX,o=t.clientY}catch(t){return!1}if(r>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;i&&Pe(t);var a=e.display,s=a.lineDiv.getBoundingClientRect();if(o>s.bottom||!Re(e,n))return De(t);o-=s.top-a.viewOffset;for(var l=0;l<e.options.gutters.length;++l){var c=a.gutters.childNodes[l];if(c&&c.getBoundingClientRect().right>=r)return Ne(e,n,e,A(e.doc,o),e.options.gutters[l],t),De(t)}}function So(e,t){return ko(e,t,"gutterClick",!0)}function To(e,t){Dt(e.display,t)||Eo(e,t)||Le(e,t,"contextmenu")||e.display.input.onContextMenu(t)}function Eo(e,t){return!!Re(e,"gutterContextMenu")&&ko(e,t,"gutterContextMenu",!1)}function Fo(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),rn(e)}function _o(e){Li(e),fi(e),Dn(e)}function Mo(e,t,n){if(!t!=!(n&&n!=Ns)){var i=e.display.dragFunctions,r=t?Ba:Me;r(e.display.scroller,"dragstart",i.start),r(e.display.scroller,"dragenter",i.enter),r(e.display.scroller,"dragover",i.over),r(e.display.scroller,"dragleave",i.leave),r(e.display.scroller,"drop",i.drop)}}function No(e){e.options.lineWrapping?(s(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(wa(e.display.wrapper,"CodeMirror-wrap"),we(e)),Cn(e),fi(e),rn(e),setTimeout(function(){return Zn(e)},100)}function Lo(e,t,n,i){var r=this;if(!(this instanceof Lo))return new Lo(e,t,n,i);this.options=t=t?d(t):{},d(Ls,t,!1),Ai(t);var o=t.value;"string"==typeof o&&(o=new vs(o,t.mode,null,t.lineSeparator,t.direction)),this.doc=o;var a=new Lo.inputStyles[t.inputStyle](this),s=this.display=new E(e,o,a);s.wrapper.CodeMirror=this,Li(this),Fo(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),ti(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,selectingText:!1,draggingText:!1,highlight:new Ca,keySeq:null,specialChars:null},t.autofocus&&!ha&&s.input.focus(),ta&&na<11&&setTimeout(function(){return r.display.input.reset(!0)},20),Ao(this),Gr(),ni(this),this.curOp.forceUpdate=!0,Yi(this,o),t.autofocus&&!ha||this.hasFocus()?setTimeout(c(An,this),20):Rn(this);for(var l in As)As.hasOwnProperty(l)&&As[l](r,t[l],Ns);Bn(this),t.finishInit&&t.finishInit(this);for(var u=0;u<Rs.length;++u)Rs[u](r);ii(this),ia&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(s.lineDiv).textRendering&&(s.lineDiv.style.textRendering="auto"),this.editor=n,this.cid=i}function Ao(e){function t(){r.activeTouch&&(o=setTimeout(function(){return r.activeTouch=null},1e3),(a=r.activeTouch).end=+new Date)}function n(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}function i(e,t){if(null==t.left)return!0;var n=t.left-e.left,i=t.top-e.top;return n*n+i*i>400}var r=e.display;Ba(r.scroller,"mousedown",ui(e,bo)),ta&&na<11?Ba(r.scroller,"dblclick",ui(e,function(t){if(!Le(e,t)){var n=kn(e,t);if(n&&!So(e,t)&&!Dt(e.display,t)){Pe(t);var i=e.findWordAt(n);ur(e.doc,i.anchor,i.head)}}})):Ba(r.scroller,"dblclick",function(t){return Le(e,t)||Pe(t)}),ba||Ba(r.scroller,"contextmenu",function(t){return To(e,t)});var o,a={end:0};Ba(r.scroller,"touchstart",function(t){if(!Le(e,t)&&!n(t)){r.input.ensurePolled(),clearTimeout(o);var i=+new Date;r.activeTouch={start:i,moved:!1,prev:i-a.end<=300?a:null},1==t.touches.length&&(r.activeTouch.left=t.touches[0].pageX,r.activeTouch.top=t.touches[0].pageY)}}),Ba(r.scroller,"touchmove",function(){r.activeTouch&&(r.activeTouch.moved=!0)}),Ba(r.scroller,"touchend",function(n){var o=r.activeTouch;if(o&&!Dt(r,n)&&null!=o.left&&!o.moved&&new Date-o.start<300){var a,s=e.coordsChar(r.activeTouch,"page");a=!o.prev||i(o,o.prev)?new cs(s,s):!o.prev.prev||i(o,o.prev.prev)?e.findWordAt(s):new cs(P(s.line,0),U(e.doc,P(s.line+1,0))),e.setSelection(a.anchor,a.head),e.focus(),Pe(n)}t()}),Ba(r.scroller,"touchcancel",t),Ba(r.scroller,"scroll",function(){r.scroller.clientHeight&&(Jn(e,r.scroller.scrollTop),Qn(e,r.scroller.scrollLeft,!0),Ne(e,"scroll",e))}),Ba(r.scroller,"mousewheel",function(t){return Pi(e,t)}),Ba(r.scroller,"DOMMouseScroll",function(t){return Pi(e,t)}),Ba(r.wrapper,"scroll",function(){return r.wrapper.scrollTop=r.wrapper.scrollLeft=0}),r.dragFunctions={enter:function(t){Le(e,t)||Be(t)},over:function(t){Le(e,t)||(Kr(e,t),Be(t))},start:function(t){return Vr(e,t)},drop:ui(e,zr),leave:function(t){Le(e,t)||Yr(e)}};var s=r.input.getField();Ba(s,"keyup",function(t){return vo.call(e,t)}),Ba(s,"keydown",ui(e,mo)),Ba(s,"keypress",ui(e,yo)),Ba(s,"focus",function(t){return An(e,t)}),Ba(s,"blur",function(t){return Rn(e,t)})}function Ro(e,t,n,i){var r,o=e.doc;null==n&&(n="add"),"smart"==n&&(o.mode.indent?r=Ze(e,t):n="prev");var a=e.options.tabSize,s=F(o,t),l=u(s.text,null,a);s.stateAfter&&(s.stateAfter=null);var c,d=s.text.match(/^\s*/)[0];if(i||/\S/.test(s.text)){if("smart"==n&&((c=o.mode.indent(r,s.text.slice(d.length),s.text))==Ea||c>150)){if(!i)return;n="prev"}}else c=0,n="not";var h="",p=0;if("prev"==n?t>o.first?(c=u(h=F(o,t-1).text,null,a),h=d?"":h.match(/^\s*/)[0]):c=0:"add"==n?c=l+e.options.indentUnit:"subtract"==n?c=l-e.options.indentUnit:"number"==typeof n&&(c=l+n),c=Math.max(0,c),h&&!d);else{if(h="",e.options.indentWithTabs)for(var m=Math.floor(c/a);m;--m)p+=a,h+="\t";p<c&&(h+=f(c-p))}if(h!=d)return Rr(o,h,P(t,0),P(t,d.length),"+input"),s.stateAfter=null,!0;for(var g=0;g<o.sel.ranges.length;g++){var v=o.sel.ranges[g];if(v.head.line==t&&v.head.ch<d.length){var y=P(t,d.length);pr(o,g,new cs(y,y));break}}}function Io(e){Is=e}function Po(e,t,n,i,r){var o=e.doc;e.display.shift=!1,i||(i=o.sel);var a=e.state.pasteIncoming||"paste"==r,s=Ha(t),l=null;if(a&&i.ranges.length>1)if(Is&&Is.text.join("\n")==t){if(i.ranges.length%Is.text.length==0){l=[];for(var c=0;c<Is.text.length;c++)l.push(o.splitLines(Is.text[c]))}}else s.length==i.ranges.length&&(l=g(s,function(e){return[e]}));for(var d,u=i.ranges.length-1;u>=0;u--){var h=i.ranges[u],p=h.from(),f=h.to();h.empty()&&(n&&n>0?p=P(p.line,p.ch-n):e.state.overwrite&&!a?f=P(f.line,Math.min(F(o,f.line).text.length,f.ch+m(s).length)):Is&&Is.lineWise&&Is.text.join("\n")==t&&(p=f=P(p.line,0))),d=e.curOp.updateInput;var v={from:p,to:f,text:l?l[u%l.length]:s,origin:r||(a?"paste":e.state.cutIncoming?"cut":"+input")};Fr(e.doc,v),Ct(e,"inputRead",e,v)}t&&!a&&Do(e,t),Wn(e),e.curOp.updateInput=d,e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=!1}function Oo(e,t){var n=e.clipboardData&&e.clipboardData.getData("Text");if(n)return e.preventDefault(),t.isReadOnly()||t.options.disableInput||di(t,function(){return Po(t,n,0,null,"paste")}),!0}function Do(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var n=e.doc.sel,i=n.ranges.length-1;i>=0;i--){var r=n.ranges[i];if(!(r.head.ch>100||i&&n.ranges[i-1].head.line==r.head.line)){var o=e.getModeAt(r.head),a=!1;if(o.electricChars){for(var s=0;s<o.electricChars.length;s++)if(t.indexOf(o.electricChars.charAt(s))>-1){a=Ro(e,r.head.line,"smart");break}}else o.electricInput&&o.electricInput.test(F(e.doc,r.head.line).text.slice(0,r.head.ch))&&(a=Ro(e,r.head.line,"smart"));a&&Ct(e,"electricInput",e,r.head.line)}}}function Bo(e){for(var t=[],n=[],i=0;i<e.doc.sel.ranges.length;i++){var r=e.doc.sel.ranges[i].head.line,o={anchor:P(r,0),head:P(r+1,0)};n.push(o),t.push(e.getRange(o.anchor,o.head))}return{text:t,ranges:n}}function jo(e,t){e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!!t)}function Ho(){var e=i("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=i("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return ia?e.style.width="1000px":e.setAttribute("wrap","off"),da&&(e.style.border="1px solid black"),jo(e),t}function $o(e,t,n,i,r){function o(){var i=t.line+n;return!(i<e.first||i>=e.first+e.size)&&(t=new P(i,t.ch,t.sticky),c=F(e,i))}function a(i){var a;if(null==(a=r?Fe(e.cm,c,t,n):Te(c,t,n))){if(i||!o())return!1;t=Ee(r,e.cm,c,t.line,n)}else t=a;return!0}var s=t,l=n,c=F(e,t.line);if("char"==i)a();else if("column"==i)a(!0);else if("word"==i||"group"==i)for(var d=null,u="group"==i,h=e.cm&&e.cm.getHelper(t,"wordChars"),p=!0;!(n<0)||a(!p);p=!1){var f=c.text.charAt(t.ch)||"\n",m=x(f,h)?"w":u&&"\n"==f?"n":!u||/\s/.test(f)?null:"p";if(!u||p||m||(m="s"),d&&d!=m){n<0&&(n=1,a(),t.sticky="after");break}if(m&&(d=m),n>0&&!a(!p))break}var g=kr(e,t,s,l,!0);return D(s,g)&&(g.hitSide=!0),g}function Uo(e,t,n,i){var r,o=e.doc,a=t.left;if("page"==i){var s=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),l=Math.max(s-.5*vn(e.display),3);r=(n>0?t.bottom:t.top)+n*l}else"line"==i&&(r=n>0?t.bottom+3:t.top-3);for(var c;(c=pn(e,a,r)).outside;){if(n<0?r<=0:r>=o.height){c.hitSide=!0;break}r+=5*n}return c}function qo(e,t){var n=Yt(e,t.line);if(!n||n.hidden)return null;var i=F(e.doc,t.line),r=zt(n,i,t.line),o=ke(i,e.doc.direction),a="left";o&&(a=Ce(o,t.ch)%2?"right":"left");var s=Qt(r.map,t.ch,a);return s.offset="right"==s.collapse?s.end:s.start,s}function Wo(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}function zo(e,t){return t&&(e.bad=!0),e}function Vo(e,t,n,i,r){function o(e){return function(t){return t.id==e}}function a(){d&&(c+=u,d=!1)}function s(e){e&&(a(),c+=e)}function l(t){if(1==t.nodeType){var n=t.getAttribute("cm-text");if(null!=n)return void s(n||t.textContent.replace(/\u200b/g,""));var c,h=t.getAttribute("cm-marker");if(h){var p=e.findMarks(P(i,0),P(r+1,0),o(+h));return void(p.length&&(c=p[0].find())&&s(_(e.doc,c.from,c.to).join(u)))}if("false"==t.getAttribute("contenteditable"))return;var f=/^(pre|div|p)$/i.test(t.nodeName);f&&a();for(var m=0;m<t.childNodes.length;m++)l(t.childNodes[m]);f&&(d=!0)}else 3==t.nodeType&&s(t.nodeValue)}for(var c="",d=!1,u=e.doc.lineSeparator();l(t),t!=n;)t=t.nextSibling;return c}function Ko(e,t,n){var i;if(t==e.display.lineDiv){if(!(i=e.display.lineDiv.childNodes[n]))return zo(e.clipPos(P(e.display.viewTo-1)),!0);t=null,n=0}else for(i=t;;i=i.parentNode){if(!i||i==e.display.lineDiv)return null;if(i.parentNode&&i.parentNode==e.display.lineDiv)break}for(var r=0;r<e.display.view.length;r++){var o=e.display.view[r];if(o.node==i)return Yo(o,t,n)}}function Yo(e,t,n){function i(t,n,i){for(var r=-1;r<(u?u.length:0);r++)for(var o=r<0?d.map:u[r],a=0;a<o.length;a+=3){var s=o[a+2];if(s==t||s==n){var l=L(r<0?e.line:e.rest[r]),c=o[a]+i;return(i<0||s!=t)&&(c=o[a+(i?1:0)]),P(l,c)}}}var r=e.text.firstChild,a=!1;if(!t||!o(r,t))return zo(P(L(e.line),0),!0);if(t==r&&(a=!0,t=r.childNodes[n],n=0,!t)){var s=e.rest?m(e.rest):e.line;return zo(P(L(s),s.text.length),a)}var l=3==t.nodeType?t:null,c=t;for(l||1!=t.childNodes.length||3!=t.firstChild.nodeType||(l=t.firstChild,n&&(n=l.nodeValue.length));c.parentNode!=r;)c=c.parentNode;var d=e.measure,u=d.maps,h=i(l,c,n);if(h)return zo(h,a);for(var p=c.nextSibling,f=l?l.nodeValue.length-n:0;p;p=p.nextSibling){if(h=i(p,p.firstChild,0))return zo(P(h.line,h.ch-f),a);f+=p.textContent.length}for(var g=c.previousSibling,v=n;g;g=g.previousSibling){if(h=i(g,g.firstChild,-1))return zo(P(h.line,h.ch+v),a);v+=g.textContent.length}}var Jo=navigator.userAgent,Go=navigator.platform,Qo=/gecko\/\d/i.test(Jo),Xo=/MSIE \d/.test(Jo),Zo=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(Jo),ea=/Edge\/(\d+)/.exec(Jo),ta=Xo||Zo||ea,na=ta&&(Xo?document.documentMode||6:+(ea||Zo)[1]),ia=!ea&&/WebKit\//.test(Jo),ra=ia&&/Qt\/\d+\.\d+/.test(Jo),oa=!ea&&/Chrome\//.test(Jo),aa=/Opera\//.test(Jo),sa=/Apple Computer/.test(navigator.vendor),la=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(Jo),ca=/PhantomJS/.test(Jo),da=!ea&&/AppleWebKit/.test(Jo)&&/Mobile\/\w+/.test(Jo),ua=/Android/.test(Jo),ha=da||ua||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(Jo),pa=da||/Mac/.test(Go),fa=/\bCrOS\b/.test(Jo),ma=/win/i.test(Go),ga=aa&&Jo.match(/Version\/(\d*\.\d*)/);ga&&(ga=Number(ga[1])),ga&&ga>=15&&(aa=!1,ia=!0);var va,ya=pa&&(ra||aa&&(null==ga||ga<12.11)),ba=Qo||ta&&na>=9,wa=function(t,n){var i=t.className,r=e(n).exec(i);if(r){var o=i.slice(r.index+r[0].length);t.className=i.slice(0,r.index)+(o?r[1]+o:"")}};va=document.createRange?function(e,t,n,i){var r=document.createRange();return r.setEnd(i||e,n),r.setStart(e,t),r}:function(e,t,n){var i=document.body.createTextRange();try{i.moveToElementText(e.parentNode)}catch(e){return i}return i.collapse(!0),i.moveEnd("character",n),i.moveStart("character",t),i};var xa=function(e){e.select()};da?xa=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:ta&&(xa=function(e){try{e.select()}catch(e){}});var Ca=function(){this.id=null};Ca.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var ka,Sa,Ta=30,Ea={toString:function(){return"CodeMirror.Pass"}},Fa={scroll:!1},_a={origin:"*mouse"},Ma={origin:"+move"},Na=[""],La=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Aa=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,Ra=!1,Ia=!1,Pa=null,Oa=function(){function e(e){return e<=247?n.charAt(e):1424<=e&&e<=1524?"R":1536<=e&&e<=1785?i.charAt(e-1536):1774<=e&&e<=2220?"r":8192<=e&&e<=8203?"w":8204==e?"b":"L"}function t(e,t,n){this.level=e,this.from=t,this.to=n}var n="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",i="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",r=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,o=/[stwN]/,a=/[LRr]/,s=/[Lb1n]/,l=/[1n]/;return function(n,i){var c="ltr"==i?"L":"R";if(0==n.length||"ltr"==i&&!r.test(n))return!1;for(var d=n.length,u=[],h=0;h<d;++h)u.push(e(n.charCodeAt(h)));for(var p=0,f=c;p<d;++p){var g=u[p];"m"==g?u[p]=f:f=g}for(var v=0,y=c;v<d;++v){var b=u[v];"1"==b&&"r"==y?u[v]="n":a.test(b)&&(y=b,"r"==b&&(u[v]="R"))}for(var w=1,x=u[0];w<d-1;++w){var C=u[w];"+"==C&&"1"==x&&"1"==u[w+1]?u[w]="1":","!=C||x!=u[w+1]||"1"!=x&&"n"!=x||(u[w]=x),x=C}for(var k=0;k<d;++k){var S=u[k];if(","==S)u[k]="N";else if("%"==S){var T=void 0;for(T=k+1;T<d&&"%"==u[T];++T);for(var E=k&&"!"==u[k-1]||T<d&&"1"==u[T]?"1":"N",F=k;F<T;++F)u[F]=E;k=T-1}}for(var _=0,M=c;_<d;++_){var N=u[_];"L"==M&&"1"==N?u[_]="L":a.test(N)&&(M=N)}for(var L=0;L<d;++L)if(o.test(u[L])){var A=void 0;for(A=L+1;A<d&&o.test(u[A]);++A);for(var R="L"==(L?u[L-1]:c),I=R==("L"==(A<d?u[A]:c))?R?"L":"R":c,P=L;P<A;++P)u[P]=I;L=A-1}for(var O,D=[],B=0;B<d;)if(s.test(u[B])){var j=B;for(++B;B<d&&s.test(u[B]);++B);D.push(new t(0,j,B))}else{var H=B,$=D.length;for(++B;B<d&&"L"!=u[B];++B);for(var U=H;U<B;)if(l.test(u[U])){H<U&&D.splice($,0,new t(1,H,U));var q=U;for(++U;U<B&&l.test(u[U]);++U);D.splice($,0,new t(2,q,U)),H=U}else++U;H<B&&D.splice($,0,new t(1,H,B))}return 1==D[0].level&&(O=n.match(/^\s+/))&&(D[0].from=O[0].length,D.unshift(new t(0,0,O[0].length))),1==m(D).level&&(O=n.match(/\s+$/))&&(m(D).to-=O[0].length,D.push(new t(0,d-O[0].length,d))),"rtl"==i?D.reverse():D}}(),Da=[],Ba=function(e,t,n){if(e.addEventListener)e.addEventListener(t,n,!1,{passive:!0});else if(e.attachEvent)e.attachEvent("on"+t,n);else{var i=e._handlers||(e._handlers={});i[t]=(i[t]||Da).concat(n)}},ja=function(){if(ta&&na<9)return!1;var e=i("div");return"draggable"in e||"dragDrop"in e}(),Ha=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,n=[],i=e.length;t<=i;){var r=e.indexOf("\n",t);-1==r&&(r=e.length);var o=e.slice(t,"\r"==e.charAt(r-1)?r-1:r),a=o.indexOf("\r");-1!=a?(n.push(o.slice(0,a)),t+=a+1):(n.push(o),t=r+1)}return n}:function(e){return e.split(/\r\n?|\n/)},$a=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},Ua=function(){var e=i("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),qa=null,Wa={},za={},Va={},Ka=function(e,t){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0};Ka.prototype.eol=function(){return this.pos>=this.string.length},Ka.prototype.sol=function(){return this.pos==this.lineStart},Ka.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},Ka.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},Ka.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},Ka.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},Ka.prototype.eatSpace=function(){for(var e=this,t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++e.pos;return this.pos>t},Ka.prototype.skipToEnd=function(){this.pos=this.string.length},Ka.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},Ka.prototype.backUp=function(e){this.pos-=e},Ka.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=u(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?u(this.string,this.lineStart,this.tabSize):0)},Ka.prototype.indentation=function(){return u(this.string,null,this.tabSize)-(this.lineStart?u(this.string,this.lineStart,this.tabSize):0)},Ka.prototype.match=function(e,t,n){if("string"!=typeof e){var i=this.string.slice(this.pos).match(e);return i&&i.index>0?null:(i&&!1!==t&&(this.pos+=i[0].length),i)}var r=function(e){return n?e.toLowerCase():e};if(r(this.string.substr(this.pos,e.length))==r(e))return!1!==t&&(this.pos+=e.length),!0},Ka.prototype.current=function(){return this.string.slice(this.start,this.pos)},Ka.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}};var Ya=function(e,t,n){this.text=e,ie(this,t),this.height=n?n(this):1};Ya.prototype.lineNo=function(){return L(this)},Ie(Ya);var Ja,Ga={},Qa={},Xa=null,Za=null,es={left:0,right:0,top:0,bottom:0};Lo.posFromMouse=kn;var ts=function(e,t,n){this.cm=n;var r=this.vert=i("div",[i("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),o=this.horiz=i("div",[i("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");e(r),e(o),Ba(r,"scroll",function(){r.clientHeight&&t(r.scrollTop,"vertical")}),Ba(o,"scroll",function(){o.clientWidth&&t(o.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,ta&&na<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};ts.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,n=e.scrollHeight>e.clientHeight+1,i=e.nativeBarWidth;if(n){this.vert.style.display="block",this.vert.style.bottom=t?i+"px":"0";var r=e.viewHeight-(t?i:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+r)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=n?i+"px":"0",this.horiz.style.left=e.barLeft+"px";var o=e.viewWidth-e.barLeft-(n?i:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+o)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&e.clientHeight>0&&(0==i&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:n?i:0,bottom:t?i:0}},ts.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},ts.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},ts.prototype.zeroWidthHack=function(){var e=pa&&!la?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Ca,this.disableVert=new Ca},ts.prototype.enableZeroWidthBar=function(e,t,n){function i(){var r=e.getBoundingClientRect();("vert"==n?document.elementFromPoint(r.right-1,(r.top+r.bottom)/2):document.elementFromPoint((r.right+r.left)/2,r.bottom-1))!=e?e.style.pointerEvents="none":t.set(1e3,i)}e.style.pointerEvents="auto",t.set(1e3,i)},ts.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var ns=function(){};ns.prototype.update=function(){return{bottom:0,right:0}},ns.prototype.setScrollLeft=function(){},ns.prototype.setScrollTop=function(){},ns.prototype.clear=function(){};var is={native:ts,null:ns},rs=0,os=function(e,t,n){var i=e.display;this.viewport=t,this.visible=On(i,e.doc,t),this.editorIsHidden=!i.wrapper.offsetWidth,this.wrapperHeight=i.wrapper.clientHeight,this.wrapperWidth=i.wrapper.clientWidth,this.oldDisplayWidth=Ut(e),this.force=n,this.dims=bn(e),this.events=[]};os.prototype.signal=function(e,t){Re(e,t)&&this.events.push(arguments)},os.prototype.finish=function(){for(var e=this,t=0;t<this.events.length;t++)Ne.apply(null,e.events[t])};var as=0,ss=null;ta?ss=-.53:Qo?ss=15:oa?ss=-.7:sa&&(ss=-1/3);var ls=function(e,t){this.ranges=e,this.primIndex=t};ls.prototype.primary=function(){return this.ranges[this.primIndex]},ls.prototype.equals=function(e){var t=this;if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var n=0;n<this.ranges.length;n++){var i=t.ranges[n],r=e.ranges[n];if(!D(i.anchor,r.anchor)||!D(i.head,r.head))return!1}return!0},ls.prototype.deepCopy=function(){for(var e=this,t=[],n=0;n<this.ranges.length;n++)t[n]=new cs(B(e.ranges[n].anchor),B(e.ranges[n].head));return new ls(t,this.primIndex)},ls.prototype.somethingSelected=function(){for(var e=this,t=0;t<this.ranges.length;t++)if(!e.ranges[t].empty())return!0;return!1},ls.prototype.contains=function(e,t){var n=this;t||(t=e);for(var i=0;i<this.ranges.length;i++){var r=n.ranges[i];if(O(t,r.from())>=0&&O(e,r.to())<=0)return i}return-1};var cs=function(e,t){this.anchor=e,this.head=t};cs.prototype.from=function(){return H(this.anchor,this.head)},cs.prototype.to=function(){return j(this.anchor,this.head)},cs.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};var ds=function(e){var t=this;this.lines=e,this.parent=null;for(var n=0,i=0;i<e.length;++i)e[i].parent=t,n+=e[i].height;this.height=n};ds.prototype.chunkSize=function(){return this.lines.length},ds.prototype.removeInner=function(e,t){for(var n=this,i=e,r=e+t;i<r;++i){var o=n.lines[i];n.height-=o.height,lt(o),Ct(o,"delete")}this.lines.splice(e,t)},ds.prototype.collapse=function(e){e.push.apply(e,this.lines)},ds.prototype.insertInner=function(e,t,n){var i=this;this.height+=n,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var r=0;r<t.length;++r)t[r].parent=i},ds.prototype.iterN=function(e,t,n){for(var i=this,r=e+t;e<r;++e)if(n(i.lines[e]))return!0};var us=function(e){var t=this;this.children=e;for(var n=0,i=0,r=0;r<e.length;++r){var o=e[r];n+=o.chunkSize(),i+=o.height,o.parent=t}this.size=n,this.height=i,this.parent=null};us.prototype.chunkSize=function(){return this.size},us.prototype.removeInner=function(e,t){var n=this;this.size-=t;for(var i=0;i<this.children.length;++i){var r=n.children[i],o=r.chunkSize();if(e<o){var a=Math.min(t,o-e),s=r.height;if(r.removeInner(e,a),n.height-=s-r.height,o==a&&(n.children.splice(i--,1),r.parent=null),0==(t-=a))break;e=0}else e-=o}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof ds))){var l=[];this.collapse(l),this.children=[new ds(l)],this.children[0].parent=this}},us.prototype.collapse=function(e){for(var t=this,n=0;n<this.children.length;++n)t.children[n].collapse(e)},us.prototype.insertInner=function(e,t,n){var i=this;this.size+=t.length,this.height+=n;for(var r=0;r<this.children.length;++r){var o=i.children[r],a=o.chunkSize();if(e<=a){if(o.insertInner(e,t,n),o.lines&&o.lines.length>50){for(var s=o.lines.length%25+25,l=s;l<o.lines.length;){var c=new ds(o.lines.slice(l,l+=25));o.height-=c.height,i.children.splice(++r,0,c),c.parent=i}o.lines=o.lines.slice(0,s),i.maybeSpill()}break}e-=a}},us.prototype.maybeSpill=function(){if(!(this.children.length<=10)){var e=this;do{var t=e.children.splice(e.children.length-5,5),n=new us(t);if(e.parent){e.size-=n.size,e.height-=n.height;var i=h(e.parent.children,e);e.parent.children.splice(i+1,0,n)}else{var r=new us(e.children);r.parent=e,e.children=[r,n],e=r}n.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},us.prototype.iterN=function(e,t,n){for(var i=this,r=0;r<this.children.length;++r){var o=i.children[r],a=o.chunkSize();if(e<a){var s=Math.min(t,a-e);if(o.iterN(e,s,n))return!0;if(0==(t-=s))break;e=0}else e-=a}};var hs=function(e,t,n){var i=this;if(n)for(var r in n)n.hasOwnProperty(r)&&(i[r]=n[r]);this.doc=e,this.node=t};hs.prototype.clear=function(){var e=this,t=this.doc.cm,n=this.line.widgets,i=this.line,r=L(i);if(null!=r&&n){for(var o=0;o<n.length;++o)n[o]==e&&n.splice(o--,1);n.length||(i.widgets=null);var a=Ot(this);N(i,Math.max(0,i.height-a)),t&&(di(t,function(){Br(t,i,-a),mi(t,r,"widget")}),Ct(t,"lineWidgetCleared",t,this,r))}},hs.prototype.changed=function(){var e=this,t=this.height,n=this.doc.cm,i=this.line;this.height=null;var r=Ot(this)-t;r&&(N(i,i.height+r),n&&di(n,function(){n.curOp.forceUpdate=!0,Br(n,i,r),Ct(n,"lineWidgetChanged",n,e,L(i))}))},Ie(hs);var ps=0,fs=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++ps};fs.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){var t=this.doc.cm,n=t&&!t.curOp;if(n&&ni(t),Re(this,"clear")){var i=this.find();i&&Ct(this,"clear",i.from,i.to)}for(var r=null,o=null,a=0;a<this.lines.length;++a){var s=e.lines[a],l=Y(s.markedSpans,e);t&&!e.collapsed?mi(t,L(s),"text"):t&&(null!=l.to&&(o=L(s)),null!=l.from&&(r=L(s))),s.markedSpans=J(s.markedSpans,l),null==l.from&&e.collapsed&&!ge(e.doc,s)&&t&&N(s,vn(t.display))}if(t&&this.collapsed&&!t.options.lineWrapping)for(var c=0;c<this.lines.length;++c){var d=ue(e.lines[c]),u=be(d);u>t.display.maxLineLength&&(t.display.maxLine=d,t.display.maxLineLength=u,t.display.maxLineChanged=!0)}null!=r&&t&&this.collapsed&&fi(t,r,o+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,t&&wr(t.doc)),t&&Ct(t,"markerCleared",t,this,r,o),n&&ii(t),this.parent&&this.parent.clear()}},fs.prototype.find=function(e,t){var n=this;null==e&&"bookmark"==this.type&&(e=1);for(var i,r,o=0;o<this.lines.length;++o){var a=n.lines[o],s=Y(a.markedSpans,n);if(null!=s.from&&(i=P(t?a:L(a),s.from),-1==e))return i;if(null!=s.to&&(r=P(t?a:L(a),s.to),1==e))return r}return i&&{from:i,to:r}},fs.prototype.changed=function(){var e=this,t=this.find(-1,!0),n=this,i=this.doc.cm;t&&i&&di(i,function(){var r=t.line,o=L(t.line),a=Yt(i,o);if(a&&(tn(a),i.curOp.selectionChanged=i.curOp.forceUpdate=!0),i.curOp.updateMaxLine=!0,!ge(n.doc,r)&&null!=n.height){var s=n.height;n.height=null;var l=Ot(n)-s;l&&N(r,r.height+l)}Ct(i,"markerChanged",i,e)})},fs.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=h(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},fs.prototype.detachLine=function(e){if(this.lines.splice(h(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},Ie(fs);var ms=function(e,t){var n=this;this.markers=e,this.primary=t;for(var i=0;i<e.length;++i)e[i].parent=n};ms.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var t=0;t<this.markers.length;++t)e.markers[t].clear();Ct(this,"clear")}},ms.prototype.find=function(e,t){return this.primary.find(e,t)},Ie(ms);var gs=0,vs=function(e,t,n,i,r){if(!(this instanceof vs))return new vs(e,t,n,i,r);null==n&&(n=0),us.call(this,[new ds([new Ya("",null)])]),this.first=n,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.frontier=n;var o=P(n,0);this.sel=Di(o),this.history=new Qi(null),this.id=++gs,this.modeOption=t,this.lineSep=i,this.direction="rtl"==r?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),Vi(this,{from:o,to:o,text:e}),vr(this,Di(o),Fa)};vs.prototype=b(us.prototype,{constructor:vs,iter:function(e,t,n){n?this.iterN(e-this.first,t-e,n):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var n=0,i=0;i<t.length;++i)n+=t[i].height;this.insertInner(e-this.first,t,n)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=M(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:pi(function(e,t){var n=P(this.first,0),i=this.first+this.size-1;Fr(this,{from:n,to:P(i,F(this,i).text.length),text:this.splitLines(e),origin:t||"setValue",full:!0},!0),this.cm&&zn(this.cm,0,0),vr(this,Di(n),Fa)}),replaceRange:function(e,t,n,i){Rr(this,e,t=U(this,t),n=n?U(this,n):t,i)},getRange:function(e,t,n){var i=_(this,U(this,e),U(this,t));return!1===n?i:i.join(n||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(R(this,e))return F(this,e)},getLineNumber:function(e){return L(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=F(this,e)),ue(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return U(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:pi(function(e,t,n){fr(this,U(this,"number"==typeof e?P(e,t||0):e),null,n)}),setSelection:pi(function(e,t,n){fr(this,U(this,e),U(this,t||e),n)}),extendSelection:pi(function(e,t,n){ur(this,U(this,e),t&&U(this,t),n)}),extendSelections:pi(function(e,t){hr(this,W(this,e),t)}),extendSelectionsBy:pi(function(e,t){hr(this,W(this,g(this.sel.ranges,e)),t)}),setSelections:pi(function(e,t,n){var i=this;if(e.length){for(var r=[],o=0;o<e.length;o++)r[o]=new cs(U(i,e[o].anchor),U(i,e[o].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),vr(this,Oi(r,t),n)}}),addSelection:pi(function(e,t,n){var i=this.sel.ranges.slice(0);i.push(new cs(U(this,e),U(this,t||e))),vr(this,Oi(i,i.length-1),n)}),getSelection:function(e){for(var t,n=this,i=this.sel.ranges,r=0;r<i.length;r++){var o=_(n,i[r].from(),i[r].to());t=t?t.concat(o):o}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=this,n=[],i=this.sel.ranges,r=0;r<i.length;r++){var o=_(t,i[r].from(),i[r].to());!1!==e&&(o=o.join(e||t.lineSeparator())),n[r]=o}return n},replaceSelection:function(e,t,n){for(var i=[],r=0;r<this.sel.ranges.length;r++)i[r]=e;this.replaceSelections(i,t,n||"+input")},replaceSelections:pi(function(e,t,n){for(var i=this,r=[],o=this.sel,a=0;a<o.ranges.length;a++){var s=o.ranges[a];r[a]={from:s.from(),to:s.to(),text:i.splitLines(e[a]),origin:n}}for(var l=t&&"end"!=t&&Ui(this,r,t),c=r.length-1;c>=0;c--)Fr(i,r[c]);l?gr(this,l):this.cm&&Wn(this.cm)}),undo:pi(function(){Mr(this,"undo")}),redo:pi(function(){Mr(this,"redo")}),undoSelection:pi(function(){Mr(this,"undo",!0)}),redoSelection:pi(function(){Mr(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,n=0,i=0;i<e.done.length;i++)e.done[i].ranges||++t;for(var r=0;r<e.undone.length;r++)e.undone[r].ranges||++n;return{undo:t,redo:n}},clearHistory:function(){this.history=new Qi(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:cr(this.history.done),undone:cr(this.history.undone)}},setHistory:function(e){var t=this.history=new Qi(this.history.maxGeneration);t.done=cr(e.done.slice(0),null,!0),t.undone=cr(e.undone.slice(0),null,!0)},setGutterMarker:pi(function(e,t,n){return Dr(this,e,"gutter",function(e){var i=e.gutterMarkers||(e.gutterMarkers={});return i[t]=n,!n&&C(i)&&(e.gutterMarkers=null),!0})}),clearGutter:pi(function(e){var t=this;this.iter(function(n){n.gutterMarkers&&n.gutterMarkers[e]&&Dr(t,n,"gutter",function(){return n.gutterMarkers[e]=null,C(n.gutterMarkers)&&(n.gutterMarkers=null),!0})})}),lineInfo:function(e){var t;if("number"==typeof e){if(!R(this,e))return null;if(t=e,!(e=F(this,e)))return null}else if(null==(t=L(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:pi(function(t,n,i){return Dr(this,t,"gutter"==n?"gutter":"class",function(t){var r="text"==n?"textClass":"background"==n?"bgClass":"gutter"==n?"gutterClass":"wrapClass";if(t[r]){if(e(i).test(t[r]))return!1;t[r]+=" "+i}else t[r]=i;return!0})}),removeLineClass:pi(function(t,n,i){return Dr(this,t,"gutter"==n?"gutter":"class",function(t){var r="text"==n?"textClass":"background"==n?"bgClass":"gutter"==n?"gutterClass":"wrapClass",o=t[r];if(!o)return!1;if(null==i)t[r]=null;else{var a=o.match(e(i));if(!a)return!1;var s=a.index+a[0].length;t[r]=o.slice(0,a.index)+(a.index&&s!=o.length?" ":"")+o.slice(s)||null}return!0})}),addLineWidget:pi(function(e,t,n){return jr(this,e,t,n)}),removeLineWidget:function(e){e.clear()},markText:function(e,t,n){return Hr(this,U(this,e),U(this,t),n,n&&n.type||"range")},setBookmark:function(e,t){var n={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return e=U(this,e),Hr(this,e,e,n,"bookmark")},findMarksAt:function(e){var t=[],n=F(this,(e=U(this,e)).line).markedSpans;if(n)for(var i=0;i<n.length;++i){var r=n[i];(null==r.from||r.from<=e.ch)&&(null==r.to||r.to>=e.ch)&&t.push(r.marker.parent||r.marker)}return t},findMarks:function(e,t,n){e=U(this,e),t=U(this,t);var i=[],r=e.line;return this.iter(e.line,t.line+1,function(o){var a=o.markedSpans;if(a)for(var s=0;s<a.length;s++){var l=a[s];null!=l.to&&r==e.line&&e.ch>=l.to||null==l.from&&r!=e.line||null!=l.from&&r==t.line&&l.from>=t.ch||n&&!n(l.marker)||i.push(l.marker.parent||l.marker)}++r}),i},getAllMarks:function(){var e=[];return this.iter(function(t){var n=t.markedSpans;if(n)for(var i=0;i<n.length;++i)null!=n[i].from&&e.push(n[i].marker)}),e},posFromIndex:function(e){var t,n=this.first,i=this.lineSeparator().length;return this.iter(function(r){var o=r.text.length+i;if(o>e)return t=e,!0;e-=o,++n}),U(this,P(n,t))},indexFromPos:function(e){var t=(e=U(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var n=this.lineSeparator().length;return this.iter(this.first,e.line,function(e){t+=e.text.length+n}),t},copy:function(e){var t=new vs(M(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,n=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<n&&(n=e.to);var i=new vs(M(this,t,n),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(i.history=this.history),(this.linked||(this.linked=[])).push({doc:i,sharedHist:e.sharedHist}),i.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],qr(i,Ur(this)),i},unlinkDoc:function(e){var t=this;if(e instanceof Lo&&(e=e.doc),this.linked)for(var n=0;n<this.linked.length;++n)if(t.linked[n].doc==e){t.linked.splice(n,1),e.unlinkDoc(t),Wr(Ur(t));break}if(e.history==this.history){var i=[e.id];Ki(e,function(e){return i.push(e.id)},!0),e.history=new Qi(null),e.history.done=cr(this.history.done,i),e.history.undone=cr(this.history.undone,i)}},iterLinkedDocs:function(e){Ki(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):Ha(e)},lineSeparator:function(){return File.useCRLF?"\r\n":"\n"},setDirection:pi(function(e){"rtl"!=e&&(e="ltr"),e!=this.direction&&(this.direction=e,this.iter(function(e){return e.order=null}),this.cm&&Gi(this.cm))})}),vs.prototype.eachLine=vs.prototype.iter;for(var ys=0,bs=!1,ws={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},xs=0;xs<10;xs++)ws[xs+48]=ws[xs+96]=String(xs);for(var Cs=65;Cs<=90;Cs++)ws[Cs]=String.fromCharCode(Cs);for(var ks=1;ks<=12;ks++)ws[ks+111]=ws[ks+63235]="F"+ks;var Ss={};Ss.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Ss.pcDefault={"Ctrl-A":"selectAll","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Ss.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Ss.macDefault={"Cmd-A":"selectAll","Cmd-Up":"goDocStart","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Ss.default=pa?Ss.macDefault:Ss.pcDefault;var Ts,Es,Fs={selectAll:Tr,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),Fa)},killLine:function(e){return oo(e,function(t){if(t.empty()){var n=F(e.doc,t.head.line).text.length;return t.head.ch==n&&t.head.line<e.lastLine()?{from:t.head,to:P(t.head.line+1,0)}:{from:t.head,to:P(t.head.line,n)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){return oo(e,function(t){return{from:P(t.from().line,0),to:U(e.doc,P(t.to().line+1,0))}})},delLineLeft:function(e){return oo(e,function(e){return{from:P(e.from().line,0),to:e.from()}})},delWrappedLineLeft:function(e){return oo(e,function(t){var n=e.charCoords(t.head,"div").top+5;return{from:e.coordsChar({left:0,top:n},"div"),to:t.from()}})},delWrappedLineRight:function(e){return oo(e,function(t){var n=e.charCoords(t.head,"div").top+5,i=e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:n},"div");return{from:t.from(),to:i}})},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(P(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(P(e.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy(function(t){return ao(e,t.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy(function(t){return lo(e,t.head)},{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy(function(t){return so(e,t.head.line)},{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy(function(t){var n=e.charCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:n},"div")},Ma)},goLineLeft:function(e){return e.extendSelectionsBy(function(t){var n=e.charCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:n},"div")},Ma)},goLineLeftSmart:function(e){return e.extendSelectionsBy(function(t){var n=e.charCoords(t.head,"div").top+5,i=e.coordsChar({left:0,top:n},"div");return i.ch<e.getLine(i.line).search(/\S/)?lo(e,t.head):i},Ma)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"char")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],n=e.listSelections(),i=e.options.tabSize,r=0;r<n.length;r++){var o=n[r].from(),a=u(e.getLine(o.line),o.ch,i);t.push(f(i-a%i))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){return di(e,function(){for(var t=e.listSelections(),n=[],i=0;i<t.length;i++)if(t[i].empty()){var r=t[i].head,o=F(e.doc,r.line).text;if(o)if(r.ch==o.length&&(r=new P(r.line,r.ch-1)),r.ch>0)r=new P(r.line,r.ch+1),e.replaceRange(o.charAt(r.ch-1)+o.charAt(r.ch-2),P(r.line,r.ch-2),r,"+transpose");else if(r.line>e.doc.first){var a=F(e.doc,r.line-1).text;a&&(r=new P(r.line,1),e.replaceRange(o.charAt(0)+e.doc.lineSeparator()+a.charAt(a.length-1),P(r.line-1,a.length-1),r,"+transpose"))}n.push(new cs(r,r))}e.setSelections(n)})},newlineAndIndent:function(e){return di(e,function(){for(var t=e.listSelections(),n=t.length-1;n>=0;n--)e.replaceRange(e.doc.lineSeparator(),t[n].anchor,t[n].head,"+input");t=e.listSelections();for(var i=0;i<t.length;i++)e.indentLine(t[i].from().line,null,!0);Wn(e)})},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}},_s=new Ca,Ms=null,Ns={toString:function(){return"CodeMirror.Init"}},Ls={},As={};Lo.defaults=Ls,Lo.optionHandlers=As;var Rs=[];Lo.defineInitHook=function(e){return Rs.push(e)};var Is=null,Ps=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Ca,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Ps.prototype.init=function(e){function t(e){if(!Le(r,e)){if(r.somethingSelected())Io({lineWise:!1,text:r.getSelections()}),"cut"==e.type&&r.replaceSelection("",null,"cut");else{if(!r.options.lineWiseCopyCut)return;var t=Bo(r);Io({lineWise:!0,text:t.text}),"cut"==e.type&&r.operation(function(){r.setSelections(t.ranges,0,Fa),r.replaceSelection("",null,"cut")})}if(e.clipboardData){e.clipboardData.clearData();var n=Is.text.join("\n");if(e.clipboardData.setData("Text",n),e.clipboardData.getData("Text")==n)return void e.preventDefault()}var a=Ho(),s=a.firstChild;r.display.lineSpace.insertBefore(a,r.display.lineSpace.firstChild),s.value=Is.text.join("\n");var l=document.activeElement;xa(s),setTimeout(function(){r.display.lineSpace.removeChild(a),l.focus(),l==o&&i.showPrimarySelection()},50)}}var n=this,i=this,r=i.cm,o=i.div=e.lineDiv;jo(o,r.options.spellcheck),Ba(o,"paste",function(e){Le(r,e)||Oo(e,r)||na<=11&&setTimeout(ui(r,function(){return n.updateFromDOM()}),20)}),Ba(o,"compositionstart",function(e){n.composing={data:e.data,done:!1}}),Ba(o,"compositionupdate",function(e){n.composing||(n.composing={data:e.data,done:!1})}),Ba(o,"compositionend",function(e){n.composing&&(e.data!=n.composing.data&&n.readFromDOMSoon(),n.composing.done=!0)}),Ba(o,"touchstart",function(){return i.forceCompositionEnd()}),Ba(o,"input",function(){n.composing||n.readFromDOMSoon()}),Ba(o,"copy",t),Ba(o,"cut",t)},Ps.prototype.prepareSelection=function(){var e=En(this.cm,!1);return e.focus=this.cm.state.focused,e},Ps.prototype.showSelection=function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},Ps.prototype.showPrimarySelection=function(){var e=window.getSelection(),t=this.cm,n=t.doc.sel.primary(),i=n.from(),r=n.to();if(t.display.viewTo==t.display.viewFrom||i.line>=t.display.viewTo||r.line<t.display.viewFrom)e.removeAllRanges();else{var o=Ko(t,e.anchorNode,e.anchorOffset),a=Ko(t,e.focusNode,e.focusOffset);if(!o||o.bad||!a||a.bad||0!=O(H(o,a),i)||0!=O(j(o,a),r)){var s=t.display.view,l=i.line>=t.display.viewFrom&&qo(t,i)||{node:s[0].measure.map[2],offset:0},c=r.line<t.display.viewTo&&qo(t,r);if(!c){var d=s[s.length-1].measure,u=d.maps?d.maps[d.maps.length-1]:d.map;c={node:u[u.length-1],offset:u[u.length-2]-u[u.length-3]}}if(l&&c){var h,p=e.rangeCount&&e.getRangeAt(0);try{h=va(l.node,l.offset,c.offset,c.node)}catch(e){}h&&(!Qo&&t.state.focused?(e.collapse(l.node,l.offset),h.collapsed||(e.removeAllRanges(),e.addRange(h))):(e.removeAllRanges(),e.addRange(h)),p&&null==e.anchorNode?e.addRange(p):Qo&&this.startGracePeriod()),this.rememberSelection()}else e.removeAllRanges()}}},Ps.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){return e.cm.curOp.selectionChanged=!0})},20)},Ps.prototype.showMultipleSelections=function(e){n(this.cm.display.cursorDiv,e.cursors),n(this.cm.display.selectionDiv,e.selection)},Ps.prototype.rememberSelection=function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},Ps.prototype.selectionInEditor=function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return o(this.div,t)},Ps.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()||this.showSelection(this.prepareSelection(),!0),this.div.focus())},Ps.prototype.blur=function(){this.div.blur()},Ps.prototype.getField=function(){return this.div},Ps.prototype.supportsTouch=function(){return!0},Ps.prototype.receivedFocus=function(){function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))}var t=this;this.selectionInEditor()?this.pollSelection():di(this.cm,function(){return t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,e)},Ps.prototype.selectionChanged=function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},Ps.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;if(ua&&oa&&this.cm.options.gutters.length&&Wo(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var n=Ko(t,e.anchorNode,e.anchorOffset),i=Ko(t,e.focusNode,e.focusOffset);n&&i&&di(t,function(){vr(t.doc,Di(n,i),Fa),(n.bad||i.bad)&&(t.curOp.selectionChanged=!0)})}}},Ps.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e=this.cm,t=e.display,n=e.doc.sel.primary(),i=n.from(),r=n.to();if(0==i.ch&&i.line>e.firstLine()&&(i=P(i.line-1,F(e.doc,i.line-1).length)),r.ch==F(e.doc,r.line).text.length&&r.line<e.lastLine()&&(r=P(r.line+1,0)),i.line<t.viewFrom||r.line>t.viewTo-1)return!1;var o,a,s;i.line==t.viewFrom||0==(o=Sn(e,i.line))?(a=L(t.view[0].line),s=t.view[0].node):(a=L(t.view[o].line),s=t.view[o-1].node.nextSibling);var l,c,d=Sn(e,r.line);if(d==t.view.length-1?(l=t.viewTo-1,c=t.lineDiv.lastChild):(l=L(t.view[d+1].line)-1,c=t.view[d+1].node.previousSibling),!s)return!1;for(var u=e.doc.splitLines(Vo(e,s,c,a,l)),h=_(e.doc,P(a,0),P(l,F(e.doc,l).text.length));u.length>1&&h.length>1;)if(m(u)==m(h))u.pop(),h.pop(),l--;else{if(u[0]!=h[0])break;u.shift(),h.shift(),a++}for(var p=0,f=0,g=u[0],v=h[0],y=Math.min(g.length,v.length);p<y&&g.charCodeAt(p)==v.charCodeAt(p);)++p;for(var b=m(u),w=m(h),x=Math.min(b.length-(1==u.length?p:0),w.length-(1==h.length?p:0));f<x&&b.charCodeAt(b.length-f-1)==w.charCodeAt(w.length-f-1);)++f;if(1==u.length&&1==h.length&&a==i.line)for(;p&&p>i.ch&&b.charCodeAt(b.length-f-1)==w.charCodeAt(w.length-f-1);)p--,f++;u[u.length-1]=b.slice(0,b.length-f).replace(/^\u200b+/,""),u[0]=u[0].slice(p).replace(/\u200b+$/,"");var C=P(a,p),k=P(l,h.length?m(h).length-f:0);return u.length>1||u[0]||O(C,k)?(Rr(e.doc,u,C,k,"+input"),!0):void 0},Ps.prototype.ensurePolled=function(){this.forceCompositionEnd()},Ps.prototype.reset=function(){this.forceCompositionEnd()},Ps.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Ps.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()},80))},Ps.prototype.updateFromDOM=function(){var e=this;!this.cm.isReadOnly()&&this.pollContent()||di(this.cm,function(){return fi(e.cm)})},Ps.prototype.setUneditable=function(e){e.contentEditable="false"},Ps.prototype.onKeyPress=function(e){0!=e.charCode&&(e.preventDefault(),this.cm.isReadOnly()||ui(this.cm,Po)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},Ps.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},Ps.prototype.onContextMenu=function(){},Ps.prototype.resetPosition=function(){},Ps.prototype.needsContentAttribute=!0;var Os=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new Ca,this.inaccurateSelection=!1,this.hasSelection=!1,this.composing=null};Os.prototype.init=function(e){function t(e){if(!Le(r,e)){if(r.somethingSelected())Io({lineWise:!1,text:r.getSelections()}),i.inaccurateSelection&&(i.prevInput="",i.inaccurateSelection=!1,a.value=Is.text.join("\n"),xa(a));else{if(!r.options.lineWiseCopyCut)return;var t=Bo(r);Io({lineWise:!0,text:t.text}),"cut"==e.type?r.setSelections(t.ranges,null,Fa):(i.prevInput="",a.value=t.text.join("\n"),xa(a))}"cut"==e.type&&(r.state.cutIncoming=!0)}}var n=this,i=this,r=this.cm,o=this.wrapper=Ho(),a=this.textarea=o.firstChild;e.wrapper.insertBefore(o,e.wrapper.firstChild),da&&(a.style.width="0px"),Ba(a,"input",function(){ta&&na>=9&&n.hasSelection&&(n.hasSelection=null),i.poll()}),Ba(a,"paste",function(e){Le(r,e)||Oo(e,r)||(r.state.pasteIncoming=!0,i.fastPoll())}),Ba(a,"cut",t),Ba(a,"copy",t),Ba(e.scroller,"paste",function(t){Dt(e,t)||Le(r,t)||(r.state.pasteIncoming=!0,i.focus())}),Ba(e.lineSpace,"selectstart",function(t){Dt(e,t)||Pe(t)}),Ba(a,"compositionstart",function(){var e=r.getCursor("from");i.composing&&i.composing.range.clear(),i.composing={start:e,range:r.markText(e,r.getCursor("to"),{className:"CodeMirror-composing"})}}),Ba(a,"compositionend",function(){i.composing&&(i.poll(),i.composing.range.clear(),i.composing=null)})},Os.prototype.prepareSelection=function(){var e=this.cm,t=e.display,n=e.doc,i=En(e);if(e.options.moveInputWithCursor){var r=dn(e,n.sel.primary().head,"div"),o=t.wrapper.getBoundingClientRect(),a=t.lineDiv.getBoundingClientRect();i.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,r.top+a.top-o.top)),i.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,r.left+a.left-o.left))}return i},Os.prototype.showSelection=function(e){var t=this.cm.display;n(t.cursorDiv,e.cursors),n(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},Os.prototype.reset=function(e){if(!this.contextMenuPending&&!this.composing){var t,n,i=this.cm,r=i.doc;if(i.somethingSelected()){this.prevInput="";var o=r.sel.primary(),a=(t=Ua&&(o.to().line-o.from().line>100||(n=i.getSelection()).length>1e3))?"-":n||i.getSelection();this.textarea.value=a,i.state.focused&&xa(this.textarea),ta&&na>=9&&(this.hasSelection=a)}else e||(this.prevInput=this.textarea.value="",ta&&na>=9&&(this.hasSelection=null));this.inaccurateSelection=t}},Os.prototype.getField=function(){return this.textarea},Os.prototype.supportsTouch=function(){return!1},Os.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!ha||a()!=this.textarea))try{this.textarea.focus()}catch(e){}},Os.prototype.blur=function(){this.textarea.blur()},Os.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Os.prototype.receivedFocus=function(){this.slowPoll()},Os.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},Os.prototype.fastPoll=function(){function e(){n.poll()||t?(n.pollingFast=!1,n.slowPoll()):(t=!0,n.polling.set(60,e))}var t=!1,n=this;n.pollingFast=!0,n.polling.set(20,e)},Os.prototype.poll=function(){var e=this,t=this.cm,n=this.textarea,i=this.prevInput;if(this.contextMenuPending||!t.state.focused||$a(n)&&!i&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var r=n.value;if(r==i&&!t.somethingSelected())return!1;if(ta&&na>=9&&this.hasSelection===r||pa&&/[\uf700-\uf7ff]/.test(r))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var o=r.charCodeAt(0);if(8203!=o||i||(i="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var a=0,s=Math.min(i.length,r.length);a<s&&i.charCodeAt(a)==r.charCodeAt(a);)++a;return di(t,function(){Po(t,r.slice(a),i.length-a,null,e.composing?"*compose":null),r.length>1e3||r.indexOf("\n")>-1?n.value=e.prevInput="":e.prevInput=r,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Os.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Os.prototype.onKeyPress=function(){ta&&na>=9&&(this.hasSelection=null),this.fastPoll()},Os.prototype.onContextMenu=function(e){function t(){if(null!=a.selectionStart){var e=r.somethingSelected(),t="​"+(e?a.value:"");a.value="⇚",a.value=t,i.prevInput=e?"":"​",a.selectionStart=1,a.selectionEnd=t.length,o.selForContextMenu=r.doc.sel}}function n(){if(i.contextMenuPending=!1,i.wrapper.style.cssText=d,a.style.cssText=c,ta&&na<9&&o.scrollbars.setScrollTop(o.scroller.scrollTop=l),null!=a.selectionStart){(!ta||ta&&na<9)&&t();var e=0,n=function(){o.selForContextMenu==r.doc.sel&&0==a.selectionStart&&a.selectionEnd>0&&"​"==i.prevInput?ui(r,Tr)(r):e++<10?o.detectingSelectAll=setTimeout(n,500):(o.selForContextMenu=null,o.input.reset())};o.detectingSelectAll=setTimeout(n,200)}}var i=this,r=i.cm,o=r.display,a=i.textarea,s=kn(r,e),l=o.scroller.scrollTop;if(s&&!aa){r.options.resetSelectionOnContextMenu&&-1==r.doc.sel.contains(s)&&ui(r,vr)(r.doc,Di(s),Fa);var c=a.style.cssText,d=i.wrapper.style.cssText;i.wrapper.style.cssText="position: absolute";var u=i.wrapper.getBoundingClientRect();a.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-u.top-5)+"px; left: "+(e.clientX-u.left-5)+"px;\n      z-index: 1000; background: "+(ta?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";var h;if(ia&&(h=window.scrollY),o.input.focus(),ia&&window.scrollTo(null,h),o.input.reset(),r.somethingSelected()||(a.value=i.prevInput=" "),i.contextMenuPending=!0,o.selForContextMenu=r.doc.sel,clearTimeout(o.detectingSelectAll),ta&&na>=9&&t(),ba){Be(e);var p=function(){Me(window,"mouseup",p),setTimeout(n,20)};Ba(window,"mouseup",p)}else setTimeout(n,50)}},Os.prototype.readOnlyChanged=function(e){e||this.reset()},Os.prototype.setUneditable=function(){},Os.prototype.needsContentAttribute=!1,function(e){function t(t,i,r,o){e.defaults[t]=i,r&&(n[t]=o?function(e,t,n){n!=Ns&&r(e,t,n)}:r)}var n=e.optionHandlers;e.defineOption=t,e.Init=Ns,t("value","",function(e,t){return e.setValue(t)},!0),t("mode",null,function(e,t){e.doc.modeOption=t,qi(e)},!0),t("indentUnit",2,qi,!0),t("indentWithTabs",!1),t("smartIndent",!0),t("tabSize",4,function(e){Wi(e),rn(e),fi(e)},!0),t("lineSeparator",null,function(e,t){if(e.doc.lineSep=t,t){var n=[],i=e.doc.first;e.doc.iter(function(e){for(var r=0;;){var o=e.text.indexOf(t,r);if(-1==o)break;r=o+t.length,n.push(P(i,o))}i++});for(var r=n.length-1;r>=0;r--)Rr(e.doc,t,n[r],P(n[r].line,n[r].ch+t.length))}}),t("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,function(e,t,n){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),n!=Ns&&e.refresh()}),t("specialCharPlaceholder",ut,function(e){return e.refresh()},!0),t("electricChars",!0),t("inputStyle",ha?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),t("spellcheck",!1,function(e,t){return e.getInputField().spellcheck=t},!0),t("rtlMoveVisually",!ma),t("wholeLineUpdateBefore",!0),t("theme","default",function(e){Fo(e),_o(e)},!0),t("keyMap","default",function(e,t,n){var i=ro(t),r=n!=Ns&&ro(n);r&&r.detach&&r.detach(e,i),i.attach&&i.attach(e,r||null)}),t("extraKeys",null),t("lineWrapping",!1,No,!0),t("gutters",[],function(e){Ai(e.options),_o(e)},!0),t("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?wn(e.display)+"px":"0",e.refresh()},!0),t("coverGutterNextToScrollbar",!1,function(e){return Zn(e)},!0),t("scrollbarStyle","native",function(e){ti(e),Zn(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),t("lineNumbers",!1,function(e){Ai(e.options),_o(e)},!0),t("firstLineNumber",1,_o,!0),t("lineNumberFormatter",function(e){return e},_o,!0),t("showCursorWhenSelecting",!1,Tn,!0),t("resetSelectionOnContextMenu",!0),t("lineWiseCopyCut",!0),t("readOnly",!1,function(e,t){"nocursor"==t?(Rn(e),e.display.input.blur(),e.display.disabled=!0):e.display.disabled=!1,e.display.input.readOnlyChanged(t)}),t("disableInput",!1,function(e,t){t||e.display.input.reset()},!0),t("dragDrop",!0,Mo),t("allowDropFileTypes",null),t("cursorBlinkRate",530),t("cursorScrollMargin",0),t("cursorHeight",1,Tn,!0),t("singleCursorHeightPerLine",!0,Tn,!0),t("workTime",100),t("workDelay",100),t("flattenSpans",!0,Wi,!0),t("addModeClass",!1,Wi,!0),t("pollInterval",100),t("undoDepth",200,function(e,t){return e.doc.history.undoDepth=t}),t("historyEventDelay",1250),t("viewportMargin",10,function(e){return e.refresh()},!0),t("maxHighlightLength",1e4,Wi,!0),t("moveInputWithCursor",!0,function(e,t){t||e.display.input.resetPosition()}),t("tabindex",null,function(e,t){return e.display.input.getField().tabIndex=t||""}),t("autofocus",null),t("direction","ltr",function(e,t){return e.doc.setDirection(t)},!0)}(Lo),function(e){var t=e.optionHandlers,n=e.helpers={};e.prototype={constructor:e,focus:function(){window.focus(),this.display.input.focus()},setOption:function(e,n){var i=this.options,r=i[e];i[e]==n&&"mode"!=e||(i[e]=n,t.hasOwnProperty(e)&&ui(this,t[e])(this,n,r),Ne(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](ro(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,n=0;n<t.length;++n)if(t[n]==e||t[n].name==e)return t.splice(n,1),!0},addOverlay:hi(function(t,n){var i=t.token?t:e.getMode(this.options,t);if(i.startState)throw new Error("Overlays may not be stateful.");v(this.state.overlays,{mode:i,modeSpec:t,opaque:n&&n.opaque,priority:n&&n.priority||0},function(e){return e.priority}),this.state.modeGen++,fi(this)}),removeOverlay:hi(function(e){for(var t=this,n=this.state.overlays,i=0;i<n.length;++i){var r=n[i].modeSpec;if(r==e||"string"==typeof e&&r.name==e)return n.splice(i,1),t.state.modeGen++,void fi(t)}}),indentLine:hi(function(e,t,n){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),R(this.doc,e)&&Ro(this,e,t,n)}),indentSelection:hi(function(e){for(var t=this,n=this.doc.sel.ranges,i=-1,r=0;r<n.length;r++){var o=n[r];if(o.empty())o.head.line>i&&(Ro(t,o.head.line,e,!0),i=o.head.line,r==t.doc.sel.primIndex&&Wn(t));else{var a=o.from(),s=o.to(),l=Math.max(i,a.line);i=Math.min(t.lastLine(),s.line-(s.ch?0:1))+1;for(var c=l;c<i;++c)Ro(t,c,e);var d=t.doc.sel.ranges;0==a.ch&&n.length==d.length&&d[r].from().ch>0&&pr(t.doc,r,new cs(a,d[r].to()),Fa)}}}),getTokenAt:function(e,t){return it(this,e,t)},getLineTokens:function(e,t){return it(this,P(e),t,!0)},getTokenTypeAt:function(e){e=U(this.doc,e);var t,n=Xe(this,F(this.doc,e.line)),i=0,r=(n.length-1)/2,o=e.ch;if(0==o)t=n[2];else for(;;){var a=i+r>>1;if((a?n[2*a-1]:0)>=o)r=a;else{if(!(n[2*a+1]<o)){t=n[2*a+2];break}i=a+1}}var s=t?t.indexOf("overlay "):-1;return s<0?t:0==s?null:t.slice(0,s-1)},getModeAt:function(t){var n=this.doc.mode;return n.innerMode?e.innerMode(n,this.getTokenAt(t).state).mode:n},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var i=this,r=[];if(!n.hasOwnProperty(t))return r;var o=n[t],a=this.getModeAt(e);if("string"==typeof a[t])o[a[t]]&&r.push(o[a[t]]);else if(a[t])for(var s=0;s<a[t].length;s++){var l=o[a[t][s]];l&&r.push(l)}else a.helperType&&o[a.helperType]?r.push(o[a.helperType]):o[a.name]&&r.push(o[a.name]);for(var c=0;c<o._global.length;c++){var d=o._global[c];d.pred(a,i)&&-1==h(r,d.val)&&r.push(d.val)}return r},getStateAfter:function(e,t){var n=this.doc;return e=$(n,null==e?n.first+n.size-1:e),Ze(this,e+1,t)},cursorCoords:function(e,t){var n,i=this.doc.sel.primary();return n=null==e?i.head:"object"==typeof e?U(this.doc,e):e?i.from():i.to(),dn(this,n,t||"page")},charCoords:function(e,t){return cn(this,U(this.doc,e),t||"page")},coordsChar:function(e,t){return e=ln(this,e,t||"page"),pn(this,e.left,e.top)},lineAtHeight:function(e,t){return e=ln(this,{top:e,left:0},t||"page").top,A(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,n){var i,r=!1;if("number"==typeof e){var o=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>o&&(e=o,r=!0),i=F(this.doc,e)}else i=e;return sn(this,i,{top:0,left:0},t||"page",n||r).top+(r?this.doc.height-ye(i):0)},defaultTextHeight:function(){return vn(this.display)},defaultCharWidth:function(){return yn(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,n,i,r){var o=this.display,a=(e=dn(this,U(this.doc,e))).bottom,s=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),o.sizer.appendChild(t),"over"==i)a=e.top;else if("above"==i||"near"==i){var l=Math.max(o.wrapper.clientHeight,this.doc.height),c=Math.max(o.sizer.clientWidth,o.lineSpace.clientWidth);("above"==i||e.bottom+t.offsetHeight>l)&&e.top>t.offsetHeight?a=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=l&&(a=e.bottom),s+t.offsetWidth>c&&(s=c-t.offsetWidth)}t.style.top=a+"px",t.style.left=t.style.right="","right"==r?(s=o.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==r?s=0:"middle"==r&&(s=(o.sizer.clientWidth-t.offsetWidth)/2),t.style.left=s+"px"),n&&$n(this,{left:s,top:a,right:s+t.offsetWidth,bottom:a+t.offsetHeight})},triggerOnKeyDown:hi(mo),triggerOnKeyPress:hi(yo),triggerOnKeyUp:vo,execCommand:function(e){if(Fs.hasOwnProperty(e))return Fs[e].call(null,this)},triggerElectric:hi(function(e){Do(this,e)}),findPosH:function(e,t,n,i){var r=this,o=1;t<0&&(o=-1,t=-t);for(var a=U(this.doc,e),s=0;s<t&&!(a=$o(r.doc,a,o,n,i)).hitSide;++s);return a},moveH:hi(function(e,t){var n=this;this.extendSelectionsBy(function(i){return n.display.shift||n.doc.extend||i.empty()?$o(n.doc,i.head,e,t,n.options.rtlMoveVisually):e<0?i.from():i.to()},Ma)}),deleteH:hi(function(e,t){var n=this.doc.sel,i=this.doc;n.somethingSelected()?i.replaceSelection("",null,"+delete"):oo(this,function(n){var r=$o(i,n.head,e,t,!1);return e<0?{from:r,to:n.head}:{from:n.head,to:r}})}),findPosV:function(e,t,n,i){var r=this,o=1,a=i;t<0&&(o=-1,t=-t);for(var s=U(this.doc,e),l=0;l<t;++l){var c=dn(r,s,"div");if(null==a?a=c.left:c.left=a,(s=Uo(r,c,o,n)).hitSide)break}return s},moveV:hi(function(e,t){var n=this,i=this.doc,r=[],o=!this.display.shift&&!i.extend&&i.sel.somethingSelected();if(i.extendSelectionsBy(function(a){if(o)return e<0?a.from():a.to();var s=dn(n,a.head,"div");null!=a.goalColumn&&(s.left=a.goalColumn),r.push(s.left);var l=Uo(n,s,e,t);return"page"==t&&a==i.sel.primary()&&qn(n,cn(n,l,"div").top-s.top),l},Ma),r.length)for(var a=0;a<i.sel.ranges.length;a++)i.sel.ranges[a].goalColumn=r[a]}),findWordAt:function(e){var t=F(this.doc,e.line).text,n=e.ch,i=e.ch;if(t){var r=this.getHelper(e,"wordChars");"before"!=e.sticky&&i!=t.length||!n?++i:--n;for(var o=t.charAt(n),a=x(o,r)?function(e){return x(e,r)}:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!x(e)};n>0&&a(t.charAt(n-1));)--n;for(;i<t.length&&a(t.charAt(i));)++i}return new cs(P(e.line,n),P(e.line,i))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?s(this.display.cursorDiv,"CodeMirror-overwrite"):wa(this.display.cursorDiv,"CodeMirror-overwrite"),Ne(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==a()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:hi(function(e,t){zn(this,e,t)}),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-$t(this)-this.display.barHeight,width:e.scrollWidth-$t(this)-this.display.barWidth,clientHeight:qt(this),clientWidth:Ut(this)}},scrollIntoView:hi(function(e,t){null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:P(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?Vn(this,e):Yn(this,e.from,e.to,e.margin)}),setSize:hi(function(e,t){var n=this,i=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=i(e)),null!=t&&(this.display.wrapper.style.height=i(t)),this.options.lineWrapping&&nn(this);var r=this.display.viewFrom;this.doc.iter(r,this.display.viewTo,function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){mi(n,r,"widget");break}++r}),this.curOp.forceUpdate=!0,Ne(this,"refresh",this)}),operation:function(e){return di(this,e)},refresh:hi(function(){var e=this.display.cachedTextHeight;fi(this),this.curOp.forceUpdate=!0,rn(this),zn(this,this.doc.scrollLeft,this.doc.scrollTop),Mi(this),(null==e||Math.abs(e-vn(this.display))>.5)&&Cn(this),Ne(this,"refresh",this)}),swapDoc:hi(function(e){var t=this.doc;return t.cm=null,Yi(this,e),rn(this),this.display.input.reset(),zn(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,Ct(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Ie(e),e.registerHelper=function(t,i,r){n.hasOwnProperty(t)||(n[t]=e[t]={_global:[]}),n[t][i]=r},e.registerGlobalHelper=function(t,i,r,o){e.registerHelper(t,i,o),n[t]._global.push({pred:r,val:o})}}(Lo);var Ds="iter insert remove copy getEditor constructor".split(" ");for(var Bs in vs.prototype)vs.prototype.hasOwnProperty(Bs)&&h(Ds,Bs)<0&&(Lo.prototype[Bs]=function(e){return function(){return e.apply(this.doc,arguments)}}(vs.prototype[Bs]));return Ie(vs),Lo.inputStyles={textarea:Os,contenteditable:Ps},Lo.defineMode=function(e){Lo.defaults.mode||"null"==e||(Lo.defaults.mode=e),We.apply(this,arguments)},Lo.defineMIME=function(e,t){za[e]=t},Lo.defineMode("null",function(){return{token:function(e){return e.skipToEnd()}}}),Lo.defineMIME("text/plain","null"),Lo.defineExtension=function(e,t){Lo.prototype[e]=t},Lo.defineDocExtension=function(e,t){vs.prototype[e]=t},Lo.fromTextArea=function(e,t,n,i){function r(){e.value=u.getValue()}if(t=t?d(t):{},t.value=e.value,!t.tabindex&&e.tabIndex&&(t.tabindex=e.tabIndex),!t.placeholder&&e.placeholder&&(t.placeholder=e.placeholder),null==t.autofocus){var o=a();t.autofocus=o==e||null!=e.getAttribute("autofocus")&&o==document.body}var s;if(e.form&&(Ba(e.form,"submit",r),!t.leaveSubmitMethodAlone)){var l=e.form;s=l.submit;try{var c=l.submit=function(){r(),l.submit=s,l.submit(),l.submit=c}}catch(e){}}t.finishInit=function(t){t.save=r,t.getTextArea=function(){return e},t.toTextArea=function(){t.toTextArea=isNaN,r(),e.parentNode.removeChild(t.getWrapperElement()),e.style.display="",e.form&&(Me(e.form,"submit",r),"function"==typeof e.form.submit&&(e.form.submit=s))}},e.style.display="none";var u=Lo(function(t){return e.parentNode.insertBefore(t,e.nextSibling)},t,n,i);return u},function(e){e.off=Me,e.on=Ba,e.wheelEventPixels=Ii,e.Doc=vs,e.splitLines=Ha,e.countColumn=u,e.findColumn=p,e.isWordChar=w,e.Pass=Ea,e.signal=Ne,e.Line=Ya,e.changeEnd=Bi,e.scrollbarModel=is,e.Pos=P,e.cmpPos=O,e.modes=Wa,e.mimeModes=za,e.resolveMode=ze,e.getMode=Ve,e.modeExtensions=Va,e.extendMode=Ke,e.copyState=Ye,e.startState=Ge,e.innerMode=Je,e.commands=Fs,e.keyMap=Ss,e.keyName=io,e.isModifierKey=no,e.lookupKey=to,e.normalizeKeyMap=eo,e.StringStream=Ka,e.SharedTextMarker=ms,e.TextMarker=fs,e.LineWidget=hs,e.e_preventDefault=Pe,e.e_stopPropagation=Oe,e.e_stop=Be,e.addClass=s,e.contains=o,e.rmClass=wa,e.keyNames=ws}(Lo),Lo.version="5.26.0",Lo}()}),define("rangy/rangy-core.js",[],function(e,t,n){"use strict";var i=function(e){function t(e,t){var n=typeof e[t];return n==g||!(n!=m||!e[t])||"unknown"==n}function n(e,t){return!(typeof e[t]!=m||!e[t])}function i(e,t){return typeof e[t]!=v}function r(e){return function(t,n){for(var i=n.length;i--;)if(!e(t,n[i]))return!1;return!0}}function o(e){return e&&C(e,x)&&S(e,w)}function a(e){return n(e,"body")?e.body:e.getElementsByTagName("body")[0]}function s(e){n(window,"console")&&t(window.console,"log")&&window.console.log(e)}function l(e,t){t?window.alert(e):s(e)}function c(e){E.initialized=!0,E.supported=!1,l("Rangy is not supported on this page in your browser. Reason: "+e,E.config.alertOnFail)}function d(e){return e.message||e.description||String(e)}function u(){if(!E.initialized){var e,n=!1,i=!1;t(document,"createRange")&&(e=document.createRange(),C(e,b)&&S(e,y)&&(n=!0));var r=a(document);if(r&&"body"==r.nodeName.toLowerCase())if(r&&t(r,"createTextRange")&&o(e=r.createTextRange())&&(i=!0),n||i){E.initialized=!0,E.features={implementsDomRange:n,implementsTextRange:i};var l;for(var u in T)(l=T[u])instanceof h&&l.init(l,E);for(var p=0,f=_.length;p<f;++p)try{_[p](E)}catch(e){s("Rangy init listener threw an exception. Continuing. Detail: "+d(e))}}else c("Neither Range nor TextRange are available");else c("No body element found")}}function h(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function p(e,t,n,i){var r=new h(t,n,function(e){if(!e.initialized){e.initialized=!0;try{i(E,e),e.supported=!0}catch(e){s("Module '"+t+"' failed to load: "+d(e))}}});T[t]=r}function f(){}var m="object",g="function",v="undefined",y=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],b=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],w=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],x=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],C=r(t),k=r(n),S=r(i),T={},E={version:"1.3alpha.20140716",initialized:!1,supported:!0,util:{isHostMethod:t,isHostObject:n,isHostProperty:i,areHostMethods:C,areHostObjects:k,areHostProperties:S,isTextRange:o,getBody:a},features:{},modules:T,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};E.fail=c,E.warn=function(e){l("Rangy warning: "+e,E.config.alertOnWarn)},!{}.hasOwnProperty?c("hasOwnProperty not supported"):E.util.extend=function(e,t,n){var i,r;for(var o in t)t.hasOwnProperty(o)&&(i=e[o],r=t[o],n&&null!==i&&"object"==typeof i&&null!==r&&"object"==typeof r&&E.util.extend(i,r,!0),e[o]=r);return t.hasOwnProperty("toString")&&(e.toString=t.toString),e},function(){var e=document.createElement("div");e.appendChild(document.createElement("span"));var t,n=[].slice;try{1==n.call(e.childNodes,0)[0].nodeType&&(t=function(e){return n.call(e,0)})}catch(e){}t||(t=function(e){for(var t=[],n=0,i=e.length;n<i;++n)t[n]=e[n];return t}),E.util.toArray=t}();var F;t(document,"addEventListener")?F=function(e,t,n){e.addEventListener(t,n,!1)}:t(document,"attachEvent")?F=function(e,t,n){e.attachEvent("on"+t,n)}:c("Document does not have required addEventListener or attachEvent method"),E.util.addListener=F;var _=[];E.init=u,E.addInitListener=function(e){E.initialized?e(E):_.push(e)};var M=[];E.addCreateMissingNativeApiListener=function(e){M.push(e)},E.createMissingNativeApi=function(e){e=e||window,u();for(var t=0,n=M.length;t<n;++t)M[t](e)},h.prototype={init:function(e){for(var t,n,i=this.dependencies||[],r=0,o=i.length;r<o;++r){if(n=i[r],!((t=T[n])&&t instanceof h))throw new Error("required module '"+n+"' not found");if(t.init(),!t.supported)throw new Error("required module '"+n+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+e)},warn:function(e){E.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){E.warn("DEPRECATED: "+e+" in module "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},E.createModule=function(e){var t,n;2==arguments.length?(t=arguments[1],n=[]):(t=arguments[2],n=arguments[1]),p(0,e,n,t)},E.createCoreModule=function(e,t,n){p(0,e,t,n)},E.RangePrototype=f,E.rangePrototype=new f,E.selectionPrototype=new function(){};var N=!1,L=function(e){N||(N=!0,E.initialized||u())};if(typeof window!=v){if(typeof document!=v)return t(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",L,!1),F(window,"load",L),E;c("No document found")}else c("No window found")}();i.createCoreModule("DomUtil",[],function(e,t){function n(e){for(var t=0;e=e.previousSibling;)++t;return t}function i(e,t){var n,i=[];for(n=e;n;n=n.parentNode)i.push(n);for(n=t;n;n=n.parentNode)if(x(i,n))return n;return null}function r(e,t,n){for(var i=n?t:t.parentNode;i;){if(i===e)return!0;i=i.parentNode}return!1}function o(e,t,n){for(var i,r=n?e:e.parentNode;r;){if((i=r.parentNode)===t)return r;r=i}return null}function a(e){var t=e.nodeType;return 3==t||4==t||8==t}function s(e,t){var n=t.nextSibling,i=t.parentNode;return n?i.insertBefore(e,n):i.appendChild(e),e}function l(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=v)return e.ownerDocument;if(typeof e.document!=v)return e.document;if(e.parentNode)return l(e.parentNode);throw t.createError("getDocument: no document found for node")}function c(e){var n=l(e);if(typeof n.defaultView!=v)return n.defaultView;if(typeof n.parentWindow!=v)return n.parentWindow;throw t.createError("Cannot get a window object for node")}function d(e){if(typeof e.contentDocument!=v)return e.contentDocument;if(typeof e.contentWindow!=v)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function u(e){return e&&y.isHostMethod(e,"setTimeout")&&y.isHostObject(e,"document")}function h(e){try{return e.parentNode,!1}catch(e){return!0}}function p(e){if(!e)return"[No node]";if(C&&h(e))return"[Broken node]";if(a(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">[index:"+n(e)+",length:"+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return e.nodeName}function f(e){this.root=e,this._next=e}function m(e,t){this.node=e,this.offset=t}function g(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var v="undefined",y=e.util;y.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),y.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var b=document.createElement("div");y.areHostMethods(b,["insertBefore","appendChild","cloneNode"]||!y.areHostObjects(b,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),y.isHostProperty(b,"innerHTML")||t.fail("Element is missing innerHTML property");var w=document.createTextNode("test");y.areHostMethods(w,["splitText","deleteData","insertData","appendData","cloneNode"]||!y.areHostObjects(b,["previousSibling","nextSibling","childNodes","parentNode"])||!y.areHostProperties(w,["data"]))||t.fail("Incomplete Text Node implementation");var x=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},C=!1;!function(){var t=document.createElement("b");t.innerHTML="1";var n=t.firstChild;t.innerHTML="<br>",C=h(n),e.features.crashyTextNodes=C}();var k;typeof window.getComputedStyle!=v?k=function(e,t){return c(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=v?k=function(e,t){return e.currentStyle[t]}:t.fail("No means of obtaining computed style properties found"),f.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},m.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+p(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},(g.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24}).toString=function(){return this.message},e.dom={arrayContains:x,isHtmlNamespace:function(e){var t;return typeof e.namespaceURI==v||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t},parentElement:function(e){var t=e.parentNode;return 1==t.nodeType?t:null},getNodeIndex:n,getNodeLength:function(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}},getCommonAncestor:i,isAncestorOf:r,isOrIsAncestorOf:function(e,t){return r(e,t,!0)},getClosestAncestorIn:o,isCharacterDataNode:a,isTextOrCommentNode:function(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t},insertAfter:s,splitDataNode:function(e,t,i){var r=e.cloneNode(!1);if(r.deleteData(0,t),e.deleteData(t,e.length-t),s(r,e),i)for(var o,a=0;o=i[a++];)o.node==e&&o.offset>t?(o.node=r,o.offset-=t):o.node==e.parentNode&&o.offset>n(e)&&++o.offset;return r},getDocument:l,getWindow:c,getIframeWindow:function(e){if(typeof e.contentWindow!=v)return e.contentWindow;if(typeof e.contentDocument!=v)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")},getIframeDocument:d,getBody:y.getBody,isWindow:u,getContentDocument:function(e,t,n){var i;if(e?y.isHostProperty(e,"nodeType")?i=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?d(e):l(e):u(e)&&(i=e.document):i=document,!i)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return i},getRootContainer:function(e){for(var t;t=e.parentNode;)e=t;return e},comparePoints:function(e,r,a,s){var l,c,d,u,h;if(e==a)return r===s?0:r<s?-1:1;if(l=o(a,e,!0))return r<=n(l)?-1:1;if(l=o(e,a,!0))return n(l)<s?-1:1;if(!(c=i(e,a)))throw new Error("comparePoints error: nodes have no common ancestor");if(d=e===c?c:o(e,c,!0),u=a===c?c:o(a,c,!0),d===u)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");for(h=c.firstChild;h;){if(h===d)return-1;if(h===u)return 1;h=h.nextSibling}},isBrokenNode:h,inspectNode:p,getComputedStyleProperty:k,fragmentFromNodeChildren:function(e){for(var t,n=l(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n},createIterator:function(e){return new f(e)},DomPosition:m},e.DOMException=g}),i.createCoreModule("DomRange",["DomUtil"],function(e,t){function n(e,t){return 3!=e.nodeType&&(H(e,t.startContainer)||H(e,t.endContainer))}function i(e){return e.document||$(e.startContainer)}function r(e){return new O(e.parentNode,j(e))}function o(e){return new O(e.parentNode,j(e)+1)}function a(e,t,n){var i=11==e.nodeType?e.firstChild:e;return B(t)?n==t.length?I.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:q(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),i}function s(e,t,n){if(T(e),T(t),i(t)!=i(e))throw new D("WRONG_DOCUMENT_ERR");var r=U(e.startContainer,e.startOffset,t.endContainer,t.endOffset),o=U(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return n?r<=0&&o>=0:r<0&&o>0}function l(e){for(var t,n,r,o=i(e.range).createDocumentFragment();n=e.next();){if(t=e.isPartiallySelectedSubtree(),n=n.cloneNode(!t),t&&(r=e.getSubtreeIterator(),n.appendChild(l(r)),r.detach()),10==n.nodeType)throw new D("HIERARCHY_REQUEST_ERR");o.appendChild(n)}return o}function c(e,t,n){var i,r;n=n||{stop:!1};for(var o,a;o=e.next();)if(e.isPartiallySelectedSubtree()){if(!1===t(o))return void(n.stop=!0);if(a=e.getSubtreeIterator(),c(a,t,n),a.detach(),n.stop)return}else for(i=I.createIterator(o);r=i.next();)if(!1===t(r))return void(n.stop=!0)}function d(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(d(t=e.getSubtreeIterator()),t.detach()):e.remove()}function u(e){for(var t,n,r=i(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),n=e.getSubtreeIterator(),t.appendChild(u(n)),n.detach()):e.remove(),10==t.nodeType)throw new D("HIERARCHY_REQUEST_ERR");r.appendChild(t)}return r}function h(e,t,n){var i,r=!(!t||!t.length),o=!!n;r&&(i=new RegExp("^("+t.join("|")+")$"));var a=[];return c(new f(e,!1),function(t){if((!r||i.test(t.nodeType))&&(!o||n(t))){var s=e.startContainer;if(t!=s||!B(s)||e.startOffset!=s.length){var l=e.endContainer;t==l&&B(l)&&0==e.endOffset||a.push(t)}}}),a}function p(e){return"["+(void 0===e.getName?"Range":e.getName())+"("+I.inspectNode(e.startContainer)+":"+e.startOffset+", "+I.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function f(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&B(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||B(this.sc)?W(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||B(this.ec)?W(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}function m(e){return function(t,n){for(var i,r=n?t:t.parentNode;r;){if(i=r.nodeType,V(e,i))return r;r=r.parentNode}return null}}function g(e,t){if(ne(e,t))throw new D("INVALID_NODE_TYPE_ERR")}function v(e,t){if(!V(t,e.nodeType))throw new D("INVALID_NODE_TYPE_ERR")}function y(e,t){if(t<0||t>(B(e)?e.length:e.childNodes.length))throw new D("INDEX_SIZE_ERR")}function b(e,t){if(ee(e,!0)!==ee(t,!0))throw new D("WRONG_DOCUMENT_ERR")}function w(e){if(te(e,!0))throw new D("NO_MODIFICATION_ALLOWED_ERR")}function x(e,t){if(!e)throw new D(t)}function C(e){return Y&&I.isBrokenNode(e)||!V(G,e.nodeType)&&!ee(e,!0)}function k(e,t){return t<=(B(e)?e.length:e.childNodes.length)}function S(e){return!!e.startContainer&&!!e.endContainer&&!C(e.startContainer)&&!C(e.endContainer)&&k(e.startContainer,e.startOffset)&&k(e.endContainer,e.endOffset)}function T(e){if(!S(e))throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}function E(e,t){T(e);var n=e.startContainer,i=e.startOffset,r=e.endContainer,o=e.endOffset,a=n===r;B(r)&&o>0&&o<r.length&&q(r,o,t),B(n)&&i>0&&i<n.length&&(n=q(n,i,t),a?(o-=i,r=n):r==n.parentNode&&o>=j(n)&&o++,i=0),e.setStartAndEnd(n,i,r,o)}function F(e){e.START_TO_START=se,e.START_TO_END=le,e.END_TO_END=ce,e.END_TO_START=de,e.NODE_BEFORE=ue,e.NODE_AFTER=he,e.NODE_BEFORE_AND_AFTER=pe,e.NODE_INSIDE=fe}function _(e){F(e),F(e.prototype)}function M(e,t){return function(){T(this);var n,i=this.startContainer,r=this.startOffset,a=this.commonAncestorContainer,s=new f(this,!0);i!==a&&(i=(n=o(W(i,a,!0))).node,r=n.offset),c(s,w),s.reset();var l=e(s);return s.detach(),t(this,i,r,i,r),l}}function N(t,i){function a(e,t){return function(n){v(n,J),v(K(n),G);var i=(e?r:o)(n);(t?s:l)(this,i.node,i.offset)}}function s(e,t,n){var r=e.endContainer,o=e.endOffset;t===e.startContainer&&n===e.startOffset||(K(t)==K(r)&&1!=U(t,n,r,o)||(r=t,o=n),i(e,t,n,r,o))}function l(e,t,n){var r=e.startContainer,o=e.startOffset;t===e.endContainer&&n===e.endOffset||(K(t)==K(r)&&-1!=U(t,n,r,o)||(r=t,o=n),i(e,r,o,t,n))}var c=function(){};c.prototype=e.rangePrototype,t.prototype=new c,P.extend(t.prototype,{setStart:function(e,t){g(e,!0),y(e,t),s(this,e,t)},setEnd:function(e,t){g(e,!0),y(e,t),l(this,e,t)},setStartAndEnd:function(){var e=arguments,t=e[0],n=e[1],r=t,o=n;switch(e.length){case 3:o=e[2];break;case 4:r=e[2],o=e[3]}i(this,t,n,r,o)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:a(!0,!0),setStartAfter:a(!1,!0),setEndBefore:a(!0,!1),setEndAfter:a(!1,!1),collapse:function(e){T(this),e?i(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):i(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){g(e,!0),i(this,e,0,e,z(e))},selectNode:function(e){g(e,!1),v(e,J);var t=r(e),n=o(e);i(this,t.node,t.offset,n.node,n.offset)},extractContents:M(u,i),deleteContents:M(d,i),canSurroundContents:function(){T(this),w(this.startContainer),w(this.endContainer);var e=new f(this,!0),t=e._first&&n(e._first,this)||e._last&&n(e._last,this);return e.detach(),!t},splitBoundaries:function(){E(this)},splitBoundariesPreservingPositions:function(e){E(this,e)},normalizeBoundaries:function(){T(this);var e=this.startContainer,t=this.startOffset,n=this.endContainer,r=this.endOffset,o=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(n=e,r=e.length,e.appendData(t.data),t.parentNode.removeChild(t))},a=function(i){var o=i.previousSibling;if(o&&o.nodeType==i.nodeType){e=i;var a=i.length;if(t=o.length,i.insertData(0,o.data),o.parentNode.removeChild(o),e==n)r+=t,n=e;else if(n==i.parentNode){var s=j(i);r==s?(n=i,r=a):r>s&&r--}}},s=!0;if(B(n))n.length==r&&o(n);else{if(r>0){var l=n.childNodes[r-1];l&&B(l)&&o(l)}s=!this.collapsed}if(s){if(B(e))0==t&&a(e);else if(t<e.childNodes.length){var c=e.childNodes[t];c&&B(c)&&a(c)}}else e=n,t=r;i(this,e,t,n,r)},collapseToPoint:function(e,t){g(e,!0),y(e,t),this.setStartAndEnd(e,t)}}),_(t)}function L(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:I.getCommonAncestor(e.startContainer,e.endContainer)}function A(e,t,n,i,r){e.startContainer=t,e.startOffset=n,e.endContainer=i,e.endOffset=r,e.document=I.getDocument(t),L(e)}function R(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,L(this)}var I=e.dom,P=e.util,O=I.DomPosition,D=e.DOMException,B=I.isCharacterDataNode,j=I.getNodeIndex,H=I.isOrIsAncestorOf,$=I.getDocument,U=I.comparePoints,q=I.splitDataNode,W=I.getClosestAncestorIn,z=I.getNodeLength,V=I.arrayContains,K=I.getRootContainer,Y=e.features.crashyTextNodes;f.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,B(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!B(n)||n!==this.sc&&n!==this.ec?n.parentNode&&n.parentNode.removeChild(n):(e=n===this.sc?this.so:0)!=(t=n===this.ec?this.eo:n.length)&&n.deleteData(e,t-e)},isPartiallySelectedSubtree:function(){return n(this._current,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)(e=this.range.cloneRange()).collapse(!1);else{e=new R(i(this.range));var t=this._current,n=t,r=0,o=t,a=z(t);H(t,this.sc)&&(n=this.sc,r=this.so),H(t,this.ec)&&(o=this.ec,a=this.eo),A(e,n,r,o,a)}return new f(e,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var J=[1,3,4,5,7,8,10],G=[2,9,11],Q=[5,6,10,12],X=[1,3,4,5,7,8,10,11],Z=[1,3,4,5,7,8],ee=m([9,11]),te=m(Q),ne=m([6,10,12]),ie=document.createElement("style"),re=!1;try{ie.innerHTML="<b>x</b>",re=3==ie.firstChild.nodeType}catch(e){}e.features.htmlParsingConforms=re;var oe=re?function(e){var t=this.startContainer,n=$(t);if(!t)throw new D("INVALID_STATE_ERR");var i=null;return 1==t.nodeType?i=t:B(t)&&(i=I.parentElement(t)),i=null===i||"HTML"==i.nodeName&&I.isHtmlNamespace($(i).documentElement)&&I.isHtmlNamespace(i)?n.createElement("body"):i.cloneNode(!1),i.innerHTML=e,I.fragmentFromNodeChildren(i)}:function(e){var t=i(this).createElement("body");return t.innerHTML=e,I.fragmentFromNodeChildren(t)},ae=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],se=0,le=1,ce=2,de=3,ue=0,he=1,pe=2,fe=3;P.extend(e.rangePrototype,{compareBoundaryPoints:function(e,t){T(this),b(this.startContainer,t.startContainer);var n,i,r,o,a=e==de||e==se?"start":"end",s=e==le||e==se?"start":"end";return n=this[a+"Container"],i=this[a+"Offset"],r=t[s+"Container"],o=t[s+"Offset"],U(n,i,r,o)},insertNode:function(e){if(T(this),v(e,X),w(this.startContainer),H(e,this.startContainer))throw new D("HIERARCHY_REQUEST_ERR");var t=a(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){T(this);var e,t;if(this.collapsed)return i(this).createDocumentFragment();if(this.startContainer===this.endContainer&&B(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),(t=i(this).createDocumentFragment()).appendChild(e),t;var n=new f(this,!0);return e=l(n),n.detach(),e},canSurroundContents:function(){T(this),w(this.startContainer),w(this.endContainer);var e=new f(this,!0),t=e._first&&n(e._first,this)||e._last&&n(e._last,this);return e.detach(),!t},surroundContents:function(e){if(v(e,Z),!this.canSurroundContents())throw new D("INVALID_STATE_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);a(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){T(this);for(var e,t=new R(i(this)),n=ae.length;n--;)t[e=ae[n]]=this[e];return t.isBackward=this.isBackward,t},toString:function(){T(this);var e=this.startContainer;if(e===this.endContainer&&B(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new f(this,!0);return c(n,function(e){3!=e.nodeType&&4!=e.nodeType||t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){T(this);var t=e.parentNode,n=j(e);if(!t)throw new D("NOT_FOUND_ERR");var i=this.comparePoint(t,n),r=this.comparePoint(t,n+1);return i<0?r>0?pe:ue:r>0?he:fe},comparePoint:function(e,t){return T(this),x(e,"HIERARCHY_REQUEST_ERR"),b(e,this.startContainer),U(e,t,this.startContainer,this.startOffset)<0?-1:U(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:oe,toHtml:function(){T(this);var e=this.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(this.cloneContents()),e.innerHTML},intersectsNode:function(e,t){if(T(this),x(e,"NOT_FOUND_ERR"),$(e)!==i(this))return!1;var n=e.parentNode,r=j(e);x(n,"NOT_FOUND_ERR");var o=U(n,r,this.endContainer,this.endOffset),a=U(n,r+1,this.startContainer,this.startOffset);return t?o<=0&&a>=0:o<0&&a>0},isPointInRange:function(e,t){return T(this),x(e,"HIERARCHY_REQUEST_ERR"),b(e,this.startContainer),U(e,t,this.startContainer,this.startOffset)>=0&&U(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return s(this,e,!1)},intersectsOrTouchesRange:function(e){return s(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=U(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=U(this.endContainer,this.endOffset,e.endContainer,e.endOffset),i=this.cloneRange();return-1==t&&i.setStart(e.startContainer,e.startOffset),1==n&&i.setEnd(e.endContainer,e.endOffset),i}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==U(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==U(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new D("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==fe},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,z(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var i=n.pop();return t.setEnd(i,i.length),this.containsRange(t)}return this.containsNodeContents(e)},getNodes:function(e,t){return T(this),h(this,e,t)},getDocument:function(){return i(this)},collapseBefore:function(e){this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){this.setStartAfter(e),this.collapse(!0)},getBookmark:function(t){function n(e){var t=e.cloneContents();if(t.querySelector("text")){for(var n=t.querySelectorAll("svg"),i=0;i<n.length;i++)n[i].parentElement.removeChild(n[i]);return t.textContent.length}return e.toString().length}var r=i(this),o=e.createRange(r);t=t||I.getBody(r),o.selectNodeContents(t);var a=this.intersection(o),s=t.querySelectorAll("text").length,l=0,c=0;return a&&(o.setEnd(a.startContainer,a.startOffset),c=(l=s?n(o):o.toString().length)+(s?n(a):a.toString().length)),{start:l,end:c,containerNode:t}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var i,r,o,a,s=[t],l=!1,c=!1;!c&&(i=s.pop());)if(3==i.nodeType)r=n+i.length,!l&&e.start>=n&&e.start<=r&&(this.setStart(i,e.start-n),l=!0),l&&e.end>=n&&e.end<=r&&(this.setEnd(i,e.end-n),c=!0),n=r;else if(!/^text$/i.exec(i.tagName||""))for(o=(a=i.childNodes).length;o--;)s.push(a[o])},getName:function(){return"DomRange"},equals:function(e){return R.rangesEqual(this,e)},isValid:function(){return S(this)},inspect:function(){return p(this)},detach:function(){}}),N(R,A),P.extend(R,{rangeProperties:ae,RangeIterator:f,copyComparisonConstants:_,createPrototypeRange:N,inspect:p,getRangeDocument:i,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=R}),i.createCoreModule("WrappedRange",["DomRange"],function(e,t){var n,i,r=e.dom,o=e.util,a=r.DomPosition,s=e.DomRange,l=r.getBody,c=r.getContentDocument,d=r.isCharacterDataNode;if(e.features.implementsDomRange&&function(){function i(e){for(var t,n=u.length;n--;)e[t=u[n]]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}var a,d,u=s.rangeProperties;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,i(this)},s.createPrototypeRange(n,function(e,t,n,i,r){var o=e.startContainer!==t||e.startOffset!=n,a=e.endContainer!==i||e.endOffset!=r,s=!e.equals(e.nativeRange);(o||a||s)&&(e.setEnd(i,r),e.setStart(t,n))}),(a=n.prototype).selectNode=function(e){this.nativeRange.selectNode(e),i(this)},a.cloneContents=function(){return this.nativeRange.cloneContents()},a.surroundContents=function(e){this.nativeRange.surroundContents(e),i(this)},a.collapse=function(e){this.nativeRange.collapse(e),i(this)},a.cloneRange=function(){var e=new n(this.nativeRange.cloneRange());return e.isBackward=this.isBackward,e},a.refresh=function(){i(this)},a.toString=function(){return this.nativeRange.toString()};var h=document.createTextNode("test");l(document).appendChild(h);var p=document.createRange();p.setStart(h,0),p.setEnd(h,0);try{p.setStart(h,1),a.setStart=function(e,t){this.nativeRange.setStart(e,t),i(this)},a.setEnd=function(e,t){this.nativeRange.setEnd(e,t),i(this)},d=function(e){return function(t){this.nativeRange[e](t),i(this)}}}catch(e){a.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}i(this)},a.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}i(this)},d=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(i){this.nativeRange[t](n),this.nativeRange[e](n)}i(this)}}}a.setStartBefore=d("setStartBefore","setEndBefore"),a.setStartAfter=d("setStartAfter","setEndAfter"),a.setEndBefore=d("setEndBefore","setStartBefore"),a.setEndAfter=d("setEndAfter","setStartAfter"),a.selectNodeContents=function(e){this.setStartAndEnd(e,0,r.getNodeLength(e))},p.selectNodeContents(h),p.setEnd(h,3);var f=document.createRange();f.selectNodeContents(h),f.setEnd(h,4),f.setStart(h,2),-1==p.compareBoundaryPoints(p.START_TO_END,f)&&1==p.compareBoundaryPoints(p.END_TO_START,f)?a.compareBoundaryPoints=function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:a.compareBoundaryPoints=function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var m=document.createElement("div");m.innerHTML="123";var g=m.firstChild,v=l(document);v.appendChild(m),p.setStart(g,1),p.setEnd(g,2),p.deleteContents(),"13"==g.data&&(a.deleteContents=function(){this.nativeRange.deleteContents(),i(this)},a.extractContents=function(){var e=this.nativeRange.extractContents();return i(this),e}),v.removeChild(m),v=null,o.isHostMethod(p,"createContextualFragment")&&(a.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),l(document).removeChild(h),a.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createNativeRange=function(e){return(e=c(e,t,"createNativeRange")).createRange()}}(),e.features.implementsTextRange){var u=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var i=n.parentElement();(n=e.duplicate()).collapse(!1);var o=n.parentElement(),a=i==o?i:r.getCommonAncestor(i,o);return a==t?a:r.getCommonAncestor(t,a)},h=function(e){return 0==e.compareEndPoints("StartToEnd",e)},p=function(e,t,n,i,o){var s=e.duplicate();s.collapse(n);var l=s.parentElement();if(r.isOrIsAncestorOf(t,l)||(l=t),!l.canHaveHTML){var c=new a(l.parentNode,r.getNodeIndex(l));return{boundaryPosition:c,nodeInfo:{nodeIndex:c.offset,containerElement:c.node}}}var u=r.getDocument(l).createElement("span");u.parentNode&&u.parentNode.removeChild(u);for(var h,p,f,m,g,v=n?"StartToStart":"StartToEnd",y=o&&o.containerElement==l?o.nodeIndex:0,b=l.childNodes.length,w=b,x=w;;){if(x==b?l.appendChild(u):l.insertBefore(u,l.childNodes[x]),s.moveToElementText(u),0==(h=s.compareEndPoints(v,e))||y==w)break;if(-1==h){if(w==y+1)break;y=x}else w=w==y+1?y:x;x=Math.floor((y+w)/2),l.removeChild(u)}if(g=u.nextSibling,-1==h&&g&&d(g)){s.setEndPoint(n?"EndToStart":"EndToEnd",e);var C;if(/[\r\n]/.test(g.data)){var k=s.duplicate(),S=k.text.replace(/\r\n/g,"\r").length;for(C=k.moveStart("character",S);-1==(h=k.compareEndPoints("StartToEnd",k));)C++,k.moveStart("character",1)}else C=s.text.length;m=new a(g,C)}else p=(i||!n)&&u.previousSibling,m=(f=(i||n)&&u.nextSibling)&&d(f)?new a(f,0):p&&d(p)?new a(p,p.data.length):new a(l,r.getNodeIndex(u));return u.parentNode.removeChild(u),{boundaryPosition:m,nodeInfo:{nodeIndex:x,containerElement:l}}},f=function(e,t){var n,i,o,a,s=e.offset,c=r.getDocument(e.node),u=l(c).createTextRange(),h=d(e.node);return h?i=(n=e.node).parentNode:(n=s<(a=e.node.childNodes).length?a[s]:null,i=e.node),o=c.createElement("span"),o.innerHTML="&#feff;",n?i.insertBefore(o,n):i.appendChild(o),u.moveToElementText(o),u.collapse(!t),i.removeChild(o),h&&u[t?"moveStart":"moveEnd"]("character",s),u};if(i=function(e){this.textRange=e,this.refresh()},i.prototype=new s(document),i.prototype.refresh=function(){var e,t,n,i=u(this.textRange);h(this.textRange)?t=e=p(this.textRange,i,!0,!0).boundaryPosition:(e=(n=p(this.textRange,i,!0,!1)).boundaryPosition,t=p(this.textRange,i,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},i.prototype.getName=function(){return"WrappedTextRange"},s.copyComparisonConstants(i),i.rangeToTextRange=function(e){if(e.collapsed)return f(new a(e.startContainer,e.startOffset),!0);var t=f(new a(e.startContainer,e.startOffset),!0),n=f(new a(e.endContainer,e.endOffset),!1),i=l(s.getRangeDocument(e)).createTextRange();return i.setEndPoint("StartToStart",t),i.setEndPoint("EndToEnd",n),i},e.WrappedTextRange=i,!e.features.implementsDomRange||e.config.preferTextRange){var m=function(){return this}();void 0===m.Range&&(m.Range=i),e.createNativeRange=function(e){return e=c(e,t,"createNativeRange"),l(e).createTextRange()},e.WrappedRange=i}}e.createRange=function(n){return n=c(n,t,"createRange"),new e.WrappedRange(e.createNativeRange(n))},e.createRangyRange=function(e){return e=c(e,t,"createRangyRange"),new s(e)},e.createIframeRange=function(n){return t.deprecationNotice("createIframeRange()","createRange(iframeEl)"),e.createRange(n)},e.createIframeRangyRange=function(n){return t.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),e.createRangyRange(n)},e.addCreateMissingNativeApiListener(function(t){var n=t.document;void 0===n.createRange&&(n.createRange=function(){return e.createRange(n)}),n=t=null})}),i.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(e,t){function n(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function i(e,n){if(e){if(T.isWindow(e))return e;if(e instanceof g)return e.win;var i=T.getContentDocument(e,t,n);return T.getWindow(i)}return window}function r(e){return i(e,"getDocSelection").document.selection}function o(e){var t=!1;return e.anchorNode&&(t=1==T.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}function a(e,t,n){var i=n?"end":"start",r=n?"start":"end";e.anchorNode=t[i+"Container"],e.anchorOffset=t[i+"Offset"],e.focusNode=t[r+"Container"],e.focusOffset=t[r+"Offset"]}function s(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function l(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function c(t){var n;return t instanceof _?((n=e.createNativeRange(t.getDocument())).setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof M?n=t.nativeRange:A.implementsDomRange&&t instanceof T.getWindow(t.startContainer).Range&&(n=t),n}function d(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;t<n;++t)if(!T.isAncestorOf(e[0],e[t]))return!1;return!0}function u(e){var n=e.getNodes();if(!d(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function h(e){return!!e&&void 0!==e.text}function p(e,t){var n=new M(t);e._ranges=[n],a(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function f(t){if(t._ranges.length=0,"None"==t.docSelection.type)l(t);else{var n=t.docSelection.createRange();if(h(n))p(t,n);else{t.rangeCount=n.length;for(var i,r=R(n.item(0)),o=0;o<t.rangeCount;++o)(i=e.createRange(r)).selectNode(n.item(o)),t._ranges.push(i);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,a(t,t._ranges[t.rangeCount-1],!1)}}}function m(e,n){for(var i=e.docSelection.createRange(),r=u(n),o=R(i.item(0)),a=I(o).createControlRange(),s=0,l=i.length;s<l;++s)a.add(i.item(s));try{a.add(r)}catch(e){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}newControlrange.select(n.isBackward),f(e)}function g(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function v(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}function y(e,t){for(var n,i,r=J.length;r--;)if(n=J[r],i=n.selection,"deleteAll"==t)v(i);else if(n.win==e)return"delete"==t?(J.splice(r,1),!0):i;return"deleteAll"==t&&(J.length=0),null}function b(e,n){for(var i,r=R(n[0].startContainer),o=I(r).createControlRange(),a=0,s=n.length;a<s;++a){i=u(n[a]);try{o.add(i)}catch(e){throw t.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}controlrange.select(range.isBackward),f(e)}function w(e,t){if(e.win.document!=R(t))throw new N("WRONG_DOCUMENT_ERR")}function x(t){return function(n,i){var r;this.rangeCount?(r=this.getRangeAt(0))["set"+(t?"Start":"End")](n,i):(r=e.createRange(this.win.document)).setStartAndEnd(n,i),this.setSingleRange(r,this.isBackward())}}function C(e){var t=[],n=new L(e.anchorNode,e.anchorOffset),i=new L(e.focusNode,e.focusOffset),r="function"==typeof e.getName?e.getName():"Selection";if(void 0!==e.rangeCount)for(var o=0,a=e.rangeCount;o<a;++o)t[o]=_.inspect(e.getRangeAt(o));return"["+r+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}e.config.checkSelectionRanges=!0;var k,S,T=e.dom,E=e.util,F=E.isHostMethod,_=e.DomRange,M=e.WrappedRange,N=e.DOMException,L=T.DomPosition,A=e.features,R=T.getDocument,I=T.getBody,P=_.rangesEqual,O=F(window,"getSelection"),D=E.isHostObject(document,"selection");A.implementsWinGetSelection=O,A.implementsDocSelection=D;var B=D&&(!O||e.config.preferTextRange);B?(k=r,e.isSelectionValid=function(e){var t=i(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||R(n.createRange().parentElement())==t}):O?(k=function(e){return i(e,"getWinSelection").getSelection()},e.isSelectionValid=function(){return!0}):t.fail("Neither document.selection or window.getSelection() detected."),e.getNativeSelection=k;var j=k(),H=e.createNativeRange(document),$=I(document),U=E.areHostProperties(j,["anchorNode","focusNode","anchorOffset","focusOffset"]);A.selectionHasAnchorAndFocus=U;var q=F(j,"extend");A.selectionHasExtend=q;var W="number"==typeof j.rangeCount;A.selectionHasRangeCount=W;var z=q?function(t,n){var i=_.getRangeDocument(n),r=e.createRange(i);r.collapseToPoint(n.endContainer,n.endOffset),t.addRange(c(r)),t.extend(n.startContainer,n.startOffset)}:null;E.areHostMethods(j,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof j.rangeCount&&A.implementsDomRange&&function(){var t=window.getSelection();if(t){for(var n=t.rangeCount,i=[],r=o(t),a=0;a<n;++a)i[a]=t.getRangeAt(a);for(a=0;a<n;++a)0==a&&r?z?z(t,i[a]):(e.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(i[a])):t.addRange(i[a])}}(),A.selectionSupportsMultipleRanges=!1,A.collapsedNonEditableSelectionsSupported=!0;var V,K=!1;$&&F($,"createControlRange")&&(V=$.createControlRange(),E.areHostProperties(V,["item","add"])&&(K=!0)),A.implementsControlRange=K,S=U?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return!!e.rangeCount&&e.getRangeAt(e.rangeCount-1).collapsed};var Y;F(j,"getRangeAt")?Y=function(e,t){try{return e.getRangeAt(t)}catch(e){return null}}:U&&(Y=function(t){var n=R(t.anchorNode),i=e.createRange(n);return i.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),i.collapsed!==this.isCollapsed&&i.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),i}),g.prototype=e.selectionPrototype;var J=[],G=function(e){if(e&&e instanceof g)return e.refresh(),e;var t=y(e=i(e,"getNativeSelection")),n=k(e),o=D?r(e):null;return t?(t.nativeSelection=n,t.docSelection=o,t.refresh()):(t=new g(n,o,e),J.push({win:e,selection:t})),t};e.getSelection=G,e.getIframeSelection=function(n){return t.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),e.getSelection(T.getIframeWindow(n))};var Q=g.prototype;if(!B&&U&&E.areHostMethods(j,["removeAllRanges","addRange"])){Q.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),l(this)};var X=function(e,t){z(e.nativeSelection,t),e.refresh()};Q.addRange=W?function(t,i){if(K&&D&&"Control"==this.docSelection.type)m(this,t);else if(n(i)&&q)X(this,t);else{var r;if(this.removeAllRanges(),r=0,this.nativeSelection.addRange(c(t).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==r+1){if(e.config.checkSelectionRanges){var o=Y(this.nativeSelection,this.rangeCount-1);o&&!P(o,t)&&(t=new M(o))}this._ranges[this.rangeCount-1]=t,a(this,t,te(this.nativeSelection)),this.isCollapsed=S(this)}else this.refresh()}}:function(e,t){n(t)&&q?X(this,e):(this.nativeSelection.addRange(c(e)),this.refresh())},Q.setRanges=function(e){if(K&&e.length>1)b(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;t<n;++t)this.addRange(e[t])}}}else{if(!(F(j,"empty")&&F(H,"select")&&K&&B))return t.fail("No means of selecting a Range or TextRange was found"),!1;Q.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=R(this.anchorNode);else if("Control"==this.docSelection.type){var t=this.docSelection.createRange();t.length&&(e=R(t.item(0)))}if(e){I(e).createTextRange();textrange.select(range.isBackward),this.docSelection.empty()}}}catch(e){}l(this)},Q.addRange=function(t){"Control"==this.docSelection.type?m(this,t):(e.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,a(this,t,!1))},Q.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?b(this,e):t&&this.addRange(e[0])}}Q.getRangeAt=function(e){if(e<0||e>=this.rangeCount)throw new N("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var Z;if(B)Z=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=I(t.win.document).createTextRange()).collapse(!0),"Control"==t.docSelection.type?f(t):h(n)?p(t,n):l(t)};else if(F(j,"getRangeAt")&&"number"==typeof j.rangeCount)Z=function(t){if(K&&D&&"Control"==t.docSelection.type)f(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var n=0,i=t.rangeCount;n<i;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));a(t,t._ranges[t.rangeCount-1],te(t.nativeSelection)),t.isCollapsed=S(t)}else l(t)};else{if(!U||"boolean"!=typeof j.isCollapsed||"boolean"!=typeof H.collapsed||!A.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;Z=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=Y(n,0),e._ranges=[t],e.rangeCount=1,s(e),e.isCollapsed=S(e)):l(e)}}Q.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,i=this.anchorOffset;if(Z(this),e){var r=t.length;if(r!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=i)return!0;for(;r--;)if(!P(t[r],this._ranges[r]))return!0;return!1}};var ee=function(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var i=0,r=n.length;i<r;++i)P(t,n[i])||e.addRange(n[i]);e.rangeCount||l(e)};Q.removeRange=K?function(e){if("Control"==this.docSelection.type){for(var t=this.docSelection.createRange(),n=u(e),i=R(t.item(0)),r=I(i).createControlRange(),o=!1,a=0,s=t.length;a<s;++a)t.item(a)!==n||o?r.add(t.item(a)):o=!0;newControlrange.select(e.isBackward),f(this)}else ee(this,e)}:function(e){ee(this,e)};var te;!B&&U&&A.implementsDomRange?(te=o,Q.isBackward=function(){return te(this)}):te=Q.isBackward=function(){return!1},Q.isBackwards=Q.isBackward,Q.toString=function(){for(var e=[],t=0,n=this.rangeCount;t<n;++t)e[t]=""+this._ranges[t];return e.join("")},Q.collapse=function(t,n){w(this,t);var i=e.createRange(t);i.collapseToPoint(t,n),this.setSingleRange(i),this.isCollapsed=!0},Q.collapseToStart=function(){if(!this.rangeCount)throw new N("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},Q.collapseToEnd=function(){if(!this.rangeCount)throw new N("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},Q.selectAllChildren=function(t){w(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.setSingleRange(n)},Q.deleteFromDocument=function(){if(K&&D&&"Control"==this.docSelection.type){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),e.parentNode.removeChild(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var i=0,r=n.length;i<r;++i)n[i].deleteContents();this.addRange(n[r-1])}}},Q.eachRange=function(e,t){for(var n=0,i=this._ranges.length;n<i;++n)if(e(this.getRangeAt(n)))return t},Q.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},Q.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},Q.callMethodOnEachRange=function(e,t){var n=[];return this.eachRange(function(i){n.push(i[e].apply(i,t))}),n},Q.setStart=x(!0),Q.setEnd=x(!1),e.rangePrototype.select=function(e){G(this.getDocument()).setSingleRange(this,e)},Q.changeEachRange=function(e){var t=[],n=this.isBackward();this.eachRange(function(n){e(n),t.push(n)}),this.removeAllRanges(),n&&1==t.length?this.addRange(t[0],"backward"):this.setRanges(t)},Q.containsNode=function(e,t){return this.eachRange(function(n){return n.containsNode(e,t)},!0)},Q.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},Q.moveToBookmark=function(t){for(var n,i,r=[],o=0;n=t.rangeBookmarks[o++];)(i=e.createRange(this.win)).moveToBookmark(n),r.push(i);t.backward?this.setSingleRange(r[0],"backward"):this.setRanges(r)},Q.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},Q.getName=function(){return"WrappedSelection"},Q.inspect=function(){return C(this)},Q.detach=function(){y(this.win,"delete"),v(this)},g.detachAll=function(){y(null,"deleteAll")},g.inspect=C,g.isDirectionBackward=n,e.Selection=g,e.selectionPrototype=Q,e.addCreateMissingNativeApiListener(function(e){void 0===e.getSelection&&(e.getSelection=function(){return G(e)}),e=null})}),n.exports=i}),define("app/editor/Fences",["codemirror/lib/codemirror","app/document/StringUtils","jquery/jquery","exoskeleton-master/exoskeleton","autoComplete","app/document/Node","app/editor/KeyMaster","app/editor/Diagram","app/editor/KeyMaster","codemirror/addon/selection/mark-selection","codemirror/addon/edit/closebrackets","codemirror/addon/edit/closetag","codemirror/addon/mode/overlay","codemirror/addon/lint/lint"],function(e,t,n){"use strict";function i(e){if(e)switch(e){case"javascript":case"text/javascript":case"js":return e="javascript";case"json":return e={name:"javascript",json:!0};case"text/typescript":case"typescript":case"ts":return e={name:"javascript",typescript:!0};case"clojure":return e;case"coffee":case"coffeescript":case"css":return e;case"less":return"text/x-less";case"scss":return e="text/x-scss";case"gfm":case"github flavored markdown":return e="gfm";case"markdown":case"xml":case"haskell":return e;case"htmlmixed":case"html":return e="htmlmixed";case"lua":return e;case"lisp":case"commonlisp":case"common lisp":return e="commonlisp";case"pascal":case"perl":return e;case"php+html":return"application/x-httpd-php";case"php":return"text/x-php";case"cython":return e="text/x-cython";case"python":return e="text/x-python";case"ruby":return e;case"shell":case"sh":case"bash":return e="shell";case"sql":case"sql lite":return e="text/x-sql";case"mssql":return e="text/x-mssql";case"mysql":return e="text/x-mysql";case"mariadb":return e="text/x-mariadb";case"cassandra":case"cql":return e="text/x-cassandra";case"plsql":return e="text/x-plsql";case"stex":case"tex":case"latex":return"text/x-stex";case"tiddlywiki":case"wiki":return e="tiddlywiki";case"vb":case"visual basic":case"basic":return e="vb";case"vbscript":case"velocity":return e;case"verilog":return e="text/x-verilog";case"xquery":case"yaml":case"go":case"groovy":case"nginx":return e;case"octave":case"matlab":return"text/x-octave";case"c":case"clike":return e="text/x-csrc";case"c++":case"cpp":case"cc":return e="text/x-c++src";case"obj-c":case"objc":case"objective c":case"objective-c":return e="text/x-objectivec";case"text/x-scala":case"scala":return e="text/x-scala";case"csharp":case"c#":return e="text/x-csharp";case"java":return e="text/x-java";case"squirrel":return e="text/x-squirrel";case"ceylon":return e="text/x-ceylon";case"kotlin":return e="text/x-kotlin";case"swift":return e="swift";case"r":case"rlang":case"r-lang":return e="text/x-rsrc";case"d":case"diff":case"erlang":case"http":case"jade":return e;case"rst":case"restructuredtext":return e="rst";case"rust":case"jinja2":return e;case"aspx":case"asp":case"asp.net":return e="application/x-aspx";case"jsp":return e="application/x-jsp";case"erb":return e="application/x-erb";case"ejs":case"embeddedjs":case"embedded javaScript":return e="application/x-ejs";case"powershell":return"application/x-powershell";case"dockerfile":return"text/x-dockerfile";case"jsx":case"react":return"text/jsx";case"vue.js":case"vue":case"vue-template":return"script/x-vue";case"nsis":return"text/x-nsis";case"mathematica":return"text/x-mathematica";case"tiki":case"tiki wiki":case"tiki-wiki":case"tikiwiki":return"tiki";case"properties":case"ini":return"text/x-properties";case"livescript":return"text/x-livescript";case"asm":case"assembly":case"nasm":case"gas":return"assembly";case"toml":return"text/x-toml";case"sequence":return"sequence";case"flow":return"flow";case"mermaid":return"mermaid";case"ocaml":return"text/x-ocaml";case"f#":case"fsharp":return"text/x-fsharp";case"elm":return"text/x-elm";case"pgp":case"pgp-keys":case"pgp-key":case"pgp-signature":case"asciiarmor":case"ascii-armor":case"ascii armor":return"application/pgp";case"spreadsheet":case"excel":return"text/x-spreadsheet";case"elixir":return"elixir";case"cmake":return"text/x-cmake";case"cypher":case"cypher-query":return"application/x-cypher-query";case"dart":return"dart";case"django":return"text/x-django";case"dtd":case"xml-dtd":case"xml dtd":return"application/xml-dtd";case"dylan":return"text/x-dylan";case"handlebars":return"text/x-handlebars-template";case"idl":return"text/x-idl";case"webidl":case"web-idl":case"web idl":return"text/x-webidl";case"yacas":return"text/x-yacas";case"mbox":return"application/mbox";case"vhdl":return"text/x-vhdl";case"julia":return"julia";case"haxe":return"text/x-haxe";case"hxml":return"text/x-hxml";case"fortran":return"text/x-fortran";case"protobuf":return"text/x-protobuf";case"makefile":return"text/x-makefile";case"tcl":return"text/x-tcl";case"scheme":return"text/x-scheme";case"twig":return"text/x-twig"}}var r=e("codemirror/lib/codemirror"),o=e("app/document/StringUtils"),a=e("jquery/jquery"),s=e("exoskeleton-master/exoskeleton"),l=e("autoComplete.js"),c=e("app/document/Node"),d=e("app/editor/KeyMaster"),u=e("app/editor/Diagram"),h=d.map;Node=c.Node;var p=r.prototype.focus;r.prototype.focus=function(){r.signal(this,"focus",this),p.apply(this)};e("codemirror/addon/selection/mark-selection"),e("codemirror/addon/edit/closebrackets"),e("codemirror/addon/edit/closetag"),e("codemirror/addon/mode/overlay"),e("codemirror/addon/lint/lint.js");var f=["js","javascript","java","json","typescript","clojure","coffeescript","css","less","scss","gfm","markdown","xml","haskell","html","lua","lisp","commonlisp","pascal","perl","php","php+HTML","python","cython","ruby","shell","sh","sql","sql lite","mssql","mysql","CQL","mariadb","cassandra","plsql","tiddlywiki","wiki","vb","basic","visual basic","vbscript","velocity","verilog","xquery","yaml","go","groovy","nginx","octave","c","clike","c++","cpp","objective-c","csharp","c#","squirrel","ceylon","kotlin","tex","latex","swift","scala","R","D","diff","erlang","http","jade","rst","rust","jinja2","reStructuredText","asp","jsp","erb","ejs","embeddedjs","powershell","dockerfile","jsx","react","vue","nsis","mathematica","tiki wiki","properties","ini","livescript","assembly","gas","toml","matlab","ocaml","F#","fsharp","elm","pgp","asciiarmor","spreadsheet","elixir","cmake","cypher","dart","django","dtd","xml-dtd","dylan","handlebars","idl","web-idl","yacas","mbox","vhdl","julia","haxe","hxml","fortran","protobuf","makefile","tcl","scheme","twig","bash"];!function(e){var t=e.commands.delLineLeft;e.commands.delLineLeft=function(n){try{return 0==n.getCursor().ch?e.commands.delCharBefore(n):t(n)}catch(e){}}}(r);var m=function(e,t){var n=[];return f.map(function(t){0==t.toLowerCase().indexOf(e.toLowerCase())&&n.push(t)}),n.sort(),n.length<4&&f.map(function(t){t.toLowerCase().indexOf(e.toLowerCase())>0&&n.push(t)}),t&&1==n.length&&n[0]==e?[]:n},g=function(e,t){var n=this,i=e.find("input.mode").change(function(){t.attr("lang",a(this).val(),n.editor,!1)}).keydown(function(e){var t=e.which||e.keyCode;"Enter"==h[t]&&a(this).trigger("change")}).focus(function(){File.isMac&&app.touchBar&&app.touchBar.setFencesOnSetLang(!0)});return l.enable(i[0],{hintsFetcher:function(e,t){t(m(e));var n=document.querySelector(".autoComplt-list");n&&(n.style.height="auto")},maxHintNum:5}),e};window.getCodeMirrorMode=function(e,t){var n=((e=(e=e?e.toLowerCase():"").replace(/^\s*\.*lang(uage)*-/g,"").replace(/[{}]/g,"").trim()).split(/\s+/)||[e])[0],r=i(e);return r||e==n||(r=i(n)),r||(t?null:e)};var v=s.Model.extend({initialize:function(e){var t=this;this.editor=e,this.queue={},this.cachedCharWidth,this.$container=a("#fences-auto-suggest"),this.editor.diagrams=new u(e),File.option.enableDiagram&&(f=f.concat(u.MODES)),a(document).on("losefocus",".md-fences",function(){var e=a(this),n=t.queue[e.attr("cid")];n&&(t.syncToNode(this.getAttribute("cid")),n.doc.setCursor(0,0,{scroll:!1}),e.find(".md-tooltip-hide").hide(),e[0].style.marginBottom="")}).on("mousedown",".autoComplt-list li",function(e){return a("input.mode:focus").val(this.textContent),!1}),this.lazyload(),this.editor.diagrams.lazyload()},showAutoSuggest:function(e,t){if(t.token===e)return!1;var n=m(e,!0),i="";if(t.type="fences",t.token=e,t.match=n,t.found=n.length,t.pageNo=0,t.pageCnt=Math.floor((n.length-1)/5+1),!t.found)return this.$container.hide(),!1;for(var r=0;r<n.length&&r<40;r++)r%5==0&&(i+=(r>0?"</ul>":"")+"<ul data-page='"+r/5+"' style='display:none'>"),i+="<li data-content='"+n[r]+"' > "+n[r]+"</span></li>";return i+="</ul>",this.$container.html(i),this.$container},clickEventHandled:function(e,t){var n,i,r;this.queue[t]||(r=window.scrollY,this.getCm(t),r-=window.scrollY,window.scrollBy(0,r),(n=document.elementFromPoint(e.clientX,e.clientY))&&(e.stopPropagation(),(i=document.createEvent("MouseEvents")).initMouseEvent("mousedown",!0,!0,n.ownerDocument.defaultView,1,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button),n.dispatchEvent(i)),this.editor.refocus(t))},getCm:function(e){if(this.queue[e]){if(a("[cid='"+e+"'] textarea").length)return this.queue[e];delete this.queue[e]}if(!this.queue[e])return this.addCodeBlock(e)},getValue:function(e){return this.queue[e]?this.queue[e].getValue():this.editor.findElemById(e).text()},addCodeBlock:function(e){function t(e){p.findElemById(e.cid);var t=p.getNode(e.cid),n=p.undo.UndoManager,i=n.makeEmptyCommand();t.get("before");f.beforeDeleteFences(e.cid),i.undo.push({type:"fences-pos",pos:e.getCursor(),id:e.cid}),n.append(i,p.UserOp.backToParagraph(p,t,!1)),p.undo.register(i)}function n(e,n){var i,o=n.which||n.keyCode,a=r.keyName(n),s=!n.metaKey&&!n.shiftKey&&!n.ctrlKey;if("Up"==r.keyNames[o]){if((i=e.getCursor())&&0==i.line){if(s)return p.selection.moveUpOrDown(!0,n),n.codemirrorIgnore;if(0==i.ch&&!n.shiftKey&&(File.isNode&&n.ctrlKey||File.isMac&&n.metaKey))return void(n.codemirrorIgnore=!0)}n.stopPropagation()}else if("Down"==r.keyNames[o]){if((i=e.getCursor())&&i.line>=e.lineCount()-1){if(s)return p.selection.moveUpOrDown(!1,n),n.codemirrorIgnore;if(i.ch==e.doc.getLine(i.line).length&&!n.shiftKey&&(File.isNode&&n.ctrlKey||File.isMac&&n.metaKey))return void(n.codemirrorIgnore=!0)}n.stopPropagation()}else if("Left"==r.keyNames[o]){if((i=e.doc.getCursor())&&!i.line&&!i.ch&&s)return p.selection.moveUpOrDown(!0,n),n.codemirrorIgnore;n.stopPropagation()}else if("Right"==r.keyNames[o]){if((i=e.doc.getCursor())&&i.line>=e.lineCount()-1&&i.ch>=e.doc.getLine(i.line).length&&s)return p.selection.moveUpOrDown(!1,n),n.codemirrorIgnore;n.stopPropagation()}else if("Backspace"==r.keyNames[o]){if((i=e.doc.getCursor())&&e.lineCount()<=1&&!i.line&&!i.ch&&!e.getSelection().length)return t(e),n.preventDefault(),n.codemirrorIgnore;n.stopPropagation()}else if("PageDown"==r.keyNames[o]){if(!(i=e.doc.getCursor(i))||e.doc.indexFromPos(i)>=e.doc.getValue().length)return e.execCommand("goDocEnd"),p.selection.moveUpOrDown(!1),void(n.codemirrorIgnore=!0)}else if("PageUp"==r.keyNames[o]&&(!(i=e.doc.getCursor())||0==i.line&&0==i.ch))return e.execCommand("goDocStart"),p.selection.moveUpOrDown(!0),void(n.codemirrorIgnore=!0);(r.keyMap.macDefault[a]||r.keyMap.pcDefault[a])&&n.stopPropagation()}function i(t){p.undo.completeSnap(!0),t.getWrapperElement().offsetHeight||t.refresh(),a(t.getTextArea()).closest(".md-fences").find(".md-tooltip-hide").show(),p.refocus(e.id),d(t),u.isDiagramType(t.options.mode)&&p.diagrams.startPreview(t.cid),File.isMac&&app.touchBar&&app.touchBar.setFencesOnSetLang(!1)}function o(e,t){}function s(e,t){if(e.focus(),""==e.getSelection()){r.posFromMouse(e,t);var n=e.findWordAt(r.posFromMouse(e,t));e.setSelection(n.head,n.anchor)}File.isNodeHtml&&File.contextMenu.show(t)}function l(e,t){p.brush.updateWordCount(),u.isDiagramType(e.options.mode)&&p.diagrams.updateDiagram(e.cid),t.length&&t[0].origin&&p.syncChange([{type:"sync",id:e.cid,cmChanges:t}])}function c(e,t){u.isDiagramType(e.options.mode)&&t.ranges.length&&t.ranges[0].anchor.line!=(e.getCursor()||{}).line&&p.diagrams.attachError(e)}function d(e,t){File.isTypeWriterMode&&File.option.scrollWithCursor&&p.selection.typeWriterScroll(a(e.display.wrapper).find(".CodeMirror-activeline")),p.brush.updateWordCountInSelection()}function h(e,t){File.isTypeWriterMode&&t.preventDefault()}var p=this.editor,f=this;if("string"==typeof e&&(e=this.editor.getNode(e)),!this.queue[e.id]&&e.get("type")==e.TYPE.fences){var m="<textarea id = 'for-fence-"+e.id+"' />",v=a("[cid = "+e.id+"]").removeClass("mock-cm");v.html(m),(m=a("#for-fence-"+e.id)[0]).value=e.safeGetStrAttr("text").replace(/\u200b```/gi,"```"),this.queue[e.id]=r.fromTextArea(m,{lineWrapping:!0,mode:getCodeMirrorMode(e.get("lang")),styleSelectedText:!0,maxHighlightLength:1/0,viewportMargin:1/0,styleActiveLine:!0,autoCloseBrackets:!File.option.noPairingMatch,autoCloseTags:!File.option.noPairingMatch,theme:" inner",lineNumbers:File.option.showLineNumbersForFence,resetSelectionOnContextMenu:!0,cursorScrollMargin:60,dragDrop:!1,indentUnit:e.safeGetStrAttr("lang").toLowerCase().indexOf("python")>-1?4:2},this.editor,e.id),e.get("history")&&this.queue[e.id].setHistory(e.get("history")),this.queue[e.id].off("keydown",n),this.queue[e.id].on("keydown",n),this.queue[e.id].off("focus",i),this.queue[e.id].on("focus",i),this.queue[e.id].off("mousedown",o),this.queue[e.id].on("mousedown",o),this.queue[e.id].off("changes",l),this.queue[e.id].on("changes",l),this.queue[e.id].off("scrollCursorIntoView",h),this.queue[e.id].on("scrollCursorIntoView",h),this.queue[e.id].off("cursorActivity",d),this.queue[e.id].on("cursorActivity",d),this.queue[e.id].off("contextmenu",s),this.queue[e.id].on("contextmenu",s),this.queue[e.id].off("beforeSelectionChange",c),this.queue[e.id].on("beforeSelectionChange",c),a("[cid = "+e.id+"] .CodeMirror").before("<div class= 'code-tooltip md-tooltip-hide' align='right'><input class='mode' type='text' value='"+(e.get("lang")?e.get("lang"):"").replace(/'/g,"&#39;")+"' placeholder='select a language'></div> ").find(".CodeMirror").attr("lang",(e.get("lang")||"").toLowerCase()),g.call(this,v,e)}return this.queue[e.id]},toggleFocusedComponent:function(){var e=document.activeElement,t=a(e).closest(".md-fences");if(t.length)if("INPUT"==e.tagName){var n=t.attr("cid"),i=this.getCm(n),r=i.getCursor();a("[cid = "+n+"] textarea").focus(),i.focus(),i.setCursor(r)}else t.find(".CodeMirror-focused").removeClass("CodeMirror-focused").end().find("input.mode").show().focus()},focus:function(e){this.editor.undo.completeSnap(!0);var t="string"==typeof e?e:e.id;this.editor;this.editor.findElemById(t).addClass("md-focus"),this.getCm(t),window.getSelection().removeAllRanges(),setTimeout(function(){a("[cid = "+t+"] textarea").focus()},50)},getFocused:function(){for(var e in this.queue)if(this.queue.hasOwnProperty(e)&&this.queue[e].hasFocus())return this.queue[e]},updateCodeNum:function(){for(var e in this.queue)this.editor.getNode(e)||delete this.queue[e]},syncToNode:function(e){var t,n;(t="string"==typeof e?this.editor.getNode(e):e)&&((n=this.getCm(t.id)).save(),t.set("history",n.doc.getHistory()),this.editor.findElemById(t.id).children().length?t.set("text",this.queue[t.id].getValue()):t.set("text",""))},refreshEditor:function(e,t){var n=this,i=0;for(var r in this.queue)this.editor.getNode(r)&&this.editor.findElemById(r).find(".CodeMirror").length?(t&&this.queue[r].refresh(),i++):(delete this.queue[r],Node.isType(this.editor.getNode(r),Node.TYPE.fences)&&this.addCodeBlock(r));var o=a("[mdtype='fences']").toArray(),s=this.editor,l=0;o.length!=i&&o.map(function(t){s.getNode(t.getAttribute("cid")).get("lang")?(l++,n.addCodeBlock(t.getAttribute("cid"))):(e||l<30)&&(n.addCodeBlock(t.getAttribute("cid")),l++)})},lazyload:function(){var t=this;e.async(window.debugMode?"codemirror/mode.js":File.isMac?"lib/codemirror/mode.min.js":"lib.asar/codemirror/mode.min.js",function(){t.modeLoaded=!0,t.refreshEditor()})},addToUndoManager:function(e){this.editor.undo.register({undo:[{type:"fences",cmd:"undo",id:e.cid}],redo:[{type:"fences",cmd:"redo",id:e.cid}]})},jumpCmEnd:function(e){var t=this.getCm(e),n=0,i=0;t&&(n=t.doc.lastLine(),i=t.doc.getLine(n).length,t.focus(),t.setCursor({line:n,ch:i}))},jumpCmBegin:function(e){var t=this.getCm(e);t.focus(),t.setCursor({line:0,ch:0})},beforeDeleteFences:function(e,t){var n,i;"string"==typeof e?(n=this.queue[e],i=this.editor.getNode(e)):(i=e,n=this.queue[i.id]),n&&(i.set("text",n.getValue()),i.set("history",n.doc.getHistory()),n.toTextArea(),n.doc.history=null,delete this.queue[i.id],t&&t.map(function(e){e&&(e.id==i.id&&e.json&&e.json.content&&e.json.content.type==i.TYPE.fences?(e.json.content.text=i.get("text"),e.json.content.history=i.get("history")):Array.isArray(e.json)&&e.json.map(function(e){e.id==i.id&&e.content.type==i.TYPE.fences&&(e.content.text=i.get("text"),e.content.history=i.get("history"))}))}))},deletionMonitor:function(e){var t=this;e.find("[mdtype='fences']").toArray().map(function(e){t.beforeDeleteFences(e.getAttribute("cid"))})},searchOn:function(e,t,n){this.searchStatus=this.searchStatus||{},this.searchStatus.overlay=this.searchStatus.overlay||{};var i=new RegExp("^"+o.escapeRegExp(t),n.caseSensitive?"":"i");this.searchStatus.overlay[e.cid||"source"]=function(e){return{token:function(t){return n.wholeWord&&t.pos&&/[a-z_\\u00C0-\\u024f]/.exec(t.string.substring(t.pos-1,t.pos))||!t.match(i)||n.wholeWord&&/[a-z_\\u00C0-\\u024f]/.exec(t.string.substr(t.pos,t.pos+1))?(t.next(),t.pos=t.string.toLowerCase().indexOf(e,t.pos),!~t.pos&&t.skipToEnd(),null):"search-hit"}}}(t),e.addOverlay(this.searchStatus.overlay[e.cid||"source"])},clearSearchOn:function(e){this.searchStatus&&e.removeOverlay(this.searchStatus.overlay[e.cid||"source"])},clearSearchAll:function(){if(this.editor.sourceView.inSourceMode)return this.searchStatus&&this.editor.sourceView.cm.removeOverlay(this.searchStatus.overlay.source),void(this.searchStatus=null);if(this.searchStatus&&this.searchStatus.overlay)for(var e in this.queue)this.queue.hasOwnProperty(e)&&this.searchStatus.overlay[e]&&this.queue[e].removeOverlay(this.searchStatus.overlay[e])}});n.exports=v,window.CodeMirror=r,window.Fences=v}),define("autoComplete",[],function(e,t,n){var i=e("jquery/jquery"),r=function(){var e={autoCompltListClass:"autoComplt-list",autoCompltHintClass:"autoComplt-hint",autoCompltHintSelectedClass:"autoComplt-hint-selected",maxHintNum:10,autoCompltDelay:100,listStatus:{attr:"data-listStatus",open:"open"},keyCode:{up:38,down:40,esc:27,enter:13,left:37,right:39},defaultStyles:{autoCompltList:{maxHeight:"none",border:"1px solid #aaa",padding:"0",margin:"0",zIndex:99,overflowX:"hidden",overflowY:"auto",display:"none",position:"absolute",backgroundColor:"#fff"},autoCompltHint:{height:"1.5em",padding:"2px 6px 2px 10px",margin:"6px 0",overflow:"hidden",listStyleType:"none",color:"#000",backgroundColor:"#fff",cursor:"default",fontSize:"1em"},autoCompltHintSelected:{color:"#fff",backgroundColor:"#3399ff"}},adjStyleAttrs:{autoCompltList:["border","maxHeight","backgroundColor"],autoCompltHint:["height","padding","margin","color","backgroundColor","fontSize"],autoCompltHintSelected:["color","backgroundColor"]}},t=function(e){return e=e||window.event,e.target=e.target||e.srcElement,e},n=function(e,t,n){e.addEventListener?e.addEventListener(t,n):e.attachEvent&&e.attachEvent("on"+t,n)},r=function(e,t,n){e.removeEventListener?e.removeEventListener(t,n):e.detachEvent&&e.detachEvent("on"+t,n)},o=function(e,t){var n=null;if(window.getComputedStyle)n=window.getComputedStyle(e)[t]||null;else if(e.currentStyle){n=e.currentStyle&&e.currentStyle[t];var i,r,o=e.style;null==n&&o&&o[t]&&(n=o[t]),i=o.left,(r=e.runtimeStyle&&e.runtimeStyle.left)&&(e.runtimeStyle.left=e.currentStyle.left),o.left="fontSize"===t?"1em":n,n=o.pixelLeft+"px",o.left=i,r&&(e.runtimeStyle.left=r)}return n},a={buildElem:function(e){var t=document.createElement("DIV");return t.innerHTML=e,t.firstChild.cloneNode(!0)},buildHint:function(t,n){return"string"==typeof t&&t?((t=this.buildElem('<li class="'+e.autoCompltHintClass+'">'+t+"</li>")).style.height=t.style.lineHeight=n.autoCompltHint.height,t.style.padding=n.autoCompltHint.padding,t.style.margin=n.autoCompltHint.margin,t.style.overflow=n.autoCompltHint.overflow,t.style.listStyleType=n.autoCompltHint.listStyleType,t.style.color=n.autoCompltHint.color,t.style.backgroundColor=n.autoCompltHint.backgroundColor,t.style.cursor=n.autoCompltHint.cursor,t.style.fontSize=n.autoCompltHint.fontSize,t):null},buildList:function(t){var n=this.buildElem('<ul class="'+e.autoCompltListClass+'"></ul>');return n.style.maxHeight=t.autoCompltList.maxHeight,n.style.border=t.autoCompltList.border,n.style.padding=t.autoCompltList.padding,n.style.margin=t.autoCompltList.margin,n.style.zIndex=t.autoCompltList.zIndex,n.style.overflowX=t.autoCompltList.overflowX,n.style.overflowY=t.autoCompltList.overflowY,n.style.display=t.autoCompltList.display,n.style.position=t.autoCompltList.position,n.style.backgroundColor=t.autoCompltList.backgroundColor,n}},s=function(t){this.uiElem=null,this.assocInput=t,this.mouseOnList=!1,this.pauseMouseoverSelection=!1,this.pauseMouseoutDeselection=!1,this.maxHintNum=e.maxHintNum,this.styles=JSON.parse(JSON.stringify(e.defaultStyles))};s.prototype.genList=function(){if(!this.uiElem){var e=this;this.uiElem=a.buildList(this.styles),n(this.uiElem,"mouseover",function(n){n=t(n),e.isHint(n.target)&&(e.select(n.target),e.autoScroll())}),n(this.uiElem,"mouseout",function(n){n=t(n),e.deselect()}),n(this.uiElem,"mousedown",function(t){e.mouseOnList=!0,"INPUT"!==e.assocInput.tagName&&e.getSelected()&&t.preventDefault()}),n(this.uiElem,"mouseup",function(n){n=t(n),e.isHint(n.target)&&(e.select(n.target),c(e.assocInput,e.getSelected().innerHTML),e.assocInput.autoComplt.close(),i(e.assocInput).trigger("change"))}),document.body.appendChild(this.uiElem)}},s.prototype.isHint=function(t){return!(!t||"object"!=typeof t||1!==t.nodeType)&&(" "+t.className+" ").indexOf(" "+e.autoCompltHintClass+" ")>=0},s.prototype.putHints=function(e){var t=0;if(e instanceof Array){var n,i,r=[];for(i=Math.min(e.length,this.maxHintNum),n=0;n<i;n++)r.push(a.buildHint(e[n],this.styles)),r[r.length-1]||r.pop();if(r.length>0){var o=document.createDocumentFragment();for(n=0,t=r.length;n<t;n++)o.appendChild(r[n]);this.clearHints(),this.genList(),this.uiElem.appendChild(o)}}return t},s.prototype.clearHints=function(){this.uiElem&&(this.uiElem.innerHTML="")},s.prototype.isOpen=function(){return!!this.uiElem&&this.uiElem.getAttribute(e.listStatus.attr)==e.listStatus.open},s.prototype.open=function(){var t;if(this.uiElem&&(t=this.uiElem.querySelectorAll("."+e.autoCompltHintClass))&&t.length){var n,i;for(i=this.assocInput.getBoundingClientRect(),this.uiElem.style.top=(document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop)+i.bottom+"px",this.uiElem.style.left=i.left+"px",i=i.right-i.left-parseFloat(o(this.uiElem,"borderLeftWidth"))-parseFloat(o(this.uiElem,"borderRightWidth")),this.uiElem.style.width=i+"px",n=0,i=0;n<t.length;n++)i+=parseFloat(o(t[n],"height"))+parseFloat(o(t[n],"paddingTop"))+parseFloat(o(t[n],"paddingBottom")),t[n+1]&&(i+=Math.max(parseFloat(o(t[n],"marginBottom")),parseFloat(o(t[n+1],"marginTop"))));i+=parseFloat(o(t[0],"marginTop"))+parseFloat(o(t[t.length-1],"marginBottom")),this.uiElem.style.height=i+1+"px",this.uiElem.setAttribute(e.listStatus.attr,e.listStatus.open),this.uiElem.style.display="block"}},s.prototype.close=function(){this.uiElem&&(this.mouseOnList=!1,this.uiElem.parentNode.removeChild(this.uiElem),this.uiElem=null,i(this.assocInput).trigger("change"))},s.prototype.autoScroll=function(){var e=this.getSelected();if(e){var t,n=0,i=0,r=e.clientHeight,a=parseFloat(o(e,"marginTop")),s=parseFloat(o(e,"marginBottom"));for(i=r+((t=e.previousSibling)?Math.max(a,s):a);t;)n+=r,n+=(t=t.previousSibling)?Math.max(a,s):a;(this.uiElem.clientHeight+this.uiElem.scrollTop-n<i||n-this.uiElem.scrollTop<i)&&(this.uiElem.scrollTop=n)}},s.prototype.select=function(t){if(this.uiElem){var n=null;if(this.isHint(t))n=t;else if("number"==typeof t&&(t>=0||-1===t)){var i=this.uiElem.querySelectorAll("."+e.autoCompltHintClass);i.length>0&&(n=i[n=-1===(n=+t)||n>i.length-1?i.length-1:n])}null!==n&&(this.deselect(),n.className+=" "+e.autoCompltHintSelectedClass,n.style.color=this.styles.autoCompltHintSelected.color,n.style.backgroundColor=this.styles.autoCompltHintSelected.backgroundColor)}},s.prototype.deselect=function(){if(this.uiElem){var t=this.getSelected();t&&(t.className=e.autoCompltHintClass,t.style.color=this.styles.autoCompltHint.color,t.style.backgroundColor=this.styles.autoCompltHint.backgroundColor)}},s.prototype.getSelected=function(){return this.uiElem?this.uiElem.querySelector("."+e.autoCompltHintSelectedClass)||null:null};var l=function(e){return"INPUT"==e.tagName?e.value:e.innerText},c=function(e,t){"INPUT"==e.tagName?e.value=t:e.innerText=t};return{enable:function(t,o){if(t&&1===t.nodeType&&!t.autoComplt){t.autoComplt={};var a=e.autoCompltDelay,d=!0,u="",h=null,p=new s(t),f=function(){if(l(this).length>0&&d&&"function"==typeof h&&u!==l(this)){var e={};e.call=function(){h.call(e.that,e.compltTarget,e.openHint)},e.that=t,e.compltTarget=u=l(this),e.openHint=function(n){if(e.compltTarget===u)if(p.putHints(n)){var r=i(t).offset();r.top+=t.offsetHeight+5,p.open(),i(p.uiElem).css("min-width",100),i(p.uiElem).offset(r)}else e.that.autoComplt.close()},setTimeout(e.call,a)}},m=function(){if(d){var e=p.getSelected();e?c(this,e.innerHTML):c(this,u)}},g=function(e){p.mouseOnList&&"INPUT"==t.tagName&&(t.focus(),p.mouseOnList=!1),t.autoComplt.close()},v=function(n){if(d)if("keydown"==n.type){if(n.keyCode===e.keyCode.enter)return n.preventDefault();if(p.isOpen()&&(n.keyCode===e.keyCode.up||n.keyCode===e.keyCode.down)){var r=p.getSelected();n.keyCode===e.keyCode.up?(n.preventDefault(),r?r.previousSibling?p.select(r.previousSibling):p.deselect():p.select(-1)):n.keyCode===e.keyCode.down&&(n.preventDefault(),r?r.nextSibling?p.select(r.nextSibling):p.deselect():p.select(0)),p.autoScroll(),m.call(t)}}else if("keyup"==n.type){var o=!1;switch(n.keyCode){case e.keyCode.up:case e.keyCode.down:n.preventDefault();break;case e.keyCode.left:case e.keyCode.right:break;case e.keyCode.esc:p.isOpen()&&(t.value=u,t.autoComplt.close());break;case e.keyCode.enter:p.isOpen()&&(m.call(t),t.autoComplt.close(),i(t).trigger("change"));break;default:o=!0}o&&f.call(t)}};return t.autoComplt.setHintsFetcher=function(e){return"function"==typeof e&&(h=e,!0)},t.autoComplt.config=function(e){if(e instanceof Object){var t,n={};return(t=Math.floor(e.delay))>0&&(a=n.delay=t),(t=Math.floor(e.maxHintNum))>0&&(p.maxHintNum=n.maxHintNum=t),n}return!1},t.autoComplt.setStyles=function(t,n){var i,r,o=!1;switch(t){case e.autoCompltListClass:i=p.styles.autoCompltList,r=e.adjStyleAttrs.autoCompltList;break;case e.autoCompltHintClass:i=p.styles.autoCompltHint,r=e.adjStyleAttrs.autoCompltHint;break;case e.autoCompltHintSelectedClass:i=p.styles.autoCompltHintSelected,r=e.adjStyleAttrs.autoCompltHintSelected}if(n instanceof Object&&i&&r)for(var a=0;a<r.length;a++)"string"!=typeof n[r[a]]&&"number"!=typeof n[r[a]]||(o||(o={}),o[r[a]]=i[r[a]]=n[r[a]]);return o},t.autoComplt.close=function(){u="",p.close()},t.autoComplt.enable=function(){d=!0},t.autoComplt.disable=function(){this.close(),d=!1},t.autoComplt.destroy=function(){r(t,"blur",g),r(t,"keyup",v),r(t,"keydown",v),this.close(),delete t.autoComplt},n(t,"blur",g),n(t,"keyup",v),n(t,"keydown",v),o instanceof Object&&(t.autoComplt.config(o),t.autoComplt.setHintsFetcher(o.hintsFetcher)),t}return null}}}();n.exports=r}),define("codemirror/addon/selection/mark-selection.js",[],function(e,t,n){"use strict";!function(e){function t(e){e.state.markedSelection&&e.operation(function(){a(e)})}function n(e){e.state.markedSelection&&e.state.markedSelection.length&&e.operation(function(){r(e)})}function i(e,t,n,i){if(0!=c(t,n))for(var r=e.state.markedSelection,o=e.state.markedSelectionStyle,a=t.line;;){var d=a==t.line?t:l(a,0),u=a+s,h=u>=n.line,p=h?n:l(u,0),f=e.markText(d,p,{className:o});if(null==i?r.push(f):r.splice(i++,0,f),h)break;a=u}}function r(e){for(var t=e.state.markedSelection,n=0;n<t.length;++n)t[n].clear();t.length=0}function o(e){r(e);for(var t=e.listSelections(),n=0;n<t.length;n++)i(e,t[n].from(),t[n].to())}function a(e){if(!e.somethingSelected())return r(e);if(e.listSelections().length>1)return o(e);var t=e.getCursor("start"),n=e.getCursor("end"),a=e.state.markedSelection;if(!a.length)return i(e,t,n);var l=a[0].find(),d=a[a.length-1].find();if(!l||!d||n.line-t.line<s||c(t,d.to)>=0||c(n,l.from)<=0)return o(e);for(;c(t,l.from)>0;)a.shift().clear(),l=a[0].find();for(c(t,l.from)<0&&(l.to.line-t.line<s?(a.shift().clear(),i(e,t,l.to,0)):i(e,t,l.from,0));c(n,d.to)<0;)a.pop().clear(),d=a[a.length-1].find();c(n,d.to)>0&&(n.line-d.from.line<s?(a.pop().clear(),i(e,d.from,n)):i(e,d.to,n))}e.defineOption("styleSelectedText",!1,function(i,a,s){var l=s&&s!=e.Init;a&&!l?(i.state.markedSelection=[],i.state.markedSelectionStyle="string"==typeof a?a:"CodeMirror-selectedtext",o(i),i.on("cursorActivity",t),i.on("change",n)):!a&&l&&(i.off("cursorActivity",t),i.off("change",n),r(i),i.state.markedSelection=i.state.markedSelectionStyle=null)});var s=8,l=e.Pos,c=e.cmpPos}(e("codemirror/lib/codemirror"))}),define("codemirror/addon/edit/closebrackets.js",[],function(e,t,n){!function(e){function t(e,t){return"pairs"==t&&"string"==typeof e?e:"object"==typeof e&&null!=e[t]?e[t]:c[t]}function n(e){var t=e.state.closeBrackets;return!t||t.override?t:e.getModeAt(e.getCursor()).closeBrackets||t}function i(t){var n=e.cmpPos(t.anchor,t.head)>0;return{anchor:new d(t.anchor.line,t.anchor.ch+(n?-1:1)),head:new d(t.head.line,t.head.ch+(n?1:-1))}}function r(r,a){var c=n(r);if(!c||r.getOption("disableInput"))return e.Pass;var u=t(c,"pairs"),h=u.indexOf(a);if(-1==h)return e.Pass;for(var p,f=t(c,"triples"),m=u.charAt(h+1)==a,g=r.listSelections(),v=h%2==0,y=0;y<g.length;y++){var b,w=g[y],x=w.head,C=r.getRange(x,d(x.line,x.ch+1));if(v&&!w.empty())b="surround";else if(!m&&v||C!=a)if(m&&x.ch>1&&f.indexOf(a)>=0&&r.getRange(d(x.line,x.ch-2),x)==a+a&&(x.ch<=2||r.getRange(d(x.line,x.ch-3),d(x.line,x.ch-2))!=a))b="addFour";else if(m){if(e.isWordChar(C)||!s(r,x,a))return e.Pass;b="both"}else{if(!v||r.getLine(x.line).length!=x.ch&&!o(C,u)&&!/\s/.test(C))return e.Pass;b="both"}else b=m&&l(r,x)?"both":f.indexOf(a)>=0&&r.getRange(x,d(x.line,x.ch+3))==a+a+a?"skipThree":"skip";if(p){if(p!=b)return e.Pass}else p=b}var k=h%2?u.charAt(h-1):a,S=h%2?a:u.charAt(h+1);r.operation(function(){if("skip"==p)r.execCommand("goCharRight");else if("skipThree"==p)for(t=0;t<3;t++)r.execCommand("goCharRight");else if("surround"==p){for(var e=r.getSelections(),t=0;t<e.length;t++)e[t]=k+e[t]+S;r.replaceSelections(e,"around"),e=r.listSelections().slice();for(t=0;t<e.length;t++)e[t]=i(e[t]);r.setSelections(e)}else"both"==p?(r.replaceSelection(k+S,null),r.triggerElectric(k+S),r.execCommand("goCharLeft")):"addFour"==p&&(r.replaceSelection(k+k+k+k,"before"),r.execCommand("goCharRight"))})}function o(e,t){var n=t.lastIndexOf(e);return n>-1&&n%2==1}function a(e,t){var n=e.getRange(d(t.line,t.ch-1),d(t.line,t.ch+1));return 2==n.length?n:null}function s(t,n,i){var r=t.getLine(n.line),o=t.getTokenAt(n);if(/\bstring2?\b/.test(o.type)||l(t,n))return!1;var a=new e.StringStream(r.slice(0,n.ch)+i+r.slice(n.ch),4);for(a.pos=a.start=o.start;;){var s=t.getMode().token(a,o.state);if(a.pos>=n.ch+1)return/\bstring2?\b/.test(s);a.start=a.pos}}function l(e,t){var n=e.getTokenAt(d(t.line,t.ch+1));return/\bstring/.test(n.type)&&n.start==t.ch}var c={pairs:"()[]{}''\"\"",triples:"",explode:"[]{}"},d=e.Pos;e.defineOption("autoCloseBrackets",!1,function(t,n,i){i&&i!=e.Init&&(t.removeKeyMap(h),t.state.closeBrackets=null),n&&(t.state.closeBrackets=n,t.addKeyMap(h))});for(var u=c.pairs+"`",h={Backspace:function(i){var r=n(i);if(!r||i.getOption("disableInput"))return e.Pass;for(var o=t(r,"pairs"),s=i.listSelections(),l=0;l<s.length;l++){if(!s[l].empty())return e.Pass;var c=a(i,s[l].head);if(!c||o.indexOf(c)%2!=0)return e.Pass}for(l=s.length-1;l>=0;l--){var u=s[l].head;i.replaceRange("",d(u.line,u.ch-1),d(u.line,u.ch+1),"+delete")}},Enter:function(i){var r=n(i),o=r&&t(r,"explode");if(!o||i.getOption("disableInput"))return e.Pass;for(var s=i.listSelections(),l=0;l<s.length;l++){if(!s[l].empty())return e.Pass;var c=a(i,s[l].head);if(!c||o.indexOf(c)%2!=0)return e.Pass}if(i.getModeAt(i.getCursor()).indent||i.getMode().indent)return i.operation(function(){i.replaceSelection("\n",null),i.execCommand("goCharLeft");for(var e=0;e<s.length;e++){var t=s[e].head.line;i.indentLine(t,null,!0),i.indentLine(t+1,null,!0)}}),e.Pass;i.operation(function(){i.replaceSelection("\n\n",null),i.execCommand("goCharLeft"),s=i.listSelections();for(var e=0;e<s.length;e++){var t=s[e].head.line;i.indentLine(t,null,!0),i.indentLine(t+1,null,!0),i.indentLine(t,"add",!0)}})}},p=0;p<u.length;p++)h["'"+u.charAt(p)+"'"]=function(e){return function(t){return r(t,e)}}(u.charAt(p))}(e("codemirror/lib/codemirror"))}),define("codemirror/addon/edit/closetag",["codemirror/lib/codemirror"],function(e,t,n){var i=e("codemirror/lib/codemirror");!function(){function e(e){if(e.getOption("disableInput"))return i.Pass;for(var t=e.listSelections(),n=[],l=0;l<t.length;l++){if(!t[l].empty())return i.Pass;var c=t[l].head,d=e.getTokenAt(c),u=i.innerMode(e.getMode(),d.state),h=u.state;if("xml"!=u.mode.name||!h.tagName)return i.Pass;var p=e.getOption("autoCloseTags"),f="html"==u.mode.configuration,m="object"==typeof p&&p.dontCloseTags||f&&a,g="object"==typeof p&&p.indentTags||f&&s,v=h.tagName;d.end>c.ch&&(v=v.slice(0,v.length-d.end+c.ch));var y=v.toLowerCase();if(!v||"string"==d.type&&(d.end!=c.ch||!/[\"\']/.test(d.string.charAt(d.string.length-1))||1==d.string.length)||"tag"==d.type&&"closeTag"==h.type||d.string.indexOf("/")==d.string.length-1||m&&r(m,y)>-1||o(e,v,c,h,!0))return i.Pass;var b=g&&r(g,y)>-1;n[l]={indent:b,text:">"+(b?"\n\n":"")+"</"+v+">",newPos:b?i.Pos(c.line+1,0):i.Pos(c.line,c.ch+1)}}for(l=t.length-1;l>=0;l--){var w=n[l];e.replaceRange(w.text,t[l].head,t[l].anchor,"+insert");var x=e.listSelections().slice(0);x[l]={head:w.newPos,anchor:w.newPos},e.setSelections(x),w.indent&&(e.indentLine(w.newPos.line,null,!0),e.indentLine(w.newPos.line+1,null,!0))}}function t(e,t){for(var n=e.listSelections(),r=[],a=t?"/":"</",s=0;s<n.length;s++){if(!n[s].empty())return i.Pass;var l=n[s].head,c=e.getTokenAt(l),d=i.innerMode(e.getMode(),c.state),u=d.state;if(t&&("string"==c.type||"<"!=c.string.charAt(0)||c.start!=l.ch-1))return i.Pass;var h;if("xml"!=d.mode.name)if("htmlmixed"==e.getMode().name&&"javascript"==d.mode.name)h=a+"script";else{if("htmlmixed"!=e.getMode().name||"css"!=d.mode.name)return i.Pass;h=a+"style"}else{if(!u.context||!u.context.tagName||o(e,u.context.tagName,l,u))return i.Pass;h=a+u.context.tagName}">"!=e.getLine(l.line).charAt(c.end)&&(h+=">"),r[s]=h}e.replaceSelections(r),n=e.listSelections();for(s=0;s<n.length;s++)(s==n.length-1||n[s].head.line<n[s+1].head.line)&&e.indentLine(n[s].head.line)}function n(e){return e.getOption("disableInput")?i.Pass:t(e,!0)}function r(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,i=e.length;n<i;++n)if(e[n]==t)return n;return-1}function o(e,t,n,r,o){if(!i.scanForClosingTag)return!1;var a=Math.min(e.lastLine()+1,n.line+500),s=i.scanForClosingTag(e,n,null,a);if(!s||s.tag!=t)return!1;for(var l=r.context,c=o?1:0;l&&l.tagName==t;l=l.prev)++c;n=s.to;for(var d=1;d<c;d++){var u=i.scanForClosingTag(e,n,null,a);if(!u||u.tag!=t)return!1;n=u.to}return!0}i.defineOption("autoCloseTags",!1,function(t,r,o){if(o!=i.Init&&o&&t.removeKeyMap("autoCloseTags"),r){var a={name:"autoCloseTags"};("object"!=typeof r||r.whenClosing)&&(a["'/'"]=function(e){return n(e)}),("object"!=typeof r||r.whenOpening)&&(a["'>'"]=function(t){return e(t)}),t.addKeyMap(a)}});var a=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],s=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];i.commands.closeTag=function(e){return t(e)}}()}),define("codemirror/addon/mode/overlay",[],function(e,t,n){"use strict";var i=e("codemirror/lib/codemirror");i.overlayMode=function(e,t,n){return{startState:function(){return{base:i.startState(e),overlay:i.startState(t),basePos:0,baseCur:null,overlayPos:0,overlayCur:null,streamSeen:null}},copyState:function(n){return{base:i.copyState(e,n.base),overlay:i.copyState(t,n.overlay),basePos:n.basePos,baseCur:null,overlayPos:n.overlayPos,overlayCur:null}},token:function(i,r){return(i!=r.streamSeen||Math.min(r.basePos,r.overlayPos)<i.start)&&(r.streamSeen=i,r.basePos=r.overlayPos=i.start),i.start==r.basePos&&(r.base.lineBefore=r.lineBefore,r.base.lineAfter=r.lineAfter,r.baseCur=e.token(i,r.base),r.basePos=i.pos),i.start==r.overlayPos&&(i.pos=i.start,r.overlayCur=t.token(i,r.overlay),r.overlayPos=i.pos),i.pos=Math.min(r.basePos,r.overlayPos),null==r.overlayCur?r.baseCur:null!=r.baseCur&&r.overlay.combineTokens||n&&null==r.overlay.combineTokens?r.baseCur+" "+r.overlayCur:r.overlayCur},indent:e.indent&&function(t,n){return e.indent(t.base,n)},electricChars:e.electricChars,innerMode:function(t){return{state:t.base,mode:e}},blankLine:function(i){var r,o;return e.blankLine&&(r=e.blankLine(i.base)),t.blankLine&&(o=t.blankLine(i.overlay)),null==o?r:n&&null!=r?r+" "+o:o}}}}),define("codemirror/addon/lint/lint",[],function(e,t,n){function i(e,t){function n(e){if(!i.parentNode)return w.off(document,"mousemove",n);i.style.top=Math.max(0,e.clientY-i.offsetHeight-5)+"px",i.style.left=e.clientX+5+"px"}var i=document.createElement("div");return i.className="CodeMirror-lint-tooltip",i.appendChild(t.cloneNode(!0)),document.body.appendChild(i),w.on(document,"mousemove",n),n(e),null!=i.style.opacity&&(i.style.opacity=1),i}function r(e){e.parentNode&&e.parentNode.removeChild(e)}function o(e){e.parentNode&&(null==e.style.opacity&&r(e),e.style.opacity=0,setTimeout(function(){r(e)},600))}function a(e,t,n){function r(){w.off(n,"mouseout",r),a&&(o(a),a=null)}var a=i(e,t),s=setInterval(function(){if(a)for(var e=n;;e=e.parentNode){if(e&&11==e.nodeType&&(e=e.host),e==document.body)return;if(!e){r();break}}if(!a)return clearInterval(s)},400);w.on(n,"mouseout",r)}function s(e,t,n){this.marked=[],this.options=t,this.timeout=null,this.hasGutter=n,this.onMouseOver=function(t){b(e,t)},this.waitingFor=0}function l(e,t){return t instanceof Function?{getAnnotations:t}:(t&&!0!==t||(t={}),t)}function c(e){var t=e.state.lint;t.hasGutter&&e.clearGutter(x);for(var n=0;n<t.marked.length;++n)t.marked[n].clear();t.marked.length=0}function d(e,t,n,i){var r=document.createElement("div"),o=r;return r.className="CodeMirror-lint-marker-"+t,n&&((o=r.appendChild(document.createElement("div"))).className="CodeMirror-lint-marker-multiple"),0!=i&&w.on(o,"mouseover",function(t){a(t,e,o)}),r}function u(e,t){return"error"==e?e:t}function h(e){for(var t=[],n=0;n<e.length;++n){var i=e[n],r=i.from.line;(t[r]||(t[r]=[])).push(i)}return t}function p(e){var t=e.severity;t||(t="error");var n=document.createElement("div");return n.className="CodeMirror-lint-message-"+t,n.appendChild(document.createTextNode(e.message)),n}function f(e,t,n){function i(){o=-1,e.off("change",i)}var r=e.state.lint,o=++r.waitingFor;e.on("change",i),t(e.getValue(),function(t,n){e.off("change",i),r.waitingFor==o&&(n&&t instanceof w&&(t=n),g(e,t))},n,e)}function m(e){var t=e.state.lint.options,n=t.options||t,i=t.getAnnotations||e.getHelper(w.Pos(0,0),"lint");if(i)if(t.async||i.async)f(e,i,n);else{var r=i(e.getValue(),n,e);if(!r)return;r.then?r.then(function(t){g(e,t)}):g(e,r)}}function g(e,t){c(e);for(var n=e.state.lint,i=n.options,r=h(t),o=0;o<r.length;++o){var a=r[o];if(a){for(var s=null,l=n.hasGutter&&document.createDocumentFragment(),f=0;f<a.length;++f){var m=a[f],g=m.severity;g||(g="error"),s=u(s,g),i.formatAnnotation&&(m=i.formatAnnotation(m)),n.hasGutter&&l.appendChild(p(m)),m.to&&n.marked.push(e.markText(m.from,m.to,{className:"CodeMirror-lint-mark-"+g,__annotation:m}))}n.hasGutter&&e.setGutterMarker(o,x,d(l,s,a.length>1,n.options.tooltips))}}i.onUpdateLinting&&i.onUpdateLinting(t,r,e)}function v(e){var t=e.state.lint;t&&(clearTimeout(t.timeout),t.timeout=setTimeout(function(){m(e)},t.options.delay||500))}function y(e,t){for(var n=t.target||t.srcElement,i=document.createDocumentFragment(),r=0;r<e.length;r++){var o=e[r];i.appendChild(p(o))}a(t,i,n)}function b(e,t){var n=t.target||t.srcElement;if(/\bCodeMirror-lint-mark-/.test(n.className)){for(var i=n.getBoundingClientRect(),r=(i.left+i.right)/2,o=(i.top+i.bottom)/2,a=e.findMarksAt(e.coordsChar({left:r,top:o},"client")),s=[],l=0;l<a.length;++l){var c=a[l].__annotation;c&&s.push(c)}s.length&&y(s,t)}}var w=e("codemirror/lib/codemirror"),x="CodeMirror-lint-markers";w.defineOption("lint",!1,function(e,t,n){if(n&&n!=w.Init&&(c(e),!1!==e.state.lint.options.lintOnChange&&e.off("change",v),w.off(e.getWrapperElement(),"mouseover",e.state.lint.onMouseOver),clearTimeout(e.state.lint.timeout),delete e.state.lint),t){for(var i=e.getOption("gutters"),r=!1,o=0;o<i.length;++o)i[o]==x&&(r=!0);var a=e.state.lint=new s(e,l(0,t),r);!1!==a.options.lintOnChange&&e.on("change",v),0!=a.options.tooltips&&"gutter"!=a.options.tooltips&&w.on(e.getWrapperElement(),"mouseover",a.onMouseOver),m(e)}}),w.defineExtension("performLint",function(){this.state.lint&&m(this)}),w.clearMarks=c,w.updateLinting=g}),define("app/editor/MathBlock",["codemirror/lib/codemirror","jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","codemirror/addon/display/placeholder","codemirror/mode/stex/stex","app/editor/UndoManager","app/editor/KeyMaster"],function(e,t,n){"use strict";function i(){MathJax.Hub.config.TeX.equationNumbers?MathJax.Hub.config.TeX.equationNumbers.autoNumber="all":MathJax.Hub.config.TeX.equationNumbers={autoNumber:"all",useLabelIds:!0}}function r(){var e=[],t=[];MathJax.Hub.Register.MessageHook("Begin Attach MathJax",function(n){x()&&(e=Object.keys(s.labels).clone(),t=Object.keys(s.eqlabels).clone())}),MathJax.Hub.Register.MessageHook("End Attach MathJax",function(n){var i=[],r=[],o=c(n[1]),a=(o.closest(".md-inline-math"),o.closest("[mdtype='math_block']"));if(x()&&a.length){var l=File.editor.findNodeByElem(a);for(var d in s.labels)-1==e.indexOf(d)&&i.push(d);for(var u in s.eqlabels)-1==t.indexOf(u)&&r.push(u);l.set("mathLabel",i),l.set("mathEqLabel",r)}})}function o(){if(v)return!0;File.option.autoNumberingForMath&&i(),r(),v=!0}function a(e){(e.get("mathLabel")||[]).map(function(e){delete s.labels[e]}),(e.get("mathEqLabel")||[]).map(function(e){delete s.eqlabels[e]})}var s,l=e("codemirror/lib/codemirror"),c=e("jquery/jquery"),d=e("exoskeleton-master/exoskeleton"),u=e("app/document/Node"),h=u.Node,p=(e("codemirror/addon/display/placeholder"),e("codemirror/mode/stex/stex"),e("app/editor/UndoManager"),e("app/document/StringUtils")),f=e("app/editor/KeyMaster"),m=u.TYPE,g=f.map,v=!1,y=d.Model.extend({initialize:function(e){this.editor=e,this.queue={},this.preview,this.bindEvent()},bindEvent:function(){var e=this,t=this.editor;c(this.editor.sessionStr).on("click","[cid].mathjax-block",function(t){if(1==t.which)return e.startEditing(c(this)),!1}).on("click mousedown",".jax-trigger-delete-button",function(t){e.remove(c(this).closest("[cid]"))}).on("click",".jax-trigger-finish-button",function(n){e.stopEditing(e.currentCm.cid,!0),t.refocus(null)}).on("losefocus",".md-mathjax-panel",function(t){e.stopEditing(this.getAttribute("cid"))}).on("keydown",".mathjax-block",function(t){var n=event.keyCode||event.which;if("Enter"===g[n])return e.startEditing(c(this)),t.stopPropagation(),t.preventDefault()})},renderAll:function(){o(),C.Init();for(var e=document.querySelectorAll(".mathjax-block"),t=0;t<e.length;t++){var n=e[t],i=n.querySelector("script");if(!i||!i.MathJax){if(File.option.autoNumberingForMath)return void this.forceRefresh();var r=this.editor.getNode(n.getAttribute("cid"));MathJax.Hub.Queue(["BeforeRender",C,r],["Typeset",MathJax.Hub,n.getAttribute("id")],["AfterRender",C,r])}}},getTex:function(e){return this.editor.findElemById(e).find("script").text()},getCidAndElem:function(e){var t=e,n=e;return"string"==typeof e?n=this.editor.findElemById(t):t=n.attr("cid"),[t,n]},syncToNode:function(e){var t="string"==typeof e?this.editor.getNode(e):e;return(this.currentCm||{}).cid===t.cid&&(t.set("history",this.currentCm.doc.getHistory()),t.set("text",this.currentCm.getValue())),t},remove:function(e){var t,n=this.getCidAndElem(e),i=n[0],r=n[1],o=editor.getNode(i),a=editor.undo.UndoManager,s=a.makeEmptyCommand(),l=(o.get("before"),this.currentCm);this.editor.undo.completeSnap(!0),this.beforeDeleteFences(o),l&&l.cid===o.cid?s.undo.push({type:"fences-pos",pos:l.getCursor(),id:l.cid}):s.undo.push(this.editor.selection.buildUndo()),s.undo.push(a.buildReplaceUndo(o)),o.set("type",o.TYPE.paragraph),o.set("text",""),h.normalizeNode(o),s.redo.push(a.buildReplaceUndo(o)),t=c(c.parseHTML(o.toHTML())[0]),r.replaceWith(t),editor.selection.jumpIntoElemEnd(t),s.redo.push(editor.selection.buildUndo()),editor.undo.register(s),this.currentCm=void 0,this.renderAll()},deletionMonitor:function(e){var t=this;e.find(".md-mathjax-panel[cid]").toArray().map(function(e){t.currentCm.cid===e.getAttribute("cid")&&this.beforeDeleteFences(e.getAttribute("cid"))})},beforeDeleteFences:function(e,t){var n=this.syncToNode(e);this.currentCm=void 0;var i=this.editor.findElemById(e);(i=i&&i.find("script")[0])&&i.MathJax&&File.option.autoNumberingForMath?b.call(this):x()&&a(n),t&&t.map(function(e){e&&(e.id==n.id&&e.json&&e.json.content&&e.json.content.type==n.TYPE.math_block?(e.json.content.text=n.get("text"),e.json.content.history=n.get("history")):Array.isArray(e.json)&&e.json.map(function(e){e.id==n.id&&e.content.type==n.TYPE.math_block&&(e.content.text=n.get("text"),e.content.history=n.get("history"))}))})},stopEditing:function(e,t){if(e=e||(this.currentCm||{}).cid){var n=this.getCidAndElem(e),i=n[0],r=n[1],o=r[0].querySelectorAll(".mathjax-candidate"),a="hidden"===o[0].style.visibility?o[1]:o[0],l=this.syncToNode(i),d=this;if(a.className="mathjax-block",a.setAttribute("cid",i),a.setAttribute("mdtype","math_block"),a.setAttribute("id","math-jax"+i),r.replaceWith(c(a)),t){var u=l.getVeryFirstBrotherIncludeTopBlock(!1);u?(this.editor.selection.jumpIntoElemBegin(this.editor.findElemById(u.id)),this.editor.refocus()):window.getSelection().removeAllRanges()}this.currentCm=void 0,File.option.autoNumberingForMath&&C.isDirty?(C.Init(),this.forceRefresh()):(a.querySelector("script").MathJax=void 0,MathJax.Hub.Queue(["BeforeRender",C,l],["Typeset",MathJax.Hub,a.getAttribute("id")],["AfterRender",C,l]),MathJax.Hub.Queue(function(){void 0!==d.startNumber&&(s.startNumber=Math.max(d.startNumber,s.startNumber),s.number=s.startNumber,d.startNumber=void 0,C.Init())}))}},startEditing:function(e,t,n){if(n){var i=this;return this.forceRefresh(),void MathJax.Hub.Queue(function(){i.startEditing(e,t)})}var r=this.getCidAndElem(e),o=r[0],a=r[1],s=(this.editor,this.editor.getNode(o));if(o)if(this.currentCm&&this.currentCm.cid===o)this.currentCm.focus();else{this.currentCm&&(this.stopEditing(this.currentCm.cid),window.getSelection().removeAllRanges(),this.editor.refocus(null)),function(){if(File.option.autoNumberingForMath){var e=this.editor.findElemById(s.id).find("script")[0];C.startNumber=this.startNumber=void 0,e&&e.MathJax&&void 0!==e.MathJax.startNumber&&(this.startNumber=x().startNumber,C.startNumber=e.MathJax.startNumber,e.MathJax=void 0),void 0==C.startNumber&&File.option.autoNumberingForMath&&(C.startNumber=(x()||{}).startNumber||0)}}.call(this);var d=c(document.querySelector("#md-mathjax-panel-templ").textContent).attr("cid",o).attr("mdtype",m.math_block);d.children(".code-tooltip-p").removeClass("code-tooltip-p").addClass("code-tooltip"),a.replaceWith(d),this.currentCm=function(e){var t=l(d[0].querySelector(".md-mathjax-input"),{styleSelectedText:!0,styleActiveLine:!0,lineWrapping:!0,mode:"stex",placeholder:c.localize.getString("Input Math TeX here"),theme:" inner",autoCloseBrackets:!File.option.noPairingMatch,autoCloseTags:!File.option.noPairingMatch,value:s.get("text").trim(),lineNumbers:File.option.showLineNumbersForFence,resetSelectionOnContextMenu:!0,dragDrop:!1},e,o);return s.get("history")&&t.setHistory(s.get("history")),t.doc.on("change",function(n){C.getTextFunc&&C.Update(),e.syncChange([{type:"sync",id:s.id,tex:t.getValue()}])}),t.on("blur",function(e){try{s.set("history",e.doc.getHistory()),s.set("text",e.getValue())}catch(e){console.warn(e.stack)}}),t.on("focus",function(t){e.undo.completeSnap(!0),e.refocus(s.id)}),t.on("keydown",function(t,n){var i,r=n.which||n.keyCode,o=l.keyName(n);if(!n.metaKey&&!n.shiftKey&&n.ctrlKey,"Up"==l.keyNames[r])return e.selection.moveUpOrDown(!0,n),n.codemirrorIgnore;if("Down"==l.keyNames[r])return e.selection.moveUpOrDown(!1,n),n.codemirrorIgnore;if("Backspace"==l.keyNames[r]){if(!t.getValue().length)return e.mathBlock.remove(t.cid),n.preventDefault(),n.codemirrorIgnore}else{if("Enter"==l.keyNames[r]&&(n.ctrlKey||n.metaKey))return setTimeout(function(){e.UserOp.insertParagraph()},20),n.stopPropagation(),n.codemirrorIgnore;if("PageDown"==l.keyNames[r]){if(!(i=t.doc.getCursor(i))||t.doc.indexFromPos(i)>=t.doc.getValue().length)return t.execCommand("goDocEnd"),e.selection.moveUpOrDown(!1),void(n.codemirrorIgnore=!0)}else if("PageUp"==l.keyNames[r]&&(!(i=t.doc.getCursor())||0==i.line&&0==i.ch))return t.execCommand("goDocStart"),e.selection.moveUpOrDown(!0),void(n.codemirrorIgnore=!0)}(l.keyMap.macDefault[o]||l.keyMap.pcDefault[o])&&n.stopPropagation()}),e.refocus(s.id),t.focus(),t}(this.editor),function(e,t,n,i){var r=e.querySelector(".CodeMirror").CodeMirror,o=e.querySelector(".md-mathjax-preview");o.textContent="$$\n"+r.getValue()+"\n$$",C.Init(o,e.querySelector(".md-mathjax-buffer"),function(){return"$$\n"+(t.doc.getValue().trim()||"<Empty \\space Math \\space Block>")+"\n$$"},n),C.startNumber=i,MathJax.Hub.Queue(["BeforeRender",C,n,!1],["Typeset",MathJax.Hub,o]),C.Update()}(d[0],this.currentCm,s,C.startNumber),function(e){e.focus(),"<Empty \\space Math \\space Block>"==e.getValue()?e.execCommand("selectAll"):e.execCommand("goDocEnd")}(this.currentCm)}return this.currentCm},copyAsTex:function(e){var t=c(e||document.activeElement).closest("[cid]").find("script")[0].textContent.trim();this.editor.UserOp.setClipboard(null,null,t,!0)},copyAsMathML:function(e){var t=MathJax.Hub.getAllJax(c(e||document.activeElement).closest("[cid]")[0])[0],n=this.editor;w(t,function(e){n.UserOp.setClipboard("<pre class='md-fences' lang='xml'>"+p.escape(e)+"</pre>",null,e,!0)})},copyAsImage:function(e){var t=(e&&e.querySelector||document.activeElement).querySelector("svg"),n=this.editor,i=n.EditHelper.SVG2HtmlImg(t);n.UserOp.setClipboard(i,null,i,!0)},forceRefresh:function(){File.editor.sourceView.inSourceMode||(this.currentCm&&(this.stopEditing(this.currentCm.cid),window.getSelection().removeAllRanges(),this.editor.refocus(null)),o(),window.svgCache={},this.editor.brush.clearAndPause(),b.call(this),File.option.enableInlineMath?MathJax.Hub.Queue(["Typeset",MathJax.Hub,document.querySelector("#write")]):c(".mathjax-block").each(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub,this])}),this.editor.mathInline.renderAll(!0),MathJax.Hub.Queue(function(){this.editor.brush.resume()}))}}),b=function(){this.currentCm&&(self.stopEditing(self.currentCm.cid),window.getSelection().removeAllRanges(),this.editor.refocus(null));for(var e=document.querySelectorAll("script"),t=0;t<e.length;t++)e[t].MathJax&&(e[t].MathJax=void 0);x()&&(s.labels=s.eqlabels=s.IDs=s.eqIDs={},s.refs=[],this.startNumber=s.number=s.startNumber=0,C.Init())},w=function(e,t){var n;try{n=e.root.toMathML("")}catch(n){if(!n.restart)throw n;return MathJax.Callback.After([w,e,t],n.restart)}MathJax.Callback(t)(n)},x=function(){return s=MathJax.Extension["TeX/AMSmath"]},C={delay:0,preview:null,buffer:null,timeout:null,mjRunning:!1,oldText:null,maxIgnored:3,curIgnored:0,startNumber:void 0,originalEnd:void 0,isDirty:!1,Init:function(e,t,n,i){this.preview=e,this.buffer=t,this.getTextFunc=n,this.node=i,this.originalEnd=void 0,this.isDirty=!1,this.startNumber=void 0},SwapBuffers:function(){var e=this.preview,t=this.buffer;this.buffer=e,this.preview=t,e.style.visibility="hidden",e.style.position="absolute",t.style.position="",t.style.visibility=""},Update:function(){this.callback()},CreatePreview:function(){if(this.curIgnored=0,C.timeout=null,!this.mjRunning){var e=this.getTextFunc();e!==this.oldtext&&(this.buffer.textContent=this.oldtext=e,this.mjRunning=!0,MathJax.Hub.Queue(["BeforeRender",this,this.node,!1],["Typeset",MathJax.Hub,this.buffer],["AfterRender",this,this.node],["PreviewDone",this,this.node]))}},PreviewDone:function(){this.mjRunning=!1,this.SwapBuffers()},BeforeRender:function(e,t){x()&&(t?(e.unset("mathLabel"),e.unset("mathEqLabel")):a(e),void 0!==this.startNumber&&(s.startNumber=s.number=this.startNumber))},AfterRender:function(e){File.option.autoNumberingForMath&&x()&&(this.isDirty||(void 0===this.originalEnd?this.originalEnd=s.startNumber:this.isDirty=this.originalEnd!==s.startNumber))}};C.callback=MathJax.Callback(["CreatePreview",C]),C.callback.autoReset=!0,y.Preview=C,n.exports=y}),define("codemirror/addon/display/placeholder",[],function(e,t,n){function i(e){e.state.placeholder&&(e.state.placeholder.parentNode.removeChild(e.state.placeholder),e.state.placeholder=null)}function r(e){i(e);var t=e.state.placeholder=document.createElement("pre");t.style.cssText="height: 0; overflow: visible",t.className="CodeMirror-placeholder";var n=e.getOption("placeholder");"string"==typeof n&&(n=document.createTextNode(n)),t.appendChild(n),e.display.lineSpace.insertBefore(t,e.display.lineSpace.firstChild)}function o(e){s(e)&&r(e)}function a(e){var t=e.getWrapperElement(),n=s(e);t.className=t.className.replace(" CodeMirror-empty","")+(n?" CodeMirror-empty":""),n?r(e):i(e)}function s(e){return 1===e.lineCount()&&""===e.getLine(0)}var l=e("codemirror/lib/codemirror");l.defineOption("placeholder","",function(e,t,n){var r=n&&n!=l.Init;if(t&&!r)e.on("blur",o),e.on("change",a),e.on("swapDoc",a),a(e);else if(!t&&r){e.off("blur",o),e.off("change",a),e.off("swapDoc",a),i(e);var s=e.getWrapperElement();s.className=s.className.replace(" CodeMirror-empty","")}t&&!e.hasFocus()&&o(e)})}),define("codemirror/mode/stex/stex",[],function(e,t,n){var i=e("codemirror/lib/codemirror");i.defineMode("stex",function(){"use strict";function e(e,t){e.cmdState.push(t)}function t(e){return e.cmdState.length>0?e.cmdState[e.cmdState.length-1]:null}function n(e){var t=e.cmdState.pop();t&&t.closeBracket()}function i(e){for(var t=e.cmdState,n=t.length-1;n>=0;n--){var i=t[n];if("DEFAULT"!=i.name)return i}return{styleIdentifier:function(){return null}}}function r(e,t,n){return function(){this.name=e,this.bracketNo=0,this.style=t,this.styles=n,this.argument=null,this.styleIdentifier=function(){return this.styles[this.bracketNo-1]||null},this.openBracket=function(){return this.bracketNo++,"bracket"},this.closeBracket=function(){}}}function o(e,t){e.f=t}function a(n,r){var a;if(n.match(/^\\[a-zA-Z@]+/)){var d=n.current().slice(1);return a=c[d]||c.DEFAULT,a=new a,e(r,a),o(r,l),a.style}if(n.match(/^\\[$&%#{}_]/))return"tag";if(n.match(/^\\[,;!\/\\]/))return"tag";if(n.match("\\["))return o(r,function(e,t){return s(e,t,"\\]")}),"keyword";if(n.match("$$"))return o(r,function(e,t){return s(e,t,"$$")}),"keyword";if(n.match("$"))return o(r,function(e,t){return s(e,t,"$")}),"keyword";var u=n.next();return"%"==u?(n.skipToEnd(),"comment"):"}"==u||"]"==u?(a=t(r))?(a.closeBracket(u),o(r,l),"bracket"):"error":"{"==u||"["==u?(a=c.DEFAULT,a=new a,e(r,a),"bracket"):/\d/.test(u)?(n.eatWhile(/[\w.%]/),"atom"):(n.eatWhile(/[\w\-_]/),"begin"==(a=i(r)).name&&(a.argument=n.current()),a.styleIdentifier())}function s(e,t,n){if(e.eatSpace())return null;if(e.match(n))return o(t,a),"keyword";if(e.match(/^\\[a-zA-Z@]+/))return"tag";if(e.match(/^[a-zA-Z]+/))return"variable-2";if(e.match(/^\\[$&%#{}_]/))return"tag";if(e.match(/^\\[,;!\/]/))return"tag";if(e.match(/^[\^_&]/))return"tag";if(e.match(/^[+\-<>|=,\/@!*:;'"`~#?]/))return null;if(e.match(/^(\d+\.\d*|\d*\.\d+|\d+)/))return"number";var i=e.next();return"{"==i||"}"==i||"["==i||"]"==i||"("==i||")"==i?"bracket":"%"==i?(e.skipToEnd(),"comment"):"error"}function l(e,i){var r=e.peek();return"{"==r||"["==r?(t(i).openBracket(r),e.eat(r),o(i,a),"bracket"):/[ \t\r]/.test(r)?(e.eat(r),null):(o(i,a),n(i),a(e,i))}var c={};return c.importmodule=r("importmodule","tag",["string","builtin"]),c.documentclass=r("documentclass","tag",["","atom"]),c.usepackage=r("usepackage","tag",["atom"]),c.begin=r("begin","tag",["atom"]),c.end=r("end","tag",["atom"]),c.DEFAULT=function(){this.name="DEFAULT",this.style="tag",this.styleIdentifier=this.openBracket=this.closeBracket=function(){}},{startState:function(){return{cmdState:[],f:a}},copyState:function(e){return{cmdState:e.cmdState.slice(),f:e.f}},token:function(e,t){return t.f(e,t)},blankLine:function(e){e.f=a,e.cmdState.length=0},lineComment:"%"}}),i.defineMIME("text/x-stex","stex"),i.defineMIME("text/x-latex","stex")}),define("app/editor/MathInline",["jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/editor/UndoManager","app/editor/KeyMaster","app/editor/EditHelper","app/editor/KeyMaster","rangy/rangy-core","rangy/rangy-classapplier"],function(e,t,n){"use strict";var i=e("jquery/jquery"),r=e("exoskeleton-master/exoskeleton"),o=(e("app/document/Node").Node,e("app/editor/UndoManager"),e("app/editor/KeyMaster")),a=e("app/editor/EditHelper"),s=(o.map,e("app/document/StringUtils")),l=e("rangy/rangy-core.js");e("rangy/rangy-classapplier"),/Apple Computer/.test(navigator.vendor);window.svgCache={};var c=function(e){var t=i(e),n=t.textExcludeSVG().replace(/\u200B*/g,"");if(!/^\$+$/.exec(n))return MathJax.Hub.Queue(["Typeset",MathJax.Hub,e],function(){if(e.querySelector(".noError")&&e.querySelector("script").classList.add("math-jax-error"),!e.classList.contains("math-jax-postprocess")){var i=t.parent().attr("pattern")||"$",r=t.removeClass("math-jax-preprocess").addClass("math-jax-postprocess").before("<span class='md-before md-meta'>"+i+"</span>").after("<span class='md-math-after-sym'></span><span class='md-after md-meta'>"+i+"</span>")[0].innerHTML;/^\$/.exec(n)||(n=i+n+i),svgCache[n]=a.processExportedSVG(r)}}),!0},d=function(e,t,n,i){if(t.length){!i&&MathJax.Hub.Queue(function(){e.brush.pause()}),MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]);for(var r=0;r<t.length;r++)c(t[r]);n&&MathJax.Hub.Queue(function(){e.undo.exeCommand(n)}),!i&&MathJax.Hub.Queue(function(){e.brush.resume()})}},u=function(){var e=this.editor;i(this.editor.sessionStr).on("cursorChange",function(t){var n,r=t.cursor||e.selection.getRangy();if(!r)return f(e);(n=i(r.commonAncestorContainer).closest(".md-inline-math.md-expand")).length?p(e,n):f(e)}).on("mousedown",".md-inline-math svg",function(t){f(e),i(".md-expand").removeClass("md-expand");var n=i(this).closest(".md-inline-math"),r=n.addClass("md-expand").find("script");e.selection.selectAllElem(r),p(e,n)})},h=null,p=function(e,t){var n=i("#math-inline-preview"),r=i("#math-inline-preview-content"),o=t.clone().find("svg").remove().end().text();h=function(){var t=MathJax.Hub.getAllJax(r[0])[0],o=i(".md-inline-math.md-expand"),s=o.attr("pattern"),l=o.find("script"),c=(l.text()||o.find(".math-jax-preprocess").text()).replace(/\u200B*/g,""),d=h;if(t)return l.height()?void(svgCache[c]||MathJax.Hub.Queue(["Text",t,c.replace("$$"==s?/(^\$\$)|(\$\$$)/g:/(^\$)|(\$$)/g,"")],function(){a.fixPopoverPosition(l,n)})):i(e.sessionStr).off("inline-math-changed",d)},(n.hasClass("md-math-inline-prep-preview")||"none"===n[0].style.display)&&/^\$/.exec(o)&&(n.removeClass("md-math-inline-prep-preview"),MathJax.Hub.Queue(["setRenderer",MathJax.Hub,"SVG"]),r.text(o),MathJax.Hub.Queue(["Typeset",MathJax.Hub,r[0]],function(){n.show(),a.fixPopoverPosition(t.find("script"),n),i(e.sessionStr).on("inline-math-changed",h)}))},f=function(e){var t=i("#math-inline-preview");"none"!==t[0].style.display&&t.hide(),h&&(i(e.sessionStr).off("inline-math-changed",h),h=null)},m=function(){var e=this.editor.selection.getRangy();return i(e.commonAncestorContainer).closest(".md-inline-math")},g=function(e,t){var n;try{n=e.root.toMathML("")}catch(n){if(!n.restart)throw n;return MathJax.Callback.After([g,e,t],n.restart)}MathJax.Callback(t)(n)},v=r.Model.extend({initialize:function(e){this.editor=e,this.queue={},u.call(this),this.mathPrepApplier=l.createClassApplier("md-math-prep")},brushSpan:function(e){d.call(this,this.editor,[e],null,!0)},brush:function(e,t,n){var i=e.querySelectorAll(".math-jax-preprocess");return d.call(this,this.editor,i,t&&e.getAttribute("cid")===t.startId?t:null),i.length},showAutoSuggest:function(e){if(File.option.enableInlineMath){i(".md-math-prep").removeClass("md-math-prep"),this.mathPrepApplier.applyToRange(e);var t=i("#math-inline-preview").show().addClass("md-math-inline-prep-preview").css("width","auto");t.find("#math-inline-preview-content").text("<Empty Inline Math>"),a.fixPopoverPosition(i(".md-math-prep"),t)}},renderAll:function(e){e&&i(".math-jax-postprocess").parent().toArray().forEach(function(e){var t=e.getAttribute("pattern")||"$";e.innerHTML="<span class='inline-math-svg math-jax-preprocess'>"+t+s.escape(e.querySelector("script").textContent)+t+"</span></span>"});var t=document.querySelectorAll(".math-jax-preprocess");d.call(this,this.editor,t)},tryCloseInlinePreview:function(){f(this.editor)},copyAsTex:function(){var e=m.call(this),t=e.attr("pattern"),n=e.text().replace("$$"==t?/(^\$\$)|(\$\$$)/g:/(^\$)|(\$$)/g,"");this.editor.UserOp.setClipboard(null,null,n,!0)},copyAsMathML:function(){var e=i("#math-inline-preview-content")[0],t=MathJax.Hub.getAllJax(e)[0],n=this.editor;g(t,function(e){n.UserOp.setClipboard("<pre class='md-fences' lang='xml'>"+s.escape(e)+"</pre>",null,e,!0)})},copyAsImage:function(){var e=document.querySelector("#math-inline-preview-content svg"),t=this.editor,n=t.EditHelper.SVG2HtmlImg(e);t.UserOp.setClipboard(n,null,n,!0)}});n.exports=v}),define("rangy/rangy-classapplier",[],function(e,t,n){"use strict";!function(e){e.createModule("ClassApplier",["WrappedSelection"],function(e,t){function n(e,t){for(var n in e)if(e.hasOwnProperty(n)&&!1===t(n,e[n]))return!1;return!0}function i(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function r(e,t){return e.className&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e.className)}function o(e,t){e.className?r(e,t)||(e.className+=" "+t):e.className=t}function a(e){return e&&e.split(/\s+/).sort().join(" ")}function s(e){return a(e.className)}function l(e,t){return s(e)==s(t)}function c(e,t,n,i,r){var o=e.node,a=e.offset,s=o,l=a;o==i&&a>r&&++l,o!=t||a!=n&&a!=n+1||(s=i,l+=r-n),o==t&&a>n+1&&--l,e.node=s,e.offset=l}function d(e,t,n){e.node==t&&e.offset>n&&--e.offset}function u(e,t,n,i){-1==n&&(n=t.childNodes.length);for(var r,o=e.parentNode,a=A.getNodeIndex(e),s=0;r=i[s++];)c(r,o,a,t,n);t.childNodes.length==n?t.appendChild(e):t.insertBefore(e,t.childNodes[n])}function h(e,t){for(var n,i=e.parentNode,r=A.getNodeIndex(e),o=0;n=t[o++];)d(n,i,r);e.parentNode.removeChild(e)}function p(e,t,n,i,r){for(var o,a=[];o=e.firstChild;)u(o,t,n++,r),a.push(o);return i&&h(e,r),a}function f(e,t){return p(e,e.parentNode,A.getNodeIndex(e),!0,t)}function m(e,t){var n=e.cloneRange();n.selectNodeContents(t);var i=n.intersection(e);return""!=(i?i.toString():"")}function g(e){for(var t,n=e.getNodes([3]),i=0;(t=n[i])&&!m(e,t);)++i;for(var r=n.length-1;(t=n[r])&&!m(e,t);)--r;return n.slice(i,r+1)}function v(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,i,r,o=0,a=e.attributes.length;o<a;++o)if(n=e.attributes[o],"class"!=(r=n.name)){if(i=t.attributes.getNamedItem(r),null===n!=(null===i))return!1;if(n.specified!=i.specified)return!1;if(n.specified&&n.nodeValue!==i.nodeValue)return!1}return!0}function y(e,t){for(var n,i=0,r=e.attributes.length;i<r;++i)if(n=e.attributes[i].name,(!t||!I(t,n))&&e.attributes[i].specified&&"class"!=n)return!0;return!1}function b(e,t){return n(t,function(t,n){if("object"==typeof n){if(!b(e[t],n))return!1}else if(e[t]!==n)return!1})}function w(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||B(e)&&!B(e.parentNode))}function x(e){return(B(e)||1!=e.nodeType&&B(e.parentNode))&&!w(e)}function C(e){return e&&1==e.nodeType&&!j.test(D(e,"display"))}function k(e){if(0==e.data.length)return!0;if(H.test(e.data))return!1;switch(D(e.parentNode,"whiteSpace")){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return C(e.previousSibling)||C(e.nextSibling)}function S(e){var t,n,i=[];for(t=0;n=e[t++];)i.push(new R(n.startContainer,n.startOffset),new R(n.endContainer,n.endOffset));return i}function T(e,t){for(var n,i,r,o=0,a=e.length;o<a;++o)n=e[o],i=t[2*o],r=t[2*o+1],n.setStartAndEnd(i.node,i.offset,r.node,r.offset)}function E(e,t){return A.isCharacterDataNode(e)?0==t?!!e.previousSibling:t!=e.length||!!e.nextSibling:t>0&&t<e.childNodes.length}function F(e,n,i,r){var o,a,s=0==i;if(A.isAncestorOf(n,e))return e;if(A.isCharacterDataNode(n)){var l=A.getNodeIndex(n);if(0==i)i=l;else{if(i!=n.length)throw t.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+i+" in "+n.data);i=l+1}n=n.parentNode}if(E(n,i)){o=n.cloneNode(!1),a=n.parentNode,o.id&&o.removeAttribute("id");for(var c,d=0;c=n.childNodes[i];)u(c,o,d++,r);return u(o,a,A.getNodeIndex(n)+1,r),n==e?o:F(e,a,A.getNodeIndex(o),r)}if(e!=n){o=n.parentNode;var h=A.getNodeIndex(n);return s||h++,F(e,o,h,r)}return e}function _(e,t){return e.namespaceURI==t.namespaceURI&&e.tagName.toLowerCase()==t.tagName.toLowerCase()&&l(e,t)&&v(e,t)&&"inline"==D(e,"display")&&"inline"==D(t,"display")}function M(e){var t=e?"nextSibling":"previousSibling";return function(n,i){var r=n.parentNode,o=n[t];if(o){if(o&&3==o.nodeType)return o}else if(i&&(o=r[t])&&1==o.nodeType&&_(r,o)){var a=o[e?"firstChild":"lastChild"];if(a&&3==a.nodeType)return a}return null}}function N(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}function L(e,t,r){var o,a,s,l,c=this;c.cssClass=c.className=e;var d=null,u={};if("object"==typeof t&&null!==t){for(r=t.tagNames,d=t.elementProperties,u=t.elementAttributes,a=0;l=q[a++];)t.hasOwnProperty(l)&&(c[l]=t[l]);o=t.normalize}else o=t;c.normalize=void 0===o||o,c.attrExceptions=[];var h=document.createElement(c.elementTagName);c.elementProperties=c.copyPropertiesToElement(d,h,!0),n(u,function(e){c.attrExceptions.push(e)}),c.elementAttributes=u,c.elementSortedClassName=c.elementProperties.hasOwnProperty("className")?c.elementProperties.className:e,c.applyToAnyTagName=!1;var p=typeof r;if("string"==p)"*"==r?c.applyToAnyTagName=!0:c.tagNames=i(r.toLowerCase()).split(/\s*,\s*/);else if("object"==p&&"number"==typeof r.length)for(c.tagNames=[],a=0,s=r.length;a<s;++a)"*"==r[a]?c.applyToAnyTagName=!0:c.tagNames.push(r[a].toLowerCase());else c.tagNames=[c.elementTagName]}var A=e.dom,R=A.DomPosition,I=A.arrayContains,P=A.isHtmlNamespace,O=function(){function e(e,t,n){return t&&n?" ":""}return function(t,n){t.className&&(t.className=t.className.replace(new RegExp("(^|\\s)"+n+"(\\s|$)"),e))}}(),D=A.getComputedStyleProperty,B="boolean"==typeof document.createElement("div").isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return!(!e||1!=e.nodeType||"false"==e.contentEditable)&&("true"==e.contentEditable||B(e.parentNode))},j=/^inline(-block|-table)?$/i,H=/[^\r\n\t\f \u200B]/,$=M(!1),U=M(!0);N.prototype={doMerge:function(e){var t=this.textNodes,n=t[0];if(t.length>1){for(var i,r,o,a,s=A.getNodeIndex(n),l=[],c=0,d=0,u=t.length;d<u;++d){if(i=t[d],r=i.parentNode,d>0&&(r.removeChild(i),r.hasChildNodes()||r.parentNode.removeChild(r),e))for(o=0;a=e[o++];)a.node==i&&(a.node=n,a.offset+=c),a.node==r&&a.offset>s&&(--a.offset,a.offset==s+1&&d<u-1&&(a.node=n,a.offset=c));l[d]=i.data,c+=i.data.length}n.data=l.join("")}return n.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){for(var e=[],t=0,n=this.textNodes.length;t<n;++t)e[t]="'"+this.textNodes[t].data+"'";return"[Merge("+e.join(",")+")]"}};var q=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],W={};L.prototype={elementTagName:"span",elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(e,t,n){var i,r,s,l,c,d,u={};for(var h in e)if(e.hasOwnProperty(h))if(l=e[h],c=t[h],"className"==h)o(t,l),o(t,this.className),t[h]=a(t[h]),n&&(u[h]=t[h]);else if("style"==h){r=c,n&&(u[h]=s={});for(i in e[h])r[i]=l[i],n&&(s[i]=r[i]);this.attrExceptions.push(h)}else t[h]=l,n&&(u[h]=t[h],d=W.hasOwnProperty(h)?W[h]:h,this.attrExceptions.push(d));return n?u:""},copyAttributesToElement:function(e,t){for(var n in e)e.hasOwnProperty(n)&&t.setAttribute(n,e[n])},hasClass:function(e){return 1==e.nodeType&&I(this.tagNames,e.tagName.toLowerCase())&&r(e,this.className)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||x(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&k(e)},postApply:function(e,t,n,i){for(var r,o,a,s=e[0],l=e[e.length-1],c=[],d=s,u=l,h=0,p=l.length,f=0,m=e.length;f<m;++f)o=e[f],(a=$(o,!i))?(r||(r=new N(a),c.push(r)),r.textNodes.push(o),o===s&&(h=(d=r.textNodes[0]).length),o===l&&(u=r.textNodes[0],p=r.getLength())):r=null;var g=U(l,!i);if(g&&(r||(r=new N(l),c.push(r)),r.textNodes.push(g)),c.length){for(f=0,m=c.length;f<m;++f)c[f].doMerge(n);t.setStartAndEnd(d,h,u,p)}},createContainer:function(e){var t=e.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,t,!1),this.copyAttributesToElement(this.elementAttributes,t),o(t,this.className),this.onElementCreate&&this.onElementCreate(t,this),t},applyToTextNode:function(e,t){var n=e.parentNode;if(1==n.childNodes.length&&this.useExistingElements&&P(n)&&I(this.tagNames,n.tagName.toLowerCase())&&b(n,this.elementProperties))o(n,this.className);else{var i=this.createContainer(A.getDocument(e));e.parentNode.insertBefore(i,e),i.appendChild(e)}},isRemovable:function(e){return P(e)&&e.tagName.toLowerCase()==this.elementTagName&&s(e)==this.elementSortedClassName&&b(e,this.elementProperties)&&!y(e,this.attrExceptions)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){for(var t,n=this,i=e.getNodes([1],function(e){return n.isEmptyContainer(e)}),r=[e],o=S(r),a=0;t=i[a++];)h(t,o);T(r,o)},undoToTextNode:function(e,t,n,i){if(!t.containsNode(n)){var r=t.cloneRange();r.selectNode(n),r.isPointInRange(t.endContainer,t.endOffset)&&(F(n,t.endContainer,t.endOffset,i),t.setEndAfter(n)),r.isPointInRange(t.startContainer,t.startOffset)&&(n=F(n,t.startContainer,t.startOffset,i))}this.isRemovable(n)?f(n,i):O(n,this.className)},applyToRange:function(e,t){var n=S((t=t||[])||[]);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e);var i=g(e);if(i.length){for(var r,o=0;r=i[o++];)this.isIgnorableWhiteSpaceNode(r)||this.getSelfOrAncestorWithClass(r)||!this.isModifiable(r)||this.applyToTextNode(r,n);r=i[i.length-1],e.setStartAndEnd(i[0],0,r,r.length),this.normalize&&this.postApply(i,e,n,!1),T(t,n)}},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(t){var n=e.getSelection(t);n.setRanges(this.applyToRanges(n.getAllRanges()))},undoToRange:function(e,t){var n=S(t=t||[]);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e,n);var i,r,o=g(e),a=o[o.length-1];if(o.length){for(var s=0,l=o.length;s<l;++s)i=o[s],(r=this.getSelfOrAncestorWithClass(i))&&this.isModifiable(i)&&this.undoToTextNode(i,e,r,n),e.setStartAndEnd(o[0],0,a,a.length);this.normalize&&this.postApply(o,e,n,!0),T(t,n)}},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(t){var n=e.getSelection(t),i=e.getSelection(t).getAllRanges();this.undoToRanges(i),n.setRanges(i)},isAppliedToRange:function(e){if(e.collapsed||""==e.toString())return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);var t=e.getNodes([3]);if(t.length)for(var n,i=0;n=t[i++];)if(!this.isIgnorableWhiteSpaceNode(n)&&m(e,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(e){var t=e.length;if(0==t)return!1;for(;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(t){var n=e.getSelection(t);return this.isAppliedToRanges(n.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},getElementsWithClassIntersectingRange:function(e){var t=[],n=this;return e.getNodes([3],function(e){var i=n.getSelfOrAncestorWithClass(e);i&&!I(t,i)&&t.push(i)}),t},detach:function(){}},L.util={hasClass:r,addClass:o,removeClass:O,hasSameClasses:l,replaceWithOwnChildren:f,elementsHaveSameNonClassAttributes:v,elementHasNonClassAttributes:y,splitNodeAt:F,isEditableElement:B,isEditingHost:w,isEditable:x},e.CssClassApplier=e.ClassApplier=L,e.createCssClassApplier=e.createClassApplier=function(e,t,n){return new L(e,t,n)}})}(e("rangy/rangy-core"))}),define("app/editor/Brush",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/MarkParser","app/document/Node","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji","app/editor/Stylize","rangy/rangy-core","app/window/MenuHelper","app/editor/polyfill","app/editor/UndoManager","app/editor/EditHelper"],function(e,t,n){"use strict";function i(e){var t=e.parent().closest("[md-inline]");return t.length?i(t):e.closest("[md-inline]")}var r=e("exoskeleton-master/exoskeleton"),o=e("app/document/StringUtils"),a=e("app/document/MarkParser"),s=e("app/document/Node"),l=s.Node,c=s.TYPE,d=e("app/editor/Stylize"),u=e("app/editor/UndoManager"),h=u.SnapFlag,p=e("app/editor/EditHelper"),f=e("rangy/rangy-core.js"),m=function(e){this.editor=e,this.queue=[],this.interval=150,this.inline=new a.InlineLexer,this.articleArea=document.querySelector(this.editor.sessionStr),w.call(this)},g=null,v=null,y={},b=function(e,t){if(e||t){try{e.brush.pause(),v?e.focusCid=v.id||v.startId:e.refocus(void 0,void 0,!0),e.undo.completeSnap(!0);var n=g,i=f.createRange(),r=u.makeEmptyCommand(v||e.selection.buildUndo()),o=e.getNode(e.focusCid);if(r.undo.push(u.buildReplaceUndo(o)),i.moveToBookmark(n),e.selection.deRange(i),i.deleteContents(),i.insertNode(document.createTextNode(t)),n.start=n.start+=t.length,n.end=n.start,e.store(e.focusCid,!0),i.moveToBookmark(n),r.redo.push(u.buildReplaceUndo(o)),e.selection.setRange(i),r.redo.push(e.selection.buildUndo()),e.undo.register(r),"fences"==y.type){var a=o.breakOn(!1,e);e.findElemById(a.oldCid).replaceWith(a.newHtml),e.selection.jumpIntoElemBegin(e.findElemById(a.nextFocus)),e.undo.register(a.command)}else e.brush.addToQueue(e.focusCid,!0)}catch(e){console.error(e.stack)}e.brush.hideAutoComplete(),e.brush.resume(!0)}else e.brush.hideAutoComplete()},w=function(){var e=this.editor;$(document).click(function(t){document.activeElement!==e.brush.articleArea&&e.brush.hideAutoComplete()}),$(".auto-suggest-container").on("mousedown","li[data-content]",function(t){v=e.selection.buildUndo()}).on("click","li[data-content]",function(t){b(e,this.getAttribute("data-content"))})},x=function(e){if(!e||!e.length)return!1;var t=window.getSelection().getRangeAt(0).getClientRects()[0],n="none"==e[0].style.display,i=document.querySelector("content").getBoundingClientRect(),r=t.left-15;return n&&(r=r+200>window.innerWidth?window.innerWidth-200:r,e.css({top:t.bottom+(File.isMac&&app.shouldFixFontGlitch?$("content").scrollTop()-i.top:0),left:r}).show()),e.find("[data-page]").hide().filter("[data-page="+y.pageNo+"]").show(),!0};m.prototype={addToQueue:function(e,t){t=t||!1,o.isNullOrEmpty(e)||this.queue.push({cid:e,inlineOnly:t})},run:function(){var e=this;this.timerID||(this.timerID=window.setInterval(function(){e.brushQueue()},this.interval))},clearAndPause:function(){this.queue=[],this.pause()},pause:function(){clearInterval(this.timerID),this.timerID=null},resume:function(e){e&&this.brushQueue(),this.run()},restart:function(){this.queue=[],this.run()},updateWordCountInSelection:function(){this.updateWordCountInSelectionTimeout&&(clearTimeout(this.updateWordCountInSelectionTimeout),this.updateWordCountInSelectionTimeout=null);var e=this;this.updateWordCountInSelectionTimeout=setTimeout(function(){var t=e.editor.selection.getWordCountInSelection();File.isMac?t&&t<e.wordCount?app.window.updateWordCountInSelection(t):app.document.updateWordCount(e.wordCount):File.isNodeHtml&&window.requestAnimationFrame(function(){$("#footer-word-count").text((t&&t!=e.wordCount?t+"/"+e.wordCount:e.wordCount)+" "+$.localize.getString("Words","Panel"))})},50)},updateWordCount:function(){this.updateWordCountTimeout&&(clearTimeout(this.updateWordCountTimeout),this.updateWordCountTimeout=null);var e=this;setTimeout(function(){var t=$(e.articleArea).clone().find("[mdtype]").after("\n").find(".CodeMirror-gutter-wrapper").remove().end().filter(".md-toc").text("[toc]").end().filter(".mathjax-block").text(function(){return $(this).children("script").html()}).end().end().text();if(e.wordCount=p.getWordCount(t),File.isMac)app.document.updateWordCount(e.wordCount);else if(File.isNodeHtml){var n=e.wordCount;window.requestAnimationFrame(function(){$("#footer-word-count").text(n+" "+$.localize.getString("Words","Panel")),$("#footer-word-count-td").text(n)})}},10)},brushNode:function(e){var t=this.editor.selection.buildUndo();S.call(this,e,{},t,!1)&&this.editor.undo.exeCommand(t)},brushQueue:function(){var e=this,t={},n=e.queue.length;if(!this.editor.isIME&&!this.editor.isMousePressed){if(e.queue.length>0&&!File.isLocked){var i=e.editor.selection.buildUndo(),r=!1;e.queue.map(function(n){t[n.cid]||(r=S.call(e,n.cid,t,i,n.inlineOnly)||r,t[n.cid]=1)}),e.queue=[],r&&i&&e.editor.undo.exeCommand(i),this.expand(!0)}n&&(this.updateWordCount(),this.triggerAutoComplete())}},applyAutocompleteByKey:function(){v=null,b(this.editor,$(".auto-suggest-container:visible .active").attr("data-content"))},triggerAutoComplete:function(e){var t,n,i=null,r=this.editor.selection.getTextAround(),o=r[0],a=r[1],s=r[2],l=this.editor.getJQueryElem((this.editor.selection.getRangy()||{}).commonAncestorContainer),c=l.closest(".md-inline-math").length,d=e&&File.option.enableInlineMath,u=e||File.option.autoToggleEmojiAutoComplete||y.found&&"emoji"==y.type,p=this.editor.selection.getRangy();if(s&&p&&p.collapsed&&(o||a)){if(n=function(){if(p&&p.collapsed){var e=$(p.endContainer).closest(".md-lang"),t=e.text(),n=e.prev().text().length;if(t)return g={start:n,end:n+t.length,containerNode:e.closest("[mdtype]")[0]},t}}.call(this))return void x(this.editor.fences.showAutoSuggest(n,y));if(u&&(i=T.exec(o)))return void((t=/^(\w*:*)(\s|$)/.exec(a||""))&&(x(this.editor.emoji.showAutoSuggest(i[1]+t[1],y)),s.start-=i[1].length+1,s.end+=t[1].length,g=s));if(d&&(n=/\$?\$$/.exec(o))&&0==$(".md-expand.md-inline-math").length){var f,m=(/^\$+/.exec(a)||"").length;if(m<=n[0].length)return(f="$".repeat(n[0].length-m)).length&&(this.editor.undo.snap(editor.focusCid,h.REPLACE),p.insertNode(document.createTextNode(f)),p.collapse(!0)),this.editor.lastCursor=this.editor.selection.buildUndo(),s.start-=n[0].length,s.end+=n[0].length,p.moveToBookmark(s),this.editor.mathInline.showAutoSuggest(p),this.editor.restoreLastCursor(null,!0),void(g=null)}}else{if(!c)return this.hideAutoComplete();l.trigger("inline-math-changed")}this.hideAutoComplete()},changeAutoCompleteSelection:function(e,t){var n,i=$(".auto-suggest-container:visible"),r=i.find(".active");i.length&&y.pageCnt&&(t&&t.preventDefault(),r.length?(r.length&&(r=r.removeClass("active")[e?"prev":"next"]().addClass("active")),r.length||(y.pageNo+=e?-1:1,y.pageNo<0?y.pageNo=y.pageCnt-1:y.pageNo>=y.pageCnt&&(y.pageNo=0),n=i.find("[data-page]").hide().filter("[data-page="+y.pageNo+"]").show(),e?n.find("li:last").addClass("active"):n.find("li:first").addClass("active"))):r=i.find("ul:first>li:first").addClass("active"))},hideAutoComplete:function(){y={},g=null,$(".auto-suggest-container").hide()},expandOnDelay:function(e){var t=this;this.willExpandSoon&&clearTimeout(this.willExpandSoon),this.willExpandSoon=setTimeout(function(){t.expand(e)},10)},expand:function(e){function t(n,i){if(!n.prevAll(":not(.md-meta, .md-content)").text().length){var r=n.parent();return r.attr("mdtype")?n:i.contains(r[0])||e?t(r,i):n}return n}function n(e,t){if(!e.nextAll(":not(.md-meta, .md-content)").text().length){var i=e.parent();return i.hasClass("[mdtype]")||i[0].contains(t)?e:n(i,t)}return e}function r(e,t){if(e.commonAncestorContainer.nodeType===document.TEXT_NODE){if(t>0&&e.endOffset+t<=e.commonAncestorContainer.length)return e.setEnd(e.commonAncestorContainer,e.endOffset+t),e;if(t<0&&e.startOffset+t>=0)return e.setStart(e.commonAncestorContainer,e.startOffset+t),e}var n=$(e.startContainer).closest("[cid]")[0],i=e.getBookmark(n);return t>0?i.end+=t:i.start+=t,e.moveToBookmark(i),e}if(this.updateWordCountInSelection(),this.willExpandSoon&&(clearTimeout(this.willExpandSoon),this.willExpandSoon=null),!this.editor.isIME){var o=this.editor.selection,a=o.getRangy(),s=o.rangy,d=a?a.cloneRange():null;if(d&&(d.startContainer!=this.editor.writingArea||0!=d.startOffset)){var u;if(a&&!File.isLocked){if(this.editor.selection.deRange(a),u=this.editor.getJQueryElem(a.commonAncestorContainer),this.editor.stylize.putBookmark(d,this.editor.stylize.buildBookmark(u)),l.isType(document.activeElement.tagName,"INPUT","TEXTAREA")||document.activeElement.hasAttribute("tabindex"))return $(".md-expand").removeClass("md-expand"),$(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark);if(a.collapsed){var h,p=i(u),f=u.closest("[mdtype]"),m=(f.attr("contenteditable"),[]),g=p.visibleText().length;if(!f.length||l.isType(f.attr("mdtype"),c.fences,c.math_block))return $(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark);window.getSelection().baseOffset===g&&g<p.text().length?(h=p.addClass("md-expand"),(d=s.createRange()).collapseToPoint(p[0],p[0].childNodes.length),this.editor.selection.setRange(d)):(r(a,-1),h=f[0]!=$(a.startContainer).closest("[mdtype]")[0]?p:i(this.editor.getJQueryElem(a.startContainer)),a.startContainer===a.endContainer&&(a.toString().length&&a.collapse(!1),r(a,1)))}else h=i(this.editor.getJQueryElem(a.startContainer));if(!(m=i(this.editor.getJQueryElem(a.endContainer))).length&&(m=h),h.length&&m.length){var v=(d=function(e){try{var i,r=e.commonAncestorContainer;if(0==e.startOffset){var o=editor.getJQueryElem(e.startContainer);if(o.closest(".md-expand").length||o[0].hasAttribute("cid")||o[0].querySelector("[cid]"));else{i=o.closest("[cid]")[0];var a=e.collapsed;o=t(o,r.contains&&r.contains(i)?i:r),e.setStartBefore(o[0]),a&&e.collapse(!0)}}if(e.endOffset==(e.endContainer.nodeType===document.TEXT_NODE?e.endContainer.length:e.endContainer.childNodes.length)){var s=editor.getJQueryElem(e.endContainer);s.closest(".md-expand").length||s[0].hasAttribute("cid")||s[0].querySelector("[cid]")||(i=s.closest("[cid]")[0],s=n(s,r.contains&&r.contains(i)?i:r),e.setEndAfter(s[0]))}}catch(e){console.warn(e)}return e}(d)||d)&&!d.collapsed;$(".md-expand").removeClass("md-expand"),h.length?k.call(this,h):k.call(this,m),h.length&&m.length&&h.next().is(m)&&!m.hasClass("md-img-loaded")&&k.call(this,m,!0)}else $(".md-expand").removeClass("md-expand");if(v)window.getSelection().removeAllRanges(),this.editor.selection.deRange(d,!0);else{var y=window.getSelection().anchorNode;y&&(3===y.nodeType||y.hasAttribute&&y.hasAttribute("contenteditable"))&&this.editor.selection.deRange(d||this.editor.selection.getRangy(),!0)}$(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark)}else u=this.editor.getMarkElem(),$(".md-expand").removeClass("md-expand"),u.length&&l.isType(u.attr("mdtype"),l.TYPE.hr,l.TYPE.toc)&&(this.editor.stylize.putBookmark(null,this.editor.stylize.buildBookmark(u)),$(this.editor.sessionStr).trigger("cursorChange",this.editor.styleBookmark))}}},isAutoCompleteShown:function(){return $(".auto-suggest-container:visible").length},focusContainer:function(e){C.call(this,e)}};var C=function(e){var t=e.closest("tr.md-end-block, li[cid]")[0],n=e[0];if(t&&n){for(;t!==n&&t.contains(n);){if(n.previousSibling&&n.previousSibling.hasAttribute&&n.previousSibling.hasAttribute("cid"))return!1;n=n.parentElement}t.classList.add("md-focus-container")}},k=function(e,t){t||($(".md-expand").removeClass("md-expand").closest("[cid]").removeClass("md-focus"),$(".md-focus-container").removeClass("md-focus-container")),e.length&&C(e.addClass("md-expand").trigger("expand").closest("[cid]").addClass("md-focus"))},S=function(e,t,n,i){function o(e){for(var t=0;t<e.attributes.length;t++)l.isType(e.attributes[t].name,"cid","contenteditable","id","for","onerror","onload")&&e.removeAttributeNode(e.attributes[t]);e.classList.remove("md-img-loaded"),e.classList.remove("md-img-error")}function s(e){for(var t=e.querySelectorAll("*"),n=0;n<t.length;n++)o(t[n]);o(e)}function u(e,t,n,i,r,o){var a,l=n.innerHtml,c=e.clone(),o=n.cursorDiff,d=$($.parseHTML("<div>"+l+"</div>")[0]);return c.find(".md-inline-math.md-expand").text(function(){return this.textContent}),c.find(".md-expand").removeClass("md-expand"),s(c[0]),s(d[0]),c.html().replace(/\s*class=\"\"/gi,"")!=d.html().replace(/\s*class=\"\"/gi,"")?(e.html(l),n.mdlike?e.attr("mdlike")!=n.mdlike&&e.attr("mdlike",n.mdlike):e.removeAttr("mdlike"),r.mathInline.brush(e[0],i,!0),a=!0):c.find(".math-jax-preprocess").length&&r.mathInline.brush(e[0],i,!0),h(i,o,n.command,t,r)||a}function h(e,t,n,i,o){return!(!t.length||o.focusCid!==i.cid)&&(e&&(n&&n.undo.unshift(r.utils.clone(e)),e.start=f(t,e.start),e.end=f(t,e.end),n&&n.redo.push(r.utils.clone(e))),o.undo.register(n),!0)}function p(e,t,n,i,o){var a=n.cursorDiff||[];return n.replaceCid?o.findElemById(n.replaceCid).replaceWith(n.html):e.closest("p").replaceWith(n.html),n.toRemove&&n.toRemove.forEach(function(e){o.findElemById(e).remove()}),o.focusCid&&o.focusCid!==t.cid||(o.focusCid=n.focus,o.focusCid&&C(o.findElemById(o.focusCid)),i&&(n.command.undo.unshift(r.utils.clone(i)),a.length&&(i.start=f(a,i.start),i.end=f(a,i.end)),i.startId=n.focus,i.endId=n.focus,i.start-=n.offset,i.end-=n.offset,n.command.redo.push(r.utils.clone(i))),o.undo.register(n.command)),!0}function f(e,t){var n=t;for(var i in e)void 0!==i&&i<=t&&(n+=e[i]);return n}try{var m,g,v=e,y=e;if("string"==typeof e?v=this.editor.getNode(e):y=v.id,!v)return;if(l.isType(v,c.meta_block))return;if(d.CONST.NoInline.indexOf(v.get("type"))>-1)return;if(v.get("children").length)return v.get("children").toArray().map(function(e){t&&(t[e.id]=1),S.call(this,e,t,n,i)},this),!0;if(m=this.editor.findElemById(y).addClass("md-expand"),v.get("type")==c.def_footnote){var b=[];return g=this.inline.output(m.children(".md-def-content").text(),null,null,null,null,b),m.children(".md-def-content").html(g),h(n,b,null,v,this.editor),!0}var w=File.option.enableInlineMath?m.textExcludeSVG():m.text();return g=a.quickParse(w,this,v,i||!l.isType(v,c.line)),function(e,t,n,i,r){return n.blockChanged?p(e,t,n,i,r):u(e,t,n,i,r)}(m,v,g,n,this.editor)}catch(e){e.stack}},T=/:(\w+)$/;n.exports=m}),define("app/editor/Stylize",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core","app/window/MenuHelper","app/editor/UndoManager","app/editor/polyfill"],function(e,t,n){"use strict";var i=e("exoskeleton-master/exoskeleton"),r=e("app/document/StringUtils"),o=e("app/document/Node"),a=e("app/editor/UndoManager"),s=a.SnapFlag,l=o.Node,c=o.TYPE,d=o.NodeCollectionUtils,u=e("rangy/rangy-core.js"),h=e("app/window/MenuHelper"),p=function(){return File.isMac?app.clipboard.paste():File.isNode?reqnode("electron").remote.clipboard.readText():""},f=function(e,t,n,i){function r(e){var i=e.find('[md-inline="'+t+'"]').children(".md-meta:not(.md-content)");n&&(n.end-=i.text().length),i.remove()}var o=u.createRange();if(e[0].hasAttribute("mdtype")&&(e.wrapInner("<span></span>"),e=$(e[0].firstChild)),n?(n.containerNode=e[0],o.moveToBookmark(n)):o.selectNode(e[0]),o.commonAncestorContainer.nodeType==document.ELEMENT_NODE&&o.commonAncestorContainer.getAttribute("md-inline")==t)r($(o.commonAncestorContainer));else{for(var a=document.createElement("SPAN"),s=o.extractContents(),l=0;l<s.childNodes.length;l++)a.appendChild(s.childNodes[l].cloneNode(!0));r($(a)),o.insertNode(a),o.selectNode(a)}g.call(this,o,t,e[0],i?n:null)},m=function(e,t){return t.collapsed&&e[2]===e[1]&&l.isType(e[1],c.line)?[e[0],e[1].getLastBrother(!0),e[1].getLastBrother(!1)]:e},g=function(e,t,n,i){var o,a,s,d,u,h,f=b.SyntaxMap[t];if(i){var m,g=this.editor.getJQueryElem(e.startContainer),v=this.editor.getJQueryElem(e.endContainer);if(g.closest("md-before").length||g.closest("md-content").length?(e.setStartBefore(g.closest("[md-inline]")[0]),m=!0):g.closest("md-meta").length&&(e.setStartAfter(g.closest("[md-inline]")[0]),m=!0),v.closest("md-after").length||g.closest("md-content").length?(e.setEndAfter(g.closest("[md-inline]")[0]),m=!0):v.closest("md-meta").length&&(e.setEndBefore(g.closest("[md-inline]")[0]),m=!0),o=e.toString(),e.collapsed||0===o.trim())return;a=m?a||e.getBookmark(n||e.commonAncestorContainer):i instanceof Object?i:{start:i,end:i}}else o=e.toString();s=/^\s+/g.exec(o),d=/\s+$/g.exec(o),s=s?s[0].length:0,d=d?d[0].length:0,(s||d)&&((a=a||e.getBookmark(n||e.commonAncestorContainer)).start+=s,a.end-=d,e.moveToBookmark(a)),u=f[1],h=p().substr(0,200),l.isType(t,c.link)&&(r.isURL(o)?u="]("+o+")":r.isURL(h)&&(u="]("+h+")")),l.isType(t,c.image)&&(r.isImg(o)?u="]("+o+")":r.isImg(h)&&(u="]("+h+")")),e.insertNodeAtEnd(document.createTextNode(u)),e.insertNode(document.createTextNode(f[0])),i&&(l.isType(t,c.link)?e.moveToBookmark({containerNode:n,start:a.start+1,end:1+a.end}):e.moveToBookmark({containerNode:n,start:a.start+f[0].length,end:a.end+f[0].length}),editor.selection.setRange(e))},v=function(e,t){function n(e){var r=e.get("children");return r.length?r.toArray().map(n):i.stylize.canContainInline(e.get("type"))&&(i.stylize.putStyleInBlock(i.findElemById(e.id),t,void 0,void 0,!0),i.store(e),i.brush.addToQueue(e.id)),e}var i=this.editor,r=i.selection.getDetailPos(e.startContainer,e.startOffset),o=i.selection.getDetailPos(e.endContainer,e.endOffset),s=i.getMarkElem(r[0]),c=i.getMarkElem(o[0]),d=i.findNodeByElem(s),u=i.findNodeByElem(c),h=l.getTreePosition(d,u),p=h[1],f=h[2],m=a.makeEmptyCommand(i.selection.buildUndo()),g=e.cloneRange(),v=e.cloneRange(),y=p;for(m.undo.push(a.buildReplaceUndo(p)),v.setEndAfter(s[0]),this.canContainInline(d)&&(this.putStyleInBlock(s,t,v.getBookmark(s[0]),void 0,!0),i.store(d,!0)),i.UserOp.decorateOneSide(d,p,"after",n),m.redo.push(a.buildReplaceUndo(p)),i.brush.addToQueue(s.attr("cid")),y=p.get("after");y&&y!==f;)m.undo.push(a.buildReplaceUndo(y)),n(y),m.redo.push(a.buildReplaceUndo(y)),y=y.get("after");u&&u!=p&&(g.setStartBefore(c[0]),m.undo.push(a.buildReplaceUndo(f)),this.canContainInline(u)&&(this.putStyleInBlock(c,t,g.getBookmark(c[0]),void 0,!0),i.store(u,!0)),i.UserOp.decorateOneSide(u,f,"before",n),m.redo.push(a.buildReplaceUndo(f)),i.brush.addToQueue(c.attr("cid"))),m.redo.push(i.selection.buildUndo()),i.undo.register(m),$(".md-expand").removeClass("md-expand")},y=i.Model.extend({initialize:function(e){this.editor=e,this.CONST=b,this.putBookmark(null,{block:[]})},removeStyle:function(e,t,n){e.children(".md-meta").remove()},canContainInline:function(e){return e.jquery&&(e=e.attr("mdtype")),l.isType(e,c.line,c.def_footnote,c.heading,c.table_cell)},putStyle:function(e,t){this.editor.selection.deRange(e);var n=this.editor.getMarkElem(e.commonAncestorContainer),i=b.InsertInline.indexOf(t)>-1;if(i&&(n=this.editor.getMarkElem(e.startContainer)),n.length&&0===n.find("[mdtype]").length&&this.canContainInline(n)){var r=a.makeEmptyCommand(this.editor.selection.buildUndo()),o=this.editor.store(n.attr("cid"));r.undo.push(a.buildReplaceUndo(o)),this.putStyleForRange(n,t,e,!0),this.editor.store(n.attr("cid")),r.redo.push(a.buildReplaceUndo(o)),r.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(r),this.editor.brush.addToQueue(o.id,!0)}else if(!i)return v.call(this,e,t)},putStyleInBlock:function(e,t,n,i,r){if(!r||0!=e.text().length){e[0].hasAttribute("mdtype")&&e.addClass("md-expand");try{f.call(this,e,t,n,i)}catch(e){console.error(e)}}},putStyleForRange:function(e,t,n,i){var r=n.getBookmark(e[0]);e[0].hasAttribute("mdtype")&&n.commonAncestorContainer.nodeType!=document.TEXT_NODE&&e.addClass("md-expand"),f.call(this,e,t,r,i)},addStyle:function(e,t){var n,i=b.SyntaxMap[t],o=document.createElement("SPAN");o.className="md-meta md-expand",o.setAttribute("md-inline",t),"link"==t&&(n=p(),r.isURL(n)&&(i[1]="]("+n+")")),o.appendChild(document.createTextNode(i[0]+i[1])),e.insertNode(o),e.moveToBookmark({containerNode:o,start:i[0].length,end:i[0].length}),this.editor.selection.rangy.getSelection().setSingleRange(e)},detach:function(e,t){return!(!e.collapsed||!$.parseHTML("<div>"+e.toHtml()+"</div>")[0].querySelector('[md-inline="'+t+'"]'))||$(e.commonAncestorContainer).closest('[md-inline="'+t+'"]').length},canToggleStyle:function(e,t,n){var i=function(e){for(var t=0;t<e.CONST.NoInline.length;t++)if(e.hasStyle(e.CONST.NoInline[t]))return!0}(this);return!!this.hasStyle(e)||!(i||/(md-meta|md-content)(\s+|$)/g.exec(t[0].className)&&!n||/md-blockmeta/g.exec(t[0].className))&&!i},clearStyle:function(){if(window.getSelection().rangeCount&&"INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&!File.isLocked){this.editor.brush.pause(!0),this.editor.undo.completeSnap(!0);var e=this.editor.selection.getRangy();if(e){for(var t,n=a.makeEmptyCommand(editor.selection.buildUndo()),i=editor.selection.getDetailPos(e.startContainer,e.startOffset),r=editor.selection.getDetailPos(e.endContainer,e.endOffset),o=editor.getMarkElem(i[0]),s=editor.getMarkElem(r[0]),c=editor.findNodeByElem(o),d=editor.findNodeByElem(s),u=l.getTreePosition(c,d),h=u[1],p=u[2],f=h;f&&f!=p.get("after");)t=f,f=f.get("after"),n.undo.push(a.buildReplaceUndo(t)),this.editor.findElemById(t.id).find(".md-meta, .md-content").remove(),this.editor.store(t.id),this.editor.brush.addToQueue(t.id),n.redo.push(a.buildReplaceUndo(t));this.editor.undo.register(n)}this.editor.brush.resume(),this.editor.brush.expand()}},toggleStyle:function(e){if(!File.isLocked&&window.getSelection().rangeCount&&"INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&!File.isLocked){var t,n=this.editor.selection.getRangy(),i=this.hasStyle(e),r=this.editor.getJQueryElem(n.commonAncestorContainer),o=this.editor.getMarkElem(n.commonAncestorContainer),a=o.attr("cid"),d=l.isType(e,c.link,c.image)&&e;if(this.editor.undo.completeSnap(!0),a&&this.editor.undo.snap(a,s.REPLACE),!i){var u=this.editor.getJQueryElem(n.startContainer);"link"==e&&(i=u.closest('[md-inline="reflink"], [md-inline="autolink"]').length),"image"==e&&(i=u.closest('[md-inline="refimg"], .md-url').length)}this.editor.brush.pause();do{if(!this.canToggleStyle(e,r,n.collapsed))break;if(i){var h,p=r.closest('[md-inline="'+e+'"]');p.length||"link"!=e||(p=r.closest('[md-inline="reflink"], [md-inline="autolink"]')),"image"==e&&(p.length?h=/!\[([^\]]*)\]/.exec(p.text())[1]:h||((p=r.closest('[md-inline="refimg"]')).length?h=/!\[((?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*)\]/.exec(p.text())[1]:(p=r.closest(".md-url").closest("[md-inline]")).length&&(h="!"+p.text()))),e==c.comment&&(h=p.text().replace(/(^<\!--)|(-->)$/g,"")),h?(p.text(h),this.editor.selection.selectAllElem(p)):p.children(".md-meta, .md-content").remove()}else{if(!n.collapsed){this.putStyle(n,e);break}t=n.getBookmark(o[0]).start;var f=o.text().substring(t-1,t+1),m="**"==f&&$(n.startContainer).closest("[md-inline='plain']").length;e==c.em&&m?(n.moveToBookmark({containerNode:o[0],start:t-1,end:t+1}),n.extractContents()):!function(e,t){return!t||e.collapsed&&/^[\(\)\[\]\^&_\-+*#@!~`\\\/\{\}'":;<>,.?%\s]+$/.exec(t)}(n,f)?(o.addClass("md-expand"),!m&&this.editor.selection.selectWord(d),(n=this.editor.selection.getRangy()).collapsed?this.addStyle(n,e):g.call(this,n,e,o[0],t)):this.addStyle(n,e)}if(this.editor.brush.addToQueue(o.attr("cid")),e==c.inline_math&&!i){var v=this.editor;setTimeout(function(){v.brush.triggerAutoComplete(!0)},100)}}while(!1);this.editor.brush.resume(!0)}},putBookmark:function(e,t){return this.editor.styleBookmark={cursor:e,style:t}},isAtFootnoteDefSpan:function(){var e=this.editor.selection.getRangy();return e&&this.editor.getJQueryElem(e.startContainer).closest(".md-def-name").length},buildBookmark:function(e){if(File.ignoreStyleChange)return File.editor.styleBookmark.style;var t,n={inline:[],block:[],state:""},i=this.editor.selection.getRangy(),r=(e=e||this.editor.getJQueryElem(i&&i.commonAncestorContainer||document.activeElement)||$()).closest("[md-inline]"),o=e;if(0==e.length){if(!(e=this.editor.getMarkElem()).length||!l.isType(e.attr("mdtype"),l.TYPE.hr,l.TYPE.toc))return n;o=e}for(;r.length;)t=r.attr("md-inline"),this.CONST.LinkList.indexOf(t)>-1&&(t="link"),n.inline.push(t),o=r,r=r.parent().closest("[md-inline]");for(r=o.closest("[mdtype]");r.length;)(t=r.attr("mdtype"))===c.heading?n.block.push("header"+r[0].tagName.substring(1)):t===c.list?n.block.push(this.editor.findNodeByElem(r).get("style")):t===c.list_item?r.hasClass("task-list-item")&&!n.state&&(n.state=r.hasClass("task-list-done")?"checked":"unchecked"):n.block.push(t),r=r.parent().closest("[mdtype]");return n},hasStyle:function(e){var t=this.editor.styleBookmark.style;if(t)return(t.inline||[]).indexOf(e)>-1||(t.block||[]).indexOf(e)>-1},changeStyleFromMenu:function(e){if(!File.isLocked){var t=b.NameMapToStyle[e.toLowerCase()];l.isType(t,"header1","header2","header3","header4","header5","header6",c.paragraph)?this.changeBlock(t):l.isType(t,c.def_footnote,c.def_link,c.hr,c.fences,c.math_block,c.toc)?this.insertBlock(t):l.isType(t,c.table)?File.editor.tableEdit.insertTable():l.isType(t,c.meta_block)?this.insertMetaBlock():l.isType(t,c.blockquote)&&this.toggleIndent(c.blockquote)}},changeBetweenCodeMirror:function(e,t){if(l.isType(t,c.math_block,c.fences)){var n=this.editor,i=a.makeEmptyCommand(n.selection.buildUndo());n.undo.completeSnap(!0),l.isType(t,c.fences)?(n.fences.syncToNode(t.cid),n.fences.beforeDeleteFences(t)):(n.mathBlock.syncToNode(t.cid),n.mathBlock.beforeDeleteFences(t)),i.undo.push(a.buildReplaceUndo(t)),t.set("type",e),i.redo.push(a.buildReplaceUndo(t)),n.findElemById(t.id).replaceWith(t.toHTML()),e==c.fences?n.fences.getCm(t.id):e==c.math_block&&n.mathBlock.startEditing(t.id),n.selection.jumpIntoElemBegin(n.findElemById(t.id)),i.redo.push(n.selection.buildUndo()),n.undo.register(i),n.refocus(),h.refreshBlockMenu()}},toggleFences:function(){var e=this.editor.getNode(null,!0);l.isType(e,c.fences)?this.changeBlock(c.paragraph,e):l.isType(e,c.math_block)?this.changeBetweenCodeMirror(c.fences,e):this.insertBlock(c.fences)},toggleMathBlock:function(){var e=this.editor.getNode(null,!0);l.isType(e,c.math_block)?this.changeBlock(c.paragraph,e):l.isType(e,c.fences)?this.changeBetweenCodeMirror(c.math_block,e):this.insertBlock(c.math_block)},changeBlock:function(e,t){function n(e,n,i){return t.set("type",c.heading),t.set("depth",e),t.set("pattern",n),i||(p.findElemById(t.id).replaceWith(t.toHTML()),r.redo.push(a.buildReplaceUndo(t))),t}t=t||this.editor.getNode(null,!0);var r,o,s,d,h=b.getMenuBlockType(t),p=this.editor,f=t.cid;if(!l.isType(t,c.table,c.table_row,c.table_cell,c.blockquote,c.list)&&!File.isLocked&&(p.lastCursor=p.selection.buildUndo(),h!=e&&h)){if(p.undo.completeSnap(!0),l.isType(h,c.fences,c.math_block)&&(p.fences.syncToNode(t.cid),p.fences.beforeDeleteFences(t)),(r=a.makeEmptyCommand(p.lastCursor)).undo.push(a.buildReplaceUndo(t.getClosetParagraphLevel())),l.isType(h,c.def_link)&&t.set("text",t.get("href")+(t.get("tittle")?' "'+t.get("tittle")+'"':"")),0==e.indexOf("header")?(s=e.substr(6)-0,(o=t.get("pattern"))&&/-|=/.exec(o)?o=s<=2?o.replace(/-|=/g,1==s?"=":"-"):void 0:o&&(o=o.replace(/#+/g,"#".repeat(s))),t=l.isType(t,c.line)?function(e,i){var o,s,l=t.getClosetParagraphLevel();return n(e,i,!0),o=t.separateBlockFromLine(!1),s=(o[0]?o[0].toHTML():"")+o[1].toHTML()+(o[2]?o[2].toHTML():""),o[0]&&a.addUndoForInsert(r,o[0]),o[2]&&a.addUndoForInsert(r,o[2]),p.findElemById(l.id).replaceWith(s),o[1]}(s,o):n(s,o)):(t.set("type",e),t.set("pattern",void 0)),l.isType(h,c.meta_block,c.fences)&&l.isType(t,c.paragraph)){t.set("type",c.raw_edit);var m=p.simpleParse(t),g=$(m[1]),v=g[0].getAttribute("cid"),y=g.last()[0].getAttribute("cid"),w=u.createRange();p.findElemById(m[2]).replaceWith(m[1]),m&&a.append(r,m[0]),w.setStartBefore(p.findElemById(v)[0]),w.setEndAfter(p.findElemById(y)[0]),w=p.selection.deRange(w,!0),d=p.selection.buildUndo(w)}else l.normalizeNode(t),r.redo.push(a.buildReplaceUndo(t)),p.findElemById(t.id).replaceWith(t.toHTML());d||((d=i.utils.clone(r.undo[0])).startId===f&&(d.startId=t.cid),d.endId===f&&(d.endId=t.cid),d.id===f&&(d.id=t.cid),p.undo.exeCommand(d)),r.redo.push(d),p.undo.register(r),p.refocus()}},increaseHeaderLevel:function(){var e=this.editor.getMarkElem(),t=e.attr("mdtype");"heading"!=t&&"line"!=t||this.editor.stylize.changeHeadingLevel(this.editor.findNodeByElem(e),!0)},decreaseHeaderLevel:function(){var e=this.editor.getMarkElem(),t=e.attr("mdtype");"heading"!=t&&"line"!=t||this.editor.stylize.changeHeadingLevel(this.editor.findNodeByElem(e),!1)},insertMetaBlock:function(e,t){if(!File.isLocked){t=t||"";var n=this.editor.nodeMap.getFirst();if(!l.isType(n,c.meta_block)){this.editor.undo.completeSnap(!0),this.editor.lastCursor=this.editor.selection.buildUndo();var i=a.makeEmptyCommand(this.editor.lastCursor||this.editor.selection.buildUndo()),r=new l({type:c.meta_block,in:this.editor.nodeMap,attachTo:this.editor.nodeMap,after:n,text:t});return a.addUndoForInsert(i,r),e?{command:i,node:r}:(this.editor.findElemById(n.cid).before(r.toHTML()),this.editor.selection.restoreSelection(this.editor.findElemById(r.cid),0),i.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(i),$(this.editor.sessionStr).trigger("cursorChange"),this.editor.selection.scrollAdjust(),this.editor.refocus(r.cid),r)}}},insertBlock:function(e,t){function n(e,t){e.set("in",t),e.get("children").toArray().map(function(e){n(e,t)})}if(!File.isLocked){var i=this.editor,r=i.selection.getRangy(),o="",s=null;r.collapsed||t?s=a.makeEmptyCommand():(o=i.UserOp.prepMarkHtml(r.toHtml(),i).html(),s=i.UserOp.backspaceHandler(i,null,"delSelection",!0),r=i.selection.getRangy(),i.selection.deRange(r,!0),i.refocus(null,!1,!0));var d=this.editor.getNode(null,!0),u=b.getMenuBlockType(d),p=this.editor.findElemById(d.getClosetParagraphLevel().id);if(this.editor.lastCursor=this.editor.selection.buildUndo(r),u==e||!u||!l.isType(d,c.paragraph,c.heading,c.line))return t&&t.remove(),void h.refreshBlockMenu();this.editor.undo.completeSnap(!0),s.undo.push(this.editor.lastCursor),s.undo.push(a.buildReplaceUndo(d.getClosetParagraphLevel()));var f,m=l.splitAt(d,this.editor.lastCursor.start,i,l.genNormalSplitExitFunc(!1,!0)),g=m.prev,v=t||new l({type:e,text:""}),y=m.next,w="",x=e==c.hr?(y||opt_next||g.get("after")).id:v.id;l.isType(e,c.math_block,c.fences)?v.set("text",o?i.UserOp.getMarkdownSourceFrom(o):""):c.def_link,g.insert(v,!1),a.addUndoForInsert(s,v),s.redo.push(i.undo.buildReplaceUndo(m.prev)),t&&n(t,d.get("in")),y&&l.isEmptyBlock(y)&&l.isType(y.get("after"),c.paragraph)?(y.remove(),y=null):y&&a.addUndoForInsert(s,y),m.opt_next&&a.addUndoForInsert(s,m.opt_next),m.opt_prev&&a.addUndoForInsert(s,m.opt_prev),l.isEmptyBlock(g)&&(a.addUndoForRemove(s,g),g.remove(),g=null),[m.opt_prev,g,v,y,m.opt_next].map(function(e){e&&(w+=e.toHTML())}),p.replaceWith(w),f=this.editor.findElemById(x),e==c.fences?this.editor.fences.getCm(v.id):e==c.math_block&&this.editor.mathBlock.startEditing(v.id),this.editor.selection.jumpIntoElemBegin(f),this.editor.lastCursor=this.editor.selection.buildUndo(),s.redo.push(this.editor.lastCursor),this.editor.undo.register(s),this.editor.refocus(),$(this.editor.sessionStr).trigger("cursorChange"),this.editor.selection.scrollAdjust()}},toggleTaskStatus:function(e){var t=this.editor.selection.getRangy(),n=this.editor.getMarkElem(t&&t.startContainer).closest(".task-list-item"),i=n.hasClass("task-list-done");if(void 0===e&&(e=!i),n.length&&e!==i){var r=this.editor;if(t.collapsed)r.getNode(n.attr("cid")).attr("checked",e,r,!1);else{r.undo.completeSnap(!0);var o=a.makeEmptyCommand(),s=$.parseHTML(t.toHtml());$(s).find(e?".task-list-not-done":".task-list-done").andSelf(e?".task-list-not-done":".task-list-done").each(function(){var t=r.getNode(this.getAttribute("cid")).attr("checked",e,r,!0);a.append(o,t)}),o.undo.length?r.undo.register(o):r.getNode(n.attr("cid")).attr("checked",e,r,!1)}var l=(File.isMac?app.menu.getItem("Paragraph").submenu():reqnode("electron").remote.Menu.getApplicationMenu().getItem("Paragraph").submenu).getItem("Task Status"),c=File.isNode?l.submenu:l.submenu();e?(c.getItem("Mark as Complete").setState(!0),c.getItem("Mark as Incomplete").setState(!1)):(c.getItem("Mark as Complete").setState(!1),c.getItem("Mark as Incomplete").setState(!0))}},toggleIndent:function(e,t){function n(e,t,n){return t=t||e,!(!n||n.get("type")!=c.blockquote)&&(p.collapsed||!e.get("before")&&!t.get("after"))}function i(e,t){t=(t||e).getClosetParagraphLevel();var n=(e=e.getClosetParagraphLevel()).get("parent");if(p.collapsed){if(!e.get("before")&&!t.get("after")&&n&&l.isType(n.get("parent"),c.list))return n.get("parent")}else if(n&&l.isType(n.getClosetBlock(),c.list))return n.getClosetBlock()}function r(e,t,n){if(t=t||e,e.get("parent")==t.get("parent")&&l.isType(e,c.line)){var i,r=e.get("parent"),o=[];if(n.undo.push(a.buildReplaceUndo(r)),o.push(r),t.get("after")&&(i=new l({type:c.paragraph}),r.giveChildrenTo(i,t.get("after"),null,!0),o.push(i),r.insert(i),n.redo.push(a.buildReplaceUndo(r)),a.addUndoForInsert(n,i)),e.get("before")&&(i=new l({type:c.paragraph}),r.giveChildrenTo(i,null,e.get("before"),!0),o.unshift(i),r.insert(i,!0),n.redo.push(a.buildReplaceUndo(r)),a.addUndoForInsert(n,i)),e!=t){for(var s,h=o.indexOf(r)+1,p=[],f=e.get("after");f!=t.get("after");)i=new l({type:c.paragraph}),s=f,f=f.get("after"),s.detach(),s.set("parent",i),p.push(i),o.splice(h,0,i),h++;r.insertArray(p,!1,!0),a.addUndoForInsertArray(n,p)}o.length>1&&u.findElemById(r.cid).replaceWith(d.toHTML(o))}}var o,s,u=this.editor,h=a.makeEmptyCommand(u.selection.buildUndo()),p=this.editor.selection.getRangy();if(!(l.isType(document.activeElement.tagName,"INPUT","TEXTAREA")&&!this.editor.fences.getFocused()||File.isLocked)){if(this.editor.undo.completeSnap(!0),this.editor.store(),this.editor.lastCursor=this.editor.selection.buildUndo(),p){var f=u.selection.getDetailPos(p.startContainer,p.startOffset),g=u.selection.getDetailPos(p.endContainer,p.endOffset),v=u.getMarkElem(f[0]),y=u.getMarkElem(g[0]),b=u.findNodeByElem(v),w=u.findNodeByElem(y),x=l.getTreePosition(b,w),C=m(x,p);o=C[1],s=C[1]===C[2]?null:C[2]}else o=this.editor.findNodeByElem(this.editor.getMarkElem());o&&(this.editor.brush.pause(!0),e==c.blockquote?function(t,i,r){t=t.getClosetBlock(),i=i&&i.getClosetBlock();var o=t.get("parent");if(n(t,i,o))a.addUndoForUnwrap(r,o),o.unwrap(u);else{var s=new l({type:e,in:t.get("in")});s.wrap(t,i,u),a.addUndoForWrap(r,s)}}(o=o.getClosetParagraphLevel(),s=s&&s.getClosetParagraphLevel(),h):function(e,n,o,s){var d=i(e,n);if(t)if("none"==s){if(!d)return;s=d.get("style")}else if(d&&s==d.get("style"))return;if(d)d.get("style")===s?(d.get("children").map(function(e){a.addUndoForUnwrap(o,e),e.unwrap()}),a.addUndoForUnwrap(o,d),d.unwrap(u)):(o.undo.push(a.buildReplaceUndo(d)),d.set("style",s),d.set("pattern",void 0),u.findElemById(d.id).replaceWith(d.toHTML()),o.redo.push(a.buildReplaceUndo(d)));else{r(e,n=n||e,o);for(var h,p=e=e.getClosetParagraphLevel(),f=[],m=(n=n.getClosetParagraphLevel()).get("after");p&&p!=m;){var g=new l({type:c.list_item,in:e.get("in")});h=p,p=p.get("after"),g.wrap(h,h,u,!0),f.push(g),a.addUndoForWrap(o,g)}(d=new l({type:c.list,style:s,in:e.get("in")})).wrap(f[0],f.last(),u),a.addUndoForWrap(o,d),u.refresh()}}(o,s,h,e),h.redo.push(this.editor.lastCursor),this.editor.undo.exeCommand(this.editor.lastCursor),this.editor.undo.register(h),this.editor.brush.resume(),this.editor.refocus(),this.editor.selection.scrollAdjust())}},changeHeadingLevel:function(e,t){var n=null;if(e.get("type")==c.line)t&&(n="header6");else if(e.get("type")==c.heading){var i=e.get("depth")-0;7==(i-=t?1:-1)?n="paragraph":i>0&&(n="header"+i)}n&&this.changeBlock(n)}}),b={SyntaxMap:{strong:["**","**"],em:["*","*"],code:["`","`"],del:["~~","~~"],underline:["<u>","</u>"],footnote:["[^"," ]"],link:["[","]()"],image:["![","]()"],highlight:["==","=="],superscript:["^","^"],subscript:["~","~"],inline_math:["$","$"],comment:["\x3c!--","--\x3e"]},NormalBlockMap:{line:"Paragraph",paragraph:"Paragraph",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",header6:"Header 6",def_link:"Link Reference",def_footnote:"Footnotes"},InsertInline:["link","image","footnote","inline_math"],LinkList:["autolink","reflink","link"],NoInline:["hr","fences","def_link","code","meta_block","math_block","toc","comment","tag","atag","imgtag"],Selectable:["hr","math_block","toc"],InsertBlock:["table","fences","hr"],StyleToNameMap:{paragraph:"Paragraph",header1:"Heading 1",header2:"Heading 2",header3:"Heading 3",header4:"Heading 4",header5:"Heading 5",header6:"Heading 6",def_link:"Link Reference",def_footnote:"Footnotes",table:"Table",fences:"Code Fences",blockquote:"Quote",toc:"Table of Contents",hr:"Horizontal Line",meta_block:"YAML Front Matter",ol:"Ordered List",ul:"Unordered List",tasklist:"Task List",strong:"Strong",em:"Emphasis",code:"Code",del:"Strike",highlight:"Highlight",inline_math:"Inline Math",math_block:"Math Block",superscript:"Superscript",subscript:"subscript",image:"Image",footnote:"Superscript",autolink:"Hyperlink",reflink:"Hyperlink",link:"Hyperlink",url:"Hyperlink",underline:"Underline",comment:"Comment"}};b.NameMapToStyle={};for(var w in b.StyleToNameMap)b.NameMapToStyle[b.StyleToNameMap[w].toLowerCase()]=w;b.InsertQuery='[md-inline="'+b.InsertInline.join('"],[md-inline="')+'"]',b.getMenuBlockType=function(e){var t=e.get("type");switch(t){case c.line:return c.paragraph;case c.heading:return"header"+e.get("depth");case c.list:return e.get("style")}return t},y.CONST=b,n.exports=y}),define("app/editor/Selection",["app/document/StringUtils","jquery/jquery","rangy/rangy-core","codemirror/lib/codemirror","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster"],function(e,t,n){"use strict";function i(e){return!1}function r(e){o("content").on(e?"scroll":"DOMMouseScroll mousewheel",i),setTimeout(function(){o("content").off(e?"scroll":"DOMMouseScroll mousewheel",i)},500)}e("app/document/StringUtils");var o=e("jquery/jquery"),a=e("rangy/rangy-core.js"),s=e("codemirror/lib/codemirror"),l=e("app/document/Node"),c=l.Node,d=e("app/editor/KeyMaster").map,u=c.TYPE,h=function(e){this.rangy=a,a.init(),this.savedSel={},this.editor=e,o(document).on("selectionchange",function(t){e.selection.selectWordTime&&new Date-e.selection.selectWordTime>200&&(e.selection.selectWordTime=null)}),this.updateMetrics()},p=!1,f=o.fn.scrollTop;o.fn.oldScrollTop=f,o.fn.scrollTop=function(e){if(void 0===e||!p)return f.apply(this,arguments)},o(document.body).on("hidden.bs.modal",".modal",function(e){File.editor.restoreLastCursor()}).on(".show.bs.modal",".modal",function(){var e=File.editor.selection.buildUndo();e&&(File.editor.lastCursor=e)}),r(),a.rangePrototype.insertNodeAtEnd=function(e){var t=this.cloneRange();t.collapse(!1),t.insertNode(e),t.detach(),this.setEndAfter(e)};var m,g;o("window").on("resize",function(){File.suppressResize||(m=document.querySelector("content").clientHeight)}),h.prototype={preventScrollOnce:r,enableScroll:function(e){o("content").off(e?"scroll":"DOMMouseScroll mousewheel",i)},updateMetrics:function(){m=document.querySelector("content").clientHeight,g=o("content").offset().top,this.editor.defaultTextHeight=parseInt(o(".md-line").css("line-height"))},jumpIntoElemBegin:function(e,t){var n=this,i=(this.editor,e.find(".CodeMirror")[0]),r=e.children("[mdtype]");if(!e.length)return window.getSelection().removeAllRanges(),!1;if(e.length>1&&(e=o(e[0])),i)return i.CodeMirror.focus(),i.CodeMirror.execCommand("goDocStart");if(e.attr("mdtype")==l.TYPE.fences)return this.editor.fences.focus(e.attr("cid"));if(c.isType(e.attr("mdtype"),c.TYPE.image,c.TYPE.hr,c.TYPE.math_block))return this.selectNode(null,e);if(e.hasClass("footnotes"))return this.jumpIntoElemBegin(e.find(".md-def-name"));if(r.length)return this.jumpIntoElemBegin(o(r[0]),t);var s=a.createRange();return s.setStart(e[0],0),s.setEnd(e[0],0),this.deRange(s),t&&setTimeout(function(){n.setRange(s),n.editor.refocus()},20),n.setRange(s),!window.getSelection().anchorNode&&e.length&&(!function e(t){3==t.nodeType?(s.setStart(t,0),s.setEnd(t,0)):t.childNodes.length?e(t.childNodes[0]):(s.setStart(t,0),s.setEnd(t,0))}(e[0]),window.getSelection().addRange(s)),window.getSelection().anchorOffset},jumpIntoElemEnd:function(e,t){var n=e.find(".CodeMirror")[0];if(e.length>1&&(e=o(e[0])),n)n.CodeMirror.execCommand("goDocEnd");else{if(e.attr("mdtype")==l.TYPE.fences)return this.editor.fences.jumpCmEnd(e.attr("cid"));if(c.isType(e.attr("mdtype"),c.TYPE.image,c.TYPE.hr,c.TYPE.math_block))return this.selectNode(null,e);if(e.children("[mdtype]").length)return this.jumpIntoElemEnd(o(e.children("[mdtype]")[0]),t);e.addClass("md-expand"),this.restoreSelection(e[0],e.text().length),e.removeClass("md-expand")}},jumpInto:function(e,t){if(""==e.text())return this.jumpIntoElemBegin(e);this.restoreSelection(e[0],t)},setRange:function(e){this.editor.brush.updateWordCountInSelection(),o(e.startContainer).closest(".math-jax-postprocess, .md-meta, .md-content").parent().addClass("md-expand"),o(e.endContainer).closest(".math-jax-postprocess, .md-meta, .md-content").parent().addClass("md-expand"),File.isTypeWriterMode&&File.option.scrollWithCursor&&this.typeWriterScroll(e.nativeRange||e),this.rangy.getSelection().setSingleRange(e,e.isBackward)},getOffset:function(e,t){if(t=t||this.getRangy())try{return t.getBookmark(e[0]).start}catch(e){}return 0},restoreEdge:function(e,t,n,i){function r(e){if(3==e.nodeType){var o=l+e.textContent.length;if(n){if(t>=l&&t<=o)throw i.setEnd(e,t-l),c}else if(s){if(t>=l&&t<o)throw i.setStart(e,t-l),c}else if(t>=l&&t<=o)throw i.setStart(e,t-l),c;l=o}else{e.childNodes.length||e.nodeType!==e.ELEMENT_NODE||e.appendChild(document.createTextNode(""));for(var a=0,d=e.childNodes.length;a<d;++a)r(e.childNodes[a])}}e.jquery&&(e=e.length?e[0]:null);var s,l=0,c={};if(!n){var d=o(e).closest("[mdtype='line'], [mdtype='heading']");s=d.length&&t<d.text().length}i=i||a.createRange();try{e&&r(e)}catch(e){if(e==c)return i;throw e}return i},saveSelection:function(e,t){if(e)return e.jquery&&(e=e[0]),(t=t||this.getRangy())?(this.savedSel=t.getBookmark(e),this.savedSel):void 0},restoreSelection:function(e,t){if(!e)return window.getSelection().removeAllRanges();e.jquery&&(e=e[0]);var n="false"===e.getAttribute("contenteditable");if(void 0===t||null===t||""===t?t=this.savedSel:"number"==typeof t&&(t={start:t,end:t}),"fences"===e.getAttribute("mdtype")){var i=this.editor.fences.getCm(e.getAttribute("cid"));return i.focus(),void i.setCursor(t.start)}var r=a.createRange();if(r.moveToBookmark({start:t.start,end:t.end,containerNode:e}),"BODY"==document.activeElement.tagName||document.activeElement.hasAttribute("tabindex")){var s=o("content").scrollTop();this.editor.writingArea.focus(),o("content").scrollTop(s)}r.collapsed&&this.deRange(r),n&&e.setAttribute("contenteditable","true"),this.setRange(r),n&&e.setAttribute("contenteditable","false")},getVeryFirstElem:function(e){return e.children("[cid]").length>0?this.getVeryFirstElem(e.children("[cid]").first()):e},getVeryLastElem:function(e){return e.children("[cid]").length>0?this.getVeryLastElem(e.children("[cid]").last()):e},getSelection:function(){return this.rangy.getSelection()},prepNode:function(e,t,n,i){var r,o=this.editor,s=this.getRangy(),d=this.editor.undo.UndoManager,h=d.SnapFlag;try{if(s&&!n&&!s.collapsed){if(o.undo.completeSnap(!0),r=o.UserOp.surroundPair(o,e,s))return t&&t.preventDefault(),!n&&o.undo.register(r),r;r=o.UserOp.backspaceHandler(o,null,"delSelection",!0,!0)}s=this.getRangy();var p,f,m=this.rangy.getSelection(),g=m.anchorOffset==a.dom.getNodeLength(m.anchorNode),v=o.getJQueryElem(window.getSelection().anchorNode),y=o.getMarkElem(window.getSelection().anchorNode),b=o.findNodeByElem(y),w=s.getBookmark(y[0]);if(r||n||(o.undo.snap(b.cid,h.ADD,void 0,i),o.brush.addToQueue(b.cid)),v.hasClass("md-def-url")&&e.match(/\s/g).length)return g&&this.jumpIntoElemBegin(y.find(".md-def-title")),t&&t.preventDefault();if(!n&&r&&o.undo.snap(y.attr("cid"),e.length||h.ADD,o.docMenu.getAttrByElem(v)),y.removeClass("unholdable").find(".md-math-after-sym").text(""),b.get("type")==u.paragraph?(0===b.get("children").length&&c.normalizeNode(b),0===y.children("[mdtype]").length&&(y.replaceWith(b.toHTML()),this.jumpIntoElemEnd(this.editor.findElemById(b.cid)))):b.get("type")==u.meta_block||b.get("type")==u.fences||(b.isBlock()&&b.canNotDirectEdit()?(window.getSelection().removeAllRanges(),t&&t.preventDefault()):v.hasClass("md-image")&&(1!=s.startOffset||v.prev().length||(v.before("​"),s.setStartBefore(v.parent()),m.setSingleRange(s)))),b.get("children").length){var x=window.getSelection().anchorNode.childNodes,C=window.getSelection().anchorOffset,k=C>0?x[C-1]:null,S=C<x.length?x[C]:null,T=o.findNodeByElem(k?o.getMarkElem(k):[]),E=o.findNodeByElem(S?o.getMarkElem(S):[]);if(e=e.replace("​",""),c.isType(E,l.TYPE.table)){o.undo.completeSnap(!0),r=r||d.makeEmptyCommand();F=new c({type:l.TYPE.paragraph,text:e,in:E.get("in")});E.insert(F,!0),d.addUndoForInsert(r,F),o.findElemById(E.id).before(F.toHTML()),o.selection.restoreSelection(o.findElemById(F.id)[0],e.length),p=F}else if(c.isType(T,l.TYPE.table)){o.undo.completeSnap(!0),r=r||d.makeEmptyCommand();var F=new c({type:l.TYPE.paragraph,text:e,in:T.get("in")});T.insert(F),d.addUndoForInsert(r,F),o.findElemById(T.id).after(F.toHTML()),o.selection.restoreSelection(o.findElemById(F.id)[0],e.length),p=F}else E?(E=E.getVeryFirst(),o.undo.snap(E.cid,h.ADD),E.set("text",e+E.safeGetStrAttr("text",!0)),o.findElemById(E.id).replaceWith(E.toHTML()),E&&o.selection.jumpInto(o.findElemById(E.id),1),r=null):T&&(T=T.getVeryFirst(!0),o.undo.snap(T.cid,h.ADD),T.set("text",T.safeGetStrAttr("text",!0)+e),o.findElemById(T.id).replaceWith(T.toHTML()),o.selection.jumpIntoElemEnd(o.findElemById(T.id)),r=null);r&&r.redo.push(this.buildUndo()),!n&&o.refocus(p.id),t&&t.preventDefault()}else s.collapsed&&!File.isMac&&(f=o.UserOp.hanldePair(o,e,b,w,r,s))?("object"==typeof f&&(r=f),t&&t.preventDefault()):r&&(o.UserOp.insertInlineText(o,b,e,w.start,r,!0),d.append(r,o.undo.completeSnap(!0,!0)),t&&t.preventDefault());return!n&&r&&this.editor.undo.register(r),r}catch(e){}},getPosBookmark:function(){var e=editor.getMarkElem();if(e.length){var t=this.editor.fences.queue[e.attr("cid")];return t?{isCm:t,cid:t.cid,start:t.indexFromPos(t.getCursor())}:{isCm:!1,cid:e.attr("cid"),start:this.getRangy().getBookmark(e[0]).start}}},getRangy:function(e){var t=this.rangy.getSelection(),n=t.rangeCount?t.getRangeAt(0):null;return n&&(n.isBackward=t.isBackward(),e&&this.deRange(n)),n},buildUndo:function(e){var t={};if(t.type="cursor",this.editor.sourceView.inSourceMode)return t.pos=this.editor.sourceView.cm.getCursor(),t.inSourceMode=!0,t;try{e=e||this.getRangy();var n=this.editor.getMarkElem(e?e.commonAncestorContainer:void 0);if(n.children(".CodeMirror").length){var i=n.children(".CodeMirror")[0].CodeMirror;t.id=i.cid,t.pos=i.getCursor(),t.selections=i.listSelections()}else if(n.attr("mdtype")&&n.children("[tabindex]").andSelf("[tabindex]").length)t.id=n.attr("cid"),t.focus=n.attr("mdtype");else{if(!e)return null;var r=this.editor.getMarkElem(this.getDetailPos(e.startContainer,e.startOffset)[0]),o=this.editor.getMarkElem(this.getDetailPos(e.endContainer,e.endOffset)[0]),a=e.getBookmark(r[0]);if(r===o){if(t.id=r.attr("cid"),!t.id)return null;t.start=a.start,t.end=a.end}else{if(t.startId=r.attr("cid"),t.endId=o.attr("cid"),!t.startId||!t.endId)return null;t.start=a.start,t.end=e.getBookmark(o[0]).end}}}catch(e){return e.stack,null}return t},selectNode:function(e,t){(t=t||editor.findElemById(e.id)).length&&void 0!==t.attr("tabindex")&&(window.getSelection().removeAllRanges(),t.addClass("onfocus"),t.focus())},extendToLineEdge:function(e){var t=this.editor.getMarkElem()[0],n=this.getRangy();if("TEXTAREA"!=event.target.tagName&&"INPUT"!=event.target.tagName&&n&&t){var i=n.getBookmark(t),r=a.createRange();e?i.end=t.textContent.length:i.start=0,r.moveToBookmark(i),this.setRange(r)}},extendCharFromCollapse:function(e,t){var n,i=!1,r=!t;if(e.commonAncestorContainer.nodeType==document.TEXT_NODE&&(t&&e.startOffset>0&&(e.setStart(e.startContainer,e.startOffset-1),e.startOffset>0&&(n=e.toString().charCodeAt(0))>=56320&&n<=57343&&(e.setStart(e.startContainer,e.startOffset-1),(n=e.toString().charCodeAt(0))>=55296&&n<=56319||e.setStart(e.startContainer,e.startOffset+1)),i=!0),r&&e.endOffset<e.commonAncestorContainer.textContent.length&&(e.setEnd(e.endContainer,e.endOffset+1),(n=e.toString().charCodeAt(e.toString().length))>=55296&&n<=56319&&e.endOffset<e.commonAncestorContainer.textContent.length&&e.setEnd(e.endContainer,e.endOffset+1),i=!0)),!i){var o=this.editor.getMarkElem(e.startContainer)[0],a=e.getBookmark(o);if(t&&0===a.start||r&&a.end>=o.textContent.length)return!1;t?a.start--:a.end++,e.moveToBookmark(a)}return e},moveLeftOrRight:function(e,t){var n=this.editor.getMarkElem()[0],i=this.getRangy(),r=this.editor;if("TEXTAREA"!=t.target.tagName&&"INPUT"!=t.target.tagName&&i&&n){var s;if(!(s=o(t.target).closest("[mdtype='table_cell']")).length||s.closest("th").length&&!s.closest("th").prev().length){var l=i.getBookmark(n),c=a.createRange();if(t&&!t.metaKey){if(e&&0===l.start)return this.moveUpOrDown(!0,t,!0);if(!e&&l.end>=n.textContent.length&&(!n.classList.contains("md-def-link")||0!=r.getJQueryElem(i.startContainer).closest(".md-def-title").length))return this.moveUpOrDown(!1,t,!0)}if(File.isNodeHtml&&!e&&t&&t.ctrlKey&&!t.shiftKey){var d=n.textContent.substring(l.end)||"";if(/^\w+$/.exec(d))return l.start=l.end=n.textContent.length,c.moveToBookmark(l),this.setRange(c),t.preventDefault(),!0}return e?(l.end=l.start,l.start--):(l.start=l.end,l.end++),c.moveToBookmark(l),/\u200b|\007F/g.exec(c.toString())?(c.collapse(e),this.setRange(c),!0):!function(t){return o(e?t.startContainer:t.endContainer).closest(".md-inline-math").addClass("md-expand").length}(c)||t.ctrlKey||t.metaKey||t.altKey?void 0:(c.collapse(e),this.setRange(c),t&&t.preventDefault(),!0)}}},addUnholdable:function(e,t,n,i){this.editor.undo.completeSnap(!0);var r=function(e,t,n){var i=u.paragraph;e.get("type")==u.list_item&&(i=u.list_item);var r=new c({type:i});return e.insert(r,t),c.normalizeNode(r),r}(e,n),a=this.editor.findElemById(e.id),s=n?e:void 0,l=n?void 0:e;return n?a.before(r.toHTML()):a.after(r.toHTML()),t=t||this.editor.undo.UndoManager.makeEmptyCommand(),o(".unholdable").removeClass("unholdable"),this.editor.findElemById(r.id).addClass(i?"":"unholdable"),this.editor.undo.UndoManager.addUndoForInsert(t,r,l,s),t.discardable=!0,r},moveUpOrDown:function(e,t,n){function i(e,t){return c.isType(e,c.TYPE.hr,c.TYPE.toc)&&(!t||t[0].hasAttribute("tabindex"))}function r(e,t){return t?c.isType(e,u.fences,u.table,u.math_block,u.hr,u.toc):c.isType(e,u.fences,u.table,u.math_block,u.hr,u.toc,u.def_footnote,u.def_link)}function a(e,t){if(c.isType(e,u.fences,u.table,u.hr,u.def_link,u.def_footnote))return e;var n=t?"before":"after";return e.get("parent")?e.get("parent").get(n)?e:e.get(n)?e:a(e.get("parent")):e}function s(e,t,n){var i=e.getVeryFirstBrotherIncludeTopBlock(t),o=b.editor.undo.UndoManager.makeEmptyCommand();return(!w&&!i&&!e.get(t?"before":"after")||r(e)&&r(i,!0))&&(t&&c.isType(e,e.TYPE.meta_block)||(i=b.addUnholdable(a(e),o,t))),o.undo.push(b.buildUndo()),n&&n(),t?x?b.jumpIntoElemBegin(b.editor.findElemById(i.id),!0):b.jumpIntoElemEnd(b.editor.findElemById(i.id),!0):b.jumpIntoElemBegin(b.editor.findElemById(i.id),!0),o}function h(e,t,n){e.hasClass("unholdable")&&t&&(e.text().length||e.children(".md-line").length>1?e.removeClass("unholdable"):(b.editor.undo.UndoManager.addUndoForRemove(n,t),n.redo.push(b.buildUndo()),t.remove(),e.remove(),b.editor.undo.register(n)))}function p(e,n){T=s(e.getClosetBlock(),n),t&&t.preventDefault(),b.editor.undo.UndoManager.isEmptyCommand(T)||(T.redo.push(b.buildUndo()),b.editor.undo.register(T)),b.scrollAdjust()}function f(e){e&&(e.codemirrorIgnore=!0,e.preventDefault(),e.stopPropagation())}function m(e,n,i){var r=i||b.editor.fences.getCm(e.id),a=(r.doc.getCursor(),!i&&document.activeElement===C[0].querySelector("input.mode")),l=n&&0==r.doc.getCursor().line,c=!n&&r.doc.getCursor().line==r.lineCount()-1;x&&(l=!0),!i&&o(".autoComplt-list").is(":visible")||(n&&a?b.editor.fences.jumpCmEnd(C.attr("cid")):!c||i||a?(l||c||!n&&a)&&(T=s(e,n,function(){r.getInputField().blur()}),f(t),n&&!b.editor.undo.UndoManager.isEmptyCommand(T)&&(T.redo.push(b.buildUndo()),b.editor.undo.register(T))):(r.getInputField().blur(),f(t),setTimeout(function(){C.find("input.mode").focus()},10)),t&&t.stopPropagation())}function g(e){var t=e[0];return t.childElementCount>0&&function(){for(var e=0;e<t.childElementCount;e++)if(t.children[0].getAttribute("md-inline")!==u.image)return!1;return!0}()}var y,b=this,w=t&&c.isType(d[t.keyCode||t.which],"Right","Left"),x=File.isNode&&t&&t.ctrlKey&&!t.shiftKey;try{var C=this.editor.getMarkElem(),k=C.attr("mdtype"),S=this.editor.findNodeByElem(C),T=b.editor.undo.UndoManager.makeEmptyCommand();if(!S)return;if(i(S,C)||C.hasClass("rawedit"))p(S,e);else if(k==l.TYPE.fences)m(S,e);else if(k==l.TYPE.math_block&&this.editor.mathBlock.currentCm)m(S,e,this.editor.mathBlock.currentCm);else if(C.closest(".td-span").length){var E=function(e,t){var n,i=e.closest("td"),r=i.prevAll().length+1;if(!i.length){if(t)return[];r=(i=e.closest("th")).prevAll().length+1}return"TD"==i[0].tagName?(n=i.closest("tr")[t?"prev":"next"]().find("td:nth-child("+r+")>.td-span"),t&&!n.length&&(n=i.closest("tbody").prev().find("tr:last > th:nth-child("+r+") > .td-span")),n):t?[]:i.closest("thead").next().find("tr:first > td:nth-child("+r+")>.td-span")}(C.closest(".td-span"),e);if(E.length)t&&t.preventDefault(),e?this.jumpIntoElemEnd(E):this.jumpIntoElemBegin(E),this.scrollAdjust(void 0,void 0,!0);else{if(w)return f(t),!1;p(S,e)}}else if(C.closest(".md-meta-block").length&&!e)!C.text().substring(window.getSelection.focusOffset).match(/\S+\n+/)&&p(S,e);else{var F=S.getClosetBlock(!0).getVeryFirstBrotherIncludeTopBlock(e);if(T.undo.push(this.editor.lastCursor),function(e,t,n){if((n=n||this.getRangy()).collapsed){if(!(y=v(n.nativeRange))||!e.length)return 0==e.text().length;var i=e[0].getBoundingClientRect();return t?i.bottom-y.bottom<parseInt(e.css("paddingBottom"))+10:y.top-i.top<parseInt(e.css("paddingTop"))+10}}.call(this,C,!e))F?function(r,a,s){var l=b.editor.findElemById(r.id);if(h(a.closest(".unholdable"),S.getClosetParagraphLevel(),s),c.isType(r,u.fences))(d=b.editor.fences.getCm(r.id)).focus(),d.execCommand(e?"goDocEnd":"goDocStart"),b.editor.refocus();else if(c.isType(r,u.table,u.table_row,u.table_cell))b.jumpIntoElemBegin(l),f(t);else if(c.isType(r,u.math_block)){var d=b.editor.mathBlock.startEditing(l,!0);d.focus(),d.execCommand(e?"goDocEnd":"goDocStart"),b.editor.refocus()}else if(i(r))f(t),window.getSelection().removeAllRanges(),editor.findElemById(r.id).focus(),editor.refocus();else if(g(l))f(t),l.find("img:first").trigger("click");else if(c.isType(r,u.line,u.paragraph,u.heading,u.def_link,u.def_footnote)&&!r.get("text"))b.jumpIntoElemBegin(l),t&&t.preventDefault();else if(c.isType(r,u.meta_block)&&e)b.jumpIntoElemEnd(l),t&&t.preventDefault();else if(l.length){if(n)e?b.jumpIntoElemEnd(l):b.jumpIntoElemBegin(l);else{editor.selection.scrollAdjust(l,void 0,!0,!0);var p,m,v=l[0].getBoundingClientRect();e?(p=v.bottom-parseInt(l.css("paddingBottom"))-1,m=document.caretRangeFromPoint(v.right-1,p)):(p=v.top+parseInt(l.css("paddingTop"))+1,m=document.caretRangeFromPoint(v.left+1,p)),!m||m.commonAncestorContainer.parentElement.querySelector("[cid]")?e?b.jumpIntoElemEnd(l):b.jumpIntoElemBegin(l):b.setRange(m)}File.isFocusMode&&(o(".md-focus").removeClass("md-focus"),l.addClass("md-focus")),f(t)}}(F,C,T):!e&&C.text().trim().length&&p(S,e);else if(File.isTypeWriterMode&&File.option.scrollWithCursor&&y&&y.left){var _=y.left,M=e?y.top-9:y.bottom+9,N=document.caretRangeFromPoint(_,M);this.editor.writingArea.contains(N.startContainer)&&v(N).top!=y.top&&(this.setRange(N),f(t))}}}catch(e){e.message}},click:function(e,t,n){window.getSelection().removeAllRanges();var i=document.createEvent("MouseEvent"),r=document.elementFromPoint(e,t);n="click",i.initMouseEvent(n,!0,!0,window,null,e,t,0,0,!1,!1,!1,!1,0,null),r.dispatchEvent(i)},jumpDefComponent:function(e){var t=this.editor.getMarkElem(),n=a.createRange();e?(n.selectNodeContents(t.children(".md-def-name")[0]),this.deRange(n,!0)):(n.selectNodeContents(t.children(".md-def-content")[0]),this.deRange(n,!0)),this.editor.refocus()},jumpSelection:function(){return this.scrollAdjust(null,20)},jumpTop:function(e){var t=this.editor;if(t.sourceView.inSourceMode)t.sourceView.cm.execCommand("goDocStart");else{var n=this.getRangy();e&&n?(n.setStart(t.writingArea,0),this.deRange(n,!0)):this.jumpIntoElemBegin(this.editor.findElemById(this.editor.nodeMap.getFirst().cid)),File.isTypeWriterMode||o("content").animate({scrollTop:0},"100","swing",function(){t.docMenu.highlightVisibleHeader()})}},jumpBottom:function(e){var t=this.editor;if(t.sourceView.inSourceMode)t.sourceView.cm.execCommand("goDocEnd");else{var n=this.getRangy();if(e&&n){n.setEnd(t.writingArea,t.writingArea.childNodes.length),n=this.deRange(n,!0);try{n.endContainer.parentElement.classList.contains("md-def-title")&&""==n.endContainer.parentElement.textContent&&(n.setEndAfter(n.endContainer.parentElement.previousSibling.previousSibling),n=this.deRange(n,!0))}catch(e){}}else this.jumpIntoElemEnd(this.editor.findElemById(this.editor.nodeMap.getLast().getVeryFirst(!0).cid));File.isTypeWriterMode||o("content").animate({scrollTop:document.querySelector(this.editor.sessionStr).scrollHeight-window.innerHeight},"100","swing",function(){t.docMenu.highlightVisibleHeader()})}},lockScroll:function(){p=!0},unlockScroll:function(){p=!1},typeWriterScroll:function(e,t,n){function i(e){return(0!=e.top||0!=e.bottom)&&(e=e.top-m/2+r.defaultTextHeight/2,Math.abs(e)>2&&(n?o("content").animate({scrollTop:o("content").scrollTop()+e},120,"swing",n):o("content").scrollTop(o("content").scrollTop()+e)),!0)}p=!1;var r=this.editor;if(File.isTypeWriterMode){var a;if(t)return void((a=e.jquery&&e.length&&e[0].getBoundingClientRect())&&(a=document.caretRangeFromPoint((a.left+a.right)/2,a.bottom-10),this.typeWriterScroll(a)));if(!e||e.getBoundingClientRect)return void((a=e||window.getSelection().rangeCount&&window.getSelection().getRangeAt(0))&&i(a.startContainer.nodeType==document.TEXT_NODE&&a.startContainer.parentElement.hasAttribute("cid")?a.startContainer.parentElement.getBoundingClientRect():v(a)));e.jquery&&e.length&&i(e[0].getBoundingClientRect())}},scrollAdjust:function(e,t,n,i){function a(e){o("content").scrollTop(e),h.docMenu.highlightVisibleHeader(),r()}if(this.editor.sourceView&&this.editor.sourceView.inSourceMode)this.editor.sourceView.scrollAdjust();else{if(File.isTypeWriterMode&&!i)return this.typeWriterScroll(e);try{var s,l,c,d=window.innerHeight,u=o("content").scrollTop(),h=this.editor,p=e&&e.jquery&&e.closest("[mdtype='heading']").toArray();if(e&&e.jquery){if(!e.length)return;s=e.offset().top+u}else if(e&&void 0!==e.startContainer)s=(e.nativeRange||e).getClientRects()[0].top+u;else{if(o(document.activeElement).closest(".CodeMirror-focused").find(".CodeMirror-selected").length)return this.scrollAdjust(selectedCodeMirrorDom);(l=window.getSelection().getRangeAt(0))?((c=l.getClientRects()[0])||(c=l.endContainer.nodeType===document.TEXT_NODE?l.endContainer.parentElement.getClientRects()[0]:l.endContainer.getClientRects()[0]),s=c.top+u):s=o(document.activeElement).offset().top}var f=(File.isNodeHtml?o("#top-titlebar").height():document.body.classList.contains("mac-seamless-mode")?30:0)+(o("#md-searchpanel:visible").height()||0);void 0!=t?o("content").animate({scrollTop:s-t-f},"500","swing",function(){h.docMenu.highlightVisibleHeader(p)}):s>d+u-(n?70:140)+f?a(s-d+(n?70:140)):s<u+f?a(s-f-(n?70:140)):h.docMenu.highlightVisibleHeader()}catch(e){}}},selectAllElem:function(e){if(this.editor.sourceView.inSourceMode)this.editor.sourceView.cm.execCommand("selectAll");else{if(o("body").hasClass("typora-sourceview-on"))return this.editor.sourceView.cm.execCommand("selectAll");o(".md-math-after-sym").text("​");var t=a.createRange();e.children().length?(t.setStart(e.children()[0]),t.setEndAfter(e.children()[e.children().length-1])):t.selectNode(e[0]),this.deRange(t,!0)}},selectAll:function(e){if(this.editor.sourceView.inSourceMode)this.editor.sourceView.cm.execCommand("selectAll");else if(o(".md-math-after-sym").text("​"),document.activeElement&&c.isType(document.activeElement.tagName,"INPUT"))document.activeElement.select();else{var t=this.editor.getMarkElem(),n=a.createRange();if(t.hasClass("rawedit"))e||(n.selectNode(t[0]),this.setRange(n));else if(t.hasClass("md-fences")){var i=t.attr("cid");e||this.editor.fences.getCm(i).execCommand("selectAll")}else{if(e&&"INPUT"==e.target.tagName)return!0;t.closest('[mdtype="table"]').length?(this.selectAllElem(t.closest("[mdtype='table_cell']")),e&&e.preventDefault()):t.closest(".md-meta-block").length?(this.selectAllElem(t.closest("[mdtype='meta_block']")),e&&e.preventDefault()):(o(this.editor.sessionStr).addClass("md-expand"),o(".footnotes, .md-fences, .task-list, .hr, .mathjax-block").attr("contenteditable",!0),n.setStart(o(this.editor.sessionStr).children()[0]),o(this.editor.sessionStr).children()[0].classList.contains("md-hr")&&n.setStart(o(this.editor.sessionStr).children()[1]),n.setEndAfter(o(this.editor.sessionStr).children().last()[0]),o(this.editor.sessionStr).removeClass("md-expand"),this.deRange(n,!0),e&&e.preventDefault(),setTimeout(function(){o(".footnotes, .md-fences, .task-list, .hr, .mathjax-block").attr("contenteditable",!1)},10))}this.editor.lastCursor=this.buildUndo()}},getEndNode:function(e){return this.getDetailPos(e.endContainer,e.endOffset)[0]},getDetailPos:function(e,t,n){function i(e){1===e.nodeType&&0===e.childNodes.length&&e.appendChild(document.createTextNode(""))}function r(e){if(i(e),e.childNodes.length)return e.childNodes.length;if(3===e.nodeType)return e.textContent.length;if(void 0!==e.length)return e.length;throw o}var o={};if(1==e.nodeType){var a=e.childNodes;if(e.classList.contains("md-image")&&2===t&&(t=1),i(e),!a||!a.length)return[e,t];try{var s=a[t]&&a[t].getAttribute&&"checkbox"===a[t].getAttribute("type");return n?(s&&t++,t==a.length?this.getDetailPos(a[t-1],r(a[t-1])):this.getDetailPos(a[t],0,!0)):0==t?(s&&t++,this.getDetailPos(a[t],0)):this.getDetailPos(a[t-1],r(a[t-1]))}catch(n){return[e,t]}}return[e,t]},deRange:function(e,t){var n=e.cloneRange();try{var i=this.getDetailPos(e.startContainer,e.startOffset,!0),r=this.getDetailPos(e.endContainer,e.endOffset,!1);return t&&i[0].parentElement&&"HR"==i[0].parentElement.tagName&&(i[0]=i[0].parentElement.parentElement),e.setStart.apply(e,i),e.setEnd.apply(e,r),t&&this.setRange(e),e}catch(e){}return n},selectLine:function(){var e,t;if(this.editor.sourceView.inSourceMode)return e=this.editor.sourceView.cm,t=e.getCursor(),void e.setSelection(s.Pos(t.line,0),s.Pos(t.line,e.getLine(t.line).length));var n=o(document.activeElement).closest(".CodeMirror");if(n.length)return e=n[0].CodeMirror,t=e.getCursor(),void e.setSelection(s.Pos(t.line,0),s.Pos(t.line,e.getLine(t.line).length));if(document.activeElement&&c.isType(document.activeElement.tagName,"INPUT"))document.activeElement.select();else{if(window.getSelection().rangeCount){var i=window.getSelection(),r=this.editor.getMarkElem(i.commonAncestorContainer),l=a.createRange();if(r.length)if(r.closest("tr[mdtype='table_row']").length){var d=r.closest("tr[mdtype='table_row']");l.selectNode(d[0]),d.closest('[mdtype="table"]').attr("contenteditable",!0),this.deRange(l,!0),d.closest('[mdtype="table"]').attr("contenteditable",!1)}else{r.addClass("md-expand-on-selection"),window.getSelection().modify("move","backward","sentence"),window.getSelection().modify("extend","forward","sentence"),l=this.getRangy();var u=o(l.commonAncestorContainer).closest(".md-meta");u.length?this.selectAllElem(u.closest("[md-inline]")):(u=this.editor.getMarkElem(l.startContainer)).length&&u[0]!==this.editor.getMarkElem(l.endContainer)[0]&&(l.setEndAfter(u[0]),this.deRange(l,!0)),r.removeClass("md-expand-on-selection")}}this.editor.brush.updateWordCountInSelection()}},selectWord:function(e,t,n){var i,r;if(this.editor.sourceView.inSourceMode)return i=this.editor.sourceView.cm,r=i.findWordAt(i.getCursor()),void i.extendSelection(r.anchor,r.head);this.selectWordTime=new Date;var a=o(document.activeElement).closest(".CodeMirror");if(a.length)return i=a[0].CodeMirror,r=i.findWordAt(i.getCursor()),void i.extendSelection(r.anchor,r.head);if(e){var s,l,c,d,u,h;if(n=n||this.getRangy()){if(s=o(n.commonAncestorContainer),(l=s.closest("[md-inline='url'], [md-inline='image'], [md-inline='refimg']")).length)return this.selectAllElem(l);if(l=s.closest("[md-inline='plain']"),u=n.getBookmark(l[0]),l.length)for(c="image"==e?/(([\w-_]+:\/\/)|(www\.)|\w*\/)?[\w-.\/?%&=:@]+(\.jpe?g|png|gif|webm|svg)/gi:/(([\w-_]+:\/\/)|(www\.)|\w*\/)[\w-.\/?%&=:@]*/gi,d=l.text();h=c.exec(d);)if(c.lastIndex-h[0].length<=u.start&&c.lastIndex>=u.end)return u.start=c.lastIndex-h[0].length,u.end=c.lastIndex,n.moveToBookmark(u),window.getSelection().removeAllRanges(),void this.rangy.getSelection().setSingleRange(n)}if("image"===e)return}if(File.isNodeHtml){window.getSelection().modify("move","forward","word"),window.getSelection().modify("extend","backward","word"),n=n||this.getRangy();var p=/[\(\)\[\]\^&_\-+*#@!~`\\\/\{\}'":;<>,.?% ]+$/g.exec(n.toString());p&&n.toString()!=p[0]&&((u=n.getBookmark(n.commonAncestorContainer.children?n.commonAncestorContainer:n.commonAncestorContainer.parentElement)).end-=p[0].length,n.moveToBookmark(u),this.rangy.getSelection().setSingleRange(n))}else{var f=window.getSelection().toString();if(t)return n=n||this.getRangy(),void(/\S\s$/.exec(f)&&n.endContainer.nodeType==document.TEXT_NODE&&(n.setEnd(n.endContainer,Math.max(n.endOffset-1,0)),n.select(n.isBackward)));window.getSelection().modify("move","forward","word"),window.getSelection().modify("extend","backward","word")}this.editor.brush.updateWordCountInSelection()},selectPhrase:function(){function e(t){return t?t.nodeType===t.ELEMENT_NODE?t.hasAttribute("md-inline")&&t.getAttribute("md-inline")!==u.plain?t:t.hasAttribute("mdtype")?t:t.classList.contains("md-def-name")||t.classList.contains("md-def-content")||t.classList.contains("md-def-title")?t:e(t.parentElement):t.nodeType===t.TEXT_NODE?e(t.parentElement):null:null}if(this.editor.sourceView.inSourceMode){var t=this.editor.sourceView.cm,n=t.findWordAt(t.getCursor());t.extendSelection(n.anchor,n.head)}else if(document.activeElement&&c.isType(document.activeElement.tagName,"INPUT"))document.activeElement.select();else{var i,r=this.getRangy(!0),a=!1;if(r){if(this.editor.styleBookmark.style){var s=this.editor.styleBookmark.style.block;if(s.indexOf(u.def_footnote)>-1||s.indexOf(u.def_link)>-1?/md-def-(name|url|title)|/gi.exec(document.activeElement.className)&&(a=!0,i=o(r.startContainer).closest(".md-def-name, .md-def-url, .md-def-title")[0]):s.indexOf(u.table)>-1&&(a=!0,i=o(r.startContainer).closest("[mdtype='table_cell']")[0]),i=i||e(r.startContainer))return function(e,t,n){e.getAttribute("md-inline")==u.image&&(n=!1,e=e.children[0]),n?t.selectNodeContents(e):(t.selectNode(e),editor.selection.deRange(t))}(i,r,a),this.setRange(r)}return this.selectWord()}}},isCrossBlock:function(e){return(e=e||this.getRangy())?!e.collapsed&&this.editor.getJQueryElem(e.commonAncestorContainer).find("[mdtype]").length:e},getTextAround:function(){var e,t,n=this.getRangy();if(n&&n.collapsed){var i=o(n.startContainer).closest("[md-inline='plain'], .md-lang")[0],r=n.getBookmark(i);if(i)return n.setStartBefore(i),e=n.toString(),n.collapse(!1),n.setEndAfter(i),t=n.toString(),n.setStart(i,0),[e,t,r]}return[]},getCharCountInSelection:function(e){return(e=e||this.getTextInSelection()).length},getWordCountInSelection:function(e){var t=this.editor.EditHelper.getWordCount(e||this.getTextInSelection());return Math.min(t,this.editor.brush.wordCount)},getTextInSelection:function(){var e=o(document.activeElement).closest(".CodeMirror");if(e.length)return e[0].CodeMirror.getSelection();var t=self.editor.selection.getRangy();return t&&!t.collapsed&&o(t.commonAncestorContainer).closest("#write").length?o(o.parseHTML("<div>"+t.toHtml()+"</div>")).find("[mdtype]").after("\n").filter(".md-toc").text("[toc]").end().filter(".mathjax-block").text(function(){return o(this).children("script").html()}).end().find(".CodeMirror-gutter-wrapper").remove().end().end().text():""}};var v=function(e){var t=e.getClientRects(),n=t.length&&t[t.length-1];return!n&&e.collapsed?(e.startContainer.nodeType==document.TEXT_NODE?e.startContainer.parentElement:e.startContainer).getBoundingClientRect():n};n.exports=h,n.exports.buildRange=function(e,t,n){function i(e){if(3==e.nodeType){var a=r+e.textContent.length;if(!s&&t>=r&&t<=a&&(o.setStart(e,t-r),s=!0),s&&n>=r&&n<=a)throw o.setEnd(e,n-r),l;r=a}else for(var c=0,d=e.childNodes.length;c<d;++c)i(e.childNodes[c])}if(!e)return window.getSelection().removeAllRanges();var r=0,o=a.createRange(),s=!1,l={};o.collapseToPoint(e,0);try{i(e)}catch(e){if(e==l)return o;throw e}},n.exports.rangy=a}),define("app/editor/TableEdit",["jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/editor/UndoManager","app/editor/polyfill","app/editor/KeyMaster"],function(e,t,n){"use strict";function i(){r("#typora-table-row-tracker, #typora-table-col-tracker").hide().find(".typora-table-data-area").html("")}var r=e("jquery/jquery"),o=e("exoskeleton-master/exoskeleton"),a=e("app/document/Node"),s=a.TYPE,l=a.Node,c=e("app/editor/UndoManager"),d=(e("app/editor/polyfill"),e("app/editor/KeyMaster").map),u=99,h=20,p=o.Model.extend({initialize:function(e){function t(t){function n(){r(this).val().trim().length||r(this).val(2);var e=i.find("#md-grid-width").val(),t=i.find("#md-grid-height").val();i.find("a.md-active").removeClass("md-active"),i.find("tr:nth-child(-n+"+t+")>td:nth-child(-n+"+e+")>a").addClass("md-active")}var i,o='<div class="popover bottom md-table-resize-popover" style="display:block; bottom:auto; top:20px; margin-left:-10px;" contenteditable="false">\t\t\t\t\t<div class="arrow" style="left:20px;"></div>\t\t\t\t\t<div class="md-grid-board-wrap md-reset code-tooltip-content">\t\t\t\t\t\t<table role="grid" class="md-grid-board md-reset">\t\t\t\t\t\t\t<tbody>\t\t\t\t\t\t\t\t<tr class="md-reset" row="1">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="2">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="3">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="4">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="5">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="6">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="7">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="8">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="9">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t\t<tr class="md-reset" row="10">\t\t\t\t\t\t\t\t\t<td class="md-reset" col="1"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="2"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="3"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="4"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="5"><a href="#"></a></td>\t\t\t\t\t\t\t\t\t<td class="md-reset" col="6"><a href="#"></a></td>\t\t\t\t\t\t\t\t</tr>\t\t\t\t\t\t\t</tbody>\t\t\t\t\t\t</table>\t\t\t\t\t\t<div class="popover-title">\t\t\t\t\t\t\t<input id="md-grid-width" type="text"  max="20" size="2" min="1" value="0" /> x <input id="md-grid-height" maxlength="2" size="2" min="1" value="0"/><button id="md-resize-grid" class="btn btn-primary btn-xs">'+r.localize.getString("OK")+"</button>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t</div>",a=t.closest('[mdtype="table"]'),s=e.findNodeByElem(a),l=s.get("align").length,c=a.children("tbody").children("tr").length+1;r(".md-table-resize-popover").remove(),t.append(o),(i=t.find(".md-table-resize-popover")).find("tr:nth-child(-n+"+c+")>td:nth-child(-n+"+l+")").addClass("md-grid-ext"),i.find("#md-grid-width, #md-grid-height").off("keydown keypress").on("keypress",function(e){if(!/\d/.exec(String.fromCharCode(e.which)))return!1}).on("keydown",function(e){var t=e.keyCode||e.which;return"Up"===d[t]?(this.value=this.value-0+1,this.value=Math.min("md-grid-height"==this.getAttribute("id")?u:h,this.value),!1):"Down"===d[t]?(this.value=this.value-1,this.value=Math.max(2,this.value),!1):void 0}),i.find("#md-grid-width").val(l).off("blur focus").blur(n).focus(function(){i.find("#md-resize-grid").show()}).blur(function(){this.value>h?this.value=h:this.value<2&&(this.value=2)}).on("keydown",function(e){var t=e.keyCode||e.which;if("Tab"===d[t]&&!e.ctrlKey)return i.find("#md-grid-height").focus(),!1;"Enter"===d[t]&&i.find("#md-grid-height").focus()}),i.find("#md-grid-height").val(c).off("blur focus").blur(n).focus(function(){i.find("#md-resize-grid").show()}).blur(function(){this.value>u?this.value=u:this.value<2&&(this.value=2)}).on("keydown",function(e){var t=e.keyCode||e.which;if("Tab"===d[t]&&!e.ctrlKey)return i.find("#md-grid-width").focus(),!1;"Enter"===d[t]&&i.find("#md-resize-grid").click()}),i.find(".md-grid-board a").off("mouseenter mouseleave click").hover(function(){var e=r(this).closest("td"),t=e.prevAll().length+1,n=e.closest("tr").prevAll().length+1;n=1===n?2:n,i.find("a.md-active").removeClass("md-active"),i.find("tr:nth-child(-n+"+n+")>td:nth-child(-n+"+t+")>a").addClass("md-active"),i.find("#md-grid-width").val(t),i.find("#md-grid-height").val(n),i.find("#md-resize-grid").hide()}).click(function(e){e.stopPropagation(),e.preventDefault(),i.find("#md-resize-grid").click()}),i.find("#md-resize-grid").off("click").click(function(t){var n,r=i.find("#md-grid-width").val(),o=i.find("#md-grid-height").val(),l=s.getFirstChild(),c=s.get("align").length,d=0,u=e.undo.UndoManager.makeEmptyCommand();for(u.undo.push(e.undo.buildReplaceUndo(s));l||d<o;)d<o?(l?p.resizeRow(l,r,s):l=p.newEmptyRowAfter(n,r,s),l=(n=l).get("after")):l&&(n=l,l=l.get("after"),n.delete()),d++;r<c?s.set("align",s.get("align").slice(0,r)):s.set("align",s.get("align").concat([].repeat(null,r-c))),a.replaceWith(s.toHTML()),F.showTableEdit(s),e.lastCursor?e.undo.exeCommand(e.lastCursor):window.getSelection().removeAllRanges(),u.redo.push(e.undo.buildReplaceUndo(s)),e.undo.register(u)})}function n(){var e=M.height();return M.closest("thead").length?"<table class='md-table' style='margin:0 ; padding:0; margin-left:0; height:"+e+"px;'><thead>"+M[0].outerHTML+"</thead></table>":"<table class='md-table' style='margin:0 ; padding:0; margin-left:0; height:"+e+"px;'><tbody>"+M[0].outerHTML+"</tbody></table>"}function o(e){var t=N[0].offsetWidth;return"<table class='md-table' style='margin:0 ; padding:0; height:"+_.height()+"px; width:"+t+"px;'><thead><tr>"+e[0].outerHTML+"</tr></thead><tbody>"+e.toArray().map(function(e,t){return t?"<tr style='width:"+e.offsetWidth+"px; height:"+e.offsetHeight+"px;'>"+e.outerHTML+"</tr>":""}).join("")+"</tbody></table>"}function a(e){if(!File.isLocked){A=!0,window.getSelection().removeAllRanges(),w();var t=M.children();r("#typora-table-row-tracker .typora-table-data-area").html(n()).find("td, th").each(function(e){this.style.width=t[e].offsetWidth+"px"}),B=e.offsetX,j=e.offsetY,P=I=M.closest("thead").length?0:M.prevAll().length+1,D=[];var i=_.offset().top;return M.closest("table").find("[mdtype='table_row']").each(function(){D.push(this.offsetTop+i)}),D.push(D.last()+_.find("tbody tr:last-child")[0].offsetHeight),!1}}function s(e){if(!File.isLocked){R=!0,window.getSelection().removeAllRanges();var t=x(P=I=O),n=r(t[0]).offset();r("#typora-table-col-tracker .typora-table-data-area").offset(n).html(o(t)),w(!0),B=e.offsetX,j=e.offsetY,D=[];var i=_.offset().left;_.find("thead:last-of-type th").each(function(){D.push(this.offsetLeft+i)}),D.push(D.last()+_.find("thead [mdtype='table_row'] th:last-child")[0].offsetWidth)}}function f(e){A?g(e):R&&m(e)}function m(e){if(R){r("#typora-table-col-tracker").css("left",e.clientX-B);var t,n=_.scrollLeft();(t=D.findIndex(function(t,i){return D[i]>e.clientX-B+n}))>0&&(t-=1),-1==t&&(t=D.length-1),I!=t&&y(I=t)}}function g(e){if(A){r("#typora-table-row-tracker").css("top",e.clientY-j-L+document.querySelector("content").scrollTop);var t;(t=D.findIndex(function(t,n){return D[n]>e.clientY-j}))>0&&(t-=1),-1==t&&(t=D.length-1),I!=t&&v(I=t)}}function v(e){var t;if(e>=D.length-1)(t=_.find("tbody tr:last-child").offset()).top+=_.find("tbody tr:last-child")[0].offsetHeight;else{var n=r(_.find("tr[mdtype]")[e]);if(n[0]==M[0]||!n.length)return void b();t=n.offset()}r("#typora-table-row-insert-marker").width(_[0].offsetWidth).show().offset(t)}function y(e){var t;if(e>=D.length-1)(t=_.offset()).left+=_[0].offsetWidth;else{if(P==e||P+1==e)return void b();t=x(e).offset()}_.find(".md-table-edit").remove(),r("#typora-table-col-insert-marker").height(_[0].offsetHeight).show().offset(t)}function b(){r(".typora-table-insert-marker").hide()}function w(e){r("#write").addClass("no-selection"),File.preventScroll=!0,e?(x(O).addClass("typora-on-moving"),r("#typora-table-row-tracker").hide()):(M.addClass("typora-on-moving"),r("#typora-table-col-tracker").hide())}function x(e){return _.find("[mdtype='table_row']>*:nth-child("+(e+1)+")")}function C(e){File.preventScroll=!1,r("#write").removeClass("no-selection"),r("content").removeClass("prevent-scroll"),r(".typora-on-moving").removeClass("typora-on-moving"),b()}function k(e){A?T(e):R&&E(e)}function S(){A=!1,R=!1,_=null,M=null,N=null,P=null,I=null}function T(e){if(A)return A=!1,C(),i(),F.moveTableRow(P,I,_),S(),!1}function E(e){if(R)return R=!1,C(),i(),F.moveTableCol(P,I,_),S(),!1}var F=this;this.editor=e,this.TableEdit=p,r(e.sessionStr).on("click",".md-align-gp button",function(t){var n,i=/md-align-\S+/g.exec(this.className)[0].substring(9),o=r(this).closest("th").prevAll().length-1,a=r(this).closest('[mdtype="table"]'),s=e.findNodeByElem(a);n=s.get("align")[o]==i?null:i,s.attr("align_idx",[o,n],e),t.stopPropagation(),e.lastCursor&&e.undo.exeCommand(e.lastCursor)}).on("click",".md-delete-table",function(){e.tableEdit.deleteTable(r(this).closest("[mdtype='table']"))}).on("click",".md-resize-table",function(n){r(this).next(".md-table-resize-popover").length?(r(".md-table-resize-popover").remove(),e.lastCursor&&e.undo.exeCommand(e.lastCursor)):t(r(this).parent()),n.stopPropagation()}).on("click",".md-table-edit",function(t){r(t.target).closest(".md-table-resize-popover").length||(r(".md-table-resize-popover").remove(),e.lastCursor&&r(".md-table-resize-popover").length&&e.undo.exeCommand(e.lastCursor)),t.stopPropagation()}).on("mousedown",".md-table-edit button",function(){File.editor.lastCursor=File.editor.selection.buildUndo()||File.editor.lastCursor}).on("refocus","[mdtype='table']",function(){r(document.activeElement).closest("[md-inline='image']").length||F.showTableEdit(r(this))}).on("mouseup",".md-table-edit",function(e){e.stopPropagation()}),function(){var t=r("#table-insert-dialog");t.find("#table-insert-col, #table-insert-row").off("keydown keypress keyup change").on("keypress",function(e){if(!/\d/.exec(String.fromCharCode(e.which)))return!1}).on("keydown",function(e){var t=e.keyCode||e.which;return"Up"===d[t]?(this.value=this.value-0+1,this.value=Math.min("table-insert-row"==this.getAttribute("id")?u:h,this.value),!1):"Down"===d[t]?(this.value=this.value-1,this.value=Math.max(2,this.value),!1):void 0}).on("keyup",function(){r(this).trigger("change")}).on("change",function(){File.isMac&&app.touchBar&&app.touchBar.updateInsertTableTouchBar()}),t.find("#table-insert-col").blur(function(){0===r(this).val().trim().length&&r(this).val(2),this.value>h?this.value=h:this.value<1&&(this.value=1)}).on("keydown",function(e){var n=e.keyCode||e.which;if("Tab"===d[n]&&!event.ctrlKey||"Enter"===d[n])return t.find("#table-insert-row").focus(),!1}),t.find("#table-insert-row").blur(function(){0===r(this).val().trim().length&&r(this).val(2),this.value>u?this.value=u:this.value<2&&(this.value=2)}).on("keydown",function(e){var n=e.keyCode||e.which;if("Tab"===d[n]&&!event.ctrlKey)return t.find("#table-insert-col").focus(),!1;"Enter"===d[n]&&t.find(".btn-primary").trigger("click")}),t.find(".btn-primary").click(function(){t.modal("hide"),e.restoreLastCursor(),r(File.editor.sessionStr).trigger("cursorChange");var n=new l({type:l.TYPE.table,in:e.nodeMap});p.valify(n,t.find("#table-insert-col").val(),t.find("#table-insert-row").val()),e.stylize.insertBlock(l.TYPE.table,n)})}(),r(e.sessionStr).on("keydown","[mdtype='table']",function(e){var t=e.keyCode||e.which;if("Tab"===d[t]&&!event.ctrlKey)return F.moveToNextCell(!0,e.shiftKey),!1;if("Enter"===d[t]){var n=F.editor.UserOp.backspaceHandler(F.editor,null,"delSelection");if(e.shiftKey)F.editor.UserOp.pasteHandler(F.editor,"<br />",!0);else if(File.isMacOrMacNode?e.metaKey:e.ctrlKey){var i=F.addRow(!1,F.editor.undo.commandStack.indexOf(n)>-1);c.append(n,i)}else F.moveToBeblowCell(c.isEmptyCommand(n));return!1}return File.isMac&&l.isType(d[t],"Left","Right","Up","Down")&&e.metaKey&&e.ctrlKey?("Up"==d[t]?F.moveRowUpOrDown(!0):"Down"==d[t]?F.moveRowUpOrDown(!1):"Left"==d[t]?F.moveColLeftOrRight(!0):"Right"==d[t]&&F.moveColLeftOrRight(!1),!1):File.isNode&&l.isType(d[t],"Left","Right","Up","Down")&&e.shiftKey&&e.ctrlKey?("Up"==d[t]?F.moveRowUpOrDown(!0):"Down"==d[t]?F.moveRowUpOrDown(!1):"Left"==d[t]?F.moveColLeftOrRight(!0):"Right"==d[t]&&F.moveColLeftOrRight(!1),!1):(File.isMacOrMacNode?e.metaKey:e.ctrlKey)&&("Left"===d[t]||"Right"===d[t])?(F.moveToNextCell(!1,"Left"===d[t],!0),!1):void 0});var _,M,N,L,A,R,I,P,O,D,B,j;setTimeout(function(){L=r("content").offset().top},200),function(){var t=r("#typora-table-row-tracker"),n=r("#typora-table-col-tracker");r(e.sessionStr).on("mouseenter click","th, td",function(e){if(0!=(N=r(this)).children("[mdtype]").length){M=N.closest("tr"),_=M.closest("[mdtype='table']"),O=N.prevAll().length;var i=M.offset(),o=N.offset();t.show().offset(i).find(".typora-table-drag-area").height(M[0].offsetHeight+1),o.top=_.offset().top,n.show().offset(o).find(".typora-table-drag-area").width(N[0].offsetWidth+1)}}),r(document).on("mousedown","#typora-table-row-tracker",a).on("mousedown","#typora-table-col-tracker",s).on("mousemove",f).on("mouseup",k)}()},moveTableRow:function(e,t,n){if(this.editor.undo.completeSnap(!0),e!=t&&e+1!=t){n=n||this.editor.getMarkElem().closest("[mdtype='table']");var i=this.editor,r=i.selection.buildUndo(),o=c.makeEmptyCommand(r),a=i.findNodeByElem(n),s=a.getNthChild(e);o.undo.push(c.buildReplaceUndo(a)),e<--t&&t--,s.detach(),t>=0?a.getNthChild(t).insert(s):a.getFirstChild().insert(s,!0),o.redo.push(c.buildReplaceUndo(a)),n.replaceWith(a.toHTML()),r&&(i.undo.exeCommand(r),o.redo.push(i.selection.buildUndo())),i.undo.register(o),this.showTableEdit(a)}},moveTableCol:function(e,t,n){this.editor.undo.completeSnap(!0),n=n||this.editor.getMarkElem().closest(".md-table");var i=this.editor,r=i.selection.buildUndo(),o=c.makeEmptyCommand(r),a=i.findNodeByElem(n),s=a.getFirstChild();if(e!=t&&e+1!=t){for(o.undo.push(c.buildReplaceUndo(a)),e<--t&&t--;s;){var l=s.getNthChild(e);l.detach(),t>=0?s.getNthChild(t).insert(l):s.getFirstChild().insert(l,!0),s=s.get("after")}o.redo.push(c.buildReplaceUndo(a)),n.replaceWith(a.toHTML()),r&&(i.undo.exeCommand(r),o.redo.push(i.selection.buildUndo())),i.undo.register(o),this.showTableEdit(a)}else this.showTableEdit(a)},moveRowUpOrDown:function(e){var t=this.editor.selection.getRangy();if(t&&!File.isLocked){var n=r(t.commonAncestorContainer).closest("[mdtype='table_row']").closest("tr");if(0!=n.length){var i=n.closest("thead").length?0:n.prevAll().length+1;e&&0==i||!e&&i&&0==n.nextAll().length||this.moveTableRow(i,e?i-1:i+2,n.closest("[mdtype='table']"))}}},moveColLeftOrRight:function(e){var t=this.editor.selection.getRangy();if(t&&!File.isLocked){var n=r(t.commonAncestorContainer).closest("[mdtype='table_cell']").closest("td, th");if(0!=n.length){var i=n.prevAll().length;e&&0==i||!e&&0==n.nextAll().length||this.moveTableCol(i,e?i-1:i+2,n.closest("[mdtype='table']"))}}},insertTable:function(){File.isLocked||(this.editor.lastCursor=this.editor.selection.buildUndo(),r("#table-insert-dialog").modal({keyboard:!0}),File.isMac&&app.touchBar&&app.touchBar.showInsertTableTouchBar(),setTimeout(function(){r("#table-insert-col").focus()},500))},resizeTableEdit:function(e,t,n){for(var i=i||this.editor,t=t||e.closest(".md-table"),r=(i.findNodeByElem(t.closest(".md-table-fig")),t.offset()),o=t.width(),a=[],s=t.find("thead:nth-child(2)>tr>th"),l=(t.parent().width(),t.find("thead:first>tr:first>th:first").outerWidth(!0),0);l<s.length;l++)a.push(s[l].offsetWidth),o-=a[l];s=e.find("th");for(l=0;l<s.length;l++)0!==l&&l!=s.length-1?(s[l].width=a[l-1],n&&n(s[l],l)):o-=s[l].offsetWidth;r.top-=e.height(),r.left+=o/2,e.offset(r)},showTableEdit:function(e){function t(e,t){"left"!==e&&"right"!==e&&"center"!==e||t.find(".md-align-"+e).addClass("active")}var n,i,o,a=e,s=e;e.jquery?a=editor.findNodeByElem(e):s=editor.findElemById(a.id),s.on("scroll",function(){r(".md-table-edit").remove()}),s.children(".md-table").length&&(s=s.children(".md-table")),s.children(".md-table-edit").length||(r(".md-table-edit").remove(),i=function(e){var t,n=e.get("align"),i=[],o=r.localize.getString("Align Left"),a=r.localize.getString("Align Center"),s=r.localize.getString("Align Right"),l=r.localize.getString("Resize Table"),c=r.localize.getString("Delete Table"),d='<div class="btn-group btn-group-xs md-align-gp"><button type="button" class="btn btn-default md-align-left" ty-hint="'+o+'" aria-label="'+o+'"><span class="glyphicon glyphicon-align-left"></span></button><button type="button" class="btn btn-default md-align-center" ty-hint="'+a+'" aria-label="'+a+'"><span class="glyphicon glyphicon-align-justify"></span></button><button type="button" class="btn btn-default md-align-right" ty-hint="'+s+'" aria-label="'+s+'"><span class="glyphicon glyphicon-align-right"></span></button></div>';for(i.push("<thead class='md-table-edit md-tooltip-remove' contenteditable='false' ><tr>"),i.push('<th class="md-th-button btn-group-xs md-resize-table-th"><button type="button" class="btn btn-default md-resize-table" ty-hint="'+l+'" aria-label="'+l+'"><span class="glyphicon glyphicon-th"></span></button></th>'),t=0;t<n.length;t++)i.push("<th>"),i.push(d),i.push("</th>");return i.push('<th class="md-th-button btn-group-xs"><button type="button" class="btn btn-default md-delete-table" ty-hint="'+c+'" aria-label="'+c+'"><span class="glyphicon glyphicon-trash"></span></button></th>'),i.push("</tr></thead>"),i.join("")}(a),n=a.get("align"),s.children("thead").before(i),o=s.children(".md-table-edit"),this.resizeTableEdit(o,s,function(e,i){t(n[i-1],r(e))}))},moveToNextCell:function(e,t,n){try{var i,r=this.editor.getMarkElem(window.getSelection().anchorNode).closest("[mdtype='table_cell']").parent(),o=(t?r.prev():r.next()).children("[mdtype='table_cell']");if(n){var a=this.editor.selection.getRangy().getBookmark(r[0]);if(t&&a.end>0)return this.editor.selection.jumpIntoElemBegin(r),this.editor.refocus();if(!t&&a.start<r.text().length)return this.editor.selection.jumpIntoElemEnd(r),this.editor.refocus()}!o.length&&r.length&&(i=r.parent(),(o=(t?i.prev().children(":last"):i.next().children(":first")).children("[mdtype='table_cell']")).length||(t&&"TD"===r[0].tagName?o=i.closest("table").find("thead:not(.md-table-edit)>tr>th:last>[mdtype='table_cell']"):t||"TH"!==r[0].tagName||(o=i.closest("table").find("tbody>tr:first>td:first>[mdtype='table_cell']")))),o.focus(),o.length&&(e?this.editor.selection.selectAllElem(o):t?this.editor.selection.jumpIntoElemEnd(o):this.editor.selection.jumpIntoElemBegin(o)),this.editor.refocus()}catch(e){}},moveToBeblowCell:function(e,t,n){try{var i=this.editor.getMarkElem(window.getSelection().anchorNode).closest("[mdtype='table_cell']"),r=this.editor.findNodeByElem(i),o=p.getNextCellInColumn(r,t),a=o&&this.editor.findElemById(o.cid);o?a.length&&(e?this.editor.selection.selectAllElem(a):t?this.editor.selection.jumpIntoElemEnd(a):this.editor.selection.jumpIntoElemBegin(a)):this.editor.selection.moveUpOrDown()}catch(e){}},getSibling:function(e,t,n){return p.getSibling(e,t,n)},unfocusAll:function(e){e?r(".md-table-edit").fadeOut(function(){r(".md-table-edit").remove()}):r(".md-table-edit").remove(),r(".typora-table-tracker").hide()},deleteRow:function(){p.deleteRow(this.editor)},addRow:function(e,t){return p.addRow(this.editor,e,t)},deleteCol:function(){p.deleteCol(this.editor)},addCol:function(e){p.addCol(this.editor,e)},copyTable:function(e){(e=(e=e||this.editor.getMarkElem(window.getSelection().anchorNode).closest("table")).clone()).find("td, th").attr("style","border: 1px solid rgb(204, 204, 204);min-height:1ch;min-width:4ch;");var t=e[0].outerHTML;this.editor.UserOp.setClipboard(t,"",e.text(),!0)},deleteTable:function(e,t){i(),editor.undo.completeSnap(!0),e=e||editor.getMarkElem(window.getSelection().anchorNode).closest("[mdtype='table']");var n=this.editor.getNode(e.attr("cid")),r=editor.undo.UndoManager.makeEmptyCommand(this.editor.selection.buildUndo()),o=n.get("after"),a=n.get("before");return o||a?(c.addUndoForRemove(r,n),n.remove(),e.remove()):(r.undo.push(c.buildReplaceUndo(n)),n.set("type",s.paragraph),n.set("text",""),n.clearChildren(),l.normalizeNode(n),e.replaceWith(n.toHTML()),r.redo.push(c.buildReplaceUndo(n))),editor.focusCid=null,o?this.editor.selection.jumpIntoElemBegin(this.editor.findElemById(o.id)):this.editor.selection.jumpIntoElemEnd(this.editor.findElemById((a||n).id)),this.editor.lastCursor=null,r.redo.push(this.editor.selection.buildUndo()),!t&&this.editor.undo.register(r),r},isTableEmpty:function(e){for(var t=0,n=e.get("children").length;t<n;t++)if(!function(e){for(var t=0,n=e.get("children").length;t<n;t++)if(e.get("children").at(t).get("text"))return!1;return!0}(e.get("children").at(t)))return!1;return!0}});p.deleteRow=function(e){r(".md-tooltip-hide").hide();var t,n,i,o,a,s=e.getMarkElem(window.getSelection().anchorNode).closest("td"),l=e.getMarkElem(window.getSelection().anchorNode).closest("tr[mdtype='table_row']"),c=l.prevAll().length;if(l.siblings().length){for(n=e.findNodeByElem(l).get("parent"),e.undo.completeSnap(!0),(t=e.undo.UndoManager.makeEmptyCommand()).undo.push(e.selection.buildUndo()),t.undo.push(e.undo.UndoManager.buildReplaceUndo(n)),o=n.getNthChild(1),i=c;i;)o=o.get("after"),i--;o.remove(),t.redo.push(e.undo.UndoManager.buildReplaceUndo(n)),e.findElemById(n.id).replaceWith(n.toHTML()),c?c--:c++,a=document.createRange();try{a.setStart(e.findElemById(n.id).find("tbody>tr:nth-child("+(c+1)+")>td:nth-child("+(s.prevAll().length+1)+")>span")[0],0),window.getSelection().removeAllRanges(),window.getSelection().addRange(a),t.redo.push(e.selection.buildUndo())}catch(e){}e.undo.register(t),e.tableEdit.showTableEdit(n)}},p.addRow=function(e,t,n){r(".md-tooltip-hide").hide();var i,o,a=e.getMarkElem(window.getSelection().anchorNode).closest("tr[mdtype='table_row']"),s=(e.getMarkElem(window.getSelection().anchorNode).closest("td, th").prevAll().length,"TBODY"==a.parent()[0].tagName),l=s?a.prevAll().length+1:0,c=e.undo.UndoManager.makeEmptyCommand();if(!t||s){i=e.findNodeByElem(a).get("parent"),e.undo.completeSnap(!0),c.undo.push(e.selection.buildUndo()),c.undo.push(e.undo.UndoManager.buildReplaceUndo(i)),o=i.getNthChild(l),o=p.newEmptyRowAfter(t?o.get("before"):o,o.get("children").length,i),s?a[t?"before":"after"](o.toHTML()):e.findElemById(i.id).replaceWith(i.toHTML());var d=e.findElemById(o.getFirstChild().id);e.selection.jumpIntoElemBegin(d),e.selection.scrollAdjust(),c.redo.push(e.undo.UndoManager.buildReplaceUndo(i)),c.redo.push(e.selection.buildUndo()),!n&&e.undo.register(c),e.tableEdit.showTableEdit(i)}return c},p.addCol=function(e,t){r(".md-tooltip-hide").hide();var n,i,o=e.getMarkElem(window.getSelection().anchorNode).closest("td, th"),a=o.find("[cid]").attr("cid"),s=o.prevAll().length;i=e.findNodeByElem(o.children("[cid]")).get("parent").get("parent"),e.undo.completeSnap(!0),(n=e.undo.UndoManager.makeEmptyCommand()).undo.push(e.selection.buildUndo()),n.undo.push(e.undo.UndoManager.buildReplaceUndo(i)),i.get("children").toArray().map(function(e){e.getNthChild(s).insert(new l({type:l.TYPE.table_cell,text:""}),t)}),i.get("align").splice(t?s:s+1,0,null),e.findElemById(i.id).replaceWith(i.toHTML()),o=e.findElemById(a).closest("th, td"),e.selection.jumpIntoElemBegin(t?o.prev():o.next()),n.redo.push(e.undo.UndoManager.buildReplaceUndo(i)),e.undo.register(n),e.tableEdit.showTableEdit(i)},p.deleteCol=function(e){r(".md-tooltip-hide").hide();var t,n,i=e.getMarkElem(window.getSelection().anchorNode).closest("td, th"),o=i.prevAll().length,a=i.nextAll().length,s=i.closest("tr"),l="TBODY"==s.parent()[0].tagName?s.prevAll().length+1:0;if(o||a){n=e.findNodeByElem(i.children("[cid]")).get("parent").get("parent"),e.undo.completeSnap(!0),(t=e.undo.UndoManager.makeEmptyCommand()).undo.push(e.selection.buildUndo()),t.undo.push(e.undo.UndoManager.buildReplaceUndo(n)),n.get("children").toArray().map(function(e){e.getNthChild(o).remove()}),n.get("align").splice(o,1),e.findElemById(n.id).replaceWith(n.toHTML());var c=document.createRange();try{l?c.setStart(e.findElemById(n.id).find("tbody>tr:nth-child("+l+")>td:nth-child("+(o+1)+")>span")[0],0):c.setStart(e.findElemById(n.id).find("thead>tr[mdtype]>th:nth-child("+(o+1)+")>span")[0],0),window.getSelection().removeAllRanges(),window.getSelection().addRange(c),t.redo.push(e.selection.buildUndo())}catch(e){}t.redo.push(e.undo.UndoManager.buildReplaceUndo(n)),e.undo.register(t),e.tableEdit.showTableEdit(n)}},p.getSibling=function(e,t,n){if(l.isType(e,l.TYPE.table_cell)){var t=t||"after",i=e.get(t),r=e.get("parent").get(t);return i||!r||n||(i="after"==t?r.getFirstChild():r.getLastChild()),i}},p.getColumnIndex=function(e,t){return t=t||0,t++,(e?p.getColumnIndex(e.get("before"),t):t)-2},p.getCellAt=function(e,t){if(l.isType(e,l.TYPE.table_row)){for(var n=e.getFirstChild();t>0;)t--,n=n.get("after");return n}},p.getNextCellInColumn=function(e,t,n){if(l.isType(e,l.TYPE.table_cell)){var n=n||p.getColumnIndex(e),t=t||"after",i=e.get("parent").get(t);return i?p.getCellAt(i,n):void 0}},p.resizeRow=function(e,t){for(var n,i=e.getFirstChild(),r=0;i||r<t;)r<t?(i||(i=new l({type:l.TYPE.table_cell,in:n.get("in"),parent:e,before:n})),i=(n=i).get("after")):i&&(i=(n=i).get("after"),n.delete()),r++},p.newEmptyRowAfter=function(e,t,n){var i=new l({type:l.TYPE.table_row,in:n.get("in"),parent:n,before:e,after:e?e.get("after"):null});new l({type:l.TYPE.table_cell,in:n.get("in"),parent:i});return p.resizeRow(i,t),i},p.valify=function(e,t,n,i){var r;if(n=n||2,void 0===t&&(t=e.get("children").at(0),t=t?t.get("children").length:1),i&&1==e.get("children").length&&1==t)i(e,e.get("children").at(0).get("children").at(0).get("text"));else{e.get("children").map(function(e){for(var n=e.get("children").length;n<t;n++)n===e.get("children").length&&(r=e.getLastChild()),r=new l({type:l.TYPE.table_cell,parent:e,in:e.get("in"),before:r,text:""})});for(var o=e.get("children").length;o<n;o++)p.newEmptyRowAfter(e.get("children").at(o-1),t,e);e.get("align")||e.set("align",new Array(t-0))}},l.TableEdit=p,n.exports=p}),define("app/editor/ImageEdit",["jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/editor/UserOp","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/ConvertUtils","app/editor/DeleteOp","app/editor/Stylize","app/window/MenuHelper","app/window/FileHelper","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp","app/editor/Inline","app/editor/Selection","codemirror/lib/codemirror","app/editor/UndoManager","app/editor/EditHelper"],function(e,t,n){"use strict";function i(e){return!!/^\s*(file|data):/.exec(e)}var r=e("jquery/jquery"),o=e("exoskeleton-master/exoskeleton"),a=e("app/document/Node"),s=a.Node,l=a.TYPE,c=e("app/editor/UserOp"),d=e("app/editor/Inline"),u=e("app/editor/Selection").rangy,h=e("app/editor/UndoManager"),p=e("app/editor/EditHelper"),f=e("app/document/StringUtils"),d=e("app/editor/Inline"),m=e("app/window/FileHelper"),g=window.reqnode?reqnode("electron").remote:null,v=null,y={},b=null,w="http://support.typora.io/Images/";window.imgLastModified=Math.floor((new Date-0)/1e3),window.uploadImageQueue=new Set,window.moveImageQueue=new Set;var x=o.Model.extend({initialize:function(e){this.editor=e,r(e.sessionStr).on("mousemove",".md-image>.md-meta",function(){event.offsetX-event.target.offsetLeft<20&&event.offsetY<30?this.classList.add("md-show-hint"):this.classList.remove("md-show-hint")}).on("mouseleave",".md-image>.md-meta",function(){this.classList.remove("md-show-hint")}).on("click","img",function(t){var n=r(t.target).closest(".md-image").addClass("md-expand"),i=u.createRange();i.moveToBookmark({containerNode:n.children(".md-meta")[0],start:2,end:2+(t.target.getAttribute("alt")||"").length}),e.selection.setRange(i)})},getLocalRootUrlForInsert:function(){return this.editor.docMenu.getLocalRootUrl()||File.option.useRelativePathForImg&&m.getCurrentFileFolderPath()||""},getRealSrc:function(e){function t(e,t){return"file://"+e.replace(/^file:\/\//,"").replace(/\/$/,"")+"/"+t.replace(/^\//gi,"")}if(!e)return e;if(/^data:/.exec(e))return e;try{if(/^(file|ftp|https?):(\/\/|\\\\)/gi.exec(e))return e;if(File.isNode){var n=reqnode("path"),i=this.editor.docMenu.getLocalRootUrl();return File.isWin||!/^\//.exec(e)||i?"file://"+n.resolve(this.editor.docMenu.getLocalRootUrl()||m.getCurrentFileFolderPath()||"",e.replace(/^\s*(\\\\|\/)/,"")):"file://"+e}return/^(\/)|(\/\/)|(\\\\)|([a-z]+\:\\\\)/gi.exec(e)?t(this.editor.docMenu.getLocalRootUrl()||"",e||""):t(m.getCurrentFileFolderPath()||"",e||"")}catch(e){}return e},updateImgRef:function(e){var t=this.editor.brush.inline;r("[data-ref='"+f.escape(e)+"']").each(function(){var e=(this.querySelector(".md-content")||{}).textContent;void 0!==e&&r(this).replaceWith(t.output(e))})},willUpdateImgRef:function(e){e&&(b&&clearTimeout(b),y[e]=!0,v=v||new Date,new Date-v>200?setTimeout(function(){Object.keys(y).map(this.updateImgRef,this)}.bind(this),10):b=setTimeout(function(){Object.keys(y).map(this.updateImgRef,this)}.bind(this),300))},refreshLocalImg:function(){var e=Math.floor((new Date-0)/1e3);r(".md-image img").each(function(){var t=File.editor.imgEdit.getRealSrc(this.parentElement.getAttribute("data-src")),n=t+"?lastModify="+imgLastModified;/^file:\/\//i.exec(t)&&(failImgCache.remove(n),loadedImgCache.remove(n),this.setAttribute("src",t+"?lastModify="+e),this.setAttribute("onload",d.onLoadEvaluate),this.setAttribute("onerror",d.onErrorEvaluate))}),imgLastModified=e},updateLocalRootUrl:function(){var e=this.editor.docMenu.getLocalRootUrl()||"";if(this.editor.localRootUrl!=e)for(var t=document.querySelectorAll("[md-inline='image']"),n=0;n<t.length;n++){var i=t[n],o=i.querySelector("img");if(i.getAttribute("data-src")!=o.getAttribute("src")){var s=r.parseHTML(d.decorate({type:a.TYPE.image,markdown:i.textContent,alt:o.getAttribute("alt"),href:i.getAttribute("data-src")}))[0];i.parentElement.replaceChild(s,i)}}},selectComponent:function(e){var t=this.editor.selection.getRangy(),n=r(t.startContainer).closest("[md-inline='image']"),i=n.text(),o=t.getBookmark(n[0]),a=i.indexOf("]"),s=h.makeEmptyCommand(this.editor.selection.buildUndo());e?(o.start=a+2,o.end=i.length-1):(o.start=2,o.end=a),t.moveToBookmark(o),this.editor.selection.setRange(t),s.redo.push(this.editor.selection.buildUndo()),this.editor.undo.register(s)},buildImageMapToUpload:function(){C={};for(var e,t,n=document.querySelectorAll(".md-image.md-img-loaded"),r=n.length,o=0;o<r;o++)i(t=(e=n[o]).querySelector("img").getAttribute("src"))&&(t=t.replace(/\?[^.]*$/,""),C[t]=C[t]||[],C[t].push(e));return Object.keys(C)},replaceImageMap:function(e,t){var n=JSON.parse(e),i=h.makeEmptyCommand(this.editor.selection.buildUndo()),o=this.editor,a=new Set;if(Object.keys(n).forEach(function(e){if(C[e]){var t=n[e];C[e].forEach(function(e){e.querySelector("img").src=t,e.hasAttribute("data-src")&&e.setAttribute("data-src",t);var n,c,d=o.findNodeByElem(r(e).closest("[cid]")),u=e.getAttribute("md-inline");if(!a.has(d)&&s.isType(u,l.image,l.imgtag)&&(a.add(d),i.undo.push(h.buildReplaceUndo(d))),n=e.querySelector(".md-content").textContent,u==l.image)c=n.replace(/(\(<?)((?:\([^)]*\)|[^()])*?)(>?[ \t]*((['"])(.*?)\4[ \t]*)?\))/,"$1"+t+"$3"),e.querySelector(".md-content").textContent=c;else if(u==l.imgtag)c=n.replace(/(src=(["'])).+?(\2)/i,"$1"+t+"$3"),e.querySelector(".md-content").textContent=c;else if(u==l.refimg){var p=/^!\[((?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*)\]\s*\[([^\]]*)\]/.exec(n),f=(p[2]||p[1]).replace(/\s+/g," "),m=o.nodeMap.link_list.getNodeByRef(f);if(a.has(m))return;a.add(m),i.undo.push(h.buildReplaceUndo(m)),m.set("href",t),o.findElemById(m.cid).replaceWith(m.toHTML())}})}}),a.forEach(function(e){e.get("type")!==l.def_link&&o.store(e,!0),i.redo.push(h.buildReplaceUndo(e))}),i.redo.push(o.selection.buildUndo()),o.undo.register(i),t){var c=Object.keys(n).length;p.showNotification(r.localize.getString("Successfully uploaded {0} images.").format(c)+"<span class='btn-default btn-xs btn undo-btn' style='right: 40px;position: absolute;'>"+r.localize.getString("Undo")+"</span>")}},insertImagesFromLocalFile:function(){if(!File.isLocked){var e=reqnode("electron").remote,t=e.getCurrentWindow(),n=(e.app,e.dialog),i=this.editor;n.showOpenDialog(t,{filters:[{name:"Images",extensions:["png","jpg","jpng","bmp","svg","tiff","webp","gif"]}],properties:["openFile","multiSelections"],buttonLabel:"Select"},function(e){e&&0!=e.length&&i.imgEdit.doInsertFromURLs(e)})}},doInsertFromURL:function(e){function t(){return File.isWin?e.match(/\\([^\\]+)\./g).last().replace(/\[|\]|\//g,""):e.match(/\/([^\/]+)\./g).last().replace(/\[|\]/g,"")}function n(){var e=window.getSelection(),t="";return!File.editor.sourceView.inSourceMode&&e.startOffset>0&&(t=" "),t}function i(e){e.removeClass("md-on-uploading").removeClass("md-on-moving"),e.find(".md-image-uploading-mask-wrapper").remove(),e.removeAttr("data-origin-path")}function o(e,t,n){return new Promise(function(e,i){app.ipic.copyImage(n,t,e,i)})}function a(e,t,n){return new Promise(function(e,i){var o,a=reqnode("fs-extra"),s=m.getFileNameFromPath(n);t=(t+"/").replace(/[\/\\]{2}$/,"/"),o=t+s,new Promise(function(e,n){a.stat(t,function(i){if(!i)return e();if("ENOENT"!=i.code)return n(!1);var o=r("#image-create-folder-confirm").find("#image-create-folder-target").text(t).end().modal({backdrop:"static",keyboard:!1});File.isLocked=!0,o.off("mousedown",".image-create-folder-dialog-yes, .image-create-folder-dialog-no, .image-create-folder-dialog-help, .close").one("mousedown",".image-create-folder-dialog-yes",function(){o.modal("hide"),File.isLocked=!1,File.freshMenu(),e()}).one("mousedown",".image-create-folder-dialog-no",function(){o.modal("hide"),File.isLocked=!1,File.freshMenu(),n(!1)}).one("mousedown",".close",function(){o.modal("hide"),File.isLocked=!1,File.freshMenu(),n(!1)}).on("mousedown",".image-create-folder-dialog-help",function(){g.shell.openExternal(w)})})}).then(function(){a.ensureDir(t,function(t){if(t)return i(t);a.access(o,a.R_OK,function(t){t||(o=o.replace(/(\.[^.]+$)/,"-"+((new Date).getTime()+"").substring(3)+"$1")),a.copy(n,o,function(t){if(t)return i(t);e(o)})})})},function(){i()})})}function s(e,t){t=this.resolveImagePath(t);var n=this.editor,i=e.find(".md-content").text(),o=i.replace(/(\(<?)((?:\([^)]*\)|[^()])*?)(>?[ \t]*((['"])(.*?)\5[ \t]*)?\))/,"$1"+t+"$3"),a=n.selection.buildUndo(),s=h.makeEmptyCommand(a),l=r.extend({},a),c=o.length-i.length,d=n.findNodeByElem(e.closest("[cid]"));return n.undo.completeSnap(!0),l.start+=c,l.end+=c,s.undo.push(h.buildReplaceUndo(d)),e.find(".md-content").text(o),n.store(d,!0),n.brush.addToQueue(e.closest("[cid]").attr("cid")),n.brush.resume(),s.redo.push(h.buildReplaceUndo(d)),s.redo.push(l),n.undo.register(s),l}function l(e){var i=this.editor,o=i.getMarkElem();if(!o.length||!i.stylize.canContainInline(o))return!1;c.backspaceHandler(i,null,"delSelection");var a,l=t(),d=n(),u=i.getNode(o.attr("cid")),p=d+"!["+l.substring(1,l.length-1)+"]("+e+")",f=i.selection.getRangy();if(!f)return null;if((a=r(f.startContainer).closest("[md-inline='image']")).length)return s.call(this,a,e),this.selectComponent(!0),a;var m=f.getBookmark(o[0]).start,g=(u.cid,i.selection.prepNode("​",null,!0)||h.makeEmptyCommand());return g.undo.push(i.selection.buildUndo()),c.insertInlineText(i,u,p,g),i.brush.brushNode(u.cid),f.moveToBookmark({containerNode:i.findElemById(u.cid)[0],start:m,end:m}),(a=r(f.startContainer).closest(".md-image")).find("img").attr("src","file://"+e),i.undo.register(g),a}function u(e){var t=r("[data-origin-path="+JSON.stringify(e)+"]");return i(t),uploadImageQueue.delete(e),moveImageQueue.delete(e),t}var p=d.applyUploadingStyle;if(e&&/\.(png|jpg|jpeg|svg|gif|bmp|webp|tiff)$/gi.exec(e)){var v,y=e,b=this,x=this.editor,C=this.getTagetImageStorageFolder();if(!/^[^:]+:\/\//.exec(e)&&C)if(this.editor.undo.completeSnap(!0),File.isMac&&"ipic"==C){if(app.ipic.validateBeforeUpload()&&(v=l.call(this,y))&&v.length)return this.editor.getNode(v.closest("[cid]").attr("cid")),void function(e,t){return this.editor.brush.pause(),window.uploadImageQueue.add(t),p(e,t,!1),this.editor.brush.resume(),new Promise(function(e,n){app.ipic.upload(t,e,n)})}.call(this,v,y).then(function(e){v=u(y),s.call(b,v,e)},function(e){v=u(y),s.call(b,v,y),e&&setTimeout(function(){r("#md-notification").html("<p style='padding-right: 100px;'>"+r.localize.getString("Failed to upload image. Error Message:")+" <code>"+f.escape(e)+"</code><span class='btn-default btn-xs btn ok-btn' style='right: 40px;position: absolute;bottom: 8px;'>"+r.localize.getString("Close")+"</span></p>").show()},500)})}else if(C&&(0!=(y=m.normalizePath(y)).indexOf(C)||y.substring(C.length+1).match(/[\\\/]/g)))return void((v=l.call(this,y))&&v.length&&(this.editor.getNode(v.closest("[cid]").attr("cid")),function(e,t,n){return this.editor.brush.pause(),window.moveImageQueue.add(n),p(e,n,!0),this.editor.brush.resume(),File.isMac?o.call(this,e,t,n):a.call(this,e,t,n)}.call(this,v,C,y).then(function(e){v=u(y),s.call(b,v,e)},function(e){v=u(y),s.call(b,v,y),console.error(e),e&&setTimeout(function(){r("#md-notification").html("<p style='padding-right: 100px;'>"+r.localize.getString("Failed to Copy Image to Target Folder.")+" <code>"+f.escape(e)+"</code><span class='btn-default btn-xs btn ok-btn' style='right: 40px;position: absolute;bottom: 8px;'>"+r.localize.getString("Close")+"</span></p>").show()},500)})));(function(e){var i,o=t(),a=n(),l=x.selection.getRangy();l&&(i=r(l.startContainer).closest("[md-inline='image']")).length?(s.call(this,i,e),this.selectComponent(!0)):(e=this.resolveImagePath(e),c.pasteHandler(this.editor,a+"!["+o.substring(1,o.length-1)+"]("+e+")",!0))}).call(this,e)}},doInsertFromURLs:function(e){var t=this.editor;e.forEach(function(e,n){n>0&&t.UserOp.insertParagraph(!1,t),t.imgEdit.doInsertFromURL(e)})},resolveImagePath:function(e){if(/^[^:]+:\/\//.exec(e))return e;var t=this.getLocalRootUrlForInsert(),n=m.getCurrentFileFolderPath();if(t&&t.length){var i=f.getRelativePath(t,e);t==n&&(i=i.replace(/^\s*(\\\\|\/)/,"")),e=("."!=i[0]&&this.editor.docMenu.getLocalRootUrl()?"/":"")+i}else{if(!File.option.useRelativePathForImg||!n||0!==e.indexOf(n))return e;e=e.substring(n.length).replace(/^\//,"")}return File.isWin&&(e=e.replace(/\\+/g,"/")),e},getTagetImageStorageFolder:function(){var e=this.editor.docMenu.getValueInMeta("typora-copy-images-to");if(e&&!File.editor.sourceView.inSourceMode){if(File.option.allowImageUpload&&"ipic"==e.toLowerCase())return"ipic";if(File.option.allowImageMove&&m.getCurrentFileFolderPath()){var t=m.getCurrentFileFolderPath();if(t)return/[\\/]$/.exec(t[t.length-1])||(t+="/"),m.normalizePath(t+e)}}return null},toggleCopyToFolder:function(){var e=reqnode("electron").remote,t=e.getCurrentWindow(),n=e.dialog,i=this,o=this.getTagetImageStorageFolder(),a=m.getCurrentFileFolderPath();if(File.refreshImageCopyStatus(!0),!File.isLocked&&!File.editor.sourceView.inSourceMode)if(o)this.doRemoveImageCopyToFolder(!1);else{if(!a)return void n.showMessageBox(t,{title:r.localize.getString("Document must be saved first.","Panel"),message:r.localize.getString("Typora will copy newly inserted image to folder by selected relative path, so please save the file first.","Panel"),buttons:[r.localize.getString("OK")]});if(!File.option.allowImageMove)return void n.showMessageBox(t,{title:"One More Step",message:"To use this feature, please enable the option `Allow copy images to given folder` on Preferences Panel first.",buttons:[r.localize.getString("Learn More…"),r.localize.getString("Close")]},function(t){0==t&&e.shell.openExternal(w)});n.showOpenDialog(t,{defaultPath:m.getCurrentFileFolderPath(),title:r.localize.getString("Select Container Folder"),properties:["openDirectory","createDirectory"],buttonLabel:r.localize.getString("Select")},function(e){e&&0!=e.length&&i.doSetImageCopyToFolder(e[0])})}},toggleUseImageRootPath:function(){var e=reqnode("electron").remote,t=e.getCurrentWindow(),n=e.dialog,i=this.editor.docMenu.getLocalRootUrl(),o=this.editor;i?this.editor.docMenu.removeProperty("typora-root-url"):n.showOpenDialog(t,{defaultPath:m.getCurrentFileFolderPath(),title:r.localize.getString("Select Container Folder"),properties:["openDirectory","createDirectory"],buttonLabel:r.localize.getString("Select")},function(e){e&&0!=e.length&&o.imgEdit.doSetImageRootPath(e[0])})},doSetImageCopyToFolder:function(e,t){e=t&&File.isMac?"ipic":f.getRelativePath(m.getCurrentFileFolderPath(),e,!0),this.editor.docMenu.writeProperty("typora-copy-images-to",e)},doSetImageRootPath:function(e){this.editor.docMenu.writeProperty("typora-root-url",f.getRelativePath(m.getCurrentFileFolderPath(),e,!0)),this.refreshLocalImg()},doRemoveImageCopyToFolder:function(e){return this.editor.docMenu.removeProperty("typora-copy-images-to",e)}}),C={};n.exports=x}),define("app/editor/UserOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/ConvertUtils","app/editor/TableEdit","app/editor/DeleteOp","app/editor/ConvertUtils","app/editor/Stylize","app/window/MenuHelper","app/window/FileHelper","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton"),e("app/document/StringUtils");var i=e("app/document/Node"),r=e("app/editor/UndoManager"),o=(r.SnapFlag,i.Node),a=i.TYPE,s=(i.NodeCollectionUtils,e("rangy/rangy-core.js"),e("app/document/MarkParser")),l=(e("app/editor/TableEdit"),e("app/editor/ConvertUtils"),e("app/editor/DeleteOp")),c=e("app/editor/IndentOp"),d=e("app/editor/PairOp"),u=e("app/editor/ClipboardOp"),h=function(e,t,n,i){var r,o=e;if(e==t)return null;for(r=e.get(n);r;)i(r,o),r=(o=r).get(n);return h(e.get("parent"),t,n,i),o};t.getDisplayText=function(e){var t=e.clone();return t.find(".md-meta, .md-content").remove(),t.text().replace(/\u00A0/g," ")},t.decorateOneSide=h,t.simpleExpand=function(e,t){if(File.isLocked)return!1;var n,i,l,c=e.getNode(t),d=e.selection.buildUndo();if(!o.isType(c,a.heading,a.def_footnote,a.def_link)||d.startId&&d.startId!=d.endId)return!1;if((n=c.toMark().trim()).match(/\n/))return!1;var u=r.makeEmptyCommand(e.lastCursor),h=new o({type:a.line,text:n});if(!u.undo.length||!u.undo[0].id&&u.undo[0].startId!=u.undo[0].endId)return!1;if(u.undo.push(r.buildReplaceUndo(c)),o.isType(c,a.heading)&&(i=c.get("pattern")&&c.get("pattern").replace("{0}","").length||c.get("depth")+1),o.isType(c,a.def_link,a.def_footnote)){var p,f=e.selection.getRangy(),m=e.getJQueryElem(f.startContainer);p=m.closest(".md-def-content"),i=o.isType(c,a.def_link)?1:2,p.length&&(i+=3),(p=m.closest(".md-def-title")).length&&m.text().length&&(i+=5)}return c.unset("text"),c.set("type",a.paragraph),c.append(h),u.redo.push(r.buildReplaceUndo(c)),d=e.selection.buildUndo(),d.start+=i,d.end+=i,d.id=h.cid,d.startId=d.endId=void 0,u.redo.push(d),l=c.toHTML(s.renderHtmlWithBlockMeta(h,e.brush)),e.findElemById(c.cid).replaceWith(l),e.undo.exeCommand(d,[]),e.undo.stashUndo(u),h.cid},t.backspaceHandler=l.backspaceHandler,t.deleteSelectable=l.deleteSelectable,t.deleteLineProcessor=l.deleteLineProcessor,t.deleteLine=l.deleteLine,t.backToParagraph=l.backToParagraph,t.getMarkdownSourceFrom=u.getMarkdownSourceFrom,t.copyAsMarkdown=u.copyAsMarkdown,t.copyAsHTMLSource=u.copyAsHTMLSource,t.copyHandler=u.copyHandler,t.insertInlineText=u.insertInlineText,t.pasteHandler=u.pasteHandler,t.setClipboard=u.setClipboard,t.insertURLs=u.insertURLs,t.prepMarkHtml=u.prepMarkHtml,t.insertParagraph=u.insertParagraph,t.processClipboardHTML=u.processClipboardHTML,t.moreIndent=c.moreIndent,t.lessIndent=c.lessIndent,t.hanldePair=d.hanldePair,t.surroundPair=d.surroundPair}),define("app/editor/ConvertUtils",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/TableEdit","app/editor/UndoManager","app/editor/polyfill","app/editor/KeyMaster","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/Emoji"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton");var i=e("app/document/StringUtils"),r=e("app/document/Node"),o=r.Node,a=r.TYPE,i=(r.NodeCollectionUtils,e("app/document/StringUtils")),s=e("app/editor/TableEdit"),l=e("app/document/MarkParser"),c=e("jquery/jquery"),d=["CONTENT","HEADER","FOOTER","ARTICLE","SECTION","DIV","P","BLOCKQUOTE","PRE","UL","OL","TABLE","HR","H1","H2","H3","H4","H5","H6","DL","DT","DD","TBODY","THEAD","TFOOT","ASID","LI","HTML","BODY","IFRAME","STYLE","SCRIPT","FIGURE"],u=["INPUT","BUTTON","SELECT","SCRIPT","CANVAS","META","PROGRESS","VIDEO","HEAD","EMBED","STYLE","TEMPLATE"];t.convertToPlain=function(e){function t(e,t){for(var i=(e instanceof Array?e[0]:e.first()).getLastBrother(!0),r=[],o=0;o<e.length;o++)r=r.concat(n(i,t)),i=i.get("after");return r}function n(e,i){function r(e){return i?[e]:[e,""]}var s,l=[];switch(e.get("type")){case a.fences:for(l=e.get("text").replace(/\u200B/g,"").split("\n"),h=0;h<l.length;h++)l[h]="    "+l[h];return i||l.push(""),l;case a.list:var c=e.get("style"),d=e.get("children").length;if(d)for(var u=e.getFirstChild(),h=0;u;){var p=n(u,!0),f=o.getIndentPrefix(c,h,u,void 0,(d+"").length);p.map(function(e,t){p[t]=(t?" ".repeat(f.length):f)+p[t],l.push(p[t])}),h++,u=u.get("after")}return i||l.push(""),l;case a.table:for(var m,g,v,y,b,w,x=[],C=[],k=0,S=e.getFirstChild();S;){for(m=S.getFirstChild(),C[k]=[],g=0;m;)C[k][g]=m.toMark().trim(),m=m.get("after"),0===k&&(x[g]=4),x[g]=Math.max(C[k][g].length,x[g]),x[g]=Math.min(x[g],40),g++;S=S.get("after"),k++}for(k=0;k<C.length;k++){for(v="  ",g=0;g<x.length;g++)y=Math.max(x[g]-C[k][g].length,0),"right"==(b=e.get("align")[g])?v+=" ".repeat(y)+C[k][g]:"center"==b?(w=~~(y/2),v+=" ".repeat(w)+C[k][g]+" ".repeat(y-w)):v+=C[k][g]+" ".repeat(y),v+="\t";l.push(v.replace(/\s$/,""))}return i||l.push(""),l;case a.hr:return r("---");case a.def_link:return s="["+e.get("ref")+"]: "+e.safeGetStrAttr("href")+(e.safeGetStrAttr("title").length?'\t"'+e.get("title")+'"':""),o.isType(e.get("after"),a.def_link)?[s]:r(s);case a.def_footnote:return s="["+e.get("ref")+"]: "+e.get("text"),o.isType(e.get("after"),a.def_footnote)?[s]:r(s);default:return e.get("children")&&e.get("children").length>0?t(e.get("children"),i):r(e.get("text"))}}return t(e).join("\n")},t.parseHTML=function(e,t,n,r){function h(e){try{var t=/(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)/,n=/\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)/;return(e.match(/\n\s*(\!?\[|#{1,5}|>|```)/g)||"").length>3||e.match(n)||e.match(t)?e:null}catch(e){}return null}function p(e,t){var n,o,a;return e.find("img").each(function(){(n=c(this)).text("!["+(n.attr("alt")||n.attr("title")||"img").replace(/\r|\n/gi,"")+"]("+i.getAbsoluteURL(r,n.attr("src"))+")")}),e.find("strong, b").each(function(){(n=c(this)).text("**"+n.text().replace(/([^\\])\*/,"$1\\*")+"**")}),e.find("em, i").each(function(){(n=c(this)).text("*"+n.text().replace(/([^\\])\*/,"$1\\*")+"*")}),e.find("code, pre, tt").each(function(){(n=c(this)).text("`"+n.text()+"`")}),e.find("del, strike").each(function(){(n=c(this)).text("~~"+n.text()+"~~")}),e.find("br").each(function(){(n=c(this)).replaceWith("\n")}),e.find("a:not(:empty)").each(function(){n=c(this),o=i.getAbsoluteURL(r,n.attr("href")),0==(a=n.text()).length?n.replaceWith(""):o==a?n.replaceWith("&lt;"+o.replace(/</g,encodeURI("<")).replace(/>/g,encodeURI(">"))+"&gt;"):n.replaceWith("["+a.replace(/([^\\])]([^(]|$)/,"$1\\]$2").replace(/\r|\n/gi,"")+"]("+o+")")}),File.option.highlight&&e.find("mark").each(function(){(n=c(this)).text("=="+n.text().replace(/([^\\])\=/,"\\=")+"==")}),t?e[0].innerText.split(/(\r|\n)+/):e.text().replace(/\r|\n/gi,"")}function f(e,t,n,i){var r,s=t,l=[];if(t&&t!==n){for(;s&&s!==n;)o.isType(s,a.paragraph)&&o.isEmptyBlock(s)?(r=s,s=s.get("after"),r.remove(),i&&i.splice(i.indexOf(r),1)):s=s.get("after");for(t=s.get("before")||s,s=n;s&&s!==t;)o.isType(s,a.paragraph)&&o.isEmptyBlock(s)?(r=s,s=s.get("before"),r.remove(),i&&i.splice(i.indexOf(r),1)):s=s.get("before")}for(s=t;s;){var c=null;if(o.isType(s,a.blockquote,a.list_item))f(s,s.getFirstChild(),s.getLastChild());else if(o.isType(s,a.fences)&&o.isType(s.get("before"),a.fences))l.push(s),s.head=s.get("before").head||s.get("before"),s.head.set("text",s.head.get("text")+"\n"+s.get("text"));else if(o.isType(s,a.list)&&0===s.get("children").length)s.set("type",a.paragraph);else if(o.isType(s,a.paragraph)&&(c=/^(`+)([\s\S]*?[^`])\1(?!`)\s*$/g.exec(s.get("text")))){s.set("type",a.fences),s.set("text",c[2]);continue}s=s.get("after")}l.map(function(e){i&&i.splice(i.indexOf(e),1),e.remove()})}function m(e,n,i){e.in=t,e.parent=n,e.before=i.last(),e&&e.text&&(e.text=e.text.replace(/\u200b/g,"").replace(/\u00a0/g," "));var r=new o(e);return i.push(r),r}function g(e,t,n){var i=[];if(t)for(var r=0;r<e[0].childNodes.length;r++)x(c(e[0].childNodes[r]),n,i);else o.isType(n,a.blockquote,a.list_item)?y(e,n,i):n.set("text",p(e))}function v(e,t,n){for(var r,o,s=[],c=null,d=0;d<e.length;d++)r=e[d],(s=l.reDefLink.exec(r))?(c=null,m({type:a.def_link,ref:s[1],href:s[3],title:s[7]},t,n)):(s=l.reDefFootnote.exec(r))?(c=null,m({type:a.def_footnote,ref:s[1],text:(s[2]||"").trim()},t,n)):(null==c&&(c=m({type:a.paragraph},t,n),o=[]),m({type:a.line,text:i.escapeHead(r)},c,o))}function y(e,t,n){if(e.find("br").length){for(var i=p(e,!0),r=[],o=0;o<i.length;o++)i[o].trim().length&&r.push(i[o]);v(r,t,n)}else{if(3==e[0].nodeType&&!e.text().trim().length)return;v([p(e)],t,n)}}function b(e,t){for(var n,i=[],r=0;r<e.length;r++)"DT"==e[r].tagName&&((n=m({type:a.list_item},t,i)).itemList=[],m({type:a.paragraph,text:p(c(e[r]))},n,n.itemList)),"DD"==e[r].tagName&&n&&m({type:a.paragraph,text:p(c(e[r]))},n,n.itemList)}function w(e){if(-1==d.indexOf(e[0].tagName))return!1;var t=!1;return e.children().each(function(){t=t||this.tagName&&(d.indexOf(this.tagName)>-1||"BLOCK"==this.style.display)}),t}function x(e,t,n){var i,r,l=w(e),d=e[0].tagName;if(!(e.data("skip")||u.indexOf(d)>-1||e[0].nodeType===document.COMMENT_NODE)){if("BLOCKQUOTE"===d)g(e,l,i=m({type:a.blockquote},t,n));else if("LI"===d&&o.isType(t,a.list))g(e,l,i=m({type:a.list_item},t,n));else if("UL"===d||"OL"===d)g(e,l,i=m({type:a.list,style:d.toLowerCase()},t,n));else if("DL"===d)i=m({type:a.list,style:"ul"},t,n),b(e.children(),i);else if("TABLE"===d)(r=e.children().children("tr").add(e.children("tr"))).length&&(i=m({type:a.table},t,n),n=[],i.cols=1,r.toArray().map(function(e){x(c(e),i,n)}),i.set("align",new Array(i.cols-0)),s.valify(i,i.cols,2,function(e,i){var r=i.split(/(\r|\n)+/);e.set("type",a.paragraph),e.set("text",r[0]);for(var o=1;o<r.length;o++)r[o].trim().length&&m({type:a.paragraph,text:r[o]},t,n)}));else if("THEAD"===d||"TBODY"===d||"TFOOTER"===d){for(var f=[e],v=$elem.next();v.length&&o.isType(v[0].tagName,"THEAD","TBODY","TFOOTER");)f.push(v),v.data("skip",!0);e.wrap("<table></table>"),x(e.parent(),t,n)}else if("TR"===d&&o.isType(t,a.table)){var C;C=(r=e.children("th")).length,r=r.add(e.children("td")),t.cols=r.length>t.cols?r.length:t.cols,i=m({type:a.table_row,isHeader:C},t,n),n=[],r.toArray().map(function(e){x(c(e),i,n)})}else if("TD"!==d&&"TH"!==d||!o.isType(t,a.table_row))if("HR"===d)m({type:a.hr},t,n);else if(/H[1-6]/g.exec(d))m({type:a.heading,text:p(e),depth:e[0].tagName[1]},t,n);else if("CODE"===d||"PRE"===d&&0==e.find("pre").length||"FIGURE"==d&&e.hasClass("highlight"))e.find("div").each(function(){c(this).before("<br/>")}),m({type:a.fences,text:e[0].innerText.replace(/^\s*\n+/,"")},t,n);else if(l)e.children().each(function(){x(c(this),t,n)});else{var k=h(e[0].innerText||"");if(k)return k;y(e,t,n)}else i=m({type:a.table_cell,text:p(e)},t,n);return null}}var C=c(c.parseHTML("<div>"+e+"</div>")[0]),k=[];C.find("head, meta, script, css, .gutter, style, title").remove();var S=x(C,null,k);if(S)return S;if(k.length&&(f(null,k[0],k.last(),k),1===k.length&&o.isType(k[0],a.paragraph))){var T=C.text().replace(/(^\n+)|(\n+$)|\u200b/g,"").replace(/\u00a0/g," ");return k[0].delete(),o.parseFrom(T,t,{noTop:!0,skips:{old_code:!0}},!0)[1]}return k}}),define("app/editor/DeleteOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/ConvertUtils","app/editor/TableEdit","app/editor/Stylize","app/window/MenuHelper","app/editor/Emoji","app/editor/EditHelper","app/window/FileHelper","app/editor/PairOp"],function(e,t,n){"use strict";e("exoskeleton-master/exoskeleton"),e("app/document/StringUtils");var i=e("app/document/Node"),r=e("app/editor/UndoManager"),o=r.SnapFlag,a=i.Node,s=i.TYPE,l=(i.NodeCollectionUtils,e("rangy/rangy-core.js"),e("app/document/MarkParser"),e("app/editor/TableEdit")),c=(e("app/editor/ConvertUtils"),e("app/editor/Stylize")),d=(e("app/editor/Emoji"),e("app/editor/EditHelper"),e("app/window/FileHelper"),e("app/editor/PairOp")),u=(window.reqnode&&reqnode("electron").remote,"skipCommand"),h=$("content"),p=function(e,t,n){if(a.isType(t,s.line)&&!t.get("before")&&(t=t.get("parent")),a.isType(t.get("parent"),s.blockquote)&&(n||!t.get("before"))){var o=r.makeEmptyCommand(e.selection.buildUndo()),l=t.upStream();return r.append(o,l.command),e.findElemById(l.oldCid).replaceWith(l.newHtml),e.undo.exeCommand(o.undo[0]),o.redo.push(e.selection.buildUndo()),o}if(a.isType(t.get("parent"),s.list_item)&&(n||!t.get("parent").get("before")&&!t.get("before"))){var o=r.makeEmptyCommand(e.selection.buildUndo()),c=t.get("parent"),d=c.get("parent");o.undo.push(r.buildReplaceUndo(d)),d.unset("start"),c.set("parent",null),c.set("after",null),d.insert(c,!0);var u=c.unwrap();return r.addUndoForInsertArray(o,u),e.findElemById(d.id).before(i.NodeCollectionUtils.toHTML(u)),d.get("children").length?(e.findElemById(d.id).replaceWith(d.toHTML()),o.redo.push(r.buildReplaceUndo(d))):(r.addUndoForRemove(o,d),d.remove(),e.findElemById(d.id).remove()),e.selection.jumpIntoElemBegin(e.findElemById(u[0].id)),o.redo.push(e.selection.buildUndo()),o}},f=function(e,t,n,i){var o=r.makeEmptyCommand(e.selection.buildUndo());return o.undo.push(r.buildReplaceUndo(t)),t.set("type",s.paragraph),t.clearChildren(),n?t.set("text",""):t.set("text",t.get("text").replace(/\u200B|(\r?\n)/g,"")),a.normalizeNode(t),o.redo.push(r.buildReplaceUndo(t)),e.findElemById(t.id).replaceWith(t.toHTML()),e.selection.jumpIntoElemBegin(e.findElemById(t.id)),o.redo.push(e.selection.buildUndo()),!i&&$(e.sessionStr).trigger("cursorChange"),o},m=function(e,t,n,i){if(t&&t.length){n&&n.preventDefault(),!i&&e.undo.completeSnap(!0);var o=e.findNodeByElem(t),a=r.makeEmptyCommand(e.selection.buildUndo());return o?(o.set("text",""),a=r.append(a,f(e,o))):(o=e.findNodeByElem(t.closest("[mdtype]")),a.undo.push(r.buildReplaceUndo(o)),e.selection.moveLeftOrRight(!0),t.remove(),e.store(o.id),a.redo.push(r.buildReplaceUndo(o)),a.redo.push(e.selection.buildUndo())),!i&&e.undo.register(a),a}},g=function(e,t,n,g,v){function y(e,t,n){var i,r=e;if(e==t)return null;for(i=e.get(n);i;)$("[cid='"+i.id+"']").remove(),i.remove(),i=e.get(n);return y(e.get("parent"),t,n),r}function b(e,t,n,i,o){var s,l,d,u=t.cloneRange(),h=e.findElemById(n.id);return u.setEndAfter(h[0]),e.selection.deRange(u),l=e.findNodeByElem(e.getMarkElem(u.startContainer)),!o&&$(u.startContainer).closest("table").length?(r.append(i,_(e,u,!0)),l=e.findNodeByElem($(u.startContainer).closest("[mdtype='table']")),n.contains(l)&&(y(l,n,"after"),0===l.getText().length)?(r.append(i,f(e,l)),"abortAndSkipCursor"):"abort"):(i.undo.push(r.buildReplaceUndo(n)),s=$(u.extractContents()),a.isType.apply(null,[n].concat(c.CONST.Selectable))&&r.append(i,f(e,n,!0,!0)),e.store(l,!0),e.findElemById(l.cid).replaceWith(l.toHTML()),d=y(l,n,"after"),!!(s.text().length||s.find("img").length||d)&&(i.redo.push(r.buildReplaceUndo(n)),l))}function w(e,t,n,i,o){var a,s,l,c=t.cloneRange(),d=e.findElemById(n.id);return c.setStartBefore(d[0]),e.selection.deRange(c),!o&&$(c.endContainer).closest("table").length?(r.append(i,_(e,c,!0)),s=e.findNodeByElem($(c.endContainer).closest("[mdtype='table']")),"abort"):(i.undo.push(r.buildReplaceUndo(n)),s=e.findNodeByElem(e.getMarkElem(e.selection.getEndNode(c))),a=$(c.extractContents()),e.store(s,!0),e.findElemById(s.cid).replaceWith(s.toHTML()),l=y(s,n,"before"),!!(a.text().length||a.find("img").length||l)&&(i.redo.push(r.buildReplaceUndo(n)),s))}function x(e,t,n,i,o,l,c){function d(e,t){return e==t||e.get("before")||e.get("after")?e:d(e.get("parent"),t)}var u,h,p,f,m=a.isEmptyBlock(i);if(!m||i==o||a.isEmptyBlock(o)&&!c)if(m&&i==o&&o.isBlock())o.set("type",s.paragraph),o.clearChildren(),e.findElemById(o.id).replaceWith(o.toHTML()),e.selection.jumpIntoElemBegin(e.findElemById(o.id)),l.redo.push(e.selection.buildUndo());else{if(console.assert(t!=n,"Error on spliceStartAndEnd"),t!=n){if(u=n.safeGetStrAttr("text"),f=d(n,o),r.addUndoForRemove(l,f),e.findElemById(f.id).remove(),f.remove(),h=$(t.toHTML()).textExcludeSVG().length,l.undo.push(r.buildReplaceUndo(i)),a.isType(t,s.def_link))if(t.safeGetStrAttr("title").length)t.set("title",t.get("title")+u);else{var g=/["']([^"]*)["']\s*$/g.exec(u);u=u.replace(/"([^"])*"\s*$/,""),g&&t.set("title",g[1]),t.set("href",t.get("href")+u)}else t.set("text",t.safeGetStrAttr("text")+u);if(f!=o&&o!==n&&o.get("before")==i&&a.isType(i,s.list_item)){var v=o.getFirstChild();v.set("before",i.getLastChild()),o.giveChildrenTo(i,v),r.addUndoForRemove(l,o),e.findElemById(o.id).remove(),o.remove()}l.redo.push(r.buildReplaceUndo(i)),e.findElemById(i.id).replaceWith(i.toHTML()),p=e.findElemById(t.id)}p=e.findElemById(t.id),e.selection.restoreSelection(p,h),l.redo.push(e.selection.buildUndo())}else e.findElemById(i.id).remove(),r.addUndoForRemove(l,i),i.remove(),f=d(n,o),e.findElemById(f.id).replaceWith(f.toHTML()),e.selection.jumpIntoElemBegin(e.findElemById(f.id))}function C(e,t){var n,o=r.makeEmptyCommand(e.selection.buildUndo()),a=t.get("before"),s=a.get("children").at(a.get("children").length-1).getLastBrother();return o.undo.push(r.buildReplaceUndo(a.get("parent"))),e.findElemById(t.id).remove(),s.insert(t),n=t.unwrap(),o.redo.push(r.buildReplaceUndo(a.get("parent"))),e.findElemById(s.id).after(i.NodeCollectionUtils.toHTML(n)),e.selection.jumpIntoElemBegin(e.findElemById(n[0].id)),o.redo.push(e.selection.buildUndo()),o}function k(e,t){function n(t){var n=r.makeEmptyCommand(e.selection.buildUndo());return r.addUndoForRemove(n,t),e.findElemById(t.id).remove(),t.remove(),n.redo.push(e.selection.buildUndo()),n}a.isType(t,s.line)&&!t.get("before")&&(t=t.get("parent"));var i=t.get("before");return a.isType(i,s.hr)?n(i):i&&!a.isEmptyBlock(t)&&a.isEmptyBlock(i)?n(i):!i&&a.isType(t.get("parent"),s.list_item)&&(i=t.get("parent").get("before"))&&1==i.get("children").length&&a.isEmptyBlock(i.get("children").at(0))?n(i):void 0}function S(e,i){if(a.isType(i,s.table_cell)){var o=i.get("parent").get("parent");if(t&&!n&&!i.get("before")&&!i.get("parent").get("before")&&e.tableEdit.isTableEmpty(o))return e.tableEdit.deleteTable(e.findElemById(o.cid),!0);var c=l.getSibling(i,"before");return c&&(I=r.makeEmptyCommand(e.selection.buildUndo()),e.selection.jumpIntoElemEnd(e.findElemById(c.id)),I.redo.push(e.selection.buildUndo())),I}}function T(e,t){if(a.isType(t,s.line)&&!t.get("before")&&(t=t.get("parent")),a.isType(t.get("parent"),s.list_item)&&t.get("parent").get("before")&&!t.get("before"))return C(e,t.get("parent"))}function E(e,t){if(a.isType(t,a.backToParagraphBeforeDelete))return e.stylize.changeBlock(s.paragraph,t),u}function F(e,t,n,i,o){for(var l=[S,k,p,T,E],c=null,d=0;d<l.length;d++)if(c=l[d](e,t))return c;if(n=a.isType(t,s.line)&&!t.get("before")?n||t.get("parent"):n||t,o=o||n.get("before"),i=i||o&&o.getVeryFirst(!0),!c&&i&&x(e,i,t,o,n,c=r.makeEmptyCommand(e.selection.buildUndo())),!c&&!i&&a.isType(t,s.paragraph)&&a.isEmptyBlock(t)&&t.get("after")){c=r.makeEmptyCommand(e.selection.buildUndo());var u=t.get("after").cid;r.addUndoForRemove(c,t),t.remove(),e.findElemById(t.cid).remove(),e.selection.jumpIntoElemBegin(e.findElemById(u)),c.redo.push(e.selection.buildUndo())}return c}function _(e,t,n){var i,o=e.selection.getDetailPos(t.startContainer,t.startOffset),l=e.selection.getDetailPos(t.endContainer,t.endOffset),c=r.makeEmptyCommand(),d=e.getMarkElem(o[0]),u=e.getMarkElem(l[0]),h=d.closest('[mdtype="table"]'),p=e.findNodeByElem(h),f=e.findNodeByElem(d),m=e.findNodeByElem(u);if(n||((i=t.cloneRange()).collapse(!0),i=e.selection.buildUndo(i)),t.setStart(o[0],o[1]),t.setEnd(l[0],l[1]),f==m)return t.collapsed||!a.isType(f,s.table_cell)||d[0]!=t.commonAncestorContainer&&!d[0].contains(t.commonAncestorContainer)||(c.undo.push(r.buildReplaceUndo(f)),t.extractContents(),e.store(f,!0),c.redo.push(r.buildReplaceUndo(f)),c.redo.push(e.selection.buildUndo(t))),c;var g,v,y=b(e,t,f,c,!0),x=w(e,t,m,c,!0);for(c.undo.push(r.buildReplaceUndo(p)),g=e.tableEdit.getSibling(f,"after");g&&g!=m;)g.set("text",""),v=!0,g=e.tableEdit.getSibling(g,"after");return y||x||v?(e.findElemById(p.id).replaceWith(p.toHTML()),c.redo.push(r.buildReplaceUndo(p))):c.undo.pop(),n||(c.redo.push(i),e.undo.exeCommand(i)),c}function M(t){return t?(/\n/.exec(window.getSelection().toString())?(D.setStart(D.startContainer,0),D.select(D.isBackward)):D=e.selection.getRangy(),D):e.selection.getRangy()}function N(t){return e.selection.deRange(t),A=e.getMarkElem(t.commonAncestorContainer),R=e.nodeMap.allNodes.get(A.attr("cid")),P=t.getBookmark(A[0]),A.length&&!R.get("children").length&&0==P.start&&!n}function L(){var n=null;if(a.isType(R.getClosetParagraphLevel().get("before"),a.TYPE.hr,a.TYPE.toc)&&(n=R.get("before")),e.undo.completeSnap(!0),t&&t.preventDefault(),$(".md-tooltip-remove").remove(),A.prev("[cid]").addClass("md-expand"),(I=F(e,R))===u);else if(!g)return n&&(e.selection.selectNode(n),I.redo.push(e.selection.buildUndo())),e.undo.register(I),e.refresh(),n||e.findElemById(R.cid).trigger("refocus"),e.refocus(),e.selection.scrollAdjust(),I}var A,R,I,P,O=e.selection.getRangy(),D=O&&e.selection.deRange(O.cloneRange()),B=D&&!D.collapsed,j=document.activeElement,H=!1,U=O;if(a.isType(j.getAttribute("mdtype"),a.TYPE.hr,a.TYPE.toc)){var q=$(j).closest("[mdtype]");return m(e,q,t,g)}if(j.getAttribute("mdtype")==s.math_block)return t&&t.preventDefault(),e.mathBlock.remove(j.getAttribute("cid")),I;if(n&&"Backspace"!=n?!0===n&&(n="Delete"):n=!1,D){if($(D.commonAncestorContainer).closest("[mdtype='table_row']").length&&t&&t.shiftKey&&(File.isMac?t.metaKey:t.ctrlKey))return t.preventDefault(),e.tableEdit.deleteRow(),u;if(D.collapsed){if(n){if("Delete"==n&&function(t){return e.selection.deRange(t),A=e.getMarkElem(t.commonAncestorContainer),R=e.nodeMap.allNodes.get(A.attr("cid")),P=t.getBookmark(A[0]),"Delete"==n&&a.isType(A.attr("mdtype"),s.line,s.heading)&&!R.get("children").length&&0==P.start&&0==A.text().length}(D)&&(I=function(){function t(t,n){var i=r.makeEmptyCommand(e.selection.buildUndo());return e.findElemById(t.cid).remove(),r.addUndoForRemove(i,t),t.remove(),e.selection.jumpIntoElemBegin(e.findElemById(n)),i.redo.push(e.selection.buildUndo()),i}if(e.undo.completeSnap(!0),a.isType(R,s.line)){var n=R.get("parent");if(R.get("after"))return t(R,R.get("after").cid);if(n.get("after"))return R.get("before")?t(R,n.get("after").getVeryFirst().cid):t(n,n.get("after").getVeryFirst().cid)}else if(R.get("after"))return t(R,R.get("after").getVeryFirst().cid);return null}()))return g||(e.undo.register(I),e.refocus()),t&&t.preventDefault(),I}else if(N(D))return L();if(!0===(D=function(){var i=t&&(File.isNodeHtml?t.ctrlKey:t.altKey),r=!1;return"delSelection"==n?e.selection.getRangy():(i||(r=e.selection.extendCharFromCollapse(D,!n)),r||(H=!0,n?(window.getSelection().modify("extend","forward",i?"word":"character"),D=e.selection.getRangy()):(window.getSelection().modify("extend","backward",i?"word":"character"),D=M(i))),!n&&/^\u200b|\007F$/g.exec(D.toString())?(e.selection.extendCharFromCollapse(D,!0),N(D)||D):D)}()))return L();if(!n&&d.tryRemovePairStart(e,D)&&(v=!1),"delSelection"==n&&D&&D.collapsed)return t&&t.preventDefault(),r.makeEmptyCommand()}else!function(t){if(e.selection.selectWordTime&&File.isMac)if(n){if("Delete"==n&&t.endContainer.nodeType===document.TEXT_NODE){var i=t.endContainer.textContent,r=i.charAt(t.endOffset);/\s/.exec(r)&&(t.endOffset++,U=t.cloneRange())}}else t.startOffset>0&&t.startContainer.nodeType===document.TEXT_NODE&&(r=(i=t.startContainer.textContent).charAt(t.startOffset-1),/\s/.exec(r)&&(t.startOffset--,U=t.cloneRange()))}(D);if(v&&!(D.commonAncestorContainer.nodeType!=document.TEXT_NODE||0==n&&D.startOffset<=1||"Delete"==n&&D.endOffset>=D.commonAncestorContainer.textContent.length-1))return null;if(e.selection.selectWordTime=null,e.selection.deRange(D),A=e.getMarkElem(D.commonAncestorContainer),R=e.nodeMap.allNodes.get(A.attr("cid")),H&&(window.getSelection().removeAllRanges(),window.getSelection().addRange(O.nativeRange)),A.length&&!R.get("children").length){if(A.get("type")!==s.fences)return function(e,t,n,i,a){var s,l=3!==n.commonAncestorContainer.nodeType,c=e.getNode(i.attr("cid"));a||(e.undo.snap(c.cid,B?o.DELETE_ACCROSS_BLOCK:o.DELETE),e.brush.pause(!0)),(I=r.makeEmptyCommand(e.selection.buildUndo(U))).undo.push(r.buildReplaceUndo(c));var d=h.scrollTop();if(s=n.extractContents(),d!=h.scrollTop()&&e.undo.clearEventTimer(),e.store(c.cid),I.redo.push(r.buildReplaceUndo(c)),c.getText().length||(e.findElemById(c.cid).html($(c.toHTML()).html()),n=e.selection.getRangy(),e.selection.deRange(n,!0)),I.redo.push(e.selection.buildUndo()),s.querySelector("img"),n.collapse(!1),l){var u=i.attr("cid");l=e.selection.saveSelection(i,n),n.setStart(i[0],0);var p=(n.toString().match(/(:\u200b)|(\u200b:)/g)||[]).length;e.store(u,!0),i.replaceWith(e.nodeMap.allNodes.get(u).toHTML()),i=e.findElemById(u),l.start-=p,l.end-=p,e.selection.restoreSelection(i,l),e.focusCid=null,e.refocus()}return e.brush.addToQueue(i.attr("cid")),!a&&e.brush.resume(!0),t&&(t.preventDefault(),$("#write").trigger("input")),I}(e,t,D,A,g);!g&&e.undo.completeSnap(!0),I=m(e,A,t,g)}else!g&&e.undo.completeSnap(!0),t&&t.preventDefault(),$(".md-tooltip-remove").remove(),I=function(e,t,n){if(!document.contains(t.startContainer)&&!(t=e.selection.getRangy()))return r.makeEmptyCommand();var i=e.selection.getDetailPos(t.startContainer,t.startOffset),o=e.selection.getDetailPos(t.endContainer,t.endOffset),s=e.getMarkElem(i[0]),l=e.getMarkElem(o[0]),c=e.findNodeByElem(s),d=e.findNodeByElem(l);if(!c||!d)return r.makeEmptyCommand();var u=a.getTreePosition(c,d),h=u[1],p=u[2],f=r.makeEmptyCommand(e.selection.buildUndo()),m=t.cloneRange();if(s[0]==l[0])return f;if(m.collapse(!0),m=e.selection.buildUndo(m),t.setStart(i[0],i[1]),t.setEnd(o[0],o[1]),$(t.commonAncestorContainer).closest('[mdtype="table"]').length)return r.append(f,_(e,t));var g=b(e,t,h,f),v=w(e,t,p,f),y=h.get("after"),C=[];for(t=e.selection.getRangy(),e.selection.deRange(t,!0);y&&y!=p;)C.push(y),y=y.get("after");return r.addUndoForRemoveArray(f,C,h,p),C.map(function(t){e.findElemById(t.id).remove(),t.remove()}),"abort"==g||"abort"==v||"abortAndSkipCursor"==g?("abortAndSkipCursor"!=g&&(t.collapse(!0),f.redo.push(m),e.undo.exeCommand(m)),!1===v&&0==d.getText().length&&(r.addUndoForRemove(f,d),e.findElemById(d.id).remove(),d.remove())):g||v||C.length||n?x(e,g||c,v||d,h,p,f,g):f=F(e,d,p,c,h),e.refresh(),f}(e,D,n),g||(e.undo.register(I),e.refocus()),e.selection.scrollAdjust();return I}},v={"[mdtype='hr']":g,"tr[mdtype='table_row']":l.deleteRow,".md-toc":m};t.backspaceHandler=g,t.deleteSelectable=m,t.deleteLineProcessor=v,t.deleteLine=function(e){var t,n=e.getMarkElem();if(n&&n.length){for(t in v)if(n.closest(t).length)return void v[t](e,n.closest(t));!function(t){var n=t.hasClass("md-expand");t.addClass("md-expand"),window.getSelection().modify("move","backward","sentence"),window.getSelection().modify("extend","forward","sentence"),n&&t.removeClass("md-expand"),g(e,null,"delSelection")}(n)}},t.backToParagraph=f}),define("app/editor/PairOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core"],function(e,t,n){"use strict";function i(){if(!d){var e="\\{\\(\\[\"'";File.option.autoPairExtendSymbol&&(e+="*`~_",File.option.enableInlineMath&&(e+="$"),File.option.enableSuperscript&&(e+="^"),File.option.enableHighlight&&(e+="=")),d=new RegExp("^["+e+"]$")}return d}function r(){if(!u){var e="\\{\\(\\[\"'";File.option.autoPairExtendSymbol&&(e+="*`~_",File.option.enableInlineMath&&(e+="$"),File.option.enableSuperscript&&(e+="^")),u=new RegExp("["+e+"]")}return u}function o(){if(!h){var e="*`_";File.option.enableInlineMath&&(e+="$"),h=new RegExp("^["+e+"]$")}return h}e("exoskeleton-master/exoskeleton"),e("app/document/StringUtils");var a=e("app/document/Node"),s=e("app/editor/UndoManager"),l=s.SnapFlag,c=(a.Node,a.TYPE,e("rangy/rangy-core.js"),{"(":")","[":"]","{":"}",'"':'"',"'":"'","~":"~","^":"^","=":"=","*":"*","`":"`",$:"$",_:"_"}),d=null,u=null,h=null;t.hanldePair=function(e,t,n,i,r,a){function d(){var t=e.selection.rangy.createRange();i.end++,i.start++,t.moveToBookmark(i),t.select(t.isBackward),r&&r.redo.push(e.selection.buildUndo())}function u(){var i=e.selection.getRangy(),o=document.createTextNode(t+c[t]);return e.undo.completeSnap(!0),e.undo.snap(n.cid,l.ADD),r=r||s.makeEmptyCommand(e.selection.buildUndo()),i.insertNode(o),o.parentElement.normalize(),d(),r}if(!File.option.noPairingMatch){var h,p,f,m;if(/^[\]\)\}'"]$/.exec(t)){if(h=e.findElemById(n.cid).textExcludeSVG(),t===h.substring(i.start,i.start+1))return d(),r||!0;if("'"==t||'"'==t){if(""==h)return u();if(m=h.substring(0,i.start),p=m.slice(-1),t!=p&&"\\"!=p&&!/\w/.exec(h.substring(Math.max(0,i.start-1),i.start+1))&&!function(e,t){for(var n,i,r=e.length,o=0;o<r;o++){var a=e[o];"'"!=a&&'"'!=a||(n?n==a?(n=null,i=null):i=i?null:a:n=a)}return t==n||t==i}(m,t))return u()}}else if(/^[\[\(\{]$/.exec(t)){if(h=e.findElemById(n.cid).textExcludeSVG(),f=h.substring(i.start,i.start+1),!/[^\[\]{}()"'\s`“”‘’«»‹›>$]/.exec(f))return u()}else if(File.option.autoPairExtendSymbol&&o().exec(t)){if(a&&a.commonAncestorContainer&&a.commonAncestorContainer.parentElement&&("CODE"==a.commonAncestorContainer.parentElement.tagName&&"`"!=t||"SCRIPT"==a.commonAncestorContainer.parentElement.tagName&&"$"!=t))return;if(h=e.findElemById(n.cid).textExcludeSVG(),File.option.enableInlineMath&&"$"==h.substring(i.start-1,i.start)&&/[*`^_~=]/.exec(t))return;f=h.substring(i.start,i.start+1);var g=h.substring(i.start+1,i.start+2),v=/[*_]/.exec(t);if(f==t){if(!v)return d()||!0;if(v&&g)return d()||!0;var y=$(e.selection.getRangy().commonAncestorContainer);if(y.closest(".md-after").length||y.parent().parent("em").length)return d()||!0;if(m=h.substring(0,i.start),/[*_]$/.exec(m))return u()}if(m=m||h.substring(0,i.start),!function(e,t){if("`"==t&&/``$/.exec(e))return!0;e.replace(/\\[*`_$]/g,""),"_"==t&&(e=e.replace(/([a-z])_([a-z])/gi,""));for(var n=e.length,i=!1,r=0;r<n;r++)e[r]==t&&(i=!i);return i}(m,t)&&!/[^\s\>\)\]}'";:.,?!~*\/&#=_+-]/.exec(f))return u()}return!1}},t.surroundPair=function(e,t,n){if(!File.option.noPairingMatch){var r,o,a,l,d=$(n.commonAncestorContainer).closest("[cid]"),u=$(n.commonAncestorContainer).closest(".md-def-content:not(.md-def-url)");return(d.length&&!d.find("[cid], .md-def-name").length||u.length)&&i().exec(t)?(o=e.findNodeByElem(d),d=u.length?u:d,r=n.getBookmark(d[0]),l=s.makeEmptyCommand(e.selection.buildUndo()),e.store(o,!0),l.undo.push(s.buildReplaceUndo(o)),a=o.get("text"),o.set("text",a.substring(0,r.start)+t+a.substring(r.start,r.end)+c[t]+a.substring(r.end)),l.redo.push(s.buildReplaceUndo(o)),(n=e.selection.rangy.createRange()).moveToBookmark(r),e.selection.deRange(n),n.insertNodeAtEnd(document.createTextNode(c[t])),n.insertNode(document.createTextNode(t)),r.start++,r.end++,n.moveToBookmark(r),n.select(n.isBackward),l.redo.push(e.selection.buildUndo()),l):void 0}},t.tryRemovePairStart=function(e,t){var n=t.toString();if(!File.option.noPairingMatch&&r().exec(n)){var i=$(t.commonAncestorContainer).closest("[cid]"),o=i.text(),a=t.getBookmark(i[0]);if(c[n]==o.substring(a.end,a.end+1))return a.end++,t.moveToBookmark(a),t}}}),define("app/editor/IndentOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core"],function(e,t,n){"use strict";function i(e,t){var n,i;if(e=e.getClosetParagraphLevel(),d.isType(e.get("before"),u.list))return e;if(!(n=p(e,function(e){return d.isType(e.get("parent"),u.list_item)}))&&t)for(i=t;i;){if(i==e||i.contains(e))return i;i=i.get("after")}return n}function r(e,t){return e=e.getClosetParagraphLevel(),p(e,function(e){return d.isType(e.get("parent"),u.list_item)})}function o(e){return p(e,function(e){return d.isType(e.get("parent"),u.blockquote)})}function a(e,t){return e?e.get("after")?t(e.get("after").getVeryFirst()):a(e.get("parent"),t):null}function s(e,t){for(t=t||1;t>0&&e;)e.unset("tail"),e=e.getLastChild(),t--}e("exoskeleton-master/exoskeleton"),e("app/document/StringUtils");var l=e("app/document/Node"),c=e("app/editor/UndoManager"),d=(c.SnapFlag,l.Node),u=l.TYPE,h=l.NodeCollectionUtils,p=(e("rangy/rangy-core.js"),function(e,t){if(t(e))return e;var n=e.get("parent");return n?p(n,t):null}),f=function(e,t){if(d.isType(e,u.list)&&d.isType(e.get("before"),u.list)&&e.get("style")==e.get("before").get("style"))return e.get("before").appendTillEnd(e.getFirstChild()),e.remove(),t&&t.remove.push(e.cid),!0},m=function(e,t,n,r,o,l){function h(e){var t,n,i,o=e.get("before");if(d.isType(o,u.list))return i=e.get("after"),r.undo.push(c.buildReplaceUndo(o)),c.addUndoForRemove(r,e),o.getLastChild().getLastChild().set("tail",o.get("tail")||o.getLastChild().get("tail")||o.getLastChild().getLastChild().get("tail")),s(o,2),o.getLastChild().append(e),s(e),d.isType(i,u.list)&&i.get("style")==o.get("style")&&(c.addUndoForRemove(r,i),f(i,l)),r.redo.push(c.buildReplaceUndo(o)),l.remove.push(e.cid),l.replace.push(o),!0;if(t=e.get("parent"),n=t.get("before"),!o&&n){var a=n.getLastChild();return r.undo.push(c.buildReplaceUndo(n)),d.isType(a,u.list)?(a.getLastChild().set("tail",n.get("tail")||a.get("tail")),n.set("tail",e.get("tail"))):(n.getLastChild().set("tail",n.get("tail")),s(n),(a=t.get("parent").clone()).unset("start"),s(a),n.append(a),n.set("tail",e.get("tail")),s(e)),p(a,n,e),!0}}function p(e,t,n){var i,o=n.get("parent");return c.addUndoForRemove(r,o),i=n.get("after"),e.append(o),i&&(i.set("before",null),t.set("tail",o.get("tail")),s(o),t.appendTillEnd(i),s(t.getLastChild(),2),f(i,l)),s(o,2),r.redo.push(c.buildReplaceUndo(t)),l.remove.push(o.cid),l.replace.push(t),!0}l=l||{replace:[],remove:[]};var g,v,y,b=t.get("parent");if(t.get("before"))y=h(t);else{if(!b.get("before")){if(v=b.get("parent"),g=v.get("before"),!d.isType(g,u.list)||g.get("style")!=v.get("style"))return!1;r.undo.push(c.buildReplaceUndo(g)),c.addUndoForRemove(r,v),g.getLastChild().set("tail",Math.min(g.get("tail"),1)),g.set("tail",v.get("tail")),f(v,l),r.redo.push(c.buildReplaceUndo(g)),l.remove.push(v.cid),l.replace.push(g)}o.containsNode(document.querySelector("[cid='"+b.getLastChild().cid+"']"),!0)?(y=function(e){var t,n=e.get("before");return!!n&&(r.undo.push(c.buildReplaceUndo(n)),t=n.getLastChild(),d.isType(t,u.list)?t.getLastChild().set("tail",n.get("tail")||t.get("tail")):((t=n.get("parent").clone()).unset("start"),n.getLastChild().set("tail",n.get("tail")),n.append(t),s(t)),c.addUndoForRemove(r,e),t.append(e),n.set("tail",e.get("tail")),s(e,2),r.redo.push(c.buildReplaceUndo(n)),l.remove.push(e.cid),l.replace.push(n),!0)}(b),t=b):y=h(t)}return!y||t==n||t.contains(n)||n.contains(t)||(t=a(t,i))&&m(e,t,n,r,o,l),y&&l},g=function(e,t,n,i,r,l){function d(){var e,n,r=t.get("parent"),o={},a=[];o.oldCid=r.cid,i.undo.push(c.buildReplaceUndo(r)),t.get("before")?(n=[t],a.push(r),t.get("after")&&(e=r.clone(),n.push(e),e.appendTillEnd(t.get("after")),r.insert(e)),r.insert(t),r.set("tail",r.getLastChild().get("tail")),s(r.getLastChild()),a.push(t),e&&a.push(e),i.redo.push(c.buildReplaceUndo(r)),c.addUndoForInsertArray(i,n)):(c.addUndoForRemove(i,t),r.insert(t,!0),c.addUndoForInsert(i,t),a.push(t),r.get("children").length?(i.redo.push(c.buildReplaceUndo(r)),a.push(r)):(c.addUndoForRemove(i,r),r.remove())),o.html=h.toHTML(a),l.push(o)}for(l=l||[],d();t&&t!=n&&!t.contains(n)&&!n.contains(t);)t&&(t=a(t,o)),d();return l},v=function(e,t){for(var n=[],i=e;i!=t;)n.push(i),i=i.get("after");return t&&n.push(t),n},y=function(e,t,n,i,o,l){l=l||[];var p,m,g,b=t.get("before"),w=t.get("parent"),x={};if(b)m=t.getLastBrother(),i.undo.push(c.buildReplaceUndo(w)),x.oldCid=w.get("parent").cid,w.get("after")&&(g=v(w.get("after")),c.addUndoForRemoveArray(i,g),(p=w.get("parent").clone()).unset("start"),w.get("parent").set("tail",w.getLastChild().get("tail")),s(w,2),p.appendTillEnd(w.get("after")),w.append(p),f(p)?p=null:g.push(p),c.addUndoForInsertArray(i,g)),s(t.get("before")),g=v(t),w.get("parent").insertTillEnd(t),i.redo.push(c.buildReplaceUndo(w)),c.addUndoForInsertArray(i,g),t=m,g.unshift(w.get("parent")),x.html=h.toHTML(g),l.push(x);else{var C=w.get("parent").get("parent"),k=C&&C.get("parent");if(!d.isType(k,u.list))return!1;if(w.get("parent").get("before")||w.get("before")){if(i.undo.push(c.buildReplaceUndo(k)),m=w.getLastChild(),!o.containsNode(document.querySelector("[cid='"+w.getLastChild().cid+"']"),!0)&&d.isType(n.get("before"),u.list)){var S=n.get("before");S.getLastChild().getLastChild().set("tail",S.get("tail"),S.getLastChild().get("tail")),s(S,2),S.set("tail",n.getLastBrother().get("tail")),s(n.getLastBrother()),S.getLastChild().appendTillEnd(n)}!function(){var e,t;w.get("after")&&((e=w.get("parent").clone()).unset("start"),w.getLastChild().set("tail",w.get("tail")),s(w),s(w.get("after")),e.appendTillEnd(w.get("after")),w.append(e)),t=(e=w.get("parent")).get("parent"),e.get("after")&&(s(e),w.set("tail",t.get("tail")||w.get("tail")),e.getLastChild().appendTillEnd(e.get("after"))),t.insert(w),0==e.get("children").length&&e.remove(),t.set("tail",t.getLastChild().get("tail")),s(t.getLastChild()),x.oldCid=t.cid,x.html=h.toHTML(v(t,w)),l.push(x)}(),t=m,i.redo.push(c.buildReplaceUndo(k))}else i.undo.push(c.buildReplaceUndo(C)),m=w.getLastChild(),function(){var e,t;t=(e=w.get("parent")).get("parent"),w.detach(),0==e.get("children").length&&e.remove();for(var n,i=w.getLastChild();i;)n=i.get("before"),t.append(i,!0),i=n;x.oldCid=t.cid,x.html=t.toHTML(),l.push(x)}(),t=m,i.redo.push(c.buildReplaceUndo(C))}return m=a(t,r),l&&m&&o.containsNode(document.querySelector("[cid='"+m.cid+"']"),!0)&&y(e,m,n,i,o,l),l};t.moreIndent=function(e){var t=e.selection.getRangy();if(!t||File.isLocked)return!0;if(d.isType(document.activeElement.tagName,"TEXTAREA","INPUT")){var n=$(document.activeElement).closest(".CodeMirror")[0];return n&&n.CodeMirror.execCommand("indentMore"),!0}var r=e.getMarkElem(t.startContainer),o=i(e.findNodeByElem(r)),a=e.getMarkElem(t.endContainer),s=i(e.findNodeByElem(a),o);e.undo.completeSnap(!0),e.brush.pause(),o&&!s&&(s=o.closest(u.list).getLastChild().getFirstChild());var l=!1;if(o&&s){var h=e.selection.buildUndo(),p=c.makeEmptyCommand(h);return(l=m(e,o,s,p,t))&&(p.redo.push(h),l.remove.forEach(function(t){e.findElemById(t).remove()}),l.replace.forEach(function(t){t.isDeleted()||e.findElemById(t.cid).replaceWith(t.toHTML())}),e.undo.exeCommand(h),e.undo.register(p)),e.refresh(),e.selection.scrollAdjust(),e.brush.resume(),l||o!==s}return e.brush.resume(),!1},t.lessIndent=function(e){function t(){e.undo.completeSnap(!0),e.brush.pause(),a=e.selection.buildUndo(),s=c.makeEmptyCommand(a)}var n=e.selection.getRangy();if(!n||File.isLocked)return!0;if(d.isType(document.activeElement.tagName,"TEXTAREA","INPUT")){var i=$(n.startContainer).closest(".CodeMirror")[0];return i&&i.CodeMirror.execCommand("indentLess"),!0}n=e.selection.deRange(n);var a,s,l=e.getMarkElem(n.startContainer),h=r(e.findNodeByElem(l)),p=e.getMarkElem(n.endContainer),f=r(e.findNodeByElem(p));h&&!f&&(f=h.closest(u.list).getLastChild().getFirstChild());var m=!1;if(h&&f&&(t(),m=y(e,h,f,s,n)),m||(h=o(e.findNodeByElem(l).getClosetParagraphLevel()),f=o(e.findNodeByElem(p).getClosetParagraphLevel()),d.isType(h,u.paragraph,u.def_footnote,u.def_link,u.heading)&&f&&(t(),m=g(e,h,f,s,n))),m){for(var v=0;v<m.length;v++)Object.keys(m[v])[0],e.findElemById(m[v].oldCid).replaceWith(m[v].html);e.undo.exeCommand(a),s.redo.push(a),e.mathBlock.renderAll(),e.undo.register(s)}return e.brush.resume(),m&&h!=f}}),define("app/editor/ClipboardOp",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/document/Node","app/editor/UndoManager","rangy/rangy-core","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji","app/editor/TableEdit","app/editor/polyfill","app/editor/ConvertUtils","app/editor/TableEdit","app/editor/Stylize","app/window/MenuHelper","app/editor/Emoji","app/window/FileHelper","app/editor/DeleteOp","app/editor/ConvertUtils","app/editor/Stylize","app/editor/PairOp"],function(e,t,n){"use strict";function i(e){var t=r(e,null,!0);return"string"==typeof t?t:h.convertToPlain(t)}function r(e,t,n){t||(F.reset(!0),t=F);var i,r,o=$($.parseHTML("<div>"+e+"</div>")[0]),a=[],s=o.children("[mdtype]");return s.length?(s.each(function(){(r=d.reverse($(this),t,n)).set("before",i),i=r,a.push(r)}),a):n?(o.find("[data-emoji]").text(function(){return this.getAttribute("data-emoji")}),o.find(".md-meta, .md-content").remove(),o.text()):o.textExcludeSVG()}function o(e,t,n){var i=r(e,t);if(d.isType(i[0],u.line)){var o=new d({type:u.paragraph,in:i[0].get("in")});return i.map(function(e){o.append(e)}),[o]}return i}function a(e){var t=o(e);return"string"==typeof t?t:d.markFromArr(t)}e("exoskeleton-master/exoskeleton");var s=e("app/document/StringUtils"),l=e("app/document/Node"),c=e("app/editor/UndoManager"),d=(c.SnapFlag,l.Node),u=l.TYPE,h=(l.NodeCollectionUtils,e("rangy/rangy-core.js"),e("app/document/MarkParser"),e("app/editor/TableEdit"),e("app/editor/ConvertUtils")),p=e("app/editor/Stylize"),f=e("app/editor/Emoji"),m=e("app/window/FileHelper"),g=e("app/editor/DeleteOp"),v=window.reqnode?reqnode("electron").remote:null,y="",b=g.backspaceHandler,w=function(e,t,n,i,r,o){t=t||(l=e.getMarkElem(),e.getNode(l.attr("cid")));var a=e.getJQueryElem(window.getSelection().anchorNode),l=e.findElemById(t.id);if(d.noChangeLine(t)&&(n=n.trim().split(/[\n\r]+/gi)[0]),"\n"==n&&l.text().length<=i&&(n="\n​"),r&&r.undo.push(c.buildReplaceUndo(t,void 0)),a.hasClass("md-def-name"))l=a.closest("[cid]"),e.docMenu.getAttrByElem(a),e.selection.getRangy().insertNode(document.createTextNode(s.escape(n))),t.set("ref",a.text());else if(a.hasClass("md-def-url"))l=a.closest("[cid]"),e.docMenu.getAttrByElem(a),n=n.replace(/\s/gi,""),e.selection.getRangy().insertNode(document.createTextNode(s.escape(n))),t.set("href",a.text());else if(a.hasClass("md-def-title"))l=a.closest("[cid]"),e.docMenu.getAttrByElem(a),e.selection.getRangy().insertNode(document.createTextNode(s.escape(n))),t.set("title",a.text());else{var h,p="",f=i;a.hasClass("md-meta-block")&&0==a.text().length&&"\n​"==n?h="\n\n":(a.hasClass("md-meta-block")&&p.length==i&&"\n"==p[i-1]?i--:a.closest(".md-def-content").length?(f-=t.get("ref").length,p=a.closest(".md-def-content").textExcludeSVG()):(p=l.textExcludeSVG(),d.isType(t,u.meta_block)&&(p=p.replace(/\n$/,""))),h=void 0!==f?p.substring(0,f)+n+p.substring(f):p.text()+n),t.set("text",h.replace("​","")),l.html($(t.toHTML()).html())}r&&(e.store(t,!0),r.redo.push(c.buildReplaceUndo(t,void 0)));var m={id:t.id,type:"cursor",start:i+n.length};o&&(e.undo.exeCommand(m),e.brush.addToQueue(t.id)),r&&r.redo.push(m),e.brush.addToQueue(t.id),l=e.findElemById(t.id),o&&l.addClass("md-focus")},x=function(e,t,n,i,r){if(File.isMac)setTimeout(function(){i&&app.clipboard.clearContents(),e&&app.clipboard.copyForType(E(e)[0],"text/html"),app.clipboard.copyForType(t,"text/markhtml"),n&&app.clipboard.copyForType(n,"text/plain")},20);else if(File.isNode&&r){if("cut_before"===File._CopyContentFlag||"cut"==r.type&&e){if(!e)return setTimeout(v.getCurrentWindow().webContents.copy,30),void(File._CopyContentFlag="cut_after");b(File.editor,null,"delSelection"),File._CopyContentFlag=!1}else if("cut_after"===File._CopyContentFlag)File._CopyContentFlag=!1,e=(E(v.clipboard.readHTML())||[])[0],b(File.editor,null,"delSelection");else if(e&&!File._CopyContentFlag);else{if(!File._CopyContentFlag)return File._CopyContentFlag=!0,void(!e&&setTimeout(v.getCurrentWindow().webContents.copy,30));!0===File._CopyContentFlag&&(e=(E(v.clipboard.readHTML()||e)||[])[0]||""),File._CopyContentFlag=!1}n&&r.clipboardData.setData("text/plain",n),e&&r.clipboardData.setData("text/html",e),t&&r.clipboardData.setData("text/markhtml",t),r.preventDefault()}else File.isNode&&v.clipboard.write({html:E(e)[0]||n,text:n})},C=function(e,t,n){t=t||File.editor;var i,r,o,a;return e.find(".md-fences").toArray().map(function(e){i=e.getAttribute("cid"),(r=$(e)).attr("lang",r.attr("lang")),r.text(t.fences.getValue(i))}),n&&n.skipEmoji||e.find(".md-emoji").toArray().map(function(e){(r=$(e)).text(":"+r.attr("data-content")+":")}),e.find("[mdtype='math_block']").toArray().map(function(e){i=e.getAttribute("cid"),(r=$(e)).text(t.mathBlock.getTex(i))}),e.find(".md-math-after-sym").remove(),(o=e.children("li[cid]")).length&&((a=$(document.querySelector("[cid='"+o[0].getAttribute("cid")+"']").parentElement).clone()).empty().append(o).wrap("div"),e=a.parent()),e},k=function(e,t){var n=$($.parseHTML("<div>"+e+"</div>"));return C(n,t)},S=function(e,t){e=e||File.editor;var n=document.activeElement,i=e.selection.getRangy();if(e.sourceView.inSourceMode)x(null,null,File.editor.sourceView.cm.getSelection(),!0,t);else if("HR"==n.getAttribute("mdtype"))x(null,null,"---",!0,t);else if(n.getAttribute("mdtype")!==u.math_block||i&&!i.collapsed){if("INPUT"==n.tagName||"TEXTAREA"==n.tagName||0==n.childElementCount)x(null,null,n.value||n.innerText,!0,t);else if(window.getSelection().rangeCount){var r="";r=k(i.toHtml(),e).html(),x(null,r,a(r),!0,t)}}else x(null,null,"$$\n"+e.mathBlock.getTex(n.getAttribute("cid"))+"\n$$",!0,t);File._CopyContentFlag=!1},T=function(e,t){function n(n){var i="",r=o(i=k(n,e).html()),a=e.export.exportCollection(r,null,!0,!0,!0);x(null,"<pre mdtype='fences' lang='HTML'>"+s.escape(a)+"</pre>",a,!0,t)}e=e||File.editor;var i=document.activeElement,r=e.selection.getRangy();if(e.sourceView.inSourceMode)x(null,null,File.editor.sourceView.cm.getSelection(),!0,t);else if("HR"==i.getAttribute("mdtype"))x(null,null,"<hr/>",!0,t);else if(i.getAttribute("mdtype")!==u.math_block||r&&!r.collapsed)if("INPUT"==i.tagName||"TEXTAREA"==i.tagName||0==i.childElementCount){if(i.classList.contains("md-content")&&r.toString()==i.textContent){var a=$(i).closest(".md-image");if(a.length)return void n(a[0].outerHTML)}x(null,null,i.value||i.innerText,!0,t)}else window.getSelection().rangeCount&&n(r.toHtml());else x(null,null,"$$\n"+e.mathBlock.getTex(i.getAttribute("cid"))+"\n$$",!0,t)},E=function(e){if(!e)return"";var t=$.parseHTML(e||""),n="<!DOCTYPE html>",i="<!DOCTYPE html>",r=File.option.showLineNumbersForFence?"  ":"";if(!t)return["",""];t.map(function(e){var t=$(e),o=t.find(".md-emoji").andSelf(".md-emoji");o.text(function(e){return $(o[e]).children("[data-emoji]").attr("data-emoji")}),t.find(".md-table-edit, .md-meta, .md-content").remove(),t.find("[cid].md-fences").andSelf("[cid].md-fences").html(function(){var e=this.querySelectorAll("pre");if(e.length){for(var t=[],n=0;n<e.length;n++)e[n].innerHTML&&t.push(r+e[n].innerHTML);return t.join("<br/>")}return this.innerHTML+"<br/><br/>"}),t.find(".md-line, h1, h2, h3, h4, h5, h6, .md-def-link, .md-def-footnoote").css("width",""),t.find(".md-def-name").before("[").after("]   "),n+=e.outerHTML||e.textContent,e.getAttribute&&e.getAttribute("mdtype")==u.toc||(t.find(".md-toc").remove(),t.find(".mathjax-block").andSelf(".mathjax-block").html(function(){try{return File.editor.findElemById(this.getAttribute("cid")).find("script").text()}catch(e){return""}}).css("font-size","1rem"),t.find(".md-line").oldReplaceWith(function(){return this.innerHTML+(this.nextSibling?"\n":"")}),t.find("li p").oldReplaceWith(function(){return this.innerHTML+(this.nextSibling?"\n":"")}),t.find("ul, ol, .md-def-link, .md-def-footnoote, blockquote, .md-fences, .mathjax-block").after("<br/>"),t.find(".md-def-name").before("[").after("]   "),i+=e.outerHTML||e.textContent,d.isType(e.tagName,"UL","OL")&&(i+="<br/>"))});return[n,i]},F=new l.NodeMap,_=function(e,t,n){function i(e,t){return e.get("attr")&&e.get("attr").trim().length?e.get("attr"):void 0}function r(e){return d.isType(e,d.TYPE.line,d.TYPE.heading,d.TYPE.raw_edit,d.TYPE.fences,d.TYPE.table_cell)?e.get("text"):(!d.isType(e,u.def_footnote)||i(e,"ref")&&i(e,"text"))&&(!d.isType(e,u.def_link)||i(e,"ref")&&i(e,"href"))?e.get("children").toArray().reduce(function(e,t){return e+r(t)}," "):i(blocks[0],"ref")||i(blocks[0],"href")||i(blocks[0],"text")||i(blocks[0],"title")||""}function a(t,n,i,o){function a(e){for(var t,n=e.getFirstChild().getFirstChild(),i=[];n;)t=n,i.push(n),n=l.getSibling(n),t.detach();return e.remove(),i}var s,l=e.tableEdit.TableEdit,h=t.get("parent").get("parent"),p=t,f=p;o.undo.push(c.buildReplaceUndo(h));var m=[];i.forEach(function(e,t){e.get("type")==u.table?m=m.concat(a(e)):m.push(e)});for(var g=0;g<m.length&&p;g++)s=function(e,t,n,i){var o=e.safeGetStrAttr("text"),a=r(n).replace(/\r?\n/g," ");return e.set("text",o.substr(0,t)+a+o.substr(t)),t+a.length}(p,0===g?n:0,m[g]),f=p,p=d.isType(m[g],u.table_cell)?l.getSibling(p,!1,!0):l.getNextCellInColumn(p);e.findElemById(h.id).replaceWith(h.toHTML()),o.redo.push(c.buildReplaceUndo(h)),void 0!==s?e.selection.jumpInto(e.findElemById(f.id),s):e.selection.jumpIntoElemEnd(e.findElemById(f.id)),o.redo.push(e.selection.buildUndo())}function s(e){for(var t=[],n=-2,i=0;i<e.length;i++){var r=e[i];d.isType(r,u.table_cell)?(n!==i-1?(r.set("type",u.paragraph),t.push(r)):(t.last().set("text",t.last().get("text")+"  "+r.get("text")),r.remove()),n=i):t.push(r)}return t}function f(t,n,i,r,o){i.undo.push(e.selection.buildUndo());var s=o(r,e.nodeMap,e,y);if("string"==typeof s)return g(t,n,s,i);if(0!=s.length){if(d.isType(t,u.table_cell))a(t,n,s,i);else if(d.isType(t,u.table_row,u.table));else{var l=t.getClosetBlock();d.isType(l.get("parent"),u.list_item)?i.undo.push(e.undo.buildReplaceUndo(l.get("parent"))):i.undo.push(e.undo.buildReplaceUndo(l));var c=t===e.nodeMap.getFirst()&&0===n,h=[];s.map(function(e,t){d.isType(e,u.meta_block)&&!(0==t&&c)&&h.push(e)}),h.map(function(e){s.remove(e)});var p=d.splitAt(t,n,e,d.genNormalSplitExitFunc(!1,!1,!0));v(p.prev,p.next,s,i,p.opt_prev,p.opt_next)}e.undo.register(i)}}function m(e,t,n){var i=e.canContainBlock()?e.getLastChild():e,r=t.canContainBlock()?t.getFirstChild():t,o=-1;if(!r.canContainBlock()){var a=r.getVeryFirst(),s=i.getVeryFirst(!0);o=s.get("text").length,s.set("text",s.get("text")+a.get("text")),0==o&&d.isType(i,u.paragraph)&&1==i.get("children").length&&!d.isType(a,u.line)&&(d.property.map(function(e){i.set(e,a.get(e))}),i.set("text",s.get("text")),s.remove()),a.remove(),r.isDeleted()||(0==r.get("children").length?r.remove():d.isType(r,u.paragraph)&&d.isType(i,u.paragraph)&&(i.getLastChild().insertTillEnd(r.getFirstChild()),r.remove())),r.isDeleted()||0!=r.get("children").length||r.remove()}return r.isDeleted()||(i.insert(r),d.isEmptyBlock(i)&&i.remove()),t.isDeleted()||(0==t.get("children").length?t.remove():d.isType(t,u.list_item)?(e.getLastChild().insertTillEnd(t.getFirstChild()),t.remove()):d.isType(t,u.paragraph)&&d.isType(e,u.paragraph)&&(e.getLastChild().insertTillEnd(t.getFirstChild()),t.remove())),n&&n.redo.push(c.buildReplaceUndo(e)),o}function g(t,n,i,r){var o=i.split(/\r?\n/g);if(o.length>1&&!o[0].trim().length&&o[1].trim().length&&(o=o.slice(1)),d.noChangeLine(t)&&(o=[o[0]]),o.length<=1||p.CONST.NoInline.indexOf(t.get("type"))>-1)w(e,t,o.join("\n"),n,r,!0),e.undo.register(r);else{r.undo.push(e.selection.buildUndo()),r.undo.push(c.buildReplaceUndo(t.getClosetParagraphLevel()));var a=d.splitAt(t,n,e,d.genNormalSplitExitFunc(!1,!1,!0)),s=d.parseFrom(o.join("\n"),a.prev.get("in"),{noTop:!a.prev.get("attachTo")||n,skips:{old_code:!1}},!0);v(a.prev,a.next,s[1],r,a.opt_prev,a.opt_next),e.undo.register(r)}}function v(t,n,i,r,o,a){function h(e){for(var t=1;t<e.length;t++)if(e[t].get("type")!=e[t-1].get("type"))return!1;return!0}function p(e){var t=e.get("after"),s=e.get("parent");if(r.undo.push(c.buildReplaceUndo(e)),d.isType(i[0],u.list)?(g=e.id,e.insert(i[0]),m(e,(v=i[0].unwrap().clone()).shift(),r),v.length&&c.addUndoForInsertArray(r,v),v.unshift(e),i.shift(),n.isDeleted()||(y=m(v.last().getVeryFirst(!0,!0),n,r))):h(i)&&d.isType(i[0],u.list_item)?(e.insertArray(i,!1,!0),m(e,i.shift(),r),(v=i.clone()).length&&c.addUndoForInsertArray(r,v),v.unshift(e),n.isDeleted()||(y=m(v.last().getVeryFirst(!0,!0),n,r))):(t=new d({type:u.list_item}),e.insert(t),i.map(function(e){t.append(e)}),m(e,t,r),v=[e],i=[]),!n.isDeleted()&&v.push(n),i.length){var l;g=s.cid,s.insertArray(i,!1,!0),v=(v=[s]).concat(i),t&&(g=s.cid,r.undo.push(c.buildReplaceUndo(s)),s.unset("ahead"),s.unset("tail"),(l=s.clone()).unset("start"),s.giveChildrenTo(l,t,null,!0),i.last().insert(l),v.push(l)),a=null,o=null}else f=v.last()}var f,g=t.id,v=i.slice(0),y=-1;i=s(i),f=i.last().getVeryFirst(!0),(d.isEmptyBlock(n)||d.isType(n,u.list_item)&&1==n.get("children").length&&d.isEmptyBlock(n.getFirstChild()))&&n.remove(),d.isType(t,u.blockquote,u.list)||(!function(e){if(d.isType(e,u.list_item))p(e);else{r.redo.push(c.buildReplaceUndo(e)),1==i.length&&d.isType(i[0],u.blockquote)&&d.isType(e.get("parent"),u.blockquote)?(e.insert(i[0]),i=i[0].unwrap(),(v=i.slice(0)).unshift(e)):(e.insertArray(i,!1,!0),v=[e].concat(i));var t,s=e.get("after");d.isType(s,u.table)||(e.canContainBlock()||!s||s.canContainBlock()||(m(e,s,r),s.isDeleted()&&(i.remove(s),v.remove(s))),t=v.last().getVeryFirst(!0,!0),n.isDeleted()||n.canContainBlock()||t.canContainBlock()||(f=t.getVeryFirst(!0),y=m(t,n,r))),i.length&&c.addUndoForInsertArray(r,i),d.isEmptyBlock(e)&&!s.isDeleted()&&(c.addUndoForRemove(r,e),e.remove(),v.remove(e)),o&&v.unshift(o),!n.isDeleted()&&v.push(n),y<0&&(f=v.last()),a&&v.push(a)}}(t),n.isDeleted()||c.addUndoForInsert(r,n),o&&c.addUndoForInsert(r,o),a&&c.addUndoForInsert(r,a),e.findElemById(g).replaceWith(l.NodeCollectionUtils.toHTML(v)),y>=0?e.selection.jumpInto(e.findElemById(f.cid),y):f==n?e.selection.jumpIntoElemBegin(e.findElemById(n.cid)):e.selection.jumpIntoElemEnd(e.findElemById(f.getVeryFirst(!0).cid)),r.redo.push(e.selection.buildUndo()),setTimeout(function(){e.refresh(),e.selection.scrollAdjust()},100))}y="",File._PasteContentFlag=!1;var x="string"!=typeof t||n?null:t,C="string"==typeof t&&n?t:null,k="object"==typeof t?t:null;if("INPUT"==document.activeElement.tagName)return!0;if("TEXTAREA"==document.activeElement.tagName){if(!k&&C){var S=$(document.activeElement).closest(".CodeMirror");S&&(S=S[0].CodeMirror).replaceSelection(C)}return!0}if(d.isType(L,u.hr))return!1;if("BODY"==document.activeElement.tagName)return!1;e.undo.completeSnap(!0);var T,E,F,_=e.selection.prepNode("​",null,!0)||c.makeEmptyCommand(),M=e.getMarkElem(),L=e.findNodeByElem(M),A=File.isNode?reqnode("electron").remote.app:window.app;if(k){if(k.preventDefault(),(C=k.clipboardData.getData("text/plain"))&&(C=C.replace(/(\r?\n)$/,"")),x=k.clipboardData.getData("text/html"),F=k.clipboardData.getData("text/markhtml"),File.isMac&&!x&&!F){var R=A.clipboard.getHTML()||["",""];x=R[0],y=R[1]}}else C||File.isMac&&(C=A.clipboard.paste());if(File.isMac&&!x&&!F&&!n){var I=A.ipic.getImageInClipboard();if(I&&I.length)return N(e,I),e.selection.scrollAdjust(),!1}if(File.isNode&&!x&&!F&&!n&&e.imgEdit.getTagetImageStorageFolder()){var P=reqnode("electron").clipboard.readImage();if(!P.isEmpty()){var O=A.getPath("temp").replace(/[\/\\]$/,"")+(File.isWin?"\\\\":"/")+Number(new Date)+".png";try{reqnode("fs").writeFileSync(O,P.toPNG())}catch(e){return!1}return N(e,[O]),e.selection.scrollAdjust(),!1}}_.undo.push(e.selection.buildUndo()),_=c.append(_,b(e,k,"delSelection",!0)),L=e.findNodeByElem(e.getMarkElem()),E=(T=e.selection.getRangy()).getBookmark(e.findElemById(L.id)[0]).start,n=n||T.startContainer&&$(e.getJQueryElem(T.startContainer)).closest(".md-def-url, .md-def-name, .md-def-title, pre, code").length,F&&!n?f(L,E,_,F,o):x&&!n?f(L,E,_,x,h.parseHTML):g(L,E,C,_),e.selection.scrollAdjust()},M=function(e,t){if(!File.isLocked){var n=(t=t||File.editor).getMarkElem(),i=t.findNodeByElem(n).getClosetBlock(),r=new d({type:u.paragraph}),o=c.makeEmptyCommand(t.selection.buildUndo());i.insert(r,e);var a=r.append(new d({type:u.line,text:""}));c.addUndoForInsert(o,r),e?t.findElemById(i.cid).before(r.toHTML()):t.findElemById(i.cid).after(r.toHTML()),t.selection.jumpIntoElemBegin(t.findElemById(a.cid)),o.redo.push(t.selection.buildUndo()),t.undo.register(o),t.refocus()}},N=function(e,t){if(window.app){if(app.document.isLocked())return}else if(File.isLocked)return!1;e.sourceView.inSourceMode||t.forEach(function(t,n){n&&M(!1,e),L(e,t)})},L=function(e,t){if(t)if(/\.(png|jpe?g|svg|gif|bmp|webp|tiff)$/gi.exec(t))e.imgEdit.doInsertFromURL(t);else{var n=m.getFileNameFromPath(t),t=s.getRelativePath(m.getCurrentFileFolderPath(),t),i="["+n.replace(/(^|[^\\])]/,"$1\\]")+"]("+t.replace(/(^|[^\\])\)/,"$1\\)")+")";_(e,i,!0)}};t.getMarkdownSourceFrom=a,t.copyAsMarkdown=S,t.copyAsHTMLSource=T,t.copyHandler=function(e,t){if("copyAsMarkdown"===File._CopyContentFlag)return S(e,t);if("copyAsHTMLSource"===File._CopyContentFlag)return T(e,t);var n=document.activeElement,r=e.selection.getRangy();if(e.sourceView.inSourceMode&&x(null,null,File.editor.sourceView.cm.getSelection(),!0,t),"hr"==n.getAttribute("mdtype"))x(n.outerHTML,null,"---",!0,t);else if("toc"==n.getAttribute("mdtype"))x(n.outerHTML,"<div mdtype='toc'><div>","[toc]",!0,t);else if("IMG"==n.tagName)x(n.outerHTML,null,n.getAttribute("src"),!0,t);else if(n.getAttribute("mdtype")!==u.math_block||r&&!r.collapsed){if("INPUT"==n.tagName||"TEXTAREA"==n.tagName)return t||console.error("in copyHandler : shouldn't be here"),!0;if(window.getSelection().rangeCount){if(!File._CopyContentFlag&&File.isNode)return File._CopyContentFlag=!0,v.clipboard.writeHTML(""),void setTimeout(v.getCurrentWindow().webContents.copy,0);var o=r.toHtml(),s=$($.parseHTML("<div>"+o+"</div>"));s.find(".md-emoji").text(function(){return f.data[this.getAttribute("data-content")]}),s.find(".math-jax-postprocess").text(function(){return this.querySelector("script").textContent.replace(/\u200B*/g,"")}).parent().addClass("md-expand");var l=(s=C(s,e,{skipEmoji:!File.option.copyMarkdownByDefault})).html(),c=File.option.copyMarkdownByDefault?a(l):i(l).replace(/\u200B/gi,"");x(null,l,c,!1,t)}}else{var d=e.mathBlock.getTex(n.getAttribute("cid"));x(n.querySelector(".MathJax_Display").outerHTML,"<div mdtype='"+u.math_block+"'>"+d+"</div>",d,!0,t)}},t.insertInlineText=w,t.pasteHandler=_,t.setClipboard=x,t.insertURLs=N,t.prepMarkHtml=k,t.insertParagraph=M,t.processClipboardHTML=E}),define("app/editor/DocMenu",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji","app/editor/Selection","rangy/rangy-core","codemirror/lib/codemirror","app/window/FileHelper","app/editor/UndoManager"],function(e,t,n){"use strict";function i(e,t){for(var n=e.find(".outline-item-wrapper"),i=0;i<n.length;i++)n[i].querySelector(".outline-item-wrapper")?t&&n[i].classList.contains("outline-h1")&&n[i].classList.add("outline-item-open"):n[i].classList.add("outline-item-signle")}function r(){return a||(a=new p.InlineLexer(null,b)),a}function o(e,t){return new RegExp("^s*"+e+"s*:s*(.*)$","mig").exec(t)}var a,s=e("app/document/StringUtils"),l=e("exoskeleton-master/exoskeleton"),c=e("app/document/Node"),d=c.Node,u=c.TYPE,h=e("jquery/jquery"),p=e("app/document/MarkParser"),f=(e("app/editor/Selection").rangy,e("app/window/FileHelper")),m=e("app/editor/UndoManager"),g=window.reqnode?reqnode("electron").remote:null,v=g?g.app:window.app,y=l.Collection.extend({model:d,getNodeByRef:function(e){for(var t in this.models)if(this.models.hasOwnProperty(t)){var n=this.models[t];if(s.escape(n.get("ref")).toLowerCase()==s.escape(e).toLowerCase())return n}},getFootHTMLByRef:function(e,t){var n=this.getNodeByRef(e);return n?(t&&File.editor.store(n.cid,!0),"<div class='code-tooltip md-tooltip-remove md-hover-tip md-f-tooltip' contenteditable='false'><div class='md-arrow' /><div class='code-tooltip-content'>"+editor.brush.inline.output(n.get("text"))+"</div></div>"):null},getHrefByRef:function(e,t){var n=this.getNodeByRef(e);return n&&t&&File.editor.store(n.cid,!0),n?s.escape(n.get("href")):void 0}}),b=function(e){switch(e.type){case u.strong:return"<strong>"+e.inner+"</strong>";case u.em:return"<em>"+e.inner+"</em>";case u.code:return"<code>"+s.escape(e.text)+"</code>";case u.plain:return e.text;case u.tag:case u.imgtag:return s.escape(e.text);case u.del:return"<del>"+e.inner+"</del>";case u.footnote:return"";case u.escape:return e.text;default:return e.inner||e.text||""}},w=l.Model.extend({initialize:function(e){this.nodeMap=e,this.refresh(),this.delay=200,this.refreshTimeout=null},remove:function(e){var t=this.headers.indexOf(e);t>-1&&this.headers.splice(t,1)},refresh:function(e,t){function n(){var e=this.nodeMap.getFirst();for(this.headers=[];e;)d.isType(e,d.TYPE.heading)?this.headers.push(e):File.option.expandSimpleBlock&&d.isType(e,d.TYPE.paragraph)&&e.get("depth")&&this.headers.push(e),e=e.get("after");!t&&this.updateHTML(),this.refreshTimeout=null}var i=this;this.refreshTimeout&&clearTimeout(this.refreshTimeout),e?n.call(i):this.refreshTimeout=setTimeout(function(){n.call(i)},this.delay)},getTocInnerHTML:function(){var e=function(e){var t=e.get("text");return d.isType(e,d.TYPE.paragraph)&&(t=e.getText().replace(/^#+\s*/,"").replace(/\n.*/,"")),"<span class='md-toc-item md-toc-h"+e.get("depth")+"' data-ref='"+e.cid+"'><a class='md-toc-inner'>"+a.output(t)+"</a></span>"},t="";return(this.headers||[]).map(function(n){n.isDeleted()||(t+=e(n))}),t},updateHTML:function(){var e=0,t=document.querySelectorAll(".md-toc-content");if(t.length>0){var n=this.getTocInnerHTML();for(e=0;e<t.length;e++)t[e].innerHTML!=n&&(t[e].innerHTML=n)}this.updateOutlineHtml()},updateOutlineHtml:function(){if(document.body.classList.contains("pin-outline")){var e=document.querySelector("#outline-content"),t=C(this),n=e.scrollTop,r=!document.body.classList.contains(".no-collapse-outline"),o=[],a=0==e.innerHTML.trim().length;if(function(e,t){var n=h(h.parseHTML("<div>"+e+"<div>")[0]),i=h(h.parseHTML("<div>"+t+"<div>")[0]);return n.find(".outline-item-open, .outline-active").removeClass("outline-item-open").removeClass("outline-active"),i.find(".outline-item-open, .outline-active").removeClass("outline-item-open").removeClass("outline-active"),n.html()==i.html()}(e.innerHTML,t))return;r&&!a&&h(e).find(".outline-item-open>.outline-item>.outline-label").map(function(){o.push(this.getAttribute("data-ref"))}),e.innerHTML=C(this),e.scrollTop=n,r&&(i(h(e)),h(e.querySelector(".outline-active")).parents(".outline-item-wrapper:not(.outline-item-signle)").addClass("outline-item-open"),a?1==e.children.length&&e.children[0].classList.add("outline-item-open"):o.forEach(function(t){var n=e.querySelector("[data-ref='"+t+"']");n&&((n=n.parentElement.parentElement).classList.contains("outline-item-signle")||n.classList.add("outline-item-open"))})),File.editor.docMenu.highlightVisibleHeader()}}}),x=null,C=function(e){function t(e){i+="<li class='outline-item-wrapper outline-h"+e.get("depth")+"'><div class='outline-item'><span class='outline-expander'></span><span class='outline-label' data-ref='"+e.cid+"'>"+a.output(e.get("text"))+"</span></div><ul class='outline-children'>",o.push(e.get("depth"))}function n(){i+="</ul></li>",o.pop()}var i="",o=[],a=r();try{!function(e){for(var i=0;i<e.length;i++){t(e[i]);var r=e[i+1]?e[i+1].get("depth"):1;if(r<=e[i].get("depth"))for(;o.last()&&o.last()>=r;)n()}}(e.headers)}catch(e){window.debugMode&&console.warn(e.stack),i=""}return i},k=l.Model.extend({initialize:function(e){var t=this;r(),this.headerStr="h1, h2, h3, h4, h5, h6, [mdlike='h1'], [mdlike='h2'], [mdlike='h3'], [mdlike='h4'], [mdlike='h5'], [mdlike='h6']",this.expandedOutlineItem=[],e.nodeMap.foot_list=new y,e.nodeMap.link_list=new y,e.nodeMap.toc=new w(e.nodeMap),this.editor=e,function(){function e(){n=!1,setTimeout(function(){n||h(".md-f-tooltip").remove()},500)}var n,i,r=t.editor;setTimeout(function(){h(document).on("mouseenter mousemove",".md-footnote",function(){if(!n||i!==r.focusCid){if(window.getSelection().anchorNode&&this.contains(window.getSelection().anchorNode.parentElement))return;n=!0,i=r.focusCid,t.showTooltipForSup(h(this))}}).on("mouseleave",".md-footnote",e).on("mouseenter",".md-f-tooltip",function(){n=!0}).on("mouseleave",".md-f-tooltip",e)},300)}(),h(document).on("mousedown",".md-toc-inner",function(t){if(1===t.which){var n=this.parentElement.getAttribute("data-ref"),i=e.findElemById(n);return e.store(),e.undo.completeSnap(!0),e.selection.jumpIntoElemEnd(i),e.selection.scrollAdjust(i,10),!1}}).on("mousedown",".md-delete-toc",function(t){1===t.which&&e.UserOp.deleteSelectable(e,h(this).closest(".md-toc"))}).on("click","#md-notification .close-btn",function(e){h("#md-notification").hide()}),h(document).on("click",".outline-expander",function(e){var t=this.nextElementSibling.getAttribute("data-ref");h(".outline-label[data-ref='"+t+"']").parent().parent().toggleClass("outline-item-open")}).on("click",".outline-label",function(n){var i=this.getAttribute("data-ref"),r=e.findElemById(i);e.undo.completeSnap(!0),e.selection.scrollAdjust(r,10),File.isFocusMode&&e.updateFocusMode(!1),t.autoHideOutline()}).on("mousewheel","#sidebar-content",function(e){x&&clearTimeout(x)}).on("mousewheel","content",function(n){if(document.querySelector(".dropmenu.open")&&!File.editor.sourceView.inSourceMode){var i=h(e.sessionStr).children(t.headerStr);i.length>100?(x&&clearTimeout(x),x=setTimeout(t.highlightVisibleHeader.bind(t),30)):(t.highlightVisibleHeader(i),x&&clearTimeout(x),x=setTimeout(t.highlightVisibleHeader.bind(t),100))}}).on("click","#close-outline-btn, #close-sidebar-btn",function(){t.hideOutline()}).on("click","#pin-outline-btn",function(){e.library.showSidebar("outline")}).on("click","#unpin-outline-btn",function(){e.library.hideSidebar(),t.showOutline()})},highlightVisibleHeader:function(e,t){function n(e){var t=h("content").scrollTop(),n=e.offsetTop;return n<t?-1:n>t+window.innerHeight?1:0}if(document.querySelector("#typora-sidebar.open")){var i=this,r=this.editor,o=e||h(r.sessionStr).children(this.headerStr),a=0,s=o.length-1,l=void 0===t?null:t;if(o.length){for(a=1===n(o[o.length-1])?0:o.length-1;s-a>1&&null==l;){var c=Math.floor((a+s)/2),d=n(o[c]);1==d?s=c:-1==d?a=c:l=function(e){for(e--;o[e]&&0==n(o[e]);)e--;return e+1}(c)}null==l&&(l=a),l<o.length&&function(e){if((!i.editor.library||i.editor.library.isOutlineShown())&&e.length){var t,n,r=h("#outline-content:visible")[0];r&&(File.isNodeHtml||(r=r.parentElement),(t=e.offset().top-h(r).offset().top)<0?n=t-200+r.scrollTop:t>r.offsetHeight-20&&(n=t+200-r.offsetHeight+r.scrollTop),void 0!==n&&(r.scrollTop=n))}}(h("#outline-content .outline-label").removeClass("outline-active").filter("[data-ref='"+o[l].getAttribute("cid")+"']").addClass("outline-active"))}x=null}},getAttrByElem:function(e){return e.hasClass("md-def-name")?"ref":e.hasClass("md-def-content")?e.hasClass("md-def-url")?"href":"text":e.hasClass("md-def-title")?"title":void 0},addEmptyDef:function(e,t){function n(n){var r=i.findNodeByElem(n),o=i.undo.UndoManager.makeEmptyCommand();r.insert(new d({type:t,ref:e,url:"",text:""})),i.undo.UndoManager.addUndoForInsert(o,r.get("after")),n.after(r.get("after").toHTML()),i.selection.jumpIntoElemBegin(n.next().find(".md-def-content")),o.redo.push(i.selection.buildUndo()),i.undo.register(o),i.refocus()}var i=this.editor,r=h(i.sessionStr).find(t==d.TYPE.def_link?".md-def-link":".md-def-footnote").last();n(!r.length||r.nextAll(":not(.footnotes)").length?h(i.sessionStr).children().last():r)},resizeFooter:function(){},showTooltipForSup:function(e){var t,n,i=this.editor;if(e.length){var r=e.find(".md-text").text();t=i.nodeMap.foot_list.getFootHTMLByRef(r,!0),h(".md-tooltip-remove").remove(),t?(n=h(h.parseHTML(t)[0]),h("body").append(n)):File.isLocked||(t="<div class='code-tooltip md-tooltip-remove md-hover-tip md-f-tooltip' contenteditable='false'><div class='md-arrow' /><div class='code-tooltip-content'><span class='fa text-warning fa-exclamation-triangle' title='warning' aria-hidden='true' /> "+h.localize.getString("Need to define the reference footnote <b>{0}</b> with syntax <a>[^{1}]: www.example.com</a>").format(r,r).trim()+" </div></div>",n=h(h.parseHTML(t)[0]),h("body").append(n),n.find(".code-tooltip-content a").unbind("click").click(function(){i.docMenu.addEmptyDef(r,c.TYPE.def_footnote)})),this.editor.EditHelper.fixPopoverPosition(e,n)}},getLocalRootUrl:function(e){var t=this.getMetaNode();if(e=e||"img",t){var n=(/^\s*typora-root-url\s*:\s*(.*)$/im.exec(t.get("text"))||[])[1];if(n){var i=f.getCurrentFileFolderPath();return i?File.isMac?v.path.resolvePathRelateTo(n,i):reqnode("path").resolve(i,n):n}}return null},buildMetaMap:function(){function e(e){return e.replace(/(^\s*['"]*)(['"]*\s*$)/,"")}var t,n,i=this.getMetaNode(),r=/^\s*([^:]+)\s*:\s*(.*)$/,o=/^\s#/,a={};return i&&((i.get("text")||"").split(/\r|\n|\r\n/g).forEach(function(e){e.match(o)||((n=r.exec(e))?(t=n[1],a[t]=n[2].replace(/^\s*[|>]\s*/,"")):t&&(a[t]+="\n"+e.trim()))}),Object.keys(a).forEach(function(t){a[t].match(/^\s*-/)?a[t]=a[t].split(/(^|\n+)\s*-/g).filter(function(e){return e.match(/\S/)}).map(function(t){return e(t)}):(n=a[t].match(/^\s*\[(.*)\]\s*$/))?a[t]=n[1].split(/\s*,\s*/).map(e):a[t]=e(a[t])})),a},getMetaNode:function(){this.editor.undo&&this.editor.undo.completeSnap(!0);var e=this.editor.nodeMap.getFirst();return d.isType(e,u.meta_block)?e:null},getValueInMeta:function(e,t){if(t=t||this.getMetaNode()){var n=(new RegExp("^s*"+e+"s*:s*(.*)$","mi").exec(t.get("text"))||[])[1];return n?n.trim():n}return null},renderOutline:function(){var e=C(this.editor.nodeMap.toc),t=h(".outline-content");if(t.html(e),i(t,!0),this.expandedOutlineItem)this.expandedOutlineItem.forEach(function(e){try{t.find("[data-ref='"+e+"']").parent().parent().addClass("outline-item-open")}catch(e){}}),this.expandedOutlineItem=null;else{var n=t.children();n.length<20&&n.addClass(".outline-item-open")}},showOutline:function(e){this.editor.library.isSidebarShown()?h("#toc-content").html(h("#outline-content").html()).find(".outline-active").removeClass("outline-active"):this.renderOutline(),h(".dropdown-menu.open, .dropdown-menu.show").removeClass("open").removeClass("show"),document.querySelector("#toc-dropmenu").classList.add("open")},storeOutline:function(){this.expandedOutlineItem=[];for(var e=document.querySelectorAll(".outline-item-open:not(.outline-h1)>.outline-item>.outline-label"),t=0;t<e.length;t++)this.expandedOutlineItem.push(e[t].getAttribute("data-ref"));return this.expandedOutlineItem},hideOutline:function(e){this.storeOutline(),document.querySelector("#toc-dropmenu").classList.remove("open")},autoHideOutline:function(){document.querySelector("#toc-dropmenu").classList.contains("open")&&this.hideOutline()},toggleOutline:function(){document.querySelector("#toc-dropmenu.open")?this.hideOutline():this.showOutline()},getHeaderMatrix:function(e){var t=[];return this.editor.nodeMap.toc.headers.map(function(n){var i=a.output(n.get("text"));e&&(i=h.parseHTML("<div>"+i+"<div>")[0].textContent),t.push([n.get("depth")-0,i,n.cid])}),t},writeProperty:function(e,t){this.editor.undo.completeSnap(!0);var n=this.editor.docMenu.getMetaNode(),i=this.editor.selection.buildUndo()||{},r=m.makeEmptyCommand(i),a=e+": "+t,s=n&&i&&(i.id||i.startId)==n.id,l=h.extend({},i),c=0;if(n){r.undo.push(m.buildReplaceUndo(n));var d=n.get("text"),u=o(e,d);if(u){l.start>u.index+u[0].length?c=a.length-u[0].length:l.start>u.index&&(c=l.start-u.index+a.length),l.end=l.start=l.start-c;var p=new RegExp("^s*"+e+"s*:s*(.*)$","mi");n.set("text",d.replace(p,a))}else n.set("text",d?d.replace(/\n?$/,"\n"+a):a);r.redo.push(m.buildReplaceUndo(n)),this.editor.findElemById(n.cid).replaceWith(n.toHTML()),s&&this.editor.undo.exeCommand(l)}else{var f=this.editor.stylize.insertMetaBlock(!0,a);n=f.node,m.append(r,f.command),this.editor.findElemById(n.get("after").cid).before(n.toHTML())}r.redo.push(l),this.editor.undo.register(r)},removeProperty:function(e,t){this.editor.undo.completeSnap(!0);var n=this.editor.docMenu.getMetaNode(),i=this.editor.selection.buildUndo(),r=m.makeEmptyCommand(i),a=(i.id||i.startId)==n.id,s=new RegExp("^s*"+e+"s*:s*(.*)$","mi"),l=h.extend({},i),c=0;if(n){if(r.undo.push(m.buildReplaceUndo(n)),a){var d=o(e,n.get("text"));d&&(l.start>d.index+d[0].length?c=d[0].length:l.start>d.index&&(c=l.start-d.index),l.end=l.start=l.start-c)}n.set("text",n.get("text").replace(s,"")),r.redo.push(m.buildReplaceUndo(n)),this.editor.findElemById(n.cid).replaceWith(n.toHTML()),r.redo.push(l),a&&this.editor.undo.exeCommand(l),!t&&this.editor.undo.register(r)}return r}});n.exports=k}),define("app/editor/SearchPanel",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","rangy/rangy-core","app/editor/KeyMaster","codemirror/lib/codemirror","app/document/Node","rangy/rangy-classapplier"],function(e,t,n){"use strict";function i(e){return!e.match(/^([a-z]|\s)?$/gi)}function r(e,t){return new RegExp(l.escapeRegExp(e)+(t.wholeWord?"(?![A-Za-z_\\u00C0-\\u024f])":""),t.caseSensitive?"g":"gi")}function o(e){v&&clearTimeout(v),$("#md-searchpanel.searchpanel-replace-mode").addClass("searchpanel-msg-mode").find("#searchpanel-msg-content").text(e),v=setTimeout(function(){$("#md-searchpanel").removeClass("searchpanel-msg-mode")},5e3)}function a(e,t){return"Replaced "+e+" occurrence(s)"}var s=e("exoskeleton-master/exoskeleton"),l=e("app/document/StringUtils"),c=e("rangy/rangy-core.js"),d=e("app/editor/KeyMaster"),u=e("codemirror/lib/codemirror"),h=e("app/document/Node"),p=window.Node,f=h.Node,m=h.TYPE,g=(e("rangy/rangy-classapplier"),/[A-Za-z_\\u00C0-\\u024f]/i),v=null,y=s.Model.extend({initialize:function(e){this.editor=e,this.bindEvents(),this.curSel=null,this.searchTimer,this.applier=c.createClassApplier("md-search-hit"),this.selectApplier=c.createClassApplier("md-search-select")},bindEvents:function(){var e,t=this,n=!1,i=d.map;!File.isMac&&!File.isNode&&d("command+f, ctrl+f",function(e){t.showPanel(),e.preventDefault()}),!File.isMac&&!File.isNode&&d("command+h, ctrl+h",function(e){t.showPanel(!0),e.preventDefault()}),$(document.body).on("keydown",function(e){var n=event.keyCode||event.which;if("Esc"==i[n]&&t.isOpen)return t.closePanel(),!1}).on("mouseup",".md-search-hit",function(){t.closePanel(!1,$(this))}).on("mouseup",".cm-search-hit",function(e){var n=$(e.target).closest(".CodeMirror")[0].CodeMirror,i=u.posFromMouse(n,e),r=n.indexFromPos(i),o=t.searchStatus.hits.find(function(e){return e.isCm==n&&e.start<=r&&e.end>=r});if(t.closePanel(!0),o)return n.doc.setSelection(n.posFromIndex(o.start),n.posFromIndex(o.end)),!1}).on("mouseup",".CodeMirror",function(e){t.closePanel(!0)}),$("#md-searchpanel").on("blur",function(){t.closePanel()}).on("click",".close-btn .glyphicon-remove",function(){t.closePanel()}).on("keydown","input",function(){var e=event.keyCode||event.which;if("Esc"==i[e])return t.closePanel(),!1}).on("keydown","#search-panel-input",function(){var e=event.keyCode||event.which;return"Enter"==i[e]?(t.highlightNext(),!1):"Tab"==i[e]?$("#md-searchpanel.searchpanel-replace-mode").length?($("#search-panel-replace-input").focus(),!1):(this.value+="\t",!1):void 0}).on("keyup","#search-panel-input",function(){var r=event.keyCode||event.which;(n=n&&!(String.fromCharCode(r).match(/\s|[0-9]/g)||"Enter"==i[r]))||e==$(this).val()||(e=$(this).val(),t.doSearch(e))}).on("keydown","#search-panel-replace-input",function(){var e=event.keyCode||event.which;if((n=229==e)||"Enter"!=i[e]){if("Tab"==i[e]&&!event.shiftKey)return!1}else t.replaceSelection()}).on("mousedown","#search-panel-prev",function(){t.highlightNext(!0)}).on("mousedown","#search-panel-next",function(){t.highlightNext()}).on("click","#md-search-type-label",function(){$("#md-searchpanel").addClass("searchpanel-replace-mode"),$("#search-panel-replace-input").focus(),document.body.classList.add("on-replace-panel-open")}).on("click","#md-replace-type-label",function(){$("#md-searchpanel").removeClass("searchpanel-replace-mode").removeClass("searchpanel-msg-mode"),$("#search-panel-input").focus(),document.body.classList.remove("on-replace-panel-open"),$("content").removeClass("on-replace-panel-open")}).on("click","#search-panel-replace-btn",function(){t.replaceSelection(),$("#md-searchpanel").removeClass("searchpanel-msg-mode")}).on("click","#search-panel-replaceall-btn",function(){$("#md-searchpanel").removeClass("searchpanel-msg-mode"),t.replaceAll()}).on("click","#searchpanel-msg-close-btn",function(){$("#md-searchpanel").removeClass("searchpanel-msg-mode")}).on("click","#searchpanel-msg-undo-btn",function(){t.editor.undo.undo(),$("#md-searchpanel").removeClass("searchpanel-msg-mode"),!t.editor.sourceView.inSourceMode&&t.doSearch($("#search-panel-input").val())}).on("mousedown","#searchpanel-case-option-btn",function(e){return this.classList.toggle("active"),File.isMac&&app.touchBar&&app.touchBar.updateFindReplaceMode(),t.doSearch(),!1}).on("mousedown","#searchpanel-word-option-btn",function(){return this.classList.toggle("active"),File.isMac&&app.touchBar&&app.touchBar.updateFindReplaceMode(),t.doSearch(),!1})},replaceAll:function(){function e(e,t){var o=e.get(t);o&&e.set(t,o.replace(r(n,f),function(e,t,n){return f.wholeWord&&t>0&&g.exec(n.substr(t-1,1))?e:i}))}if(this.searchStatus&&this.searchStatus.hits.length){var t,n=this.searchStatus.searchText,i=$("#search-panel-replace-input").val(),l=this.searchStatus.hits;if(o.call(this,a(this.searchStatus.hits.length,this.searchStatus.searchText)),this.editor.sourceView.inSourceMode){var c="",d=0,u=l.length;for(t=0,n=this.editor.sourceView.cm.getValue();d<u;d++)c=c+n.substring(t,l[d].start-0)+i,t=l[d].end-0;return c+=n.substring(t),this.editor.sourceView.cm.setValue(c),void this.clearSearch()}var h=this.editor.undo.UndoManager,p=h.makeEmptyCommand(s.utils.extend(this.searchStatus.curSelection,{type:"cursor"})),f=this.searchStatus,m=null;this.clearSearch();for(d=0;d<l.length;d++)m!=(t=l[d]).cid&&(m=t.cid,function(t){var n=this.editor.getNode(t.cid);p.undo.push(h.buildReplaceUndo(n)),e(n,"text"),e(n,"title"),e(n,"ref"),p.redo.push(h.buildReplaceUndo(n)),this.editor.findElemById(n.cid).replaceWith(n.toHTML())}.call(this,t));this.editor.undo.register(p)}},replaceSelection:function(){if(this.editor.sourceView.inSourceMode&&!this.searchStatus.curSelection&&this.highlightNext(),this.searchStatus.curSelection&&this.searchStatus.hits.length&&$("#md-searchpanel.searchpanel-replace-mode").length){var e,t,n,i=$("#search-panel-replace-input").val(),r=i.length-this.searchStatus.searchText.length,o=this.searchStatus.curPos,a=this.editor.undo.UndoManager,s=a.makeEmptyCommand(),l=this.searchStatus.curSelection,c=l.isCm;n=r,this.searchStatus.lastRange?(e=this.editor.nodeMap.allNodes.get(l.cid),s.undo.push({type:"cursor",id:e.cid,start:l.start,end:l.end}),this.selectApplier.undoToRange(this.searchStatus.lastRange),this.applier.undoToRange(this.searchStatus.lastRange),n=i.length-(this.searchStatus.curSelection.end-this.searchStatus.curSelection.start),this.searchStatus.lastRange.deleteContents(),this.searchStatus.lastRange.insertNode(document.createTextNode(i)),this.searchStatus.lastRange=null,s.undo.push(a.buildReplaceUndo(e)),this.editor.store(e.cid),s.redo.push(a.buildReplaceUndo(e))):c&&c.doc.replaceSelection(i,"start","+findReplace"),function(e){for(var t=e.curPos+1;t<e.hits.length;t++){var i=e.hits[t];i.cid==e.curSelection.cid&&(i.start+=n,i.end+=n)}}(this.searchStatus),this.highlightNext(),this.searchStatus.hits.splice(o,1),--this.searchStatus.curPos<0&&(this.searchStatus.curPos=this.searchStatus.hits.length-1),this.searchStatus.hits.length||this.clearSearch(),t=this.searchStatus.curSelection||this.searchStatus.initRange,this.editor.sourceView.inSourceMode||(t&&s.redo.push({type:"cursor",id:t.cid,start:t.start,end:t.end}),this.editor.undo.register(s))}},isOpen:function(){return"block"==document.querySelector("#md-searchpanel").style.display},showPanel:function(e){$("#md-searchpanel").is(":visible")||(editor.lastCursor=editor.selection.buildUndo(),this.editor.undo.completeSnap(!0),this.clearSearch(),this.searchStatus.initPos=editor.selection.getPosBookmark(),$("#md-searchpanel").show().find("#search-panel-input").focus()[0].select(),$("#search-panel-input").val()&&this.doSearch($("#search-panel-input").val()),document.body.classList.add("on-search-panel-open")),e?($("#md-searchpanel").addClass("searchpanel-replace-mode"),document.body.classList.add("on-replace-panel-open")):($("#md-searchpanel").removeClass("searchpanel-replace-mode"),document.body.classList.remove("on-replace-panel-open")),File.isMac&&app.touchBar&&(app.touchBar.showFindReplaceTouchBar(),app.touchBar.updateFindReplaceMode())},closePanel:function(e,t){t=t||$(".md-search-select");var n=this.editor.getMarkElem().length;if(document.body.classList.remove("on-replace-panel-open"),document.body.classList.remove("on-search-panel-open"),$("#md-searchpanel").removeClass("searchpanel-msg-mode").hide(),this.editor.sourceView.inSourceMode)return this.searchStatus&&this.searchStatus.hits.length&&(this.editor.fences.clearSearchAll(),this.editor.sourceView.cm.focus()),void this.resetSearchStatus();e?n=!0:t.length?(this.editor.selection.selectAllElem(t),this.editor.lastCursor=this.editor.selection.buildUndo(),n=!1):this.searchStatus&&this.searchStatus.curSelection&&this.searchStatus.curSelection.isCm&&(this.searchStatus.curSelection.isCm.focus(),this.editor.lastCursor=this.editor.selection.buildUndo(),n=!1),this.clearSearch(),$(".md-search-hit").removeClass("md-search-hit"),!n&&this.editor.restoreLastCursor(),!e&&this.editor.refocus()},doSearch:function(e){function t(e){var t=e.containerNode||document.querySelector("[cid='"+e.cid+"']");return!!h&&(h.compareDocumentPosition(t)==p.DOCUMENT_POSITION_PRECEDING||h==t&&e.start<u.start)}function n(e,n){for(var i=r(n,d),o=e.getValue(),a=!1,l=null;i.exec(o);)a=!0,l={isCm:e,cid:e.cid,start:i.lastIndex-n.length,end:i.lastIndex},d.wholeWord&&l.start>0&&g.exec(o.substr(l.start-1,1))||(d.hits.push(l),t(l)&&d.curPos++);a&&s.fences.searchOn(e,n,d)}function o(e,n,i){for(var o,a,l=r(n,d),u=s.findElemById(e.cid)[0],h=u.textContent;l.exec(h);)a={cid:e.cid,containerNode:u,start:l.lastIndex-n.length,end:l.lastIndex},d.wholeWord&&a.start>0&&g.exec(h.substr(a.start-1,1))||((o=o||c.createRange()).moveToBookmark(a),v.applyToRange(o),d.hits.push(a),t(a)&&d.curPos++)}function a(e,t,i){e.get("children").length?e.get("children").toArray().map(function(e){a(e,t)}):s.fences.queue[e.cid]?n(s.fences.queue[e.cid],t):f.isType(e,m.math_block)?(s.mathBlock.currentCm||{}).cid===e.cid&&(s.fences.clearSearchOn(s.mathBlock.currentCm),n(s.mathBlock.currentCm,t)):o(e,t,i)}this.clearSearch();var s=this.editor,l=this,d=this.searchStatus,u=d&&d.initPos,h=u&&document.querySelector("[cid='"+u.cid+"']");if(d.searchText=void 0===e?$("#search-panel-input").val():e,d.caseSensitive=$("#searchpanel-case-option-btn.active").length,d.wholeWord=$("#searchpanel-word-option-btn.active").length,i(d.searchText)){var l=this,v=this.applier;if(this.editor.sourceView.inSourceMode)return void n(this.editor.sourceView.cm,d.searchText);this.searchTimer=setTimeout(function(){for(var e=s.nodeMap.getFirst();e;)a(e,d.searchText,v),e=e.get("after");l.highlightNext()},50)}},highlightNext:function(e){function t(){i.curSelection&&((n=i.curSelection.isCm)?n.execCommand(e?"goDocStart":"goDocEnd"):i.lastRange&&this.selectApplier.undoToRange(this.searchStatus.lastRange))}if(!$("#md-searchpanel").is(":visible"))return this.showPanel();$("#md-searchpanel").removeClass("searchpanel-msg-mode");var n,i=this.searchStatus,r=this.editor;i&&i.hits.length&&(i.curSelection&&(i.curPos+=e?-1:1),i.curPos>=i.hits.length?i.curPos=0:i.curPos<0&&(i.curPos=i.hits.length-1),function(e){t.call(this),i.curSelection=i.hits[i.curPos],$(".md-focus").removeClass("md-focus"),(n=i.curSelection.isCm)?(i.lastRange=null,n.doc.setSelection(n.posFromIndex(i.curSelection.start),n.posFromIndex(i.curSelection.end)),File.isTypeWriterMode?r.selection.typeWriterScroll($(".CodeMirror-selectedtext")):r.selection.scrollAdjust($(".CodeMirror-selectedtext"),null,window.innerHeight-200),$(".CodeMirror-selectedtext").closest("[cid]").addClass("md-focus")):(i.lastRange=i.lastRange||c.createRange(),i.lastRange.moveToBookmark({containerNode:document.querySelector("[cid='"+i.curSelection.cid+"']"),start:i.curSelection.start,end:i.curSelection.end}),this.selectApplier.applyToRange(i.lastRange),File.isTypeWriterMode?r.selection.typeWriterScroll(i.lastRange.nativeRange):r.selection.scrollAdjust(i.lastRange,null,window.innerHeight-200),document.querySelector("[cid='"+i.curSelection.cid+"']").classList.add("md-focus"))}.call(this,i.curPos))},clearSearch:function(e){if(this.editor.sourceView.inSourceMode)return this.editor.fences.clearSearchAll(),void this.resetSearchStatus(this.searchStatus&&(this.searchStatus.curSelection||this.searchStatus.initPos));if(this.searchStatus){try{this.searchStatus.lastRange&&this.selectApplier.undoToRange(this.searchStatus.lastRange)}catch(e){}for(var t,n=c.createRange(),i=0;i<this.searchStatus.hits.length;i++){var r=this.searchStatus.hits[i];r.isCm||(n.moveToBookmark({containerNode:document.querySelector("[cid='"+r.cid+"']"),start:r.start,end:r.end}),this.applier.undoToRange(n))}(t=this.searchStatus.curSelection&&this.searchStatus.curSelection.isCm)&&(t.doc.setSelection(t.posFromIndex(this.searchStatus.curSelection.start)),$(t.display.input.textarea).blur())}this.editor.fences.clearSearchAll(),clearTimeout(this.searchTimer);var o=this.searchStatus&&(this.searchStatus.curSelection||this.searchStatus.initPos);this.resetSearchStatus(o)},resetSearchStatus:function(e){this.searchStatus={hits:[],curPos:0,searchText:null,lastRange:null,initPos:e,curSelection:null}}});n.exports=y}),define("app/editor/Word",["jquery/jquery","exoskeleton-master/exoskeleton"],function(e,t,n){"use strict";var i=e("jquery/jquery"),r=e("exoskeleton-master/exoskeleton").Model.extend({initialize:function(e){this.editor=e,this.$container=i("#word-auto-suggest")},search:function(e,t,n,i){var r=e.substring(t,t+n);if(!r)return[];var o=[];return File.isMac?(o=app.word.getSpellSuggestionInContext(e,t,n),i.type="word",i.token=r,i.match=o,i.found=o.length,i.pageNo=0,i.pageCnt=Math.floor((o.length-1)/5+1)):i.found=!1,o},showAutoSuggest:function(e,t,n,r){if(r.token===e.substring(t,t+n))return!1;var o=this.search(e,t,n,r),a="";if(!r.found)return this.$container.hide(),!1;for(var s=0;s<o.length&&s<40;s++)s%5==0&&(a+=(s>0?"</ul>":"")+"<ul data-page='"+s/5+"' style='display:none'>"),a+=i("<li/>").attr("data-content",o[s]).text(o[s])[0].outerHTML;return a+="</ul>",this.$container.html(a),this.$container}});n.exports=r}),define("app/document/Export",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/document/StringUtils","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji","app/document/Node2Native","app/editor/Diagram","codemirror/lib/codemirror","app/document/MarkParser","app/editor/polyfill"],function(e,t,n){"use strict";function i(){s&&(s.close(),s.destroy(),s=null),g("#md-notification").fadeOut()}function r(e,t){if(e.nodeType==document.TEXT_NODE){var n=e.textContent;(n=n.split(/(;|-)/).map(function(e){return";"==e||"-"==e?"<span style='font-family:"+t+"'>"+e+"</span>":h.escape(e)}).join(""))!=e.textContent&&(e.innerHTML=n)}else 1==e.nodeType&&e.childNodes.forEach(function(e){r(e,t)})}function o(e){return e.map(function(e){return"<div class='footnote-line'>"+e.join("")+"</div>"}).join("\n")}var a,s,l=e("exoskeleton-master/exoskeleton"),c=e("app/document/Node"),d=c.Node,u=c.TYPE,h=(c.NodeCollectionUtils,e("app/document/StringUtils")),p=e("app/document/MarkParser"),f=e("app/editor/Inline"),m=(e("app/document/Node2Native"),e("app/editor/EditHelper")),g=e("jquery/jquery"),v=(e("app/editor/polyfill"),1e4),y=function(){for(var e=document.querySelectorAll("#write figure"),t=0;t<e.length;t++){var n=e[t];n.style.zoom=Math.min(n.clientWidth/n.scrollWidth,1),n.style.overflowX="hidden",n.style.overflowy="hidden"}},b=function(){for(var e=document.querySelectorAll("#write a"),t=/^\s*#(.+)$/,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"'":"\\'","\\":"\\\\"},i=function(e){return e.replace(/["\\\b\t\n\f\r]/g,function(e){return n[e]}).replace(/\u200b/g,"")},r=0;r<e.length;r++){var o,a=e[r],s=a.getAttribute("name"),l=a.getAttribute("href");if(s){var c=document.createElement("a"),d=document.createTextNode(" ");c.appendChild(d),c.setAttribute("class","md-print-anchor"),c.setAttribute("href","uaf://"+i(s)),a.parentNode.insertBefore(c,a)}l&&(o=t.exec(l))&&(l=o[1],a.setAttribute("href","uat://"+i(l)))}};window.releaseCaptureWin_=i;var w=l.Model.extend({initialize:function(t){this.editor=t,window.debugMode&&e.async("FileSaver.min",function(e){a=e})},exportToNative:function(e,t){return t=File.isMac?function(e){app.controller.exportWithPandocCallback(e)}:t||function(){},this.editor.nodeMap.exportToNative(e,t)},exportToImage:function(){function e(e){return/png$/i.exec(b)?e.toPNG():e.toJPEG(100)}function t(e,t){reqnode("fs").writeFile(e,t,function(t){t?u.showErrorBox(g.localize.getString("Export Failed","Panel"),t.message):l.shell.showItemInFolder(e)})}function n(){if(b&&y.length){var n=null,r=0;try{if(y.length>1){var o=document.createElement("canvas"),s=o.getContext("2d");o.width=640,o.height=a,y.forEach(function(e){var t=new Image(640,e.getSize().height);t.src=e.toDataURL(),s.drawImage(t,0,r),r+=t.height}),n=e(l.nativeImage.createFromDataURL(o.toDataURL())),t(b,n),i()}else n=e(y[0]),t(b,n),i()}catch(e){console.error(e),i()}}}function r(){g("#md-notification").html("<p> "+g.localize.getString("Exporting in progress...","Panel")+" </p>").show()}function o(e){var t=a-e;t>v&&(t=v),s.setContentSize(640,t),s.webContents.once("did-navigate-in-page",function(r,l){return setTimeout(function(){s.webContents.capturePage(function(r){if(r.isEmpty())return i();f>1&&(r=r.resize({width:640,quality:"best"})),y.push(r),e+t<a?o(e+=t):n()})},400),!1}),s.webContents.executeJavaScript("document.body.scrollTop = {d}; window.location.hash = {d};".replace(/{d}/g,e))}var a,l=reqnode("electron").remote,c=l.getCurrentWindow(),d=l.app,u=l.dialog,h=l.BrowserWindow,p=this,f=l.screen.getPrimaryDisplay().scaleFactor||1,m=d.setting.get("zoomFactor")||1,y=[],b=null;try{(function(){File.editor.store(!0),i();var e=p.exportToHTML(!0,!1,!1,!0),t=l.app.setting.config;return(s=new h({skipTaskbar:!0,show:!1,webPreferences:{webSecurity:!1,allowDisplayingInsecureContent:!0,allowRunningInsecureContent:!0,nodeIntegration:!1,directWrite:t.directWrite,defaultFontFamily:t.defaultFontFamily,zoomFactor:m},webgl:!1,useContentSize:!0,width:640,height:960,enableLargerThanScreen:!0,offscreen:!0,alwaysOnTop:!0,minimizable:!1,closable:!1})).loadURL("data:text/html;charset=UTF-8,  "+encodeURIComponent(e)),s})().webContents.once("did-finish-load",function(){setTimeout(function(){s.webContents.once("did-navigate-in-page",function(e,t){var n=t.match(/[\d\.]+$/)[0]-0;return e.preventDefault(),isNaN(n)?i():(s.setContentSize(640,n),(a=n)>4*v?(i(),u.showErrorBox(g.localize.getString("Export Failed","Panel"),g.localize.getString("Generated Image too Large","Panel")),!1):(o(0),!1))}),s.webContents.executeJavaScript("window.location.hash = document.body.clientHeight;")},400)})}catch(e){i()}u.showSaveDialog(c,{properties:["saveFile"],title:"Export to…",defaultPath:d.getPath("userDesktop")+"/"+File.getSuggestedFileName(!0)+".png",filters:[{name:"PNG",extensions:["png"]},{name:"JPEG",extensions:["jpg","jpng"]}]},function(e){if(!e)return i();b=e,r(),n()})},exportAndSaveHTML:function(e){var t=new Blob([this.exportToHTML(e)],{type:"text/html;charset=utf-8"});a(t,"export.html")},exportCollection:function(e,t,n,i,a,s,l){function c(e){if("string"==typeof e)return s.output(e,f.decorateAsExport);var r=e.get("children");if(d.isType(e,u.paragraph)){var o=[];return r.sortedForEach(function(e){o.push(s.output(e.get("text"),f.decorateAsExport))}),o.join("\n")}return r&&r.length>0?C.exportCollection(r,t,n,i,a,s):s.output(e.get("text"),f.decorateAsExport)}function v(e){var t=null;switch(e.get("type")){case u.paragraph:return"<p>"+(c(e)||"&nbsp;")+"</p>";case u.heading:var o="";return n&&1==e.get("depth")&&!e.get("parent")&&e.get("before")&&(o=" data-breakpage"),"<h"+e.get("depth")+o+">"+(i||l?"":"<a name='header-"+e.cid+"' class='md-header-anchor "+(n?"md-print-anchor' href='af://"+e.cid+"'> ":"'>")+"</a>")+c(e)+"</h"+e.get("depth")+">";case u.blockquote:return"<blockquote>"+c(e)+"</blockquote>";case u.list:var a=e.get("style"),s=function(){for(var t=e.get("children").toArray(),n=0;n<t.length;n++){var i=t[n].getFirstChild();if(!d.isType(i,u.paragraph)||i.get("after"))return!0}return!1}();if(e.set("loose",s),a==d.ListType.task)return"<ul "+(i?"":"class='task-list'")+">"+x+c(e)+"</ul>";var p="";return a==d.ListType.ol&&(p=""===e.get("start")?void 0:e.get("start")-0,p=Number.isNaN(p)||1==p?"":" start='"+e.get("start")+"' "),"<"+a+p+">"+x+c(e)+x+"</"+a+">";case u.list_item:return e.get("parent").get("style")===d.ListType.task?"<li "+(i?"":"class='task-list-item task-list-"+(e.get("checked")?"done":"not-done")+"'")+" ><input type='checkbox' disabled='disabled' "+(e.get("checked")?"checked":"")+"/>"+c(e)+"</li>":"<li>"+function(e){return c(!1===e.get("parent").get("loose")?e.getFirstChild():e)}(e)+"</li>";case u.fences:if(i){var f=h.escapeInQuote(e.get("lang")||"");return f?"<pre><code class='language-"+f+"' lang='"+f+"'>"+h.escape(e.get("text"))+x+"</code></pre>":"<pre><code>"+h.escape(e.get("text"))+x+"</code></pre>"}var y,w=b.findElemById(e.id).clone();if(File.option.enableDiagram&&d.isType((e.get("lang")||"").toLowerCase(),"flow","sequence","mermaid")){y=!1;var C=b.findElemById(e.id).find("svg"),k=w.find("svg");return C.attr("width")&&!C.attr("viewBox")&&(k.attr("viewBox","0 0 "+C.attr("width")+" "+C.height()),k.css("max-width","100%"),k.css("height","auto")),m.processExportedSVG(w.find(".md-diagram-panel").html(w.find(".md-diagram-panel-preview").html())[0].outerHTML)}if(!1!==y&&(y=e.get("text").split(/\n/).length>13),w.removeAttr("cid").removeAttr("contenteditable").removeAttr("mdtype").find("input, textarea, .code-tooltip, .CodeMirror-cursors, .CodeMirror-hscrollbar, .CodeMirror-vscrollbar").remove().end().find(".CodeMirror-sizer").css("min-height",""),y&&w.css("page-break-inside","unset"),n&&File.isNode){var S=window.getComputedStyle(File.editor.writingArea).fontFamily||"initial";S=S.replace(/'/g,"\\'"),w.find(".CodeMirror-line > span").each(function(){r(this,S)})}return w[0].outerHTML;case u.math_block:var T=b.findElemById(e.id),E=T.width(),F=T.find(".MathJax_SVG").width();return E<F-10&&(T=T.clone().find(".MathJax_SVG").css("zoom",E/F)),n&&File.isNode&&File.option.printPDFByPhantom&&(T=T.clone().css("zoom",1/.9*1.25+"")),T[0]?m.processExportedSVG(T[0].outerHTML):"<p class='math-block'>$$"+h.escape(e.get("text"))+"$$</p>";case u.hr:return"<hr />";case u.def_footnote:case u.def_link:return"";case u.table:e.get("align").length;for(var _="<figure><table>"+x,M=e.getFirstChild();M;)M.get("before")?_+=v(M):_+="<thead>"+x+v(M)+"</thead>"+x+"<tbody>",(M=M.get("after"))||(_+="</tbody>"+x);return _+="</table></figure>";case u.table_row:for(var N,_="<tr>",M=e.getFirstChild(),L=e.get("parent").get("align"),A=0,R=e.get("before")?"td":"th";M;)_+="<"+R+(N=(N=L[A])?" style='text-align:"+N+";' ":"")+">"+v(M)+"</"+R+">",M=M.get("after"),A++;return _+="</tr>";case u.table_cell:return c(e)||"&nbsp;";case u.meta_block:return"";case u.toc:return function(){if(i)return"<div>[TOC]</div>";if(!t){var e=g(document.querySelector(".md-toc-content")).clone();e.find("[data-ref]").each(function(){this.querySelector("a").setAttribute("href",(n&&File.isMac?"at://":"#header-")+this.getAttribute("data-ref")),n&&File.isNode&&File.option.printPDFByPhantom&&this.querySelector("a").setAttribute("href","")}),t="<div class='md-toc' mdtype='toc'>"+e[0].outerHTML+"</div>"}return t}();default:return"<p>"+c(e)+"</p>"}}var y=this.editor.nodeMap,b=this.editor,s=s||new p.InlineLexer({nodeMap:y,count:1,footnoteList:[],appendFootnote:function(e,n){if(!t[n]){var i=s.output(e.get("text"),f.decorateAsExport,null,null,{footnote:1});t[n]=["<span class='md-fn-count'>"+n+"</span> "+i]}var r=t[n].length-1,o=n+(r?"-"+r:"");return t[n].push("<a name='dfref-footnote-"+o+"' href='#ref-footnote-"+o+"' title='"+g.localize.getString("back to document")+"' class='reversefootnote' >↩</a>"),o},noStyle:i,forPrint:n,skipOp:{atag:!0,underline:!0,comment:!0,imgtag:!0}},f.decorateAsExport),w="",x=i?"\n":"",C=this;if(t=t||[],"string"==typeof e)return c(e);if(e.length){var k=e instanceof Array,S=k?e[0]:e.sortedFirst();do{w+=v(S)+x,S=S.get("after")}while(S&&(!k||e.indexOf(S)>-1))}return w+(a?o(t):"")},exportToHTML:function(e,t,n,i){function r(e,t){if(!e)return"";t=t||[];var n,i,r=/^\s*@include-when-export\s+(url)?([('"]+)([^\)"']+)([)'"]+)/im;try{(i=e.match(/^\s*@include-when-export\s.+$/gim))&&i.map(function(e){(n=r.exec(e)||[])[3]&&t.push(n[3])})}catch(e){}r=/^\s*@import\s+(url)?([('"]+)([^\)"']+)([)'"]+)/im;try{(i=e.match(/^\s*@import\s.+$/gim))&&i.map(function(e){(n=r.exec(e)||[])[3]&&t.push(n[3])})}catch(e){}return t.map(function(e){return"<link href='"+e+"' rel='stylesheet' type='text/css' />"}).join("\n")}function a(e){return File.isMac?app.path.readText(e):File.isNode?reqnode("fs").readFileSync(e,"utf-8"):void 0}function s(e,t){function n(e){var n=(e.match(i)||[""])[0];return e=decodeURI(n.length?e.substring(1,e.length-1):e),(e=File.isMac?app.path.resolvePathRelateTo(e,t):reqnode("path").resolve(t,e)).match(/\.css$/)?(r.push(s(a(e),e)),e=""):e=(File.isMac?"file://":"file:///")+e,n+encodeURI(e)+n}var i=/^["']/,r=[];return t=(t||"").replace(/[\/\\][^\/\\]*$/,""),e=(e||"").replace(/(^|;|\n)[\s]*@import([^;\n]+)(;|$|\n)/,function(e,t){var i=(/['"]([^"']+)['"]/.exec(e)||[])[0];return i?e.replace(i,n(i)):e}).replace(/url\([^:)]+\)/gi,function(e){return e=e.substring(4,e.length-1),"url("+n(e)+")"}),e=r.join("\n")+e}function l(){function t(e){for(var n in e.cssRules){var i=e.cssRules[n];if(i.styleSheet){if(i.href.match(/mermaid/i)&&!f)continue;if(i.href.match(/sourcemode\.dark\.css/i))continue;t(i.styleSheet)}else l.push((i.cssText||"").replace(/content: ([^;]{1});/g,"content: '$1';"))}}var n,i,o,l=[];if(v="",e){if(document.querySelectorAll("link[css-include]").forEach(function(e){v+="<link rel='stylesheet' href='"+h.escapeInQuote(e.href)+"' type='text/css' />"}),File.colorBrightness<.5&&File.isNode){var c=reqnode("electron").remote.app.getPath("userData");v+=["github.css","base.user.css","github.user.css"].map(function(e){return"<link rel='stylesheet' href='file:///"+h.escapeInQuote(c+"/themes/"+e)+"' type='text/css' />"}).join("\n")}else v+=["theme_css","base_user_css","theme_user_css"].map(function(e){return"<link rel='stylesheet' href='file://"+(File.isWin?"/":"")+h.escapeInQuote(g("#"+e).attr("href"))+"' type='text/css' />"}).join("\n");return""}var d,u,p;File.isMac&&(o=["theme_css","base_user_css","theme_user_css"].map(function(e){return u=[],p=g("#"+e).attr("href"),d=a(p),r(d,u),u.forEach(function(e){(/^\/\//.exec(e)||/.+:\/\//.exec(e))&&(v+="<link href='"+e+"' rel='stylesheet' type='text/css' />")}),s(d,g("#"+e).attr("href"))}).join("\n")),i=["(base\\.css)"],o||i.push("(theme)"),m&&i.push("(codemirror)"),f&&i.push("(mermaid)"),i=new RegExp(i.join("|"),"i");for(var y=0;y<document.styleSheets.length;y++)if(n=document.styleSheets[y],i.exec(n.href)&&(t(n),/themes/.exec(n.href)))try{var b=decodeURI(n.href.replace(File.isWin?/^[\w_-]+:[\/]+/:/^[\w_-]+:\/\//,""));v+=r(a(b,"utf-8"))}catch(e){}return o&&l.push(o),l.join("\n")}var c=this.editor.nodeMap,d=this.editor,u=[],p=File.editor.docMenu.getValueInMeta("title")||File.getFileName(),f=File.option.enableDiagram&&g(".md-fences[lang='mermaid']").length,m=Object.keys(File.editor.fences.queue).length,v="";return File.option.showLineNumbersForFence&&d.fences.refreshEditor(!0),function(n,r){r=h.escape(r)||"",u.length&&(window.app&&app.setting.get("split_pages"),n+="<div class='footnotes-area' "+(e?"data-breakpage":"")+" ><hr/>"+o(u)+"</div>");var a=e?"<script> window.setBreakPage = function(b){var node = document.querySelectorAll('[data-breakpage]'); for(var i=0;i<node.length;i++){node[i].style.pageBreakBefore = b ? 'always':'' }}; setBreakPage("+(window.app&&app.setting.get("split_pages")?"true":"false")+");<\/script>":"",s=File.isMac?"is-mac":"is-node",c=i?"24px":document.body.parentElement.style.fontSize||"";if(c&&(c=" style='font-size:"+c+" !important'"),File.option.showLineNumbersForFence&&(s+=" show-fences-line-number"),e&&File.isMac&&(a+="<script>("+b.toString()+")();<\/script>"),e&&(a+="<script>("+y.toString()+")();<\/script>"),t)return"<!doctype html>\n<html>\n<head>\n<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>\n<title>"+r+"</title></head>\n<body>"+n+"</body>\n</html>";var d=l(),p=["typora-export"];return i&&(p.push("for-image"),d+="::-webkit-scrollbar {display: none;}"),console.log("csslinks == "+v),"<!doctype html>\n<html"+c+(e&&!File.option.printPDFByPhantom&&" class='blink-to-pdf' "||"")+">\n<head>\n<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>\n<title>"+r+"</title>"+v+"<style type='text/css'>html {overflow-x: initial !important;}"+d+"\n</style>\n</head>\n<body class='"+p.join(" ")+"' >\n<div  id='write' "+(e?"style='top:auto'":"")+" class = '"+s+"'>"+n+"</div>\n"+a+"</body>\n</html>"}(this.exportCollection(c.blocks,u,e,t,void 0,void 0,i),p)}});n.exports=w}),define("app/document/Node2Native",["exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/document/StringUtils","app/editor/Diagram","codemirror/lib/codemirror","app/editor/KeyMaster","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/UndoManager","app/editor/Emoji"],function(e,t,n){"use strict";function i(){d=Object.create(null),!c&&File.option.enableInlineMath&&(c=document.querySelector("#inline-math-export-jax"),MathJax.Hub.Typeset(c),c=MathJax.Hub.getAllJax(c)[0]),$(".md-inline-math, [mdtype='math_block']").each(function(){try{var e,t=this.querySelector("script").textContent.trim().replace(/\u200b/g,"");this.classList.contains("md-inline-math")?(c.Text(t),e=c.root.toMathML("")):e=MathJax.Hub.getAllJax(this)[0].root.toMathML(""),d[t]=e}catch(e){}})}function r(e,t){var n=document.querySelector("[cid='"+e+"'] svg"),i=x.svg2DataURL(n,$(n).closest("[lang='mermaid']").length),r=n.getBoundingClientRect(),a=new Image;a.onerror=function(e){t("")},a.onload=function(){var e=document.createElement("canvas"),n=e.getContext("2d"),i=File.canvasratio,s=a.width,l=r.bottom-r.top;e.width=a.width,e.height=r.bottom-r.top,i>1.1&&(e.width=s*i,e.height=l*i,n.scale(i,i)),n.drawImage(a,0,0),e.style.width=s+"px",e.style.height=l+"px",setTimeout(function(){o(e.toDataURL("image/png"),t)},100)},a.src=i}function o(e,t){var n;if(File.isNode){var i=e.replace(/^data:image\/png;base64,/,""),r=reqnode("electron").remote.app;n=r.getPath("temp").replace(/[\/\\]$/,"")+(File.isWin?"\\\\":"/")+Number(new Date)+".png",reqnode("fs").writeFile(n,i,"base64",function(e){e?console.error(e.stack):(t(n),E.push(n))})}else{if(!File.isMac)return"";n=window.app.path.savePNG(e),t(n),E.push(n)}}function a(e,t){function n(n){if(n||0==h.size)return e=i.join(""),t(e),!0}var i=e.split(/(\uE040\d+)\uE041/g);i.length;i.forEach(function(e,t){if(e.charAt(0)==k){var o=e.substring(1)-0,a=u[o].cid;r(a,function(e){i[t]=JSON.stringify(e),h.delete(a),n()})}else n()})}function s(){if(File.isNode)for(;E.length;)reqnode("fs").unlink(E.pop());else File.isMac&&(app.path.removeTempFiles(JSON.stringify(E)),E=[])}function l(e){if(S={target:e,nodeMap:this,skipOp:j},T=[],u=[],h=new Set,void 0===File.canvasratio){File.canvasratio=1;var t=document.createElement("canvas").getContext("2d"),n=window.devicePixelRatio||1,i=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;File.canvasratio=n/i}}e("exoskeleton-master/exoskeleton");var c,d,u,h,p,f=e("app/document/Node"),m=f.Node,g=f.NodeMap,v=f.TYPE,y=e("app/document/StringUtils"),b=e("app/editor/Diagram"),w=e("app/document/MarkParser"),x=e("app/editor/EditHelper"),C={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"'":"'","\\":"\\\\"},k="",S={},T=[],E=[],F=function(e){return w.recoverEscape(e).replace(/["'\\\b\t\n\f\r]/g,function(e){return C[e]}).replace(/\u200b/g,"")},_={left:"AlignLeft",right:"AlignRight",center:"AlignCenter"},M=function(e,t,n,i){t=void 0===t?",":t,i=i||S;for(var r,o=[],a=n||e.getFirstChild();a;)(r=I(a,i))&&o.push(r),a=a.get("after");return o.join(t)},N=function(e,t){try{return'Div ("toc", [], []) [Para ['+e.toc.headers.map(t?function(e){return'Str "'+" ".repeat(e.get("depth")-1)+'", Link ("", [], []) ['+L(e)+'] ("#header-'+e.cid+'","")'}:function(e){return'Str "'+"\\t".repeat(e.get("depth")-1)+'", Link ("", [], []) ['+L(e)+'] ("#header-'+e.cid+'","")'}).join(",LineBreak,")+"]]"}catch(e){return console.warn(e.stack),""}},L=function(e,t){return t=t||e.get("text"),p.output(t,null,e).replace(/, $/,"")||'Str ""'},A=function(e){try{var t=(new DOMParser).parseFromString(e,"text/html");return t.querySelectorAll("mtable").forEach(function(e){e.hasAttribute("columnalign")&&!e.getAttribute("columnalign")&&e.removeAttribute("columnalign")}),t.body.innerHTML}catch(e){}return e},R=function(e){return m.isType(e,"epub","rst","opml","textile")},I=function(e,t){var n;R(t.target);switch(e.get("type")){case v.meta_block:return"";case v.heading:var i=m.isType(t.target,"textile","opml")?"":"header-"+e.cid;return"Header "+e.get("depth")+' ("'+i+'", [], []) ['+L(e)+"]";case v.line:return L(e);case v.paragraph:return"Para ["+(n=M(e,",Space,"))+"]";case v.blockquote:return"BlockQuote ["+(n=M(e))+"]";case v.list:var r=e.get("style");return n=M(e),r==m.ListType.ol?"OrderedList (1,Decimal,Period) ["+n+"]":"BulletList ["+n+"]";case v.list_item:return"["+(n=M(e))+"]";case v.fences:if(b.isDiagramType(e.get("lang"))&&m.isType(t.target,"epub","docx","odt")){u.push(e),h.add(e.cid);var o=document.querySelector("[cid='"+e.cid+"'] svg").getBoundingClientRect();return'Div ("",[],[("style","text-align:center")]) [Para [Image ('+JSON.stringify(e.get("lang"))+',[],[("width", "'+(o.right-o.left)+'")]) [Str ""] ('+(k+(u.length-1))+',"fig:")]] '}return'CodeBlock ("",["'+F(e.get("lang")||"")+'"],[]) "'+F(e.get("text"))+'"';case v.math_block:if(n=e.get("text").trim().replace(/\u200b/g,""),"epub"==t.target){var a=d[n];if(a)return'RawBlock (Format "html") '+JSON.stringify(A(a))+" "}else if("latex"==t.target&&n.match(/^\\(begin|newcommand|renewcommand|newenvironment|renewenvironment|def|let){/))return'RawBlock (Format "latex") '+JSON.stringify(n);return'Plain [Math DisplayMath "'+F(n)+'"]';case v.hr:return"HorizontalRule";case v.def_footnote:case v.def_link:return"";case v.toc:return"latex"==t.target?'RawBlock (Format "latex") "\\\\tableofcontents"':"wiki"==t.target?'RawBlock (Format "mediawiki") "__TOC__", RawBlock (Format "mediawiki") ""':"rst"==t.target?'RawBlock (Format "rst") ".. contents::", RawBlock (Format "rst") "\n"':"opml"==t.target?"":"textile"==t.target?'RawBlock (Format "textile") "{toc}", RawBlock (Format "textile") "\n"':N(e.get("in"),"epub"==t.target);case v.table:var s=e.get("align").map(function(e){return _[e]||"AlignDefault"}),l=s.map(function(){return"0.0"}),c=e.getFirstChild();return"Table [] ["+s.join(",")+"] ["+l.join(",")+"] ["+M(c)+"] ["+M(e,",",c.get("after"))+"]";case v.table_row:return"["+M(e)+"]";case v.table_cell:return"[Plain ["+L(e)+"]]";default:return""}},P=[];P[v.strong]="Strong",P[v.em]="Emph",P[v.del]="Strikeout",P[v.subscript]="Subscript",P[v.superscript]="Superscript";var O,D={html:'RawInline (Format "html") "<u>", $0, RawInline (Format "html") "</u>", ',docx:'RawInline (Format "openxml") "<w:r><w:rPr><w:u w:val=\\"single\\" /></w:rPr><w:t>$0</w:t></w:r>", ',rtf:'RawInline (Format "rtf") "{\\\\ul ", $0, RawInline (Format "rtf") " }", ',latex:'RawInline (Format "latex") "\\\\underline{", $0, RawInline (Format "latex") "}", '},B={html:'RawInline (Format "html") "<mark>", $0, RawInline (Format "html") "</mark>", ',docx:'RawInline (Format "openxml") "<w:r><w:rPr><w:shd w:val=\\"clear\\" w:fill=\\"ffff00\\" /></w:rPr><w:t>$0</w:t></w:r>", ',rtf:'RawInline (Format "rtf") "{{\\\\colortbl;\\\\red255\\\\green255\\\\blue0;} \\\\cb1 ", $0, RawInline (Format "rtf") "}", ',latex:'RawInline (Format "latex") "\\\\hl{", $0, RawInline (Format "latex") "}", '},j={atag:!1,imgtag:!1,comment:!0},H=function(e,t){var n=function(e){if(m.isType(e.type,v.plain,v.escape,v.emoji))return e.inner||e.text;if(t)return e.text||"";throw Error("caught styles")};O||(O=new w.InlineLexer({skipOp:j},n));try{return O.output(e.text,n,null,!0)}catch(e){return!1}},U=function(e,t){var n,i,r,o,a,s=/^(\S*)(\s*)/,l=function(e){for(var t,n="";e.length&&(t=s.exec(e));)e=e.substring(t[0].length),t[1]&&(n+='Str "'+F(t[1])+'", '),t[2]&&(n+="Space, ");return n};e.inner&&(e.inner=e.inner.replace(/, $/,""));var c=/^file:[\\\/]{0,2}/i;switch(e.type){case v.strong:case v.em:case v.del:case v.subscript:case v.superscript:return P[e.type]+" ["+e.inner+"], ";case v.plain:case v.escape:return l(e.text);case v.code:return'Code ("", [], []) "'+F(e.text.trim())+'", ';case v.autolink:case v.url:return'Link ("", [], []) [Str "'+F(e.text)+'"] ("'+F(e.href)+'", ""), ';case v.atag:if(!R(t.target))return'Link ("", [], []) ['+e.inner+'] ("'+F(e.href)+'", "'+F("")+'"), ';case v.imgtag:if(!R(t.target)){var u=$($.parseHTML(e.text));return'Image ("",[],[]) [Str "'+F(u.attr("title")||u.attr("alt")||"")+'"] ("'+F(File.editor.imgEdit.getRealSrc(e.href).replace(c,""))+'","fig:"), '}case v.tag:case v.comment:return'RawInline (Format "html") "'+F(e.text)+'", ';case v.link:if("#"==(e.href||"").trim()[0]){var h=e.href.substr(1),p=$("h1, h2, h3, h4, h5, h6").filter(function(){return $(this).text().toLowerCase().trim()==h.toLowerCase().trim()});p.length&&(e.href="#header-"+p.attr("cid"))}return'Link ("", [], []) ['+e.inner+'] ("'+F(e.href)+'", "'+F(e.title||"")+'"), ';case v.image:return'Image ("",[],[]) [Str "'+F(e.title||"")+'"] ("'+F(File.editor.imgEdit.getRealSrc(e.href).replace(c,""))+'","fig:"), ';case v.refimg:r="Image";case v.reflink:return n=t.nodeMap.link_list.getNodeByRef(e.ref||e.text),i=n?F(n.get("href").replace(c,"")):"",h=F(n&&n.get("title")||""),"Image"==(r=r||"Link")&&(e.inner='Str "'+F(h||"")+'"'),r+' ("", [], []) ['+e.inner+'] ("'+i+'", "'+h+'"), ';case v.footnote:var f=t.nodeMap.foot_list.getNodeByRef(e.text);return f?"Note [Para ["+L(f)+"]], ":l(e.text);case v.attr:return l(e.text);case v.emoji:return'Str "'+F(e.inner)+'", ';case v.inline_math:if("epub"==t.target){var m=d[e.text.replace(/(^\s*\$+)|(\$+\s*$)|\u200b/g,"").trim()];if(m)return'RawInline (Format "html") '+JSON.stringify(m)+", "}return'Math InlineMath "'+F(e.text.replace(/(^\s*\$+)|(\$+\s*$)|\u200b/g,""))+'", ';case v.linebreak:return"LineBreak, ";case v.highlight:if("latex"==t.target)T.push("\\usepackage{color}"),T.push("\\usepackage{soulutf8}");else if("docx"==t.target)return a=H(e,!0),B[t.target].replace("$0",F(y.escape(a)));o=B;case v.underline:return o=o||D,"docx"==t.target?(a=H(e,!0),o[t.target].replace("$0",F(y.escape(a)))):(o[t.target]||o.html).replace("$0",e.inner);default:return""}},q=function(e){function t(e,t){return'("'+F(e)+'", MetaList ['+t.map(function(e){return'MetaInlines [RawInline (Format "tex") "'+F(e)+'"]'}).join(", ")+"])"}var n=[];e["header-includes"]&&e["header-includes"]instanceof Array?e["header-includes"]=e["header-includes"].concat(T):T.length&&(e["header-includes"]=T);for(var i in e)n.push(function(e,n){return n instanceof Array?t(e,n):'("'+F(e)+'", MetaInlines [ '+(p.output(n).replace(/, $/,"")||'Str ""')+"])"}(i,e[i]));return n.join(", ")};g.prototype.exportToNative=function(e,t){File.editor.export.cleanUpTempFiles=s,l.call(this,e),"epub"==e&&i(),p&&p.options.nodeMap===this||(p=new w.InlineLexer(S,U));var n=M(null,"\n ,",this.getFirst(),S),r="Pandoc (Meta {unMeta = fromList ["+q(File.editor.docMenu.buildMetaMap())+"]})\n ["+n+"]";return m.isType(e,"epub","docx")?a(r,t):t(r),r}}),define("app/editor/SourceView",["codemirror/lib/codemirror","codemirror/addon/selection/active-line","codemirror/addon/edit/visiblespace","jquery/jquery","exoskeleton-master/exoskeleton","app/document/Node","app/document/StringUtils","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/KeyMaster","app/editor/UndoManager","app/editor/Emoji","app/editor/UndoManager"],function(e,t,n){"use strict";function i(e,t){var n="number"==typeof e?e:e.get("tail");return void 0===n?void 0===t?e.get("after")?1:0:t:n}function r(e){return g.isType(e,v.table_row,v.line)?0:i(e)}function o(e,t){function n(e,t){return e.get("children").toArray().reduce(function(e,n){return e+o(n,t)},0)}function r(e){return g.isType(e.get("parent"),v.list_item)&&!1!==e.get("parent").get("tight")}switch(e.get("type")){case v.meta_block:return 2+e.get("text").match(/(\n|$)/g).length+i(e);case v.heading:return(e.get("ahead")||0)+((e.get("pattern")||(!g.isType(e.get("parent"),v.list_item)&&File.option.headingStyle&&e.get("depth")<=2?"===":"#")).match(/[-=]/)?2:1)+i(e);case v.paragraph:var a=e.get("tail");return t&&(a=0),g.isType(e.get("after"),v.paragraph)&&a<1&&(e.unset("tail"),a=1),void 0!==a||!g.isType(e.get("after"),v.math_block)&&e.get("after")||(a=0),(e.get("ahead")||0)+(e.get("children").length||1)+i(void 0===a?e:a,a);case v.line:return 1;case v.blockquote:return(e.get("ahead")||0)+n(e,!0)+i(e);case v.list:var s=e.get("ahead")||0;return e.isLoose(!0),s+=n(e),g.isType(e.get("after"),v.list)&&(!e.get("tail")||e.get("tail"))<2&&e.get("pattern")==e.get("after").get("pattern")&&e.get("style")==e.get("after").get("style")&&(e.unset("tail"),s++,r(e)&&s++),t||(s+=i(e,r(e)?0:1)),s;case v.list_item:return void 0==(a=e.get("tail"))&&!e.get("tight")&&e.get("after")&&(a=1),n(e,!0)+(a||0);case v.fences:var l=/`|~/.exec(e.get("pattern")||"```");return(e.get("ahead")||0)+(l?3:1)+(e.get("text").match(/\n/g)||[]).length+i(e);case v.math_block:return(e.get("ahead")||0)+3+(e.get("text").match(/\n/g)||[]).length+i(e,g.isType(e.get("before"),v.paragraph)&&g.isType(e.get("after"),v.paragraph)?0:1);case v.hr:return i(e)+1;case v.toc:return(e.get("ahead")||0)+1+i(e);case v.def_footnote:case v.def_link:return(e.get("ahead")||0)+1+i(e,!e.get("after")||g.isType(e.get("after"),g.TYPE.def_link)?0:1);case v.table:return(e.get("ahead")||0)+e.get("children").length+1+i(e);case v.table_row:return e.get("before")?1:2;case v.table_cell:return 0;default:return 1}}function a(e,t){return t=t||0,e?e.get("before")?a(e.get("before"),t+o(e.get("before"))):e.get("parent")?a(e.get("parent"),t+(e.get("parent").get("ahead")||0)):t:t}function s(){var e=w.lineText.substring(0,w.ch);w.inRef=e.match(k)&&!e.match(S),w.textBefore=e}function l(){var e=w.textBefore;w.cellsBefore=p.splitTableCell(e.replace(/^\s*\|/,""),!0)||[e],w.cellsOffset=w.cellsBefore.last().length,w.cellsBefore=w.cellsBefore.length}var c=e("codemirror/lib/codemirror"),d=(e("codemirror/addon/selection/active-line"),e("codemirror/addon/edit/visiblespace"),e("jquery/jquery")),u=(e("exoskeleton-master/exoskeleton"),e("app/document/Node")),h=e("app/document/StringUtils"),p=e("app/document/MarkParser"),f=e("app/editor/UndoManager"),m=window.reqnode?reqnode("electron").remote:null,g=u.Node,v=u.TYPE,y=d("#typora-source"),b=(d("#toggle-sourceview-btn"),!1),w=null,x=function(e){this.editor=e,this.cm=null,this.inSourceMode=!1,this.renderedHTML=""};x.prototype.prep=function(){if(!this.cm){var e=document.querySelector("#typora-source-input"),t=this;this.cm=c.fromTextArea(e,{lineWrapping:!0,mode:"gfm",theme:"typora-default",styleSelectedText:!0,maxHighlightLength:1/0,styleActiveLine:!0,visibleSpace:!0,viewportMargin:100,autoCloseBrackets:!0,autoCloseTags:!0,resetSelectionOnContextMenu:!1,extraKeys:{Enter:"newlineAndIndentContinueMarkdownList"},lineNumbers:!0,dragDrop:!1},this.editor),y.css("z-index","2");var n=null,i=(this.cm,this.editor);File.isMac?n=app.menu.getItem("Edit").submenu():File.isNode&&(n=reqnode("electron").remote.Menu.getApplicationMenu().getItem("Edit").submenu),this.cm.on("changes",function(e,r){if(t.inSourceMode&&(document.querySelector(".on-search-panel-open")&&"+findReplace"!==r[0].origin&&"setValue"!==r[0].origin&&t.editor.searchPanel.closePanel(),"begin"!==r[0].origin&&"sync"!==r[0].origin)){b=!0;var o=File.editor.sourceView.cm.doc.historySize();n&&(n.getItem("Undo").setEnabled(!File.isLocked&&o.undo>0),n.getItem("Redo").setEnabled(!File.isLocked&&o.redo>0)),"fromDisk"!==r[0].origin&&File.updateChangeCount(File.ChangeType.NSChangeDone),i.syncChange([{type:"sync",srcChanges:r}]),File.needsUpdateSnap()}}),this.cm.on("contextmenu",function(e,n){if(t.inSourceMode){var i=e.getCursor("from"),r=e.getCursor("to");setTimeout(function(){e.setSelection(i,r,{scroll:!1})},180)}}),this.cm.on("cursorActivity",function(e,n){t.inSourceMode&&(File.isFocusMode&&i.updateFocusMode(!0),File.isTypeWriterMode&&t.scrollAdjust())}),this.cm.on("scrollCursorIntoView",function(e,n){t.inSourceMode&&!File.isTypeWriterMode||n.preventDefault()}),this.cm.display.scroller.addEventListener("wheel",function(e){Math.abs(e.deltaY)<4||File.isFocusMode&&File.isTypeWriterMode&&i.updateFocusMode(!1)},{passive:!0})}},x.prototype.show=function(){File.sync();var e=this.editor.getMarkdown();try{w=M.call(this)}catch(e){w=null,console.warn(e.stack)}this.editor.cleanTooltip(),this.editor.searchPanel.closePanel(),this.inSourceMode=!0,File.isNode&&m.getCurrentWindow().setInSourceMode(!0),d("body").addClass("typora-sourceview-on"),this.renderedHTML="",this.prep(),this.cm.setValue(e,"begin"),b=!1,y.show(),L.call(this),this.cm.refresh(),this.cm.focus(),this.cm.getDoc().clearHistory(),this.cm.options.readOnly=File.isLocked,this.enableTypeWriterMode(File.isTypeWriterMode)};var C;x.prototype.enableTypeWriterMode=function(e){if(this.cm){if(e){var t=this.cm.defaultTextHeight();C=document.querySelector("content").clientHeight,this.cm.display.lineSpace.parentNode.style.paddingTop=(C-t)/2+"px",this.cm.display.lineSpace.parentNode.style.paddingBottom=(C-t)/2+"px"}else this.cm.display.lineSpace.parentNode.style.paddingTop="",this.cm.display.lineSpace.parentNode.style.paddingBottom="";this.scrollAdjust()}},x.prototype.setValue=function(e,t,n){this.cm&&(this.cm.setValue(e,n||"begin"),t&&(b=!0))},x.prototype.onSave=function(){if(this.cm.doc.history.lastModTime=0,b){var e=this.cm.getScrollInfo().top;File.reloadContent(this.cm.getValue(File.useCRLF?"\r\n":"\n"),!1,!0,!1,!0),this.cm.scrollTo(0,e)}},x.prototype.hide=function(){var e=this.editor;d("body").removeClass("typora-sourceview-on"),this.inSourceMode=!1,File.isNode&&m.getCurrentWindow().setInSourceMode(!1),(w=this.cm.getCursor()).lineText=this.cm.getLine(w.line),s(),b&&(File.isMac&&!app.document.isDocumentEdited()&&this.renderedHTML?(d(File.editor.sessionStr).html(this.renderedHTML),setTimeout(function(){File.editor.refresh()},500),File.editor.syncChange([{type:"sync",allHtml:this.renderedHTML,json:f.buildAllDoc(File.editor.nodeMap).json}])):File.reloadContent(this.cm.getValue(File.useCRLF?"\r\n":"\n"),!1,!0,!1,!0)),y.hide(),F.call(this),e.selection.scrollAdjust()},x.prototype.scrollAdjust=function(){var e=this.cm;if(File.isTypeWriterMode){var t=e.cursorCoords(!0,"window"),n=t.top-(C+t.bottom-t.top)/2;Math.abs(n)>2&&e.scrollTo(null,e.getScrollInfo().top+n)}else{var i=this.cm.charCoords(this.cm.getCursor(),"local").top,r=this.cm.getScrollerElement().offsetHeight/2;this.cm.scrollTo(null,i-r-5)}};var k=/\[/,S=/\]/,T=function(e,t,n){function i(e,t,n){return void 0===n&&(n=(n=t?w.lineText.indexOf(e):w.lineText.lastIndexOf(e))<0?0:n),Math.max(0,w.ch-n)}var r=null;switch(t.get("type")){case v.line:case v.heading:e.undo.exeCommand({type:"cursor",id:t.cid,start:function(e,t){var n=t;for(var i in e)void 0!==i&&i<=t&&(n+=e[i]);return n}(t.cursorDiff||[],i(t.get("text")))});break;case v.hr:case v.toc:t.get("after")?e.selection.jumpIntoElemBegin(e.findElemById(t.get("after").getVeryFirst().cid)):e.selection.selectNode(t);break;case v.math_block:r=e.mathBlock.startEditing(t.cid,!0),n--;break;case v.fences:(t.get("pattern")||"```").match(/`/)&&n--,r=e.fences.getCm(t.cid);break;case v.def_link:case v.def_footnote:if(w.inRef)e.undo.exeCommand({type:"cursor",id:t.cid,start:i(t.get("ref"),!0)});else{var o=new RegExp("(]:\\s*)"+h.escapeRegExp(t.get("href")||t.get("text"))).exec(w.lineText),a=o?o.index+o[1].length:0;e.undo.exeCommand({type:"cursor",id:t.cid,start:t.get("ref").length+i(void 0,void 0,a)})}break;case v.meta_block:for(var s=t.get("text").split(/\n/),a=w.ch,c=0;c<n-1;c++)a+=(s[c]||"").length+1;e.undo.exeCommand({type:"cursor",id:t.cid,start:a});break;case v.table_row:l(),e.undo.exeCommand({type:"cursor",id:t.getNthChild(Math.max(0,w.cellsBefore-1)).cid,start:w.cellsOffset});break;default:e.selection.jumpIntoElemEnd(e.findElemById(t.getVeryFirst(!0).cid))}r&&(r.focus(),n>=r.lineCount()?r.execCommand("goDocEnd"):r.setCursor({line:n,ch:i(r.getLine(n))}))},E=function(e,t,n){var i=0;for(n+(t.get("ahead")||0)>w.line&&e.selection.jumpIntoElemBegin(e.findElemById(t.getVeryFirst().cid)),i=o(t);t.get("after")&&n+i<=w.line;)n+=i,i=o(t=t.get("after"));t.get("children").length&&!g.isType(t,v.table_row)?E(e,t.getFirstChild(),n+(t.get("ahead")||0)):n+i-r(t)>w.line?T(e,t,w.line-n-(t.get("ahead")||0)):e.selection.jumpIntoElemEnd(e.findElemById(t.getVeryFirst(!0).cid))},F=function(){var e=this.editor;try{E(e,e.nodeMap.getFirst(),0)}catch(e){console.warn(e.stack)}e.refocus()},_=function(e){return!e.get("after")&&(!e.get("parent")||_(e.get("parent")))},M=function(){if(this.editor.focusCid){var e=this.editor.findElemById(this.editor.focusCid),t=this.editor.getNode(this.editor.focusCid),n=0,i="",r="",o=this.editor.selection.getRangy();if(t){if(n=!_(t)||g.isType(t,v.heading)&&g.isType(t.get("depth"),1,2)?a(t)+(t.get("ahead")||0):-1,g.isType(t,v.fences)){var s=!/`|~/.exec(t.get("pattern")||"```");return!s&&n++,w=document.activeElement.classList.contains("mode")?{line:-1,before:t.get("pattern")||"```"}:this.editor.fences.getCm(t.cid).doc.getCursor(),w.before=(s?t.get("pattern"):"")+this.editor.fences.getCm(t.cid).getLine(w.line).substring(0,w.ch),w.line=w.line+n,w.ch=void 0,w}if(g.isType(t,v.math_block))return this.editor.mathBlock.currentCm?(w=this.editor.mathBlock.currentCm.doc.getCursor(),w.line=w.line+n+1,w):{line:n,ch:-1};if(g.isType(t,v.toc))return{line:n,before:"]"};if(g.isType(t,v.hr))return{line:n,before:this.get("pattern")||"------"};if(g.isType(t,v.def_link,v.def_footnote)){var l,c=this.editor.getJQueryElem(o.startContainer);if((l=c.closest(".md-def-content")).length)return o.setStartBefore(l[0]),i="]: "+o.toString(),{line:n,before:i};if((l=c.closest(".md-def-title")).length&&c.text().length)return o.setStartBefore(l[0]),i='"'+o.toString(),{line:n,before:i}}if(g.isType(t,v.table,v.table_row))return{line:n,ch:-1};if(o.setStartBefore(e[0]),i=o.toString().replace(/(\u200B*):(\u200B*)/g,":").replace(/\200B\$/,"$"),g.isType(t,v.table_cell)){for(r="",t=t.get("before");t;)r="\\|[^|]*"+r,t=t.get("before");return i=r+"\\|\\s*"+h.escapeRegExp(i),{line:n,beforeRegExp:i}}if(g.isType(t,v.meta_block))return i=i.replace(/^---/gm,"​---").replace(/\n$/g,""),n=(i.match(/\n/g)||[]).length+1,i=i.substring(i.lastIndexOf("\\n")),{line:n,before:i};if(""===i&&g.isType(t,v.line,v.heading)){if(g.isType(t,v.heading)){var d=t.toMark();if(/^\s*#/.exec(d))return{line:n,beforeRegExp:"^\\s*#+\\s*"}}var u=t.getTopBlock();if(g.isType(u,v.list,v.blockquote))return{line:n,ch:N(t)}}return{line:n,before:i}}}},N=function(e,t){t=t||0;var n=e.get("parent");switch(e.get("type")){case v.blockquote:t=g.getIndentPrefix(v.blockquote,0,e,e.get("pattern")).length+t;break;case v.list_item:var i=n.get("style"),r=n.isLoose(),o=n.get("children").length,a=Number.isNaN(Number.parseInt(n.get("start")))?0:Number.parseInt(n.get("start"))-1,s=n.get("pattern"),l=e.getChildIndex();r&&s&&e.get("markindent")&&(s=getDefaultPrefixPattern(i,s.trim(),e.get("markindent"))),e.get("prespace")&&(s=" ".repeat(e.get("prespace"))+s);var c=g.getIndentPrefix(i,l+a,e,s,(o+"").length),d=c.length,u=i==g.ListType.ol?(l+a+"").length-1:0;e.get("subindent")?d=Math.min(c.replace(/\s+$/,"").length+4,e.get("subindent")+u):n.get("subindent")&&(d=Math.min(c.replace(/\s+$/,"").length+4,n.get("subindent")+u)),t=d+t}return n?N(n,t):t},L=function(){if(w)try{var e=w.ch;if(w.line<0&&(w.line=this.cm.doc.lineCount()-1),void 0===e){var t=this.cm.doc.getLine(w.line);if(w.before)e=t.indexOf(w.before)+w.before.length;else if(w.beforeRegExp){var n=new RegExp(w.beforeRegExp,"g");n.exec(t),e=n.lastIndex}}this.cm.doc.setCursor({line:w.line,ch:e>0?e:0}),e<0&&this.cm.execCommand("goLineEnd")}catch(e){console.error(e.stack)}};n.exports=x}),define("codemirror/addon/selection/active-line",[],function(e,t,n){function i(e){for(var t=0;t<e.state.activeLines.length;t++)e.removeLineClass(e.state.activeLines[t],"wrap",l),e.removeLineClass(e.state.activeLines[t],"background",c),e.removeLineClass(e.state.activeLines[t],"gutter",d)}function r(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function o(e,t){for(var n=[],o=0;o<t.length;o++){var a=t[o],s=e.getOption("styleActiveLine");if("object"==typeof s&&s.nonEmpty?a.anchor.line==a.head.line:a.empty()){var u=e.getLineHandleVisualStart(a.head.line);n[n.length-1]!=u&&n.push(u)}}r(e.state.activeLines,n)||e.operation(function(){i(e);for(var t=0;t<n.length;t++)e.addLineClass(n[t],"wrap",l),e.addLineClass(n[t],"background",c),e.addLineClass(n[t],"gutter",d);e.state.activeLines=n})}function a(e,t){o(e,t.ranges)}var s=e("codemirror/lib/codemirror"),l="CodeMirror-activeline",c="CodeMirror-activeline-background",d="CodeMirror-activeline-gutter";s.defineOption("styleActiveLine",!1,function(e,t,n){var r=n!=s.Init&&n;t!=r&&(r&&(e.off("beforeSelectionChange",a),i(e),delete e.state.activeLines),t&&(e.state.activeLines=[],o(e,e.listSelections()),e.on("beforeSelectionChange",a)))})}),define("codemirror/addon/edit/visiblespace.js",[],function(e,t,n){"use strict";var i=e("codemirror/lib/codemirror");i.defineOption("visibleSpace",!1,function(e,t,n){n==i.Init&&(n=!1),n&&!t?e.removeOverlay("visiblespace"):!n&&t&&e.addOverlay({token:function(e,t){if(t.atBlockStart&&e.pos<t.atBlockStart)return e.eat(" ")?"startspace startspace-"+(e.pos-1):e.eat("\t")?"starttab startspace-"+(e.pos-1):(e.pos++,null);var n=/(^[ \t]+)|(\s+$)/.exec(e.string),i=e.string.length,r=n&&n[1]?n[1].length:-1;n&&n[2]&&n[2].length;return r>0&&r>e.pos?(e.pos++,"startspace-"+(e.pos-1)+("\t"==e.string.charAt(e.pos-1)?" starttab":" startspace")):(e.pos=i,null)},name:"visiblespace"})})}),define("app/editor/QuickOpenPanel",["jquery/jquery","app/document/StringUtils","app/editor/KeyMaster"],function(e,t,n){"use strict";function i(e){if(w.length){A=-1==A?0:(A+e)%w.length,u(".typora-quick-open-item.active").removeClass("active"),u(".typora-quick-open-item[data-index='"+A+"']").addClass("active");var t=A*T,n=v.scrollTop();(t<n||t>n+T*E-10)&&v.scrollTop(Math.min(t,(w.length-E)*T))}}function r(e){function t(e,t,n){var i=/[^\\\/]+$/.exec(e),r=i[0],a=e.substring(0,i.index);S.length&&(r=h.escape(r).replace(new RegExp("(("+S.join(")|(")+"))","gi"),"<b>$1</b>")),t.append(m.find(".typora-quick-open-item-title").html(r).end().find(".typora-quick-open-item-path").text(o(a)).end().clone().attr("data-original",e).attr("data-index",n+"").addClass(A==n?"active":""))}function n(e,t){t.append(g.clone().find(".typora-quick-open-info").text(u.localize.getString(e?"Gathering more results":"Searching")).end())}function i(e){if(!(e<0)){var i=u("<div>").css("position","absolute").css("top",e*r*40+"px").css("width","100%"),o=w.length;d=Math.min(o+N,e*r+r+N);for(var a=e*r;a<d;a++)a==o?n(o,i):t(w[a],i,a);y.append(i)}}var r=20,a=v.scrollTop(),s=Math.floor(a/40),l=Math.floor(s/r);l!=F&&(i((F=l)-1),i(F),i(F+1))}function o(e){return(e=e.replace(M,"~")).length>60?e.substring(0,30)+"..."+e.substring(e.length-30,e.length):e}function a(){F=-1,y.html("").height(T*(w.length+N)),r()}function s(e){var t=[],n=(S=e.split(/\s+/).filter(h.isNotNullOrEmpty).map(function(e){return e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace("*",".*")})).map(function(e){return new RegExp("(.)?"+e+"(.)?","i")}),i=[];S.length?(x.forEach(function(e){for(var i,r=0,o=0;o<n.length;o++){if(!(i=l(e.n,n[o])))return;r+=i}e.s=r,t.push(e)}),t.sort(function(e,t){var n=t.s-e.s;return n||t.d-e.d}),t=C.filter(function(e){for(var t=0;t<n.length;t++)if(!l(e.n,n[t]))return!1;return!0}).concat(t)):t=(C||[]).clone().concat(x),t.forEach(function(e){-1==i.indexOf(e.p)&&i.push(e.p)}),this.initResult(i)}function l(e,t){e=h.removeDiacritics(e);var n=t.exec(e);return n?(n[1]=n[1]||"",n[3]=n[3]||"",4-n[1].length-(/\w/.test(n[1])?1:0)-(/\w/.test(n[3])?1:0)):0}function c(e){_=(w[A]||{}).p,L&&(this.setSearchState(1),File.isMac&&app.quickOpen.query(e)),s.call(this,e),File.isMac&&app.quickOpen.reindexFolderIfNeeded()}var d,u=e("jquery/jquery"),h=e("app/document/StringUtils"),p=e("app/editor/KeyMaster").map,f=function(e){this.editor=e},m=u(u("#typora-quick-open-item-templ").html()),g=u(u("#typora-quick-loading-item-templ").html()),v=u(".typora-quick-open-list"),y=u(".typora-quick-open-list-inner"),b=u("#typora-quick-open-input input"),w=[],x=[],C=[],k="",S=[],T=40,E=5,F=-1,_=null,M=window.app&&new RegExp("^"+h.escapeRegExp(app.path.home)),N=0,L=!0,A=-1;f.prototype.init=function(){var e=this;b.on("input",function(){var t=u(this).val();t!=k&&(w=[],k=t.replace(/[()'"%\\\/.?]/," "),c.call(e,k))}).on("keydown",function(t){var n=t.keyCode||t.which;if("Esc"==p[n]||"o"==p[n]&&t.shiftKey&&t.metaKey)return e.close(),!1;if("Tab"==p[n])return!1;if("Up"==p[n])return i(-1),!1;if("Down"==p[n])return i(1),!1;if("Enter"==p[n]&&File.isMac&&u(".typora-quick-open-item.active").length)return app.path.openURL(w[A],void 0,!0),!1;if(File.isMac&&t.ctrlKey&&!t.metaKey&&!t.shiftKey){if("P"==String.fromCharCode(n))return i(-1),!1;if("N"==String.fromCharCode(n))return i(1),!1}t.stopPropagation()}).on("blur",function(){setTimeout(e.close,200)}),v.on("mousedown",".typora-quick-open-item",function(){File.isMac&&app.path.openURL(this.getAttribute("data-original"),void 0,!0)}).on("scroll",r),File.isMac&&app.quickOpen.cacheRecentFiles()},f.prototype.show=function(){var e=u("#typora-quick-open:not(:visible)").show();this.editor.searchPanel.closePanel(!0),e.length&&(u("content").css("overflowY","hidden"),b[0].select(),A=-1,c.call(this,""))},f.prototype.close=function(){u("#typora-quick-open:visible").hide().length&&(u("content").css("overflowY",""),File.isMac&&app.quickOpen.stopQuery()),A=-1},f.prototype.updateResult=function(e){(e=e.filter(function(e){return-1==w.indexOf(e)})).length&&(w=w.concat(e),File.isMac&&w.remove(app.document.currentFilePath()),a.call(this))},f.prototype.initResult=function(e){A=_?w.indexOf(_):e.length?0:-1,w=e,File.isMac&&w.remove(app.document.currentFilePath()),a.call(this)},f.prototype.initFileCache=function(e,t,n,i,r){x=e.map(function(e,i){return{n:t[i],p:e,d:n[i]}}),C=r.map(function(e){return{n:(/[^\\\/]+$/.exec(e)||[])[0]||"",p:e}}),L=i>e.length},f.prototype.setRecentFiles=function(e){C=e.map(function(e){return{n:(/[^\\\/]+$/.exec(e)||[])[0]||"",p:e}})},f.prototype.setSearchState=function(e){N!==e&&(e&&d==w.length?(u(".typora-quick-open-item:last").after(g.clone().find(".typora-quick-open-info").text(u.localize.getString(d?"Gathering more results":"Searching")).end()),d++):e||(u(".typora-quick-open-info-item").remove().length&&y.height(y.height()-40),d==w.length+1&&d--),N=e)},n.exports=f}),define("app/window/Library",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileInfoPanel","app/window/FileHelper","app/editor/FileTree","app/window/FileInfoPanel","app/editor/FileList"],function(e,t,n){"use strict";var i,r,o,a=e("app/document/StringUtils"),s=e("exoskeleton-master/exoskeleton"),l=e("app/document/Node"),c=(l.Node,l.TYPE,e("app/window/FileHelper")),d=e("app/window/FileInfoPanel"),a=e("app/document/StringUtils"),u=e("app/editor/KeyMaster").map,h=e("app/editor/FileTree"),p=e("app/editor/FileList"),f=e("jquery/jquery"),m=window.reqnode?reqnode("electron").remote:null,g=m?m.app:window.app,v=m?m.getCurrentWindow():null;window.onWindowFocus=function(e){try{if(File.isNode&&File.getCurrentDocByNode().setActiveWindow(v),File.isMac?File.bindMenu():File.freshMenu(!0),File.editor.imgEdit.refreshLocalImg(),File.isNode){if(!o&&File.filePath&&!reqnode("fs-plus").isFileSync(File.filePath))return void d.onPresentationMoved();File.getMountFolder()&&(reqnode("fs-plus").isDirectorySync(File.getMountFolder())||File.editor.library.onRootChanged())}if(!e&&File.editor.selection){var t=File.editor.selection.buildUndo();File.restoreEditStateFromData(File.getDocumentSnap(),!0)||(File.editor.lastCursor=t,File.editor.restoreLastCursor())}File.isMac&&File.editor.library.markOpenedFile(c.getCurrentFilePath())}catch(e){console.error(e)}finally{return"DONE"}},window.onWindowBlur=function(){try{if(!window.File||!File.editor||!File.editor.sourceView)return;i=!!File.editor.sourceView.inSourceMode||(File.editor.selection.buildUndo()||!0),File.isMac?window.File.isLocked=!0:document.body.classList.remove("mouse-entered"),File.backupDocumentSnap()}catch(e){console.error(e)}};f(".sidebar-content"),f(".sidebar-mac-tab");var y,b=function(e){File.isBroken||(e=e||"").toLowerCase()!=(File.filePath||"").toLowerCase()&&c.tryLeaveDocument(function(t){if(!t){var n,i=m.getCurrentWindow();g.getDocumentController();File.contentSnapRestoredTime=-1,File.buildDocumentSnap(),(n=g.getDocumentController().switchDocument(i.id,e)).snap?(d.setFileTitle(e,n.snap.fileEncode),File.onSwitchDocumentTarget(n.snap)):(File.fileName=void 0,File.onSwitchDocumentTarget(null,e))}},!0)},w=[],x=s.Model.extend({initialize:function(e,t){this.editor=e,this.root,this.items,this.fsWatcher,this.fileTree=new h(this),this.fileList=new p(this),this.useTreeStyle,this.supportResize_,this.bindLiveResize(),this.defaultTab=File.option.sidebarTab||(File.isMac?"file-list":"outline"),"outline"==this.defaultTab?document.querySelector("#typora-sidebar").classList.add("active-tab-outline"):document.querySelector("#typora-sidebar").classList.add("active-tab-files"),File.isNode&&f("#reveal-folder-from-sidebar-menu").text(f.localize.getString("Reveal in File Explorer"))},supportResize:function(){return void 0===this.supportResize_?(this.supportResize_=!(!window.CSS||!window.CSS.supports||!window.CSS.supports("--sidebar-width",0)&&!window.CSS.supports("(--foo: red)")),this.supportResize_):this.supportResize_},bindLiveResize:function(){var e=f("#typora-sidebar-resizer");return void e.remove()},setSidebarWidth:function(e,t){var n=e?e+"px":"";document.documentElement.style.setProperty("--sidebar-width",n),File.isMac&&("true"!=(window.getComputedStyle(document.body).getPropertyValue("--typora-center-window-title")||"").trim()&&document.body.classList.contains("pin-outline")?g.window.setTitlebarTextMarginLeft(e):g.window.setTitlebarTextMarginLeft(void 0)),t&&g.setting.put("sidebar-width",e)},isSuppressOnChange:function(){return r},markFocusOnDialogClose:function(){o=!0,setTimeout(function(){o=!1},200)},pauseOnChange:function(e){r=!0,e&&setTimeout(function(){r=!1},File.isMac?2e3:200)},resumeOnChange:function(){r=!1},isFileTabShown:function(){return!!document.querySelector(".pin-outline .active-tab-files")},isSidebarShown:function(){return document.body.classList.contains("pin-outline")},isOutlineShown:function(){return f(".pin-outline .active-tab-outline").length>0},getActiveTab:function(){return this.isSidebarShown()?this.isFileTabShown()?this.useTreeStyle?"file-tree":"file-list":"outline":""},togglePanel:function(e){this.isSidebarShown();this.getActiveTab()==e?this.toggleSidebar():this.showSidebar(e)},toggleSidebar:function(){this.isSidebarShown()?this.hideSidebar():this.showSidebar()},tmpHideSidebar:function(e){this.savedSidebarStatus=this.isSidebarShown(),this.editor.docMenu.autoHideOutline(),this.hideSidebar(!e)},recoverSidebar:function(){this.savedSidebarStatus&&this.showSidebar()},hideSidebar:function(e){this.editor.docMenu.storeOutline(),document.querySelector("#typora-sidebar").classList.remove("open"),document.body.classList.remove("pin-outline"),!e&&g&&g.setting.put("sidebar_tab",""),f(window).trigger("resize"),File.isMac&&g.window.setTitlebarTextMarginLeft(void 0)},showSidebar:function(e,t){this.editor.docMenu.autoHideOutline(),t&&this.isSidebarShown()?this.switch(e):this.show(e)},show:function(e){document.querySelector("#typora-sidebar").classList.add("open"),document.body.classList.add("pin-outline"),this.switch(e||this.getActiveTab()||this.defaultTab),this.editor.docMenu.renderOutline(),f(window).trigger("resize"),File.isMac&&"true"!=(window.getComputedStyle(document.body).getPropertyValue("--typora-center-window-title")||"").trim()&&g.window.setTitlebarTextMarginLeft(document.querySelector("#typora-sidebar").getBoundingClientRect().width)},switchTreeOrList:function(e){this.useTreeStyle!==e&&(this.useTreeStyle=e,f(".sidebar-content").scrollTop(0),this.useTreeStyle?f("#typora-sidebar").addClass("use-file-tree-style").removeClass("use-file-list-style").find("#sidepanel-segmented-input-files").attr("data-localize",f.localize.getString("Files")).text(f.localize.getString("Files")):f("#typora-sidebar").addClass("use-file-list-style").removeClass("use-file-tree-style").find("#sidepanel-segmented-input-files").attr("data-localize",f.localize.getString("Articles")).text(f.localize.getString("Files")),f("#sidepanel-segmented-input-files").localize("Front",{language:File.language,pathPrefix:"locales"})),this.isFileTabShown()&&!this.renderIfNeed()&&this.markCurrentFile(!0),f("[data-side-mode]").removeClass("selected-folder-menu-item"),this.useTreeStyle?f("[data-side-mode='file-tree']").addClass("selected-folder-menu-item"):f("[data-side-mode='file-list']").addClass("selected-folder-menu-item"),f("#sidebar-footer-main-item-label").text(c.getFileNameFromPath(File.getMountFolder())||f.localize.getString("Open Folder...")),g&&g.setting.put("sidebar_tab",e?"file-tree":"file-list")},openFile:function(e){e&&!File.isBroken&&(f("#sidebar-files-menu").trigger("blur"),File.isMac?g.controller.switchDocumentTarget(e):(File.megaMenu.hide(),b(e)))},openFileInNewWindow:function(e,t){e&&(File.backupDocumentSnap(),File.isMac?t?g.app.openFolder(e):g.app.openInTypora(e,!0):m.app.openFileOrFolder(e,{forceCreateWindow:!0,mountFolder:File.getMountFolder()}))},onLoadFolderFailed:function(e){!e&&alert(f.localize.getString("Cannot open folder {0}")/format(File.getMountFolder())),File.isNode&&m.app.setting.removeRecentFolder(File.getMountFolder()),f("#file-library-tree, #file-library-list-children").attr("data-state","").html(""),File.mountFolder_=null,this.root=null,this.refreshMenuVisibility()},addFolderWatchByWin:function(e,t){function n(e,t){y&&clearTimeout(y),w.push([e,t]),y=setTimeout(i,200)}function i(){var t=w.clone();y=null,w=[];var n=[],i=[];t.forEach(function(t){a.fileTree.onChangeForWin(t[0],t[1],e,n),a.fileList.onChangeForWin(t[0],t[1],e,i)})}function o(e,t){"INITIALIZATION_FAILED"==t?console.error("failed to initialize the watcher. any failure during the initialization may case this error. such as the path is inaccessible or nonexistent."):"UNABLE_TO_WATCH_SELF"==t?console.error('failed to watch parent diectory. it means the "MOVED" event will nolonger fire. this error always occurs at the start up under winxp. since the GetFinalPathNameByHandleW API is not available.'):"UNABLE_TO_CONTINUE_WATCHING"==t&&console.error('some error makes the watcher stop working. perhaps the directory you are watching is deleted or becoming inaccessible. the "ENDED" event will fire after this error.')}if(e){var a=this;this.fsWatcher&&this.fsWatcher.close();reqnode("fswin-aio");var s={};s.WATCH_SUB_DIRECTORIES=!0,s.CHANGE_FILE_SIZE=!1,s.CHANGE_LAST_WRITE=!t,s.CHANGE_LAST_ACCESS=!1,s.CHANGE_CREATION=!0,s.CHANGE_ATTRIBUTES=!1,s.CHANGE_SECUTITY=!1,this.fsWatcher=reqnode("fswin-aio").dirWatcher(e,function(e,t){if(!r)if(t&&t.OLD_NAME,"ERROR"!=e)if("STARTED"!=e)if("MOVED"!=e)n(e,t);else{if(File.filePath&&0==File.filePath.indexOf(File.getMountFolder()+"\\")){var i=t+"\\"+File.filePath.substr(File.getMountFolder().length);doApplyRename(i)}a.onRootChanged(t)}else console.log("start monitoring folder change.");else o(0,t)},s)}},bindContext:function(){function e(e){if(t=this,this==document.querySelector("#file-library")&&n.useTreeStyle){if(e.target!=this||!File.editor.library.root)return!1;t=n.findElemFromPath(File.editor.library.root.path)[0],f("#file-menu").children("li").hide().end().find('[data-action="new_file"],[data-action="new_folder"]').show()}else f("#file-menu li").show();File.sync(),n.editor.lastCursor=n.editor.selection.buildUndo(),f("#write").blur(),f(".context-menu").removeClass("show").find(".active").removeClass("active");var i=f(t).closest(".file-library-node").focus(),r=f("#file-menu").addClass("show");n.useTreeStyle?(r.find('[data-action="new_folder"]').show(),i.attr("data-path")==File.getMountFolder()?r.find("[for-file]").hide():"true"==i.attr("data-is-directory")?r.find("[for-file]:not([for-folder])").hide():r.find("[for-folder]:not([for-file])").hide()):(r.find('[data-action="new_folder"]').hide(),r.find("[for-folder]:not([for-file])").hide());var o=r.height()+48,a=e.clientX>window.innerWidth-220?window.innerWidth-220:e.clientX,s=e.clientY>window.innerHeight-o?window.innerHeight-o:e.clientY-f("#top-titlebar").height()+8;return r.css({top:s+"px",left:a+"px"}),i.one("blur",function(){document.activeElement&&document.activeElement.classList.contains("file-node-content")||f(".context-menu").removeClass("show")}),!1}var t,n=this;f("#file-menu").on("mousedown","[data-key]",function(e){var i=this.getAttribute("data-action");if(i&&1==e.which){switch(f(".context-menu").removeClass("show").find(".active").removeClass("active"),i){case"open":n.openFileCommand(t);break;case"open_in_new_window":n.openFileInNewWindowCommand(t);break;case"new_file":return n.newFileCommand(t),!1;case"new_folder":return n.newFolderCommand(t),!1;case"delete":n.deleteFileCommand(t);break;case"rename":return n.getDelegate().renameFileCommand(t),!1;case"copy_path":n.copyFullPathCommand(t);break;case"reveal":n.revealFileInFinderCommand(t);break;default:return}n.editor.restoreLastCursor(null,!0)}}),f("#file-library").on("contextmenu",".file-node-content, .file-list-item",e).on("contextmenu",e)},bindEvents:function(){function e(){f(".show-sidebar-footer-context").removeClass("show-sidebar-footer-context")}var t=this;File.isNodeHtml,f("#sidepanel-segmented-input-files").click(function(){t.switch("files",!0)}),f("#sidepanel-segmented-input-outline").click(function(){t.switch("outline",!0)}),f("#typora-sidebar").on("keydown","[tabindex]",function(e){"Esc"==u[e.keyCode||e.which]&&t.editor.focusCid&&t.editor.restoreLastCursor(null,!0)}).on("mousedown","[tabindex]",function(e){if("INPUT"!=e.target.tagName){var n=t.editor.selection.buildUndo();n&&(t.editor.lastCursor=n)}}),f("#ty-sidebar-footer").on("click","#sidebar-new-file-btn",function(){t.newFile(File.getMountFolder())}).on("click","#switch-file-list-btn",function(){t.switchTreeOrList(!t.useTreeStyle)}).on("click","#target-cur-file-btn",function(){File.getMountFolder()&&t.getDelegate().focusToFile(c.getCurrentFilePath())}).on("click","#sidebar-menu-btn",function(){f(".show-sidebar-footer-context").length?e():t.showSidebarMenu()}),f(".sidebar-tabs").on("click","#hide-sidebar-btn",function(){t.hideSidebar()}).on("click","#switch-sidebar-icon",function(){t.switch(t.isFileTabShown()?"outline":"files")}),f("#sidebar-files-menu").on("blur",function(){e()}).on("mousedown","#close-sidebar-menu-btn",function(){e()}).on("mousedown","#new-file-from-sidebar-menu",function(e){1==e.which&&t.newFile(File.getMountFolder())}).on("mousedown","#reveal-folder-from-sidebar-menu",function(e){1==e.which&&File.getMountFolder()&&(File.isMac?g.path.openFolderInFinder(File.getMountFolder()):m.shell.openItem(File.getMountFolder()))}).on("mousedown","#refresh-from-sidebar-menu",function(e){1==e.which&&File.getMountFolder()&&t.refreshPanelCommand()}).on("mousedown","#open-folder-from-sidebar-menu",function(e){1==e.which&&setTimeout(t.selectFolder.bind(t),100)}).on("mousedown","[data-side-mode]",function(e){1==e.which&&t.switch(this.getAttribute("data-side-mode"))}).on("mousedown",".folder-menu-item",function(e){1==e.which&&File.getMountFolder()!=this.getAttribute("data-path")&&(File.isMac?g.controller.switchFolder(this.getAttribute("data-path")):g.switchFolder(this.getAttribute("data-path"),m.getCurrentWindow()))}).on("click","#ty-group-by-folder-btn",function(e){return t.getDelegate().setGroupByFolder(!t.fileList.expandFolders),!1}).on("click","#ty-sort-by-natural-btn",function(){return t.getDelegate().setSortType(0),!1}).on("click","#ty-sort-by-name-btn",function(){return t.getDelegate().setSortType(1),!1}).on("click","#ty-sort-by-date-btn",function(){return t.getDelegate().setSortType(2),!1}).on("keydown",function(e){"Esc"==u[e.keyCode||e.which]&&this.blur()}),this.fileTree.bindEvents(),this.fileList.bindEvents(),File.isNodeHtml&&this.bindContext()},selectFolder:function(){if(File.isMac)g.controller.selectFolder();else{var e=m.dialog,t=m.getCurrentWindow(),n=this;e.showOpenDialog(t,{buttonLabel:f.localize.getString("Select"),properties:["openDirectory"]},function(e){var t=(e||[])[0];t&&n.onRootChanged(t)})}},showSidebarMenu:function(){function e(e,t){var n=f(f("#folder-menu-item-template").html());return n.find("span").text(c.getFileNameFromPath(e)),n.attr("data-path",e),n.attr("ty-hint",a.abbreviatingWithTilde(e)),t.before(n),n}f(".sidebar-footer").addClass("show-sidebar-footer-context");var t=f("#sidebar-files-menu").focus();!function(){t.find(".folder-menu-item").remove().end().find(".folder-menu-group").show();var n=f(".sidebar-content").height(),i=t.find("#reveal-folder-from-sidebar-menu")[0].clientHeight,r=t[0].clientHeight,o=Math.max(0,Math.min(6,Math.floor((n-r-20)/i))),a=File.isMac?g.controller.getRecentFolders():g.setting.getRecentFolders().map(function(e){return e.path});a=a.slice(0),File.getMountFolder()?(a.remove(File.getMountFolder()),a=a.slice(0,(o||1)-1)):a=a.slice(0,o);for(var s=f("#folder-menu-item-after"),l=0;l<a.length;l++)e(a[l],s);File.getMountFolder()?e(File.getMountFolder(),s).addClass("selected-folder-menu-item"):0==a.length&&t.find(".folder-menu-group").removeClass("show")}()},init:function(){if(File.option.sidebarTab&&this.show(File.option.sidebarTab),this.bindEvents(),File.isMac&&g.controller.isLoadFolder()&&!c.getCurrentFilePath()&&(this.isFileTabShown()||this.show(this.useTreeStyle?"file-tree":"file-list"),this.useTreeStyle)){var e=this;setTimeout(function(){e.openFileCommand(document.querySelector(".file-library-file-node[data-path]"))},0),g.controller.setLoadFolder(!1)}},switch:function(e,t){if(f(".sidebar-content").scrollTop(0),"outline"==e)f("#typora-sidebar").addClass("active-tab-outline").removeClass("active-tab-files"),f("[data-side-mode]").removeClass("selected-folder-menu-item"),f("[data-side-mode='outline']").addClass("selected-folder-menu-item"),f("#sidebar-footer-main-item-label").text(f.localize.getString("Outline")),this.editor.docMenu.highlightVisibleHeader(),this.useTreeStyle?f("#switch-sidebar-icon").html('<span class="ty-icon ty-file-tree"></span>').attr("ty-hint",f.localize.getString("Switch to File Tree view")):f("#switch-sidebar-icon").html('<span class="ty-icon ty-three-cells"></span>').attr("ty-hint",f.localize.getString("Switch to File List view"));else{f("#typora-sidebar").removeClass("active-tab-outline").addClass("active-tab-files");var n=this.useTreeStyle||!1;"file-list"==e?n=!1:"file-tree"==e?n=!0:e=n?"file-tree":"file-list",this.switchTreeOrList(n),this.refreshMenuVisibility(),f("#switch-sidebar-icon").html('<span class="ty-icon ty-list"></span>').attr("ty-hint",f.localize.getString("Switch to Outline view"))}f("#switch-sidebar-icon").localize("Front",{language:File.language,pathPrefix:"locales"}),g&&g.setting.put("sidebar_tab",e),File.isNode||f(".sidebar-tab").removeClass("active").filter("outline"==e?"#sidepanel-segmented-input-outline":"#sidepanel-segmented-input-files").addClass("active")},calcMountFolder:function(e){File.getMountFolder();if(File.isMac)File.mountFolder_=g.controller.mountFolder();else{if(!File.isNode)return null;if(!File.getMountFolder())try{File.mountFolder_=function(t){var n=reqnode("path"),i=reqnode("fs"),r=t;if(!t)return null;for(;r&&/^\w*\/+\w/.exec(r);){var o=i.readdirSync(r);if(o.indexOf(".git")>-1||o.indexOf(".svn")>-1||o.indexOf(".hg")>-1||o.indexOf("package.json")>-1)return r;if(/((dropbox\/apps\/[^\/]+)|pages|articles?|blogs?|content)\/?$/i.exec(r))return r;if(/(_?posts?|_?drafts?)\/?$/i.exec(r))return r;if(/(node_modules)\/[^\/]+\/?$/i.exec(r))return r;var a=r;if((r=n.join(r,"../"))==a||e)break}return/^\w*\/+\w/.exec(t)?t.replace(/[\/\\]$/,"")||null:t}(c.getCurrentFileFolderPath())}catch(e){}}return this.isFileTabShown()&&(File.getMountFolder()?f("#sidebar-menu-btn .sidebar-footer-main-item-label").text(c.getFileNameFromPath(File.getMountFolder())):f("#sidebar-menu-btn .sidebar-footer-main-item-label").text("Open Folder…")),File.getMountFolder()},fetchRecentFile:function(){},renderIfNeed:function(){return this.useTreeStyle?this.fileTree.renderIfNeed():this.fileList.renderIfNeed()},findElemFromPath:function(e){return f(".file-library-node[data-path='"+a.escapeSelector(e)+"']")},revealInSidebar:function(){this.isFileTabShown()?this.markCurrentFile():c.getCurrentFilePath()&&this.showSidebar("files")},revealInFileList:function(){this.showSidebar("file-list"),this.markCurrentFile()},revealInFileTree:function(){this.showSidebar("file-tree"),this.markCurrentFile()},markCurrentFile:function(e,t){var n=c.getCurrentFilePath();n&&(this.markOpenedFile(n,t),this.getDelegate().focusToFile(n,e))},markOpenedFile:function(e,t){return e?(t||f(".file-library-node.active").removeClass("active"),this.findElemFromPath(e).addClass("active")):f()},end:function(){this.fileTree.needRepaint(),this.fileList.needRepaint(!0),this.root=null,File.mountFolder_=null,this.fsWatcher?(this.fsWatcher.close(),this.fsWatcher=null,y&&clearTimeout(y)):File.isUnixNode&&(this.fileTree.unixWatchers={},this.fileList.unixWatchers={},reqnode("pathwatcher").closeAllWatchers())},refreshMenuVisibility:function(){var e=f("#ty-sidebar-footer");File.getMountFolder()?(e.find(".empty-menu-group").removeClass("show"),e.find(".not-empty-menu-group").addClass("show")):(e.find(".empty-menu-group").addClass("show"),e.find(".not-empty-menu-group").removeClass("show")),f("#sidebar-footer-main-item-label").text(c.getFileNameFromPath(File.getMountFolder())||f.localize.getString("Open Folder..."))},onRootChanged:function(e){this.end(),File.isNode&&(File.mountFolder_=e,e&&m.app.setting.addRecentFolder(e)),f("#file-library:visible").length&&this.renderIfNeed(),this.refreshMenuVisibility()},setMountFolder:function(e,t){this.onRootChanged(e),t&&this.showSidebar(this.useTreeStyle?"file-tree":"file-library",!0)},onFileChanges:function(e){if(File.getMountFolder()){var t=JSON.parse(e);this.fileTree.onChangeForMac(t),this.fileList.onChangeForMac(t)}},getDelegate:function(){return this.useTreeStyle?this.fileTree:this.fileList},newFile:function(e){File.getMountFolder()&&this.getDelegate().newFile(e)},openFileCommand:function(e){e||retrun;var t=this.editor.getJQueryElem(e).closest(".file-library-node").attr("data-path");this.openFile(t),this.editor.docMenu.autoHideOutline()},openFileInNewWindowCommand:function(e){if(e=this.editor.getJQueryElem(e).closest(".file-library-node")[0]){var t="true"==e.dataset.isDirectory,n=e.dataset.path;this.openFileInNewWindow(n,t)}},copyFullPathCommand:function(e){var t=this.editor.getJQueryElem(e).closest(".file-library-node").attr("data-path");this.editor.UserOp.setClipboard("<span>"+t+"</span>",null,t,!0)},revealFileInFinderCommand:function(e){var t="string"==typeof e?e:this.editor.getJQueryElem(e).closest(".file-library-node").attr("data-path");File.isMac?g.path.showInFinder(t):m.shell.showItemInFolder(t)},renameFileCommand:function(e,t){this.getDelegate().renameFileCommand(e,t)},newFileCommand:function(e,t){this.getDelegate().newFileCommand(e,t)},newFolderCommand:function(e){this.fileTree.newFolderCommand(e)},deleteFileCommand:function(e){var t=this.editor.getJQueryElem(e).closest(".file-library-node"),n=t.attr("data-path");if(n==c.getCurrentFilePath()){var i=this.useTreeStyle?f():t.filter(".file-list-item").next();i.length?this.openFileCommand(i[0]):File.isNode?b(null):g.controller.switchDocumentTarget("")}t.hide(),File.isMac?g.library.trashItem(n):File.isNode&&m.shell.moveItemToTrash(n)},refreshPanelCommand:function(){var e=File.getMountFolder();this.end(),File.isNode?File.mountFolder_=e:(g.controller.switchFolder(e),g.controller.bindFolderMonitor()),this.renderIfNeed(),this.refreshMenuVisibility()},bindRename:function(e,t,n,i){function r(e){return File.isWin?e.replace(/[\\\/:*?"<>\|\000-\031]/g,"").trim():e.replace(/[\/\\\000-\031]/g,"")}function o(){if(!c){c=!0;var i=r(e.val());i.length>0&&i!=d?(e.val(i),t(e)):n()}}function a(t){var n=e.val(),i=n.lastIndexOf(".");i<0&&t&&(i=n.length),i>0&&e[0].setSelectionRange(0,i)}function s(e){e.val(r(e.val())),d!=e.val()?File.isLinux?m.dialog.showMessageBox(null,{title:f.localize.getString("Confirm"),message:f.localize.getString('Rename to "{0}" ?').format(e.val()),type:"question",buttons:["OK","Cancel"]},function(e){0==e?(h.markFocusOnDialogClose(),o()):n()}):confirm(f.localize.getString('Rename to "{0}" ?').format(e.val()))?(h.markFocusOnDialogClose(),o()):n():n()}var l,c,d=e.val(),h=this;e.one("blur",function(){l||(l=!0,i?o():s(e))}).on("keydown",function(e){return"Enter"==u[e.keyCode||e.which]?(l=!0,o(),!1):"Esc"==u[e.keyCode||e.which]?(l=!0,n(),!1):"A"==u[e.keyCode||e.which]&&(File.isMacOrMacNode?e.metaKey:e.ctrlKey)?(a(!0),!1):void 0}).on("mousedown",function(e){e.stopPropagation()}).on("click",function(e){e.stopPropagation()}).on("mouseup",function(e){1==e.which&&this.selectionEnd==this.selectionStart&&this.selectionEnd==this.value.length&&a()}).on("focus",a)}});n.exports=x}),define("app/editor/FileTree",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileInfoPanel","app/editor/KeyMaster"],function(e,t,n){"use strict";function i(e){return e==this.getRoot()?e.path==y?"fa fa-history":"fa fa-folder":e.isDirectory?"fa fa-folder":"fa fa-file-text-o"}function r(e,t){return File.isMac?new Promise(function(t,n){t(a(e))}):s(e,!1,t)}function o(e,t){return c.naturalSort(e.name,t.name)}function a(e){function t(e){e.subdir&&(e.subdir.sort(o),e.content.sort(o),e.subdir.forEach(t))}var n=g.library.listDocsUnder(e.path);if(!n)return null;var i=JSON.parse(n);return e.fetched=!0,e.subdir=i.subdir,e.subdir.forEach(function(e){e.fetched=!0}),e.content=i.content,e.isDirectory=i.isDirectory,e.isFile=i.isFile,e.name=i.name,t(e),e}function s(e,t,n){function i(e){return File.filePath&&0==File.filePath.indexOf(e+l)}var r=reqnode("fs-plus"),a=reqnode("path"),l=File.isWin?"\\":"/";return new Promise(function(l,c){var d=e.path;if(e.name=a.basename(d)||d,e.subdir=[],e.content=[],e.fetched=!t,"."==e.name[0])return l();w(d,function(a){if(!a||a.shouldIgnore)return l();if(e.isDirectory=a.isDir,e.isFile=a.isFile,a.isFile)return e.fetched=!0,h.isSupportedFile(e.name)?l(e):l();if(a.isDir){if(i(d))e.isOpen=!0;else if(t)return l(e);e.isDirectory&&(e.fetched||e.isOpen)&&File.isUnixNode&&n.addFolderWatchByUnix(e),r.list(d,void 0,function(t,i){if(t)return l();Promise.all(i.map(function(t){return s({path:t},!e.isOpen,n)})).then(function(t){if(e.subdir.length+e.content.length>0)return e.fetched=!0,void l(e);t.forEach(function(t){t&&(t.isDirectory?e.subdir.push(t):e.content.push(t))}),e.fetched=!0,e.subdir.sort(o),e.content.sort(o),l(e)})})}})})}var l,c=e("app/document/StringUtils"),d=e("exoskeleton-master/exoskeleton"),u=e("app/document/Node"),h=(u.Node,u.TYPE,e("app/window/FileHelper")),p=e("app/window/FileInfoPanel"),c=e("app/document/StringUtils"),f=(e("app/editor/KeyMaster").map,e("jquery/jquery")),m=window.reqnode?reqnode("electron").remote:null,g=m?m.app:window.app,v=!1,y=(m&&m.getCurrentWindow(),"_recent"),b=[],w=h.statWrapper,x=(h.allowedExtensions,d.Model.extend({initialize:function(e){this.parent=e,this.editor=e.editor,this.$template=f(document.querySelector("#file-library-node-template").textContent),this.root,this.unixWatchers={}},getRoot:function(){return this.parent.root},setRoot:function(e){return this.parent.root=e},renderNode:function(e){if(!e)return f();var t=this.$template.clone();e==this.getRoot()?(e.isOpen=!0,t.find(".file-node-open-state").remove()):e.isDirectory&&e.subdir&&(e.subdir.length||e.content.length)&&t.attr("data-has-sub","true").addClass(e.isOpen?"file-node-expanded":"file-node-collapsed");var n=e.name.indexOf(".");if((n<0||e.isDirectory)&&(n=e.name.length),t.find(".file-node-title-name-part").text(e.name.substr(0,n)),t.find(".file-node-title-ext-part").text(e.name.substr(n)),t.attr("data-path",e.path).attr("data-is-directory",e.isDirectory),t.find(".file-node-icon").addClass(i.call(this,e)),e.isDirectory||t.addClass("file-library-file-node"),e==this.getRoot()?t.addClass("file-node-root"):e.isDirectory||e.path!=h.getCurrentFilePath()||t.addClass("active"),e.isDirectory&&e.subdir){var r=t.find(".file-node-children");r.html(""),e.isOpen&&(e.subdir.forEach(function(e){r.append(this.renderNode(e))},this),e.content.forEach(function(e){r.append(this.renderNode(e))},this))}return t},renderIfNeed:function(){return!v&&(this.render(),File.isWin&&this.parent.addFolderWatchByWin(File.getMountFolder()),!0)},render:function(){function e(){v="complete",f("#file-library-tree").html("").append(this.renderNode(this.getRoot())).attr("data-state",""),this.parent.markCurrentFile()}v=!0;var t=this,n=File.getMountFolder();this.getRoot()||(this.parent.root={path:this.parent.calcMountFolder(),isOpen:!0},this.getRoot().path?r(this.getRoot(),t).then(function(i){t.parent.root=i,i?e.call(t):File.getMountFolder()&&t.parent.onLoadFolderFailed(!n)}):t.parent.onLoadFolderFailed(!0)),this.getRoot()?f("#file-library-tree").attr("data-state","rendering").html(""):f("#file-library-tree").html("")},findElemFromPath:function(e){return f(".file-tree-node[data-path='"+c.escapeSelector(e)+"']")},focusToFile:function(e){if(this.getRoot()&&e&&!0!==v){var t=File.getMountFolder(),n=(File.isWin,window.innerHeight,f(".sidebar-content"));n.scrollTop();e.indexOf(t)}},markOpenedFile:function(e){return this.parent.markOpenedFile(e).filter(".file-tree-node")},needRepaint:function(){v=!1},addFolderWatchByUnix:function(e){function t(e,t){i.parent.isSuppressOnChange()||(l&&clearTimeout(l),b.push([e,t]),l=setTimeout(n,200))}function n(){var e=b.clone();l=null,b=[];var t=[];i.parent.isSuppressOnChange()||e.forEach(function(e){i.onChangeForLinux(e[0],e[1],t)})}var i=this,r=reqnode("pathwatcher"),o=this.unixWatchers[e.path];o&&o.close();try{this.unixWatchers[e.path]=r.watch(e.path,function(n){t(n,e)})}catch(t){console.warn("Unable to watch path "+e.path)}},findNodeFromPath:function(e,t){function n(e,i){if(e){if(e.path==i)return e;t.push(e);for(var r=0;r<e.subdir.length;r++){var o=e.subdir[r];if(o.path==i)return o;if(0==i.indexOf(o.path+(File.isWin?"\\":"/")))return n(o,i)}return e.content.find(function(e){return e.path==i})}return null}if(e&&this.getRoot()){File.isWin;return t=t||[],n(this.getRoot(),e)}},expandNode:function(e,t,n){if(!0!==v){var i=[],o=this.findNodeFromPath(t,i),a=this;o&&(o.isOpen=!0,e.children(".file-node-children").children().length?e.removeClass("file-node-collapsed").addClass("file-node-expanded"):!o.fetched||o.subdir.length>0&&!o.subdir[0].fetched?r(o,a).then(function(t){t&&(e.replaceWith(a.renderNode(t)),f(".file-library-node.active").length||a.markOpenedFile(h.getCurrentFilePath()),n&&n())}):e.replaceWith(this.renderNode(o)),f(".file-library-node.active").length||this.markOpenedFile(h.getCurrentFilePath()),n&&n())}},onChangeForMac:function(e){function t(e){var t=p.findElemFromPath(e.path);t.length&&t.replaceWith(this.renderNode(e))}function n(e,n){e&&(e.isDirectory?n.subdir.remove(e):n.content.remove(e),n.subdir.length+n.content.length==0?(e.isOpen=!1,t.call(this,n)):p.findElemFromPath(e.path).remove())}function i(e,t,n){if(t.fetched&&!u.has(t)){var i;if(t.content.length+t.subdir.length==0&&u.add(t),n){if(t.subdir.findIndex(function(t){return t.path==e})>-1)return;(i=a({path:e}))&&t.subdir.push(i)}else{if(t.content.findIndex(function(t){return t.path==e})>-1)return;i={path:e,isDirectory:!1,name:e.split("/").last()},t.content.push(i)}d.add(t)}}function r(e,t){return c.naturalSort(e.name,t.name)}function o(e,t){var n=c.pathByDeleteLastComponent(e),r=p.findNodeFromPath(n);r&&i.call(p,e,r,t)}if(v){var s,l=[],d=new Set,u=new Set,p=this;if(e.forEach(function(e){if(s=this.findNodeFromPath(e.path,l),this.getRoot())if("removed"==e.type)e.path==this.getRoot().path?this.parent.root=null:s&&l.length&&n.call(this,s,l.last());else if("rename"==e.type){if(e.oldPath==this.getRoot().path)return void(this.parent.root=null);l=[],s=this.findNodeFromPath(e.oldPath,l),n.call(this,s,l.last()),o(e.newPath,e.isDir)}else"created"!=e.type||s||s==this.getRoot()||o(e.path,e.isDir)},this),this.getRoot()){u.forEach(function(e){(e=a(e))&&t.call(this,e)},this),d.forEach(function(e){e.subdir.sort(r),e.content.sort(r),t.call(this,e)},this);var f=h.getCurrentFilePath();this.parent.markOpenedFile(f),this.focusToFile(f)}else this.parent.onRootChanged()}},isPathTooDeepToDisplay:function(e,t){return t=t||[],this.findNodeFromPath(e,t),!t.length||!!e.substr(t.last().path.length).replace(/^[\\/]+/,"").match(/[\\/]/)},onChangeForWin:function(e,t,n,i){function r(e,t){t=t||[];var n=h.findNodeFromPath(e,t);if(n){var i=t.last();i.subdir.remove(n),i.content.remove(n),i.subdir.length+i.content.length==0?h.findElemFromPath(i.path).replaceWith(h.renderNode(i)):h.findElemFromPath(e).remove()}}function o(e,t){if(t=t||[],!i.find(function(t){return t==e||0==e.indexOf(t+u)})){i.push(e);var n=h.findNodeFromPath(e),r=l.dirname(e),o=h.findNodeFromPath(r);if((!n||!n.fetched)&&o&&o.fetched){var a=!o.isOpen,c=o.content.length+o.subdir.length==0;s({path:e},a,h).then(function(e){if(e){var t=e.isDirectory?o.subdir:o.content,n=t.findIndex(function(t){return e.path.localeCompare(t.path)<=0});if(n<0&&(n=t.length),t.splice(n,0,e),e.isDirectory||(n+=o.subdir.length),c)h.findElemFromPath(o.path).replaceWith(h.renderNode(o));else{var i=h.findElemFromPath(o.path).children(".file-node-children");(o.isOpen||i.children().length)&&i[0].insertChildAtIndex(h.renderNode(e)[0],n)}}})}}}if(v&&t&&!this.parent.isSuppressOnChange()){var a="string"==typeof t?t:t.OLD_NAME,l=(reqnode("fs"),reqnode("path")),c=l.join(n,a),d=(reqnode("util"),[]),u=File.isWin?"\\":"/",h=this;if(!this.isPathTooDeepToDisplay(c,d))if("REMOVED"!=e){if("ADDED"!=e)return"RENAMED"==e?(r(c,d),r(c.replace(/\$$/,""),d),void o(l.join(n,t.NEW_NAME))):void 0;o(c,d)}else r(c,d)}},onChangeForLinux:function(e,t,n){var i=this;n.find(function(e){return e==t.path||0==t.path.indexOf(e+"/")})||(n.push(t.path),"change"==e&&s(t,!1,this).then(function(e){if(e){var t=i.findElemFromPath(e.path);t.length&&t.replaceWith(i.renderNode(e)),i.parent.markCurrentFile()}}),"rename"==e&&t==i.getRoot()&&i.parent.onRootChanged(),"delete"==e&&t==i.getRoot()&&i.parent.onRootChanged())},newFile:function(e){this.newFileCommand(this.findElemFromPath(e),!1)},newFolderCommand:function(e){this.newFileCommand(e,!0)},newFileCommand:function(e,t){function n(e,t){var n=0;return t?(e.subdir.forEach(function(e){var t=/^untitled folder( (\d+))?$/i.exec(e.name);t&&(n=Math.max(n,(t[2]||0)-0+1))}),"Untitled Folder"+(n?" "+n:"")):(e.content.forEach(function(e){var t=/^untitled( (\d+))?\./i.exec(e.name);t&&(n=Math.max(n,(t[2]||0)-0+1))}),"Untitled"+(n?" "+n:"")+".md")}function i(){var e=this.findNodeFromPath(o);if(e){var i=n(e,t),r=File.isNode&&reqnode("fs");try{var a=this.findElemFromPath(o),l=o+(File.isWin?"\\":"/")+i,c={fetched:!0,subdir:[],content:[],isDirectory:!!t,name:i,path:l};if(t){if(File.isNode)r.mkdirSync(l);else if(!(u=g.library.newFolder(l)))return;s.parent.pauseOnChange(!0),e.subdir.push(c)}else{if(File.isNode){var d=r.openSync(l,"wx");r.close(d)}else{var u=g.library.newFile(l);if(!u)return}s.parent.pauseOnChange(!0),e.content.push(c)}a.replaceWith(this.renderNode(e)),this.focusToFile(c.path),this.renameFileCommand(this.findElemFromPath(c.path)[0])}catch(e){}}}var r=this.editor.getJQueryElem(e).closest(".file-library-node"),o=r.attr("data-path"),a="true"==r.attr("data-is-directory"),s=this;if(o)if(a||(o=c.pathByDeleteLastComponent(o)),a){s=this;this.expandNode(r,o,function(){i.call(s)})}else i.call(this)},renameFileCommand:function(e,t){function n(e){function t(e){m.dialog.showErrorBox(f.localize.getString("Rename Failed"),f.localize.getString('Failed to rename from "{0}" to "{1}"').format(s,n)+"\n"+e),a&&p.watchFileChange(File.filePath)}var n=e.val();d.parent.resumeOnChange(),n=File.isWin?n.replace(/[\\\/:*?"<>\|\000-\031]/g,"").trim():n.replace(/[\/\\\000-\031]/g,"");var i=c.pathByDeleteLastComponent(o)+(File.isWin?"\\":"/")+n;e.closest(".file-node-on-edit").removeClass("file-node-on-edit");var a=File.filePath&&(reqnode("fs-plus").isCaseInsensitive?0==File.filePath.toLowerCase().indexOf(o.toLowerCase()):0==File.filePath.indexOf(o)),l=m.getCurrentWindow().id,u=reqnode("fs");File.filePath,o.toLowerCase()!=i.toLowerCase()&&u.existsSync(i)?t(f.localize.getString("File with same name already exists at target path.")):(g.sendEvent("willRename",{oldPath:o,fromWin:l}),u.rename(o,i,function(e){if(r.removeClass("file-node-on-edit"),d.editor.restoreLastCursor(),e&&(i=o),g.sendEvent("didRename",{oldPath:o,newPath:i,fromWin:l}),e)t(e);else if(!File.filePath)return}))}function i(e){var t=e.val().replace(/[\/\\]/g,""),n=c.pathByDeleteLastComponent(o)+"/"+t;d.parent.pauseOnChange(!0),o!=n&&g.library.renameFile(o,n)?(r.children(".file-node-content").children(".file-node-title").text(t),o==h.getCurrentFilePath()&&setTimeout(function(){d.parent.markCurrentFile(!1,!0)},1e3)):e.val(s),r.removeClass("file-node-on-edit"),d.editor.restoreLastCursor()}f(".file-node-on-edit").removeClass("file-node-on-edit");var r=this.editor.getJQueryElem(e).closest(".file-library-node").addClass("file-node-on-edit"),o=r.attr("data-path"),a=(r.attr("data-is-directory"),r.children(".file-node-content").children(".file-tree-rename-div")),s=a.prev().text().trim(),l=a.children("input").val(s),d=this;this.parent.bindRename(l,function(e){File.isMac?i(e):n(e)},function(){l.closest(".file-node-on-edit").removeClass("file-node-on-edit")}),l.focus()},bindEvents:function(){function e(e,n){t.findNodeFromPath(n).isOpen=!1,e.addClass("file-node-collapsed").removeClass("file-node-expanded")}var t=this;f("#file-library-tree").on("click",".file-node-content",function(n){if(1===n.which){n.preventDefault(),n.stopPropagation(),document.activeElement.blur();var i=f(this).parent(),r=i.attr("data-path"),o=i.attr("data-is-directory");if(i.hasClass("file-node-on-edit"))return!1;"false"==o?(File.isMacOrMacNode?n.metaKey:n.ctrlKey)?t.parent.openFileInNewWindow(r):t.parent.openFile(r):"true"==i.attr("data-has-sub")&&(i.hasClass("file-node-expanded")?e(i,r):t.expandNode(i,r))}}).on("dragstart",".file-tree-node",function(e){})}}));n.exports=x}),define("app/editor/FileList",["app/document/StringUtils","exoskeleton-master/exoskeleton","jquery/jquery","app/document/Node","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/FileInfoPanel","app/editor/KeyMaster","app/editor/EditHelper"],function(e,t,n){"use strict";function i(e,t){var n=File.isWin?"\\":"/";if(t.find(function(t){return t==e||0==e.indexOf(t+n)}))return!0;t.push(e)}var r,o,a,s,l=e("app/document/StringUtils"),c=e("exoskeleton-master/exoskeleton"),d=e("app/document/Node"),u=d.Node,h=(d.TYPE,e("app/window/FileHelper")),l=(e("app/window/FileInfoPanel"),e("app/document/StringUtils")),p=(e("app/editor/KeyMaster").map,e("app/editor/EditHelper")),f=e("jquery/jquery"),m=window.reqnode?reqnode("electron").remote:null,g=m?m.app:window.app,v=f("#file-library-list-children"),y=f("#file-library-list"),b=[],w=function(e){return e.replace(/^\s*(([\n#>]+)|([-=*`\s]{3,}))/gm,"").replace(/\s*[*_`$=]+\s*/gm," ").replace(/\[([^\]]+)\]\([^)]*\)/gm,"$1")},x=function(e,t,n,i){for(var r=t+1;r<i;r++){if(e[r].indexOf(":")>=0)return n;n+="\n"+e[r]}return n},C=function(e,t){var n=t.indexOf(".");n<0&&(n=t.length),e.find(".file-list-item-file-name-part").text(t.substr(0,n)),e.find(".file-list-item-file-ext-part").text(t.substr(n))},k={Natural:0,Alphabet:1,Date:2},S=function(e,t){var n,i=e.split(/\r*\n+/),r=i.length;if("---"==i[0]){for(var o,a=[],s=1;s<r;s++){if("---"==i[s])return a.length<3&&a.push(w(i.slice(s+1).join("\n")||e)),a.join("\n");(n=/^\s*(title)\s*:(.+)$/.exec(i[s]))?(o=x(i,s,n[2],r))&&a.push(o.trim()):(n=/^\s*(subtitle)\s*:(.+)$/.exec(i[s]))?(o=x(i,s,n[2],r))&&a.push(o.trim()):(n=/^\s*(overview|summary|description|excerpt)\s*:(.+)$/.exec(i[s]))&&(o=x(i,s,n[2],r))&&a.push(o.trim())}return w(e)}return w(e)},T=h.statWrapper,E=400,F=c.Model.extend({initialize:function(e){this.parent=e,this.editor=e.editor,this.$template=f(document.querySelector("#file-list-item-template").textContent),this.expandFolders=function(e){return File.isMac?g.setting.getBool(e)||!1:!!File.isNode&&(g.setting.get(e)||!1)}("not_group_by_folders"),this.sortType=File.option.sortType,this.setGroupByFolder(this.expandFolders),this.setSortType(this.sortType),this.unixWatchers={},this.needRepaint(),File.isNode&&(E=Number.parseInt(g.setting.config.maxFetchCountOnFileList)||200,Number.isNaN(E)&&(E=200))},isShown:function(){return this.parent.isFileTabShown()&&!this.parent.useTreeStyle},isRendering:function(){return r},renderIfNeed:function(){return!r&&(this.render(),File.isWin&&this.parent.addFolderWatchByWin(File.getMountFolder()),!0)},appendTreeByNode:function(e,t,n,i){var o=reqnode("fs-plus"),a=reqnode("path"),s=(reqnode("util"),this);n=n||0,t=t||function(){};var l=!!i;i=i||y;var c=function(e,t,l,d){if(!e)return d();o.readdir(e,function(o,u){if(o)return d(void 0,o);!File.isWin&&s.addFileWatchByUnix(e,!0);var h=u.length;h||d();var p=function(){--h<=0&&d()};u.forEach(function(o){var d=a.join(e,o);T(d,function(a){if(r){if(!a||a.shouldIgnore)return p();50==n&&!0===r&&"rendering"!=i.attr("data-state")&&i.attr("data-state","rendering"),n>E?s.endRender(!0):a.isFile?t(a,o,e,d,p)&&n++:a.isDir&&l(a,o,e,d)?c(d,t,l,p):p()}})})})};c(e,function(e,t,n,r,o){if(!e.shouldIgnore){var a={folderPath:n,folderName:h.getFileNameFromPath(n),name:t,path:r,lastModified:e.mtime};return s.fetchSummaryByNode(r,function(e){a.summary=e,s.appendItemToView(a,!1,l?i[0]:void 0),!File.isWin&&s.addFileWatchByUnix(a.path,!1,a),o()}),!0}o()},function(e,t,n,i){return!e.shouldIgnore},t)},fecthAllDocsByNode:function(){this.appendTreeByNode(this.parent.calcMountFolder(!0),this.endRender.bind(this))},fetchSummaryByNode:function(e,t){var n;reqnode("fs-plus").createReadStream(e,{start:0,end:600}).on("data",function(e){if("string"==typeof e)n=e;else{var t=h.detectEncodeByNode(e),i=h.getContentFromBuffer(e,t);n=i}}).on("end",function(){void 0===n&&(n=""),t(n)})},render:function(e){if(e&&this.needRepaint(),!r){r=!0,o=new Date,a=!1;var t=this;setTimeout(function(){!0===r&&"rendering"!=y.attr("data-state")&&y.attr("data-state","rendering")},500),v.html("").removeClass("show-folder-name"),File.isMac?g.library.fetchAllDocs(this.parent.calcMountFolder(!0)||""):File.isNode&&this.fecthAllDocsByNode(),setTimeout(function(){!0===r&&new Date-o>4e4&&(console.error("render file list timeout"),t.endRender(!0))},6e4)}},endRender:function(e,t,n){if(r=e?"oversize":"complete",f("#file-library-list").attr("data-state",r),setTimeout(function(){"oversize"==r&&f("#file-library-list").attr("data-state","oversize-end")},2e3),!e){if(t&&File.getMountFolder())return void this.parent.onLoadFolderFailed();this.parent.markCurrentFile(!1,!0)}},setSortType:function(e){if(f(".ty-side-sort-btn2").removeClass("active"),e==k.Alphabet?f("#ty-sort-by-name-btn").addClass("active"):e==k.Date?f("#ty-sort-by-date-btn").addClass("active"):f("#ty-sort-by-natural-btn").addClass("active"),this.sortType!=e){this.sortType=e,g&&g.setting.put("file_sort_type",e),v.html("");var t=document.createDocumentFragment();this.expandFolders?(this.files.sort(this.compareItem_.bind(this)),this.files.forEach(function(e){this.appendItemToView(e,!1,t)},this)):this.dirArr.forEach(function(e){var n=e.content;e.content=[],n.forEach(function(e){this.appendItemToView(e,!1,t)},this)},this),v.append(t)}},setGroupByFolder:function(e){if(e?f("#ty-group-by-folder-btn").removeClass("active"):f("#ty-group-by-folder-btn").addClass("active"),this.expandFolders!=e){this.expandFolders=e,g&&g.setting.put("not_group_by_folders",e),v.html("");var t=document.createDocumentFragment();e?(this.files=[],this.dirArr.forEach(function(e){this.files=this.files.concat(e.content)},this),this.dirArr=[],this.dirMap={},this.files.sort(this.compareItem_.bind(this)),this.files.forEach(function(e){this.appendItemToView(e,!1,t)},this)):(this.dirArr=[],this.dirMap={},this.files.forEach(function(e){this.appendItemToView(e,!1,t)},this),this.files=[]),v.append(t),"oversize"==r?this.endRender(!0):"complete"==r&&this.endRender(!1)}},compareItem_:function(e,t){return this.sortType==k.Alphabet?e.name.localeCompare(t.name):this.sortType==k.Date?t.lastModified-e.lastModified:l.naturalSort(e.name,t.name)},getItem:function(e){if(this.expandFolders)for(var t=this.files.length,n=0;n<t;n++){if(this.files[n].path==e)return this.files[n];if(this.files[n].folderPath==e)return{path:e,isDir:!0}}else{if(this.dirMap[e])return{path:e,isDir:!0};var i=l.pathByDeleteLastComponent(e);if(this.dirMap[i])return this.dirMap[i].content.find(function(t){return t.path==e})}},computeIndex:function(e){return(this.expandFolders?function(e){for(var t=0,n=0;n<this.files.length&&!(this.compareItem_(this.files[n],e)>0);n++)t++;return this.files.splice(t,0,e),t}:function(e){var t=e.folderPath,n=this.dirMap[t],i=0,r=0;n||(n={path:t,content:[]},this.dirArr.push(n),this.dirMap[t]=n);for(a=0;a<this.dirArr.length-1;a++){var o=this.dirArr[a];if(o.path==t)break;i+=o.content.length}for(var a=0;a<n.content.length&&!(this.compareItem_(n.content[a],e)>0);a++)r++;return n.content.splice(r,0,e),r+i}).call(this,e)},appendItemToView:function(e,t,n,i){if("oversize"!=r&&r){var o=i||{},s=o.forceMark,c=o.skipAnim,d=this.$template.clone();this.parent.calcMountFolder(!0);if(e&&e.path){a||File.getMountFolder()!=e.folderPath&&(a=!0,v.addClass("show-folder-name")),d.attr("data-path",e.path),d.attr("data-parent-path",e.folderPath),d.children(".file-list-item-parent-loc").text(e.folderName),d.children(".file-list-item-time").text(l.date2NatrualLang(new Date(e.lastModified),!0)),C(d,e.name);var u=d.children(".file-list-item-summary");u.text(S(e.summary,e.name)),u.html(u.html().replace(/([^\s]+)\s*\n+/g,"$1<br/>")),e.path==h.getCurrentFilePath()&&d.addClass("active");var p;if(n)this.expandFolders?n.appendChild(d[0]):(p=this.computeIndex(e),n.insertChildAtIndex(d[0],p));else{if(t){var f,m,g=this.removeItemFromView(e,!0),y=g.hasClass("active");if(g&&g.length)return m=g.prevAll().length,p=this.computeIndex(e),m!=p||e.oldPath?(e.oldPath=void 0,f=g[0].clientHeight,g.remove(),v[0].insertChildAtIndex(d[0],p),(y||s)&&d.addClass("active"),c||v.children().each(function(e){var t=this;if(t==d[0])t.style.transition="transform 0s",t.style.transform="translate(0px, "+f*(m-e)+"px)";else if(e>=p&&e<m)t.style.transition="transform 0s",t.style.transform="translate(0px, -"+f+"px)";else{if(!(e>=m&&e<p))return;t.style.transform="translate(0px, "+f+"px)"}requestAnimationFrame(function(){t.style.transform="",t.style.transition="transform 400ms"})}),h.getCurrentFilePath()==e.path&&this.parent.markCurrentFile(),d[0]):g.find("input").length?g[0]:(g.replaceWith(d),d[0])}p=this.computeIndex(e),v[0].insertChildAtIndex(d[0],p)}return d[0]}}},removeFileOrFolder:function(e,t){function n(e){var n=i.findElemFromPath(e);n.length&&(t?n.remove():n.hide("slow",function(){n.remove()}))}var i=this,r=File.isWin?"\\":"/";i.expandFolders?function(e){var t=0;i.files.removeIf(function(i){if(i.path==e||0==i.path.indexOf(e+r))return t++,n(i.path,t>10),!0})}(e):i.findElemFromPath(e).length?i.removeItemFromView({path:e},!1,t):function(e){var t=0;i.dirArr.removeIf(function(n){return t++,n.path==e||0==n.path.indexOf(e+r)}),0!=t&&Object.keys(i.dirMap).clone().forEach(function(o){o!=e&&0!=o.indexOf(e+r)||(i.dirMap[o].content.forEach(function(e){n(e.path,t>10)}),delete i.dirMap[o])})}(e)},removeItemFromView:function(e,t,n){function i(e,t){~e.indexOf(t)?e.remove(t):e.removeIf(function(e){return e.path.toLowerCase()==(t.oldPath||t.path).toLowerCase()},!0)}var r=this.findElemFromPath(e.oldPath||e.path);if(e.folderPath||(e.folderPath=r.attr("data-parent-path")),!r.length)return f();if(this.expandFolders)i(this.files,e);else{var o=this.dirMap[e.folderPath];o&&i(o.content,e)}if(!t){r.nextAll(),r[0].offsetHeight;n?r.remove():r.hide("slow",function(){r.remove()})}return r},appendItemToViewByMac:function(e,t,n){this.appendItemToView(JSON.parse(e),t,void 0,{forceMark:n})},bindEvents:function(){function e(){t.editor.dropTargetDom=null,document.querySelector("#sidebar-content").classList.remove("on-drop")}var t=this;v.on("mousedown",".file-list-item",function(e){if("INPUT"==document.activeElement.tagName&&f(document.activeElement).trigger("blur"),1==event.which)return event.ctrlKey||event.metaKey?t.parent.openFileInNewWindowCommand(this):(f(".file-list-item:focus").blur(),t.parent.openFile(this.getAttribute("data-path"))),!1}),f("#switch-to-tree-on-oversize").on("click",function(e){t.parent.switch("file-tree")});var n=!1;f("#file-library").on("dragenter",function(e){if(!t.parent.useTreeStyle){var i=e.originalEvent.dataTransfer.files[0];n=!1,File.isMac?(window.focus(),n=(e.originalEvent.dataTransfer.types||[]).indexOf("Files")>-1):i&&File.getMountFolder()&&(n=h.isSupportedFile(i.path)),n&&(t.editor.dropTargetDom=this,document.querySelector("#sidebar-content").classList.add("on-drop"))}}).on("dragend mouseleave dragfileLeave",function(t){e()}).on("dragfile",function(t){t.stopPropagation(),e();var n=t.originalEvent.data.folders,i=t.originalEvent.data.urls;!File.getMountFolder()||1==n.length&&0==i.length?n[0]&&g.controller.switchFolder(n[0]):g.controller.moveFilesToLibrary(i)?t.stopPropagation():t.originalEvent.data.resultFromFront="cancel"}).on("dragover",function(e){e.preventDefault(),e.stopPropagation()}).on("drop",function(i){function r(e){return u.join(File.getMountFolder(),u.basename(e))}function o(e){var n=r(e);d.move(e,n,function(e){e||m||(m=!0,t.parent.openFile(n))})}if(!File.isNode||!n||!File.getMountFolder())return e();i.stopPropagation(),i.preventDefault();var a,s,l=i.originalEvent.dataTransfer.files,c=i.originalEvent.dataTransfer.items,d=reqnode("fs-extra"),u=reqnode("path"),m=File.fileHasModified&&File.changeCounter.isDocumentEdited();if(0==l.length)return e();if(0!=l[0].path.toLowerCase().indexOf(File.getMountFolder())){for(var g=0;g<l.length;g++){var v=l[g],y=c[g];if(v.path,y.webkitGetAsEntry().isFile)if(!a&&d.existsSync(r(v.path))){if(s)continue;var b=p.getDialog("Save",f.localize.getString("Should continue moving and overwrite exisiting file(s) ?"),!0,"two-way-dialog","Continue & Overwrite");b.modal({backdrop:!1,keyboard:!0}),b.find(".btn-primary").one("click",function(){a=!0,o(v.path),b.modal("hide")}),b.one("hidden.bs.modal",function(){s=!0})}else o(v.path)}e()}else c[0].webkitGetAsEntry().isDirectory||h.isSupportedFile(l[0].path)&&t.parent.openFile(l[0].path)})},needRepaint:function(e){(e||!0!==r)&&(r=!1,this.dirArr=[],this.dirMap={},this.files=[])},findElemFromPath:function(e){return f(".file-list-item[data-path='"+l.escapeSelector(e)+"']")},onChangeForMac:function(e){if("complete"==r&&!this.parent.isSuppressOnChange()){for(var t=[],n=0;n<e.length;n++){var o=e[n];if(u.isType(o.type,"created","modified")&&i(o.path,t))return;if("rename"==o.type){if(o.isDir){this.needRepaint();break}var a=h.getCurrentFilePath()==o.oldPath;this.removeFileOrFolder(o.oldPath),g.library.updateListItem(o.newPath,a)}else"removed"==o.type&&this.removeFileOrFolder(o.path);if(o.isDir&&"modified"!=o.type){this.needRepaint();break}"created"==o.type?g.library.updateListItem(o.path):"modified"!=o.type||o.isDir||("oversize"!=r||g.library.isOpened(o.path))&&g.library.updateListItem(o.path)}!r&&this.isShown()&&this.render()}},onChangeForWin:function(e,t,n,o){function a(e){File.getMountFolder()&&0==e.indexOf(File.getMountFolder())&&T(e,function(t){if(t&&!t.shouldIgnore)if(t.isFile){var n=l.pathByDeleteLastComponent(e),i={folderPath:n,folderName:h.getFileNameFromPath(n),name:h.getFileNameFromPath(e),path:e};d.fetchSummaryByNode(e,function(e){i.summary=e,i.lastModified=t.mtime,d.appendItemToView(i,!0)})}else t.isDir&&d.appendTreeByNode(e)})}if("complete"==r&&!this.parent.isSuppressOnChange()&&t){var s="string"==typeof t?t:t.OLD_NAME,c=(reqnode("fs"),reqnode("path").join(n,s)),d=(reqnode("util"),File.isWin,this);if("ADDED"!=e)if("REMOVED"!=e){if("RENAMED"==e)return d.removeFileOrFolder(c),d.removeFileOrFolder(c.replace(/\$$/,"")),void a(reqnode("path").join(n,t.NEW_NAME));if("MODIFIED"!=e);else{if(i(c,o))return;if(0==d.findElemFromPath(c).length)return;T(c,function(e){if(e&&!e.shouldIgnore&&e.isFile){var t=d.getItem(c);d.fetchSummaryByNode(c,function(n){t.summary=n,t.lastModified=e.mtime,d.appendItemToView(t,!0)})}})}}else d.removeFileOrFolder(c);else{if(i(c,o))return;a(c)}}},addFileWatchByUnix:function(e,t){function n(e,t,n,i){if(!i.find(function(e){return e==t||0==t.indexOf(e+c)}))if(i.push(t),"rename"!=e&&"delete"!=e||t!=File.getMountFolder()){if("change"==e)if(n){var r=File.getMountFolder()==t,o=f("#file-library").scrollTop();y.clone();a.removeFileOrFolder(t,r),a.appendTreeByNode(t,function(){r&&f("#file-library").scrollTop(o)})}else{var s=a.getItem(t);if(!s)return;h.statWrapper(t,function(e){e&&!e.shouldIgnore&&a.fetchSummaryByNode(t,function(t){s.summary=t,s.lastModified=e.mtime,a.appendItemToView(s,!0)})})}else if("delete"==e)a.removeFileOrFolder(t);else if("rename"==e)return}else a.parent.onRootChanged()}function i(e,t,n){a.parent.isSuppressOnChange()||(s&&clearTimeout(s),b.push([e,t,n]),s=setTimeout(o,200))}function o(){var e=b.clone();s=null,b=[];var t=[];if(!a.parent.isSuppressOnChange()){for(var i=[],r=[],o=!1,l=0;l<e.length;l++){var c=e[l],d=c[1];if(c[2]){if("change"!=c[0]){o=!1;break}-1==r.indexOf(d)&&r.push(d)}else if(-1==i.indexOf(d))o=c[0],i.push(d);else if(o!=c[0]){o=!1;break}}o&&1==i.length&&1==r.length&&0==i[0].indexOf(r[0])&&("delete"==o?e.length<=2&&(e=[[o,i[0],!1]]):"change"==o&&(e=[[o,i[0],!1]])),e.forEach(function(e){n(e[0],e[1],e[2],t)})}}if(!File.isMac&&!File.isWin&&"oversize"!=r){var a=this,l=reqnode("pathwatcher"),c=(reqnode("fs-plus"),reqnode("util"),"/"),d=this.unixWatchers[e];try{d&&d.close(),this.unixWatchers[e]=l.watch(e,function(n){i(n,e,t)})}catch(e){console.warn(e)}}},update:function(e,t){if(void 0!==t){var n=this.parent.findElemFromPath(e).children(".file-list-item-summary");n.text(S(t.substr(0,500))),n.html(n.html().replace(/([^\s]+)\s*\n+/g,"$1<br/>"))}},focusToFile:function(e,t){var n=this.findElemFromPath(e)[0];if(n){var i=n?n.offsetTop:0,r=n.clientHeight,o=n?{scrollTop:Math.max(0,i-r)}:null,a=f(File.isMac?".sidebar-content":"#file-library"),s=a.parent().height();!o||a.scrollTop()<i+40&&s+a.scrollTop()>i+40||(t?a.scrollTop(o.scrollTop):a.animate(o,500))}},newFile:function(){function e(e,n){var i=this.appendItemToView({folderPath:File.getMountFolder(),folderName:h.getFileNameFromPath(File.getMountFolder()),name:n,path:e,lastModified:new Date,summary:""},!0);t.renameFileCommand(i,!0)}var t=this;if(File.getMountFolder())if(a)File.isMac?g.library.newFileUnder(File.getMountFolder()):m.dialog.showSaveDialog(File.isLinux?null:m.getCurrentWindow(),{title:"New",defaultPath:File.getMountFolder()+"/Untitled.md",buttonLabel:"Create",filters:[{name:"Markdown",extensions:["md","markdown","mmd","mdown","txt","text"]}]},function(e){e&&reqnode("fs").writeFile(e,"",function(){t.parent.openFile(e)})});else{var n=function(e){var t=0;return f(".file-list-item[data-parent-path='"+JSON.stringify(e).replace(/(^")|("$)/g,"")+"']").each(function(){var e=/^untitled( (\d+))?\./i.exec(this.querySelector(".file-list-item-file-name").textContent.trim());e&&(t=Math.max(t,(e[2]||0)-0+1))}),"Untitled"+(t?" "+t:"")+".md"}(File.getMountFolder()),i=File.getMountFolder()+(File.isWin?"\\":"/")+n;if(this.parent.pauseOnChange(!0),File.isMac)this.parent.pauseOnChange(!0),g.library.newFile(i)?e.call(this,i,n):(this.parent.resumeOnChange(),g.library.newFileUnder(File.getMountFolder()));else{var r=reqnode("fs");i=reqnode("path").resolve(i);var o=r.openSync(i,"wx");r.close(o),this.parent.pauseOnChange(!0),e.call(this,i,n)}}},newFileCommand:function(e){this.newFile()},renameFileCommand:function(e,t){function n(e){return e.length?e[0].innerText||e[0].textContent:""}function i(t,i){if(C(d,t),s.replaceWith(d),u!=i){var r=f(e);a.appendItemToView({path:i,folderPath:e.getAttribute("data-parent-path"),folderName:f(e).children(".file-list-item-parent-loc").text(),lastModified:new Date,name:t,summary:n(r.children(".file-list-item-summary")),oldPath:u},!0)}a.editor.restoreLastCursor()}function r(e){function t(e){i(p,u),m.dialog.showErrorBox(f.localize.getString("Rename Failed"),f.localize.getString('Failed to rename from "{0}" to "{1}"').format(p,n)+"\n"+e)}var n=e.val();n=File.isWin?n.replace(/[\\\/:*?"<>\|\000-\031]/g,"").trim():n.replace(/[\/\\\000-\031]/g,"");var r=reqnode("path").resolve(l.pathByDeleteLastComponent(u)+(File.isWin?"\\":"/")+n),o=m.getCurrentWindow().id,s=reqnode("fs");u!=r?u.toLowerCase()!=r.toLowerCase()&&s.existsSync(r)?t(f.localize.getString("File with same name already exists at target path.")):(a.parent.pauseOnChange(!0),g.sendEvent("willRename",{oldPath:u,fromWin:o}),s.rename(u,r,function(e){g.sendEvent("didRename",{oldPath:u,newPath:e?u:r,fromWin:o}),e?t(e):i(n,r)})):i(p,u)}function o(e){var t=e.val().replace(/[\/\\]/g,""),n=l.pathByDeleteLastComponent(u)+"/"+t;a.parent.pauseOnChange(!0),u!=n&&g.library.renameFile(u,n)?(i(t,n),u==h.getCurrentFilePath()&&setTimeout(function(){a.parent.markCurrentFile(!1,!0)},1e3)):i(p,u)}e=f(e).closest(".file-library-node")[0],File.isMac&&g.window.focus();var a=this,s=f("<input class='file-list-item-file-name' />"),c=f(e).find(".file-list-item-file-name"),d=c.clone(),u=e.getAttribute("data-path"),p=c.children().text();c.replaceWith(s),s.val(p),this.parent.bindRename(s,function(e){return File.isMac?o(e):r(e)},function(){i(p,u)},t),s.focus()}});n.exports=F}),define("app/window/ClientCommand",["app/document/File","exoskeleton-master/exoskeleton","jquery/jquery","app/editor/UndoManager","app/document/StringUtils","app/document/Node","app/editor/polyfill","app/window/FileHelper","app/editor/EditHelper","app/editor/KeyMaster","app/window/MenuHelper","app/window/FileInfoPanel","app/window/steno2","app/window/MenuHelper","app/window/FileHelper","app/window/PDFBridge","app/window/PandocBridge"],function(e,t,n){"use strict";var i=e("app/document/File"),r=e("jquery/jquery"),o=e("app/window/MenuHelper");if(i.isNodeHtml){if(i.isNode)var a=reqnode("electron").remote,s=a.app,l=a.getCurrentWindow(),c=a.BrowserWindow;var d={},u=e("app/window/FileHelper"),h=e("app/window/PDFBridge"),p=e("app/editor/EditHelper"),f=e("app/window/PandocBridge");d.newFile=function(){i.megaMenu.hide(),s.openFile()},d.close=function(){i.megaMenu.hide(),l.close()},d.quit=function(){s.getAllWindows().map(function(e){e.close()})},d.openWithPath=function(e){var t=s.getDocumentController().getDocument(e);t?(t.activeWindow||t.windows.keys().next().value).focus():i.fileHasModified||i.filePath?s.openFileOrFolder(e,{curWindow:l}):reqnode("fs-plus").isDirectorySync(e)?s.switchFolder(e,l):m(e)};var m=function(e){s.getDocumentController().getDocument(e)||(s.getDocumentController().getDocumentFromWindowId(l.id).rename(e),i.reloadContent(i.getContent(),!0),i.updateChangeCount(i.ChangeType.NSChangeCleared))};d.open=function(){a.dialog.showOpenDialog(l,{properties:["openFile"],filters:[{name:r.localize.getString("Markdown File"),extensions:["md","markdown","text","txt","mmd","mdown",""]},{name:r.localize.getString("All Files"),extensions:["*"]}]},function(e){e&&e.length&&(d.openWithPath(e[0]),i.megaMenu.hide())})},d.openFolder=function(){a.dialog.showOpenDialog(l,{properties:["openDirectory"]},function(e){e&&e.length&&(d.openWithPath(e[0]),i.megaMenu.hide())})},d.import=function(){i.megaMenu.hide(),f.prepImport()},d.validatePandocInstall=function(){return f.validatePandocInstall()},d.doImport=function(e){f.import(e)},d.openFileLocation=function(){i.filePath&&a.shell.showItemInFolder(i.filePath)},d.showPreferencePanel=function(){document.body.classList.contains("native-window")?r("#preference-dialog:visible").length||(i.megaMenu.prepPreferencePanel(),r(".modal").modal("hide"),r("#preference-dialog").modal("show"),r("*:focus").blur()):r(".megamenu-opened #megamenu-section-preference:not(.hide)").length?i.megaMenu.hide():(i.megaMenu.show(),r("#m-preference").trigger("click"))},d.save=function(){i.saveUseNode(!1)},d.saveAs=function(){i.saveUseNode(!1,!0)};var g=function(){v.webContents.print()};window.releasePrintWin_=function(){v&&(v.destroy(),v=null)},d.print=function(){y().webContents.on("did-finish-load",function(){setTimeout(g,300)}),document.body.classList.contains("megamenu-opened")&&i.megaMenu.hide()},d.exportHTML=function(){i.editor.store(!0),u.showExportDialog("html",i.editor.export.exportToHTML(),null,null,!0),i.megaMenu.hide()},d.exportHTMLPlain=function(){i.editor.store(!0),u.showExportDialog("html",i.editor.export.exportToHTML(!1,!0),null,null,!0),i.megaMenu.hide()},d.exportImage=function(){i.editor.export.exportToImage(),i.megaMenu.hide()},d.exportDocx=function(){f.export("docx")},d.exportOdt=function(){f.export("odt")},d.exportRTF=function(){f.export("rtf")},d.exportEpub=function(){f.export("epub")},d.exportLaTeX=function(){f.export("latex")},d.exportWiki=function(){f.export("wiki")},d.exportRST=function(){f.export("rst")},d.exportOPML=function(){f.export("opml")},d.exportTextile=function(){f.export("textile")};var v,y=function(){var e=i.editor.export.exportToHTML(!0),t=a.app.setting.config;if(v&&(v.destroy(),v=null),v=new c({skipTaskbar:!0,title:"Print PDF Preview",show:!1,webPreferences:{webSecurity:!1,allowDisplayingInsecureContent:!0,allowRunningInsecureContent:!0,nodeIntegration:!1,directWrite:t.directWrite,defaultFontFamily:t.defaultFontFamily,zoomFactor:s.setting.get("zoomFactor")}}),i.megaMenu.hide(),e.length<1e5)v.loadURL("data:text/html;charset=UTF-8,  "+encodeURIComponent(e));else{var n=reqnode("path").join(s.getPath("temp"),new Date-0+"tmp.html");reqnode("fs-extra").outputFileSync(n,e),v.loadURL("file:///"+n)}return v},b=null;d.exportPDF=function(){function e(e){e&&alert(r.localize.getString("Export Failed","Panel"),e),v&&v.destroy(),v=null,b=null,e||r("#md-notification").hide()}i.colorBrightness<.5&&1!==a.dialog.showMessageBox(l,{type:"warning",title:r.localize.getString("Dark Theme not support","Panel"),message:r.localize.getString('Sorry, current version of Typora won\'t print background color on exported PDF, So dark theme is not yet supported for PDF exproting. \nPlease choose a light theme or click "Print with default theme"',"Panel"),buttons:[r.localize.getString("Cancel"),r.localize.getString("Print with default theme","Panel")],cancelId:0})||(i.sync(),b=h.startPDFJob(y()),setTimeout(function(){b&&r("#md-notification").html(["<p>"+r.localize.getString("Exporting in progress...","Panel"),'\n<div class="typora-search-spinner" style="margin-right:16px;top:8px">','<div class="rect1"></div>','<div class="rect2"></div>','<div class="rect3"></div>','<div class="rect4"></div>','<div class="rect5"></div>',"</div></p>"].join("")).show()},2e3),u.showExportDialog("pdf",function(t){t?b.then(function(n){i.fs.writeFile(t,n,function(n){n?e(n):(r("#md-notification .typora-pdf-warning").length||p.showNotification(r.localize.getString("Export to PDF successfully.","Panel")),a.shell.showItemInFolder(t))})},e):e()},void 0,void 0,!0))},d.selectAll=function(){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName){if(i.editor.sourceView.inSourceMode)return i.editor.sourceView.cm.focus(),void i.editor.sourceView.cm.execCommand("selectAll");r(document.activeElement).closest("#write").length||r("#write").focus(),i.editor.selection.selectAll(),i.editor.brush.expand()}else i.isNode&&l.webContents.selectAll()},d.deleteWord=function(){i.isLocked||(i.editor.selection.selectWord(),i.editor.UserOp.backspaceHandler(i.editor,null,"delSelection"))},d.deleteScope=function(){i.isLocked||(i.editor.selection.selectPhrase(),i.editor.UserOp.backspaceHandler(i.editor,null,"delSelection"))},d.deleteLine=function(){i.isLocked||i.editor.UserOp.deleteLine(i.editor)},d.undo=function(){i.isLocked||(editor.undo.completeSnap(!0),i.editor.undo.undo(),i.freshMenu())},d.redo=function(){i.isLocked||(editor.undo.completeSnap(!0),i.editor.undo.redo(),i.freshMenu())},d.toggleOutline=function(){i.editor.library.togglePanel("outline"),d.refreshViewMenu()},d.toggleFileList=function(){i.editor.library.togglePanel("file-list"),d.refreshViewMenu()},d.toggleFileTree=function(){i.editor.library.togglePanel("file-tree"),d.refreshViewMenu()},d.pinWindow=function(){l.setAlwaysOnTop(!0),document.body.classList.add("always-on-top"),d.refreshViewMenu()},d.execForAll=function(e){var t=e.toString(),n=arguments;t=t.replace(/\$(\d+)/gi,function(e,t){return t-0<n.length?n[t]:e}),reqnode("electron").ipcRenderer.send("execForAll",t)},d.unpinWindow=function(){l.setAlwaysOnTop(!1),document.body.classList.remove("always-on-top"),d.refreshViewMenu()},d.refreshViewMenu=function(){var e=a.Menu.getApplicationMenu().items[4].submenu;o.refreshViewMenu(e);var t=e.getItem("Show Status Bar"),n=e.getItem("Actual Size");t.checked=!1,document.body.classList.contains("show-footer")&&(t.checked=!0),n.checked=!s.setting.get("customZoom")};var w=function(e){"string"==typeof e&&(i._CopyContentFlag=e),l.webContents.copy()},x=function(e){"string"==typeof e&&(i._PasteContentFlag=e),l.webContents.paste()};d.cut=function(){l.webContents.cut()},d.copy=function(){w()},d.copyAsMarkdown=function(){w("copyAsMarkdown")},d.copyAsHTMLSource=function(){w("copyAsHTMLSource")},d.paste=function(){x(!1)},d.pasteAsPlain=function(){x("pasteAsPlain")},d.setTheme=function(e,t){console.log("set theme: "+e),a.Menu.getApplicationMenu().getItem("Themes").submenu.items.map(function(e){e.checked=e.label==t}),s.setting.put("theme",e),d.execForAll("function(){            File.setTheme();        }")},d.resetZoom=function(){s.setting.put("customZoom",!1),i.resetZoom()},d.zoomIn=function(){s.setting.put("customZoom",!0);var e=reqnode("electron").webFrame,t=e.getZoomLevel()+1;e.setZoomLevel(t),s.setting.put("zoomLevel",t),s.setting.put("zoomFactor",e.getZoomFactor())},d.zoomOut=function(){s.setting.put("customZoom",!0);var e=reqnode("electron").webFrame,t=e.getZoomLevel()-1;e.setZoomLevel(t),s.setting.put("zoomLevel",t),s.setting.put("zoomFactor",e.getZoomFactor())},n.exports=d,window.ClientCommand=d}}),define("app/window/PDFBridge",["app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster","app/window/FileHelper"],function(e,t,n){"use strict";function i(e,t,n,i){function r(e){console.error("failed to add book to exported PDF\n"+e.stack||e.details),$("#md-notification").html("<p class='typora-pdf-warning'>"+$.localize.getString("[Warning] Failed to attach bookmark for PDF file.","Panel")+"<span class='btn close-btn btn-xs'><span class='glyphicon glyphicon-remove'></span></span></p>").show(),n(s)}var s=Buffer.from(t);e?i(e):e?i(e):(PDFJS.disableWorker=!0,PDFJS.getDocument(t).then(o,function(e){i(e)}).then(function(e){try{var i=new FileReader;i.onloadend=function(){n(new Buffer(new Uint8Array(i.result)))},i.onerror=i.onabort=r,i.readAsArrayBuffer(a(e,t))}catch(e){r(e)}},r))}if(File.isNode){var r=reqnode("electron").remote;r.app,r.getCurrentWindow(),r.BrowserWindow,r.dialog,e("app/document/StringUtils"),e("app/editor/EditHelper"),e("app/window/FileHelper");e.async(window.debugMode?["pdf/pdf-designer.min.js","pdf/pdf.js"]:["lib.asar/pdf/pdf-designer.min.js","lib.asar/pdf/pdf.min.js"]);var o=function(e){return new Promise(function(t,n){function i(e){n(e)}var r=e.numPages,o={},a=0,s=0;0==r&&n("Genrated PDF only have 0 page");for(var l=0;l<r;l++)e.getPage(l+1).then(function(e){e.getAnnotations().then(function(n){s||(s=e.getViewport(1).height),a++,n.forEach(function(t){if(t.subtype="Link"){var n;(n=/^af:\/\/(.+)$/.exec(t.url||""))&&(o[n[1]]=[e.pageIndex+1,s-t.rect[3]])}}),a>=r&&t(o)},i)},i)})},a=function(e,t){function n(t,i,a,s){for(var l=7,c=null,d=a;d<s;d++){var u,h=o[d],p=h[0];if(7==l&&(l=p),p<=i)return d;if(p>l)d=n(c,l,d,s)-1;else{if(!(u=e[h[2]]))continue;c=t?t.AddChild(h[1],u[0],u[1],"",!1,!1,null):r.OutLine.AddRoot(h[1],u[0],u[1],"",!1,!1,null)}}return s}var i=new TPDFAnalyst,r=new TPDFOutLineMaker,o=File.editor.docMenu.getHeaderMatrix(!0);return i.LoadFromStream(t),r.Info.Title=File.editor.docMenu.getValueInMeta("title")||"",r.Info.Subject=File.editor.docMenu.getValueInMeta("subject")||"",r.Info.Author=File.editor.docMenu.getValueInMeta("author")||"",r.Info.Keywords=File.editor.docMenu.getValueInMeta("keywords")||"",r.Info.Creator=File.editor.docMenu.getValueInMeta("creator")||"Typora",r.Info.Producer=File.editor.docMenu.getValueInMeta("producer")||"Typora",r.Info.CreationDate=PDF_GetDateTime_Now(),r.Info.ModDate=PDF_GetDateTime_Now(),r.View.PageMode=TPDFPageMode.pmUseOutlines,n(null,0,0,o.length),r.Save(i)};t.startPDFJob=function(e){return new Promise(function(t,n){new Promise(function(t,n){e.webContents.once("did-finish-load",function(){t()}),setTimeout(function(){e.webContents.stop(),t()},1e4)}).then(function(){setTimeout(function(){e.webContents.printToPDF({printBackground:!1,marginsType:0},function(e,r){i(e,r,t,n)})},200)},n)})},t.startPDFJobFromWebket=function(){return new Promise(function(e,t){var n=File.editor.export.exportToHTML(!0);reqnode("html-pdf").create(n,{type:"pdf",format:"A4",border:{top:"2cm",bottom:"2cm"},phantomArgs:["--ignore-ssl-errors=true","--local-to-remote-url-access=true","--web-security=false"]}).toBuffer(function(n,r){i(n,r,e,t)})})}}}),define("app/window/PandocBridge",["app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster","app/window/FileHelper","app/window/FileInfoPanel","app/window/FileHelper"],function(e,t,n){"use strict";if(File.isNode){var i,r=reqnode("child_process").spawn,o=reqnode("electron").remote,a=o.app,s=o.getCurrentWindow(),l=(o.BrowserWindow,o.dialog),c=e("app/document/StringUtils"),d=e("app/editor/EditHelper"),u=e("app/window/FileHelper"),h=e("app/window/FileInfoPanel"),p=null,f=function(e,t,n,i){m();var o=[],a=[];return(p=r("pandoc",e,i)).on("close",function(e){var i=Buffer.concat(o),r=Buffer.concat(a).toString();t(n,i,r,e),p=null}),p.stdout.on("data",function(e){o.push(e)}),p.stderr.on("data",function(e){a.push(e)}),p},m=function(){p&&p.kill&&(p.removeAllListeners("close"),p.kill()),p=null},g=function(e){n=a.setting.isPandocValid();if(e&&void 0!==n)return n;if(n)return!0;var t,n=!0,i=reqnode("child_process").spawnSync("pandoc",["--version"]);if(i.error?n=!1:(t=(i=i.stdout.toString("utf8").split(/\r|\n|\r\n/)[0]).match(/[\d.]+/)[0],n=a.setting.compareVersion(t,"1.16")>=0),!n&&!e){var r=d.getDialog($.localize.getString("Require Pandoc to Continue...","Panel"),$.localize.getString("Import or some export features requires <a href='http://pandoc.org/' target='_blank'>Pandoc</a> (≥ v1.16) to be installed.","Panel"),!0,null,$.localize.getString("Follow Instructions to Install/Update Pandoc","Panel")).modal({backdrop:!1});r.find(".btn-primary").one("click",function(){o.app.openFile(__dirname+"/Docs/Install and Use Pandoc.md",{forceCreateWindow:!0}),r.modal("hide")})}return a.setting.setPandocValid(n),n},v={prepImport:function(){function e(e){n.webContents.executeJavaScript('window.getSelection().removeAllRanges();ClientCommand.doImport("'+c.escapeInQuote(e)+'")')}if(g()){var t=File.changeCounter.isDiscardableUntitled(),n=t?o.getCurrentWindow():a.openFile("",{syncAndPrepOnly:!0}),i=t;n.webContents.once("did-finish-load",function(){i=!0}),l.showOpenDialog(s,{title:$.localize.getString("Import","Menu"),properties:["openFile"],filters:[{name:$.localize.getString("All Supported Formats","Panel"),extensions:["docx","latex","tex","ltx","rst","rest","org","wiki","dokuwiki","textile","opml","epub"]},{name:"MS Word",extensions:["docx"]},{name:"TeX/LaTeX",extensions:["latex","tex","ltx"]},{name:"reStructuredText",extensions:["rst","rest"]},{name:"org-mode",extensions:["org"]},{name:"Wiki",extensions:["wiki","dokuwiki"]},{name:"Epub",extensions:["epub"]},{name:"Textile",extensions:["textile"]},{name:"OPML",extensions:["opml"]}]},function(r){if(r&&r.length){var o=r[0];if(t)return void e(o);n.show(),i?e(o):n.webContents.once("did-finish-load",function(){e(o)})}else t||n.close()})}},import:function(e){File.lock(),File.blockUI=!0,i=$("#import-process-dialog"),p=f([e,"--wrap=none","--atx-headers","-t","markdown"],b,e),h.setFileTitle(null,null,u.getFileNameFromPath(e).replace(/\..+$/,"")),setTimeout(function(){p&&(i.modal({backdrop:"static",keyboard:!1}),i.find(".btn").one("click",function(){m(),s.close()}))},200)},export:function(e){if(g()){File.megaMenu.hide(),File.sync();var t=[e];"latex"==e?t=["tex","latex"]:"wiki"==e?t=["wiki","txt"]:"rst"==e?t=["rst","text","rest","reStructuredText"]:"opml"==e?t=["opml","xml"]:"textile"==e&&(t=["textile"]);var n=(u.getCurrentFileFolderPath()||a.getPath("documents"))+"/"+File.getSuggestedFileName(!0)+(t?"."+t[0]:"");l.showSaveDialog(s,{title:$.localize.getString("Export to...","Panel"),defaultPath:n,filters:[{name:e,extensions:t},{name:$.localize.getString("All Files","Panel"),extensions:[]}]},function(t){if(t){File.blockUI=!0;var n=["-f","native","-s","-o",t,"-t",e];"wiki"==e&&(n.pop(),n.push("mediawiki"));var r=new Date;File.editor.export.exportToNative(e,function(e){(p=f(n,y,t,{stdio:"pipe"})).stdin.end(e,"utf8"),i=$("#export-process-dialog");var o=Math.max(500-new Date+r,0);setTimeout(function(){p&&(i.modal({backdrop:"static",keyboard:!1}),i.find(".btn").one("click",function(){File.blockUI=!1,m(),i.modal("hide")}))},o)})}})}}},y=function(e,t,n,r){i.modal("hide"),File.blockUI=!1,0!==r?function(t){d.getDialog($.localize.getString("Export Failed","Panel"),$.localize.getString("Failed to export file to <em>{0}</em>").format(c.escape(e))+"<br />"+c.escape(t.substring(0,500)),!0,"error-dialog").modal({backdrop:"static"}),console.error(t)}(n):o.shell.showItemInFolder(e),File.editor.export.cleanUpTempFiles()},b=function(e,t,n,r){i.modal("hide"),File.unlock(),File.blockUI=!1,t&&0!=t.length?File.reloadContent(t.toString(),!0):d.getDialog($.localize.getString("Import Failed","Panel"),$.localize.getString("Failed to import file from <em>{0}</em>","Panel").format(c.escape(e))+"<br />"+c.escape(n),!0,"error-dialog").modal({backdrop:"static"}),File.updateChangeCount(File.ChangeType.NSChangeDone),m()};v.slientQuit=m,v.validatePandocInstall=g,n.exports=v}}),define("app/window/ContextMenu",["app/editor/KeyMaster","app/document/Node","exoskeleton-master/exoskeleton","jquery/jquery","app/document/StringUtils","app/editor/Stylize","app/editor/UndoManager","rangy/rangy-core","app/window/MenuHelper","app/editor/polyfill","app/editor/UserOp","app/document/MarkParser","app/editor/Inline","app/editor/EditHelper","app/editor/Emoji","app/editor/TableEdit","app/editor/ConvertUtils","app/editor/DeleteOp","app/window/FileHelper","app/editor/PairOp","app/editor/IndentOp","app/editor/ClipboardOp"],function(e,t,n){"use strict";function i(){$(".context-menu").removeClass("show")}function r(e){var t=x.getCurrentWindow();i(),t.inspectElement(e.clientX,e.clientY)}function o(){var e=(x.app.setting.config||{}).searchService||[[$.localize.getString("Search with Google","Menu"),"https://google.com/search?q=%s"]];e.forEach(function(t,n){var i=$($.parseHTML('<li data-group="search" data-key>\n<a role="menuitem">'+b.escape(t[0])+"</a></li>")[0]);0===n?($("#search-service-placeholder").after('<li class="divider" data-group="search"></li>').replaceWith(i),i.attr("data-key","search-default"),e.length>2&&i.after('<li data-key="search-with" data-group="search" class="has-extra-menu">\n<a role="menuitem"><span>'+$.localize.getString("Search With…")+'</span><i class="fa fa-caret-right"></i></a></li>')):1===n&&2==e.length?$("[data-key='search-default']").after(i):$("#search-menu").append(i),i.click(function(){a(t[1])})})}function a(e){i(),x.shell.openExternal(e.replace(/%s/,encodeURIComponent(p)))}function s(e,t){var n=$("[data-group='"+e+"']");t?n.show():n.hide()}function l(){try{var e=File.editor.getJQueryElem(window.getSelection().anchorNode).closest("a");s("hyperlink",e.attr("href")||e.attr("data-ref"))}catch(e){s("hyperlink",!1)}}function c(){p="";try{s("search",(p=window.getSelection().toString()).trim().length>0)}catch(e){s("search")}}function d(){if(C&&!File.option.noSpellCheck&&!/\s/gi.exec(p.trim())&&p.trim().length>0&&C.isMisspelled(p.trim())){s("spell-check",!0),$("[data-key='correct']").remove();var e=C.getCorrectionsForMisspelling(p.trim());0==e.length?$("#divider-before-learn").hide():$("#divider-before-learn").show().before(e.reduce(function(e,t){return e+='<li data-group="spell-check" data-key="correct"><a role="menuitem">'+t+"</a></li>"},""))}else s("spell-check",!1)}function u(){File.editor.lastCursor&&File.editor.undo.exeCommand(File.editor.lastCursor)}var h,p="",f=(e("app/editor/KeyMaster"),e("app/document/Node")),m=f.Node,g=f.TYPE,v=e("app/editor/Stylize"),y=e("app/editor/UserOp"),b=e("app/document/StringUtils"),w=e("app/editor/KeyMaster").map,x=window.reqnode?reqnode("electron").remote:null,C=function(){try{return window.reqnode&&reqnode("spellchecker")}catch(e){console.warn(e.stack)}}(),k=function(e){File.isMac||(this.sessionStr=e,$(document).ready(S.bind(this)))},S=function(){$("content").on("scroll",i),$(window).on("resize",i),_.call(this),R.call(this),F.call(this),M.call(this),T.call(this),L.call(this),N.call(this),window.reqnode&&A.call(this),window.reqnode&&o.call(this)},T=function(){},E=function(){var e=File.editor.styleBookmark.style,t=e.block[0],n=document.querySelector("#context-menu"),i=File.editor.stylize.CONST.NoInline.indexOf(e.block[0])>-1,r=!1,o=!1,a=!1,l=function(){try{return File.editor.getMarkElem(window.getSelection().getRangeAt(0).startContainer).attr("mdtype")==f.TYPE.meta_block}catch(e){}return!1}();s("inline-style",!i),$("[data-style]").removeClass("active"),e.inline.map(function(e){var t=document.querySelector("[data-style='"+e+"']");t&&t.classList.add("active"),m.isType(e,g.inline_math)&&(a=!0)}),e.block.map(function(e){m.isType(e,g.blockquote,g.list_item)&&(r=!0),m.isType(e,g.table)&&(o=!0),m.isType(e,g.math_block)&&(a=!0)}),$("[data-key='block-style'] span").text($.localize.getString(v.CONST.StyleToNameMap[t],"Menu")),$("#block-style-menu [data-block]").removeClass("state-on").filter("[data-block='"+t+"']").addClass("state-on"),e.block.length>0&&File.editor.stylize.CONST.NormalBlockMap[t]?($("[data-block-auto-disable]").removeClass("disabled"),$("[data-block-auto-hide]").removeClass("hide")):($("[data-block-auto-disable]").addClass("disabled"),$("[data-block-auto-hide]").addClass("hide")),t!=g.def_footnote&&t!=g.def_link||($("#insert-menu [data-block-auto-disable]").addClass("disabled"),$("#insert-menu [data-block-auto-hide]").addClass("hide")),File.editor.docMenu.getMetaNode()||l?($('[data-insert="meta_block"]').parent().addClass("hide"),$('[data-group="block-wrap"]').addClass("hide")):(t==g.meta_block&&$('[data-insert-p="before"]').parent().addClass("disabled"),$('[data-insert="meta_block"]').removeClass("hide"),$('[data-group="block-wrap"]').removeClass("hide")),r?n.querySelector('[data-group="block-tab"]').classList.remove("hide"):n.querySelector('[data-group="block-tab"]').classList.add("hide"),o?(n.querySelector('[data-key="table"]').classList.remove("hide"),n.querySelector('[data-key="block-style"]').classList.add("hide")):(n.querySelector('[data-key="table"]').classList.add("hide"),n.querySelector('[data-key="block-style"]').classList.remove("hide")),a?n.querySelector('[data-key="math"]').classList.remove("hide"):n.querySelector('[data-key="math"]').classList.add("hide")},F=function(){document.querySelector("#context-menu");$("[data-style]").click(function(){i(),u(),File.editor.refocus(),File.editor.stylize.toggleStyle(this.getAttribute("data-style"))})},_=function(){$("body").on("mouseenter",".context-menu [data-key]",function(){var e=$(this);e.closest(".context-menu").find(".active").removeClass("active"),e.addClass("active")}).on("mouseleave",".context-menu",function(e){$(this).find(".active:not(.has-extra-menu)").removeClass("active")}),$("#context-menu").on("mouseenter","[data-key]",function(){var e=$(this);if("block-style"==e.attr("data-key")?(I("#block-style-menu",e),e.addClass("active")):(document.querySelector("#block-style-menu").classList.remove("show"),document.querySelector("[data-key='block-style']").classList.remove("active")),"insert"==e.attr("data-key")?(I("#insert-menu",e),e.addClass("active")):(document.querySelector("#insert-menu").classList.remove("show"),document.querySelector("[data-key='insert']").classList.remove("active")),"copy-as"==e.attr("data-key")?(I("#edit-menu",e),e.addClass("active")):(document.querySelector("[data-key='copy-as']").classList.remove("active"),document.querySelector("#edit-menu").classList.remove("show")),"search-with"==e.attr("data-key")?(I("#search-menu",e),e.addClass("active")):(document.querySelector("#search-menu").classList.remove("show"),$("[data-key='search-with']").removeClass("active")),"table"==e.attr("data-key")){var t=editor.getMarkElem();t.closest("thead").length?$("[data-key='insert_row_before'], [data-key='delete_table_row']").hide():($("[data-key='insert_row_before']").show(),t.closest("tbody").children().length>=2?$("[data-key='delete_table_row']").show():$("[data-key='delete_table_row']").hide()),t.closest("tr").children().length>=2?$("[data-key='delete_table_col']").show():$("[data-key='delete_table_col']").hide(),I("#table-menu",e),e.addClass("active")}else document.querySelector("#table-menu").classList.remove("show"),document.querySelector("[data-key='table']").classList.remove("active");"math"==e.attr("data-key")?(I("#math-menu",e),e.addClass("active")):(document.querySelector("#math-menu").classList.remove("show"),document.querySelector("[data-key='math']").classList.remove("active"))})},M=function(){$("#context-menu").on("click","[data-indent]",function(){var e=this.getAttribute("data-indent");i(),u(),File.editor.refocus(),File.editor.stylize.toggleIndent(e)}).on("click","[data-tab]",function(){i(),u(),File.editor.refocus();"left"==this.getAttribute("data-tab")?y.lessIndent(File.editor):y.moreIndent(File.editor)}),$("#block-style-menu").on("click","[data-block]",function(){var e=this.getAttribute("data-block");i(),u(),File.editor.refocus(),File.editor.stylize.changeBlock(e)}),$("#insert-menu").on("click","[data-insert]",function(){var e=this.getAttribute("data-insert");i(),u(),File.editor.refocus(),e===g.table?File.editor.tableEdit.insertTable():e===g.meta_block?File.editor.stylize.insertMetaBlock():File.editor.stylize.insertBlock(e)}).on("click","[data-insert-p]",function(){var e="before"==this.getAttribute("data-insert-p");i(),u(),File.editor.refocus(),File.editor.UserOp.insertParagraph(e)})},N=function(){$("#math-menu").on("click",'[data-key="copy_as_mathml"]',function(){i(),u(),File.editor.styleBookmark.style.block.indexOf(g.math_block)>-1?File.editor.mathBlock.copyAsMathML(h):File.editor.mathInline.copyAsMathML()}).on("click",'[data-key="copy_as_math_tex"]',function(){i(),u(),File.editor.styleBookmark.style.block.indexOf(g.math_block)>-1?File.editor.mathBlock.copyAsTex(h):File.editor.mathInline.copyAsTex()}).on("click",'[data-key="copy_as_math_image"]',function(){i(),u(),File.editor.styleBookmark.style.block.indexOf(g.math_block)>-1?File.editor.mathBlock.copyAsImage(h):File.editor.mathInline.copyAsImage()}),File.isWin||$("#math-menu [menu-for-win]").hide()},L=function(){$("#table-menu").on("click",'[data-key="insert_row_before"]',function(){i(),u(),File.editor.tableEdit.addRow(!0)}).on("click",'[data-key="insert_row_after"]',function(){i(),u(),File.editor.tableEdit.addRow(!1)}).on("click",'[data-key="delete_table_row"]',function(){i(),u(),File.editor.tableEdit.deleteRow(!1)}).on("click",'[data-key="insert_col_before"]',function(){i(),u(),File.editor.tableEdit.addCol(!0)}).on("click",'[data-key="insert_col_after"]',function(){i(),u(),File.editor.tableEdit.addCol(!1)}).on("click",'[data-key="delete_table_col"]',function(){i(),u(),File.editor.tableEdit.deleteCol()}).on("click",'[data-key="delete_table"]',function(){i(),u(),File.editor.tableEdit.deleteTable()}).on("click",'[data-key="copy_table"]',function(){i(),u(),File.editor.tableEdit.copyTable()})},A=function(){C&&!File.option.noSpellCheck&&(reqnode("electron").webFrame.setSpellCheckProvider("en-US",File.option.autoCorrectMisspell,{spellCheck:function(e){return!C.isMisspelled(e)}}),$("#context-menu").on("click","[data-key='learn']",function(){i(),u(),C.add(p)}).on("click","[data-key='correct']",function(e){i(),u(),y.pasteHandler(File.editor,$(e.target).text(),!0)}))},R=function(){$("[data-key='jumpto']").click(function(){i(),u(),File.editor.tryOpenLink(File.editor.getJQueryElem(window.getSelection().anchorNode).closest("a"))}),$(".context-menu").mousedown(function(e){if(!$(e.target).closest("a").length)return!1}),$("[data-key='dev-tool']").click(r),File.isNode&&(x.app.setting.get("debug",!1)?$("[data-group='dev-tool']").show():$("[data-group='dev-tool']").hide()),$("[data-key='cut']").click(function(e){i(),u(),ClientCommand.cut();var t;(t=$(document.activeElement.tagName).closest(".CodeMirror")[0])&&setTimeout(function(){t.CodeMirror.replaceSelection("","start")},30)}),$("[data-key='copy']").click(function(e){i(),u(),ClientCommand.copy()}),$("[data-key='copy_as_markdown']").click(function(e){i(),u(),ClientCommand.copyAsMarkdown()}),$("[data-key='paste_as_plain']").click(function(e){i(),u(),ClientCommand.pasteAsPlain()}),$("[data-key='paste']").click(function(){i(),u(),ClientCommand.paste()})};k.prototype.show=function(e){File.editor.brush.expand(),$(File.editor.sessionStr).trigger("cursorChange"),File.editor.lastCursor=File.editor.selection.buildUndo(),$(e.target).closest(".mathjax-block").length&&(h=e.target,File.editor.stylize.putBookmark(null,File.editor.stylize.buildBookmark($(e.target).closest(".mathjax-block"))),File.ignoreStyleChange=!0,setTimeout(function(){File.ignoreStyleChange=!1},400)),$(".context-menu").removeClass("show").find(".active").removeClass("active"),l(),c(),E(),window.reqnode&&d();var t=$("#context-menu").addClass("show"),n=t.height()+48,i=e.clientX>window.innerWidth-220?window.innerWidth-220:e.clientX,r=e.clientY>window.innerHeight-n?window.innerHeight-n:e.clientY-$("#top-titlebar").height()+8;t.css({top:r+"px",left:i+"px"}),e.preventDefault(),e.stopPropagation()};var I=function(e,t){var n=$(e).addClass("show"),i=n.height()+48,r=t.offset(),o=r.left,a=o+200,s=r.top-30,l=a+160>window.innerWidth?o-184:a,c=s+i>window.innerHeight?window.innerHeight-i:s;return n.css({top:c+"px",left:l+"px"}),!1},P=function(e,t){var n,i,r=$(e);if("Enter"==t){if(!r.hasClass("has-extra-menu"))return r.trigger("click").find("a").trigger("click"),!0;t="OpenSubmenu"}if("Up"==t||"Down"==t)return r=r.closest("li"),0==(n="Up"==t?r.prev():r.next()).length||(!n.height()||n.hasClass("divider")?P(n[0],t):(r=r.closest(".context-menu").find(".active"),n.hasClass("has-btn-submenu")?(i=r.prevAll("a").length/(r.closest(".has-btn-submenu").find("a").length||1)*n.find("a").length,(n=$(n.find("[data-key]")[Math.floor(i)])).trigger("mouseenter"),!0):(r.removeClass("active"),n.addClass("active"),!0)));if(("Left"==t||"Right"==t)&&"A"==r[0].tagName)return n="Left"==t?r.prev():r.next(),r.removeClass("active"),n.addClass("active"),!0;if("Left"==t||"Esc"==t){if((r=r.closest(".context-menu")).hasClass("ext-context-menu"))return r.find(".active").removeClass("active"),r.removeClass("show"),!0;if("Left"==t)return!0}return"Right"==t||"OpenSubmenu"==t?(r.hasClass("has-extra-menu")&&(r.trigger("mouseenter"),$(".ext-context-menu:visible [data-key]:visible").first().trigger("mouseenter")),!0):void 0};k.prototype.handleKeyEvent=function(e){var t,n=w[e.keyCode||e.which],i=$(".context-menu:visible");return!!i.length&&("Esc"==n?($(".context-menu").removeClass("show"),!0):i.find(".active").length?(t=$(".ext-context-menu .active")[0])?P(t,n):P($(".context-menu .active")[0],n):"Up"==n?(i.find("li[data-key]:visible").last().addClass("active"),!0):"Down"==n?(i.find("li[data-key]:visible").first().addClass("active"),!0):void 0)},n.exports=k}),define("app/window/MegaMenu",["list.js-master/dist/list","list.js-master/dist/list.fuzzysearch.min","app/document/StringUtils","app/editor/EditHelper","jquery/jquery","app/document/Node","exoskeleton-master/exoskeleton","app/editor/KeyMaster","app/window/FileHelper","app/window/ClientCommand","app/document/File","app/editor/UndoManager","app/editor/polyfill","app/window/FileHelper","app/window/MenuHelper","app/window/FileInfoPanel","app/window/steno2","app/window/PDFBridge","app/window/PandocBridge","app/window/PandocBridge"],function(e,t,n){"use strict";var i=e("list.js-master/dist/list"),r=e("list.js-master/dist/list.fuzzysearch.min.js"),o=e("app/document/StringUtils"),a=e("app/editor/EditHelper"),s=e("app/window/FileHelper"),l=e("app/editor/KeyMaster").map,c=e("app/window/ClientCommand"),d=e("app/window/PandocBridge"),u=window.reqnode?reqnode("electron").remote:null,h=function(e){File.isNodeHtml&&(this.sessionStr=e,$(document).ready(m.bind(this)))},p=null,f=function(){$("#recent-document-table");if(File.isNode){u.getCurrentWindow();var e=u.app,t=e.setting.getRecentDocuments(),n=e.setting.getRecentFolders(),a=reqnode("fs-plus");if(t.map(function(e){e["recent-file-dir"]=a.tildify(e.path.substr(0,e.path.length-e.name.length)),e["recent-file-name"]=o.escape(e.name),e["recent-file-path"]=o.escape(e.path)}),n.map(function(e){e["recent-file-dir"]="(folder)",e["recent-file-name"]=o.escape(e.name),e["recent-file-path"]=o.escape(e.path)}),t=t.concat(n),t=t.filter(function(e){return e["recent-file-name"].trim().length>0}).sort(function(e,t){return-e.date+t.date}),p)p.clear(),p.add(t);else{var s={item:"recent-file-item-pattern",listClass:"list-js-list",valueNames:["name"],plugins:[r()]};p=new i("recent-file-panel",s,t)}}};h.prototype.hide=function(){document.body.classList.remove("megamenu-opened"),File.editor.lastCursor&&File.editor.undo.exeCommand(File.editor.lastCursor)},h.prototype.show=function(){File.editor.lastCursor=File.editor.selection.buildUndo(),document.body.classList.add("megamenu-opened"),$(".dropdown-menu").removeClass("open").removeClass("show")};var m=function(){function e(){var e=this.getAttribute("id").substr(2);$(".megamenu-section").addClass("hide"),$("#megamenu-section-"+e).removeClass("hide"),$("#megamenu-menu-list a").removeClass("active"),$(this).addClass("active")}if($(document).on("keydown",function(e){"Esc"===l[e.keyCode||e.which]&&File.megaMenu.hide()}),$("#w-menu-btn").click(function(){return File.megaMenu.show(),$("#m-open").trigger("click"),!1}),$(".megamenu-menu-header").click(function(){return File.megaMenu.hide(),!1}).mouseleave(function(){$(this).blur()}),$("#m-open").on("active",function(){e.call(this),f()}).on("click",function(){$(this).trigger("active"),!$("#megamenu-section-open").removeClass("hide").is(":visible")&&$("#m-open-local").trigger("click")}),$("#m-export, #m-about").click(e),$("#m-theme").click(function(){y(),e.call(this)}),$("#m-preference").click(function(){File.megaMenu.prepPreferencePanel(),e.call(this)}),File.isNode){u.getCurrentWindow();var t=u.app;$("#m-close").click(c.close),$("#m-new").click(c.newFile),$("#recent-file-panel").on("click",".recent-file-item",function(){var e=this.querySelector(".recent-file-path").innerHTML,n=o.unescape(e);File.fs.existsSync(n)?(c.openWithPath(n),File.megaMenu.hide()):(a.getDialog($.localize.getString("Error"),$.localize.getString("File does not exist at <em>{0}</em>","Panel").format(e),!0,"error-dialog").modal({backdrop:"static"}),t.setting.removeRecentDocument(n),p&&p.remove("path",n))}),$("#megamenu-clear-recet-documents").click(function(){t.setting.clearRecentDocuments(),p.clear()}),$("#m-open-local").click(c.open),$("#m-import-local").click(c.import),$("#m-save").click(c.save),$("#m-save-as").click(c.saveAs),$("#export-as-pdf").click(c.exportPDF),$("#export-as-html").click(c.exportHTML),$("#export-as-html-plain").click(c.exportHTMLPlain),$("#export-as-image").click(c.exportImage),$("#export-as-docx").click(c.exportDocx),$("#export-as-odt").click(c.exportOdt),$("#export-as-rtf").click(c.exportRTF),$("#export-as-epub").click(c.exportEpub),$("#export-as-latex").click(c.exportLaTeX),$("#export-as-wiki").click(c.exportWiki),$("#export-as-rst").click(c.exportRST),$("#export-as-opml").click(c.exportOPML),$("#export-as-textile").click(c.exportTextile),$("#m-print").click(c.print),w(),g()}},g=function(){$("#about-page-version-label").text("version "+u.app.getVersion()+"(beta)"),u.app.setting.get("framelessWindow")||$("#about-content-about-section").appendTo("#about-dialog .modal-body"),$("#typora-help-md-table tr").click(function(){this.textContent.trim()==$.localize.getString("Support Documentation","Panel")?u.shell.openExternal("http://support.typora.io"):u.app.openFile(__dirname+"/Docs/"+this.textContent.trim()+".md",{forceCreateWindow:!0})})},v=!1,y=function(){var e=u.app,t=e.setting.getAllThemes(),n="";v||(t.map(function(t){n+='<div class="theme-preview-div" data-theme="$theme$" ><iframe class="theme-preview-content" src="html/preview.html?$src$""></iframe><div style="position:absolute; top:0;left:0;bottom:0;right:0;background:white;opacity:0;padding:0;margin:0;"></div><i class="fa fa-check-circle"></i></div>'.replace("$src$",encodeURI("folder="+e.getPath("userData").replace(/\\/g,"\\\\")+"/themes&&css="+t)).replace("$theme$",t)}),$("#theme-preview-grid").html(n).on("click",".theme-preview-div",function(){$("#theme-preview-grid").find(".active").removeClass("active");var e=$(this).addClass("active").attr("data-theme");c.setTheme(e,e.replace(/\.css$/,"").replace(/(?:^|_|-)(\w)/g,function(e,t,n){return t.toUpperCase()}))}),v=!0),$("#theme-preview-grid [data-theme='"+e.setting.getCurrentTheme()+"']").addClass("active")},b=function(e){e=e||File.option.indentSize;var t=["> Quote\n- List item\n  1. sub-bullet",">  Quote\n-  List item\n   1. sub-bullet",">   Quote\n-   List item\n    1.  sub-bullet",">    Quote\n-    List item\n     1.   sub-bullet"];$("#preference-indent-size-pre").text(t[e-2])},w=function(){u.getCurrentWindow();var e=u.app,t=reqnode("fs-extra"),n=(reqnode("electron").ipcRenderer,function(){}),i=function(i){t.copy(__dirname+"/conf.default.json",e.getPath("userData")+"/conf/conf.default.json",{overwrite:!0},i||n),t.copy(__dirname+"/conf.default.json",e.getPath("userData")+"/conf/conf.user.json",{overwrite:!0},n)};$(document).on("change","input[name='windowStyleType']",function(){e.setting.put("framelessWindow","framelessWindow"==$("input[name='windowStyleType']:checked").val())}).on("change","#show-status-bar-btn",function(){var t=$("#show-status-bar-btn:checked").length>0;e.setting.put("showStatusBar",t),c.execForAll('function() {                document.body.classList.toggle("show-footer");            }')}).on("change","input[name='fontSize']",function(){var t=$("#use-custom-font-size-btn").prop("checked");e.setting.put("useCustomFontSize",t),c.execForAll('function() {                var app = reqnode("electron").remote.app,                    useCustomFontSize = app.setting.get("useCustomFontSize");                if (useCustomFontSize) {                    document.body.parentElement.style.fontSize = (app.setting.get("customFontSize") || 14) + "px";                } else {                    document.body.parentElement.style.fontSize = "";                }            }')}).on("keypress","#custom-font-size-input",function(e){if(!/\d/.exec(String.fromCharCode(e.which)))return!1}).on("blur","#custom-font-size-input",function(t){var n=/\d+/.exec(this.value)[0];e.setting.put("customFontSize",n),c.execForAll('function() {                var app = reqnode("electron").remote.app;                document.body.parentElement.style.fontSize = app.setting.get("customFontSize") + "px";            }')}).on("change","#collapsible-outline-btn",function(){var t=$("#collapsible-outline-btn:checked").length>0;e.setting.put("can_collapse_outline_panel",t),c.execForAll("function() {                File.setCanCollapsePinnedOutline("+!!t+");            }")}).on("change","[name='enable_inline_math'], [name='enable_subscript'],[name='enable_superscript'],[name='enable_highlight'],[name='enable_diagram'],[name='copy_markdown_by_default'], [name='show_line_numbers_for_fence'], [name='auto_correct_misspell'], [name='auto_numbering_for_math'], [name='use_relative_path_for_img'], [name='allow_image_move'], [name='strict_mode']",function(){var t=this.getAttribute("name"),n=$(this).prop("checked");e.setting.put(t,n),"strict_mode"!=t&&c.execForAll("function(){File.option."+o.camelize(t)+" = "+n+";}")}).on("change","#preference-indent-size-btn",function(){var t=this.value-0;e.setting.put("indentSize",t),b(t),c.execForAll('function() {                File.option.indentSize = "$1";            }',t)}).on("click","#open-theme-folder-btn",function(){u.shell.openItem(u.app.getPath("userData")+"/themes")}).on("change","#preference-trigger-debug-btn",function(){var t=$("#preference-trigger-debug-btn:checked").length>0;e.setting.put("debug",t),t?c.execForAll("function() {$(\"[data-group='dev-tool']\").show();}"):c.execForAll("function() {$(\"[data-group='dev-tool']\").hide();}")}).on("change","#preference-send-anony-info-btn",function(){e.setting.put("send_usage_info",$("#preference-send-anony-info-btn:checked").length>0)}).on("change","[name='enable_spell_check']",function(){var t=!$(this).prop("checked");e.setting.put("no_spell_check",t),$("[name='auto_correct_misspell']").prop("disabled",!t),c.execForAll("function(){File.option.noSpellCheck = "+t+";}")}).on("change","#preference_auto_pair",function(){var t=!$(this).prop("checked");e.setting.put("no_pairing_match",t),c.execForAll("function(){File.option.noPairingMatch = "+t+";}"),t&&$("#preference_auto_pair_markdown").prop("checked",!1),$("#preference_auto_pair_markdown").prop("disabled",t)}).on("change","#preference_auto_pair_markdown",function(){var t=$(this).prop("checked");e.setting.put("match_pari_markdown",t),c.execForAll("function(){File.option.autoPairExtendSymbol = "+t+";}")}).on("change","[name='defaultLineEnding']",function(){var t=$("#trigger-line-ending-crlf").prop("checked");e.setting.put("line_ending_crlf",t),c.execForAll("function(){File.option.preferCRLF = "+t+";}")}).on("change","#preference_expand_block",function(){var t=$(this).prop("checked");e.setting.put("auto_expand_block",t),c.execForAll("function(){File.option.expandSimpleBlock = "+t+";}")}).on("change","#preference-heading-style",function(){var t=$(this).val()-0;e.setting.put("heading_style",t),c.execForAll("function(){File.option.headingStyle = "+t+";}")}).on("change","#preference-ul-style",function(){var t=$(this).val()-0;e.setting.put("ul_style",t),c.execForAll("function(){File.option.ulStyle = "+t+";}")}).on("change","[name='autocompleteTrigger']",function(){var t=$("#trigger-emoji-autocomplete-on").prop("checked");e.setting.put("trigger_emoji_autocomplete",t),c.execForAll("function(){File.option.autoToggleEmojiAutoComplete = "+t+";}")}).on("click","#preference-open-draft-folder",function(){u.shell.openItem(s.getUnsavedDraftsPath())}).on("change","#preference-auto-save",function(){var t=$(this).prop("checked");e.setting.put("enableAutoSave",t),File.option.enableAutoSave=t,c.execForAll("function(){File.option.enableAutoSave = "+t+";}"),$("#preference-auto-save-on-switch").prop("checked",File.option.enableAutoSave||File.option.saveFileOnSwitch),$("#preference-auto-save-on-switch").prop("disabled",File.option.enableAutoSave)}).on("change","#preference-auto-save-on-switch",function(){var t=$(this).prop("checked");e.setting.put("save_file_on_switch",t),c.execForAll("function(){File.option.saveFileOnSwitch = "+t+";}")}).on("click","#open-conf-folder-btn",function(){var t=e.getPath("userData")+"/conf/conf.user.json";reqnode("fs-plus").isFileSync(t)?u.shell.showItemInFolder(t):i(function(){u.shell.showItemInFolder(t)})}).on("click","#reset-conf-folder-btn",function(){$(".modal:not(.block-modal)").modal("hide");var e=a.getDialog("Confrim","Revert advanced setting file to default one ?").modal({backdrop:!1});e.find(".btn-primary").one("click",function(){i(),e.modal("hide")})}).on("change","[name='scroll_with_cursor']",function(){var t=!$(this).prop("checked");e.setting.put("no_pairing_match",t),c.execForAll("function(){File.option.scrollWithCursor = !"+t+";}")}).on("change","#preference-lanuage",function(){e.setting.put("userLanguage",$("#preference-lanuage").val())}),function(){try{var t=File.isWin&&reqnode("winsparkle-node");$(document).on("click","#preference-trigger-check-update",function(){File.isWin&&(t.setAppcastUrl("https://www.typora.io/windows/dev_update.xml"),t.checkUpdateWithUI())}).on("change","#preference-enable-auto-update",function(){$("#preference-enable-auto-update:checked").length?(t.setAutomaticCheckForUpdates(!0),e.setting.put("enableAutoUpdate",!0)):(t.setAutomaticCheckForUpdates(!1),e.setting.put("enableAutoUpdate",!1))})}catch(e){console.error(e)}}()};h.prototype.prepPreferencePanel=function(){u.getCurrentWindow();var e=u.app;if(d.validatePandocInstall(!0)&&$(".hide-when-pandoc-installed").hide(),$(".open-pandoc-guide").on("click",function(){e.openFile(__dirname+"/Docs/Install and Use Pandoc.md")}),document.body.classList.contains("native-window")&&$("#preference-content").appendTo("#preference-dialog .modal-body"),$("input[name='windowStyleType'][value='framelessWindow']").prop("checked",e.setting.get("framelessWindow")),$("input[name='windowStyleType'][value='nativeWindow']").prop("checked",!e.setting.get("framelessWindow")),$("#show-status-bar-btn").prop("checked",!1!==e.setting.get("showStatusBar")),$("#custom-font-size-input").val(e.setting.get("customFontSize")||14),e.setting.get("useCustomFontSize")?$("#use-custom-font-size-btn").prop("checked",!0):$("#use-auto-font-size-btn").prop("checked",!0),$("#collapsible-outline-btn").prop("checked",e.setting.get("can_collapse_outline_panel")),File.option.autoToggleEmojiAutoComplete?$("#trigger-emoji-autocomplete-on").prop("checked",!0):$("#trigger-emoji-autocomplete-off").prop("checked",!0),$("input[name='copy_markdown_by_default']").prop("checked",File.option.copyMarkdownByDefault),["enable_subscript","enable_superscript","show_line_numbers_for_fence","auto_numbering_for_math","enable_highlight","use_relative_path_for_img","allow_image_move","strict_mode"].map(function(t){$("input[name='"+t+"']").prop("checked",e.setting.get(t))}),$("input[name='enable_diagram']").prop("checked",File.option.enableDiagram),$("input[name='enable_inline_math']").prop("checked",File.option.enableInlineMath),$("#preference-auto-save").prop("checked",File.option.enableAutoSave),$("#preference-auto-save-on-switch").prop("checked",File.option.enableAutoSave||File.option.saveFileOnSwitch),$("#preference-auto-save-on-switch").prop("disabled",File.option.enableAutoSave),$("input[name='enable_spell_check']").prop("checked",!e.setting.get("no_spell_check")),$("input[name='auto_correct_misspell']").prop("checked",!e.setting.get("auto_correct_misspell")).prop("disabled",e.setting.get("no_spell_check")),$("input[name='scroll_with_cursor']").prop("checked",!e.setting.get("no_pairing_match")),$("#preference_auto_pair").prop("checked",!e.setting.get("no_pairing_match")),e.setting.get("no_pairing_match")?($("#preference_auto_pair_markdown").prop("checked",!1),$("#preference_auto_pair_markdown").prop("disabled",!0)):($("#preference_auto_pair_markdown").prop("checked",e.setting.get("match_pari_markdown")),$("#preference_auto_pair_markdown").prop("disabled",!1)),$("#preference_expand_block").prop("checked",e.setting.get("auto_expand_block")),$("#preference-indent-size-btn").val((e.setting.get("indentSize")||2)+""),File.isWin)try{var t=reqnode("winsparkle-node");$("#preference-enable-auto-update").prop("checked",t.getAutomaticCheckForUpdates())}catch(e){console.error(e)}else $("#preference-enable-auto-update").parent().hide();$("#preference-trigger-debug-btn").prop("checked",e.setting.get("debug",!1)),$("#preference-send-anony-info-btn").prop("checked",e.setting.get("send_usage_info",!0)),$("#preference-heading-style").val(File.option.headingStyle),$("#preference-ul-style").val(File.option.ulStyle),$("#trigger-line-ending-crlf").prop("checked",File.option.preferCRLF),$("#trigger-line-ending-lf").prop("checked",!File.option.preferCRLF),$("#preference-lanuage").val(e.setting.get("userLanguage")||"auto"),b()},n.exports=h}),define("list.js-master/dist/list",[],function(e,t,n){"use strict";!function(){function e(t,n,i){var r=e.resolve(t);if(null==r){i=i||t,n=n||"root";var o=new Error('Failed to require "'+i+'" from "'+n+'"');throw o.path=i,o.parent=n,o.require=!0,o}var a=e.modules[r];if(!a._resolving&&!a.exports){var s={};s.exports={},s.client=s.component=!0,a._resolving=!0,a.call(this,s.exports,e.relative(r),s),delete a._resolving,a.exports=s.exports}return a.exports}e.modules={},e.aliases={},e.resolve=function(t){"/"===t.charAt(0)&&(t=t.slice(1));for(var n=[t,t+".js",t+".json",t+"/index.js",t+"/index.json"],i=0;i<n.length;i++){var t=n[i];if(e.modules.hasOwnProperty(t))return t;if(e.aliases.hasOwnProperty(t))return e.aliases[t]}},e.normalize=function(e,t){var n=[];if("."!=t.charAt(0))return t;e=e.split("/"),t=t.split("/");for(var i=0;i<t.length;++i)".."==t[i]?e.pop():"."!=t[i]&&""!=t[i]&&n.push(t[i]);return e.concat(n).join("/")},e.register=function(t,n){e.modules[t]=n},e.alias=function(t,n){if(!e.modules.hasOwnProperty(t))throw new Error('Failed to alias "'+t+'", it does not exist');e.aliases[n]=t},e.relative=function(t){function n(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1}function i(n){return e(i.resolve(n),t,n)}var r=e.normalize(t,"..");return i.resolve=function(i){var o=i.charAt(0);if("/"==o)return i.slice(1);if("."==o)return e.normalize(r,i);var a=t.split("/"),s=n(a,"deps")+1;return s||(s=0),i=a.slice(0,s+1).join("/")+"/deps/"+i},i.exists=function(t){return e.modules.hasOwnProperty(i.resolve(t))},i},e.register("component-classes/index.js",function(e,t,n){function i(e){if(!e)throw new Error("A DOM element reference is required");this.el=e,this.list=e.classList}var r=t("indexof"),o=/\s+/,a=Object.prototype.toString;n.exports=function(e){return new i(e)},i.prototype.add=function(e){if(this.list)return this.list.add(e),this;var t=this.array();return~r(t,e)||t.push(e),this.el.className=t.join(" "),this},i.prototype.remove=function(e){if("[object RegExp]"==a.call(e))return this.removeMatching(e);if(this.list)return this.list.remove(e),this;var t=this.array(),n=r(t,e);return~n&&t.splice(n,1),this.el.className=t.join(" "),this},i.prototype.removeMatching=function(e){for(var t=this.array(),n=0;n<t.length;n++)e.test(t[n])&&this.remove(t[n]);return this},i.prototype.toggle=function(e,t){return this.list?(void 0!==t?t!==this.list.toggle(e,t)&&this.list.toggle(e):this.list.toggle(e),this):(void 0!==t?t?this.add(e):this.remove(e):this.has(e)?this.remove(e):this.add(e),this)},i.prototype.array=function(){var e=this.el.className.replace(/^\s+|\s+$/g,"").split(o);return""===e[0]&&e.shift(),e},i.prototype.has=i.prototype.contains=function(e){return this.list?this.list.contains(e):!!~r(this.array(),e)}}),e.register("segmentio-extend/index.js",function(e,t,n){n.exports=function(e){for(var t,n=Array.prototype.slice.call(arguments,1),i=0;t=n[i];i++)if(t)for(var r in t)e[r]=t[r];return e}}),e.register("component-indexof/index.js",function(e,t,n){n.exports=function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}}),e.register("component-event/index.js",function(e,t,n){var i=window.addEventListener?"addEventListener":"attachEvent",r=window.removeEventListener?"removeEventListener":"detachEvent",o="addEventListener"!==i?"on":"";e.bind=function(e,t,n,r){return e[i](o+t,n,r||!1),n},e.unbind=function(e,t,n,i){return e[r](o+t,n,i||!1),n}}),e.register("timoxley-to-array/index.js",function(e,t,n){function i(e){return"[object Array]"===Object.prototype.toString.call(e)}n.exports=function(e){if(void 0===e)return[];if(null===e)return[null];if(e===window)return[window];if("string"==typeof e)return[e];if(i(e))return e;if("number"!=typeof e.length)return[e];if("function"==typeof e&&e instanceof Function)return[e];for(var t=[],n=0;n<e.length;n++)(Object.prototype.hasOwnProperty.call(e,n)||n in e)&&t.push(e[n]);return t.length?t:[]}}),e.register("javve-events/index.js",function(e,t,n){var i=t("event"),r=t("to-array");e.bind=function(e,t,n,o){e=r(e);for(var a=0;a<e.length;a++)i.bind(e[a],t,n,o)},e.unbind=function(e,t,n,o){e=r(e);for(var a=0;a<e.length;a++)i.unbind(e[a],t,n,o)}}),e.register("javve-get-by-class/index.js",function(e,t,n){n.exports=document.getElementsByClassName?function(e,t,n){return n?e.getElementsByClassName(t)[0]:e.getElementsByClassName(t)}:document.querySelector?function(e,t,n){return t="."+t,n?e.querySelector(t):e.querySelectorAll(t)}:function(e,t,n){var i=[];null==e&&(e=document);for(var r=e.getElementsByTagName("*"),o=r.length,a=new RegExp("(^|\\s)"+t+"(\\s|$)"),s=0,l=0;s<o;s++)if(a.test(r[s].className)){if(n)return r[s];i[l]=r[s],l++}return i}}),e.register("javve-get-attribute/index.js",function(e,t,n){n.exports=function(e,t){var n=e.getAttribute&&e.getAttribute(t)||null;if(!n)for(var i=e.attributes.length,r=0;r<i;r++)void 0!==t[r]&&t[r].nodeName===t&&(n=t[r].nodeValue);return n}}),e.register("javve-natural-sort/index.js",function(e,t,n){n.exports=function(e,t,n){var i,r,o=/(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,a=/(^[ ]*|[ ]*$)/g,s=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,l=/^0x[0-9a-f]+$/i,c=/^0/,n=n||{},d=function(e){return n.insensitive&&(""+e).toLowerCase()||""+e},u=d(e).replace(a,"")||"",h=d(t).replace(a,"")||"",p=u.replace(o,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),f=h.replace(o,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),m=parseInt(u.match(l))||1!=p.length&&u.match(s)&&Date.parse(u),g=parseInt(h.match(l))||m&&h.match(s)&&Date.parse(h)||null,v=n.desc?-1:1;if(g){if(m<g)return-1*v;if(m>g)return 1*v}for(var y=0,b=Math.max(p.length,f.length);y<b;y++){if(i=!(p[y]||"").match(c)&&parseFloat(p[y])||p[y]||0,r=!(f[y]||"").match(c)&&parseFloat(f[y])||f[y]||0,isNaN(i)!==isNaN(r))return isNaN(i)?1:-1;if(typeof i!=typeof r&&(i+="",r+=""),i<r)return-1*v;if(i>r)return 1*v}return 0}}),e.register("javve-to-string/index.js",function(e,t,n){n.exports=function(e){return e=void 0===e?"":e,e=null===e?"":e,e=e.toString()}}),e.register("component-type/index.js",function(e,t,n){var i=Object.prototype.toString;n.exports=function(e){switch(i.call(e)){case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array";case"[object Error]":return"error"}return null===e?"null":void 0===e?"undefined":e!==e?"nan":e&&1===e.nodeType?"element":typeof e.valueOf()}}),e.register("list.js/index.js",function(e,t,n){!function(e,i){var r=e.document,o=t("get-by-class"),a=t("extend"),s=t("indexof"),l=function(e,n,i){var c,d=this,u=t("./src/item")(d),h=t("./src/add-async")(d),p=t("./src/parse")(d);c={start:function(){d.listClass="list",d.searchClass="search",d.sortClass="sort",d.page=200,d.i=1,d.items=[],d.visibleItems=[],d.matchingItems=[],d.searched=!1,d.filtered=!1,d.handlers={updated:[]},d.plugins={},d.helpers={getByClass:o,extend:a,indexOf:s},a(d,n),d.listContainer="string"==typeof e?r.getElementById(e):e,d.listContainer&&(d.list=o(d.listContainer,d.listClass,!0),d.templater=t("./src/templater")(d),d.search=t("./src/search")(d),d.filter=t("./src/filter")(d),d.sort=t("./src/sort")(d),this.items(),d.update(),this.plugins())},items:function(){p(d.list),void 0!==i&&d.add(i)},plugins:function(){for(var e=0;e<d.plugins.length;e++){var t=d.plugins[e];d[t.name]=t,t.init(d,l)}}},this.add=function(e,t){if(!t){var n=[],i=!1;void 0===e[0]&&(e=[e]);for(var r=0,o=e.length;r<o;r++){var a=null;e[r]instanceof u?(a=e[r]).reload():(i=d.items.length>d.page,a=new u(e[r],void 0,i)),d.items.push(a),n.push(a)}return d.update(),n}h(e,t)},this.show=function(e,t){return this.i=e,this.page=t,d.update(),d},this.remove=function(e,t,n){for(var i=0,r=0,o=d.items.length;r<o;r++)d.items[r].values()[e]==t&&(d.templater.remove(d.items[r],n),d.items.splice(r,1),o--,r--,i++);return d.update(),i},this.get=function(e,t){for(var n=[],i=0,r=d.items.length;i<r;i++){var o=d.items[i];o.values()[e]==t&&n.push(o)}return n},this.size=function(){return d.items.length},this.clear=function(){return d.templater.clear(),d.items=[],d},this.on=function(e,t){return d.handlers[e].push(t),d},this.off=function(e,t){var n=d.handlers[e],i=s(n,t);return i>-1&&n.splice(i,1),d},this.trigger=function(e){for(var t=d.handlers[e].length;t--;)d.handlers[e][t](d);return d},this.reset={filter:function(){for(var e=d.items,t=e.length;t--;)e[t].filtered=!1;return d},search:function(){for(var e=d.items,t=e.length;t--;)e[t].found=!1;return d}},this.update=function(){var e=d.items,t=e.length;d.visibleItems=[],d.matchingItems=[],d.templater.clear();for(var n=0;n<t;n++)e[n].matching()&&d.matchingItems.length+1>=d.i&&d.visibleItems.length<d.page?(e[n].show(),d.visibleItems.push(e[n]),d.matchingItems.push(e[n])):e[n].matching()?(d.matchingItems.push(e[n]),e[n].hide()):e[n].hide();return d.trigger("updated"),d},c.start()};n.exports=l}(window)}),e.register("list.js/src/search.js",function(e,t,n){var i=t("events"),r=t("get-by-class"),o=t("to-string");n.exports=function(e){var t,n,a,s,l={resetList:function(){e.i=1,e.templater.clear(),s=void 0},setOptions:function(e){2==e.length&&e[1]instanceof Array?n=e[1]:2==e.length&&"function"==typeof e[1]?s=e[1]:3==e.length&&(n=e[1],s=e[2])},setColumns:function(){n=void 0===n?l.toArray(e.items[0].values()):n},setSearchString:function(e){e=(e=o(e).toLowerCase()).replace(/[-[\]{}()*+?.,\\^$|#]/g,"\\$&"),a=e},toArray:function(e){var t=[];for(var n in e)t.push(n);return t}},c={list:function(){for(var t=0,n=e.items.length;t<n;t++)c.item(e.items[t])},item:function(e){e.found=!1;for(var t=0,i=n.length;t<i;t++)if(c.values(e.values(),n[t]))return void(e.found=!0)},values:function(e,n){return!!(e.hasOwnProperty(n)&&(t=o(e[n]).toLowerCase(),""!==a&&t.search(a)>-1))},reset:function(){e.reset.search(),e.searched=!1}},d=function(t){return e.trigger("searchStart"),l.resetList(),l.setSearchString(t),l.setOptions(arguments),l.setColumns(),""===a?c.reset():(e.searched=!0,s?s(a,n):c.list()),e.update(),e.trigger("searchComplete"),e.visibleItems};return e.handlers.searchStart=e.handlers.searchStart||[],e.handlers.searchComplete=e.handlers.searchComplete||[],i.bind(r(e.listContainer,e.searchClass),"keyup",function(t){var n=t.target||t.srcElement;""===n.value&&!e.searched||d(n.value)}),i.bind(r(e.listContainer,e.searchClass),"input",function(e){""===(e.target||e.srcElement).value&&d("")}),e.helpers.toString=o,d}}),e.register("list.js/src/sort.js",function(e,t,n){var i=t("natural-sort"),r=t("classes"),o=t("events"),a=t("get-by-class"),s=t("get-attribute");n.exports=function(e){e.sortFunction=e.sortFunction||function(e,t,n){return n.desc="desc"==n.order,i(e.values()[n.valueName],t.values()[n.valueName],n)};var t={els:void 0,clear:function(){for(var e=0,n=t.els.length;e<n;e++)r(t.els[e]).remove("asc"),r(t.els[e]).remove("desc")},getOrder:function(e){var t=s(e,"data-order");return"asc"==t||"desc"==t?t:r(e).has("desc")?"asc":r(e).has("asc")?"desc":"asc"},getInSensitive:function(e,t){var n=s(e,"data-insensitive");t.insensitive="true"===n},setOrder:function(e){for(var n=0,i=t.els.length;n<i;n++){var o=t.els[n];if(s(o,"data-sort")===e.valueName){var a=s(o,"data-order");"asc"==a||"desc"==a?a==e.order&&r(o).add(e.order):r(o).add(e.order)}}}},n=function(){e.trigger("sortStart"),options={};var n=arguments[0].currentTarget||arguments[0].srcElement||void 0;n?(options.valueName=s(n,"data-sort"),t.getInSensitive(n,options),options.order=t.getOrder(n)):(options=arguments[1]||options,options.valueName=arguments[0],options.order=options.order||"asc",options.insensitive=void 0===options.insensitive||options.insensitive),t.clear(),t.setOrder(options),options.sortFunction=options.sortFunction||e.sortFunction,e.items.sort(function(e,t){return options.sortFunction(e,t,options)}),e.update(),e.trigger("sortComplete")};return e.handlers.sortStart=e.handlers.sortStart||[],e.handlers.sortComplete=e.handlers.sortComplete||[],t.els=a(e.listContainer,e.sortClass),o.bind(t.els,"click",n),e.on("searchStart",t.clear),e.on("filterStart",t.clear),e.helpers.classes=r,e.helpers.naturalSort=i,e.helpers.events=o,e.helpers.getAttribute=s,n}}),e.register("list.js/src/item.js",function(e,t,n){n.exports=function(e){return function(t,n,i){var r=this;this._values={},this.found=!1,this.filtered=!1;this.values=function(t,n){if(void 0===t)return r._values;for(var i in t)r._values[i]=t[i];!0!==n&&e.templater.set(r,r.values())},this.show=function(){e.templater.show(r)},this.hide=function(){e.templater.hide(r)},this.matching=function(){return e.filtered&&e.searched&&r.found&&r.filtered||e.filtered&&!e.searched&&r.filtered||!e.filtered&&e.searched&&r.found||!e.filtered&&!e.searched},this.visible=function(){return r.elm.parentNode==e.list},function(t,n,i){if(void 0===n)i?r.values(t,i):r.values(t);else{r.elm=n;var o=e.templater.get(r,t);r.values(o)}}(t,n,i)}}}),e.register("list.js/src/templater.js",function(e,t,n){var i=t("get-by-class"),r=function(e){var t=function(t){if(void 0===t){for(var n=e.list.childNodes,i=0,r=n.length;i<r;i++)if(void 0===n[i].data)return n[i];return null}if(-1!==t.indexOf("<")){var o=document.createElement("div");return o.innerHTML=t,o.firstChild}return document.getElementById(e.item)}(e.item),n=this;this.get=function(e,t){n.create(e);for(var r={},o=0,a=t.length;o<a;o++){var s=i(e.elm,t[o],!0);r[t[o]]=s?s.innerHTML:""}return r},this.set=function(e,t){if(!n.create(e))for(var r in t)if(t.hasOwnProperty(r)){var o=i(e.elm,r,!0);o&&("IMG"===o.tagName&&""!==t[r]?o.src=t[r]:o.innerHTML=t[r])}},this.create=function(e){if(void 0!==e.elm)return!1;var i=t.cloneNode(!0);return i.removeAttribute("id"),e.elm=i,n.set(e,e.values()),!0},this.remove=function(t){e.list.removeChild(t.elm)},this.show=function(t){n.create(t),e.list.appendChild(t.elm)},this.hide=function(t){void 0!==t.elm&&t.elm.parentNode===e.list&&e.list.removeChild(t.elm)},this.clear=function(){if(e.list.hasChildNodes())for(;e.list.childNodes.length>=1;)e.list.removeChild(e.list.firstChild)}};n.exports=function(e){return new r(e)}}),e.register("list.js/src/filter.js",function(e,t,n){n.exports=function(e){return e.handlers.filterStart=e.handlers.filterStart||[],e.handlers.filterComplete=e.handlers.filterComplete||[],function(t){if(e.trigger("filterStart"),e.i=1,e.reset.filter(),void 0===t)e.filtered=!1;else{e.filtered=!0;for(var n=e.items,i=0,r=n.length;i<r;i++){var o=n[i];t(o)?o.filtered=!0:o.filtered=!1}}return e.update(),e.trigger("filterComplete"),e.visibleItems}}}),e.register("list.js/src/add-async.js",function(e,t,n){n.exports=function(e){return function(t,n,i){var r=t.splice(0,100);i=(i=i||[]).concat(e.add(r)),t.length>0?setTimeout(function(){addAsync(t,n,i)},10):(e.update(),n(i))}}}),e.register("list.js/src/parse.js",function(e,t,n){n.exports=function(e){var n=t("./item")(e),i=function(e){for(var t=e.childNodes,n=[],i=0,r=t.length;i<r;i++)void 0===t[i].data&&n.push(t[i]);return n},r=function(t,i){for(var r=0,o=t.length;r<o;r++)e.items.push(new n(i,t[r]))},o=function(t,n){var i=t.splice(0,100);r(i,n),t.length>0?setTimeout(function(){init.items.indexAsync(t,n)},10):e.update()};return function(){var t=i(e.list),n=e.valueNames;e.indexAsync?o(t,n):r(t,n)}}}),e.alias("component-classes/index.js","list.js/deps/classes/index.js"),e.alias("component-classes/index.js","classes/index.js"),e.alias("component-indexof/index.js","component-classes/deps/indexof/index.js"),e.alias("segmentio-extend/index.js","list.js/deps/extend/index.js"),e.alias("segmentio-extend/index.js","extend/index.js"),e.alias("component-indexof/index.js","list.js/deps/indexof/index.js"),e.alias("component-indexof/index.js","indexof/index.js"),e.alias("javve-events/index.js","list.js/deps/events/index.js"),e.alias("javve-events/index.js","events/index.js"),e.alias("component-event/index.js","javve-events/deps/event/index.js"),e.alias("timoxley-to-array/index.js","javve-events/deps/to-array/index.js"),e.alias("javve-get-by-class/index.js","list.js/deps/get-by-class/index.js"),e.alias("javve-get-by-class/index.js","get-by-class/index.js"),e.alias("javve-get-attribute/index.js","list.js/deps/get-attribute/index.js"),e.alias("javve-get-attribute/index.js","get-attribute/index.js"),e.alias("javve-natural-sort/index.js","list.js/deps/natural-sort/index.js"),e.alias("javve-natural-sort/index.js","natural-sort/index.js"),e.alias("javve-to-string/index.js","list.js/deps/to-string/index.js"),e.alias("javve-to-string/index.js","list.js/deps/to-string/index.js"),e.alias("javve-to-string/index.js","to-string/index.js"),e.alias("javve-to-string/index.js","javve-to-string/index.js"),e.alias("component-type/index.js","list.js/deps/type/index.js"),e.alias("component-type/index.js","type/index.js"),"object"==typeof t?n.exports=e("list.js"):"function"==typeof define&&define.amd?define(function(){return e("list.js")}):this.List=e("list.js")}()}),define("list.js-master/dist/list.fuzzysearch.min.js",[],function(e,t,n){"use strict";!function(){function e(t,n,i){var r=e.resolve(t);if(null==r){i=i||t,n=n||"root";var o=new Error('Failed to require "'+i+'" from "'+n+'"');throw o.path=i,o.parent=n,o.require=!0,o}var a=e.modules[r];if(!a._resolving&&!a.exports){var s={};s.exports={},s.client=s.component=!0,a._resolving=!0,a.call(this,s.exports,e.relative(r),s),delete a._resolving,a.exports=s.exports}return a.exports}e.modules={},e.aliases={},e.resolve=function(t){"/"===t.charAt(0)&&(t=t.slice(1));for(var n=[t,t+".js",t+".json",t+"/index.js",t+"/index.json"],i=0;i<n.length;i++){var t=n[i];if(e.modules.hasOwnProperty(t))return t;if(e.aliases.hasOwnProperty(t))return e.aliases[t]}},e.normalize=function(e,t){var n=[];if("."!=t.charAt(0))return t;e=e.split("/"),t=t.split("/");for(var i=0;i<t.length;++i)".."==t[i]?e.pop():"."!=t[i]&&""!=t[i]&&n.push(t[i]);return e.concat(n).join("/")},e.register=function(t,n){e.modules[t]=n},e.alias=function(t,n){if(!e.modules.hasOwnProperty(t))throw new Error('Failed to alias "'+t+'", it does not exist');e.aliases[n]=t},e.relative=function(t){function n(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1}function i(n){return e(i.resolve(n),t,n)}var r=e.normalize(t,"..");return i.resolve=function(i){var o=i.charAt(0);if("/"==o)return i.slice(1);if("."==o)return e.normalize(r,i);var a=t.split("/"),s=n(a,"deps")+1;return s||(s=0),i=a.slice(0,s+1).join("/")+"/deps/"+i},i.exists=function(t){return e.modules.hasOwnProperty(i.resolve(t))},i},e.register("component-indexof/index.js",function(e,t,n){n.exports=function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}}),e.register("component-classes/index.js",function(e,t,n){function i(e){if(!e)throw new Error("A DOM element reference is required");this.el=e,this.list=e.classList}var r=t("indexof"),o=/\s+/,a=Object.prototype.toString;n.exports=function(e){return new i(e)},i.prototype.add=function(e){if(this.list)return this.list.add(e),this;var t=this.array();return~r(t,e)||t.push(e),this.el.className=t.join(" "),this},i.prototype.remove=function(e){if("[object RegExp]"==a.call(e))return this.removeMatching(e);if(this.list)return this.list.remove(e),this;var t=this.array(),n=r(t,e);return~n&&t.splice(n,1),this.el.className=t.join(" "),this},i.prototype.removeMatching=function(e){for(var t=this.array(),n=0;n<t.length;n++)e.test(t[n])&&this.remove(t[n]);return this},i.prototype.toggle=function(e){return this.list?(this.list.toggle(e),this):(this.has(e)?this.remove(e):this.add(e),this)},i.prototype.array=function(){var e=this.el.className.replace(/^\s+|\s+$/g,"").split(o);return""===e[0]&&e.shift(),e},i.prototype.has=i.prototype.contains=function(e){return this.list?this.list.contains(e):!!~r(this.array(),e)}}),e.register("segmentio-extend/index.js",function(e,t,n){n.exports=function(e){for(var t,n=Array.prototype.slice.call(arguments,1),i=0;t=n[i];i++)if(t)for(var r in t)e[r]=t[r];return e}}),e.register("component-event/index.js",function(e){var t=void 0!==window.addEventListener?"addEventListener":"attachEvent",n=void 0!==window.removeEventListener?"removeEventListener":"detachEvent",i="addEventListener"!==t?"on":"";e.bind=function(e,n,r,o){return e[t](i+n,r,o||!1),r},e.unbind=function(e,t,r,o){return e[n](i+t,r,o||!1),r}}),e.register("component-type/index.js",function(e,t,n){var i=Object.prototype.toString;n.exports=function(e){switch(i.call(e)){case"[object Function]":return"function";case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array";case"[object String]":return"string"}return null===e?"null":void 0===e?"undefined":e&&1===e.nodeType?"element":e===Object(e)?"object":typeof e}}),e.register("timoxley-is-collection/index.js",function(e,t,n){function i(e){return"object"==typeof e&&/^\[object (NodeList)\]$/.test(Object.prototype.toString.call(e))&&e.hasOwnProperty("length")&&(0==e.length||"object"==typeof e[0]&&e[0].nodeType>0)}var r=t("type");n.exports=function(e){var t=r(e);if("array"===t)return 1;switch(t){case"arguments":return 2;case"object":if(i(e))return 2;try{if("length"in e&&!e.tagName&&(!e.scrollTo||!e.document)&&!e.apply)return 2}catch(e){}default:return 0}}}),e.register("javve-events/index.js",function(e,t){var n=t("event"),i=t("is-collection");e.bind=function(e,t,r,o){if(i(e)){if(e&&void 0!==e[0])for(var a=0;a<e.length;a++)n.bind(e[a],t,r,o)}else n.bind(e,t,r,o)},e.unbind=function(e,t,r,o){if(i(e)){if(e&&void 0!==e[0])for(var a=0;a<e.length;a++)n.unbind(e[a],t,r,o)}else n.unbind(e,t,r,o)}}),e.register("javve-get-by-class/index.js",function(e,t,n){n.exports=document.getElementsByClassName?function(e,t,n){return n?e.getElementsByClassName(t)[0]:e.getElementsByClassName(t)}:document.querySelector?function(e,t,n){return n?e.querySelector(t):e.querySelectorAll(t)}:function(e,t,n){var i=[];null==e&&(e=document);for(var r=e.getElementsByTagName("*"),o=r.length,a=new RegExp("(^|\\s)"+t+"(\\s|$)"),s=0,l=0;o>s;s++)if(a.test(r[s].className)){if(n)return r[s];i[l]=r[s],l++}return i}}),e.register("javve-to-string/index.js",function(e,t,n){n.exports=function(e){return e=void 0===e?"":e,e=null===e?"":e,e=e.toString()}}),e.register("list.fuzzysearch.js/index.js",function(e,t,n){var i=(t("classes"),t("events")),r=t("extend"),o=t("to-string"),a=t("get-by-class");n.exports=function(e){r(e=e||{},{location:0,distance:100,threshold:.4,multiSearch:!0,searchClass:"fuzzy-search"});var n,s=t("./src/fuzzy"),l={search:function(t,i){for(var r=e.multiSearch?t.replace(/ +$/,"").split(/ +/):[t],o=0,a=n.items.length;a>o;o++)l.item(n.items[o],i,r)},item:function(e,t,n){for(var i=!0,r=0;r<n.length;r++){for(var o=!1,a=0,s=t.length;s>a;a++)l.values(e.values(),t[a],n[r])&&(o=!0);o||(i=!1)}e.found=i},values:function(t,n,i){if(t.hasOwnProperty(n)){var r=o(t[n]).toLowerCase();if(s(r,i,e))return!0}return!1}};return{init:function(t){n=t,i.bind(a(n.listContainer,e.searchClass),"keyup",function(e){var t=e.target||e.srcElement;n.search(t.value,l.search)})},search:function(e,t){n.search(e,t,l.search)},name:e.name||"fuzzySearch"}}}),e.register("list.fuzzysearch.js/src/fuzzy.js",function(e,t,n){n.exports=function(e,t,n){function i(e,n){var i=e/t.length,r=Math.abs(s-n);return o?i+r/o:r?1:i}var r=n.location||0,o=n.distance||100,a=n.threshold||.4;if(t===e)return!0;if(t.length>32)return!1;var s=r,l=function(){var e,n={};for(e=0;e<t.length;e++)n[t.charAt(e)]=0;for(e=0;e<t.length;e++)n[t.charAt(e)]|=1<<t.length-e-1;return n}(),c=a,d=e.indexOf(t,s);-1!=d&&(c=Math.min(i(0,d),c),-1!=(d=e.lastIndexOf(t,s+t.length))&&(c=Math.min(i(0,d),c)));var u=1<<t.length-1;d=-1;for(var h,p,f,m=t.length+e.length,g=0;g<t.length;g++){for(h=0,p=m;p>h;)i(g,s+p)<=c?h=p:m=p,p=Math.floor((m-h)/2+h);m=p;var v=Math.max(1,s-p+1),y=Math.min(s+p,e.length)+t.length,b=Array(y+2);b[y+1]=(1<<g)-1;for(var w=y;w>=v;w--){var x=l[e.charAt(w-1)];if(b[w]=0===g?(b[w+1]<<1|1)&x:(b[w+1]<<1|1)&x|(f[w+1]|f[w])<<1|1|f[w+1],b[w]&u){var C=i(g,w-1);if(c>=C){if(c=C,!((d=w-1)>s))break;v=Math.max(1,2*s-d)}}}if(i(g+1,s)>c)break;f=b}return!(0>d)}}),e.alias("component-classes/index.js","list.fuzzysearch.js/deps/classes/index.js"),e.alias("component-classes/index.js","classes/index.js"),e.alias("component-indexof/index.js","component-classes/deps/indexof/index.js"),e.alias("segmentio-extend/index.js","list.fuzzysearch.js/deps/extend/index.js"),e.alias("segmentio-extend/index.js","extend/index.js"),e.alias("javve-events/index.js","list.fuzzysearch.js/deps/events/index.js"),e.alias("javve-events/index.js","events/index.js"),e.alias("component-event/index.js","javve-events/deps/event/index.js"),e.alias("timoxley-is-collection/index.js","javve-events/deps/is-collection/index.js"),e.alias("component-type/index.js","timoxley-is-collection/deps/type/index.js"),e.alias("javve-get-by-class/index.js","list.fuzzysearch.js/deps/get-by-class/index.js"),e.alias("javve-get-by-class/index.js","get-by-class/index.js"),e.alias("javve-to-string/index.js","list.fuzzysearch.js/deps/to-string/index.js"),e.alias("javve-to-string/index.js","list.fuzzysearch.js/deps/to-string/index.js"),e.alias("javve-to-string/index.js","to-string/index.js"),e.alias("javve-to-string/index.js","javve-to-string/index.js"),e.alias("list.fuzzysearch.js/index.js","list.fuzzysearch.js/index.js"),"object"==typeof t?n.exports=e("list.fuzzysearch.js"):"function"==typeof define&&define.amd?define(function(){return e("list.fuzzysearch.js")}):this.ListFuzzySearch=e("list.fuzzysearch.js")}()});